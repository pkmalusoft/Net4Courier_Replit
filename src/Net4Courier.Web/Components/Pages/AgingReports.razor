@page "/aging-reports"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject Net4Courier.Web.Services.AppAuthStateProvider AppAuthState
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums
@using ClosedXML.Excel

<PageTitle>Aging Reports - Net4Courier</PageTitle>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h5">Customer Aging Report</MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Success">Account Receivable</MudChip>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Download" 
                       OnClick="DownloadExcel" Disabled="@(_agingData.Count == 0)">Excel</MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadAgingData">Refresh</MudButton>
        </MudStack>
    </MudStack>
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
        Analyze outstanding customer balances by aging buckets (0-30, 31-60, 61-90, 90+ days).
    </MudText>
</MudPaper>

<MudPaper Class="pa-4 mb-4" Elevation="1">
    <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
        <MudDatePicker @bind-Date="_asOfDate" Label="As Of Date" DateFormat="dd-MMM-yyyy" />
        <MudSelect T="long?" @bind-Value="_customerId" Label="Customer" Clearable="true" Style="min-width:250px">
            @foreach (var customer in _customers)
            {
                <MudSelectItem T="long?" Value="@customer.Id">@customer.Name</MudSelectItem>
            }
        </MudSelect>
        <MudCheckBox @bind-Value="_showZeroBalance" Label="Show Zero Balances" Color="Color.Primary" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadAgingData">Generate Report</MudButton>
    </MudStack>
</MudPaper>

<MudGrid Class="mb-4">
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Outstanding</MudText>
            <MudText Typo="Typo.h4" Color="Color.Primary">@AppAuthState.CurrencySymbol @_totalOutstanding.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="2">
        <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-success);">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">0-30 Days</MudText>
            <MudText Typo="Typo.h5" Color="Color.Success">@AppAuthState.CurrencySymbol @_total0To30.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="2">
        <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-info);">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">31-60 Days</MudText>
            <MudText Typo="Typo.h5" Color="Color.Info">@AppAuthState.CurrencySymbol @_total31To60.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="2">
        <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-warning);">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">61-90 Days</MudText>
            <MudText Typo="Typo.h5" Color="Color.Warning">@AppAuthState.CurrencySymbol @_total61To90.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-error);">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">90+ Days</MudText>
            <MudText Typo="Typo.h5" Color="Color.Error">@AppAuthState.CurrencySymbol @_total90Plus.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2">
    <MudTable Items="@_agingData" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary" Dense="true">
        <HeaderContent>
            <MudTh>Customer</MudTh>
            <MudTh>Code</MudTh>
            <MudTh Style="text-align:right">0-30 Days</MudTh>
            <MudTh Style="text-align:right">31-60 Days</MudTh>
            <MudTh Style="text-align:right">61-90 Days</MudTh>
            <MudTh Style="text-align:right">90+ Days</MudTh>
            <MudTh Style="text-align:right">Total Outstanding</MudTh>
            <MudTh Style="text-align:right">Credit Limit</MudTh>
            <MudTh Style="text-align:right">Available</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Customer">@context.CustomerName</MudTd>
            <MudTd DataLabel="Code">@context.CustomerCode</MudTd>
            <MudTd DataLabel="0-30 Days" Style="text-align:right">
                <MudText Color="Color.Success">@AppAuthState.CurrencySymbol @context.Bucket0To30.ToString("N2")</MudText>
            </MudTd>
            <MudTd DataLabel="31-60 Days" Style="text-align:right">
                <MudText Color="Color.Info">@AppAuthState.CurrencySymbol @context.Bucket31To60.ToString("N2")</MudText>
            </MudTd>
            <MudTd DataLabel="61-90 Days" Style="text-align:right">
                <MudText Color="Color.Warning">@AppAuthState.CurrencySymbol @context.Bucket61To90.ToString("N2")</MudText>
            </MudTd>
            <MudTd DataLabel="90+ Days" Style="text-align:right">
                <MudText Color="Color.Error">@AppAuthState.CurrencySymbol @context.Bucket90Plus.ToString("N2")</MudText>
            </MudTd>
            <MudTd DataLabel="Total" Style="text-align:right">
                <MudText Typo="Typo.body2" Style="font-weight:bold">@AppAuthState.CurrencySymbol @context.TotalOutstanding.ToString("N2")</MudText>
            </MudTd>
            <MudTd DataLabel="Credit Limit" Style="text-align:right">@AppAuthState.CurrencySymbol @context.CreditLimit.ToString("N0")</MudTd>
            <MudTd DataLabel="Available" Style="text-align:right">
                @if (context.AvailableCredit < 0)
                {
                    <MudText Color="Color.Error">@AppAuthState.CurrencySymbol @context.AvailableCredit.ToString("N2")</MudText>
                }
                else
                {
                    <MudText>@AppAuthState.CurrencySymbol @context.AvailableCredit.ToString("N2")</MudText>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No aging data available.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    private List<CustomerAgingData> _agingData = new();
    private List<Party> _customers = new();
    private bool _loading = true;
    private DateTime? _asOfDate = DateTime.Today;
    private long? _customerId;
    private bool _showZeroBalance = false;

    private decimal _totalOutstanding => _agingData.Sum(a => a.TotalOutstanding);
    private decimal _total0To30 => _agingData.Sum(a => a.Bucket0To30);
    private decimal _total31To60 => _agingData.Sum(a => a.Bucket31To60);
    private decimal _total61To90 => _agingData.Sum(a => a.Bucket61To90);
    private decimal _total90Plus => _agingData.Sum(a => a.Bucket90Plus);

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _customers = await dbContext.Parties
            .Where(p => p.PartyType == PartyType.Customer && !p.IsDeleted && p.IsActive)
            .OrderBy(p => p.Name)
            .ToListAsync();
        await LoadAgingData();
    }

    private async Task LoadAgingData()
    {
        _loading = true;
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var asOfDate = _asOfDate ?? DateTime.Today;

        var customerQuery = dbContext.Parties
            .Where(p => p.PartyType == PartyType.Customer && !p.IsDeleted);

        if (_customerId.HasValue)
            customerQuery = customerQuery.Where(p => p.Id == _customerId);

        var customers = await customerQuery.ToListAsync();

        var invoices = await dbContext.Invoices
            .Where(i => !i.IsDeleted && i.Status != InvoiceStatus.Cancelled)
            .ToListAsync();

        _agingData = new List<CustomerAgingData>();

        foreach (var customer in customers)
        {
            var customerInvoices = invoices.Where(i => i.CustomerId == customer.Id).ToList();
            
            var aging = new CustomerAgingData
            {
                CustomerId = customer.Id,
                CustomerName = customer.Name,
                CustomerCode = customer.Code ?? "",
                CreditLimit = customer.CreditLimit
            };

            foreach (var invoice in customerInvoices)
            {
                var balance = (invoice.BalanceAmount ?? invoice.NetTotal ?? 0);
                if (balance <= 0) continue;

                var daysOld = (asOfDate - invoice.InvoiceDate).Days;

                if (daysOld <= 30)
                    aging.Bucket0To30 += balance;
                else if (daysOld <= 60)
                    aging.Bucket31To60 += balance;
                else if (daysOld <= 90)
                    aging.Bucket61To90 += balance;
                else
                    aging.Bucket90Plus += balance;
            }

            if (_showZeroBalance || aging.TotalOutstanding > 0)
                _agingData.Add(aging);
        }

        _agingData = _agingData.OrderByDescending(a => a.TotalOutstanding).ToList();
        _loading = false;
    }

    private async Task DownloadExcel()
    {
        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Aging Report");

        worksheet.Cell(1, 1).Value = "Customer Aging Report";
        worksheet.Cell(1, 1).Style.Font.Bold = true;
        worksheet.Cell(1, 1).Style.Font.FontSize = 14;
        worksheet.Cell(2, 1).Value = $"As of: {(_asOfDate ?? DateTime.Today):dd-MMM-yyyy}";

        var headers = new[] { "Customer", "Code", "0-30 Days", "31-60 Days", "61-90 Days", "90+ Days", "Total Outstanding", "Credit Limit", "Available Credit" };
        for (int i = 0; i < headers.Length; i++)
        {
            worksheet.Cell(4, i + 1).Value = headers[i];
            worksheet.Cell(4, i + 1).Style.Font.Bold = true;
            worksheet.Cell(4, i + 1).Style.Fill.BackgroundColor = XLColor.LightGray;
        }

        int row = 5;
        foreach (var data in _agingData)
        {
            worksheet.Cell(row, 1).Value = data.CustomerName;
            worksheet.Cell(row, 2).Value = data.CustomerCode;
            worksheet.Cell(row, 3).Value = data.Bucket0To30;
            worksheet.Cell(row, 4).Value = data.Bucket31To60;
            worksheet.Cell(row, 5).Value = data.Bucket61To90;
            worksheet.Cell(row, 6).Value = data.Bucket90Plus;
            worksheet.Cell(row, 7).Value = data.TotalOutstanding;
            worksheet.Cell(row, 8).Value = data.CreditLimit;
            worksheet.Cell(row, 9).Value = data.AvailableCredit;
            row++;
        }

        row++;
        worksheet.Cell(row, 1).Value = "Totals";
        worksheet.Cell(row, 1).Style.Font.Bold = true;
        worksheet.Cell(row, 3).Value = _total0To30;
        worksheet.Cell(row, 4).Value = _total31To60;
        worksheet.Cell(row, 5).Value = _total61To90;
        worksheet.Cell(row, 6).Value = _total90Plus;
        worksheet.Cell(row, 7).Value = _totalOutstanding;
        worksheet.Row(row).Style.Font.Bold = true;

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        var content = stream.ToArray();
        var fileName = $"AgingReport_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(content));
    }

    private class CustomerAgingData
    {
        public long CustomerId { get; set; }
        public string CustomerName { get; set; } = "";
        public string CustomerCode { get; set; } = "";
        public decimal Bucket0To30 { get; set; }
        public decimal Bucket31To60 { get; set; }
        public decimal Bucket61To90 { get; set; }
        public decimal Bucket90Plus { get; set; }
        public decimal TotalOutstanding => Bucket0To30 + Bucket31To60 + Bucket61To90 + Bucket90Plus;
        public decimal CreditLimit { get; set; }
        public decimal AvailableCredit => CreditLimit - TotalOutstanding;
    }
}

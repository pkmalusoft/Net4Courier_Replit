@page "/awb-new"
@page "/awb-new/{Id:long}"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject Net4Courier.Web.Services.ShipmentStatusService ShipmentStatusService
@inject Net4Courier.Web.Services.AWBNumberService AWBNumberService
@inject Net4Courier.Web.Services.AppAuthStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Operations.Entities
@using Net4Courier.Finance.Entities
@using Net4Courier.Kernel.Enums
@using ShipmentModeEntity = Net4Courier.Masters.Entities.ShipmentMode

<PageTitle>@(Id > 0 ? "Edit AWB" : "New AWB") - Net4Courier</PageTitle>

<MudPaper Class="pa-4" Elevation="0">
    <MudForm @ref="_form" @bind-IsValid="_formIsValid">

        <MudToolBar Dense="true" Class="pl-0">
            <MudText Typo="Typo.h6">Airway Bill Details</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="!_formIsValid">
                @(Id > 0 ? "Update" : "Save")
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Cancel" Class="ml-2">Cancel</MudButton>
            <MudMenu Dense="true" Class="ml-2">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined">Actions</MudButton>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Icon="@Icons.Material.Filled.Print">Print AWB</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy">Duplicate</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.History">View History</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudToolBar>

        <MudPaper Class="pa-3 mt-2" Elevation="1">
            <MudGrid Spacing="2" AlignItems="Center">
                <MudItem xs="6" md="1">
                    <MudSelect T="long?" @bind-Value="_inscan.ShipmentModeId" Label="Inco Terms" Dense="true" 
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                               Disabled="@(CalculateMovementType() != MovementType.InternationalExport)">
                        @foreach (var mode in _shipmentModes)
                        {
                            <MudSelectItem T="long?" Value="@mode.Id">@mode.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudDatePicker @bind-Date="_transactionDate" Label="AWB Date" Dense="true" 
                                   Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" 
                                   AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
                </MudItem>
                <MudItem xs="3" md="1">
                    <MudCheckBox Value="_isAutoAWB" ValueChanged="OnAutoAWBChanged" Label="Auto" Dense="true" T="bool" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudTextField @bind-Value="_inscan.AWBNo" Label="AWB No.*" Dense="true" 
                                  Variant="Variant.Outlined" Required="true" RequiredError="Required" 
                                  Disabled="_isAutoAWB" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudSelect T="PaymentMode" @bind-Value="_selectedPaymentMode" @bind-Value:after="OnPaymentModeChanged" Label="Payment Mode" Dense="true" 
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter">
                        <MudSelectItem T="PaymentMode" Value="@PaymentMode.PickupCash">Pickup Cash</MudSelectItem>
                        <MudSelectItem T="PaymentMode" Value="@PaymentMode.COD">COD</MudSelectItem>
                        <MudSelectItem T="PaymentMode" Value="@PaymentMode.Account">Account</MudSelectItem>
                        <MudSelectItem T="PaymentMode" Value="@PaymentMode.Prepaid">Prepaid</MudSelectItem>
                        <MudSelectItem T="PaymentMode" Value="@PaymentMode.CAD">CAD</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="2">
                    @if (_selectedPaymentMode == PaymentMode.Account)
                    {
                        <MudSelect T="long?" Value="_inscan.CustomerId" ValueChanged="OnCustomerChanged" Label="Customer" Dense="true" 
                                   Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem T="long?" Value="@((long?)null)">-- Walk-in --</MudSelectItem>
                            @foreach (var customer in _customers)
                            {
                                <MudSelectItem T="long?" Value="@customer.Id">@customer.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                    else if (_selectedPaymentMode == PaymentMode.PickupCash)
                    {
                        <MudSelect T="long?" @bind-Value="_selectedCashAccountId" Label="Cash Account" Dense="true" 
                                   Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var acc in _cashAccounts)
                            {
                                <MudSelectItem T="long?" Value="@acc.Id">@acc.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                    else
                    {
                        <MudTextField Value="@_controlAccountName" Label="Account" Dense="true" Variant="Variant.Outlined" Disabled="true" />
                    }
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudSwitch T="bool" Value="_copyAddress" ValueChanged="OnCopyAddressChanged" Label="Copy Address" Color="Color.Primary" />
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudGrid Class="mt-4">
            <MudItem xs="12" md="6">
                <MudCard Class="pa-4" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">Consignor / Shipper</MudText>
                    <MudTextField @bind-Value="_inscan.Consignor" Label="Name" Dense="true" Variant="Variant.Outlined" Class="mb-2" />
                    <MudGrid Spacing="2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsignorPhone" Label="Telephone" Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsignorMobile" Label="Mobile No." Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                    <MudTextField @bind-Value="_inscan.ConsignorContact" Label="Contact Person" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudTextField @bind-Value="_inscan.ConsignorAddress1" Label="Flat / Building" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudTextField @bind-Value="_inscan.ConsignorAddress2" Label="Area / Landmark" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudGrid Spacing="2" Class="mt-2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsignorPostalCode" Label="Pincode" Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" Value="_originCountryId" ValueChanged="OnOriginCountryChanged" Label="Origin Country" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                                @foreach (var country in _countries)
                                {
                                    <MudSelectItem T="long?" Value="@country.Id">@country.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" Value="_originCityId" ValueChanged="OnOriginCityChanged" Label="Origin City" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true" Disabled="@(!_originCities.Any())">
                                @foreach (var city in _originCities)
                                {
                                    <MudSelectItem T="long?" Value="@city.Id">@city.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" Value="_inscan.ConsignorLocation" ValueChanged="OnOriginLocationChanged" Label="Origin Location" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true" Disabled="@(!_originLocations.Any())">
                                @foreach (var loc in _originLocations)
                                {
                                    <MudSelectItem T="string" Value="@loc.Name">@loc.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" @bind-Value="_inscan.OriginPortId" Label="Origin Airport" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                                       Disabled="@(CalculateMovementType() != MovementType.InternationalExport)">
                                @foreach (var port in _airports)
                                {
                                    <MudSelectItem T="long?" Value="@port.Id">@port.Name (@port.IATACode)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCard Class="pa-4" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">Consignee / Receiver</MudText>
                    <MudTextField @bind-Value="_inscan.Consignee" Label="Name" Dense="true" Variant="Variant.Outlined" Class="mb-2" />
                    <MudGrid Spacing="2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsigneePhone" Label="Telephone" Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsigneeMobile" Label="Mobile No." Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                    <MudTextField @bind-Value="_inscan.ConsigneeContact" Label="Contact Person" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudTextField @bind-Value="_inscan.ConsigneeAddress1" Label="Flat / Building" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudTextField @bind-Value="_inscan.ConsigneeAddress2" Label="Area / Landmark" Dense="true" Variant="Variant.Outlined" Class="mt-2" />
                    <MudGrid Spacing="2" Class="mt-2">
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ConsigneePostalCode" Label="Pincode" Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" Value="_destCountryId" ValueChanged="OnDestCountryChanged" Label="Dest Country" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                                @foreach (var country in _countries)
                                {
                                    <MudSelectItem T="long?" Value="@country.Id">@country.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" Value="_destCityId" ValueChanged="OnDestCityChanged" Label="Dest City" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true" Disabled="@(!_destCities.Any())">
                                @foreach (var city in _destCities)
                                {
                                    <MudSelectItem T="long?" Value="@city.Id">@city.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" Value="_inscan.ConsigneeLocation" ValueChanged="OnDestLocationChanged" Label="Dest Location" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true" Disabled="@(!_destLocations.Any())">
                                @foreach (var loc in _destLocations)
                                {
                                    <MudSelectItem T="string" Value="@loc.Name">@loc.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="long?" @bind-Value="_inscan.DestinationPortId" Label="Destination Airport" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                                       Disabled="@(CalculateMovementType() != MovementType.InternationalExport)">
                                @foreach (var port in _airports)
                                {
                                    <MudSelectItem T="long?" Value="@port.Id">@port.Name (@port.IATACode)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudCard Class="mt-4 pa-4">
            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">Shipment & Charges</MudText>
            <MudGrid>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.Pieces" Label="Pieces" Dense="true" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.Weight" Label="Weight (kg)" Dense="true" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.CustomsValue" Label="Invoice Value" Dense="true" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudSelect T="string" @bind-Value="_inscan.Currency" Label="Currency" Dense="true" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="string" Value="@("INR")">INR</MudSelectItem>
                        <MudSelectItem T="string" Value="@("USD")">USD</MudSelectItem>
                        <MudSelectItem T="string" Value="@("EUR")">EUR</MudSelectItem>
                        <MudSelectItem T="string" Value="@("GBP")">GBP</MudSelectItem>
                        <MudSelectItem T="string" Value="@("AED")">AED</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudSelect T="DocumentType" @bind-Value="_inscan.DocumentTypeId" Label="Shipment Type" Dense="true" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="DocumentType" Value="@DocumentType.Letter">Letter</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.Document">Document</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelUpto30Kg">Parcel Upto 30kg</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelAbove30Kg">Parcel Above 30kg</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudSelect T="ParcelType" @bind-Value="_parcelType" Label="Parcel Type" Dense="true" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="ParcelType" Value="@ParcelType.Document">Document</MudSelectItem>
                        <MudSelectItem T="ParcelType" Value="@ParcelType.Letter">Letter</MudSelectItem>
                        <MudSelectItem T="ParcelType" Value="@ParcelType.ParcelUpto30Kg">Parcel Upto 30kg</MudSelectItem>
                        <MudSelectItem T="ParcelType" Value="@ParcelType.ParcelAbove30Kg">Parcel Above 30kg</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Style="height: 40px;">
                        <MudText Typo="Typo.body2" Class="mr-2">Movement:</MudText>
                        <MudChip T="string" Color="@GetMovementChipColor()" Size="Size.Small">@GetMovementTypeDisplay()</MudChip>
                    </MudStack>
                </MudItem>
            </MudGrid>
            <MudDivider Class="my-3" />
            <MudGrid>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.CourierCharge" Label="Courier Charge" Dense="true" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudTooltip Placement="Placement.Top" RootClass="d-block">
                        <ChildContent>
                            <MudTextField Value="@((_inscan.OtherCharge ?? 0).ToString("N2"))" Label="Other Charges" Dense="true" 
                                          Variant="Variant.Outlined" ReadOnly="true"
                                          Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Edit" 
                                          OnAdornmentClick="OpenOtherChargesDialog" AdornmentColor="Color.Primary" />
                        </ChildContent>
                        <TooltipContent>
                            @if (_selectedOtherCharges.Any())
                            {
                                <MudStack Spacing="0">
                                    @foreach (var charge in _selectedOtherCharges)
                                    {
                                        <MudText Typo="Typo.caption">@charge.ChargeName: @charge.Amount.ToString("N2")</MudText>
                                    }
                                    <MudDivider Class="my-1" />
                                    <MudText Typo="Typo.caption"><strong>Total: @_selectedOtherCharges.Sum(c => c.Amount).ToString("N2")</strong></MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption">Click to add charges</MudText>
                            }
                        </TooltipContent>
                    </MudTooltip>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.FuelSurcharge" Label="Fuel Surcharge" Dense="true" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudCheckBox @bind-Value="_applyTax" Label="Tax" Dense="true" />
                        @if (_applyTax)
                        {
                            <MudNumericField @bind-Value="_inscan.TaxPercent" Label="%" Dense="true" Variant="Variant.Outlined" Format="N1" Style="width: 80px;" />
                        }
                    </MudStack>
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudNumericField @bind-Value="_inscan.Discount" Label="Discount" Dense="true" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="6" md="2">
                    <MudNumericField Value="@NetTotal" Label="Total" Dense="true" Variant="Variant.Filled" Format="N2" ReadOnly="true" />
                </MudItem>
            </MudGrid>
            @if (_inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD)
            {
                <MudGrid Class="mt-2">
                    <MudItem xs="6" md="2">
                        <MudNumericField @bind-Value="_inscan.CODAmount" Label="COD Amount" Dense="true" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                </MudGrid>
            }
        </MudCard>

        <MudGrid Class="mt-4">
            <MudItem xs="12" md="6">
                <MudCard Class="pa-4" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">Forwarding Agent</MudText>
                    <MudGrid Spacing="2">
                        <MudItem xs="6">
                            <MudSelect T="long?" @bind-Value="_inscan.ForwardingAgentId" Label="Forwarding Agent" Dense="true" 
                                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                                @foreach (var agent in _forwardingAgents)
                                {
                                    <MudSelectItem T="long?" Value="@agent.Id">@agent.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="_inscan.ForwardingAWBNo" Label="Agent AWB No." Dense="true" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudNumericField @bind-Value="_inscan.ForwardingCharge" Label="Rate" Dense="true" Variant="Variant.Outlined" Format="N2" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudNumericField @bind-Value="_inscan.ManifestWeight" Label="Manifest Wt" Dense="true" Variant="Variant.Outlined" Format="N2" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudNumericField @bind-Value="_inscan.VerifiedWeight" Label="Verified Wt" Dense="true" Variant="Variant.Outlined" Format="N2" />
                        </MudItem>
                    </MudGrid>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCard Class="pa-4" Style="height: 100%;">
                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">Instructions & Audit</MudText>
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2">
                        <MudCheckBox @bind-Value="_inscan.IsNCND" Label="NCND" Dense="true" />
                        <MudCheckBox @bind-Value="_inscan.IsCashOnly" Label="Cash Only" Dense="true" />
                        <MudCheckBox @bind-Value="_inscan.IsChequeOnly" Label="Cheque Only" Dense="true" />
                        <MudCheckBox @bind-Value="_inscan.IsCollectMaterial" Label="Collect Material" Dense="true" />
                        <MudCheckBox @bind-Value="_inscan.IsDOCopyBack" Label="DO Copy Back" Dense="true" />
                    </MudStack>
                    <MudTextField @bind-Value="_inscan.Remarks" Label="Remarks" Dense="true" Variant="Variant.Outlined" Lines="3" Class="mt-2" />
                </MudCard>
            </MudItem>
        </MudGrid>

    </MudForm>
</MudPaper>

@code {
    [Parameter] public long Id { get; set; }

    private InscanMaster _inscan = new();
    private MudForm _form = null!;
    private bool _formIsValid;
    private DateTime? _transactionDate = DateTime.Today;
    private List<ShipmentModeEntity> _shipmentModes = new();
    private List<Party> _customers = new();
    private List<Party> _forwardingAgents = new();
    private List<Country> _countries = new();
    private List<City> _originCities = new();
    private List<City> _destCities = new();
    private List<Location> _originLocations = new();
    private List<Location> _destLocations = new();
    private List<Port> _airports = new();
    private List<AccountHead> _cashAccounts = new();
    private long? _originCountryId;
    private long? _originCityId;
    private long? _destCountryId;
    private long? _destCityId;
    private long? _selectedCashAccountId;
    private long? _controlAccountId;
    private string _controlAccountName = string.Empty;
    private bool _isAutoAWB = true;
    private PaymentMode _selectedPaymentMode = PaymentMode.Prepaid;
    private bool _copyAddress;
    private bool _applyTax;
    private ParcelType _parcelType = ParcelType.Document;
    private long? _companyCountryId;
    private List<OtherChargeSelection> _selectedOtherCharges = new();

    private decimal NetTotal => ((_inscan.CourierCharge ?? 0) + (_inscan.OtherCharge ?? 0) + (_inscan.FuelSurcharge ?? 0)) 
                                * (1 + (_applyTax ? (_inscan.TaxPercent ?? 0) / 100 : 0)) - (_inscan.Discount ?? 0);

    protected override async Task OnInitializedAsync()
    {
        _customers = await DbContext.Parties.Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        _forwardingAgents = await DbContext.Parties.Where(p => p.PartyType == PartyType.ForwardingAgent && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        _countries = await DbContext.Countries.Where(c => c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        _cashAccounts = await DbContext.AccountHeads.Where(a => a.AccountNature == AccountNature.CashAccount && a.IsActive && !a.IsDeleted && !a.IsGroup).OrderBy(a => a.Name).ToListAsync();
        _shipmentModes = await DbContext.ShipmentModes.Where(s => s.IsActive && !s.IsDeleted).OrderBy(s => s.SortOrder).ToListAsync();
        _airports = await DbContext.Ports.Where(p => p.PortType == PortType.Airport && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        
        var company = await DbContext.Companies.FirstOrDefaultAsync(c => !c.IsDeleted);
        _companyCountryId = company?.CountryId;

        if (Id > 0)
        {
            var existing = await DbContext.InscanMasters.FindAsync(Id);
            if (existing != null)
            {
                _inscan = existing;
                _transactionDate = _inscan.TransactionDate.ToLocalTime();
                _isAutoAWB = _inscan.IsAutoGenerated;
                _selectedPaymentMode = _inscan.PaymentModeId;
                _applyTax = (_inscan.TaxPercent ?? 0) > 0;
                _parcelType = (ParcelType)(_inscan.ParcelTypeId ?? 1);
                await LoadExistingGeography();
                await LoadExistingOtherCharges();
            }
        }
        else
        {
            _inscan.AWBNo = await GenerateAWBNo();
            _inscan.TransactionDate = DateTime.UtcNow;
            _inscan.ShipmentModeId = _shipmentModes.FirstOrDefault()?.Id;
            _inscan.IsAutoGenerated = true;
            _inscan.Currency = "INR";
            _selectedPaymentMode = _inscan.PaymentModeId;
            var india = _countries.FirstOrDefault(c => c.Name == "India");
            if (india != null)
            {
                _originCountryId = india.Id;
                _destCountryId = india.Id;
                _inscan.ConsignorCountry = india.Name;
                _inscan.ConsigneeCountry = india.Name;
                _originCities = await DbContext.Cities.Where(c => c.CountryId == india.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
                _destCities = _originCities;
            }
        }

        await LoadPaymentModeAccount(_selectedPaymentMode);
    }

    private async Task LoadPaymentModeAccount(PaymentMode paymentMode)
    {
        _controlAccountId = null;
        _controlAccountName = string.Empty;
        _selectedCashAccountId = null;

        if (paymentMode == PaymentMode.COD || paymentMode == PaymentMode.CAD)
        {
            var controlType = paymentMode == PaymentMode.COD ? ControlAccountType.CODControl : ControlAccountType.CADControl;
            var setting = await DbContext.ControlAccountSettings
                .Include(s => s.AccountHead)
                .FirstOrDefaultAsync(s => s.AccountType == controlType && !s.IsDeleted);
            if (setting?.AccountHead != null)
            {
                _controlAccountId = setting.AccountHeadId;
                _controlAccountName = setting.AccountHead.Name;
            }
            else
            {
                _controlAccountName = paymentMode == PaymentMode.COD ? "COD Control (Not Configured)" : "CAD Control (Not Configured)";
            }
        }
        else if (paymentMode == PaymentMode.Prepaid)
        {
            var setting = await DbContext.ControlAccountSettings
                .Include(s => s.AccountHead)
                .FirstOrDefaultAsync(s => s.AccountType == ControlAccountType.PrepaidControl && !s.IsDeleted);
            if (setting?.AccountHead != null)
            {
                _controlAccountId = setting.AccountHeadId;
                _controlAccountName = setting.AccountHead.Name;
            }
            else
            {
                _controlAccountName = "Prepaid Control (Not Configured)";
            }
        }
        else if (paymentMode == PaymentMode.PickupCash)
        {
            var setting = await DbContext.ControlAccountSettings
                .FirstOrDefaultAsync(s => s.AccountType == ControlAccountType.CashAccount && !s.IsDeleted);
            if (setting != null)
            {
                _selectedCashAccountId = setting.AccountHeadId;
            }
            else if (_cashAccounts.Any())
            {
                _selectedCashAccountId = _cashAccounts.First().Id;
            }
        }
    }

    private async Task LoadExistingGeography()
    {
        var originCountry = _countries.FirstOrDefault(c => c.Name == _inscan.ConsignorCountry);
        var destCountry = _countries.FirstOrDefault(c => c.Name == _inscan.ConsigneeCountry);
        
        if (originCountry != null)
        {
            _originCountryId = originCountry.Id;
            _originCities = await DbContext.Cities.Where(c => c.CountryId == originCountry.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
            var originCity = _originCities.FirstOrDefault(c => c.Name == _inscan.ConsignorCity);
            if (originCity != null)
            {
                _originCityId = originCity.Id;
                _originLocations = await DbContext.Locations.Where(l => l.CityId == originCity.Id && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
            }
        }
        
        if (destCountry != null)
        {
            _destCountryId = destCountry.Id;
            _destCities = await DbContext.Cities.Where(c => c.CountryId == destCountry.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
            var destCity = _destCities.FirstOrDefault(c => c.Name == _inscan.ConsigneeCity);
            if (destCity != null)
            {
                _destCityId = destCity.Id;
                _destLocations = await DbContext.Locations.Where(l => l.CityId == destCity.Id && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
            }
        }
    }

    private async Task<string> GenerateAWBNo()
    {
        var branchId = AuthStateProvider.CurrentBranch?.Id;
        if (branchId.HasValue)
        {
            return await AWBNumberService.PreviewNextAWBNumber(branchId.Value);
        }
        return "(Branch not configured)";
    }

    private async Task OnAutoAWBChanged(bool value)
    {
        _isAutoAWB = value;
        _inscan.IsAutoGenerated = value;
        if (_isAutoAWB)
        {
            _inscan.AWBNo = await GenerateAWBNo();
        }
        else
        {
            _inscan.AWBNo = string.Empty;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPaymentModeChanged()
    {
        _inscan.PaymentModeId = _selectedPaymentMode;
        _inscan.CustomerId = null;
        await LoadPaymentModeAccount(_selectedPaymentMode);
    }

    private async Task OnCustomerChanged(long? customerId)
    {
        _inscan.CustomerId = customerId;
        if (_copyAddress && customerId.HasValue)
        {
            await PopulateConsignorFromCustomer(customerId.Value);
        }
        StateHasChanged();
    }

    private async Task OnCopyAddressChanged(bool value)
    {
        _copyAddress = value;
        if (_copyAddress && _inscan.CustomerId.HasValue)
        {
            await PopulateConsignorFromCustomer(_inscan.CustomerId.Value);
        }
        StateHasChanged();
    }

    private async Task PopulateConsignorFromCustomer(long customerId)
    {
        var customer = await DbContext.Parties
            .Include(p => p.Addresses)
            .FirstOrDefaultAsync(p => p.Id == customerId);
        
        if (customer == null) return;

        _inscan.Consignor = customer.Name;
        _inscan.ConsignorContact = customer.ContactPerson;
        _inscan.ConsignorPhone = customer.Phone;
        _inscan.ConsignorMobile = customer.Mobile;

        var address = customer.Addresses.FirstOrDefault(a => a.IsDefault) 
                      ?? customer.Addresses.FirstOrDefault();
        
        if (address != null)
        {
            _inscan.ConsignorAddress1 = address.BuildingName;
            _inscan.ConsignorAddress2 = string.IsNullOrEmpty(address.Area) ? address.Street : $"{address.Street}, {address.Area}";
            _inscan.ConsignorCity = address.City;
            _inscan.ConsignorState = address.State;
            _inscan.ConsignorCountry = address.Country ?? "India";
            _inscan.ConsignorPostalCode = address.PostalCode;
            var country = _countries.FirstOrDefault(c => c.Name == address.Country);
            if (country != null)
            {
                _originCountryId = country.Id;
                _originCities = await DbContext.Cities.Where(c => c.CountryId == country.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
                var city = _originCities.FirstOrDefault(c => c.Name == address.City);
                if (city != null)
                {
                    _originCityId = city.Id;
                    _originLocations = await DbContext.Locations.Where(l => l.CityId == city.Id && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
                    _inscan.ConsignorLocation = address.Landmark;
                }
            }
        }
    }

    private async Task OnOriginCountryChanged(long? countryId)
    {
        _originCountryId = countryId;
        _originCityId = null;
        _originCities.Clear();
        _originLocations.Clear();
        _inscan.ConsignorCity = null;
        _inscan.ConsignorLocation = null;
        
        if (countryId.HasValue)
        {
            var country = _countries.FirstOrDefault(c => c.Id == countryId);
            _inscan.ConsignorCountry = country?.Name;
            _originCities = await DbContext.Cities.Where(c => c.CountryId == countryId && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        }
        else
        {
            _inscan.ConsignorCountry = null;
        }
        StateHasChanged();
    }

    private async Task OnOriginCityChanged(long? cityId)
    {
        _originCityId = cityId;
        _originLocations.Clear();
        _inscan.ConsignorLocation = null;
        
        if (cityId.HasValue)
        {
            var city = _originCities.FirstOrDefault(c => c.Id == cityId);
            _inscan.ConsignorCity = city?.Name;
            _originLocations = await DbContext.Locations.Where(l => l.CityId == cityId && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
        }
        else
        {
            _inscan.ConsignorCity = null;
        }
        StateHasChanged();
    }

    private void OnOriginLocationChanged(string? locationName)
    {
        _inscan.ConsignorLocation = locationName;
        StateHasChanged();
    }

    private async Task OnDestCountryChanged(long? countryId)
    {
        _destCountryId = countryId;
        _destCityId = null;
        _destCities.Clear();
        _destLocations.Clear();
        _inscan.ConsigneeCity = null;
        _inscan.ConsigneeLocation = null;
        
        if (countryId.HasValue)
        {
            var country = _countries.FirstOrDefault(c => c.Id == countryId);
            _inscan.ConsigneeCountry = country?.Name;
            _destCities = await DbContext.Cities.Where(c => c.CountryId == countryId && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        }
        else
        {
            _inscan.ConsigneeCountry = null;
        }
        StateHasChanged();
    }

    private async Task OnDestCityChanged(long? cityId)
    {
        _destCityId = cityId;
        _destLocations.Clear();
        _inscan.ConsigneeLocation = null;
        
        if (cityId.HasValue)
        {
            var city = _destCities.FirstOrDefault(c => c.Id == cityId);
            _inscan.ConsigneeCity = city?.Name;
            _destLocations = await DbContext.Locations.Where(l => l.CityId == cityId && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
        }
        else
        {
            _inscan.ConsigneeCity = null;
        }
        StateHasChanged();
    }

    private void OnDestLocationChanged(string? locationName)
    {
        _inscan.ConsigneeLocation = locationName;
        StateHasChanged();
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        if (_transactionDate.HasValue)
            _inscan.TransactionDate = _transactionDate.Value.Date.ToUniversalTime();

        var periodCheck = await ValidatePeriodIsOpen(_inscan.TransactionDate);
        if (!periodCheck.isValid)
        {
            Snackbar.Add(periodCheck.message, Severity.Error);
            return;
        }

        var branchId = AuthStateProvider.CurrentBranch?.Id;
        if (Id == 0 && _isAutoAWB && !branchId.HasValue)
        {
            Snackbar.Add("Cannot auto-generate AWB: No branch selected. Please log in again.", Severity.Error);
            return;
        }

        if (Id == 0 && !_isAutoAWB)
        {
            if (!await AWBNumberService.IsAWBNumberUnique(_inscan.AWBNo))
            {
                Snackbar.Add($"AWB number '{_inscan.AWBNo}' already exists. Please enter a unique AWB number.", Severity.Error);
                return;
            }
        }

        _inscan.IsAutoGenerated = _isAutoAWB;
        _inscan.ParcelTypeId = (int)_parcelType;
        _inscan.MovementTypeId = CalculateMovementType();
        _inscan.NetTotal = NetTotal;
        _inscan.IsCOD = _inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD;

        using var transaction = await DbContext.Database.BeginTransactionAsync();
        try
        {
            if (Id == 0)
            {
                if (_isAutoAWB && branchId.HasValue)
                {
                    _inscan.AWBNo = await AWBNumberService.GenerateNextAWBNumber(branchId.Value, _inscan.MovementTypeId);
                }
                _inscan.CreatedAt = DateTime.UtcNow;
                _inscan.CourierStatusId = CourierStatus.Pending;
                DbContext.InscanMasters.Add(_inscan);
            }
            else
            {
                _inscan.ModifiedAt = DateTime.UtcNow;
                DbContext.InscanMasters.Update(_inscan);
            }

            await DbContext.SaveChangesAsync();
            await SaveOtherCharges();
            await DbContext.SaveChangesAsync();
            await transaction.CommitAsync();
        }
        catch
        {
            await transaction.RollbackAsync();
            Snackbar.Add("Failed to save AWB. Please try again.", Severity.Error);
            return;
        }
        
        if (Id == 0)
        {
            await ShipmentStatusService.SetStatus(
                _inscan.Id, "QC_COMPLETED", "AWB_CREATED", null, null,
                null, _inscan.ConsignorCity, null, null,
                $"Shipment created - AWB {_inscan.AWBNo}", isAutomatic: true);
        }
        
        Snackbar.Add(Id > 0 ? "AWB updated successfully" : "AWB created successfully", Severity.Success);
        NavigationManager.NavigateTo("/awb-list");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/awb-list");
    }

    private async Task<(bool isValid, string message)> ValidatePeriodIsOpen(DateTime transactionDate)
    {
        var period = await DbContext.FinancialPeriods
            .Include(p => p.FinancialYear)
            .Where(p => p.StartDate <= transactionDate && p.EndDate >= transactionDate && p.IsActive && !p.IsDeleted)
            .FirstOrDefaultAsync();

        if (period != null)
        {
            if (period.Status == PeriodStatus.Closed)
            {
                return (false, $"Cannot save. The period {period.PeriodName} is closed. Please contact administrator to reopen.");
            }

            if (period.FinancialYear != null && period.FinancialYear.IsClosed)
            {
                return (false, $"Cannot save. The financial year {period.FinancialYear.Name} is closed.");
            }

            return (true, string.Empty);
        }

        var financialYear = await DbContext.FinancialYears
            .Where(fy => fy.StartDate <= transactionDate && fy.EndDate >= transactionDate && !fy.IsDeleted)
            .FirstOrDefaultAsync();

        if (financialYear != null && financialYear.IsClosed)
        {
            return (false, $"Cannot save. The financial year {financialYear.Name} is closed.");
        }

        return (true, string.Empty);
    }

    private async Task OpenOtherChargesDialog()
    {
        var existingCharges = _selectedOtherCharges.Select(c => new AWBOtherCharge
        {
            OtherChargeTypeId = c.ChargeTypeId,
            Amount = c.Amount
        }).ToList();

        var parameters = new DialogParameters<OtherChargesDialog>
        {
            { x => x.ExistingCharges, existingCharges }
        };

        var dialog = await DialogService.ShowAsync<OtherChargesDialog>("Select Other Charges", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is List<AWBOtherCharge> selectedCharges)
        {
            var chargeTypes = await DbContext.OtherChargeTypes.ToListAsync();
            _selectedOtherCharges = selectedCharges.Select(c => new OtherChargeSelection
            {
                ChargeTypeId = c.OtherChargeTypeId,
                ChargeName = chargeTypes.FirstOrDefault(ct => ct.Id == c.OtherChargeTypeId)?.Name ?? "Unknown",
                Amount = c.Amount
            }).ToList();

            _inscan.OtherCharge = _selectedOtherCharges.Sum(c => c.Amount);
            StateHasChanged();
        }
    }

    private async Task LoadExistingOtherCharges()
    {
        if (Id > 0)
        {
            var charges = await DbContext.AWBOtherCharges
                .Include(c => c.OtherChargeType)
                .Where(c => c.InscanId == Id)
                .ToListAsync();

            _selectedOtherCharges = charges.Select(c => new OtherChargeSelection
            {
                ChargeTypeId = c.OtherChargeTypeId,
                ChargeName = c.OtherChargeType?.Name ?? "Unknown",
                Amount = c.Amount
            }).ToList();

            _inscan.OtherCharge = _selectedOtherCharges.Sum(c => c.Amount);
        }
    }

    private async Task SaveOtherCharges()
    {
        if (Id > 0 || _inscan.Id > 0)
        {
            var inscanId = _inscan.Id;
            var existingCharges = await DbContext.AWBOtherCharges.Where(c => c.InscanId == inscanId).ToListAsync();
            DbContext.AWBOtherCharges.RemoveRange(existingCharges);

            foreach (var charge in _selectedOtherCharges)
            {
                DbContext.AWBOtherCharges.Add(new AWBOtherCharge
                {
                    InscanId = inscanId,
                    OtherChargeTypeId = charge.ChargeTypeId,
                    Amount = charge.Amount,
                    CreatedAt = DateTime.UtcNow
                });
            }
        }
    }

    private class OtherChargeSelection
    {
        public long ChargeTypeId { get; set; }
        public string ChargeName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }

    private MovementType CalculateMovementType()
    {
        bool originIsCompanyCountry = _originCountryId == _companyCountryId && _companyCountryId.HasValue;
        bool destIsCompanyCountry = _destCountryId == _companyCountryId && _companyCountryId.HasValue;

        if (originIsCompanyCountry && destIsCompanyCountry)
            return MovementType.Domestic;
        if (originIsCompanyCountry && !destIsCompanyCountry)
            return MovementType.InternationalExport;
        if (!originIsCompanyCountry && destIsCompanyCountry)
            return MovementType.InternationalImport;
        return MovementType.Transhipment;
    }

    private string GetMovementTypeDisplay()
    {
        var movementType = CalculateMovementType();
        return movementType switch
        {
            MovementType.Domestic => "Domestic",
            MovementType.InternationalExport => "International-Export",
            MovementType.InternationalImport => "International-Import",
            MovementType.Transhipment => "Transhipment",
            _ => "Unknown"
        };
    }

    private Color GetMovementChipColor()
    {
        var movementType = CalculateMovementType();
        return movementType switch
        {
            MovementType.Domestic => Color.Success,
            MovementType.InternationalExport => Color.Info,
            MovementType.InternationalImport => Color.Warning,
            MovementType.Transhipment => Color.Secondary,
            _ => Color.Default
        };
    }
}

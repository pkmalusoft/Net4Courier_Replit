@page "/customer-invoicing"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Web.Components.Shared
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject InvoicingService InvoicingService
@inject ExchangeRateService ExchangeRateService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Customer Invoicing</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudText Typo="Typo.h5">Customer Invoicing</MudText>
    </MudStack>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudAutocomplete T="Party" Label="Customer" @bind-Value="_selectedCustomer"
                                 SearchFunc="SearchCustomers" ToStringFunc="@(p => p?.Name ?? "")"
                                 Variant="Variant.Outlined" Dense="true" Required="true"
                                 Clearable="true" ResetValueOnEmptyText="true" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="Period From" @bind-Date="_periodFrom" DateFormat="dd-MMM-yyyy"
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="Period To" @bind-Date="_periodTo" DateFormat="dd-MMM-yyyy"
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="Invoice Date" @bind-Date="_invoiceDate" DateFormat="dd-MMM-yyyy"
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="FetchUnbilledAWBs"
                           Disabled="@(_selectedCustomer == null)" Class="mt-2" FullWidth="true">
                    Fetch AWBs
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-2">
            <MudItem xs="12" md="3">
                <MudSelect T="Currency" Label="Invoice Currency" Value="_selectedCurrency"
                           ValueChanged="OnCurrencyChanged"
                           ToStringFunc="@(c => c != null ? $"{c.Code} - {c.Name}" : "")"
                           Variant="Variant.Outlined" Dense="true">
                    @foreach (var curr in _currencies)
                    {
                        <MudSelectItem Value="@curr">@curr.Code - @curr.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField T="decimal" Label="Exchange Rate" @bind-Value="_exchangeRate"
                                 Format="N6" Variant="Variant.Outlined" Dense="true"
                                 ReadOnly="@(_isBranchCurrency)" />
            </MudItem>
            <MudItem xs="12" md="2">
                @if (!_isBranchCurrency)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.CurrencyExchange"
                               OnClick="FetchExchangeRate" Disabled="@_fetchingRate" Class="mt-2">
                        @if (_fetchingRate)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Fetching...</span>
                        }
                        else
                        {
                            <span>Fetch Ex.Rate</span>
                        }
                    </MudButton>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Success" Class="mt-3">Base currency (rate = 1)</MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (_preview != null)
    {
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4 mb-4">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6">AWB Details (@_preview.Details.Count AWBs)</MudText>
                    </MudStack>

                    <MudTable Items="@_preview.Details" Dense="true" Hover="true" FixedHeader="true" Height="400px">
                        <HeaderContent>
                            <MudTh>AWB No</MudTh>
                            <MudTh>Date</MudTh>
                            <MudTh>Origin</MudTh>
                            <MudTh>Destination</MudTh>
                            <MudTh>Pcs</MudTh>
                            <MudTh>Weight</MudTh>
                            <MudTh Style="text-align:right">Freight</MudTh>
                            <MudTh Style="text-align:right">Other</MudTh>
                            <MudTh Style="text-align:right">Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.AWBNo</MudTd>
                            <MudTd>@context.AWBDate.ToString("dd-MMM")</MudTd>
                            <MudTd>@context.Origin</MudTd>
                            <MudTd>@context.Destination</MudTd>
                            <MudTd>@context.Pieces</MudTd>
                            <MudTd>@context.Weight.ToString("N2")</MudTd>
                            <MudTd Style="text-align:right">@_invoiceCurrencySymbol@ConvertAmount(context.CourierCharge).ToString("N2")</MudTd>
                            <MudTd Style="text-align:right">@_invoiceCurrencySymbol@ConvertAmount(context.OtherCharge).ToString("N2")</MudTd>
                            <MudTd Style="text-align:right"><strong>@_invoiceCurrencySymbol@ConvertAmount(context.Total).ToString("N2")</strong></MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText>No unbilled AWBs found for the selected period</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4 mb-4" Style="background-color: #f5f5f5;">
                    <MudText Typo="Typo.h6" Class="mb-4">Invoice Summary</MudText>

                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Customer:</MudText>
                            <MudText><strong>@_preview.CustomerName</strong></MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Period:</MudText>
                            <MudText>@_preview.PeriodFrom.ToString("dd-MMM") - @_preview.PeriodTo.ToString("dd-MMM-yyyy")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Total AWBs:</MudText>
                            <MudText>@_preview.Details.Count</MudText>
                        </MudStack>

                        <MudDivider Class="my-2" />

                        @if (!_isBranchCurrency)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Foreign Currency: @_selectedCurrency?.Code</MudChip>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.caption">Exchange Rate:</MudText>
                                <MudText Typo="Typo.caption">1 @_branchCurrencyCode = @_exchangeRate.ToString("N6") @_selectedCurrency?.Code</MudText>
                            </MudStack>
                            <MudDivider Class="my-1" />
                        }

                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Sub Total:</MudText>
                            <MudText>@_invoiceCurrencySymbol@ConvertAmount(_preview.SubTotal).ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Tax (@_preview.TaxPercent%):</MudText>
                            <MudText>@_invoiceCurrencySymbol@ConvertAmount(_preview.TaxAmount).ToString("N2")</MudText>
                        </MudStack>

                        @if (_preview.SpecialCharges.Any())
                        {
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Special Charges (Read-Only)</MudText>

                            @foreach (var charge in _preview.SpecialCharges)
                            {
                                <MudPaper Class="pa-2" Elevation="0" Style="background-color: #e3f2fd;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2">@charge.ChargeName</MudText>
                                        <MudText Typo="Typo.body2">@_invoiceCurrencySymbol@ConvertAmount(charge.CalculatedAmount).ToString("N2")</MudText>
                                    </MudStack>
                                    @if (charge.IsTaxApplicable)
                                    {
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Tax (@charge.TaxPercent%)</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@_invoiceCurrencySymbol@ConvertAmount(charge.TaxAmount).ToString("N2")</MudText>
                                        </MudStack>
                                    }
                                </MudPaper>
                            }

                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText>Special Charges Total:</MudText>
                                <MudText>@_invoiceCurrencySymbol@(ConvertAmount(_preview.SpecialChargesTotal + _preview.SpecialChargesTax).ToString("N2"))</MudText>
                            </MudStack>
                        }

                        <MudDivider Class="my-2" />

                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Net Total:</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Primary">@_invoiceCurrencySymbol@ConvertAmount(_preview.NetTotal).ToString("N2")</MudText>
                        </MudStack>
                    </MudStack>

                    <MudStack Row="true" Spacing="2" Class="mt-4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearPreview" FullWidth="true">
                            Clear
                        </MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GenerateInvoice" 
                                   Disabled="@(!_preview.Details.Any())" FullWidth="true">
                            Generate Invoice
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudPaper Class="pa-8" Elevation="1">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">Select a Customer and Period</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Choose a customer and billing period, then click "Fetch AWBs" to generate an invoice preview.
                </MudText>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

@code {
    private bool _loading;
    private bool _fetchingRate;
    private Party? _selectedCustomer;
    private DateTime? _periodFrom;
    private DateTime? _periodTo;
    private DateTime? _invoiceDate;
    private InvoicePreviewModel? _preview;
    private Branch? _currentBranch;
    private string _currencySymbol = "";
    private string _branchCurrencyCode = "";
    private decimal _branchTaxPercent = 5;

    private List<Currency> _currencies = new();
    private Currency? _selectedCurrency;
    private decimal _exchangeRate = 1;
    private string _invoiceCurrencySymbol = "";
    private bool _isBranchCurrency => _selectedCurrency != null &&
        string.Equals(_selectedCurrency.Code, _branchCurrencyCode, StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        _periodFrom = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        _periodTo = DateTime.Today;
        _invoiceDate = DateTime.Today;

        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _currentBranch = await dbContext.Branches
            .Include(b => b.Currency)
            .FirstOrDefaultAsync(b => !b.IsDeleted && b.IsActive);
        if (_currentBranch != null)
        {
            _currencySymbol = _currentBranch.Currency?.Symbol ?? _currentBranch.Currency?.Code ?? "";
            _branchCurrencyCode = _currentBranch.Currency?.Code ?? "";
            _branchTaxPercent = _currentBranch.VatPercentage ?? 5;
        }

        _currencies = await dbContext.Set<Currency>()
            .Where(c => c.IsActive && !c.IsDeleted)
            .OrderBy(c => c.Code)
            .ToListAsync();

        _selectedCurrency = _currencies.FirstOrDefault(c =>
            string.Equals(c.Code, _branchCurrencyCode, StringComparison.OrdinalIgnoreCase));
        UpdateInvoiceCurrencySymbol();
    }

    private void UpdateInvoiceCurrencySymbol()
    {
        if (_selectedCurrency != null)
            _invoiceCurrencySymbol = _selectedCurrency.Symbol ?? _selectedCurrency.Code ?? "";
        else
            _invoiceCurrencySymbol = _currencySymbol;

        if (_isBranchCurrency)
            _exchangeRate = 1;
    }

    private decimal ConvertAmount(decimal amount)
    {
        return Math.Round(amount * _exchangeRate, 2);
    }

    private void OnCurrencyChanged(Currency value)
    {
        _selectedCurrency = value;
        UpdateInvoiceCurrencySymbol();
    }

    private async Task FetchExchangeRate()
    {
        if (_selectedCurrency == null || string.IsNullOrEmpty(_branchCurrencyCode))
        {
            Snackbar.Add("Please select a currency first", Severity.Warning);
            return;
        }

        _fetchingRate = true;
        StateHasChanged();

        try
        {
            var rate = await ExchangeRateService.GetExchangeRateAsync(_branchCurrencyCode, _selectedCurrency.Code);
            if (rate.HasValue)
            {
                _exchangeRate = rate.Value;
                Snackbar.Add($"Exchange rate fetched: 1 {_branchCurrencyCode} = {rate.Value:N6} {_selectedCurrency.Code}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Could not fetch exchange rate. Please enter manually.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching exchange rate: {ex.Message}", Severity.Error);
        }
        finally
        {
            _fetchingRate = false;
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<Party>> SearchCustomers(string value, CancellationToken cancellationToken)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (string.IsNullOrEmpty(value))
            return await dbContext.Parties
                .Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted)
                .Take(20).ToListAsync();

        return await dbContext.Parties
            .Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted &&
                   (p.Name.Contains(value) || (p.Code != null && p.Code.Contains(value))))
            .Take(20).ToListAsync();
    }

    private async Task FetchUnbilledAWBs()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (_selectedCustomer == null)
        {
            Snackbar.Add("Please select a customer", Severity.Warning);
            return;
        }

        _loading = true;
        StateHasChanged();

        try
        {
            var fromDate = DateTime.SpecifyKind(_periodFrom?.Date ?? DateTime.Today.AddMonths(-1), DateTimeKind.Utc);
            var toDate = DateTime.SpecifyKind(_periodTo?.Date ?? DateTime.Today, DateTimeKind.Utc);
            var invoiceDate = _invoiceDate?.Date ?? DateTime.Today;

            var awbs = await InvoicingService.GetUnbilledAWBs(_selectedCustomer.Id, fromDate, toDate);
            var specialCharges = await InvoicingService.GetApplicableSpecialCharges(_selectedCustomer.Id, invoiceDate);

            var address = await dbContext.PartyAddresses
                .Where(a => a.PartyId == _selectedCustomer.Id && a.IsDefault)
                .FirstOrDefaultAsync();

            var fullAddress = address != null
                ? $"{address.Street}, {address.Area}, {address.City}, {address.State} {address.PostalCode}"
                : null;

            _preview = await InvoicingService.GenerateInvoicePreviewAsync(
                _selectedCustomer.Id,
                _selectedCustomer.Name,
                fullAddress,
                _selectedCustomer.TaxNumber,
                invoiceDate,
                fromDate,
                toDate,
                awbs,
                specialCharges,
                _branchTaxPercent
            );

            if (!awbs.Any())
            {
                Snackbar.Add("No unbilled AWBs found for the selected period", Severity.Info);
            }
            else
            {
                Snackbar.Add($"Found {awbs.Count} unbilled AWBs", Severity.Success);
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ClearPreview()
    {
        _preview = null;
    }


    private async Task GenerateInvoice()
    {
        if (_preview == null || !_preview.Details.Any())
        {
            Snackbar.Add("No AWBs to invoice", Severity.Warning);
            return;
        }

        var totalDisplay = $"{_invoiceCurrencySymbol}{ConvertAmount(_preview.NetTotal):N2}";
        var confirmed = await DialogService.ShowMessageBox(
            "Generate Invoice",
            $"Generate invoice for {_preview.Details.Count} AWBs totaling {totalDisplay}?",
            yesText: "Generate", cancelText: "Cancel");

        if (confirmed == true)
        {
            _loading = true;
            StateHasChanged();

            try
            {
                _preview.CurrencyCode = _selectedCurrency?.Code;
                _preview.CurrencySymbol = _invoiceCurrencySymbol;
                _preview.ExchangeRate = _exchangeRate;
                _preview.BranchCurrencyCode = _branchCurrencyCode;
                var invoice = await InvoicingService.CreateInvoice(_preview);
                Snackbar.Add($"Invoice {invoice.InvoiceNo} created successfully", Severity.Success);
                _preview = null;
                Navigation.NavigateTo($"/invoice-view/{invoice.Id}");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error creating invoice: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
                StateHasChanged();
            }
        }
    }
}

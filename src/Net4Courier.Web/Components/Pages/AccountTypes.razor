@page "/account-types"
@inject ApplicationDbContext DbContext
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities

<PageTitle>Account Types</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h5">Account Types</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddNew">
                Add Account Type
            </MudButton>
        </MudStack>

        <MudTable Items="@_accountTypes" Dense="true" Hover="true" Bordered="true" Striped="true" Loading="@_loading">
            <HeaderContent>
                <MudTh>Code</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Sort Order</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="width: 120px;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code">@context.Code</MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Description">@context.Description</MudTd>
                <MudTd DataLabel="Sort Order">@context.SortOrder</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                        @(context.IsActive ? "Active" : "Inactive")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" 
                                   OnClick="@(() => Edit(context))" Title="Edit" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" 
                                   OnClick="@(() => Delete(context))" Title="Delete" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No account types found</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<AccountType> _accountTypes = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _accountTypes = await DbContext.AccountTypes
            .Where(a => !a.IsDeleted)
            .OrderBy(a => a.SortOrder)
            .ThenBy(a => a.Name)
            .ToListAsync();
        _loading = false;
    }

    private async Task AddNew()
    {
        var parameters = new DialogParameters<AccountTypeDialog>
        {
            { x => x.AccountType, new AccountType() },
            { x => x.IsNew, true }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AccountTypeDialog>("New Account Type", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
        {
            await LoadData();
        }
    }

    private async Task Edit(AccountType accountType)
    {
        var parameters = new DialogParameters<AccountTypeDialog>
        {
            { x => x.AccountType, accountType },
            { x => x.IsNew, false }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AccountTypeDialog>("Edit Account Type", parameters, options);
        var result = await dialog.Result;
        
        if (result is { Canceled: false })
        {
            await LoadData();
        }
    }

    private async Task Delete(AccountType accountType)
    {
        var inUse = await DbContext.Parties.AnyAsync(p => p.AccountTypeId == accountType.Id && !p.IsDeleted);
        if (inUse)
        {
            Snackbar.Add("Cannot delete: This account type is in use by customers", Severity.Warning);
            return;
        }

        var confirmed = await DialogService.ShowMessageBox(
            "Delete Account Type",
            $"Are you sure you want to delete '{accountType.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirmed == true)
        {
            accountType.IsDeleted = true;
            accountType.ModifiedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadData();
            Snackbar.Add("Account type deleted", Severity.Success);
        }
    }
}

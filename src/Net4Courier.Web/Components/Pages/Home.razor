@page "/"
@inject Net4Courier.Infrastructure.Data.ApplicationDbContext DbContext
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>Dashboard - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Dashboard</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">Welcome to Net4Courier Management System</MudText>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
}
else
{
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Shipments</MudText>
                        <MudText Typo="Typo.h4">@_stats.TotalShipments.ToString("N0")</MudText>
                    </div>
                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" />
                    </MudAvatar>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.Today" Size="Size.Small" /> @_stats.TodayShipments today
                </MudText>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Pending Deliveries</MudText>
                        <MudText Typo="Typo.h4">@_stats.PendingDeliveries.ToString("N0")</MudText>
                    </div>
                    <MudAvatar Color="Color.Warning" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" />
                    </MudAvatar>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Warning" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" /> @_stats.OutForDelivery out for delivery
                </MudText>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Revenue</MudText>
                        <MudText Typo="Typo.h4">@FormatCurrency(_stats.TotalRevenue)</MudText>
                    </div>
                    <MudAvatar Color="Color.Success" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                    </MudAvatar>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Success" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" /> @FormatCurrency(_stats.MonthRevenue) this month
                </MudText>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Active Customers</MudText>
                        <MudText Typo="Typo.h4">@_stats.ActiveCustomers.ToString("N0")</MudText>
                    </div>
                    <MudAvatar Color="Color.Info" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.People" />
                    </MudAvatar>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Info" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" /> @_stats.NewCustomersThisMonth new this month
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Domestic</MudText>
                        <MudText Typo="Typo.h5">@_stats.DomesticShipments</MudText>
                    </div>
                    <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Medium">
                        <MudIcon Icon="@Icons.Material.Filled.Home" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Export</MudText>
                        <MudText Typo="Typo.h5">@_stats.ExportShipments</MudText>
                    </div>
                    <MudAvatar Color="Color.Success" Variant="Variant.Outlined" Size="Size.Medium">
                        <MudIcon Icon="@Icons.Material.Filled.FlightTakeoff" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Import</MudText>
                        <MudText Typo="Typo.h5">@_stats.ImportShipments</MudText>
                    </div>
                    <MudAvatar Color="Color.Info" Variant="Variant.Outlined" Size="Size.Medium">
                        <MudIcon Icon="@Icons.Material.Filled.FlightLand" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Transhipment</MudText>
                        <MudText Typo="Typo.h5">@_stats.TranshipmentShipments</MudText>
                    </div>
                    <MudAvatar Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Medium">
                        <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-4">
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Recent Shipments</MudText>
                @if (_recentShipments.Any())
                {
                    <MudTable Items="@_recentShipments" Hover="true" Striped="true" Dense="true">
                        <HeaderContent>
                            <MudTh>AWB No</MudTh>
                            <MudTh>Consignor</MudTh>
                            <MudTh>Destination</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Date</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="AWB No">@context.AWBNo</MudTd>
                            <MudTd DataLabel="Consignor">@context.Consignor</MudTd>
                            <MudTd DataLabel="Destination">@context.ConsigneeCity, @context.ConsigneeCountry</MudTd>
                            <MudTd DataLabel="Type">
                                <MudChip T="string" Color="@GetMovementTypeColor(context.MovementTypeId)" Size="Size.Small">
                                    @GetMovementTypeName(context.MovementTypeId)
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@GetStatusColor(context.CourierStatusId)" Size="Size.Small">
                                    @context.CourierStatusId.ToString()
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Date">@context.TransactionDate.ToString("dd/MM/yyyy")</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No shipments found. Create your first AWB to get started.</MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Quick Actions</MudText>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Add" Href="/awb/new">
                        New AWB Entry
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" Href="/awb">
                        Track Shipment
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" StartIcon="@Icons.Material.Filled.Description" Href="/invoices">
                        Generate Invoice
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" StartIcon="@Icons.Material.Filled.Assessment" Href="/reports">
                        View Reports
                    </MudButton>
                </MudStack>
            </MudPaper>
            
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Status Overview</MudText>
                <MudStack Spacing="2">
                    <div class="d-flex justify-space-between">
                        <MudText>Delivered</MudText>
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">@_stats.DeliveredShipments</MudChip>
                    </div>
                    <div class="d-flex justify-space-between">
                        <MudText>In Transit</MudText>
                        <MudChip T="string" Color="Color.Primary" Size="Size.Small">@_stats.InTransitShipments</MudChip>
                    </div>
                    <div class="d-flex justify-space-between">
                        <MudText>Pending</MudText>
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">@_stats.PendingDeliveries</MudChip>
                    </div>
                    <div class="d-flex justify-space-between">
                        <MudText>Returned</MudText>
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">@_stats.ReturnedShipments</MudChip>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _isLoading = true;
    private DashboardStats _stats = new();
    private List<InscanMaster> _recentShipments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        _isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        var today = DateTime.Today;
        var startOfMonth = new DateTime(today.Year, today.Month, 1);

        _stats.TotalShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted);

        _stats.TodayShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.TransactionDate.Date == today);

        _stats.PendingDeliveries = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Pending);

        _stats.OutForDelivery = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.OutForDelivery);

        _stats.InTransitShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.InTransit);

        _stats.DeliveredShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Delivered);

        _stats.ReturnedShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Returned);

        _stats.TotalRevenue = await DbContext.InscanMasters
            .Where(s => !s.IsDeleted)
            .SumAsync(s => s.NetTotal ?? 0);

        _stats.MonthRevenue = await DbContext.InscanMasters
            .Where(s => !s.IsDeleted && s.TransactionDate >= startOfMonth)
            .SumAsync(s => s.NetTotal ?? 0);

        _stats.ActiveCustomers = await DbContext.Parties
            .CountAsync(p => !p.IsDeleted && p.IsActive && p.PartyType == Net4Courier.Masters.Entities.PartyType.Customer);

        _stats.NewCustomersThisMonth = await DbContext.Parties
            .CountAsync(p => !p.IsDeleted && p.PartyType == Net4Courier.Masters.Entities.PartyType.Customer && p.CreatedAt >= startOfMonth);

        _stats.DomesticShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.Domestic);

        _stats.ExportShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.InternationalExport);

        _stats.ImportShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.InternationalImport);

        _stats.TranshipmentShipments = await DbContext.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.Transhipment);

        _recentShipments = await DbContext.InscanMasters
            .Where(s => !s.IsDeleted)
            .OrderByDescending(s => s.TransactionDate)
            .ThenByDescending(s => s.Id)
            .Take(10)
            .ToListAsync();
    }

    private string FormatCurrency(decimal amount)
    {
        if (amount >= 1000000)
            return $"${amount / 1000000:N1}M";
        if (amount >= 1000)
            return $"${amount / 1000:N1}K";
        return $"${amount:N0}";
    }

    private Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Delivered => Color.Success,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Info,
        CourierStatus.Pending => Color.Warning,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private Color GetMovementTypeColor(MovementType type) => type switch
    {
        MovementType.Domestic => Color.Primary,
        MovementType.InternationalExport => Color.Success,
        MovementType.InternationalImport => Color.Info,
        MovementType.Transhipment => Color.Warning,
        _ => Color.Default
    };

    private string GetMovementTypeName(MovementType type) => type switch
    {
        MovementType.Domestic => "Domestic",
        MovementType.InternationalExport => "Export",
        MovementType.InternationalImport => "Import",
        MovementType.Transhipment => "Tranship",
        _ => "Unknown"
    };

    private class DashboardStats
    {
        public int TotalShipments { get; set; }
        public int TodayShipments { get; set; }
        public int PendingDeliveries { get; set; }
        public int OutForDelivery { get; set; }
        public int InTransitShipments { get; set; }
        public int DeliveredShipments { get; set; }
        public int ReturnedShipments { get; set; }
        public decimal TotalRevenue { get; set; }
        public decimal MonthRevenue { get; set; }
        public int ActiveCustomers { get; set; }
        public int NewCustomersThisMonth { get; set; }
        public int DomesticShipments { get; set; }
        public int ExportShipments { get; set; }
        public int ImportShipments { get; set; }
        public int TranshipmentShipments { get; set; }
    }
}

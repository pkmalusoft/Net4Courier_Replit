@page "/"
@inject IDbContextFactory<Net4Courier.Infrastructure.Data.ApplicationDbContext> DbContextFactory
@inject IDialogService DialogService
@inject Net4Courier.Web.Services.GlobalSearchService SearchService
@inject NavigationManager NavigationManager
@inject Net4Courier.Web.Services.AppAuthStateProvider AppAuthState
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@using System.Linq

<PageTitle>Dashboard - Net4Courier</PageTitle>

<style>
    .global-search-container {
        position: relative;
        flex: 1;
        max-width: 500px;
        margin-left: 24px;
    }
    .global-search-field .mud-input-root {
        background: #f8fafc !important;
        border-radius: 8px !important;
        border: 1px solid #e2e8f0 !important;
    }
    .global-search-field .mud-input-root:focus-within {
        border-color: #556ee6 !important;
        box-shadow: 0 0 0 3px rgba(85, 110, 230, 0.1) !important;
    }
    .search-result-item {
        padding: 10px 16px;
        cursor: pointer;
        transition: background 0.15s ease;
    }
    .search-result-item:hover {
        background: #f1f5f9;
    }
    .search-category-header {
        padding: 8px 16px;
        background: #f8fafc;
        font-weight: 600;
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .search-kbd {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 0.75rem;
        color: #64748b;
        font-family: monospace;
    }
    .stat-card {
        border-radius: 12px !important;
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .stat-icon-primary { background: rgba(85, 110, 230, 0.1); color: #556ee6; }
    .stat-icon-warning { background: rgba(249, 168, 37, 0.1); color: #F9A825; }
    .stat-icon-success { background: rgba(52, 195, 143, 0.1); color: #34c38f; }
    .stat-icon-info { background: rgba(80, 165, 241, 0.1); color: #50a5f1; }
    .stat-icon-error { background: rgba(244, 106, 106, 0.1); color: #f46a6a; }
    .type-card {
        border-radius: 10px !important;
        border-left: 4px solid;
        transition: all 0.2s ease;
    }
    .type-card:hover {
        transform: translateY(-1px);
    }
    .type-domestic { border-left-color: #556ee6; }
    .type-export { border-left-color: #34c38f; }
    .type-import { border-left-color: #50a5f1; }
    .type-tranship { border-left-color: #F9A825; }
    .quick-action-card {
        border-radius: 12px !important;
    }
</style>

<div class="d-flex align-center mb-4">
    <div>
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Dashboard</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">Welcome back! Here's your operations overview.</MudText>
    </div>
    
    <div class="global-search-container">
        <MudAutocomplete T="SearchResult"
                         @ref="_searchField"
                         Value="_selectedResult"
                         ValueChanged="OnSearchResultSelected"
                         SearchFunc="SearchAsync"
                         Placeholder="Search by AWB, Customer, or Invoice..."
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Class="global-search-field"
                         Immediate="true"
                         DebounceInterval="300"
                         MinCharacters="2"
                         MaxItems="15"
                         Dense="true"
                         ResetValueOnEmptyText="true"
                         CoerceText="false"
                         CoerceValue="false"
                         ToStringFunc="@(r => r?.Title ?? "")">
            <ItemTemplate>
                <div class="d-flex align-center gap-3 py-1">
                    <MudIcon Icon="@GetResultIcon(context)" Size="Size.Small" Color="@GetResultColor(context)" />
                    <div class="flex-grow-1">
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Title</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Subtitle</MudText>
                    </div>
                    @if (!string.IsNullOrEmpty(context.Status))
                    {
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@GetStatusChipColor(context.Status)" Style="font-size: 0.65rem;">
                            @context.Status
                        </MudChip>
                    }
                </div>
            </ItemTemplate>
            <NoItemsTemplate>
                <div class="pa-4 text-center">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No results found</MudText>
                </div>
            </NoItemsTemplate>
            <MoreItemsTemplate>
                <div class="pa-2 text-center">
                    <MudText Typo="Typo.caption" Color="Color.Primary">Type more to refine results...</MudText>
                </div>
            </MoreItemsTemplate>
        </MudAutocomplete>
    </div>
    
    <MudSpacer />
    <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small" Icon="@Icons.Material.Filled.CalendarToday">
        @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
    </MudChip>
</div>

@if (_isLoading)
{
    <div class="d-flex justify-center align-center" style="min-height: 300px;">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
    </div>
}
else
{
    <MudGrid Spacing="4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Total Shipments</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.TotalShipments.ToString("N0")</MudText>
                        <div class="d-flex align-center gap-1 mt-2">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Success">@_stats.TodayShipments today</MudText>
                        </div>
                    </div>
                    <div class="stat-icon stat-icon-primary">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Pending Deliveries</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.PendingDeliveries.ToString("N0")</MudText>
                        <div class="d-flex align-center gap-1 mt-2">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Warning" />
                            <MudText Typo="Typo.caption" Color="Color.Warning">@_stats.OutForDelivery out for delivery</MudText>
                        </div>
                    </div>
                    <div class="stat-icon stat-icon-warning">
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Total Revenue</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@FormatCurrency(_stats.TotalRevenue)</MudText>
                        <div class="d-flex align-center gap-1 mt-2">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.caption" Color="Color.Success">@FormatCurrency(_stats.MonthRevenue) this month</MudText>
                        </div>
                    </div>
                    <div class="stat-icon stat-icon-success">
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Active Customers</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.ActiveCustomers.ToString("N0")</MudText>
                        <div class="d-flex align-center gap-1 mt-2">
                            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.caption" Color="Color.Info">@_stats.NewCustomersThisMonth new this month</MudText>
                        </div>
                    </div>
                    <div class="stat-icon stat-icon-info">
                        <MudIcon Icon="@Icons.Material.Filled.People" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="4" Class="mt-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Delivered</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.DeliveredShipments.ToString("N0")</MudText>
                    </div>
                    <div class="stat-icon stat-icon-success">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Out for Delivery</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.OutForDelivery.ToString("N0")</MudText>
                    </div>
                    <div class="stat-icon stat-icon-info">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">In Transit</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.InTransitShipments.ToString("N0")</MudText>
                    </div>
                    <div class="stat-icon stat-icon-primary">
                        <MudIcon Icon="@Icons.Material.Filled.Flight" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-weight: 500;">Returned</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;" Class="mt-1">@_stats.ReturnedShipments.ToString("N0")</MudText>
                    </div>
                    <div class="stat-icon stat-icon-error">
                        <MudIcon Icon="@Icons.Material.Filled.AssignmentReturn" />
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h6" Class="mt-6 mb-3" Style="font-weight: 600;">Shipment Types</MudText>
    <MudGrid Spacing="3">
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-4 type-card type-domestic" Elevation="0">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Domestic</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_stats.DomesticShipments</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Home" Color="Color.Primary" />
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-4 type-card type-export" Elevation="0">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Export</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_stats.ExportShipments</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.FlightTakeoff" Color="Color.Success" />
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-4 type-card type-import" Elevation="0">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Import</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_stats.ImportShipments</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.FlightLand" Color="Color.Info" />
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="6" sm="3">
            <MudPaper Class="pa-4 type-card type-tranship" Elevation="0">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Transhipment</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_stats.TranshipmentShipments</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" Color="Color.Warning" />
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-6" Spacing="4">
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-5 stat-card" Elevation="0">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Recent Shipments</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" EndIcon="@Icons.Material.Filled.ArrowForward" Href="/awb-list">
                        View All
                    </MudButton>
                </div>
                @if (_recentShipmentItems.Any())
                {
                    <MudTable Items="@_recentShipmentItems" Hover="true" Dense="true" Elevation="0" Class="rounded-lg">
                        <HeaderContent>
                            <MudTh Style="font-weight: 600;">AWB No</MudTh>
                            <MudTh Style="font-weight: 600;">Shipper</MudTh>
                            <MudTh Style="font-weight: 600;">Destination</MudTh>
                            <MudTh Style="font-weight: 600;">Type</MudTh>
                            <MudTh Style="font-weight: 600;">Status</MudTh>
                            <MudTh Style="font-weight: 600;">Date</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="AWB No">
                                <MudLink Href="@context.TrackingUrl" Color="Color.Primary" Style="font-weight: 500;">
                                    @context.AWBNo
                                </MudLink>
                            </MudTd>
                            <MudTd DataLabel="Shipper">
                                <div>
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.ShipperName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.ShipperCity</MudText>
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Destination">@context.DestinationCity, @context.DestinationCountry</MudTd>
                            <MudTd DataLabel="Type">
                                <MudChip T="string" Color="@context.TypeColor" Size="Size.Small" Variant="Variant.Filled" Style="font-size: 0.7rem;">
                                    @context.TypeName
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@context.StatusColor" Size="Size.Small" Variant="Variant.Outlined" Style="font-size: 0.7rem;">
                                    @context.StatusName
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Date">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@context.TransactionDate.ToString("dd MMM yyyy")</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="rounded-lg">
                        No shipments found. Create your first AWB to get started.
                    </MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-5 quick-action-card" Elevation="0" Style="border: 1px solid rgba(0,0,0,0.05);">
                <MudText Typo="Typo.h6" Style="font-weight: 600;" Class="mb-4">Quick Actions</MudText>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Add" Href="/awb-entry" Class="rounded-lg" Style="text-transform: none; font-weight: 500;">
                        New AWB Entry
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" StartIcon="@Icons.Material.Filled.LocalShipping" Href="/pickup-request-new" Class="rounded-lg" Style="text-transform: none; font-weight: 500;">
                        New Pickup Request
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" Href="/tracking" Class="rounded-lg" Style="text-transform: none; font-weight: 500;">
                        Track Shipment
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" StartIcon="@Icons.Material.Filled.Receipt" Href="/customer-invoicing" Class="rounded-lg" Style="text-transform: none; font-weight: 500;">
                        Generate Invoice
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" StartIcon="@Icons.Material.Filled.Assessment" OnClick="OpenReportsDialog" Class="rounded-lg" Style="text-transform: none; font-weight: 500;">
                        View Reports
                    </MudButton>
                </MudStack>
            </MudPaper>
            
            <MudPaper Class="pa-5 mt-4 quick-action-card" Elevation="0" Style="border: 1px solid rgba(0,0,0,0.05);">
                <MudText Typo="Typo.h6" Style="font-weight: 600;" Class="mb-4">Status Overview</MudText>
                <MudStack Spacing="3">
                    <div class="d-flex justify-space-between align-center">
                        <div class="d-flex align-center gap-2">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #34c38f;"></div>
                            <MudText Typo="Typo.body2">Delivered</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_stats.DeliveredShipments</MudText>
                    </div>
                    <div class="d-flex justify-space-between align-center">
                        <div class="d-flex align-center gap-2">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #556ee6;"></div>
                            <MudText Typo="Typo.body2">In Transit</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_stats.InTransitShipments</MudText>
                    </div>
                    <div class="d-flex justify-space-between align-center">
                        <div class="d-flex align-center gap-2">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #F9A825;"></div>
                            <MudText Typo="Typo.body2">Pending</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_stats.PendingDeliveries</MudText>
                    </div>
                    <div class="d-flex justify-space-between align-center">
                        <div class="d-flex align-center gap-2">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #f46a6a;"></div>
                            <MudText Typo="Typo.body2">Returned</MudText>
                        </div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_stats.ReturnedShipments</MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _isLoading = true;
    private DashboardStats _stats = new();
    private List<RecentShipmentItem> _recentShipmentItems = new();
    private MudAutocomplete<SearchResult>? _searchField;
    private SearchResult? _selectedResult;

    private async Task<IEnumerable<SearchResult>> SearchAsync(string query, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(query) || query.Length < 2)
            return Enumerable.Empty<SearchResult>();
        
        try
        {
            var results = await SearchService.SearchAsync(query);
            return results;
        }
        catch
        {
            return Enumerable.Empty<SearchResult>();
        }
    }

    private void OnSearchResultSelected(SearchResult? result)
    {
        _selectedResult = result;
        if (result != null)
        {
            var url = result.NavigateUrl;
            _selectedResult = null;
            StateHasChanged();
            NavigationManager.NavigateTo(url);
        }
    }

    private string GetResultIcon(SearchResult result) => result.Type switch
    {
        SearchResultType.AWB => Icons.Material.Filled.LocalShipping,
        SearchResultType.Customer => Icons.Material.Filled.Person,
        SearchResultType.Invoice => Icons.Material.Filled.Receipt,
        _ => Icons.Material.Filled.Search
    };

    private Color GetResultColor(SearchResult result) => result.Type switch
    {
        SearchResultType.AWB => Color.Primary,
        SearchResultType.Customer => Color.Success,
        SearchResultType.Invoice => Color.Warning,
        _ => Color.Default
    };

    private Color GetStatusChipColor(string status)
    {
        if (Enum.TryParse<CourierStatus>(status, out var courierStatus))
        {
            return courierStatus switch
            {
                CourierStatus.Delivered => Color.Success,
                CourierStatus.InTransit => Color.Primary,
                CourierStatus.OutForDelivery => Color.Info,
                CourierStatus.Pending => Color.Warning,
                CourierStatus.Returned => Color.Error,
                _ => Color.Default
            };
        }
        return Color.Default;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        _isLoading = false;
    }

    private async Task LoadDashboardData()
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();
        
        var today = DateTime.UtcNow.Date;
        var startOfMonth = new DateTime(today.Year, today.Month, 1, 0, 0, 0, DateTimeKind.Utc);

        var inscanCount = await context.InscanMasters.CountAsync(s => !s.IsDeleted);
        var allInscanAwbNos = await context.InscanMasters
            .Where(s => !s.IsDeleted)
            .Select(s => s.AWBNo)
            .ToListAsync();
        var importCount = await context.ImportShipments.CountAsync(s => !s.IsDeleted && !s.LinkedInscanMasterId.HasValue && !allInscanAwbNos.Contains(s.AWBNo));
        _stats.TotalShipments = inscanCount + importCount;

        var inscanToday = await context.InscanMasters.CountAsync(s => !s.IsDeleted && s.TransactionDate.Date == today);
        var importToday = await context.ImportShipments.Include(s => s.ImportMaster).CountAsync(s => !s.IsDeleted && !s.LinkedInscanMasterId.HasValue && !allInscanAwbNos.Contains(s.AWBNo) && s.ImportMaster != null && s.ImportMaster.TransactionDate.Date == today);
        _stats.TodayShipments = inscanToday + importToday;

        _stats.PendingDeliveries = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Pending);

        _stats.OutForDelivery = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.OutForDelivery);

        _stats.InTransitShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.InTransit);

        _stats.DeliveredShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Delivered);

        _stats.ReturnedShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.CourierStatusId == CourierStatus.Returned);

        _stats.TotalRevenue = await context.InscanMasters
            .Where(s => !s.IsDeleted)
            .SumAsync(s => s.NetTotal ?? 0);

        _stats.MonthRevenue = await context.InscanMasters
            .Where(s => !s.IsDeleted && s.TransactionDate >= startOfMonth)
            .SumAsync(s => s.NetTotal ?? 0);

        _stats.ActiveCustomers = await context.Parties
            .CountAsync(p => !p.IsDeleted && p.IsActive && p.PartyType == Net4Courier.Masters.Entities.PartyType.Customer);

        _stats.NewCustomersThisMonth = await context.Parties
            .CountAsync(p => !p.IsDeleted && p.PartyType == Net4Courier.Masters.Entities.PartyType.Customer && p.CreatedAt >= startOfMonth);

        _stats.DomesticShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.Domestic);

        _stats.ExportShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.InternationalExport);

        var inscanImportCount = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.InternationalImport);
        var inscanImportAwbNos = await context.InscanMasters
            .Where(s => !s.IsDeleted && s.MovementTypeId == MovementType.InternationalImport)
            .Select(s => s.AWBNo)
            .ToListAsync();
        var unlinkedImportCount = await context.ImportShipments
            .CountAsync(s => !s.IsDeleted && !s.LinkedInscanMasterId.HasValue && !inscanImportAwbNos.Contains(s.AWBNo));
        _stats.ImportShipments = inscanImportCount + unlinkedImportCount;

        _stats.TranshipmentShipments = await context.InscanMasters
            .CountAsync(s => !s.IsDeleted && s.MovementTypeId == MovementType.Transhipment);

        var recentInscanRaw = await context.InscanMasters
            .Where(s => !s.IsDeleted)
            .OrderByDescending(s => s.TransactionDate)
            .ThenByDescending(s => s.Id)
            .Take(10)
            .Select(s => new { s.AWBNo, s.Consignor, s.ConsignorCity, s.ConsigneeCity, s.ConsigneeCountry, s.MovementTypeId, s.CourierStatusId, s.TransactionDate })
            .ToListAsync();

        var recentInscan = recentInscanRaw.Select(s => new RecentShipmentItem
        {
            AWBNo = s.AWBNo,
            ShipperName = s.Consignor ?? "-",
            ShipperCity = s.ConsignorCity ?? "-",
            DestinationCity = s.ConsigneeCity ?? "-",
            DestinationCountry = s.ConsigneeCountry ?? "-",
            TypeName = GetMovementTypeName(s.MovementTypeId),
            TypeColor = GetMovementTypeColor(s.MovementTypeId),
            StatusName = FormatCourierStatus(s.CourierStatusId),
            StatusColor = GetStatusColor(s.CourierStatusId),
            TransactionDate = s.TransactionDate,
            TrackingUrl = $"/tracking/{s.AWBNo}",
            IsImport = false
        }).ToList();

        var recentImportRaw = await context.ImportShipments
            .Include(s => s.ImportMaster)
            .Where(s => !s.IsDeleted && !s.LinkedInscanMasterId.HasValue)
            .OrderByDescending(s => s.ImportMaster!.TransactionDate)
            .ThenByDescending(s => s.Id)
            .Take(10)
            .Select(s => new { s.AWBNo, s.ShipperName, s.ShipperCity, s.ConsigneeCity, s.ConsigneeCountry, s.Status, s.ImportMasterId, TransactionDate = s.ImportMaster != null ? s.ImportMaster.TransactionDate : s.CreatedAt })
            .ToListAsync();

        var recentImport = recentImportRaw.Select(s => new RecentShipmentItem
        {
            AWBNo = s.AWBNo,
            ShipperName = s.ShipperName ?? "-",
            ShipperCity = s.ShipperCity ?? "-",
            DestinationCity = s.ConsigneeCity ?? "-",
            DestinationCountry = s.ConsigneeCountry ?? "-",
            TypeName = "Import",
            TypeColor = Color.Info,
            StatusName = s.Status.ToString(),
            StatusColor = GetImportStatusColor(s.Status),
            TransactionDate = s.TransactionDate,
            TrackingUrl = $"/tracking/{s.AWBNo}",
            IsImport = true
        }).ToList();

        var inscanAwbNos = new HashSet<string>(recentInscan.Select(r => r.AWBNo), StringComparer.OrdinalIgnoreCase);
        var filteredImport = recentImport.Where(r => !inscanAwbNos.Contains(r.AWBNo));

        _recentShipmentItems = recentInscan
            .Concat(filteredImport)
            .OrderByDescending(s => s.TransactionDate)
            .Take(10)
            .ToList();
    }

    private string FormatCurrency(decimal amount)
    {
        var code = AppAuthState.CurrencyCode;
        if (amount >= 1000000)
            return $"{code} {amount / 1000000:N1}M";
        if (amount >= 1000)
            return $"{code} {amount / 1000:N1}K";
        return $"{code} {amount:N0}";
    }

    private static Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Delivered => Color.Success,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Info,
        CourierStatus.Pending => Color.Warning,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private static Color GetImportStatusColor(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.Cleared or ImportShipmentStatus.Released or ImportShipmentStatus.HandedOver => Color.Success,
        ImportShipmentStatus.Inscanned or ImportShipmentStatus.ReceivedAtWarehouse => Color.Info,
        ImportShipmentStatus.PendingCustoms or ImportShipmentStatus.AwaitingDocuments => Color.Warning,
        ImportShipmentStatus.CustomsHold or ImportShipmentStatus.UnderExamination or ImportShipmentStatus.OnHold => Color.Error,
        ImportShipmentStatus.Expected => Color.Default,
        _ => Color.Default
    };

    private static Color GetMovementTypeColor(MovementType type) => type switch
    {
        MovementType.Domestic => Color.Primary,
        MovementType.InternationalExport => Color.Success,
        MovementType.InternationalImport => Color.Info,
        MovementType.Transhipment => Color.Warning,
        _ => Color.Default
    };

    private static string FormatCourierStatus(CourierStatus status) => status switch
    {
        CourierStatus.Pending => "Pending",
        CourierStatus.AssignedToPickup => "Assigned",
        CourierStatus.PickedUp => "Picked Up",
        CourierStatus.InscanAtOrigin => "Inscan Origin",
        CourierStatus.InTransit => "In Transit",
        CourierStatus.InscanAtDestination => "Inscan Dest.",
        CourierStatus.OutForDelivery => "Out for Delivery",
        CourierStatus.Delivered => "Delivered",
        CourierStatus.NotDelivered => "Not Delivered",
        CourierStatus.ReturnToOrigin => "Return to Origin",
        CourierStatus.Returned => "Returned",
        CourierStatus.OnHold => "On Hold",
        CourierStatus.Cancelled => "Cancelled",
        _ => status.ToString()
    };

    private static string GetMovementTypeName(MovementType type) => type switch
    {
        MovementType.Domestic => "Domestic",
        MovementType.InternationalExport => "Export",
        MovementType.InternationalImport => "Import",
        MovementType.Transhipment => "Tranship",
        _ => "Unknown"
    };

    private async Task OpenReportsDialog()
    {
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        await DialogService.ShowAsync<ReportsDialog>("Reports", options);
    }

    private class RecentShipmentItem
    {
        public string AWBNo { get; set; } = "";
        public string ShipperName { get; set; } = "";
        public string ShipperCity { get; set; } = "";
        public string DestinationCity { get; set; } = "";
        public string DestinationCountry { get; set; } = "";
        public string TypeName { get; set; } = "";
        public Color TypeColor { get; set; }
        public string StatusName { get; set; } = "";
        public Color StatusColor { get; set; }
        public DateTime TransactionDate { get; set; }
        public string TrackingUrl { get; set; } = "";
        public bool IsImport { get; set; }
    }

    private class DashboardStats
    {
        public int TotalShipments { get; set; }
        public int TodayShipments { get; set; }
        public int PendingDeliveries { get; set; }
        public int OutForDelivery { get; set; }
        public int InTransitShipments { get; set; }
        public int DeliveredShipments { get; set; }
        public int ReturnedShipments { get; set; }
        public decimal TotalRevenue { get; set; }
        public decimal MonthRevenue { get; set; }
        public int ActiveCustomers { get; set; }
        public int NewCustomersThisMonth { get; set; }
        public int DomesticShipments { get; set; }
        public int ExportShipments { get; set; }
        public int ImportShipments { get; set; }
        public int TranshipmentShipments { get; set; }
    }
}

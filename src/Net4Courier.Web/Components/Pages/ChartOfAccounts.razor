@page "/chart-of-accounts"
@inject ApplicationDbContext DbContext
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Chart of Accounts - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudToolBar Dense="true" Class="pl-0">
            <MudText Typo="Typo.h6">Chart of Accounts</MudText>
            <MudSpacer />
            <MudSelect T="AccountClassification?" Value="_filterClassification" ValueChanged="OnClassificationFilterChanged" 
                       Label="Classification" Dense="true" Variant="Variant.Outlined" Style="width: 150px;" Class="mr-2"
                       Clearable="true" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter">
                <MudSelectItem T="AccountClassification?" Value="AccountClassification.Assets">Assets</MudSelectItem>
                <MudSelectItem T="AccountClassification?" Value="AccountClassification.Liabilities">Liabilities</MudSelectItem>
                <MudSelectItem T="AccountClassification?" Value="AccountClassification.Income">Income</MudSelectItem>
                <MudSelectItem T="AccountClassification?" Value="AccountClassification.Expenditure">Expenditure</MudSelectItem>
                <MudSelectItem T="AccountClassification?" Value="AccountClassification.Equity">Equity</MudSelectItem>
            </MudSelect>
            <MudTextField @bind-Value="_searchText" Placeholder="Search..." Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mr-4" 
                          Immediate="true" DebounceInterval="300" Style="width: 200px;" Dense="true" Variant="Variant.Outlined" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddAccount">
                Add Account
            </MudButton>
        </MudToolBar>

        <MudTable Items="@FilteredAccounts" Dense="true" Hover="true" Bordered="true" Striped="true" Class="mt-4"
                  Loading="_loading" LoadingProgressColor="Color.Primary" GroupBy="@_groupDefinition" GroupHeaderStyle="background-color:var(--mud-palette-background-grey)">
            <HeaderContent>
                <MudTh Style="width: 100px;">Code</MudTh>
                <MudTh>Account Name</MudTh>
                <MudTh Style="width: 120px;">Classification</MudTh>
                <MudTh Style="width: 140px;">Group</MudTh>
                <MudTh Style="width: 120px;">Type</MudTh>
                <MudTh Style="width: 80px;">Active</MudTh>
                <MudTh Style="width: 100px;">Actions</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh colspan="7">
                    <MudText Typo="Typo.subtitle1"><b>@context.GroupName</b></MudText>
                </MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Code"><MudText Typo="Typo.body2">@context.Code</MudText></MudTd>
                <MudTd DataLabel="Name">
                    @if (context.IsGroup)
                    {
                        <MudText Typo="Typo.body2"><b>@context.Name</b></MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">@context.Name</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Classification"><MudChip T="string" Size="Size.Small" Color="@GetClassificationColor(context.Classification)">@context.Classification</MudChip></MudTd>
                <MudTd DataLabel="Group"><MudText Typo="Typo.body2">@GetGroupLabel(context.AccountGroup)</MudText></MudTd>
                <MudTd DataLabel="Type"><MudText Typo="Typo.body2">@GetNatureLabel(context.AccountNature)</MudText></MudTd>
                <MudTd DataLabel="Active"><MudCheckBox Value="@context.IsActive" Disabled="true" Dense="true" Color="Color.Success" /></MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => EditAccount(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteAccount(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No accounts found</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<AccountHead> _accounts = new();
    private string _searchText = string.Empty;
    private AccountClassification? _filterClassification;
    private bool _loading = true;

    private TableGroupDefinition<AccountHead> _groupDefinition = new()
    {
        GroupName = "Classification",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.Classification.ToString()
    };

    private IEnumerable<AccountHead> FilteredAccounts
    {
        get
        {
            var result = _accounts.AsEnumerable();
            
            if (_filterClassification.HasValue)
                result = result.Where(a => a.Classification == _filterClassification.Value);
            
            if (!string.IsNullOrWhiteSpace(_searchText))
                result = result.Where(a => 
                    a.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    a.Code.Contains(_searchText, StringComparison.OrdinalIgnoreCase));
            
            return result;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
    }

    private async Task LoadAccounts()
    {
        _loading = true;
        _accounts = await DbContext.AccountHeads
            .Where(a => !a.IsDeleted)
            .OrderBy(a => a.Classification)
            .ThenBy(a => a.AccountGroup)
            .ThenBy(a => a.Name)
            .ToListAsync();
        _loading = false;
    }

    private void OnClassificationFilterChanged(AccountClassification? value)
    {
        _filterClassification = value;
        StateHasChanged();
    }

    private async Task AddAccount()
    {
        var account = new AccountHead { CompanyId = 1, IsActive = true };
        var parameters = new DialogParameters<AccountHeadDialog> { { x => x.Account, account }, { x => x.IsNew, true } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AccountHeadDialog>("Add Account", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await LoadAccounts();
            Snackbar.Add("Account added successfully", Severity.Success);
        }
    }

    private async Task EditAccount(AccountHead account)
    {
        var parameters = new DialogParameters<AccountHeadDialog> { { x => x.Account, account }, { x => x.IsNew, false } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AccountHeadDialog>("Edit Account", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await LoadAccounts();
            Snackbar.Add("Account updated successfully", Severity.Success);
        }
    }

    private async Task DeleteAccount(AccountHead account)
    {
        var confirm = await DialogService.ShowMessageBox("Confirm Delete", 
            $"Are you sure you want to delete '{account.Name}'?", yesText: "Delete", cancelText: "Cancel");
        if (confirm == true)
        {
            account.IsDeleted = true;
            account.ModifiedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadAccounts();
            Snackbar.Add("Account deleted", Severity.Info);
        }
    }

    private Color GetClassificationColor(AccountClassification classification) => classification switch
    {
        AccountClassification.Assets => Color.Success,
        AccountClassification.Liabilities => Color.Warning,
        AccountClassification.Income => Color.Info,
        AccountClassification.Expenditure => Color.Error,
        AccountClassification.Equity => Color.Primary,
        _ => Color.Default
    };

    private string GetGroupLabel(AccountGroup group) => group switch
    {
        AccountGroup.CurrentAssets => "Current Assets",
        AccountGroup.FixedAssets => "Fixed Assets",
        AccountGroup.Investments => "Investments",
        AccountGroup.CurrentLiabilities => "Current Liabilities",
        AccountGroup.LongTermLiabilities => "Long Term Liabilities",
        AccountGroup.DirectIncome => "Direct Income",
        AccountGroup.IndirectIncome => "Indirect Income",
        AccountGroup.DirectExpenses => "Direct Expenses",
        AccountGroup.IndirectExpenses => "Indirect Expenses",
        AccountGroup.Capital => "Capital",
        AccountGroup.Reserves => "Reserves",
        _ => group.ToString()
    };

    private string GetNatureLabel(AccountNature nature) => nature switch
    {
        AccountNature.General => "General",
        AccountNature.CashAccount => "Cash",
        AccountNature.BankAccount => "Bank",
        AccountNature.ControlAccount => "Control",
        AccountNature.Receivable => "Receivable",
        AccountNature.Payable => "Payable",
        AccountNature.TaxAccount => "Tax",
        AccountNature.DiscountAccount => "Discount",
        AccountNature.RoundOffAccount => "Round Off",
        _ => nature.ToString()
    };
}

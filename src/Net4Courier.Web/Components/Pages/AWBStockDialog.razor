@using MudBlazor
@using Net4Courier.Operations.Entities

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(IsEdit ? "Edit AWB Stock" : "Add AWB Stock")</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudSelect T="string" Label="Item Name" @bind-Value="Stock.ItemName"
                               Variant="Variant.Outlined" Required="true" RequiredError="Item name is required">
                        <MudSelectItem Value="@("AWB Book")">AWB Book</MudSelectItem>
                        <MudSelectItem Value="@("AWB Sticker")">AWB Sticker</MudSelectItem>
                        <MudSelectItem Value="@("AWB Roll")">AWB Roll</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="string" Label="Item Type" @bind-Value="Stock.ItemType"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("")">None</MudSelectItem>
                        <MudSelectItem Value="@("Domestic")">Domestic</MudSelectItem>
                        <MudSelectItem Value="@("International")">International</MudSelectItem>
                        <MudSelectItem Value="@("Express")">Express</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Stock.ReferenceNo" Label="Reference No."
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField T="int" Value="Stock.Qty" Label="Qty" Min="1"
                                     Variant="Variant.Outlined" Required="true"
                                     Immediate="true" ValueChanged="@OnQtyChanged" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="Stock.Rate" Label="Rate" Format="N2"
                                     Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField Value="@(Stock.Qty * Stock.Rate)" Label="Amount" Format="N2"
                                     Variant="Variant.Outlined" ReadOnly="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField T="string" Value="Stock.AWBNoFrom" Label="AWB NO. From"
                                  Variant="Variant.Outlined" Required="true" RequiredError="AWB From is required"
                                  Immediate="true" ValueChanged="@OnAWBNoFromChanged" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Value="@_awbNoTo" Label="AWB NO. To"
                                  Variant="Variant.Outlined" ReadOnly="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Stock.Remarks" Label="Remarks" Lines="2"
                                  Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public AWBStock Stock { get; set; } = new();
    [Parameter] public bool IsEdit { get; set; }
    
    private MudForm? _form;
    private string _awbNoTo = "";

    protected override void OnParametersSet()
    {
        CalculateAWBNoTo();
    }

    private void OnQtyChanged(int qty)
    {
        Stock.Qty = qty;
        CalculateAWBNoTo();
    }

    private void OnAWBNoFromChanged(string awbNoFrom)
    {
        Stock.AWBNoFrom = awbNoFrom;
        CalculateAWBNoTo();
    }

    private void CalculateAWBNoTo()
    {
        if (!string.IsNullOrWhiteSpace(Stock.AWBNoFrom) && Stock.Qty > 0)
        {
            if (long.TryParse(Stock.AWBNoFrom, out long startNum))
            {
                long endNum = startNum + Stock.Qty - 1;
                _awbNoTo = endNum.ToString();
                Stock.AWBNoTo = _awbNoTo;
                Stock.AWBCount = Stock.Qty;
            }
            else
            {
                _awbNoTo = "";
                Stock.AWBNoTo = "";
            }
        }
        else
        {
            _awbNoTo = "";
            Stock.AWBNoTo = "";
        }
    }
    
    private async Task Submit()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        
        Stock.Amount = Stock.Qty * Stock.Rate;
        Stock.AWBCount = Stock.Qty;
        MudDialog.Close(DialogResult.Ok(Stock));
    }
    
    private void Cancel() => MudDialog.Cancel();
}

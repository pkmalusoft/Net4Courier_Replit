@page "/bank-accounts/new"
@page "/bank-accounts/edit/{Id:guid}"

@using Net4Courier.Web.Services.CashBank
@using Net4Courier.Web.DTOs

@inject IBankAccountService BankAccountService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>@(Id.HasValue ? "Edit" : "New") Bank Account</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">@(Id.HasValue ? "Edit" : "New") Bank Account</MudText>
    
    <MudPaper Class="pa-6" Elevation="2">
        <MudForm @ref="form" @bind-IsValid="@formIsValid">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="accountName" Label="Account Name" Required="true" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="accountNumber" Label="Account Number" Required="true" Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
            <MudGrid Class="mt-4">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="bankName" Label="Bank Name" Required="true" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="branchName" Label="Branch Name" Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
            <MudGrid Class="mt-4">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="swiftCode" Label="SWIFT Code" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="iban" Label="IBAN" Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
            <MudGrid Class="mt-4">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="currency" Label="Currency" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="isActive" Label="Active" Color="Color.Primary" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4" />

            <div class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@(!formIsValid || isSaving)">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Save
                </MudButton>
            </div>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private MudForm form = null!;
    private bool formIsValid;
    private bool isSaving;

    private string accountName = "";
    private string accountNumber = "";
    private string bankName = "";
    private string? branchName;
    private string? swiftCode;
    private string? iban;
    private string? currency;
    private bool isActive = true;

    private static readonly Guid TenantId = Guid.Parse("11111111-1111-1111-1111-111111111111");

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            var account = await BankAccountService.GetByIdAsync(TenantId, Id.Value);
            if (account != null)
            {
                accountName = account.AccountName;
                accountNumber = account.AccountNumber;
                bankName = account.BankName;
                branchName = account.BranchName;
                swiftCode = account.SwiftCode;
                iban = account.IbanNumber;
                currency = account.CurrencyCode;
                isActive = account.IsActive;
            }
        }
    }

    private async Task Save()
    {
        await form.Validate();
        if (!formIsValid) return;

        isSaving = true;
        try
        {
            Snackbar.Add("Bank account saved (placeholder - full implementation pending)", Severity.Info);
            Navigation.NavigateTo("/bank-accounts");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving bank account: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/bank-accounts");
    }
}

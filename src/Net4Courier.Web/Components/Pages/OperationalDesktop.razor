@page "/operational-desktop"
@inject IDbContextFactory<Net4Courier.Infrastructure.Data.ApplicationDbContext> DbFactory
@inject Net4Courier.Web.Services.IDateTimeService DateTimeService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>Operational Desktop - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Operational Desktop</MudText>
<MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">Real-time operations monitoring and quick actions</MudText>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
}
else
{
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-warning);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Pending Pickup</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning">@_pendingPickup</MudText>
                    </div>
                    <MudAvatar Color="Color.Warning" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" />
                    </MudAvatar>
                </div>
                <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small" Href="/pickup-management" Class="mt-2">View All</MudButton>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-info);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">In Transit</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@_inTransit</MudText>
                    </div>
                    <MudAvatar Color="Color.Info" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" />
                    </MudAvatar>
                </div>
                <MudButton Variant="Variant.Text" Color="Color.Info" Size="Size.Small" Href="/awb-list" Class="mt-2">View All</MudButton>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-primary);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Out for Delivery</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_outForDelivery</MudText>
                    </div>
                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.DeliveryDining" />
                    </MudAvatar>
                </div>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" Href="/outscan" Class="mt-2">View DRS</MudButton>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-success);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Delivered Today</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@_todayDateDisplay</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_deliveredToday</MudText>
                    </div>
                    <MudAvatar Color="Color.Success" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                    </MudAvatar>
                </div>
                <MudButton Variant="Variant.Text" Color="Color.Success" Size="Size.Small" Href="/pod-bulk" Class="mt-2">POD Update</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-error);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">On Hold</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_onHold</MudText>
                    </div>
                    <MudAvatar Color="Color.Error" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.PauseCircle" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-tertiary);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Exceptions</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Tertiary">@_exceptions</MudText>
                    </div>
                    <MudAvatar Color="Color.Tertiary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-secondary);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Pending MAWB</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Secondary">@_pendingMAWB</MudText>
                    </div>
                    <MudAvatar Color="Color.Secondary" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Flight" />
                    </MudAvatar>
                </div>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" Size="Size.Small" Href="/mawb-list" Class="mt-2">View MAWB</MudButton>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2" Style="border-left: 4px solid var(--mud-palette-dark);">
                <div class="d-flex justify-space-between align-center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">COD Pending</MudText>
                        <MudText Typo="Typo.h4">@_codPending</MudText>
                    </div>
                    <MudAvatar Color="Color.Dark" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.Payments" />
                    </MudAvatar>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Quick Actions</MudText>
                <MudGrid>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" StartIcon="@Icons.Material.Filled.LocalShipping" Href="/pickup-management">
                            Pickup Request
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Add" Href="/awb-entry">
                            New AWB
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true" StartIcon="@Icons.Material.Filled.LocalShipping" Href="/pickup-inscan">
                            Inscan
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" StartIcon="@Icons.Material.Filled.Output" Href="/outscan">
                            Create DRS
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" StartIcon="@Icons.Material.Filled.CheckCircle" Href="/pod-bulk">
                            POD Update
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" StartIcon="@Icons.Material.Filled.Flight" Href="/mawb-entry">
                            MAWB
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" FullWidth="true" StartIcon="@Icons.Material.Filled.Search" Href="/tracking">
                            Track AWB
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Dark" FullWidth="true" StartIcon="@Icons.Material.Filled.AttachMoney" Href="/special-charges">
                            Charges
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" StartIcon="@Icons.Material.Filled.People" Href="/customers">
                            Customers
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Receipt" Href="/invoice-entry">
                            Invoice
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" StartIcon="@Icons.Material.Filled.Payments" Href="/receipts">
                            Receipts
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true" StartIcon="@Icons.Material.Filled.NoteAlt" Href="/credit-notes">
                            Credit Note
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" FullWidth="true" StartIcon="@Icons.Material.Filled.Money" Href="/cash-bank?tab=cash">
                            Cash
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" StartIcon="@Icons.Material.Filled.AccountBalance" Href="/cash-bank?tab=bank">
                            Bank
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6" sm="4">
                        <MudButton Variant="Variant.Outlined" Color="Color.Dark" FullWidth="true" StartIcon="@Icons.Material.Filled.MenuBook" Href="/journal-entries">
                            Journal
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Recent Shipments</MudText>
                <MudTable Items="@_recentShipmentItems" Hover="true" Dense="true" Striped="true">
                    <HeaderContent>
                        <MudTh>AWB No</MudTh>
                        <MudTh>Consignee</MudTh>
                        <MudTh>Destination</MudTh>
                        <MudTh>Status</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudLink Href="@context.TrackingUrl">@context.AWBNo</MudLink>
                        </MudTd>
                        <MudTd>@context.ConsigneeName</MudTd>
                        <MudTd>@context.DestinationCity</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@context.StatusColor">
                                @context.StatusName
                            </MudChip>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>No recent shipments</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private bool _isLoading = true;
    private int _pendingPickup;
    private int _inTransit;
    private int _outForDelivery;
    private int _deliveredToday;
    private string _todayDateDisplay = "";
    private int _onHold;
    private int _exceptions;
    private int _pendingMAWB;
    private int _codPending;
    private List<RecentShipmentItem> _recentShipmentItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOperationalData();
    }

    private async Task LoadOperationalData()
    {
        _isLoading = true;
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var localNow = DateTimeService.ToLocalTime(DateTime.UtcNow);
            var localToday = localNow.Date;
            _todayDateDisplay = localToday.ToString("dd MMM yyyy");
            var todayUtcStart = TimeZoneInfo.ConvertTimeToUtc(localToday, DateTimeService.GetTimeZone());
            var todayUtcEnd = todayUtcStart.AddDays(1);
            
            _pendingPickup = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && (x.CourierStatusId == CourierStatus.Pending || x.CourierStatusId == CourierStatus.AssignedToPickup))
                .CountAsync();
            
            _inTransit = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && (x.CourierStatusId == CourierStatus.InTransit || x.CourierStatusId == CourierStatus.InscanAtOrigin || x.CourierStatusId == CourierStatus.InscanAtDestination))
                .CountAsync();
            
            _outForDelivery = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && x.CourierStatusId == CourierStatus.OutForDelivery)
                .CountAsync();
            
            var domesticDelivered = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && x.CourierStatusId == CourierStatus.Delivered && x.DeliveredDate != null && x.DeliveredDate >= todayUtcStart && x.DeliveredDate < todayUtcEnd)
                .CountAsync();

            var importDelivered = await dbContext.ImportShipments
                .Where(x => !x.IsDeleted && !x.LinkedInscanMasterId.HasValue && x.Status == ImportShipmentStatus.HandedOver && x.HandedOverAt != null && x.HandedOverAt >= todayUtcStart && x.HandedOverAt < todayUtcEnd)
                .CountAsync();

            _deliveredToday = domesticDelivered + importDelivered;
            
            _onHold = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && x.IsOnHold)
                .CountAsync();
            
            _exceptions = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && x.CourierStatusId == CourierStatus.NotDelivered)
                .CountAsync();
            
            _pendingMAWB = await dbContext.MasterAirwaybills
                .Where(x => !x.IsDeleted && x.Status == MAWBStatus.Draft)
                .CountAsync();
            
            _codPending = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted && x.IsCOD && !x.CODCollected && x.CourierStatusId == CourierStatus.Delivered)
                .CountAsync();
            
            var recentInscan = await dbContext.InscanMasters
                .Where(x => !x.IsDeleted)
                .OrderByDescending(x => x.CreatedAt)
                .Take(10)
                .Select(x => new { x.AWBNo, x.Consignee, x.ConsigneeCity, x.CourierStatusId, x.CreatedAt })
                .ToListAsync();

            var recentImport = await dbContext.ImportShipments
                .Include(x => x.ImportMaster)
                .Where(x => !x.IsDeleted && !x.LinkedInscanMasterId.HasValue)
                .OrderByDescending(x => x.CreatedAt)
                .Take(10)
                .Select(x => new { x.AWBNo, x.ConsigneeName, x.ConsigneeCity, x.Status, x.ImportMasterId, x.CreatedAt })
                .ToListAsync();

            _recentShipmentItems = recentInscan
                .Select(x => new RecentShipmentItem
                {
                    AWBNo = x.AWBNo,
                    ConsigneeName = x.Consignee ?? "-",
                    DestinationCity = x.ConsigneeCity ?? "-",
                    StatusName = GetStatusName(x.CourierStatusId),
                    StatusColor = GetStatusColor(x.CourierStatusId),
                    TrackingUrl = $"/tracking/{x.AWBNo}",
                    SortDate = x.CreatedAt
                })
                .Concat(recentImport.Select(x => new RecentShipmentItem
                {
                    AWBNo = x.AWBNo,
                    ConsigneeName = x.ConsigneeName ?? "-",
                    DestinationCity = x.ConsigneeCity ?? "-",
                    StatusName = x.Status.ToString(),
                    StatusColor = GetImportStatusColor(x.Status),
                    TrackingUrl = $"/import-customs/{x.ImportMasterId}",
                    SortDate = x.CreatedAt
                }))
                .OrderByDescending(x => x.SortDate)
                .Take(10)
                .ToList();
        }
        catch
        {
        }
        _isLoading = false;
    }

    private static Color GetImportStatusColor(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.Cleared or ImportShipmentStatus.Released or ImportShipmentStatus.HandedOver => Color.Success,
        ImportShipmentStatus.Inscanned or ImportShipmentStatus.ReceivedAtWarehouse => Color.Info,
        ImportShipmentStatus.PendingCustoms or ImportShipmentStatus.AwaitingDocuments => Color.Warning,
        ImportShipmentStatus.CustomsHold or ImportShipmentStatus.UnderExamination or ImportShipmentStatus.OnHold => Color.Error,
        _ => Color.Default
    };

    private class RecentShipmentItem
    {
        public string AWBNo { get; set; } = "";
        public string ConsigneeName { get; set; } = "";
        public string DestinationCity { get; set; } = "";
        public string StatusName { get; set; } = "";
        public Color StatusColor { get; set; }
        public string TrackingUrl { get; set; } = "";
        public DateTime SortDate { get; set; }
    }

    private Color GetStatusColor(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => Color.Default,
            CourierStatus.AssignedToPickup => Color.Info,
            CourierStatus.PickedUp => Color.Info,
            CourierStatus.InscanAtOrigin => Color.Primary,
            CourierStatus.InTransit => Color.Primary,
            CourierStatus.InscanAtDestination => Color.Secondary,
            CourierStatus.OutForDelivery => Color.Warning,
            CourierStatus.Delivered => Color.Success,
            CourierStatus.NotDelivered => Color.Error,
            CourierStatus.ReturnToOrigin => Color.Tertiary,
            CourierStatus.Returned => Color.Tertiary,
            CourierStatus.OnHold => Color.Error,
            CourierStatus.Cancelled => Color.Dark,
            _ => Color.Default
        };
    }

    private string GetStatusName(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => "Pending",
            CourierStatus.AssignedToPickup => "Assigned to Pickup",
            CourierStatus.PickedUp => "Picked Up",
            CourierStatus.InscanAtOrigin => "Inscan at Origin",
            CourierStatus.InTransit => "In Transit",
            CourierStatus.InscanAtDestination => "Inscan at Destination",
            CourierStatus.OutForDelivery => "Out for Delivery",
            CourierStatus.Delivered => "Delivered",
            CourierStatus.NotDelivered => "Not Delivered",
            CourierStatus.ReturnToOrigin => "Return to Origin",
            CourierStatus.Returned => "Returned",
            CourierStatus.OnHold => "On Hold",
            CourierStatus.Cancelled => "Cancelled",
            _ => status.ToString()
        };
    }
}

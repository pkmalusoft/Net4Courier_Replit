@page "/zone-matrix"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities
@using Net4Courier.Infrastructure.Data
@using ZoneMatrixEntity = Net4Courier.Masters.Entities.ZoneMatrix
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Zone Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" />
                <MudText Typo="Typo.h5">
                    @if (_selectedCategory != null)
                    {
                        <span>Zones - @_selectedCategory.Name</span>
                    }
                    else
                    {
                        <span>Zone Management</span>
                    }
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateNewZone">New Zone</MudButton>
        </MudStack>

        <MudGrid Class="mb-4">
            <MudItem xs="12" md="4">
                <MudSelect T="long?" Label="Zone Category" Value="_categoryId" Variant="Variant.Outlined" 
                           Margin="Margin.Dense" Clearable="true" ValueChanged="CategoryChanged">
                    @foreach (var cat in _categories)
                    {
                        <MudSelectItem Value="@((long?)cat.Id)">@cat.Name (@cat.Code)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="_searchText" Label="Search zones" Variant="Variant.Outlined" Margin="Margin.Dense"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="SearchZones" />
            </MudItem>
        </MudGrid>

        <MudTable Items="@_zones" Hover="true" Striped="true" Loading="@_loading" Dense="true" Elevation="0"
                  Class="border-solid border">
            <HeaderContent>
                <MudTh>Zone Code</MudTh>
                <MudTh>Zone Name</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Countries/Cities</MudTh>
                <MudTh>Sort Order</MudTh>
                <MudTh Style="width:120px">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Zone Code">
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.ZoneCode</MudChip>
                </MudTd>
                <MudTd DataLabel="Zone Name">@context.ZoneName</MudTd>
                <MudTd DataLabel="Type">
                    <MudChip T="string" Size="Size.Small" Color="@(context.ZoneType == ZoneType.International ? Color.Info : Color.Secondary)">
                        @context.ZoneType.ToString()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Locations">
                    <MudLink OnClick="@(() => EditZone(context))">@context.Details.Count @(context.ZoneType == ZoneType.International ? "countries" : "cities")</MudLink>
                </MudTd>
                <MudTd DataLabel="Sort">@context.SortOrder</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                   OnClick="@(() => EditZone(context))" Title="Edit" />
                    <MudIconButton Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary"
                                   OnClick="@(() => EditZoneDetails(context))" Title="Locations" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => DeleteZone(context))" Title="Delete" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No zones found. Click "New Zone" to create one.</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudText>Loading zones...</MudText>
            </LoadingContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<ZoneMatrixEntity> _zones = new();
    private List<ZoneCategory> _categories = new();
    private ZoneCategory? _selectedCategory;
    private bool _loading = true;
    private string _searchText = "";
    private long? _categoryId;

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _categories = await dbContext.ZoneCategories.Where(c => !c.IsDeleted).OrderBy(c => c.SortOrder).ToListAsync();
        
        var uri = new Uri(Navigation.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("categoryId", out var catIdValue) && long.TryParse(catIdValue, out var catId))
        {
            _categoryId = catId;
            _selectedCategory = _categories.FirstOrDefault(c => c.Id == catId);
        }
        
        await LoadZones();
    }

    private async Task CategoryChanged(long? value)
    {
        _categoryId = value;
        _selectedCategory = value.HasValue ? _categories.FirstOrDefault(c => c.Id == value) : null;
        await LoadZones();
    }

    private async Task LoadZones()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _loading = true;
        try
        {
            var query = dbContext.ZoneMatrices
                .Include(z => z.Details)
                .Where(z => !z.IsDeleted)
                .AsQueryable();

            if (_categoryId.HasValue)
            {
                query = query.Where(z => z.ZoneCategoryId == _categoryId);
            }

            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                query = query.Where(z => z.ZoneCode.ToLower().Contains(_searchText.ToLower()) ||
                                         z.ZoneName.ToLower().Contains(_searchText.ToLower()));
            }

            _zones = await query.OrderBy(z => z.SortOrder).ThenBy(z => z.ZoneCode).ToListAsync();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SearchZones()
    {
        await LoadZones();
    }

    private async Task CreateNewZone()
    {
        var dialog = await DialogService.ShowAsync<ZoneMatrixDialog>("New Zone",
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await LoadZones();
        }
    }

    private async Task EditZone(ZoneMatrixEntity zone)
    {
        var dialog = await DialogService.ShowAsync<ZoneMatrixDialog>("Edit Zone",
            new DialogParameters<ZoneMatrixDialog> { { x => x.ZoneId, zone.Id } },
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });

        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await LoadZones();
        }
    }

    private async Task EditZoneDetails(ZoneMatrixEntity zone)
    {
        var dialog = await DialogService.ShowAsync<ZoneMatrixDetailsDialog>("Zone Locations",
            new DialogParameters<ZoneMatrixDetailsDialog> { { x => x.ZoneMatrixId, zone.Id } },
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            await LoadZones();
        }
    }

    private async Task DeleteZone(ZoneMatrixEntity zone)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Delete zone '{zone.ZoneCode} - {zone.ZoneName}'?" },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Zone", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            zone.IsDeleted = true;
            await dbContext.SaveChangesAsync();
            Snackbar.Add("Zone deleted", Severity.Success);
            await LoadZones();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/rate-cards");
    }
}

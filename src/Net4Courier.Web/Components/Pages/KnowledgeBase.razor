@page "/knowledge-base"
@using Markdig
@inject IWebHostEnvironment Environment

<PageTitle>Knowledge Base - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #1565c0, #0d47a1); border-radius: 12px;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Class="mud-text-white mb-1">Knowledge Base</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-white" Style="opacity: 0.9;">
                    Complete operations & system guide for Net4Courier
                </MudText>
            </div>
            <MudChip T="string" Color="Color.Surface" Icon="@Icons.Material.Filled.Info" Size="Size.Small">
                Use Ctrl+F to search
            </MudChip>
        </MudStack>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="position: sticky; top: 80px;">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Navigation</MudText>
                <MudNavMenu Dense="true">
                    <MudNavLink Href="#operations-flow" Icon="@Icons.Material.Filled.LocalShipping">Operations Flow</MudNavLink>
                    <MudNavLink Href="#reconciliation" Icon="@Icons.Material.Filled.AccountBalance">Reconciliation</MudNavLink>
                    <MudNavLink Href="#accounts--finance" Icon="@Icons.Material.Filled.Receipt">Accounts & Finance</MudNavLink>
                    <MudNavLink Href="#customer-management-crm" Icon="@Icons.Material.Filled.Contacts">CRM</MudNavLink>
                    <MudNavLink Href="#pricing--billing" Icon="@Icons.Material.Filled.PriceChange">Pricing & Billing</MudNavLink>
                    <MudNavLink Href="#system-settings" Icon="@Icons.Material.Filled.Settings">System Settings</MudNavLink>
                    <MudNavLink Href="#compliance--audit" Icon="@Icons.Material.Filled.VerifiedUser">Compliance & Audit</MudNavLink>
                    <MudNavLink Href="#status-codes-reference" Icon="@Icons.Material.Filled.Code">Status Codes</MudNavLink>
                </MudNavMenu>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2" Class="mb-2">Popular Topics</MudText>
                <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#pickup-management">Pickup</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#awb-entry--shipments">AWB</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#proof-of-delivery-pod">POD</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#rate-cards">Rate Cards</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#generate-invoice">Invoicing</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="#customer-profiles">Customers</MudChip>
                </MudStack>

                <MudDivider Class="my-4" />

                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.caption">
                        <b>Tip:</b> Use Ctrl+F (Cmd+F on Mac) to search within this page
                    </MudText>
                </MudAlert>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="9">
            <MudPaper Elevation="2" Class="pa-6">
                @if (_isLoading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    <MudText>Loading knowledge base...</MudText>
                }
                else if (!string.IsNullOrEmpty(_error))
                {
                    <MudAlert Severity="Severity.Error">@_error</MudAlert>
                }
                else
                {
                    <div class="kb-content">
                        @((MarkupString)_htmlContent)
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .kb-content h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1565c0;
        margin-top: 2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .kb-content h1:first-child {
        margin-top: 0;
    }

    .kb-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1976d2;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .kb-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-top: 1.25rem;
        margin-bottom: 0.5rem;
    }

    .kb-content h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #555;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .kb-content p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
    }

    .kb-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.9rem;
    }

    .kb-content th {
        background: #f5f5f5;
        padding: 0.75rem;
        text-align: left;
        border: 1px solid #e0e0e0;
        font-weight: 600;
    }

    .kb-content td {
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
    }

    .kb-content tr:nth-child(even) {
        background: #fafafa;
    }

    .kb-content code {
        background: #f5f5f5;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        font-size: 0.9em;
    }

    .kb-content pre {
        background: #263238;
        color: #aed581;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1rem 0;
    }

    .kb-content pre code {
        background: transparent;
        padding: 0;
        color: inherit;
    }

    .kb-content ul, .kb-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .kb-content li {
        margin: 0.25rem 0;
        line-height: 1.5;
    }

    .kb-content hr {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 2rem 0;
    }

    .kb-content strong {
        color: #1565c0;
    }

    .kb-content blockquote {
        border-left: 4px solid #1976d2;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #666;
        font-style: italic;
    }

    .kb-content a {
        color: #1976d2;
        text-decoration: none;
    }

    .kb-content a:hover {
        text-decoration: underline;
    }

    :target {
        scroll-margin-top: 100px;
    }
</style>

@code {
    private string _htmlContent = "";
    private bool _isLoading = true;
    private string _error = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadKnowledgeBase();
    }

    private async Task LoadKnowledgeBase()
    {
        try
        {
            _isLoading = true;
            
            var filePath = Path.Combine(Environment.WebRootPath, "docs", "KnowledgeBase.md");
            
            if (File.Exists(filePath))
            {
                var markdown = await File.ReadAllTextAsync(filePath);
                
                var pipeline = new MarkdownPipelineBuilder()
                    .UseAdvancedExtensions()
                    .UseAutoIdentifiers()
                    .DisableHtml()
                    .Build();
                
                _htmlContent = Markdown.ToHtml(markdown, pipeline);
            }
            else
            {
                _error = "Knowledge base file not found.";
            }
        }
        catch (Exception ex)
        {
            _error = $"Failed to load knowledge base: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}

@page "/knowledge-base"
@using Markdig
@inject IWebHostEnvironment Environment

<PageTitle>Knowledge Base - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #1565c0, #0d47a1); border-radius: 12px;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4" Style="color: white !important;" Class="mb-1">Knowledge Base</MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9) !important;">
                    Complete operations & system guide for Net4Courier
                </MudText>
            </div>
            <MudChip T="string" Color="Color.Surface" Icon="@Icons.Material.Filled.Info" Size="Size.Small" Style="color: white !important; background: rgba(255,255,255,0.2) !important;">
                Use Ctrl+F to search
            </MudChip>
        </MudStack>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="position: sticky; top: 80px;">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Navigation</MudText>
                <MudNavMenu Dense="true">
                    <MudNavLink Href="/knowledge-base#how-to-guides" Icon="@Icons.Material.Filled.HelpOutline" Style="color: #e65100; font-weight: 600;">How To Guides</MudNavLink>
                    <MudNavLink Href="/knowledge-base#operations-flow" Icon="@Icons.Material.Filled.LocalShipping">Operations Flow</MudNavLink>
                    <MudNavLink Href="/knowledge-base#reconciliation" Icon="@Icons.Material.Filled.AccountBalance">Reconciliation</MudNavLink>
                    <MudNavLink Href="/knowledge-base#accounts--finance" Icon="@Icons.Material.Filled.Receipt">Accounts & Finance</MudNavLink>
                    <MudNavLink Href="/knowledge-base#customer-management-crm" Icon="@Icons.Material.Filled.Contacts">CRM</MudNavLink>
                    <MudNavLink Href="/knowledge-base#pricing--billing" Icon="@Icons.Material.Filled.PriceChange">Pricing & Billing</MudNavLink>
                    <MudNavLink Href="/knowledge-base#system-settings" Icon="@Icons.Material.Filled.Settings">System Settings</MudNavLink>
                    <MudNavLink Href="/knowledge-base#compliance--audit" Icon="@Icons.Material.Filled.VerifiedUser">Compliance & Audit</MudNavLink>
                    <MudNavLink Href="/knowledge-base#status-codes-reference" Icon="@Icons.Material.Filled.Code">Status Codes</MudNavLink>
                </MudNavMenu>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2" Class="mb-2">Popular Topics</MudText>
                <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Href="/knowledge-base#how-to-guides">How To</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#pickup-management">Pickup</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#awb-entry--shipments">AWB</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#proof-of-delivery-pod">POD</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#rate-cards">Rate Cards</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#generate-invoice">Invoicing</MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Href="/knowledge-base#customer-profiles">Customers</MudChip>
                </MudStack>

                <MudDivider Class="my-4" />

                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.caption">
                        <b>Tip:</b> Use Ctrl+F (Cmd+F on Mac) to search within this page
                    </MudText>
                </MudAlert>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="9">
            <MudPaper Elevation="2" Class="pa-6">
                @if (_isLoading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    <MudText>Loading knowledge base...</MudText>
                }
                else if (!string.IsNullOrEmpty(_error))
                {
                    <MudAlert Severity="Severity.Error">@_error</MudAlert>
                }
                else
                {
                    <div class="kb-content">
                        @((MarkupString)_htmlContent)
                    </div>
                    
                    <MudDivider Class="my-6" />
                    
                    <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px;">
                        <MudText Typo="Typo.h6" Color="Color.Warning" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
                            Suggest a New How-To Topic
                        </MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">
                            Can't find what you're looking for? Submit your question and we'll add it to our knowledge base.
                        </MudText>
                        
                        @if (_suggestionSubmitted)
                        {
                            <MudAlert Severity="Severity.Success" Dense="true">
                                Thank you! Your suggestion has been submitted. We'll review it and add helpful content soon.
                            </MudAlert>
                        }
                        else
                        {
                            <MudGrid>
                                <MudItem xs="12" md="8">
                                    <MudTextField @bind-Value="_suggestedQuestion" 
                                                  Label="Your Question" 
                                                  Placeholder="e.g., How do I set up automated email notifications?"
                                                  Variant="Variant.Outlined"
                                                  Lines="2"
                                                  FullWidth="true"
                                                  Class="mb-2" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTextField @bind-Value="_suggesterEmail" 
                                                  Label="Your Email (optional)" 
                                                  Placeholder="email@example.com"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Email"
                                                  FullWidth="true"
                                                  Class="mb-2" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Warning"
                                               StartIcon="@Icons.Material.Filled.Send"
                                               OnClick="SubmitSuggestion"
                                               Disabled="@(string.IsNullOrWhiteSpace(_suggestedQuestion))">
                                        Submit Suggestion
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        }
                    </MudPaper>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .kb-content h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1565c0;
        margin-top: 2rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .kb-content h1:first-child {
        margin-top: 0;
    }

    .kb-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1976d2;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .kb-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-top: 1.25rem;
        margin-bottom: 0.5rem;
    }

    .kb-content h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #555;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .kb-content p {
        margin-bottom: 0.75rem;
        line-height: 1.6;
    }

    .kb-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.9rem;
    }

    .kb-content th {
        background: #f5f5f5;
        padding: 0.75rem;
        text-align: left;
        border: 1px solid #e0e0e0;
        font-weight: 600;
    }

    .kb-content td {
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
    }

    .kb-content tr:nth-child(even) {
        background: #fafafa;
    }

    .kb-content code {
        background: #f5f5f5;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        font-size: 0.9em;
    }

    .kb-content pre {
        background: #263238;
        color: #aed581;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1rem 0;
    }

    .kb-content pre code {
        background: transparent;
        padding: 0;
        color: inherit;
    }

    .kb-content ul, .kb-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .kb-content li {
        margin: 0.25rem 0;
        line-height: 1.5;
    }

    .kb-content hr {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 2rem 0;
    }

    .kb-content strong {
        color: #1565c0;
    }

    .kb-content blockquote {
        border-left: 4px solid #1976d2;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #666;
        font-style: italic;
    }

    .kb-content a {
        color: #1976d2;
        text-decoration: none;
    }

    .kb-content a:hover {
        text-decoration: underline;
    }

    :target {
        scroll-margin-top: 100px;
    }
</style>

@code {
    private string _htmlContent = "";
    private bool _isLoading = true;
    private string _error = "";
    private string _suggestedQuestion = "";
    private string _suggesterEmail = "";
    private bool _suggestionSubmitted = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadKnowledgeBase();
    }

    private async Task LoadKnowledgeBase()
    {
        try
        {
            _isLoading = true;
            
            var filePath = Path.Combine(Environment.WebRootPath, "docs", "KnowledgeBase.md");
            
            if (File.Exists(filePath))
            {
                var markdown = await File.ReadAllTextAsync(filePath);
                
                var pipeline = new MarkdownPipelineBuilder()
                    .UseAdvancedExtensions()
                    .UseAutoIdentifiers()
                    .DisableHtml()
                    .Build();
                
                _htmlContent = Markdown.ToHtml(markdown, pipeline);
            }
            else
            {
                _error = "Knowledge base file not found.";
            }
        }
        catch (Exception ex)
        {
            _error = $"Failed to load knowledge base: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task SubmitSuggestion()
    {
        if (string.IsNullOrWhiteSpace(_suggestedQuestion)) return;
        
        try
        {
            var suggestionsPath = Path.Combine(Environment.WebRootPath, "docs", "HowToSuggestions.txt");
            var entry = $"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] {_suggestedQuestion} | Email: {_suggesterEmail ?? "N/A"}\n";
            await File.AppendAllTextAsync(suggestionsPath, entry);
            
            _suggestionSubmitted = true;
            _suggestedQuestion = "";
            _suggesterEmail = "";
        }
        catch
        {
            _suggestionSubmitted = true;
        }
    }
}

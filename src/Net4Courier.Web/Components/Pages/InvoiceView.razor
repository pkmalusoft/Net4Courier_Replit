@page "/invoice-view/{InvoiceId:long}"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Context
@inject InvoicingService InvoicingService
@inject ReportingService ReportingService
@inject IGmailEmailService GmailEmailService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IWebHostEnvironment Environment
@rendermode InteractiveServer

<PageTitle>Invoice - @(_invoice?.InvoiceNo ?? "Loading")</PageTitle>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_invoice == null)
{
    <MudAlert Severity="Severity.Error">Invoice not found</MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h5">Invoice @_invoice.InvoiceNo</MudText>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_invoice.Status)">@_invoice.Status</MudChip>
            </MudStack>
            <MudStack Row="true" Spacing="2">
                @if (_invoice.Status == InvoiceStatus.Draft)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Check"
                               OnClick="PostInvoice">
                        Post Invoice
                    </MudButton>
                }
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Visibility"
                           Href="@($"/reports/ar/print-invoice/{InvoiceId}")">
                    Preview
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Download"
                           Href="@($"/api/report/invoice/{InvoiceId}")" Target="_blank">
                    Download PDF
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Email"
                           OnClick="EmailInvoice" Disabled="@_sendingEmail">
                    @if (_sendingEmail)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Sending...</span>
                    }
                    else
                    {
                        <span>Email Invoice</span>
                    }
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.ArrowBack"
                           Href="/customer-invoices">
                    Back to List
                </MudButton>
            </MudStack>
        </MudStack>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Customer Details</strong></MudText>
                    <MudText>@_invoice.CustomerName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_invoice.CustomerAddress</MudText>
                    @if (!string.IsNullOrEmpty(_invoice.CustomerTaxNo))
                    {
                        <MudText Typo="Typo.body2">Tax No: @_invoice.CustomerTaxNo</MudText>
                    }
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Invoice Details</strong></MudText>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudText Typo="Typo.caption">Invoice Date</MudText>
                            <MudText>@_invoice.InvoiceDate.ToString("dd-MMM-yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.caption">Due Date</MudText>
                            <MudText>@_invoice.DueDate?.ToString("dd-MMM-yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.caption">Period</MudText>
                            <MudText>@_invoice.PeriodFrom?.ToString("dd-MMM") - @_invoice.PeriodTo?.ToString("dd-MMM-yyyy")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.caption">Total AWBs</MudText>
                            <MudText>@_invoice.TotalAWBs</MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>AWB Details</strong></MudText>
            <MudTable Items="@_invoice.Details" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>AWB No</MudTh>
                    <MudTh>Date</MudTh>
                    <MudTh>Origin</MudTh>
                    <MudTh>Destination</MudTh>
                    <MudTh>Pcs</MudTh>
                    <MudTh>Weight</MudTh>
                    <MudTh Style="text-align:right">Freight</MudTh>
                    <MudTh Style="text-align:right">Other</MudTh>
                    <MudTh Style="text-align:right">Total</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.AWBNo</MudTd>
                    <MudTd>@context.AWBDate?.ToString("dd-MMM")</MudTd>
                    <MudTd>@context.Origin</MudTd>
                    <MudTd>@context.Destination</MudTd>
                    <MudTd>@context.Pieces</MudTd>
                    <MudTd>@context.Weight?.ToString("N2")</MudTd>
                    <MudTd Style="text-align:right">₹@context.CourierCharge?.ToString("N2")</MudTd>
                    <MudTd Style="text-align:right">₹@context.OtherCharge?.ToString("N2")</MudTd>
                    <MudTd Style="text-align:right"><strong>₹@context.Total?.ToString("N2")</strong></MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        @if (_invoice.SpecialCharges.Any())
        {
            <MudPaper Class="pa-4 mt-4" Style="background-color: #e3f2fd;">
                <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Special Charges</strong></MudText>
                <MudTable Items="@_invoice.SpecialCharges" Dense="true">
                    <HeaderContent>
                        <MudTh>Charge Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh Style="text-align:right">Value</MudTh>
                        <MudTh Style="text-align:right">Amount</MudTh>
                        <MudTh Style="text-align:right">Tax</MudTh>
                        <MudTh Style="text-align:right">Total</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.ChargeName</MudTd>
                        <MudTd>
                            @if (context.ChargeType == ChargeType.Percentage)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">%</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Default">Flat</MudChip>
                            }
                        </MudTd>
                        <MudTd Style="text-align:right">
                            @(context.ChargeType == ChargeType.Percentage ? $"{context.ChargeValue:N2}%" : $"₹{context.ChargeValue:N2}")
                        </MudTd>
                        <MudTd Style="text-align:right">₹@context.CalculatedAmount.ToString("N2")</MudTd>
                        <MudTd Style="text-align:right">₹@context.TaxAmount.ToString("N2")</MudTd>
                        <MudTd Style="text-align:right"><strong>₹@context.TotalAmount.ToString("N2")</strong></MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }

        <MudPaper Class="pa-4 mt-4" Style="background-color: #f5f5f5;">
            <MudGrid>
                <MudItem xs="12" md="6">
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Sub Total:</MudText>
                            <MudText>₹@_invoice.SubTotal?.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Tax (@_invoice.TaxPercent%):</MudText>
                            <MudText>₹@_invoice.TaxAmount?.ToString("N2")</MudText>
                        </MudStack>
                        @if (_invoice.SpecialChargesTotal > 0)
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText>Special Charges:</MudText>
                                <MudText>₹@_invoice.SpecialChargesTotal?.ToString("N2")</MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText>Special Charges Tax:</MudText>
                                <MudText>₹@_invoice.SpecialChargesTax?.ToString("N2")</MudText>
                            </MudStack>
                        }
                        <MudDivider Class="my-2" />
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Net Total:</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Primary">₹@_invoice.NetTotal?.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Paid Amount:</MudText>
                            <MudText Color="Color.Success">₹@_invoice.PaidAmount?.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle1"><strong>Balance Due:</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Error"><strong>₹@_invoice.BalanceAmount?.ToString("N2")</strong></MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudContainer>
}

@code {
    [Parameter] public long InvoiceId { get; set; }

    private bool _loading = true;
    private bool _sendingEmail = false;
    private Invoice? _invoice;
    private Party? _customer;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoice();
    }

    private async Task LoadInvoice()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _invoice = await Context.Invoices
                .Include(i => i.Details)
                .Include(i => i.SpecialCharges)
                .FirstOrDefaultAsync(i => i.Id == InvoiceId);

            if (_invoice?.CustomerId > 0)
            {
                _customer = await Context.Parties
                    .FirstOrDefaultAsync(p => p.Id == _invoice.CustomerId);
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task PostInvoice()
    {
        try
        {
            await InvoicingService.PostInvoice(InvoiceId);
            Snackbar.Add("Invoice posted successfully", Severity.Success);
            await LoadInvoice();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error posting invoice: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Draft => Color.Default,
        InvoiceStatus.Generated => Color.Success,
        InvoiceStatus.PartiallyPaid => Color.Warning,
        InvoiceStatus.Paid => Color.Info,
        InvoiceStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string BuildEmailBody(Invoice invoice, Party customer, string companyName)
    {
        var periodFrom = invoice.PeriodFrom?.ToString("dd-MMM-yyyy") ?? "N/A";
        var periodTo = invoice.PeriodTo?.ToString("dd-MMM-yyyy") ?? "N/A";
        var dueDate = invoice.DueDate?.ToString("dd-MMM-yyyy") ?? "N/A";
        var netTotal = invoice.NetTotal?.ToString("N2") ?? "0.00";
        var balance = invoice.BalanceAmount?.ToString("N2") ?? "0.00";

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<html>");
        sb.AppendLine("<body style='font-family: Arial, sans-serif;'>");
        sb.AppendLine($"<h2>Invoice {invoice.InvoiceNo}</h2>");
        sb.AppendLine($"<p>Dear {customer.Name},</p>");
        sb.AppendLine($"<p>Please find attached your invoice for the period {periodFrom} to {periodTo}.</p>");
        sb.AppendLine("<table style='border-collapse: collapse; margin: 20px 0;'>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Invoice No:</strong></td><td>{invoice.InvoiceNo}</td></tr>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Invoice Date:</strong></td><td>{invoice.InvoiceDate:dd-MMM-yyyy}</td></tr>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Due Date:</strong></td><td>{dueDate}</td></tr>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Total AWBs:</strong></td><td>{invoice.TotalAWBs}</td></tr>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Net Total:</strong></td><td style='font-weight: bold; color: #2196F3;'>{netTotal}</td></tr>");
        sb.AppendLine($"<tr><td style='padding: 5px 15px 5px 0;'><strong>Balance Due:</strong></td><td style='font-weight: bold; color: #f44336;'>{balance}</td></tr>");
        sb.AppendLine("</table>");
        sb.AppendLine("<p>Thank you for your business.</p>");
        sb.AppendLine($"<p>Best regards,<br/>{companyName}</p>");
        sb.AppendLine("</body>");
        sb.AppendLine("</html>");
        return sb.ToString();
    }

    private async Task EmailInvoice()
    {
        if (_invoice == null)
        {
            Snackbar.Add("Invoice not loaded", Severity.Error);
            return;
        }

        if (_customer == null || string.IsNullOrWhiteSpace(_customer.Email))
        {
            Snackbar.Add("Customer email address not found. Please update the customer's email in Customer Master.", Severity.Warning);
            return;
        }

        _sendingEmail = true;
        StateHasChanged();

        try
        {
            var company = await Context.Companies.FirstOrDefaultAsync(c => c.IsActive && !c.IsDeleted);
            var companyName = company?.Name ?? "Net4Courier";
            var companyEmail = company?.Email ?? "noreply@net4courier.com";

            // Load company logo for PDF (same logic as download API)
            byte[]? logoData = null;
            if (!string.IsNullOrEmpty(company?.Logo))
            {
                try
                {
                    var logoPath = company.Logo.TrimStart('/');
                    var fullPath = Path.Combine(Environment.WebRootPath ?? Environment.ContentRootPath, logoPath);
                    if (File.Exists(fullPath))
                    {
                        logoData = await File.ReadAllBytesAsync(fullPath);
                    }
                }
                catch { /* Logo loading failed, continue without logo */ }
            }

            // Get shipment for commercial invoice format (same logic as download API)
            Net4Courier.Operations.Entities.InscanMaster? shipment = null;
            if (_invoice.Details.Any())
            {
                var firstDetail = _invoice.Details.First();
                if (firstDetail.InscanId > 0)
                {
                    shipment = await Context.InscanMasters.FirstOrDefaultAsync(i => i.Id == firstDetail.InscanId);
                }
                else if (!string.IsNullOrEmpty(firstDetail.AWBNo))
                {
                    shipment = await Context.InscanMasters.FirstOrDefaultAsync(i => i.AWBNo == firstDetail.AWBNo && !i.IsDeleted);
                }
            }

            // Generate PDF using same format as download
            byte[] pdfBytes;
            if (shipment != null)
            {
                var currency = shipment.Currency ?? "AED";
                pdfBytes = ReportingService.GenerateShipmentInvoicePdf(_invoice, shipment, currency, logoData);
            }
            else
            {
                pdfBytes = ReportingService.GenerateInvoicePdf(_invoice);
            }

            var subject = $"Invoice {_invoice.InvoiceNo} from {companyName}";
            var htmlBody = BuildEmailBody(_invoice, _customer, companyName);

            var fileName = $"Invoice_{_invoice.InvoiceNo}.pdf";

            var success = await GmailEmailService.SendEmailWithAttachmentAsync(
                to: _customer.Email,
                toName: _customer.Name ?? "",
                subject: subject,
                htmlBody: htmlBody,
                attachmentBytes: pdfBytes,
                fileName: fileName,
                contentType: "application/pdf",
                fromEmail: companyEmail,
                fromName: companyName
            );

            if (success)
            {
                Snackbar.Add($"Invoice emailed successfully to {_customer.Email}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send email. Please check the Gmail integration is configured correctly.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending email: {ex.Message}", Severity.Error);
        }
        finally
        {
            _sendingEmail = false;
            StateHasChanged();
        }
    }
}

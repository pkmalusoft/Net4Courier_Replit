@page "/status-management"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Context
@inject ShipmentStatusService StatusService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Status Management</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5">Shipment Status Management</MudText>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="SeedDefaults">Seed Defaults</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenAddGroupDialog">Add Group</MudButton>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (!_groups.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            No status groups defined. Click "Seed Defaults" to create standard groups and statuses.
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_allStatuses" Hover="true" Striped="true" Dense="true" 
                  Filter="new Func<StatusViewModel, bool>(FilterFunc)" GroupBy="@_groupDefinition"
                  GroupHeaderStyle="background-color:var(--mud-palette-background-gray)">
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" />
            </ToolBarContent>
            <ColGroup>
                <col style="width:80px" />
                <col style="width:100px" />
                <col />
                <col style="width:120px" />
                <col style="width:100px" />
                <col style="width:100px" />
                <col style="width:100px" />
                <col style="width:100px" />
            </ColGroup>
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Code</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Maps To</MudTh>
                <MudTh>Terminal</MudTh>
                <MudTh>Exception</MudTh>
                <MudTh>Active</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh colspan="8">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@GetIcon(context.Key)" Size="Size.Small" />
                        <MudText Typo="Typo.subtitle1"><b>@context.Key</b></MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.Items.Count() statuses</MudChip>
                        <MudSpacer />
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="@(() => OpenAddStatusDialogByName(context.Key))">Add Status</MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => OpenEditGroupDialogByName(context.Key))">Edit Group</MudButton>
                    </MudStack>
                </MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.Id</MudTd>
                <MudTd DataLabel="Code">@context.Code</MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Maps To">@context.MapsToCourierStatus</MudTd>
                <MudTd DataLabel="Terminal">
                    @if (context.IsTerminal)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Exception">
                    @if (context.IsException)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Active">
                    @if (context.IsActive)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                   OnClick="@(() => OpenEditStatusDialog(context.Status))" Title="Edit" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No statuses found</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _loading;
    private List<ShipmentStatusGroup> _groups = new();
    private List<StatusViewModel> _allStatuses = new();
    private string _searchString = "";

    private TableGroupDefinition<StatusViewModel> _groupDefinition = new()
    {
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (s) => s.GroupName
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    private async Task LoadGroups()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _groups = await StatusService.GetAllGroups();
            _allStatuses = _groups
                .SelectMany(g => g.Statuses.Select(s => new StatusViewModel
                {
                    Id = s.Id,
                    GroupId = g.Id,
                    GroupName = g.Name ?? "",
                    GroupIcon = g.IconName,
                    Code = s.Code ?? "",
                    Name = s.Name ?? "",
                    SequenceNo = s.SequenceNo,
                    IsTerminal = s.IsTerminal,
                    IsException = s.IsException,
                    MapsToCourierStatus = s.MapsToCourierStatus?.ToString() ?? "",
                    IsActive = s.IsActive,
                    Status = s
                }))
                .OrderBy(s => s.GroupName)
                .ThenBy(s => s.SequenceNo)
                .ToList();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private bool FilterFunc(StatusViewModel status) => 
        string.IsNullOrWhiteSpace(_searchString) ||
        status.Code.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
        status.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
        status.GroupName.Contains(_searchString, StringComparison.OrdinalIgnoreCase);

    private async Task SeedDefaults()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Seed Default Statuses",
            "This will create the standard 9 status groups with ~30 statuses. Continue?",
            yesText: "Yes", cancelText: "No");

        if (confirmed == true)
        {
            await StatusService.SeedDefaultStatuses();
            Snackbar.Add("Default statuses seeded successfully", Severity.Success);
            await LoadGroups();
        }
    }

    private async Task OpenAddGroupDialog()
    {
        var newGroup = new ShipmentStatusGroup
        {
            SequenceNo = _groups.Count + 1,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };

        var parameters = new DialogParameters<GroupEditDialog> { { x => x.Group, newGroup } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<GroupEditDialog>("Add Status Group", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatusGroup savedGroup)
        {
            await SaveGroup(savedGroup, isNew: true);
        }
    }

    private async Task OpenEditGroupDialogByName(object groupName)
    {
        var group = _groups.FirstOrDefault(g => g.Name == groupName?.ToString());
        if (group != null) await OpenEditGroupDialog(group);
    }

    private async Task OpenEditGroupDialog(ShipmentStatusGroup group)
    {
        var editGroup = new ShipmentStatusGroup
        {
            Id = group.Id,
            Code = group.Code ?? "",
            Name = group.Name ?? "",
            Description = group.Description,
            SequenceNo = group.SequenceNo,
            IconName = group.IconName,
            ColorCode = group.ColorCode,
            IsActive = group.IsActive,
            CreatedAt = group.CreatedAt
        };

        var parameters = new DialogParameters<GroupEditDialog> { { x => x.Group, editGroup } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<GroupEditDialog>("Edit Status Group", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatusGroup savedGroup)
        {
            await SaveGroup(savedGroup, isNew: false);
        }
    }

    private async Task SaveGroup(ShipmentStatusGroup group, bool isNew)
    {
        try
        {
            if (isNew)
            {
                group.CreatedAt = DateTime.UtcNow;
                Context.ShipmentStatusGroups.Add(group);
            }
            else
            {
                var existing = await Context.ShipmentStatusGroups.FindAsync(group.Id);
                if (existing != null)
                {
                    existing.Code = group.Code;
                    existing.Name = group.Name;
                    existing.Description = group.Description;
                    existing.SequenceNo = group.SequenceNo;
                    existing.IconName = group.IconName;
                    existing.ColorCode = group.ColorCode;
                    existing.IsActive = group.IsActive;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }

            await Context.SaveChangesAsync();
            Snackbar.Add("Group saved successfully", Severity.Success);
            await LoadGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving group: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddStatusDialogByName(object groupName)
    {
        var group = _groups.FirstOrDefault(g => g.Name == groupName?.ToString());
        if (group != null) await OpenAddStatusDialog(group);
    }

    private async Task OpenAddStatusDialog(ShipmentStatusGroup group)
    {
        var newStatus = new ShipmentStatus
        {
            StatusGroupId = group.Id,
            SequenceNo = group.Statuses.Count + 1,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };

        var parameters = new DialogParameters<StatusEditDialog> { { x => x.Status, newStatus } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusEditDialog>("Add Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatus savedStatus)
        {
            await SaveStatus(savedStatus, isNew: true);
        }
    }

    private async Task OpenEditStatusDialog(ShipmentStatus status)
    {
        var editStatus = new ShipmentStatus
        {
            Id = status.Id,
            StatusGroupId = status.StatusGroupId,
            Code = status.Code ?? "",
            Name = status.Name ?? "",
            TimelineDescription = status.TimelineDescription,
            SequenceNo = status.SequenceNo,
            IsTerminal = status.IsTerminal,
            IsException = status.IsException,
            MapsToCourierStatus = status.MapsToCourierStatus,
            IconName = status.IconName,
            ColorCode = status.ColorCode,
            RequiresPOD = status.RequiresPOD,
            RequiresLocation = status.RequiresLocation,
            RequiresRemarks = status.RequiresRemarks,
            IsActive = status.IsActive,
            CreatedAt = status.CreatedAt
        };

        var parameters = new DialogParameters<StatusEditDialog> { { x => x.Status, editStatus } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusEditDialog>("Edit Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatus savedStatus)
        {
            await SaveStatus(savedStatus, isNew: false);
        }
    }

    private async Task SaveStatus(ShipmentStatus status, bool isNew)
    {
        try
        {
            if (isNew)
            {
                status.CreatedAt = DateTime.UtcNow;
                Context.ShipmentStatuses.Add(status);
            }
            else
            {
                var existing = await Context.ShipmentStatuses.FindAsync(status.Id);
                if (existing != null)
                {
                    existing.Code = status.Code;
                    existing.Name = status.Name;
                    existing.TimelineDescription = status.TimelineDescription;
                    existing.SequenceNo = status.SequenceNo;
                    existing.IsTerminal = status.IsTerminal;
                    existing.IsException = status.IsException;
                    existing.MapsToCourierStatus = status.MapsToCourierStatus;
                    existing.IconName = status.IconName;
                    existing.ColorCode = status.ColorCode;
                    existing.RequiresPOD = status.RequiresPOD;
                    existing.RequiresLocation = status.RequiresLocation;
                    existing.RequiresRemarks = status.RequiresRemarks;
                    existing.IsActive = status.IsActive;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }

            await Context.SaveChangesAsync();
            Snackbar.Add("Status saved successfully", Severity.Success);
            await LoadGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving status: {ex.Message}", Severity.Error);
        }
    }

    private string GetIcon(object? iconName) => iconName?.ToString() switch
    {
        "Schedule" => Icons.Material.Filled.Schedule,
        "LocalShipping" => Icons.Material.Filled.LocalShipping,
        "Warehouse" => Icons.Material.Filled.Warehouse,
        "Flight" => Icons.Material.Filled.Flight,
        "Hub" => Icons.Material.Filled.Hub,
        "DeliveryDining" => Icons.Material.Filled.DeliveryDining,
        "Warning" => Icons.Material.Filled.Warning,
        "AttachMoney" => Icons.Material.Filled.AttachMoney,
        "CheckCircle" => Icons.Material.Filled.CheckCircle,
        _ => Icons.Material.Filled.Circle
    };

    private class StatusViewModel
    {
        public long Id { get; set; }
        public long GroupId { get; set; }
        public string GroupName { get; set; } = "";
        public string? GroupIcon { get; set; }
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public int SequenceNo { get; set; }
        public bool IsTerminal { get; set; }
        public bool IsException { get; set; }
        public string MapsToCourierStatus { get; set; } = "";
        public bool IsActive { get; set; }
        public ShipmentStatus Status { get; set; } = null!;
    }
}

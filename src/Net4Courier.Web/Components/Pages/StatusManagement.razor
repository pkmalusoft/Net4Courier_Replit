@page "/status-management"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Context
@inject ShipmentStatusService StatusService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Status Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5">Shipment Status Management</MudText>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="SeedDefaults">
                Seed Defaults
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenAddGroupDialog">
                Add Group
            </MudButton>
        </MudStack>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (!_groups.Any())
    {
        <MudPaper Class="pa-8" Elevation="1">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">No Status Groups Defined</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Click "Seed Defaults" to create the standard 9 groups with ~30 statuses, or add groups manually.
                </MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudGrid>
            @foreach (var group in _groups)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudPaper Class="pa-4" Elevation="2" Style="@($"border-left: 4px solid {group.ColorCode ?? "#9E9E9E"};")">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start" Class="mb-3">
                            <MudStack Spacing="0">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@GetIcon(group.IconName)" Size="Size.Small" />
                                    <MudText Typo="Typo.h6">@group.Name</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">ID: @group.Id</MudChip>
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@group.Code</MudText>
                            </MudStack>
                            <MudStack Row="true" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => OpenAddStatusDialog(group))" Title="Add Status" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Default"
                                               OnClick="@(() => OpenEditGroupDialog(group))" Title="Edit Group" />
                            </MudStack>
                        </MudStack>

                        @if (group.Statuses.Any())
                        {
                            <MudList T="ShipmentStatus" Dense="true">
                                @foreach (var status in group.Statuses.OrderBy(s => s.SequenceNo))
                                {
                                    <MudListItem T="ShipmentStatus">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Spacing="0">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">ID: @status.Id</MudChip>
                                                    <MudText Typo="Typo.body2">@status.Name</MudText>
                                                    @if (status.IsTerminal)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Terminal</MudChip>
                                                    }
                                                    @if (status.IsException)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Exception</MudChip>
                                                    }
                                                </MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@status.Code</MudText>
                                            </MudStack>
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                           OnClick="@(() => OpenEditStatusDialog(status))" />
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">No statuses defined</MudText>
                        }
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private bool _loading;
    private List<ShipmentStatusGroup> _groups = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    private async Task LoadGroups()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _groups = await StatusService.GetAllGroups();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task SeedDefaults()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Seed Default Statuses",
            "This will create the standard 9 status groups with ~30 statuses. Continue?",
            yesText: "Yes", cancelText: "No");

        if (confirmed == true)
        {
            await StatusService.SeedDefaultStatuses();
            Snackbar.Add("Default statuses seeded successfully", Severity.Success);
            await LoadGroups();
        }
    }

    private async Task OpenAddGroupDialog()
    {
        var newGroup = new ShipmentStatusGroup
        {
            SequenceNo = _groups.Count + 1,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };

        var parameters = new DialogParameters<GroupEditDialog> { { x => x.Group, newGroup } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<GroupEditDialog>("Add Status Group", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatusGroup savedGroup)
        {
            await SaveGroup(savedGroup, isNew: true);
        }
    }

    private async Task OpenEditGroupDialog(ShipmentStatusGroup group)
    {
        var editGroup = new ShipmentStatusGroup
        {
            Id = group.Id,
            Code = group.Code ?? "",
            Name = group.Name ?? "",
            Description = group.Description,
            SequenceNo = group.SequenceNo,
            IconName = group.IconName,
            ColorCode = group.ColorCode,
            IsActive = group.IsActive,
            CreatedAt = group.CreatedAt
        };

        var parameters = new DialogParameters<GroupEditDialog> { { x => x.Group, editGroup } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<GroupEditDialog>("Edit Status Group", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatusGroup savedGroup)
        {
            await SaveGroup(savedGroup, isNew: false);
        }
    }

    private async Task SaveGroup(ShipmentStatusGroup group, bool isNew)
    {
        try
        {
            if (isNew)
            {
                group.CreatedAt = DateTime.UtcNow;
                Context.ShipmentStatusGroups.Add(group);
            }
            else
            {
                var existing = await Context.ShipmentStatusGroups.FindAsync(group.Id);
                if (existing != null)
                {
                    existing.Code = group.Code;
                    existing.Name = group.Name;
                    existing.Description = group.Description;
                    existing.SequenceNo = group.SequenceNo;
                    existing.IconName = group.IconName;
                    existing.ColorCode = group.ColorCode;
                    existing.IsActive = group.IsActive;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }

            await Context.SaveChangesAsync();
            Snackbar.Add("Group saved successfully", Severity.Success);
            await LoadGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving group: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddStatusDialog(ShipmentStatusGroup group)
    {
        var newStatus = new ShipmentStatus
        {
            StatusGroupId = group.Id,
            SequenceNo = group.Statuses.Count + 1,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };

        var parameters = new DialogParameters<StatusEditDialog> { { x => x.Status, newStatus } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusEditDialog>("Add Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatus savedStatus)
        {
            await SaveStatus(savedStatus, isNew: true);
        }
    }

    private async Task OpenEditStatusDialog(ShipmentStatus status)
    {
        var editStatus = new ShipmentStatus
        {
            Id = status.Id,
            StatusGroupId = status.StatusGroupId,
            Code = status.Code ?? "",
            Name = status.Name ?? "",
            TimelineDescription = status.TimelineDescription,
            SequenceNo = status.SequenceNo,
            IsTerminal = status.IsTerminal,
            IsException = status.IsException,
            MapsToCourierStatus = status.MapsToCourierStatus,
            IconName = status.IconName,
            ColorCode = status.ColorCode,
            RequiresPOD = status.RequiresPOD,
            RequiresLocation = status.RequiresLocation,
            RequiresRemarks = status.RequiresRemarks,
            IsActive = status.IsActive,
            CreatedAt = status.CreatedAt
        };

        var parameters = new DialogParameters<StatusEditDialog> { { x => x.Status, editStatus } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StatusEditDialog>("Edit Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ShipmentStatus savedStatus)
        {
            await SaveStatus(savedStatus, isNew: false);
        }
    }

    private async Task SaveStatus(ShipmentStatus status, bool isNew)
    {
        try
        {
            if (isNew)
            {
                status.CreatedAt = DateTime.UtcNow;
                Context.ShipmentStatuses.Add(status);
            }
            else
            {
                var existing = await Context.ShipmentStatuses.FindAsync(status.Id);
                if (existing != null)
                {
                    existing.Code = status.Code;
                    existing.Name = status.Name;
                    existing.TimelineDescription = status.TimelineDescription;
                    existing.SequenceNo = status.SequenceNo;
                    existing.IsTerminal = status.IsTerminal;
                    existing.IsException = status.IsException;
                    existing.MapsToCourierStatus = status.MapsToCourierStatus;
                    existing.IconName = status.IconName;
                    existing.ColorCode = status.ColorCode;
                    existing.RequiresPOD = status.RequiresPOD;
                    existing.RequiresLocation = status.RequiresLocation;
                    existing.RequiresRemarks = status.RequiresRemarks;
                    existing.IsActive = status.IsActive;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }

            await Context.SaveChangesAsync();
            Snackbar.Add("Status saved successfully", Severity.Success);
            await LoadGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving status: {ex.Message}", Severity.Error);
        }
    }

    private string GetIcon(string? iconName) => iconName switch
    {
        "Schedule" => Icons.Material.Filled.Schedule,
        "LocalShipping" => Icons.Material.Filled.LocalShipping,
        "Warehouse" => Icons.Material.Filled.Warehouse,
        "Flight" => Icons.Material.Filled.Flight,
        "Hub" => Icons.Material.Filled.Hub,
        "DeliveryDining" => Icons.Material.Filled.DeliveryDining,
        "Warning" => Icons.Material.Filled.Warning,
        "AttachMoney" => Icons.Material.Filled.AttachMoney,
        "CheckCircle" => Icons.Material.Filled.CheckCircle,
        _ => Icons.Material.Filled.Circle
    };
}

@page "/customer/track"
@layout CustomerLayout
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>Track Shipment - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4">
    <MudText Typo="Typo.h5" GutterBottom="true" Align="Align.Center">Track Your Shipment</MudText>
    
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Spacing="2">
            <MudTextField @bind-Value="_awbNo" Label="Enter AWB Number" Variant="Variant.Outlined" 
                          FullWidth="true" OnKeyUp="OnKeyUp" Placeholder="e.g., AWB20260116000001" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Track" 
                       StartIcon="@Icons.Material.Filled.Search" Size="Size.Large">
                Track
            </MudButton>
        </MudStack>
    </MudPaper>
    
    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    
    @if (_awb != null)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h6" Color="Color.Primary">@_awb.AWBNo</MudText>
                        <MudChip T="string" Color="@GetStatusColor(_awb.CourierStatusId)" Size="Size.Medium">
                            @_awb.CourierStatusId
                        </MudChip>
                    </MudStack>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Booked On</MudText>
                        <MudText>@_awb.TransactionDate.ToString("dd MMM yyyy")</MudText>
                    </MudStack>
                </MudItem>
            </MudGrid>
            
            <MudDivider Class="my-3" />
            
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">From</MudText>
                    <MudText Typo="Typo.body1"><strong>@_awb.Consignor</strong></MudText>
                    <MudText Typo="Typo.body2">@_awb.ConsignorCity, @_awb.ConsignorCountry</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">To</MudText>
                    <MudText Typo="Typo.body1"><strong>@_awb.Consignee</strong></MudText>
                    <MudText Typo="Typo.body2">@_awb.ConsigneeAddress1</MudText>
                    <MudText Typo="Typo.body2">@_awb.ConsigneeCity, @_awb.ConsigneeCountry</MudText>
                </MudItem>
            </MudGrid>
            
            <MudDivider Class="my-3" />
            
            <MudGrid>
                <MudItem xs="4">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Pieces</MudText>
                        <MudText>@_awb.Pieces</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="4">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Weight</MudText>
                        <MudText>@(_awb.Weight?.ToString("F2") ?? "0") kg</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="4">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                        <MudText>@_awb.DocumentTypeId</MudText>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>
        
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Tracking History</MudText>
            
            @if (_trackingHistory.Any())
            {
                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                    @foreach (var track in _trackingHistory)
                    {
                        <MudTimelineItem Color="@GetTrackingColor(track)" Size="Size.Small">
                            <ItemContent>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.subtitle2"><strong>@track.StatusId</strong></MudText>
                                    <MudText Typo="Typo.body2">@track.Remarks</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @track.EventDateTime.ToString("dd MMM yyyy HH:mm") | @track.Location
                                    </MudText>
                                </MudStack>
                            </ItemContent>
                        </MudTimelineItem>
                    }
                </MudTimeline>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No tracking updates available yet</MudAlert>
            }
        </MudPaper>
    }
    else if (_searched && !_loading)
    {
        <MudAlert Severity="Severity.Warning">
            No shipment found with AWB number: @_searchedAwb
        </MudAlert>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery(Name = "awb")]
    public string? AwbParam { get; set; }
    
    private string _awbNo = "";
    private string _searchedAwb = "";
    private InscanMaster? _awb;
    private List<AWBTracking> _trackingHistory = new();
    private bool _loading;
    private bool _searched;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(AwbParam))
        {
            _awbNo = AwbParam;
            await Track();
        }
    }

    private async Task OnKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Track();
        }
    }

    private async Task Track()
    {
        if (string.IsNullOrWhiteSpace(_awbNo))
        {
            Snackbar.Add("Please enter an AWB number", Severity.Warning);
            return;
        }

        _loading = true;
        _searched = true;
        _searchedAwb = _awbNo.Trim();
        StateHasChanged();

        try
        {
            _awb = await DbContext.InscanMasters
                .FirstOrDefaultAsync(a => a.AWBNo == _searchedAwb && !a.IsDeleted);

            if (_awb != null)
            {
                _trackingHistory = await DbContext.AWBTrackings
                    .Where(t => t.InscanId == _awb.Id)
                    .OrderByDescending(t => t.EventDateTime)
                    .ToListAsync();
            }
            else
            {
                _trackingHistory = new();
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Pending => Color.Info,
        CourierStatus.PickedUp => Color.Primary,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Warning,
        CourierStatus.Delivered => Color.Success,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private Color GetTrackingColor(AWBTracking track)
    {
        if (track.StatusId == CourierStatus.Delivered) return Color.Success;
        if (track.StatusId == CourierStatus.Returned) return Color.Error;
        return Color.Primary;
    }
}

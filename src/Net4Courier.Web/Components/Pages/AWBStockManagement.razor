@page "/awb-stock"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Infrastructure.Services
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AWBStockService StockService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>AWB Stock Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5">AWB Stock Management</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog">
            Add Stock
        </MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else
    {
        <MudTable Items="@_stocks" Dense="true" Hover="true" Striped="true" Bordered="true">
            <HeaderContent>
                <MudTh>Ref No.</MudTh>
                <MudTh>Date</MudTh>
                <MudTh>Item Name</MudTh>
                <MudTh>Item Type</MudTh>
                <MudTh Style="text-align:right">Qty</MudTh>
                <MudTh Style="text-align:right">Rate</MudTh>
                <MudTh Style="text-align:right">Amount</MudTh>
                <MudTh Style="text-align:right">AWB Count</MudTh>
                <MudTh>AWB From</MudTh>
                <MudTh>AWB To</MudTh>
                <MudTh Style="text-align:right">Available</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="width:100px">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ReferenceNo</MudTd>
                <MudTd>@context.StockDate.ToString("dd-MMM-yyyy")</MudTd>
                <MudTd>@context.ItemName</MudTd>
                <MudTd>@context.ItemType</MudTd>
                <MudTd Style="text-align:right">@context.Qty</MudTd>
                <MudTd Style="text-align:right">@context.Rate.ToString("N2")</MudTd>
                <MudTd Style="text-align:right">@context.Amount.ToString("N2")</MudTd>
                <MudTd Style="text-align:right">@context.AWBCount</MudTd>
                <MudTd>@context.AWBNoFrom</MudTd>
                <MudTd>@context.AWBNoTo</MudTd>
                <MudTd Style="text-align:right">@context.AvailableCount</MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                       Color="Color.Primary" OnClick="@(() => OpenEditDialog(context))"
                                       Disabled="@(context.AllocatedCount > 0)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                       Color="Color.Error" OnClick="@(() => DeleteStock(context))"
                                       Disabled="@(context.AllocatedCount > 0)" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No AWB stock entries found</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudContainer>


@code {
    private List<AWBStock> _stocks = new();
    private bool _loading = true;
    private long _companyId;
    private long _branchId;
    private int _userId;
    private string _userName = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadUserContext();
        await LoadStocks();
    }

    private async Task LoadUserContext()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId")?.Value;
            var branchIdClaim = user.FindFirst("BranchId")?.Value;
            var companyIdClaim = user.FindFirst("CompanyId")?.Value;

            if (int.TryParse(userIdClaim, out var uid)) _userId = uid;
            if (long.TryParse(branchIdClaim, out var bid)) _branchId = bid;
            if (long.TryParse(companyIdClaim, out var cid)) _companyId = cid;
            _userName = user.Identity.Name ?? "";
        }
    }

    private async Task LoadStocks()
    {
        _loading = true;
        try
        {
            _stocks = await StockService.GetAllStockAsync(_companyId, _branchId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading stocks: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenAddDialog()
    {
        var model = new AWBStock
        {
            StockDate = DateTime.UtcNow,
            CompanyId = _companyId,
            BranchId = _branchId,
            Qty = 1,
            AWBCount = 1
        };
        
        var parameters = new DialogParameters<AWBStockDialog>
        {
            { x => x.Stock, model },
            { x => x.IsEdit, false }
        };
        
        var dialog = await DialogService.ShowAsync<AWBStockDialog>("Add AWB Stock", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is AWBStock stock)
        {
            await SaveStock(stock, false);
        }
    }

    private async Task OpenEditDialog(AWBStock stock)
    {
        var model = new AWBStock
        {
            Id = stock.Id,
            CompanyId = stock.CompanyId,
            BranchId = stock.BranchId,
            StockDate = stock.StockDate,
            ReferenceNo = stock.ReferenceNo,
            ItemName = stock.ItemName,
            ItemType = stock.ItemType,
            Qty = stock.Qty,
            Rate = stock.Rate,
            Amount = stock.Amount,
            AWBCount = stock.AWBCount,
            AWBNoFrom = stock.AWBNoFrom,
            AWBNoTo = stock.AWBNoTo,
            Remarks = stock.Remarks
        };
        
        var parameters = new DialogParameters<AWBStockDialog>
        {
            { x => x.Stock, model },
            { x => x.IsEdit, true }
        };
        
        var dialog = await DialogService.ShowAsync<AWBStockDialog>("Edit AWB Stock", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is AWBStock updatedStock)
        {
            await SaveStock(updatedStock, true);
        }
    }

    private async Task SaveStock(AWBStock stockModel, bool isEdit)
    {
        try
        {
            if (string.IsNullOrEmpty(stockModel.ItemName))
            {
                Snackbar.Add("Please select an item name", Severity.Warning);
                return;
            }

            if (string.IsNullOrEmpty(stockModel.AWBNoFrom) || string.IsNullOrEmpty(stockModel.AWBNoTo))
            {
                Snackbar.Add("Please enter AWB range", Severity.Warning);
                return;
            }

            stockModel.StockDate = DateTime.SpecifyKind(stockModel.StockDate, DateTimeKind.Utc);

            if (isEdit)
            {
                var existing = await StockService.GetByIdAsync(stockModel.Id);
                if (existing != null)
                {
                    existing.ItemName = stockModel.ItemName;
                    existing.ItemType = stockModel.ItemType;
                    existing.ReferenceNo = stockModel.ReferenceNo;
                    existing.Qty = stockModel.Qty;
                    existing.Rate = stockModel.Rate;
                    existing.AWBCount = stockModel.AWBCount;
                    existing.AWBNoFrom = stockModel.AWBNoFrom;
                    existing.AWBNoTo = stockModel.AWBNoTo;
                    existing.Remarks = stockModel.Remarks;
                    existing.ModifiedBy = _userId;
                    existing.ModifiedByName = _userName;
                    await StockService.UpdateStockAsync(existing);
                    Snackbar.Add("Stock updated successfully", Severity.Success);
                }
            }
            else
            {
                if (string.IsNullOrEmpty(stockModel.ReferenceNo))
                    stockModel.ReferenceNo = await StockService.GenerateNextReferenceNoAsync(_companyId, _branchId);

                stockModel.CreatedBy = _userId;
                stockModel.CreatedByName = _userName;
                await StockService.CreateStockAsync(stockModel);
                Snackbar.Add("Stock added successfully", Severity.Success);
            }

            await LoadStocks();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving stock: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteStock(AWBStock stock)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Stock",
            $"Are you sure you want to delete this stock entry ({stock.ReferenceNo})?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                await StockService.DeleteStockAsync(stock.Id, _userId);
                Snackbar.Add("Stock deleted successfully", Severity.Success);
                await LoadStocks();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting stock: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetStatusColor(StockStatus status) => status switch
    {
        StockStatus.Available => Color.Success,
        StockStatus.PartiallyAllocated => Color.Warning,
        StockStatus.FullyAllocated => Color.Info,
        StockStatus.Cancelled => Color.Error,
        _ => Color.Default
    };
}

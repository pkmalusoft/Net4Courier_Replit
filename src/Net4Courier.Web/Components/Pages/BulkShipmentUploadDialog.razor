@inject ShipmentExcelService ExcelService
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject Net4Courier.Operations.Services.BarcodeService BarcodeService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Bulk Shipment Upload</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3" Style="min-width: 600px; max-width: 900px;">
            @if (!string.IsNullOrEmpty(CustomerName))
            {
                <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Person">
                    <strong>Customer:</strong> @CustomerName
                </MudAlert>
            }
            
            @if (_step == UploadStep.Download)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    Download the template, fill in your shipment data, then upload the completed file.
                </MudAlert>
                
                <MudPaper Class="pa-4" Elevation="0" Style="background-color: #f5f5f5;">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Step 1: Download Template</MudText>
                        <MudText Typo="Typo.body2">
                            Download the Excel template containing all required columns for bulk shipment upload.
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download"
                                   OnClick="DownloadTemplate" Disabled="_isDownloading">
                            @if (_isDownloading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Download Template
                        </MudButton>
                    </MudStack>
                </MudPaper>
                
                <MudPaper Class="pa-4" Elevation="0" Style="background-color: #f5f5f5;">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Step 2: Upload Completed File</MudText>
                        <MudText Typo="Typo.body2">
                            After filling in the template with your shipment data, upload it here.
                        </MudText>
                        <MudFileUpload T="IBrowserFile" Accept=".xlsx,.xls" FilesChanged="OnFileSelected" MaximumFileCount="1">
                            <ButtonTemplate>
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled" 
                                           Color="Color.Success" 
                                           StartIcon="@Icons.Material.Filled.Upload"
                                           Disabled="_isProcessing" 
                                           FullWidth="true"
                                           for="@context.Id">
                                    @if (_isProcessing)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    Upload Excel File
                                </MudButton>
                            </ButtonTemplate>
                        </MudFileUpload>
                        @if (!string.IsNullOrEmpty(_selectedFileName))
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@_selectedFileName</MudChip>
                        }
                    </MudStack>
                </MudPaper>
            }
            else if (_step == UploadStep.Preview)
            {
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.subtitle1">Preview: @_parsedShipments.Count shipment(s) found</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack"
                               OnClick="GoBack">Back to Upload</MudButton>
                </MudStack>
                
                @if (_parseResult?.HasErrors == true)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        <MudText Typo="Typo.body2" Class="fw-bold">Validation Errors Found (@_parseResult.Errors.Count)</MudText>
                        <MudList T="string" Dense="true">
                            @foreach (var error in (_showAllErrors ? _parseResult.Errors : _parseResult.Errors.Take(10)))
                            {
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                    Row @error.RowNumber - @error.Field: @error.Message
                                </MudListItem>
                            }
                            @if (_parseResult.Errors.Count > 10 && !_showAllErrors)
                            {
                                <MudListItem T="string">
                                    <MudLink Color="Color.Primary" OnClick="@(() => _showAllErrors = true)" Style="cursor: pointer;">
                                        <MudIcon Icon="@Icons.Material.Filled.ExpandMore" Size="Size.Small" Class="mr-1" />
                                        Show all @(_parseResult.Errors.Count - 10) more errors
                                    </MudLink>
                                </MudListItem>
                            }
                            @if (_parseResult.Errors.Count > 10 && _showAllErrors)
                            {
                                <MudListItem T="string">
                                    <MudLink Color="Color.Secondary" OnClick="@(() => _showAllErrors = false)" Style="cursor: pointer;">
                                        <MudIcon Icon="@Icons.Material.Filled.ExpandLess" Size="Size.Small" Class="mr-1" />
                                        Show less
                                    </MudLink>
                                </MudListItem>
                            }
                        </MudList>
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Dense="true">
                        All @_parsedShipments.Count shipment(s) validated successfully. Ready to upload.
                    </MudAlert>
                }
                
                @if (_duplicateAWBs.Count > 0)
                {
                    <MudAlert Severity="Severity.Error" Dense="true">
                        <MudText Typo="Typo.body2" Class="fw-bold">Duplicate AWB Numbers Found</MudText>
                        <MudText Typo="Typo.body2">
                            The following AWB numbers already exist in the system: @string.Join(", ", _duplicateAWBs.Take(10))
                            @if (_duplicateAWBs.Count > 10)
                            {
                                <text>... and @(_duplicateAWBs.Count - 10) more</text>
                            }
                        </MudText>
                    </MudAlert>
                }
                
                @if (_autoGenerateCount > 0)
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <MudText Typo="Typo.body2">
                            <strong>@_autoGenerateCount shipment(s)</strong> have empty AWB numbers and will be auto-generated using the branch numbering sequence.
                        </MudText>
                    </MudAlert>
                }
                
                <MudTable Items="_parsedShipments.Take(50)" Dense="true" Striped="true" Hover="true" 
                          FixedHeader="true" Height="300px" Elevation="1">
                    <HeaderContent>
                        <MudTh>Row</MudTh>
                        <MudTh>AWB No</MudTh>
                        <MudTh>Date</MudTh>
                        <MudTh>Payment</MudTh>
                        <MudTh>Pcs</MudTh>
                        <MudTh>Weight</MudTh>
                        <MudTh>Shipper</MudTh>
                        <MudTh>Consignee</MudTh>
                        <MudTh>City</MudTh>
                        <MudTh>Country</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.RowNumber</MudTd>
                        <MudTd>@(string.IsNullOrWhiteSpace(context.AWBNo) ? "(Auto)" : context.AWBNo)</MudTd>
                        <MudTd>@context.TransactionDateStr</MudTd>
                        <MudTd>@context.PaymentModeStr</MudTd>
                        <MudTd>@context.Pieces</MudTd>
                        <MudTd>@context.Weight?.ToString("N2")</MudTd>
                        <MudTd>@TruncateText(context.ShipperName, 15)</MudTd>
                        <MudTd>@TruncateText(context.ConsigneeName, 15)</MudTd>
                        <MudTd>@context.ConsigneeCity</MudTd>
                        <MudTd>@context.ConsigneeCountry</MudTd>
                    </RowTemplate>
                </MudTable>
                @if (_parsedShipments.Count > 50)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Showing first 50 of @_parsedShipments.Count shipments
                    </MudText>
                }
            }
            else if (_step == UploadStep.Result)
            {
                <MudAlert Severity="Severity.Success" Dense="true">
                    <MudText Typo="Typo.h6">Upload Complete!</MudText>
                    <MudText Typo="Typo.body1">@_createdCount shipment(s) created successfully.</MudText>
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        @if (_step == UploadStep.Download)
        {
            <MudButton OnClick="Cancel">Cancel</MudButton>
        }
        else if (_step == UploadStep.Preview)
        {
            <MudButton OnClick="Cancel">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateShipments"
                       Disabled="@(_isCreating || _parseResult?.HasErrors == true || _duplicateAWBs.Count > 0)">
                @if (_isCreating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Create @_parsedShipments.Count Shipment(s)
            </MudButton>
        }
        else if (_step == UploadStep.Result)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Close">Close</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public long? BranchId { get; set; }
    [Parameter] public long? CompanyId { get; set; }
    [Parameter] public long? FinancialYearId { get; set; }
    [Parameter] public string? DefaultOriginCountry { get; set; } = "UAE";
    [Parameter] public long? CustomerId { get; set; }
    [Parameter] public string? CustomerName { get; set; }
    
    private UploadStep _step = UploadStep.Download;
    private bool _isDownloading;
    private bool _isProcessing;
    private bool _showAllErrors;
    private bool _isCreating;
    private string? _selectedFileName;
    private ShipmentExcelParseResult? _parseResult;
    private List<ShipmentUploadDto> _parsedShipments = new();
    private List<string> _duplicateAWBs = new();
    private int _createdCount;
    private int _autoGenerateCount;

    private enum UploadStep { Download, Preview, Result }

    private async Task DownloadTemplate()
    {
        _isDownloading = true;
        try
        {
            var cities = await DbContext.Cities
                .Include(c => c.Country)
                .Where(c => c.IsActive)
                .OrderBy(c => c.Name)
                .ToListAsync();
            
            var countries = await DbContext.Countries
                .Where(c => c.IsActive)
                .OrderBy(c => c.Name)
                .ToListAsync();
            
            var serviceTypes = await DbContext.ServiceTypes
                .Where(s => s.IsActive && !s.IsDeleted)
                .OrderBy(s => s.SortOrder)
                .ToListAsync();
            
            var templateBytes = ExcelService.GenerateTemplateWithMasterData(cities, countries, serviceTypes);
            var fileName = $"ShipmentUploadTemplate_{DateTime.Now:yyyyMMdd}.xlsx";
            
            await JSRuntime.InvokeVoidAsync("downloadFileFromBytes", fileName, Convert.ToBase64String(templateBytes));
            Snackbar.Add("Template downloaded successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading template: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDownloading = false;
        }
    }

    private async Task OnFileSelected(IBrowserFile file)
    {
        if (file == null) return;
        
        _isProcessing = true;
        _selectedFileName = file.Name;
        StateHasChanged();

        try
        {
            using var stream = new MemoryStream();
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
            stream.Position = 0;

            _parseResult = ExcelService.ParseExcel(stream);
            _parsedShipments = _parseResult.Shipments;

            if (_parsedShipments.Any())
            {
                var awbNumbers = _parsedShipments
                    .Where(s => !string.IsNullOrWhiteSpace(s.AWBNo))
                    .Select(s => s.AWBNo)
                    .ToList();
                
                if (awbNumbers.Any())
                {
                    var existingAWBs = await DbContext.Set<InscanMaster>()
                        .Where(i => awbNumbers.Contains(i.AWBNo) && !i.IsDeleted)
                        .Select(i => i.AWBNo)
                        .ToListAsync();
                    _duplicateAWBs = existingAWBs;
                }
                
                _autoGenerateCount = ExcelService.CountAutoGenerateAWBs(_parsedShipments);
            }

            _step = UploadStep.Preview;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error processing file: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void GoBack()
    {
        _step = UploadStep.Download;
        _parseResult = null;
        _parsedShipments.Clear();
        _duplicateAWBs.Clear();
        _selectedFileName = null;
        _showAllErrors = false;
        _autoGenerateCount = 0;
    }

    private async Task CreateShipments()
    {
        _isCreating = true;
        StateHasChanged();

        try
        {
            if (_autoGenerateCount > 0 && !BranchId.HasValue)
            {
                Snackbar.Add("Branch is required when shipments need auto-generated AWB numbers", Severity.Error);
                _isCreating = false;
                return;
            }
            
            List<InscanMaster> shipments;
            
            if (_autoGenerateCount > 0 && BranchId.HasValue)
            {
                var branch = await DbContext.Branches.FirstOrDefaultAsync(b => b.Id == BranchId.Value);
                if (branch == null)
                {
                    Snackbar.Add("Branch not found for AWB generation", Severity.Error);
                    _isCreating = false;
                    return;
                }
                
                shipments = ExcelService.CreateShipmentsWithAutoAWB(_parsedShipments, branch, CompanyId, FinancialYearId, DefaultOriginCountry);
                
                var generatedAWBs = shipments.Where(s => s.IsAutoGenerated == true).Select(s => s.AWBNo).ToList();
                if (generatedAWBs.Any())
                {
                    var existingAutoAWBs = await DbContext.Set<InscanMaster>()
                        .Where(i => generatedAWBs.Contains(i.AWBNo) && !i.IsDeleted)
                        .Select(i => i.AWBNo)
                        .ToListAsync();
                    
                    if (existingAutoAWBs.Any())
                    {
                        Snackbar.Add($"Auto-generated AWB numbers already exist: {string.Join(", ", existingAutoAWBs.Take(5))}. Please update branch AWB sequence.", Severity.Error);
                        _isCreating = false;
                        return;
                    }
                }
                
                DbContext.Branches.Update(branch);
            }
            else
            {
                shipments = ExcelService.CreateShipments(_parsedShipments, BranchId, CompanyId, FinancialYearId, DefaultOriginCountry);
            }
            
            if (CustomerId.HasValue)
            {
                foreach (var shipment in shipments)
                {
                    shipment.CustomerId = CustomerId.Value;
                    shipment.PaymentModeId = PaymentMode.Account;
                }
            }
            
            foreach (var shipment in shipments)
            {
                if (!string.IsNullOrEmpty(shipment.AWBNo))
                {
                    var (barcodeH, barcodeV) = BarcodeService.GenerateBothBarcodes(shipment.AWBNo);
                    shipment.BarcodeImage = barcodeH;
                    shipment.BarcodeImageVertical = barcodeV;
                }
            }
            
            await DbContext.Set<InscanMaster>().AddRangeAsync(shipments);
            await DbContext.SaveChangesAsync();

            _createdCount = shipments.Count;
            _step = UploadStep.Result;
            Snackbar.Add($"{_createdCount} shipments created successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating shipments: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreating = false;
        }
    }

    private string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length > maxLength ? text.Substring(0, maxLength) + "..." : text;
    }

    private void Cancel() => MudDialog.Cancel();
    private void Close() => MudDialog.Close(DialogResult.Ok(_createdCount));
}

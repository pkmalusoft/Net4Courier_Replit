@page "/ap-settings"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Web.Services
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject AppAuthStateProvider AuthState
@rendermode InteractiveServer

<PageTitle>AP Configuration - Net4Courier</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">Accounts Payable Configuration</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
        <MudTabPanel Text="General Settings" Icon="@Icons.Material.Filled.Settings">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Vendor Bill Settings</MudText>
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_billPrefix" Label="Bill Number Prefix" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_billStartNo" Label="Starting Bill Number" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_defaultPaymentTerms" Label="Default Payment Terms (Days)" Variant="Variant.Outlined" />
                            <MudSwitch @bind-Value="_autoGenerateBillNo" Label="Auto-Generate Bill Numbers" Color="Color.Primary" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Payment Settings</MudText>
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_paymentPrefix" Label="Payment Number Prefix" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_paymentStartNo" Label="Starting Payment Number" Variant="Variant.Outlined" />
                            <MudSwitch @bind-Value="_autoAllocatePayments" Label="Auto-Allocate Payments to Oldest Bills" Color="Color.Primary" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Approval Workflow</MudText>
                        <MudStack Spacing="3">
                            <MudSwitch @bind-Value="_requireBillApproval" Label="Require Bill Approval Before Payment" Color="Color.Primary" />
                            <MudSwitch @bind-Value="_requirePaymentApproval" Label="Require Payment Approval" Color="Color.Primary" />
                            <MudNumericField @bind-Value="_paymentApprovalThreshold" Label="Payment Approval Threshold" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="@AuthState.CurrencyCode" Disabled="@(!_requirePaymentApproval)" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Reminders & Notifications</MudText>
                        <MudStack Spacing="3">
                            <MudSwitch @bind-Value="_sendPaymentReminders" Label="Send Payment Due Reminders" Color="Color.Primary" />
                            <MudNumericField @bind-Value="_reminderDaysBefore" Label="Days Before Due Date" Variant="Variant.Outlined" Disabled="@(!_sendPaymentReminders)" />
                            <MudSwitch @bind-Value="_sendOverdueNotice" Label="Send Overdue Notices" Color="Color.Warning" />
                            <MudNumericField @bind-Value="_overdueNoticeDays" Label="Days After Due Date" Variant="Variant.Outlined" Disabled="@(!_sendOverdueNotice)" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
    </MudTabs>

    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveSettings" Disabled="@_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save Settings
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private string _billPrefix = "VB-";
    private int _billStartNo = 1001;
    private int _defaultPaymentTerms = 30;
    private bool _autoGenerateBillNo = true;

    private string _paymentPrefix = "VP-";
    private int _paymentStartNo = 1001;
    private bool _autoAllocatePayments = false;

    private bool _requireBillApproval = false;
    private bool _requirePaymentApproval = false;
    private decimal _paymentApprovalThreshold = 10000;

    private bool _sendPaymentReminders = false;
    private int _reminderDaysBefore = 3;
    private bool _sendOverdueNotice = false;
    private int _overdueNoticeDays = 7;

    private bool _isSaving = false;

    private async Task SaveSettings()
    {
        _isSaving = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100);
            Snackbar.Add("AP Settings saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}

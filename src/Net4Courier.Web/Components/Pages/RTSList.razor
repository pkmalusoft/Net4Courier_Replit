@page "/rts-list"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using ClosedXML.Excel

<PageTitle>Return to Shipper (RTS) - Net4Courier</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Return to Shipper (RTS)</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateRTSDialog">
        Create RTS
    </MudButton>
</MudStack>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudTextField @bind-Value="_searchString" Placeholder="Search AWB, consignor, consignee..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" Style="width:280px" />
        <MudDatePicker @bind-Date="_fromDate" Label="From Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" Style="width:150px" />
        <MudDatePicker @bind-Date="_toDate" Label="To Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" Style="width:150px" />
        <MudSelect T="RTSChargeMode?" @bind-Value="_chargeModeFilter" Label="Charge Mode" Variant="Variant.Outlined" Style="width:150px" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem T="RTSChargeMode?" Value="@((RTSChargeMode?)null)">All</MudSelectItem>
            <MudSelectItem T="RTSChargeMode?" Value="@RTSChargeMode.Free">Free</MudSelectItem>
            <MudSelectItem T="RTSChargeMode?" Value="@RTSChargeMode.Chargeable">Chargeable</MudSelectItem>
        </MudSelect>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Search" StartIcon="@Icons.Material.Filled.Search">Search</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearFilters">Clear</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.FileDownload" 
                   OnClick="DownloadExcel" Disabled="@(!_rtsShipments.Any())">Excel</MudButton>
    </MudStack>
</MudPaper>

<MudPaper Elevation="2">
    <MudTable Items="@_rtsShipments" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary">
        <HeaderContent>
            <MudTh>RTS AWB</MudTh>
            <MudTh>Original AWB</MudTh>
            <MudTh>RTS Date</MudTh>
            <MudTh>Shipper (Original Receiver)</MudTh>
            <MudTh>Receiver (Original Shipper)</MudTh>
            <MudTh>Weight</MudTh>
            <MudTh>Charge Mode</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh Style="width: 150px;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="RTS AWB">
                <MudLink Href="@($"/awb-entry/{context.Id}")">@context.AWBNo</MudLink>
                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Class="ml-1">RTS</MudChip>
            </MudTd>
            <MudTd DataLabel="Original AWB">
                @if(context.OriginalShipment != null)
                {
                    <MudLink Href="@($"/awb-entry/{context.OriginalShipmentId}")">@context.OriginalShipment.AWBNo</MudLink>
                }
            </MudTd>
            <MudTd DataLabel="RTS Date">@context.RTSCreatedAt?.ToString("dd/MM/yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Shipper">@context.Consignor</MudTd>
            <MudTd DataLabel="Receiver">@context.Consignee</MudTd>
            <MudTd DataLabel="Weight">@context.ChargeableWeight?.ToString("N2") kg</MudTd>
            <MudTd DataLabel="Charge Mode">
                @if(context.RTSChargeMode == RTSChargeMode.Free)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Free</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Info" Size="Size.Small">Chargeable</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.CourierStatusId)" Size="Size.Small">@context.CourierStatusId</MudChip>
            </MudTd>
            <MudTd DataLabel="Amount">@(context.RTSChargeMode == RTSChargeMode.Free ? "-" : context.NetTotal?.ToString("N2"))</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Secondary" Href="@($"/shipment/{context.Id}")" Title="View Dashboard" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" Href="@($"/awb-entry/{context.Id}")" Title="Edit" />
                <MudIconButton Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default" Title="Print RTS Slip" OnClick="@(() => PrintRTSSlip(context.Id))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No RTS shipments found.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<InscanMaster> _rtsShipments = new();
    private bool _loading = true;
    private string _searchString = "";
    private DateTime? _fromDate = DateTime.Today.AddDays(-30);
    private DateTime? _toDate = DateTime.Today;
    private RTSChargeMode? _chargeModeFilter;

    protected override async Task OnInitializedAsync()
    {
        await Search();
    }

    private async Task ClearFilters()
    {
        _searchString = "";
        _fromDate = DateTime.Today.AddDays(-30);
        _toDate = DateTime.Today;
        _chargeModeFilter = null;
        await Search();
    }

    private async Task Search()
    {
        _loading = true;
        await using var context = await DbFactory.CreateDbContextAsync();
        
        var query = context.InscanMasters
            .Include(i => i.OriginalShipment)
            .Where(i => !i.IsDeleted && i.IsRTS)
            .AsQueryable();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            query = query.Where(i => i.AWBNo.Contains(_searchString) || 
                                     (i.Consignor != null && i.Consignor.Contains(_searchString)) ||
                                     (i.Consignee != null && i.Consignee.Contains(_searchString)) ||
                                     (i.OriginalShipment != null && i.OriginalShipment.AWBNo.Contains(_searchString)));
        }

        if (_fromDate.HasValue)
        {
            var from = DateTime.SpecifyKind(_fromDate.Value, DateTimeKind.Utc);
            query = query.Where(i => i.RTSCreatedAt >= from);
        }

        if (_toDate.HasValue)
        {
            var to = DateTime.SpecifyKind(_toDate.Value.AddDays(1), DateTimeKind.Utc);
            query = query.Where(i => i.RTSCreatedAt < to);
        }

        if (_chargeModeFilter.HasValue)
        {
            query = query.Where(i => i.RTSChargeMode == _chargeModeFilter.Value);
        }

        _rtsShipments = await query
            .OrderByDescending(i => i.RTSCreatedAt)
            .Take(500)
            .ToListAsync();
        
        _loading = false;
    }

    private Color GetStatusColor(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => Color.Default,
            CourierStatus.InTransit => Color.Info,
            CourierStatus.OutForDelivery => Color.Warning,
            CourierStatus.Delivered => Color.Success,
            CourierStatus.Returned => Color.Secondary,
            CourierStatus.Cancelled => Color.Error,
            _ => Color.Default
        };
    }

    private async Task OpenCreateRTSDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = await DialogService.ShowAsync<RTSEntryDialog>("Create RTS from Original Shipment", options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await Search();
            Snackbar.Add("RTS created successfully", Severity.Success);
        }
    }

    private async Task PrintRTSSlip(long rtsId)
    {
        Snackbar.Add("RTS Slip printing - Feature coming soon", Severity.Info);
    }

    private async Task DownloadExcel()
    {
        if (!_rtsShipments.Any()) return;

        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("RTS Shipments");

        worksheet.Cell(1, 1).Value = "Return to Shipper (RTS) List";
        worksheet.Cell(1, 1).Style.Font.Bold = true;
        worksheet.Cell(1, 1).Style.Font.FontSize = 14;
        worksheet.Range(1, 1, 1, 9).Merge();

        var headers = new[] { "AWB", "Original AWB", "Date", "Shipper", "Receiver", "Weight", "Charge Mode", "Status", "Amount" };
        for (int i = 0; i < headers.Length; i++)
        {
            worksheet.Cell(3, i + 1).Value = headers[i];
            worksheet.Cell(3, i + 1).Style.Font.Bold = true;
            worksheet.Cell(3, i + 1).Style.Fill.BackgroundColor = XLColor.LightGray;
        }

        int row = 4;
        foreach (var rts in _rtsShipments)
        {
            worksheet.Cell(row, 1).Value = rts.AWBNo;
            worksheet.Cell(row, 2).Value = rts.OriginalShipment?.AWBNo ?? "";
            worksheet.Cell(row, 3).Value = rts.RTSCreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "";
            worksheet.Cell(row, 4).Value = rts.Consignor ?? "";
            worksheet.Cell(row, 5).Value = rts.Consignee ?? "";
            worksheet.Cell(row, 6).Value = rts.ChargeableWeight ?? 0;
            worksheet.Cell(row, 7).Value = rts.RTSChargeMode.ToString();
            worksheet.Cell(row, 8).Value = rts.CourierStatusId.ToString();
            worksheet.Cell(row, 9).Value = rts.RTSChargeMode == RTSChargeMode.Free ? 0 : (rts.NetTotal ?? 0);
            row++;
        }

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        var fileName = $"RTS_List_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));
    }
}

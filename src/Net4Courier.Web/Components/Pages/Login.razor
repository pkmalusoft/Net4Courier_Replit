@page "/login"
@layout Net4Courier.Web.Components.Layout.EmptyLayout
@using Net4Courier.Infrastructure.Services
@using Net4Courier.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh;">
    <MudPaper Elevation="4" Class="pa-8" Style="width: 100%;">
        <MudStack Spacing="4">
            <MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Primary">
                Net4Courier
            </MudText>
            <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Default">
                Sign in to your account
            </MudText>
            
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
            }

            <MudTextField @bind-Value="_username" 
                          Label="Username" 
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Person"
                          Required="true"
                          Immediate="true"
                          OnKeyDown="HandleKeyDown" />

            <MudTextField @bind-Value="_password" 
                          Label="Password" 
                          Variant="Variant.Outlined"
                          InputType="@_passwordInputType"
                          Adornment="Adornment.End"
                          AdornmentIcon="@_passwordIcon"
                          OnAdornmentClick="TogglePasswordVisibility"
                          Required="true"
                          Immediate="true"
                          OnKeyDown="HandleKeyDown" />

            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true"
                       Size="Size.Large"
                       Disabled="@_isLoading"
                       OnClick="HandleLogin">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign In</span>
                }
            </MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private string _username = "";
    private string _password = "";
    private string _errorMessage = "";
    private bool _isLoading = false;
    private bool _showPassword = false;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
        _passwordIcon = _showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await HandleLogin();
    }

    private async Task HandleLogin()
    {
        _errorMessage = "";
        Console.WriteLine($"[LOGIN] HandleLogin started - Username: '{_username}', Password length: {_password?.Length ?? 0}");

        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
        {
            _errorMessage = "Please enter username and password";
            Console.WriteLine("[LOGIN] Validation failed - empty username or password");
            return;
        }

        _isLoading = true;
        StateHasChanged();
        Console.WriteLine("[LOGIN] Calling AuthService.ValidateUserAsync...");

        try
        {
            var user = await AuthService.ValidateUserAsync(_username, _password);
            Console.WriteLine($"[LOGIN] ValidateUserAsync returned: {(user != null ? $"User ID={user.Id}, Username={user.Username}" : "null")}");

            if (user == null)
            {
                _errorMessage = "Invalid username or password";
                _isLoading = false;
                Console.WriteLine("[LOGIN] User validation failed - user is null");
                return;
            }

            Console.WriteLine($"[LOGIN] User validated successfully. Role: {user.Role?.Name ?? "No Role"}, IsActive: {user.IsActive}");
            Console.WriteLine($"[LOGIN] PasswordHash starts with: {user.PasswordHash?.Substring(0, Math.Min(10, user.PasswordHash?.Length ?? 0))}...");
            
            var authProvider = (AppAuthStateProvider)AuthStateProvider;
            Console.WriteLine("[LOGIN] Calling authProvider.Login()...");
            authProvider.Login(user);
            Console.WriteLine("[LOGIN] Login called. Navigating to /...");

            Navigation.NavigateTo("/");
            Console.WriteLine("[LOGIN] NavigateTo('/') called");
        }
        catch (Exception ex)
        {
            _errorMessage = "Login failed. Please try again.";
            Console.WriteLine($"[LOGIN] EXCEPTION: {ex.GetType().Name}: {ex.Message}");
            Console.WriteLine($"[LOGIN] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            _isLoading = false;
            Console.WriteLine("[LOGIN] HandleLogin completed");
        }
    }
}

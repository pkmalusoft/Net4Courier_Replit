@page "/awb-list"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject Net4Courier.Web.Services.AppAuthStateProvider AppAuthState
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using ClosedXML.Excel

<PageTitle>Shipments - Net4Courier</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Shipments</MudText>
    <MudStack Row="true" Spacing="2">
        @if (_selectedShipments.Any())
        {
            <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Print" 
                       OnClick="BulkPrintAWBs">
                Print @_selectedShipments.Count AWBs
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Label" 
                       OnClick="BulkPrintLabels">
                Print @_selectedShipments.Count Labels
            </MudButton>
        }
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="DownloadExcel" StartIcon="@Icons.Material.Filled.Download" Disabled="@(_shipments.Count == 0)">Download Excel</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Large" StartIcon="@Icons.Material.Filled.Transform" Href="/awb-entry?convertPickup=true">
            Convert from Pickup
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" StartIcon="@Icons.Material.Filled.Add" Href="/awb-entry">
            Create New Shipment
        </MudButton>
    </MudStack>
</MudStack>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="2">
            <MudTextField @bind-Value="_searchString" Placeholder="Search AWB, consignor, consignee..." Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_fromDate" Label="From Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_toDate" Label="To Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="ShipmentTypeFilter" @bind-Value="_typeFilter" Label="Type" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="ShipmentTypeFilter" Value="ShipmentTypeFilter.All">All Types</MudSelectItem>
                <MudSelectItem T="ShipmentTypeFilter" Value="ShipmentTypeFilter.Domestic">Domestic/Export</MudSelectItem>
                <MudSelectItem T="ShipmentTypeFilter" Value="ShipmentTypeFilter.Import">Import</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="CourierStatus?" @bind-Value="_statusFilter" Label="Status" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="CourierStatus?" Value="@((CourierStatus?)null)">All Status</MudSelectItem>
                <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Pending">Pending</MudSelectItem>
                <MudSelectItem T="CourierStatus?" Value="@CourierStatus.InTransit">In Transit</MudSelectItem>
                <MudSelectItem T="CourierStatus?" Value="@CourierStatus.OutForDelivery">Out for Delivery</MudSelectItem>
                <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Delivered">Delivered</MudSelectItem>
                <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Returned">Returned</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mt-2">
                <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Filled" Color="Color.Primary" OnClick="Search" Title="Search" />
                <MudIconButton Icon="@Icons.Material.Filled.FilterAltOff" Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearFilters" Title="Clear Filters" />
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Elevation="2">
    <MudTable Items="@_shipments" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary" MultiSelection="true" @bind-SelectedItems="_selectedShipments">
        <HeaderContent>
            <MudTh Style="width: 120px;">Actions</MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<ShipmentListItem, object>(x => x.AWBNo)">AWB No</MudTableSortLabel></MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Consignor</MudTh>
            <MudTh>Consignee</MudTh>
            <MudTh>Destination</MudTh>
            <MudTh>Weight</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Amount</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                @if (context.IsImport)
                {
                    <div class="d-flex flex-wrap" style="max-width: 120px;">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Secondary" Href="@($"/import-shipment/{(context.ImportShipmentId ?? context.Id)}")" Title="View Details" />
                        @if (IsEditableStatus(context.Status))
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" Href="@($"/awb-entry/{context.Id}")" Title="Edit" />
                        }
                        <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Info" Href="@($"/tracking/{context.AWBNo}")" Title="Track" />
                        <MudMenu Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default" Title="Print Options" Dense="true">
                            <MudMenuItem OnClick="@(() => PrintAWBByNo(context.AWBNo))">Print AWB (A5)</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintAWBDuplexByNo(context.AWBNo))">Print 2-in-1 (A4)</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintLabelByNo(context.AWBNo))">Print Label</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintTrackingDetails(context.AWBNo))">Tracking Details</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintDutyReceiptByNo(context.AWBNo))">Duty Receipt</MudMenuItem>
                        </MudMenu>
                    </div>
                }
                else
                {
                    <div class="d-flex flex-wrap" style="max-width: 120px;">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Secondary" Href="@($"/shipment/{context.Id}")" Title="View Dashboard" />
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" Href="@($"/awb-entry/{context.Id}")" Title="Edit" />
                        <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Info" Href="@($"/tracking/{context.AWBNo}")" Title="Track" />
                        <MudIconButton Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Warning" OnClick="@(() => OpenStatusDialogById(context.Id))" Title="Update Status" />
                        <MudMenu Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default" Title="Print Options" Dense="true">
                            <MudMenuItem OnClick="@(() => PrintAWB(context.Id))">Print AWB (A5)</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintAWBDuplex(context.Id))">Print 2-in-1 (A4)</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintLabel(context.Id))">Print Label</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintTrackingDetails(context.AWBNo))">Tracking Details</MudMenuItem>
                            <MudMenuItem OnClick="@(() => PrintDutyReceipt(context.Id))">Duty Receipt</MudMenuItem>
                        </MudMenu>
                        @if (IsDeletableStatus(context.Status))
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteAWBById(context.Id))" Title="Delete" />
                        }
                    </div>
                }
            </MudTd>
            <MudTd DataLabel="AWB No">
                <div>
                    @if (context.IsImport)
                    {
                        <MudLink Href="@($"/awb-entry/{context.Id}")">@context.AWBNo</MudLink>
                    }
                    else
                    {
                        <MudLink Href="@($"/awb-entry/{context.Id}")">@context.AWBNo</MudLink>
                    }
                </div>
                <div>
                    <MudChip T="string" Color="@GetMovementTypeColor(context.MovementTypeId)" Size="Size.Small">@GetMovementTypeLabel(context.MovementTypeId)</MudChip>
                </div>
                @if (context.PickupRequestId.HasValue && _pickupNoLookup.TryGetValue(context.PickupRequestId.Value, out var pickupNo))
                {
                    <div>
                        <MudText Typo="Typo.caption" Style="color: red;">@pickupNo</MudText>
                    </div>
                }
            </MudTd>
            <MudTd DataLabel="Date">@context.TransactionDate.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Consignor">@context.Consignor</MudTd>
            <MudTd DataLabel="Consignee">@context.Consignee</MudTd>
            <MudTd DataLabel="Destination">@context.Destination</MudTd>
            <MudTd DataLabel="Weight">@context.Weight?.ToString("N2") kg</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColorFromString(context.Status)" Size="Size.Small">@context.Status</MudChip>
            </MudTd>
            <MudTd DataLabel="Amount">@_currencyDisplay @context.Amount?.ToString("N2")</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No shipments found.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<ShipmentListItem> _shipments = new();
    private HashSet<ShipmentListItem> _selectedShipments = new();
    private Dictionary<long, string> _pickupNoLookup = new();
    private bool _loading = true;
    private string _searchString = "";
    private string _currencyDisplay = "";
    private DateTime? _fromDate = DateTime.Today;
    private DateTime? _toDate = DateTime.Today;
    private CourierStatus? _statusFilter;
    private ShipmentTypeFilter _typeFilter = ShipmentTypeFilter.All;

    private record ShipmentListItem(
        long Id,
        string AWBNo,
        DateTime TransactionDate,
        string? Consignor,
        string? Consignee,
        string? Destination,
        decimal? Weight,
        string Status,
        decimal? Amount,
        MovementType MovementTypeId,
        long? PickupRequestId,
        long? ImportMasterId,
        long? ImportShipmentId
    )
    {
        public bool IsImport => MovementTypeId == MovementType.InternationalImport;
    };
    
    private enum ShipmentTypeFilter { All, Domestic, Import }

    protected override async Task OnInitializedAsync()
    {
        var code = AppAuthState.CurrencyCode;
        var symbol = AppAuthState.CurrencySymbol;
        _currencyDisplay = !string.IsNullOrWhiteSpace(code) ? code : (!string.IsNullOrWhiteSpace(symbol) ? symbol : "");
        await Search();
    }

    private async Task ClearFilters()
    {
        _searchString = "";
        _fromDate = DateTime.Today;
        _toDate = DateTime.Today;
        _statusFilter = null;
        _typeFilter = ShipmentTypeFilter.All;
        await Search();
    }

    private async Task Search()
    {
        _loading = true;
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var results = new List<ShipmentListItem>();
        
        var from = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value, DateTimeKind.Utc) : (DateTime?)null;
        var to = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.AddDays(1), DateTimeKind.Utc) : (DateTime?)null;
        
        if (_typeFilter != ShipmentTypeFilter.Import)
        {
            var inscanQuery = dbContext.InscanMasters.Where(i => !i.IsDeleted).AsQueryable();

            if (!string.IsNullOrWhiteSpace(_searchString))
            {
                inscanQuery = inscanQuery.Where(i => i.AWBNo.Contains(_searchString) || 
                                         (i.Consignor != null && i.Consignor.Contains(_searchString)) ||
                                         (i.Consignee != null && i.Consignee.Contains(_searchString)));
            }

            if (from.HasValue)
                inscanQuery = inscanQuery.Where(i => i.TransactionDate >= from.Value);

            if (to.HasValue)
                inscanQuery = inscanQuery.Where(i => i.TransactionDate < to.Value);

            if (_statusFilter.HasValue)
                inscanQuery = inscanQuery.Where(i => i.CourierStatusId == _statusFilter.Value);

            var inscanResults = await inscanQuery
                .OrderByDescending(i => i.TransactionDate)
                .ThenByDescending(i => i.Id)
                .Take(500)
                .Select(i => new ShipmentListItem(
                    i.Id,
                    i.AWBNo,
                    i.TransactionDate,
                    i.Consignor,
                    i.Consignee,
                    i.ConsigneeCity,
                    i.ChargeableWeight,
                    i.CourierStatusId.ToString(),
                    i.NetTotal,
                    i.MovementTypeId,
                    i.PickupRequestId,
                    (long?)null,
                    (long?)null
                ))
                .ToListAsync();

            var importInscanAwbs = inscanResults
                .Where(r => r.MovementTypeId == MovementType.InternationalImport)
                .ToList();
            if (importInscanAwbs.Any())
            {
                var inscanIds = importInscanAwbs.Select(r => r.Id).ToList();
                var awbNos = importInscanAwbs.Select(r => r.AWBNo).ToList();
                var importLookup = await dbContext.ImportShipments
                    .Where(s => (s.LinkedInscanMasterId.HasValue && inscanIds.Contains(s.LinkedInscanMasterId.Value))
                             || awbNos.Contains(s.AWBNo))
                    .Select(s => new { s.AWBNo, s.LinkedInscanMasterId, s.ImportMasterId, ShipmentId = s.Id, Weight = s.ChargeableWeight ?? s.Weight, Amount = s.TotalCustomsCharges })
                    .ToListAsync();
                var lookupByInscanId = importLookup.Where(x => x.LinkedInscanMasterId.HasValue)
                    .GroupBy(x => x.LinkedInscanMasterId!.Value)
                    .ToDictionary(g => g.Key, g => g.First());
                var lookupByAwb = importLookup
                    .GroupBy(x => x.AWBNo)
                    .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);
                inscanResults = inscanResults.Select(r =>
                {
                    if (r.MovementTypeId != MovementType.InternationalImport) return r;
                    var imp = lookupByInscanId.GetValueOrDefault(r.Id) ?? lookupByAwb.GetValueOrDefault(r.AWBNo);
                    if (imp == null) return r;
                    return r with { ImportMasterId = imp.ImportMasterId, ImportShipmentId = imp.ShipmentId, Weight = r.Weight ?? imp.Weight, Amount = r.Amount ?? imp.Amount };
                }).ToList();
            }

            results.AddRange(inscanResults);
        }
        
        if (_typeFilter != ShipmentTypeFilter.Domestic && !_statusFilter.HasValue)
        {
            var inscanAwbNos = results.Select(r => r.AWBNo.ToUpperInvariant()).ToHashSet(StringComparer.OrdinalIgnoreCase);
            
            var importQuery = dbContext.ImportShipments.Where(i => !i.IsDeleted && !i.LinkedInscanMasterId.HasValue).AsQueryable();

            if (!string.IsNullOrWhiteSpace(_searchString))
            {
                var searchTerm = _searchString;
                importQuery = importQuery.Where(i => i.AWBNo.Contains(searchTerm) || 
                                         (i.ShipperName != null && i.ShipperName.Contains(searchTerm)) ||
                                         i.ConsigneeName.Contains(searchTerm));
            }

            if (from.HasValue)
                importQuery = importQuery.Where(i => i.CreatedAt >= from.Value);

            if (to.HasValue)
                importQuery = importQuery.Where(i => i.CreatedAt < to.Value);

            var importResults = await importQuery
                .OrderByDescending(i => i.CreatedAt)
                .ThenByDescending(i => i.Id)
                .Take(500)
                .Select(i => new ShipmentListItem(
                    i.Id,
                    i.AWBNo,
                    i.CreatedAt,
                    i.ShipperName,
                    i.ConsigneeName,
                    i.ConsigneeCity,
                    i.ChargeableWeight ?? i.Weight,
                    i.Status.ToString(),
                    i.TotalCustomsCharges,
                    MovementType.InternationalImport,
                    (long?)null,
                    i.ImportMasterId,
                    (long?)i.Id
                ))
                .ToListAsync();
            
            foreach (var imp in importResults)
            {
                if (!inscanAwbNos.Contains(imp.AWBNo))
                    results.Add(imp);
            }
        }
        
        _shipments = results.OrderByDescending(s => s.TransactionDate).ThenByDescending(s => s.Id).Take(500).ToList();
        
        var pickupIds = _shipments.Where(s => s.PickupRequestId.HasValue).Select(s => s.PickupRequestId!.Value).Distinct().ToList();
        if (pickupIds.Any())
        {
            _pickupNoLookup = await dbContext.PickupRequests
                .Where(p => pickupIds.Contains(p.Id))
                .ToDictionaryAsync(p => p.Id, p => p.PickupNo);
        }
        else
        {
            _pickupNoLookup.Clear();
        }
        
        _loading = false;
    }

    private bool IsEditableStatus(string status)
    {
        return status is not ("OutForDelivery" or "ReadyForDelivery" or "Delivered" or "NotDelivered" or "ReturnToOrigin" or "Returned" or "Cancelled" or "Closed" or "HandedOver");
    }

    private bool IsDeletableStatus(string status)
    {
        return status is not ("OutForDelivery" or "Delivered" or "ReturnToOrigin" or "Returned" or "Cancelled" or "Closed" or "HandedOver" or "NotDelivered" or "ReadyForDelivery");
    }

    private Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Pending => Color.Default,
        CourierStatus.PickedUp => Color.Info,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Warning,
        CourierStatus.Delivered => Color.Success,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };
    
    private Color GetStatusColorFromString(string status) => status switch
    {
        "Pending" or "Expected" => Color.Default,
        "PickedUp" or "ReceivedAtWarehouse" => Color.Info,
        "InTransit" or "InCustoms" => Color.Primary,
        "OutForDelivery" or "ReadyForDelivery" => Color.Warning,
        "Delivered" => Color.Success,
        "Returned" or "HeldByCustoms" => Color.Error,
        _ => Color.Default
    };

    private async Task OpenStatusDialogById(long id)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var shipment = await dbContext.InscanMasters.FindAsync(id);
        if (shipment == null) return;
        
        var parameters = new DialogParameters<UpdateStatusDialog> { { x => x.Shipment, shipment } };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Status", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            await Search();
        }
    }

    private async Task DeleteAWBById(long id)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var shipment = await dbContext.InscanMasters.FindAsync(id);
        if (shipment == null) return;

        if (shipment.CourierStatusId is CourierStatus.OutForDelivery or CourierStatus.Delivered or CourierStatus.Returned)
        {
            Snackbar.Add("Cannot delete shipment â€” it is already Out for Delivery or beyond", Severity.Warning);
            return;
        }
        
        var confirm = await DialogService.ShowMessageBox("Confirm Delete", $"Are you sure you want to delete AWB {shipment.AWBNo}?", yesText: "Delete", cancelText: "Cancel");
        
        if (confirm == true)
        {
            shipment.IsDeleted = true;
            await dbContext.SaveChangesAsync();
            await Search();
            Snackbar.Add("AWB deleted successfully", Severity.Success);
        }
    }
    
    private async Task DeleteImportShipment(ShipmentListItem item)
    {
        var confirm = await DialogService.ShowMessageBox("Confirm Delete", $"Are you sure you want to delete import shipment {item.AWBNo}?", yesText: "Delete", cancelText: "Cancel");
        
        if (confirm == true)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var shipment = await dbContext.ImportShipments.FindAsync(item.Id);
            if (shipment != null)
            {
                shipment.IsDeleted = true;
                await dbContext.SaveChangesAsync();
                await Search();
                Snackbar.Add("Import shipment deleted successfully", Severity.Success);
            }
        }
    }

    private async Task PrintAWB(long id)
    {
        await OpenPdfPreview($"/api/report/awb/{id}", "AWB Print");
    }

    private async Task PrintAWBDuplex(long id)
    {
        await OpenPdfPreview($"/api/report/awb-duplex/{id}", "AWB 2-in-1 A4");
    }
    
    private async Task PrintLabel(long id)
    {
        await OpenPdfPreview($"/api/report/awb-label/{id}", "AWB Label");
    }

    private async Task PrintAWBByNo(string awbNo)
    {
        await OpenPdfPreview($"/api/report/awb-by-awbno/{awbNo}", "AWB Print");
    }

    private async Task PrintAWBDuplexByNo(string awbNo)
    {
        await OpenPdfPreview($"/api/report/awb-duplex-by-awbno/{awbNo}", "AWB 2-in-1 A4");
    }

    private async Task PrintLabelByNo(string awbNo)
    {
        await OpenPdfPreview($"/api/report/awb-label-by-awbno/{awbNo}", "AWB Label");
    }

    private async Task PrintTrackingDetails(string awbNo)
    {
        await OpenPdfPreview($"/api/report/tracking/{awbNo}", "Tracking Details");
    }

    private async Task PrintDutyReceipt(long id)
    {
        await OpenPdfPreview($"/api/report/duty-receipt/{id}", "Duty Receipt");
    }

    private async Task PrintDutyReceiptByNo(string awbNo)
    {
        await OpenPdfPreview($"/api/report/duty-receipt-by-awbno/{awbNo}", "Duty Receipt");
    }

    private async Task OpenPdfPreview(string url, string title)
    {
        var parameters = new DialogParameters<PdfPreviewDialog>
        {
            { x => x.PdfUrl, url },
            { x => x.Title, title }
        };
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true,
            NoHeader = false
        };
        await DialogService.ShowAsync<PdfPreviewDialog>(title, parameters, options);
    }

    private Color GetMovementTypeColor(MovementType movementType) => movementType switch
    {
        MovementType.Domestic => Color.Success,
        MovementType.InternationalExport => Color.Warning,
        MovementType.InternationalImport => Color.Info,
        MovementType.Transhipment => Color.Secondary,
        _ => Color.Default
    };

    private string GetMovementTypeLabel(MovementType movementType) => movementType switch
    {
        MovementType.Domestic => "Domestic",
        MovementType.InternationalExport => "Export",
        MovementType.InternationalImport => "Import",
        MovementType.Transhipment => "Transhipment",
        _ => "Unknown"
    };

    private async Task BulkPrintAWBs()
    {
        if (!_selectedShipments.Any()) return;
        
        var importAwbs = _selectedShipments.Where(s => s.IsImport).Select(s => s.AWBNo).ToList();
        var domesticIds = _selectedShipments.Where(s => !s.IsImport).Select(s => s.Id).ToList();
        
        if (domesticIds.Any())
        {
            var ids = string.Join(",", domesticIds);
            await OpenPdfPreview($"/api/report/awb-bulk/{ids}", "Bulk AWB Print");
        }
        if (importAwbs.Any())
        {
            var awbNos = string.Join(",", importAwbs);
            await OpenPdfPreview($"/api/report/awb-bulk-by-awbno/{awbNos}", "Bulk Import AWB Print");
        }
    }

    private async Task BulkPrintLabels()
    {
        if (!_selectedShipments.Any()) return;
        
        var importAwbs = _selectedShipments.Where(s => s.IsImport).Select(s => s.AWBNo).ToList();
        var domesticIds = _selectedShipments.Where(s => !s.IsImport).Select(s => s.Id).ToList();
        
        if (domesticIds.Any())
        {
            var ids = string.Join(",", domesticIds);
            await OpenPdfPreview($"/api/report/label-bulk/{ids}", "Bulk Label Print");
        }
        if (importAwbs.Any())
        {
            var awbNos = string.Join(",", importAwbs);
            await OpenPdfPreview($"/api/report/label-bulk-by-awbno/{awbNos}", "Bulk Import Label Print");
        }
    }

    private async Task DownloadExcel()
    {
        if (_shipments.Count == 0)
        {
            Snackbar.Add("No shipments to export", Severity.Warning);
            return;
        }

        try
        {
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Shipments");

            var headers = new[] { "AWB No", "Type", "Date", "Consignor", "Consignee", "Destination", "Weight", "Status", "Amount" };

            for (int i = 0; i < headers.Length; i++)
            {
                worksheet.Cell(1, i + 1).Value = headers[i];
                worksheet.Cell(1, i + 1).Style.Font.Bold = true;
                worksheet.Cell(1, i + 1).Style.Fill.BackgroundColor = XLColor.LightBlue;
            }

            int row = 2;
            foreach (var s in _shipments)
            {
                worksheet.Cell(row, 1).Value = s.AWBNo;
                worksheet.Cell(row, 2).Value = GetMovementTypeLabel(s.MovementTypeId);
                worksheet.Cell(row, 3).Value = s.TransactionDate.ToString("dd/MM/yyyy");
                worksheet.Cell(row, 4).Value = s.Consignor ?? "";
                worksheet.Cell(row, 5).Value = s.Consignee ?? "";
                worksheet.Cell(row, 6).Value = s.Destination ?? "";
                worksheet.Cell(row, 7).Value = s.Weight ?? 0;
                worksheet.Cell(row, 8).Value = s.Status;
                worksheet.Cell(row, 9).Value = s.Amount ?? 0;
                row++;
            }

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            var fileName = $"Shipments_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(content));
            Snackbar.Add($"Downloaded {_shipments.Count} shipments", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting: {ex.Message}", Severity.Error);
        }
    }
    
}

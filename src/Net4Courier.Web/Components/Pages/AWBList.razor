@page "/awb-list"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using ClosedXML.Excel

<PageTitle>Shipments - Net4Courier</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Shipments</MudText>
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Large" StartIcon="@Icons.Material.Filled.Transform" Href="/awb-entry?convertPickup=true">
            Convert from Pickup
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" StartIcon="@Icons.Material.Filled.Add" Href="/awb-entry">
            Create New Shipment
        </MudButton>
    </MudStack>
</MudStack>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudTextField @bind-Value="_searchString" Placeholder="Search AWB, consignor, consignee..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" Style="width:280px" />
        <MudDatePicker @bind-Date="_fromDate" Label="From Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" Style="width:150px" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        <MudDatePicker @bind-Date="_toDate" Label="To Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" Style="width:150px" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        <MudSelect T="CourierStatus?" @bind-Value="_statusFilter" Label="Status" Variant="Variant.Outlined" Style="width:150px" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem T="CourierStatus?" Value="@((CourierStatus?)null)">All Status</MudSelectItem>
            <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Pending">Pending</MudSelectItem>
            <MudSelectItem T="CourierStatus?" Value="@CourierStatus.InTransit">In Transit</MudSelectItem>
            <MudSelectItem T="CourierStatus?" Value="@CourierStatus.OutForDelivery">Out for Delivery</MudSelectItem>
            <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Delivered">Delivered</MudSelectItem>
            <MudSelectItem T="CourierStatus?" Value="@CourierStatus.Returned">Returned</MudSelectItem>
        </MudSelect>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Search" StartIcon="@Icons.Material.Filled.Search">Search</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="ClearFilters">Clear</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="DownloadExcel" StartIcon="@Icons.Material.Filled.Download" Disabled="@(_shipments.Count == 0)">Download Excel</MudButton>
    </MudStack>
</MudPaper>

<MudPaper Elevation="2">
    <MudTable Items="@_shipments" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary">
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<InscanMaster, object>(x => x.AWBNo)">AWB No</MudTableSortLabel></MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Consignor</MudTh>
            <MudTh>Consignee</MudTh>
            <MudTh>Destination</MudTh>
            <MudTh>Weight</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh Style="width: 180px;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="AWB No">
                <div>
                    <MudLink Href="@($"/awb-entry/{context.Id}")">@context.AWBNo</MudLink>
                </div>
                @if (context.PickupRequestId.HasValue && _pickupNoLookup.TryGetValue(context.PickupRequestId.Value, out var pickupNo))
                {
                    <div>
                        <MudText Typo="Typo.caption" Style="color: red;">@pickupNo</MudText>
                    </div>
                }
            </MudTd>
            <MudTd DataLabel="Date">@context.TransactionDate.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Consignor">@context.Consignor</MudTd>
            <MudTd DataLabel="Consignee">@context.Consignee</MudTd>
            <MudTd DataLabel="Destination">@context.ConsigneeCity</MudTd>
            <MudTd DataLabel="Weight">@context.ChargeableWeight?.ToString("N2") kg</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.CourierStatusId)" Size="Size.Small">@context.CourierStatusId</MudChip>
            </MudTd>
            <MudTd DataLabel="Amount">@context.NetTotal?.ToString("N2")</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Secondary" Href="@($"/shipment/{context.Id}")" Title="View Dashboard" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" Href="@($"/awb-entry/{context.Id}")" Title="Edit" />
                <MudIconButton Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Info" Href="@($"/tracking/{context.AWBNo}")" Title="Track" />
                <MudIconButton Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Warning" OnClick="@(() => OpenStatusDialog(context))" Title="Update Status" />
                <MudIconButton Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Color="Color.Tertiary" OnClick="@(() => OpenDocumentsDialog(context))" Title="Documents" />
                <MudMenu Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default" Title="Print Options" Dense="true">
                    <MudMenuItem OnClick="@(() => PrintAWB(context.Id))">Print AWB (A5)</MudMenuItem>
                    <MudMenuItem OnClick="@(() => PrintLabel(context.Id))">Print Label</MudMenuItem>
                </MudMenu>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteAWB(context))" Title="Delete" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No shipments found.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<InscanMaster> _shipments = new();
    private Dictionary<long, string> _pickupNoLookup = new();
    private bool _loading = true;
    private string _searchString = "";
    private DateTime? _fromDate = DateTime.Today;
    private DateTime? _toDate = DateTime.Today;
    private CourierStatus? _statusFilter;

    protected override async Task OnInitializedAsync()
    {
        await Search();
    }

    private async Task ClearFilters()
    {
        _searchString = "";
        _fromDate = DateTime.Today;
        _toDate = DateTime.Today;
        _statusFilter = null;
        await Search();
    }

    private async Task Search()
    {
        _loading = true;
        var query = DbContext.InscanMasters.Where(i => !i.IsDeleted).AsQueryable();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            query = query.Where(i => i.AWBNo.Contains(_searchString) || 
                                     (i.Consignor != null && i.Consignor.Contains(_searchString)) ||
                                     (i.Consignee != null && i.Consignee.Contains(_searchString)));
        }

        if (_fromDate.HasValue)
        {
            var from = DateTime.SpecifyKind(_fromDate.Value, DateTimeKind.Utc);
            query = query.Where(i => i.TransactionDate >= from);
        }

        if (_toDate.HasValue)
        {
            var to = DateTime.SpecifyKind(_toDate.Value.AddDays(1), DateTimeKind.Utc);
            query = query.Where(i => i.TransactionDate < to);
        }

        if (_statusFilter.HasValue)
        {
            query = query.Where(i => i.CourierStatusId == _statusFilter.Value);
        }

        _shipments = await query.OrderByDescending(i => i.TransactionDate).ThenByDescending(i => i.Id).Take(500).ToListAsync();
        
        var pickupIds = _shipments.Where(s => s.PickupRequestId.HasValue).Select(s => s.PickupRequestId!.Value).Distinct().ToList();
        if (pickupIds.Any())
        {
            _pickupNoLookup = await DbContext.PickupRequests
                .Where(p => pickupIds.Contains(p.Id))
                .ToDictionaryAsync(p => p.Id, p => p.PickupNo);
        }
        else
        {
            _pickupNoLookup.Clear();
        }
        
        _loading = false;
    }

    private Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Pending => Color.Default,
        CourierStatus.PickedUp => Color.Info,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Warning,
        CourierStatus.Delivered => Color.Success,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private async Task OpenStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog> { { x => x.Shipment, shipment } };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Status", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            await Search();
        }
    }

    private async Task DeleteAWB(InscanMaster shipment)
    {
        var confirm = await DialogService.ShowMessageBox("Confirm Delete", $"Are you sure you want to delete AWB {shipment.AWBNo}?", yesText: "Delete", cancelText: "Cancel");
        
        if (confirm == true)
        {
            shipment.IsDeleted = true;
            await DbContext.SaveChangesAsync();
            await Search();
            Snackbar.Add("AWB deleted successfully", Severity.Success);
        }
    }

    private async Task PrintAWB(long id)
    {
        await JS.InvokeVoidAsync("open", $"/api/report/awb/{id}", "_blank");
    }
    
    private async Task PrintLabel(long id)
    {
        await JS.InvokeVoidAsync("open", $"/api/report/awb-label/{id}", "_blank");
    }

    private async Task DownloadExcel()
    {
        if (_shipments.Count == 0)
        {
            Snackbar.Add("No shipments to export", Severity.Warning);
            return;
        }

        try
        {
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Shipments");

            var headers = new[] { "AWB No", "Date", "Consignor", "Consignor Address", "Consignor City", "Consignor Country",
                "Consignee", "Consignee Address", "Consignee City", "Consignee Country", "Pieces", "Weight", 
                "Chargeable Weight", "Cargo Description", "Status", "Payment Mode", "Courier Charge", "Discount", "Net Total" };

            for (int i = 0; i < headers.Length; i++)
            {
                worksheet.Cell(1, i + 1).Value = headers[i];
                worksheet.Cell(1, i + 1).Style.Font.Bold = true;
                worksheet.Cell(1, i + 1).Style.Fill.BackgroundColor = XLColor.LightBlue;
            }

            int row = 2;
            foreach (var s in _shipments)
            {
                worksheet.Cell(row, 1).Value = s.AWBNo;
                worksheet.Cell(row, 2).Value = s.TransactionDate.ToString("dd/MM/yyyy");
                worksheet.Cell(row, 3).Value = s.Consignor ?? "";
                worksheet.Cell(row, 4).Value = s.ConsignorAddress1 ?? "";
                worksheet.Cell(row, 5).Value = s.ConsignorCity ?? "";
                worksheet.Cell(row, 6).Value = s.ConsignorCountry ?? "";
                worksheet.Cell(row, 7).Value = s.Consignee ?? "";
                worksheet.Cell(row, 8).Value = s.ConsigneeAddress1 ?? "";
                worksheet.Cell(row, 9).Value = s.ConsigneeCity ?? "";
                worksheet.Cell(row, 10).Value = s.ConsigneeCountry ?? "";
                worksheet.Cell(row, 11).Value = s.Pieces ?? 0;
                worksheet.Cell(row, 12).Value = s.Weight ?? 0;
                worksheet.Cell(row, 13).Value = s.ChargeableWeight ?? 0;
                worksheet.Cell(row, 14).Value = s.CargoDescription ?? "";
                worksheet.Cell(row, 15).Value = s.CourierStatusId.ToString();
                worksheet.Cell(row, 16).Value = s.PaymentModeId.ToString();
                worksheet.Cell(row, 17).Value = s.CourierCharge ?? 0;
                worksheet.Cell(row, 18).Value = s.Discount ?? 0;
                worksheet.Cell(row, 19).Value = s.NetTotal ?? 0;
                row++;
            }

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            var fileName = $"Shipments_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(content));
            Snackbar.Add($"Downloaded {_shipments.Count} shipments", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task OpenDocumentsDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<ManageDocumentsDialog>
        {
            { x => x.ShipmentId, shipment.Id },
            { x => x.ShipmentAWB, shipment.AWBNo }
        };
        
        await DialogService.ShowAsync<ManageDocumentsDialog>($"Documents - {shipment.AWBNo}", 
            parameters, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true, CloseOnEscapeKey = true });
    }
}

@page "/courier-pickups"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using static Net4Courier.Masters.Entities.Party

<PageTitle>Courier Pickups - Net4Courier</PageTitle>

<MudText Typo="Typo.h5" GutterBottom="true">Courier Pickups</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="4">
            <MudSelect T="long?" Value="_selectedCourierId" ValueChanged="OnCourierChanged" 
                       Label="Courier" Variant="Variant.Outlined" Clearable="true" Dense="true">
                <MudSelectItem T="long?" Value="@((long?)null)">All Couriers</MudSelectItem>
                @foreach (var courier in _couriers)
                {
                    <MudSelectItem T="long?" Value="@((long?)courier.Id)">@courier.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="string" @bind-Value="_selectedPeriod" Label="Period" Variant="Variant.Outlined" Dense="true">
                <MudSelectItem T="string" Value="@("Today")">Today</MudSelectItem>
                <MudSelectItem T="string" Value="@("Week")">This Week</MudSelectItem>
                <MudSelectItem T="string" Value="@("Month")">This Month</MudSelectItem>
                <MudSelectItem T="string" Value="@("Year")">This Year</MudSelectItem>
                <MudSelectItem T="string" Value="@("Custom")">Custom Range</MudSelectItem>
            </MudSelect>
        </MudItem>
        @if (_selectedPeriod == "Custom")
        {
            <MudItem xs="6" sm="3" md="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="6" sm="3" md="2">
                <MudDatePicker @bind-Date="_toDate" Label="To" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
        }
        <MudItem xs="12" sm="6" md="@(_selectedPeriod == "Custom" ? 1 : 5)">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" 
                       StartIcon="@Icons.Material.Filled.Search" FullWidth="true">
                Search
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
    <MudTabPanel Text="Assigned" BadgeData="@_assignedPickups.Count" BadgeColor="Color.Primary">
        @if (_assignedPickups.Any())
        {
            <MudStack Spacing="3">
                @foreach (var pickup in _assignedPickups)
                {
                    <MudCard Outlined="true">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h6">@pickup.PickupNo</MudText>
                                    <MudText Typo="Typo.body1"><strong>@pickup.CustomerName</strong></MudText>
                                    <MudText Typo="Typo.body2">@pickup.ContactPerson</MudText>
                                </MudStack>
                                <MudStack Spacing="0" AlignItems="AlignItems.End">
                                    <MudChip T="string" Color="Color.Info" Size="Size.Small">Assigned</MudChip>
                                    @if (!string.IsNullOrEmpty(pickup.CourierName))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@pickup.CourierName</MudText>
                                    }
                                </MudStack>
                            </MudStack>
                            
                            <MudDivider Class="my-2" />
                            
                            <MudStack Spacing="1">
                                <MudStack Row="true" AlignItems="AlignItems.Start">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2">@pickup.PickupAddress</MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="ml-6">@pickup.City, @pickup.PostalCode</MudText>
                                @if (!string.IsNullOrEmpty(pickup.Landmark))
                                {
                                    <MudText Typo="Typo.caption" Class="ml-6" Color="Color.Secondary">Near: @pickup.Landmark</MudText>
                                }
                            </MudStack>

                            <MudDivider Class="my-2" />
                            
                            <MudStack Row="true" Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                    <MudLink Href="@($"tel:{pickup.Mobile ?? pickup.Phone}")" Typo="Typo.body2">
                                        @(pickup.Mobile ?? pickup.Phone)
                                    </MudLink>
                                </MudStack>
                                @if (pickup.EstimatedPieces.HasValue)
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                        @pickup.EstimatedPieces pcs @(pickup.EstimatedWeight.HasValue ? $"/ {pickup.EstimatedWeight:N1} kg" : "")
                                    </MudChip>
                                }
                            </MudStack>

                            @if (!string.IsNullOrEmpty(pickup.SpecialInstructions))
                            {
                                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2" NoIcon="true">
                                    <MudText Typo="Typo.caption">@pickup.SpecialInstructions</MudText>
                                </MudAlert>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.CheckCircle" OnClick="@(() => MarkCollected(pickup))">
                                Mark as Collected
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                }
            </MudStack>
        }
        else
        {
            <MudAlert Severity="Severity.Info">No assigned pickups for the selected filters</MudAlert>
        }
    </MudTabPanel>
    
    <MudTabPanel Text="Collected" BadgeData="@_collectedPickups.Count" BadgeColor="Color.Success">
        @if (_collectedPickups.Any())
        {
            <MudStack Spacing="2">
                @foreach (var pickup in _collectedPickups)
                {
                    <MudCard Outlined="true">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.subtitle1"><strong>@pickup.PickupNo</strong></MudText>
                                    <MudText Typo="Typo.body2">@pickup.CustomerName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@pickup.City</MudText>
                                    @if (!string.IsNullOrEmpty(pickup.CourierName))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">Courier: @pickup.CourierName</MudText>
                                    }
                                </MudStack>
                                <MudStack Spacing="0" AlignItems="AlignItems.End">
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Collected</MudChip>
                                    <MudText Typo="Typo.caption">@pickup.CollectedAt?.ToString("dd MMM HH:mm")</MudText>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
        else
        {
            <MudAlert Severity="Severity.Info">No collected pickups for the selected filters</MudAlert>
        }
    </MudTabPanel>
    
    <MudTabPanel Text="Inscanned" BadgeData="@_inscannedPickups.Count" BadgeColor="Color.Tertiary">
        @if (_inscannedPickups.Any())
        {
            <MudStack Spacing="2">
                @foreach (var pickup in _inscannedPickups)
                {
                    <MudCard Outlined="true">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.subtitle1"><strong>@pickup.PickupNo</strong></MudText>
                                    <MudText Typo="Typo.body2">@pickup.CustomerName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@pickup.City</MudText>
                                    @if (!string.IsNullOrEmpty(pickup.CourierName))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Primary">Courier: @pickup.CourierName</MudText>
                                    }
                                </MudStack>
                                <MudStack Spacing="0" AlignItems="AlignItems.End">
                                    <MudChip T="string" Color="Color.Tertiary" Size="Size.Small">Inscanned</MudChip>
                                    <MudText Typo="Typo.caption">@pickup.InscannedAt?.ToString("dd MMM HH:mm")</MudText>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
        else
        {
            <MudAlert Severity="Severity.Info">No inscanned pickups for the selected filters</MudAlert>
        }
    </MudTabPanel>
</MudTabs>

<MudPaper Class="pa-3 mt-4" Elevation="2" Style="background-color: #e3f2fd;">
    <MudStack Row="true" Justify="Justify.SpaceAround">
        <MudStack Spacing="0" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4" Color="Color.Primary">@_assignedPickups.Count</MudText>
            <MudText Typo="Typo.caption">Assigned</MudText>
        </MudStack>
        <MudDivider Vertical="true" FlexItem="true" />
        <MudStack Spacing="0" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4" Color="Color.Success">@_collectedPickups.Count</MudText>
            <MudText Typo="Typo.caption">Collected</MudText>
        </MudStack>
        <MudDivider Vertical="true" FlexItem="true" />
        <MudStack Spacing="0" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4" Color="Color.Tertiary">@_inscannedPickups.Count</MudText>
            <MudText Typo="Typo.caption">Inscanned</MudText>
        </MudStack>
    </MudStack>
</MudPaper>

<MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" Size="Size.Large" 
        Style="position: fixed; bottom: 20px; right: 20px;" OnClick="LoadData" />

@code {
    private List<PickupRequest> _assignedPickups = new();
    private List<PickupRequest> _collectedPickups = new();
    private List<PickupRequest> _inscannedPickups = new();
    private List<Party> _couriers = new();
    
    private long? _selectedCourierId;
    private string _selectedPeriod = "Today";
    private DateTime? _fromDate;
    private DateTime? _toDate;

    protected override async Task OnInitializedAsync()
    {
        _couriers = await DbContext.Parties
            .Where(p => p.PartyType == PartyType.DeliveryAgent && !p.IsDeleted && p.IsActive)
            .OrderBy(p => p.Name)
            .ToListAsync();
            
        await LoadData();
    }

    private async Task OnCourierChanged(long? courierId)
    {
        _selectedCourierId = courierId;
        await LoadData();
    }

    private (DateTime from, DateTime to) GetDateRange()
    {
        var today = DateTime.UtcNow.Date;
        
        return _selectedPeriod switch
        {
            "Today" => (today, today.AddDays(1)),
            "Week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(7 - (int)today.DayOfWeek)),
            "Month" => (new DateTime(today.Year, today.Month, 1), new DateTime(today.Year, today.Month, 1).AddMonths(1)),
            "Year" => (new DateTime(today.Year, 1, 1), new DateTime(today.Year + 1, 1, 1)),
            "Custom" => (_fromDate?.Date ?? today.AddDays(-30), _toDate?.Date.AddDays(1) ?? today.AddDays(1)),
            _ => (today, today.AddDays(1))
        };
    }

    private async Task LoadData()
    {
        var (from, to) = GetDateRange();
        
        var query = DbContext.PickupRequests
            .Where(p => !p.IsDeleted && p.RequestDate >= from && p.RequestDate < to);
            
        if (_selectedCourierId.HasValue)
        {
            query = query.Where(p => p.CourierId == _selectedCourierId.Value);
        }
        
        var pickups = await query.OrderByDescending(p => p.RequestDate).ToListAsync();
        
        _assignedPickups = pickups.Where(p => p.Status == PickupStatus.AssignedForCollection).ToList();
        _collectedPickups = pickups.Where(p => p.Status == PickupStatus.ShipmentCollected).ToList();
        _inscannedPickups = pickups.Where(p => p.Status == PickupStatus.Inscanned).ToList();
            
        StateHasChanged();
    }

    private async Task MarkCollected(PickupRequest pickup)
    {
        var parameters = new DialogParameters<CollectPickupDialog>
        {
            { x => x.Pickup, pickup }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CollectPickupDialog>("Collect Pickup", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled && result.Data is CollectPickupDialog.CollectionResult collectionResult)
        {
            pickup.Status = PickupStatus.ShipmentCollected;
            pickup.CollectedAt = DateTime.UtcNow;
            pickup.CollectionRemarks = collectionResult.Remarks;
            if (collectionResult.ActualPieces.HasValue)
            {
                pickup.ActualPieces = collectionResult.ActualPieces;
            }
            await DbContext.SaveChangesAsync();
            Snackbar.Add($"Pickup {pickup.PickupNo} marked as collected!", Severity.Success);
            await LoadData();
        }
    }
}

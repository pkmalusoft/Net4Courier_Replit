@page "/zone-categories"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums
@inject ApplicationDbContext DbContext
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Zone Categories</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h5">Zone Categories</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateNew">New Category</MudButton>
        </MudStack>

        <MudGrid Class="mb-4">
            <MudItem xs="12" md="3">
                <MudSelect T="string" Label="Movement Type" Value="_filterMovementType" Variant="Variant.Outlined" 
                           Margin="Margin.Dense" Clearable="true" ValueChanged="FilterChanged">
                    <MudSelectItem Value="@("")">All</MudSelectItem>
                    <MudSelectItem Value="@("Domestic")">Domestic</MudSelectItem>
                    <MudSelectItem Value="@("International")">International</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="_searchText" Label="Search" Variant="Variant.Outlined" Margin="Margin.Dense"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="SearchCategories" />
            </MudItem>
        </MudGrid>

        <MudTable Items="@_categories" Hover="true" Striped="true" Loading="@_loading" Dense="true" Elevation="0"
                  Class="border-solid border">
            <HeaderContent>
                <MudTh>Code</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Movement Type</MudTh>
                <MudTh>Carrier</MudTh>
                <MudTh>Zones</MudTh>
                <MudTh>Sort Order</MudTh>
                <MudTh Style="width:150px">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Code">
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.Code</MudChip>
                </MudTd>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Movement Type">
                    <MudChip T="string" Size="Size.Small" Color="@(context.MovementType != MovementType.Domestic ? Color.Warning : Color.Info)">
                        @context.MovementType
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Carrier">@GetCarrierName(context.ForwardingAgentId)</MudTd>
                <MudTd DataLabel="Zones">
                    <MudLink OnClick="@(() => ManageZones(context))">@context.ZoneMatrices.Count zones</MudLink>
                </MudTd>
                <MudTd DataLabel="Sort">@context.SortOrder</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Map" Size="Size.Small" Color="Color.Secondary"
                                   OnClick="@(() => ManageZones(context))" Title="Manage Zones" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                   OnClick="@(() => Edit(context))" Title="Edit" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => Delete(context))" Title="Delete" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No zone categories found. Click "New Category" to create one.</MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudText>Loading...</MudText>
            </LoadingContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<ZoneCategory> _categories = new();
    private Dictionary<long, string> _carrierNames = new();
    private bool _loading = true;
    private string _searchText = "";
    private string _filterMovementType = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        _loading = true;
        try
        {
            var query = DbContext.ZoneCategories
                .Include(z => z.ZoneMatrices)
                .Where(z => !z.IsDeleted)
                .AsQueryable();

            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                query = query.Where(z => z.Code.ToLower().Contains(_searchText.ToLower()) ||
                                         z.Name.ToLower().Contains(_searchText.ToLower()));
            }

            if (!string.IsNullOrWhiteSpace(_filterMovementType))
            {
                if (_filterMovementType == "Domestic")
                    query = query.Where(z => z.MovementType == MovementType.Domestic);
                else if (_filterMovementType == "International")
                    query = query.Where(z => z.MovementType == MovementType.InternationalExport || 
                                             z.MovementType == MovementType.InternationalImport);
            }

            _categories = await query.OrderBy(z => z.SortOrder).ThenBy(z => z.Code).ToListAsync();

            var carrierIds = _categories.Where(z => z.ForwardingAgentId.HasValue)
                .Select(z => z.ForwardingAgentId!.Value).Distinct().ToList();

            if (carrierIds.Any())
            {
                _carrierNames = await DbContext.Parties
                    .Where(p => carrierIds.Contains(p.Id))
                    .ToDictionaryAsync(p => p.Id, p => p.Name);
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SearchCategories() => await LoadCategories();
    
    private async Task FilterChanged(string value)
    {
        _filterMovementType = value;
        await LoadCategories();
    }

    private string GetCarrierName(long? id) => id.HasValue && _carrierNames.TryGetValue(id.Value, out var name) ? name : "-";

    private async Task CreateNew()
    {
        var model = new ZoneCategory { SortOrder = (_categories.Count + 1) * 10 };
        var parameters = new DialogParameters<ZoneCategoryDialog>
        {
            { x => x.Model, model },
            { x => x.IsEdit, false },
            { x => x.SelectedCarrier, null }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ZoneCategoryDialog>("New Zone Category", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ZoneCategory savedModel)
        {
            await SaveCategory(savedModel, false);
        }
    }

    private async Task Edit(ZoneCategory category)
    {
        var model = new ZoneCategory
        {
            Id = category.Id,
            Code = category.Code,
            Name = category.Name,
            MovementType = category.MovementType,
            ForwardingAgentId = category.ForwardingAgentId,
            Description = category.Description,
            SortOrder = category.SortOrder
        };

        Party? selectedCarrier = null;
        if (category.ForwardingAgentId.HasValue)
        {
            selectedCarrier = await DbContext.Parties.FirstOrDefaultAsync(p => p.Id == category.ForwardingAgentId);
        }

        var parameters = new DialogParameters<ZoneCategoryDialog>
        {
            { x => x.Model, model },
            { x => x.IsEdit, true },
            { x => x.SelectedCarrier, selectedCarrier }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ZoneCategoryDialog>("Edit Zone Category", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is ZoneCategory savedModel)
        {
            await SaveCategory(savedModel, true);
        }
    }

    private async Task SaveCategory(ZoneCategory model, bool isEdit)
    {
        if (string.IsNullOrWhiteSpace(model.Code) || string.IsNullOrWhiteSpace(model.Name))
        {
            Snackbar.Add("Code and Name are required", Severity.Error);
            return;
        }

        try
        {
            if (isEdit)
            {
                var existing = await DbContext.ZoneCategories.FindAsync(model.Id);
                if (existing != null)
                {
                    existing.Code = model.Code;
                    existing.Name = model.Name;
                    existing.MovementType = model.MovementType;
                    existing.ForwardingAgentId = model.ForwardingAgentId;
                    existing.Description = model.Description;
                    existing.SortOrder = model.SortOrder;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }
            else
            {
                model.CreatedAt = DateTime.UtcNow;
                DbContext.ZoneCategories.Add(model);
            }

            await DbContext.SaveChangesAsync();
            Snackbar.Add(isEdit ? "Category updated" : "Category created", Severity.Success);
            await LoadCategories();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task Delete(ZoneCategory category)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Zone Category",
            $"Are you sure you want to delete '{category.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            var existing = await DbContext.ZoneCategories.FindAsync(category.Id);
            if (existing != null)
            {
                existing.IsDeleted = true;
                existing.ModifiedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
                Snackbar.Add("Category deleted", Severity.Success);
                await LoadCategories();
            }
        }
    }

    private void ManageZones(ZoneCategory category)
    {
        Navigation.NavigateTo($"/zone-matrix?categoryId={category.Id}");
    }
}

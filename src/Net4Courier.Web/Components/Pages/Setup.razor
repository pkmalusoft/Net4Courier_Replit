@page "/setup"
@layout EmptyLayout
@using Net4Courier.Infrastructure.Services
@inject ISetupService SetupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="setup-container">
    @if (!_isSetupEnabled)
    {
        <MudPaper Class="setup-card" Elevation="4">
            <div class="setup-header">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Error" />
                <MudText Typo="Typo.h4" Class="mt-2">Setup Disabled</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Set the SETUP_KEY environment variable to enable initial configuration.
                </MudText>
            </div>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" 
                       Href="/login" Class="mt-4">
                Go to Login
            </MudButton>
        </MudPaper>
    }
    else
    {
    <MudPaper Class="setup-card" Elevation="4">
        <div class="setup-header">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4" Class="mt-2">Setup & Maintenance</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Configure administrators and reset passwords</MudText>
        </div>

        @if (!_setupKeyValidated)
        {
            <MudForm @ref="_setupKeyForm" Class="mt-4">
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    Enter the Setup Key provided by your system administrator to proceed with the initial configuration.
                </MudAlert>
                
                <MudTextField @bind-Value="_setupKey"
                              Label="Setup Key"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              RequiredError="Setup Key is required"
                              FullWidth="true"
                              Class="mb-4" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="ValidateSetupKey"
                           Disabled="_isValidating">
                    @if (_isValidating)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Verify Setup Key
                </MudButton>

                @if (!string.IsNullOrEmpty(_setupKeyError))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4">@_setupKeyError</MudAlert>
                }
            </MudForm>
        }
        else
        {
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                <MudTabPanel Text="Create Admin" Icon="@Icons.Material.Filled.PersonAdd">
                    <MudForm @ref="_adminForm" Class="mt-4">
                        <MudAlert Severity="Severity.Success" Class="mb-4">
                            Setup key verified. Create a new administrator account below.
                        </MudAlert>

                        <MudTextField @bind-Value="_username"
                                      Label="Username"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Username is required"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_fullName"
                                      Label="Full Name"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Full Name is required"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_email"
                                      Label="Email"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Required="true"
                                      RequiredError="Email is required"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_password"
                                      Label="Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      RequiredError="Password is required"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_confirmPassword"
                                      Label="Confirm Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      RequiredError="Please confirm your password"
                                      FullWidth="true"
                                      Class="mb-4" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   OnClick="CreateAdmin"
                                   Disabled="_isCreating">
                            @if (_isCreating)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Create Administrator Account
                        </MudButton>

                        @if (!string.IsNullOrEmpty(_createError))
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-4">@_createError</MudAlert>
                        }
                    </MudForm>
                </MudTabPanel>
                
                <MudTabPanel Text="Reset Password" Icon="@Icons.Material.Filled.LockReset">
                    <MudForm Class="mt-4">
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            Reset the password for an existing user.
                        </MudAlert>

                        <MudTextField @bind-Value="_resetUsername"
                                      Label="Username"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_resetPassword"
                                      Label="New Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="_resetPasswordConfirm"
                                      Label="Confirm New Password"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password"
                                      Required="true"
                                      FullWidth="true"
                                      Class="mb-4" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Warning"
                                   FullWidth="true"
                                   OnClick="ResetPassword"
                                   Disabled="_isResetting">
                            @if (_isResetting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Reset Password
                        </MudButton>

                        @if (!string.IsNullOrEmpty(_resetError))
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-4">@_resetError</MudAlert>
                        }
                        @if (!string.IsNullOrEmpty(_resetSuccess))
                        {
                            <MudAlert Severity="Severity.Success" Class="mt-4">@_resetSuccess</MudAlert>
                        }
                    </MudForm>
                </MudTabPanel>
                
                <MudTabPanel Text="Users" Icon="@Icons.Material.Filled.Group">
                    <div class="mt-4">
                        <MudAlert Severity="Severity.Info" Class="mb-4">
                            List of existing users in the system.
                        </MudAlert>
                        
                        @if (_users.Any())
                        {
                            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Active</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in _users)
                                    {
                                        <tr>
                                            <td>@user.Id</td>
                                            <td>@user.Username</td>
                                            <td>@user.FullName</td>
                                            <td>@user.RoleName</td>
                                            <td>
                                                <MudIcon Icon="@(user.IsActive ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)" 
                                                         Color="@(user.IsActive ? Color.Success : Color.Error)" Size="Size.Small" />
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText>No users found.</MudText>
                        }
                        
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadUsers" Class="mt-4">
                            <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-2" /> Refresh
                        </MudButton>
                    </div>
                </MudTabPanel>
            </MudTabs>
            
            <MudAlert Severity="Severity.Warning" Class="mt-4">
                <strong>Security Notice:</strong> Remove the SETUP_KEY environment variable after completing setup to disable this page.
            </MudAlert>
        }
    </MudPaper>
    }
</div>

<style>
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 50%, #01579b 100%);
        padding: 20px;
    }

    .setup-card {
        max-width: 450px;
        width: 100%;
        padding: 40px;
        border-radius: 16px;
    }

    .setup-header {
        text-align: center;
        margin-bottom: 20px;
    }
</style>

@code {
    private MudForm? _setupKeyForm;
    private MudForm? _adminForm;
    
    private bool _isSetupEnabled = false;
    private string _setupKey = "";
    private bool _setupKeyValidated = false;
    private bool _isValidating = false;
    private string? _setupKeyError;

    private string _username = "";
    private string _fullName = "";
    private string _email = "";
    private string _password = "";
    private string _confirmPassword = "";
    private bool _isCreating = false;
    private string? _createError;
    
    private string _resetUsername = "";
    private string _resetPassword = "";
    private string _resetPasswordConfirm = "";
    private bool _isResetting = false;
    private string? _resetError;
    private string? _resetSuccess;
    
    private List<(long Id, string Username, string FullName, string? RoleName, bool IsActive)> _users = new();

    protected override async Task OnInitializedAsync()
    {
        _isSetupEnabled = await SetupService.IsSetupEnabledAsync();
    }

    private async Task ValidateSetupKey()
    {
        _setupKeyError = null;
        
        if (string.IsNullOrWhiteSpace(_setupKey))
        {
            _setupKeyError = "Please enter the setup key";
            return;
        }

        _isValidating = true;
        StateHasChanged();

        try
        {
            var isValid = await SetupService.ValidateSetupKeyAsync(_setupKey);
            if (isValid)
            {
                _setupKeyValidated = true;
                await LoadUsers();
            }
            else
            {
                _setupKeyError = "Invalid setup key. Please contact your system administrator.";
            }
        }
        catch (Exception ex)
        {
            _setupKeyError = $"Error validating setup key: {ex.Message}";
        }
        finally
        {
            _isValidating = false;
        }
    }

    private async Task CreateAdmin()
    {
        _createError = null;

        if (string.IsNullOrWhiteSpace(_username))
        {
            _createError = "Username is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(_fullName))
        {
            _createError = "Full Name is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(_email))
        {
            _createError = "Email is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(_password))
        {
            _createError = "Password is required";
            return;
        }

        if (_password.Length < 8)
        {
            _createError = "Password must be at least 8 characters long";
            return;
        }

        if (_password != _confirmPassword)
        {
            _createError = "Passwords do not match";
            return;
        }

        _isCreating = true;
        StateHasChanged();

        try
        {
            var (success, message) = await SetupService.CreateInitialAdminAsync(_setupKey, _username, _email, _fullName, _password);
            
            if (success)
            {
                Snackbar.Add(message, Severity.Success);
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                _createError = message;
            }
        }
        catch (Exception ex)
        {
            _createError = $"Error creating administrator: {ex.Message}";
        }
        finally
        {
            _isCreating = false;
        }
    }

    private async Task ResetPassword()
    {
        _resetError = null;
        _resetSuccess = null;

        if (string.IsNullOrWhiteSpace(_resetUsername))
        {
            _resetError = "Username is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(_resetPassword))
        {
            _resetError = "Password is required";
            return;
        }

        if (_resetPassword.Length < 8)
        {
            _resetError = "Password must be at least 8 characters long";
            return;
        }

        if (_resetPassword != _resetPasswordConfirm)
        {
            _resetError = "Passwords do not match";
            return;
        }

        _isResetting = true;
        StateHasChanged();

        try
        {
            var (success, message) = await SetupService.ResetPasswordAsync(_setupKey, _resetUsername, _resetPassword);
            
            if (success)
            {
                _resetSuccess = message;
                _resetUsername = "";
                _resetPassword = "";
                _resetPasswordConfirm = "";
                Snackbar.Add(message, Severity.Success);
            }
            else
            {
                _resetError = message;
            }
        }
        catch (Exception ex)
        {
            _resetError = $"Error resetting password: {ex.Message}";
        }
        finally
        {
            _isResetting = false;
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            _users = await SetupService.GetUsersAsync(_setupKey);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
    }
}

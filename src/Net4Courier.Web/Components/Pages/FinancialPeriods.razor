@page "/financial-periods"
@page "/financial-periods/{YearId:long}"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities

<PageTitle>Financial Periods</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSelect T="long?" Value="_selectedYearId" ValueChanged="OnYearChanged" Label="Financial Year" 
                           Variant="Variant.Outlined" Clearable="true" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var year in _financialYears)
                    {
                        <MudSelectItem T="long?" Value="@((long?)year.Id)">@year.Name (@year.Company?.Name)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="8" Class="d-flex align-center justify-end gap-2">
                @if (_selectedYearId.HasValue)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.LockOpen" 
                               OnClick="OpenAllPeriods">Open All</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Lock" 
                               OnClick="CloseAllPeriods">Close All</MudButton>
                    @if (!_periods.Any() && _selectedYear != null)
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
                                   OnClick="GeneratePeriods">Generate Periods</MudButton>
                    }
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_selectedYearId.HasValue && _selectedYear != null)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="1">
            <MudText Typo="Typo.subtitle1" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.DateRange" Class="mr-2" />
                @_selectedYear.Name: @_selectedYear.StartDate.ToString("dd MMM yyyy") - @_selectedYear.EndDate.ToString("dd MMM yyyy")
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @_periods.Count(p => p.Status == PeriodStatus.Open) Open | @_periods.Count(p => p.Status == PeriodStatus.Closed) Closed
            </MudText>
        </MudPaper>

        <MudTable Items="_periods" Hover="true" Dense="true" Elevation="2" Class="mb-4">
            <HeaderContent>
                <MudTh Style="width: 60px;">#</MudTh>
                <MudTh>Period</MudTh>
                <MudTh>Start Date</MudTh>
                <MudTh>End Date</MudTh>
                <MudTh Style="text-align: center;">Status</MudTh>
                <MudTh>Last Changed</MudTh>
                <MudTh Style="text-align: center;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.PeriodNumber</MudTd>
                <MudTd><strong>@context.PeriodName</strong></MudTd>
                <MudTd>@context.StartDate.ToString("dd MMM yyyy")</MudTd>
                <MudTd>@context.EndDate.ToString("dd MMM yyyy")</MudTd>
                <MudTd Style="text-align: center;">
                    @if (context.Status == PeriodStatus.Open)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.LockOpen">Open</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Lock">Closed</MudChip>
                    }
                </MudTd>
                <MudTd>
                    @if (context.ClosedAt.HasValue && context.Status == PeriodStatus.Closed)
                    {
                        <MudText Typo="Typo.caption">Closed: @context.ClosedAt.Value.ToString("dd MMM yyyy HH:mm")</MudText>
                    }
                    else if (context.ReopenedAt.HasValue)
                    {
                        <MudText Typo="Typo.caption">Reopened: @context.ReopenedAt.Value.ToString("dd MMM yyyy HH:mm")</MudText>
                    }
                </MudTd>
                <MudTd Style="text-align: center;">
                    @if (context.Status == PeriodStatus.Open)
                    {
                        <MudTooltip Text="Close Period">
                            <MudIconButton Icon="@Icons.Material.Filled.Lock" Color="Color.Error" Size="Size.Small" 
                                           OnClick="@(() => ClosePeriod(context))" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="Reopen Period">
                            <MudIconButton Icon="@Icons.Material.Filled.LockOpen" Color="Color.Success" Size="Size.Small" 
                                           OnClick="@(() => ReopenPeriod(context))" />
                        </MudTooltip>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudPaper Class="pa-8" Elevation="1">
            <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Large" Class="mb-2" />
                <br />
                Please select a Financial Year to view and manage its periods
            </MudText>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public long YearId { get; set; }
    
    private List<FinancialYear> _financialYears = new();
    private List<FinancialPeriod> _periods = new();
    private long? _selectedYearId;
    private FinancialYear? _selectedYear;
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _financialYears = await dbContext.FinancialYears
            .Include(f => f.Company)
            .Where(f => f.IsActive && !f.IsDeleted)
            .OrderByDescending(f => f.StartDate)
            .ToListAsync();

        if (YearId > 0)
        {
            _selectedYearId = YearId;
            await LoadPeriods();
        }
        else if (_financialYears.Any())
        {
            var currentYear = _financialYears.FirstOrDefault(f => f.IsCurrent);
            if (currentYear != null)
            {
                _selectedYearId = currentYear.Id;
                await LoadPeriods();
            }
        }
    }

    private async Task OnYearChanged(long? yearId)
    {
        _selectedYearId = yearId;
        await LoadPeriods();
    }

    private async Task LoadPeriods()
    {
        if (!_selectedYearId.HasValue)
        {
            _periods.Clear();
            _selectedYear = null;
            return;
        }

        _selectedYear = _financialYears.FirstOrDefault(f => f.Id == _selectedYearId);
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _periods = await dbContext.FinancialPeriods
            .Where(p => p.FinancialYearId == _selectedYearId && p.IsActive && !p.IsDeleted)
            .OrderBy(p => p.PeriodNumber)
            .ToListAsync();
    }

    private async Task ClosePeriod(FinancialPeriod period)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Close Period",
            $"Are you sure you want to close {period.PeriodName}? Transactions cannot be posted to closed periods.",
            yesText: "Close", cancelText: "Cancel");

        if (confirm == true)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            dbContext.Attach(period);
            period.Status = PeriodStatus.Closed;
            period.ClosedAt = DateTime.UtcNow;
            period.ModifiedAt = DateTime.UtcNow;
            await dbContext.SaveChangesAsync();
            Snackbar.Add($"{period.PeriodName} closed successfully", Severity.Success);
        }
    }

    private async Task ReopenPeriod(FinancialPeriod period)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Reopen Period",
            $"Are you sure you want to reopen {period.PeriodName}? This will allow transactions to be posted again.",
            yesText: "Reopen", cancelText: "Cancel");

        if (confirm == true)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            dbContext.Attach(period);
            period.Status = PeriodStatus.Open;
            period.ReopenedAt = DateTime.UtcNow;
            period.ModifiedAt = DateTime.UtcNow;
            await dbContext.SaveChangesAsync();
            Snackbar.Add($"{period.PeriodName} reopened successfully", Severity.Success);
        }
    }

    private async Task CloseAllPeriods()
    {
        var confirm = await DialogService.ShowMessageBox(
            "Close All Periods",
            "Are you sure you want to close all periods for this financial year?",
            yesText: "Close All", cancelText: "Cancel");

        if (confirm == true)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            foreach (var period in _periods.Where(p => p.Status == PeriodStatus.Open))
            {
                dbContext.Attach(period);
                period.Status = PeriodStatus.Closed;
                period.ClosedAt = DateTime.UtcNow;
                period.ModifiedAt = DateTime.UtcNow;
            }
            await dbContext.SaveChangesAsync();
            Snackbar.Add("All periods closed successfully", Severity.Success);
        }
    }

    private async Task OpenAllPeriods()
    {
        var confirm = await DialogService.ShowMessageBox(
            "Open All Periods",
            "Are you sure you want to reopen all periods for this financial year?",
            yesText: "Open All", cancelText: "Cancel");

        if (confirm == true)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            foreach (var period in _periods.Where(p => p.Status == PeriodStatus.Closed))
            {
                dbContext.Attach(period);
                period.Status = PeriodStatus.Open;
                period.ReopenedAt = DateTime.UtcNow;
                period.ModifiedAt = DateTime.UtcNow;
            }
            await dbContext.SaveChangesAsync();
            Snackbar.Add("All periods reopened successfully", Severity.Success);
        }
    }

    private async Task GeneratePeriods()
    {
        if (_selectedYear == null) return;

        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var startDate = _selectedYear.StartDate;
        var endDate = _selectedYear.EndDate;
        var periodNumber = 1;
        var currentDate = startDate;

        while (currentDate <= endDate && periodNumber <= 12)
        {
            var periodStart = currentDate;
            var periodEnd = new DateTime(currentDate.Year, currentDate.Month,
                DateTime.DaysInMonth(currentDate.Year, currentDate.Month), 23, 59, 59);

            if (periodEnd > endDate)
                periodEnd = endDate;

            var period = new FinancialPeriod
            {
                FinancialYearId = _selectedYear.Id,
                PeriodNumber = periodNumber,
                PeriodName = periodStart.ToString("MMM yyyy"),
                StartDate = DateTime.SpecifyKind(periodStart, DateTimeKind.Utc),
                EndDate = DateTime.SpecifyKind(periodEnd, DateTimeKind.Utc),
                Status = PeriodStatus.Open,
                CreatedAt = DateTime.UtcNow
            };

            dbContext.FinancialPeriods.Add(period);
            periodNumber++;
            currentDate = periodEnd.AddDays(1).Date;
        }

        await dbContext.SaveChangesAsync();
        await LoadPeriods();
        Snackbar.Add($"Generated {periodNumber - 1} periods successfully", Severity.Success);
    }
}

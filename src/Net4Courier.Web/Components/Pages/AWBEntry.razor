@page "/awb-entry"
@page "/awb-entry/{Id:long}"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>@(Id > 0 ? "Edit AWB" : "New AWB Entry") - Net4Courier</PageTitle>

<MudForm @ref="_form" @bind-IsValid="_formIsValid">
    <MudPaper Class="pa-3 mb-3" Elevation="2">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_inscan.AWBNo" Label="AWB Number" Required="true" RequiredError="Required"
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudDatePicker @bind-Date="_transactionDate" Label="Booking Date" Required="true" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudTimePicker @bind-Time="_bookingTime" Label="Booking Time" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="PaymentMode" @bind-Value="_inscan.PaymentModeId" Label="Payment Mode" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.PickupCash">Pickup Cash</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.COD">COD</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Account">Account</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Prepaid">Prepaid</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.CAD">CAD</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="long?" @bind-Value="_inscan.CustomerId" Label="Customer/Account" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="long?" Value="@((long?)null)">-- Walk-in --</MudSelectItem>
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem T="long?" Value="@customer.Id">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudTextField @bind-Value="_inscan.ReferenceNo" Label="Reference No" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid Spacing="3">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />SHIPPER DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignor" Label="Name" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorPhone" Label="Telephone No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorMobile" Label="Mobile No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsignorAddress1" Label="Address" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorCity" Label="City" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorState" Label="State" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorPostalCode" Label="Pincode" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorCountry" Label="Country" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />CONSIGNEE DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignee" Label="Name" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneePhone" Label="Telephone No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeMobile" Label="Mobile No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsigneeAddress1" Label="Address" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeCity" Label="Destination City" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeState" Label="State" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneePostalCode" Label="Pincode" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeCountry" Label="Destination Country" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-3 mt-3" Elevation="2">
        <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Small" Class="mr-1" />BOX DETAILS
        </MudText>
        <MudGrid Spacing="2">
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_inscan.CargoDescription" Label="Description" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="DocumentType" @bind-Value="_inscan.DocumentTypeId" Label="Type" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Document">Document</MudSelectItem>
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Parcel">Parcel</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="MovementType" @bind-Value="_inscan.MovementTypeId" Label="Movement" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="MovementType" Value="@MovementType.Domestic">Domestic</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.InternationalExport">International-Export</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.InternationalImport">International-Import</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.Transhipment">Transhipment</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.Pieces" Label="Units/Pcs" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-3" />

        <MudGrid Spacing="2">
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Length" Label="L (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Width" Label="W (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Height" Label="H (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="6" md="1">
                <MudNumericField @bind-Value="_inscan.Weight" Label="Actual Wt" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@VolumetricWeight" Label="Vol. Weight" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@ChargeableWeight" Label="Chg. Weight" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.CustomsValue" Label="Declared Value" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_inscan.SpecialInstructions" Label="Special Instructions" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-3 mt-3" Elevation="2">
        <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Class="mr-1" />CHARGES
        </MudText>
        <MudGrid Spacing="2">
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.CourierCharge" Label="Freight Charges" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.FuelSurcharge" Label="Fuel Surcharge" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.OtherCharge" Label="ODA/Other Charges" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.TaxPercent" Label="Tax %" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.Discount" Label="Discount" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@NetTotal" Label="Total Charges" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" 
                                 Style="font-weight: bold;" />
            </MudItem>
            @if (_inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD)
            {
                <MudItem xs="12" md="2">
                    <MudNumericField @bind-Value="_inscan.CODAmount" Label="COD Amount" 
                                     Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <MudGrid Spacing="3" Class="mt-3">
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Class="mr-1" />FORWARDING AGENT
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_forwardingAgentName" Label="Forwarding Agent" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.ForwardingCharge" Label="Forw. Rate" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ForwardingAWBNo" Label="Forw.Agnt.No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.SpotRate" Label="Spot Rate" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.MarginPercent" Label="Margin%" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.VerifiedWeight" Label="Verified Wt." 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.ManifestWeight" Label="Manifest Wt" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Remarks" Label="Remarks" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="3">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Class="mr-1" />SHIPPER INSTRUCTIONS
                </MudText>
                <MudStack Spacing="1">
                    <MudCheckBox @bind-Value="_inscan.IsNCND" Label="NCND" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsCashOnly" Label="Cash Only" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsChequeOnly" Label="Cheque Only" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsCollectMaterial" Label="Collect Material" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsDOCopyBack" Label="DOCopyBack" Dense="true" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="3">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.DeliveryDining" Size="Size.Small" Class="mr-1" />COURIER DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.PickedBy" Label="Picked By" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ReceivedBy" Label="Received By" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="3">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Class="mr-1" />AUDIT DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField Value="@_createdBy" Label="Created By" 
                                      Variant="Variant.Filled" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField Value="@_modifiedBy" Label="Modified By" 
                                      Variant="Variant.Filled" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudStack Row="true" Justify="Justify.SpaceBetween" Spacing="2" Class="mt-4">
        <MudStack Row="true" Spacing="2">
            @if (Id > 0)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="@($"/api/report/awb-print/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.Print">
                    Print AWB (A5)
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Info" Href="@($"/api/report/awb/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.Label">
                    Print Label (4x6)
                </MudButton>
                @if (!string.IsNullOrEmpty(_inscan.MAWBNo))
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" Href="@($"/api/report/manifest-label/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.LocalShipping">
                        Manifest Label
                    </MudButton>
                }
            }
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" OnClick="Cancel">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="!_formIsValid">
                @(Id > 0 ? "Update AWB" : "Save AWB")
            </MudButton>
        </MudStack>
    </MudStack>
</MudForm>

@code {
    [Parameter] public long Id { get; set; }

    private InscanMaster _inscan = new();
    private MudForm _form = null!;
    private bool _formIsValid;
    private DateTime? _transactionDate = DateTime.Today;
    private TimeSpan? _bookingTime = DateTime.Now.TimeOfDay;
    private List<Party> _customers = new();
    private string? _forwardingAgentName;
    private string _createdBy = "";
    private string _modifiedBy = "";

    private decimal VolumetricWeight => (_inscan.Length ?? 0) * (_inscan.Width ?? 0) * (_inscan.Height ?? 0) / 5000;
    private decimal ChargeableWeight => Math.Max(_inscan.Weight ?? 0, VolumetricWeight);
    private decimal NetTotal => ((_inscan.CourierCharge ?? 0) + (_inscan.OtherCharge ?? 0) + (_inscan.FuelSurcharge ?? 0)) 
                                * (1 + (_inscan.TaxPercent ?? 0) / 100) - (_inscan.Discount ?? 0);

    protected override async Task OnInitializedAsync()
    {
        _customers = await DbContext.Parties.Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();

        if (Id > 0)
        {
            var existing = await DbContext.InscanMasters.FindAsync(Id);
            if (existing != null)
            {
                _inscan = existing;
                _transactionDate = _inscan.TransactionDate.ToLocalTime();
                _bookingTime = _inscan.TransactionDate.ToLocalTime().TimeOfDay;
                _createdBy = $"{_inscan.CreatedBy} | {_inscan.CreatedAt:dd-MMM}";
                _modifiedBy = _inscan.ModifiedAt.HasValue ? $"{_inscan.ModifiedBy} | {_inscan.ModifiedAt:dd-MMM}" : "";
            }
        }
        else
        {
            _inscan.AWBNo = await GenerateAWBNo();
            _inscan.TransactionDate = DateTime.UtcNow;
            _inscan.ConsignorCountry = "India";
            _inscan.ConsigneeCountry = "India";
        }
    }

    private async Task<string> GenerateAWBNo()
    {
        var today = DateTime.Today.ToString("yyyyMMdd");
        var count = await DbContext.InscanMasters.CountAsync(i => i.AWBNo.StartsWith(today)) + 1;
        return $"{today}{count:D4}";
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        if (_transactionDate.HasValue)
        {
            var date = _transactionDate.Value.Date;
            if (_bookingTime.HasValue)
                date = date.Add(_bookingTime.Value);
            _inscan.TransactionDate = DateTime.SpecifyKind(date, DateTimeKind.Utc);
        }

        _inscan.VolumetricWeight = VolumetricWeight;
        _inscan.ChargeableWeight = ChargeableWeight;
        _inscan.NetTotal = NetTotal;
        _inscan.IsCOD = _inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD;

        if (Id == 0)
        {
            _inscan.CreatedAt = DateTime.UtcNow;
            _inscan.CourierStatusId = CourierStatus.Pending;
            DbContext.InscanMasters.Add(_inscan);
        }
        else
        {
            _inscan.ModifiedAt = DateTime.UtcNow;
            DbContext.InscanMasters.Update(_inscan);
        }

        await DbContext.SaveChangesAsync();
        Snackbar.Add(Id > 0 ? "AWB updated successfully" : "AWB created successfully", Severity.Success);
        NavigationManager.NavigateTo("/awb-list");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/awb-list");
    }
}

@page "/awb-entry"
@page "/awb-entry/{Id:long}"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>@(Id > 0 ? "Edit AWB" : "New AWB Entry") - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">@(Id > 0 ? $"Edit AWB: {_inscan.AWBNo}" : "New AWB Entry")</MudText>

<MudForm @ref="_form" @bind-IsValid="_formIsValid">
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" GutterBottom="true" Color="Color.Primary">Basic Information</MudText>
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="_inscan.AWBNo" Label="AWB Number" Required="true" RequiredError="AWB Number is required"
                              Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudDatePicker @bind-Date="_transactionDate" Label="Transaction Date" Required="true" 
                               Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="long?" @bind-Value="_inscan.BranchId" Label="Branch" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="long?" Value="@((long?)null)">-- Select --</MudSelectItem>
                    @foreach (var branch in _branches)
                    {
                        <MudSelectItem T="long?" Value="@branch.Id">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="long?" @bind-Value="_inscan.CustomerId" Label="Customer" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="long?" Value="@((long?)null)">-- Select --</MudSelectItem>
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem T="long?" Value="@customer.Id">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true" Color="Color.Primary">Consignor (Sender)</MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignor" Label="Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsignorContact" Label="Contact Person" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsignorMobile" Label="Mobile" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsignorAddress1" Label="Address Line 1" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsignorAddress2" Label="Address Line 2" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsignorCity" Label="City" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsignorCountry" Label="Country" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsignorPostalCode" Label="Postal Code" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true" Color="Color.Primary">Consignee (Receiver)</MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignee" Label="Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeContact" Label="Contact Person" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeMobile" Label="Mobile" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsigneeAddress1" Label="Address Line 1" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsigneeAddress2" Label="Address Line 2" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeCity" Label="City" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeCountry" Label="Country" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_inscan.ConsigneePostalCode" Label="Postal Code" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" GutterBottom="true" Color="Color.Primary">Package Details</MudText>
        <MudGrid>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Pieces" Label="Pieces" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Weight" Label="Actual Weight (kg)" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Length" Label="Length (cm)" Variant="Variant.Outlined" Format="N1" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Width" Label="Width (cm)" Variant="Variant.Outlined" Format="N1" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Height" Label="Height (cm)" Variant="Variant.Outlined" Format="N1" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField Value="@VolumetricWeight" Label="Vol. Weight (kg)" Variant="Variant.Outlined" Format="N2" ReadOnly="true" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect T="DocumentType" @bind-Value="_inscan.DocumentTypeId" Label="Document Type" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Document">Document</MudSelectItem>
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Parcel">Parcel</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect T="MovementType" @bind-Value="_inscan.MovementTypeId" Label="Movement Type" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="MovementType" Value="@MovementType.Domestic">Domestic</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.International">International</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.Import">Import</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.Export">Export</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSelect T="PaymentMode" @bind-Value="_inscan.PaymentModeId" Label="Payment Mode" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Prepaid">Prepaid</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.ToPay">To Pay</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.COD">COD</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Credit">Credit</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_inscan.CargoDescription" Label="Cargo Description" Variant="Variant.Outlined" Lines="2" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_inscan.SpecialInstructions" Label="Special Instructions" Variant="Variant.Outlined" Lines="2" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" GutterBottom="true" Color="Color.Primary">Charges</MudText>
        <MudGrid>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.CourierCharge" Label="Courier Charge" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.OtherCharge" Label="Other Charge" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.FuelSurcharge" Label="Fuel Surcharge" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.TaxPercent" Label="Tax %" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField @bind-Value="_inscan.Discount" Label="Discount" Variant="Variant.Outlined" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudNumericField Value="@NetTotal" Label="Net Total" Variant="Variant.Filled" Format="N2" ReadOnly="true" />
            </MudItem>
            @if (_inscan.PaymentModeId == PaymentMode.COD)
            {
                <MudItem xs="12" md="3">
                    <MudNumericField @bind-Value="_inscan.CODAmount" Label="COD Amount" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
        <MudButton Variant="Variant.Outlined" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="!_formIsValid">
            @(Id > 0 ? "Update AWB" : "Save AWB")
        </MudButton>
    </MudStack>
</MudForm>

@code {
    [Parameter] public long Id { get; set; }

    private InscanMaster _inscan = new();
    private MudForm _form = null!;
    private bool _formIsValid;
    private DateTime? _transactionDate = DateTime.Today;
    private List<Branch> _branches = new();
    private List<Party> _customers = new();

    private decimal VolumetricWeight => (_inscan.Length ?? 0) * (_inscan.Width ?? 0) * (_inscan.Height ?? 0) / 5000;
    private decimal NetTotal => ((_inscan.CourierCharge ?? 0) + (_inscan.OtherCharge ?? 0) + (_inscan.FuelSurcharge ?? 0)) 
                                * (1 + (_inscan.TaxPercent ?? 0) / 100) - (_inscan.Discount ?? 0);

    protected override async Task OnInitializedAsync()
    {
        _branches = await DbContext.Branches.Where(b => b.IsActive && !b.IsDeleted).OrderBy(b => b.Name).ToListAsync();
        _customers = await DbContext.Parties.Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();

        if (Id > 0)
        {
            var existing = await DbContext.InscanMasters.FindAsync(Id);
            if (existing != null)
            {
                _inscan = existing;
                _transactionDate = _inscan.TransactionDate.ToLocalTime();
            }
        }
        else
        {
            _inscan.AWBNo = await GenerateAWBNo();
            _inscan.TransactionDate = DateTime.UtcNow;
        }
    }

    private async Task<string> GenerateAWBNo()
    {
        var today = DateTime.Today.ToString("yyyyMMdd");
        var count = await DbContext.InscanMasters.CountAsync(i => i.AWBNo.StartsWith(today)) + 1;
        return $"{today}{count:D4}";
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        if (_transactionDate.HasValue)
            _inscan.TransactionDate = DateTime.SpecifyKind(_transactionDate.Value, DateTimeKind.Utc);

        _inscan.VolumetricWeight = VolumetricWeight;
        _inscan.ChargeableWeight = Math.Max(_inscan.Weight ?? 0, VolumetricWeight);
        _inscan.NetTotal = NetTotal;
        _inscan.IsCOD = _inscan.PaymentModeId == PaymentMode.COD;

        if (Id == 0)
        {
            _inscan.CreatedAt = DateTime.UtcNow;
            _inscan.CourierStatusId = CourierStatus.Pending;
            DbContext.InscanMasters.Add(_inscan);
        }
        else
        {
            _inscan.ModifiedAt = DateTime.UtcNow;
            DbContext.InscanMasters.Update(_inscan);
        }

        await DbContext.SaveChangesAsync();
        Snackbar.Add(Id > 0 ? "AWB updated successfully" : "AWB created successfully", Severity.Success);
        NavigationManager.NavigateTo("/awb-list");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/awb-list");
    }
}

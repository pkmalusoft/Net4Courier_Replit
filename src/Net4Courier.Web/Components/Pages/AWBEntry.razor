@page "/awb-entry"
@page "/awb-entry/{Id:long}"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject Net4Courier.Web.Services.AWBNumberService AWBNumberService
@inject Net4Courier.Web.Services.ShipmentStatusService ShipmentStatusService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject Net4Courier.Operations.Services.BarcodeService BarcodeService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Models
@using System.Security.Claims

<PageTitle>@(Id > 0 ? "Edit AWB" : "New AWB Entry") - Net4Courier</PageTitle>

@if (Id == 0)
{
    <MudPaper Class="pa-3 mb-3" Elevation="1" Style="background-color: #e8f5e9;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Transform"
                           OnClick="OpenPickupRequestSelector">
                    Convert from Pickup Request
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.CloudUpload"
                           OnClick="OpenBulkUploadDialog">
                    Bulk Shipment Upload
                </MudButton>
                @if (_sourcePickupRequest != null)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" OnClose="ClearPickupSource">
                        From: @_sourcePickupRequest.PickupNo
                    </MudChip>
                }
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudSwitch @bind-Value="_autoGenerateAWB" @bind-Value:after="OnAutoGenerateToggleChanged" Label="Auto-Generate AWB" Color="Color.Primary" />
                @if (_autoGenerateAWB && _currentBranch != null)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Next: @_nextAWBPreview
                    </MudText>
                }
            </MudStack>
        </MudStack>
    </MudPaper>
}

<MudForm @ref="_form" @bind-IsValid="_formIsValid">
    <MudPaper Class="pa-3 mb-3" Elevation="2">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_inscan.AWBNo" @bind-Value:after="OnAWBNoChanged" Label="AWB Number" Required="true" RequiredError="Required"
                              Variant="Variant.Outlined" Margin="Margin.Dense" 
                              Disabled="@(_autoGenerateAWB && Id == 0)" 
                              HelperText="@(_autoGenerateAWB && Id == 0 ? "Auto-generated" : (_isPrepaidAWB ? $"Prepaid - {_prepaidCustomerName}" : ""))" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudDatePicker @bind-Date="_transactionDate" Label="Booking Date" Required="true" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudTimePicker @bind-Time="_bookingTime" Label="Booking Time" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="PaymentMode" @bind-Value="_inscan.PaymentModeId" @bind-Value:after="OnPaymentModeChanged"
                           Label="Payment Mode" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter"
                           Disabled="@_paymentModeDisabled">
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.PickupCash">Pickup Cash</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.COD">COD</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Account">Account</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.Prepaid">Prepaid</MudSelectItem>
                    <MudSelectItem T="PaymentMode" Value="@PaymentMode.CAD">CAD</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                @if (_isPrepaidAWB)
                {
                    <MudTextField Value="@_controlAccountName" Label="Control Account" ReadOnly="true"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" 
                                  HelperText="@($"Customer: {_prepaidCustomerName}")" />
                }
                else if (_inscan.PaymentModeId == PaymentMode.Account)
                {
                    <MudSelect T="long?" @bind-Value="_inscan.CustomerId" @bind-Value:after="OnCustomerChanged"
                               Label="Customer Account *" Variant="Variant.Outlined" Margin="Margin.Dense" 
                               AnchorOrigin="Origin.BottomCenter" Required="true" RequiredError="Customer required for Account payment">
                        @foreach (var customer in _customers)
                        {
                            <MudSelectItem T="long?" Value="@customer.Id">@customer.Name</MudSelectItem>
                        }
                    </MudSelect>
                }
                else if (_inscan.PaymentModeId == PaymentMode.PickupCash)
                {
                    <MudTextField Value="@_controlAccountName" Label="Cash Account" ReadOnly="true"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                }
                else
                {
                    <MudTextField Value="@_controlAccountName" Label="Control Account" ReadOnly="true"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" />
                }
            </MudItem>
            @if (_inscan.PaymentModeId == PaymentMode.Account && _inscan.CustomerId.HasValue)
            {
                <MudItem xs="6" md="2">
                    <MudCheckBox @bind-Value="_copyCustomerToShipper" @bind-Value:after="OnCopyToShipperChanged"
                                 Label="Copy to Shipper" Color="Color.Primary" Dense="true" Class="mt-2" />
                </MudItem>
            }
            <MudItem xs="6" md="2">
                <MudTextField @bind-Value="_inscan.ReferenceNo" Label="Reference No" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_showProceedWarning && !CanProceedWithDetails)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-3" Variant="Variant.Filled">
            @GetProceedWarningMessage()
        </MudAlert>
    }

    <MudGrid Spacing="3">
        <MudItem xs="12" md="6">
            <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
            <MudPaper Class="pa-3" Elevation="2" Style="@($"height: 100%;{(!CanProceedWithDetails ? " opacity: 0.5; pointer-events: none;" : "")}")">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />SHIPPER DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignor" Label="Name" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorPhone" Label="Telephone No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorMobile" Label="Mobile No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsignorAddress1" Label="Address" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudAutocomplete T="City" Label="City" Value="_selectedConsignorCity"
                                         SearchFunc="@SearchCities" ToStringFunc="@(c => c?.Name ?? "")"
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true"
                                         ValueChanged="@OnConsignorCityChanged" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorState" Label="State" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorPostalCode" Label="Pincode" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsignorCountry" Label="Country" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect T="long?" @bind-Value="_inscan.OriginPortId" Label="Origin Airport" 
                                   Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                                   Disabled="@(_inscan.MovementTypeId != MovementType.InternationalExport)">
                            @foreach (var port in _airports)
                            {
                                <MudSelectItem T="long?" Value="@port.Id">@port.Name (@port.IATACode)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            </div>
        </MudItem>

        <MudItem xs="12" md="6">
            <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
            <MudPaper Class="pa-3" Elevation="2" Style="@($"height: 100%;{(!CanProceedWithDetails ? " opacity: 0.5; pointer-events: none;" : "")}")">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />CONSIGNEE DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Consignee" Label="Name" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneePhone" Label="Telephone No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeMobile" Label="Mobile No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.ConsigneeAddress1" Label="Address" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudAutocomplete T="City" Label="Destination City" Value="_selectedConsigneeCity"
                                         SearchFunc="@SearchCities" ToStringFunc="@(c => c?.Name ?? "")"
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true"
                                         ValueChanged="@OnConsigneeCityChanged" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeState" Label="State" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneePostalCode" Label="Pincode" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ConsigneeCountry" Label="Destination Country" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudSelect T="long?" @bind-Value="_inscan.DestinationPortId" Label="Destination Airport" 
                                   Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                                   Disabled="@(_inscan.MovementTypeId != MovementType.InternationalExport)">
                            @foreach (var port in _airports)
                            {
                                <MudSelectItem T="long?" Value="@port.Id">@port.Name (@port.IATACode)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            </div>
        </MudItem>
    </MudGrid>

    <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
    <MudPaper Class="pa-3 mt-3" Elevation="2" Style="@(!CanProceedWithDetails ? "opacity: 0.5; pointer-events: none;" : "")">
        <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Small" Class="mr-1" />BOX DETAILS
        </MudText>
        <MudGrid Spacing="2">
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_inscan.CargoDescription" Label="Description" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="DocumentType" @bind-Value="_inscan.DocumentTypeId" Label="Shipment Type" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Letter">Letter</MudSelectItem>
                    <MudSelectItem T="DocumentType" Value="@DocumentType.Document">Document</MudSelectItem>
                    <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelUpto30Kg">Parcel Upto 30kg</MudSelectItem>
                    <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelAbove30Kg">Parcel Above 30kg</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="int?" @bind-Value="_inscan.ProductTypeId" Label="Service Type" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Clearable="true">
                    @foreach (var serviceType in _serviceTypes)
                    {
                        <MudSelectItem T="int?" Value="@((int)serviceType.Id)">@serviceType.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="MovementType" @bind-Value="_inscan.MovementTypeId" Label="Movement" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="MovementType" Value="@MovementType.Domestic">Domestic</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.InternationalExport">International-Export</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.InternationalImport">International-Import</MudSelectItem>
                    <MudSelectItem T="MovementType" Value="@MovementType.Transhipment">Transhipment</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudSelect T="long?" @bind-Value="_inscan.ShipmentModeId" Label="Inco Terms" 
                           Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter" Clearable="true"
                           Disabled="@(_inscan.MovementTypeId == MovementType.Domestic)">
                    @foreach (var mode in _shipmentModes)
                    {
                        <MudSelectItem T="long?" Value="@mode.Id">@mode.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.Pieces" Label="Units/Pcs" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-3" />

        <MudGrid Spacing="2">
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Length" Label="L (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Width" Label="W (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="4" md="1">
                <MudNumericField @bind-Value="_inscan.Height" Label="H (cm)" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N1" />
            </MudItem>
            <MudItem xs="6" md="1">
                <MudNumericField @bind-Value="_inscan.Weight" Label="Actual Wt" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@VolumetricWeight" Label="Vol. Weight" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@ChargeableWeight" Label="Chg. Weight" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.CustomsValue" Label="Declared Value" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_inscan.SpecialInstructions" Label="Special Instructions" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </MudPaper>
    </div>

    <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
    <MudPaper Class="pa-3 mt-3" Elevation="2" Style="@(!CanProceedWithDetails ? "opacity: 0.5; pointer-events: none;" : "")">
        <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Class="mr-1" />CHARGES
        </MudText>
        <MudGrid Spacing="2">
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.CourierCharge" Label="Freight Charges" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.FuelSurcharge" Label="Fuel Surcharge" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudTextField Value="@((_inscan.OtherCharge ?? 0).ToString("N2"))" Label="ODA/Other Charges" 
                              Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add"
                              OnAdornmentClick="OpenOtherChargesDialog" AdornmentColor="Color.Primary" />
            </MudItem>
            <MudItem xs="12">
                @if (_selectedOtherCharges.Any())
                {
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1">
                        @foreach (var charge in _selectedOtherCharges)
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@charge.ChargeName: @charge.Amount.ToString("N2")</MudChip>
                        }
                        <MudText Typo="Typo.caption"><strong>Total: @_selectedOtherCharges.Sum(c => c.Amount).ToString("N2")</strong></MudText>
                    </MudStack>
                }
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.TaxPercent" Label="Tax %" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField @bind-Value="_inscan.Discount" Label="Discount" 
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
            </MudItem>
            <MudItem xs="6" md="2">
                <MudNumericField Value="@NetTotal" Label="Total Charges" 
                                 Variant="Variant.Filled" Margin="Margin.Dense" Format="N2" ReadOnly="true" 
                                 Style="font-weight: bold;" />
            </MudItem>
            @if (_inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD)
            {
                <MudItem xs="12" md="2">
                    <MudNumericField @bind-Value="_inscan.CODAmount" Label="COD Amount" 
                                     Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                </MudItem>
            }
        </MudGrid>
    </MudPaper>
    </div>

    <MudGrid Spacing="3" Class="mt-3">
        <MudItem xs="12" md="3">
            <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
            <MudPaper Class="pa-3" Elevation="2" Style="@($"height: 100%;{(!CanProceedWithDetails ? " opacity: 0.5; pointer-events: none;" : "")}")">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Class="mr-1" />FORWARDING AGENT
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudAutocomplete T="Party" Label="Forwarding Agent" @bind-Value="_selectedForwardingAgent"
                                         SearchFunc="SearchForwardingAgents" ToStringFunc="@(p => p?.Name ?? "")"
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true"
                                         ShowProgressIndicator="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.ForwardingCharge" Label="Forw. Rate" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="_inscan.ForwardingAWBNo" Label="Forw.Agnt.No" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.SpotRate" Label="Spot Rate" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.MarginPercent" Label="Margin%" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.VerifiedWeight" Label="Verified Wt." 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudNumericField @bind-Value="_inscan.ManifestWeight" Label="Manifest Wt" 
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Format="N2" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_inscan.Remarks" Label="Remarks" 
                                      Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
            </div>
        </MudItem>

        <MudItem xs="12" md="3">
            <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
            <MudPaper Class="pa-3" Elevation="2" Style="@($"height: 100%;{(!CanProceedWithDetails ? " opacity: 0.5; pointer-events: none;" : "")}")">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Class="mr-1" />SHIPPER INSTRUCTIONS
                </MudText>
                <MudStack Spacing="1">
                    <MudCheckBox @bind-Value="_inscan.IsNCND" Label="NCND" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsCashOnly" Label="Cash Only" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsChequeOnly" Label="Cheque Only" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsCollectMaterial" Label="Collect Material" Dense="true" />
                    <MudCheckBox @bind-Value="_inscan.IsDOCopyBack" Label="DOCopyBack" Dense="true" />
                </MudStack>
            </MudPaper>
            </div>
        </MudItem>

        <MudItem xs="12" md="3">
            <div @onclick="@(() => { if (!CanProceedWithDetails) TriggerProceedWarning(); })" style="@(!CanProceedWithDetails ? "cursor: not-allowed;" : "")">
            <MudPaper Class="pa-3" Elevation="2" Style="@($"height: 100%;{(!CanProceedWithDetails ? " opacity: 0.5; pointer-events: none;" : "")}")">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.DeliveryDining" Size="Size.Small" Class="mr-1" />COURIER DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudSelect T="string" @bind-Value="_inscan.PickedBy" Label="Picked By" 
                                   Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                            @foreach (var emp in _courierEmployees)
                            {
                                <MudSelectItem T="string" Value="@emp.Name">@emp.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudSelect T="string" @bind-Value="_inscan.ReceivedBy" Label="Received By" 
                                   Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                            @foreach (var emp in _operationsEmployees)
                            {
                                <MudSelectItem T="string" Value="@emp.Name">@emp.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            </div>
        </MudItem>

        <MudItem xs="12" md="3">
            <MudPaper Class="pa-3" Elevation="2" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Class="mr-1" />AUDIT DETAILS
                </MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12">
                        <MudTextField Value="@_createdBy" Label="Created By" 
                                      Variant="Variant.Filled" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField Value="@_modifiedBy" Label="Modified By" 
                                      Variant="Variant.Filled" Margin="Margin.Dense" ReadOnly="true" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudStack Row="true" Justify="Justify.SpaceBetween" Spacing="2" Class="mt-4">
        <MudStack Row="true" Spacing="2">
            @if (Id > 0)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="@($"/api/report/awb-print/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.Print">
                    Print AWB (A5)
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Info" Href="@($"/api/report/awb/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.Label">
                    Print Label (4x6)
                </MudButton>
                @if (!string.IsNullOrEmpty(_inscan.MAWBNo))
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" Href="@($"/api/report/manifest-label/{Id}")" Target="_blank" StartIcon="@Icons.Material.Filled.LocalShipping">
                        Manifest Label
                    </MudButton>
                }
            }
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" OnClick="Cancel">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@(!_formIsValid || !CanProceedWithDetails)">
                @(Id > 0 ? "Update AWB" : "Save AWB")
            </MudButton>
        </MudStack>
    </MudStack>
</MudForm>

@code {
    [Parameter] public long Id { get; set; }
    [SupplyParameterFromQuery] public bool convertPickup { get; set; }
    [SupplyParameterFromQuery(Name = "portal")] public string? Portal { get; set; }

    private InscanMaster _inscan = new();
    private bool _isCustomerPortal => Portal == "customer";
    private Party? _loggedInCustomerParty;
    private bool _pickupDialogOpened = false;
    private MudForm _form = null!;
    private bool _formIsValid;
    private DateTime? _transactionDate = DateTime.Today;
    private TimeSpan? _bookingTime = DateTime.Now.TimeOfDay;
    private List<Party> _customers = new();
    private List<City> _cities = new();
    private List<Net4Courier.Masters.Entities.ShipmentMode> _shipmentModes = new();
    private List<Net4Courier.Masters.Entities.ServiceType> _serviceTypes = new();
    private List<Port> _airports = new();
    private long? _controlAccountId;
    private string _controlAccountName = "";
    private bool _copyCustomerToShipper;
    private City? _selectedConsignorCity;
    private City? _selectedConsigneeCity;
    private List<Party> _forwardingAgents = new();
    private Party? _selectedForwardingAgent;
    private List<Employee> _courierEmployees = new();
    private List<Employee> _operationsEmployees = new();
    private string _currentUserName = "";
    private int? _currentUserId;
    private string _createdBy = "";
    private string _modifiedBy = "";
    
    private bool _autoGenerateAWB = true;
    private bool _showProceedWarning = false;
    private Branch? _currentBranch;
    private string _nextAWBPreview = "";
    private PickupRequest? _sourcePickupRequest;
    private PickupRequestShipment? _sourceShipment;
    private List<OtherChargeSelection> _selectedOtherCharges = new();
    
    private bool _isPrepaidAWB = false;
    private bool _paymentModeDisabled = false;
    private string _prepaidCustomerName = "";
    private long? _prepaidCustomerId;
    private PaymentMode _previousPaymentMode = default;
    private long? _previousCustomerId = null;

    private decimal VolumetricWeight => (_inscan.Length ?? 0) * (_inscan.Width ?? 0) * (_inscan.Height ?? 0) / 5000;
    private decimal ChargeableWeight => Math.Max(_inscan.Weight ?? 0, VolumetricWeight);
    private decimal NetTotal => ((_inscan.CourierCharge ?? 0) + (_inscan.OtherCharge ?? 0) + (_inscan.FuelSurcharge ?? 0)) 
                                * (1 + (_inscan.TaxPercent ?? 0) / 100) - (_inscan.Discount ?? 0);
    
    private bool CanProceedWithDetails => ((_autoGenerateAWB && Id == 0) || !string.IsNullOrWhiteSpace(_inscan.AWBNo)) && 
                                           _inscan.PaymentModeId != default && 
                                           (IsCustomerRequired() ? _inscan.CustomerId.HasValue : true);
    
    private bool IsCustomerRequired() => _inscan.PaymentModeId == PaymentMode.Account;
    
    private string GetProceedWarningMessage()
    {
        var missing = new List<string>();
        if (!(_autoGenerateAWB && Id == 0) && string.IsNullOrWhiteSpace(_inscan.AWBNo))
            missing.Add("AWB Number");
        if (_inscan.PaymentModeId == default)
            missing.Add("Payment Mode");
        if (IsCustomerRequired() && !_inscan.CustomerId.HasValue)
            missing.Add("Customer Account");
        return $"Please fill: {string.Join(", ", missing)}";
    }
    
    private void OnAutoGenerateToggleChanged()
    {
        if (_autoGenerateAWB && Id == 0)
        {
            _inscan.AWBNo = _nextAWBPreview;
        }
        else if (!_autoGenerateAWB && Id == 0)
        {
            _inscan.AWBNo = "";
        }
        StateHasChanged();
    }
    
    private void TriggerProceedWarning()
    {
        if (!CanProceedWithDetails)
        {
            _showProceedWarning = true;
            StateHasChanged();
        }
    }
    
    private async Task OnAWBNoChanged()
    {
        if (string.IsNullOrWhiteSpace(_inscan.AWBNo))
        {
            await ResetPrepaidState();
            return;
        }
        
        var prepaidAwb = await DbContext.PrepaidAWBs
            .Include(p => p.PrepaidDocument)
            .FirstOrDefaultAsync(p => p.AWBNo == _inscan.AWBNo && !p.IsUsed && !p.IsDeleted);
        
        if (prepaidAwb != null)
        {
            if (!_isPrepaidAWB)
            {
                _previousPaymentMode = _inscan.PaymentModeId;
                _previousCustomerId = _inscan.CustomerId;
            }
            
            _isPrepaidAWB = true;
            _paymentModeDisabled = true;
            _prepaidCustomerId = prepaidAwb.PrepaidDocument.CustomerId;
            _prepaidCustomerName = prepaidAwb.PrepaidDocument.CustomerName ?? "";
            
            _inscan.PaymentModeId = PaymentMode.Prepaid;
            _inscan.CustomerId = _prepaidCustomerId;
            
            await LoadPaymentModeAccount(PaymentMode.Prepaid);
            
            Snackbar.Add($"Prepaid AWB detected - Customer: {_prepaidCustomerName}", Severity.Info);
        }
        else
        {
            await ResetPrepaidState();
        }
        
        StateHasChanged();
    }
    
    private async Task ResetPrepaidState()
    {
        if (_isPrepaidAWB)
        {
            _inscan.PaymentModeId = _previousPaymentMode;
            _inscan.CustomerId = _previousCustomerId;
            _controlAccountId = null;
            _controlAccountName = "";
            
            if (_previousPaymentMode != default)
            {
                await LoadPaymentModeAccount(_previousPaymentMode);
            }
        }
        _isPrepaidAWB = false;
        _paymentModeDisabled = false;
        _prepaidCustomerName = "";
        _prepaidCustomerId = null;
        _previousPaymentMode = default;
        _previousCustomerId = null;
    }
    
    private async Task OnPaymentModeChanged()
    {
        var previousCustomerId = _inscan.CustomerId;
        _inscan.CustomerId = null;
        _copyCustomerToShipper = false;
        
        await LoadPaymentModeAccount(_inscan.PaymentModeId);
        
        // If switching to Account mode and there was a customer selected, re-select and auto-populate
        if (_inscan.PaymentModeId == PaymentMode.Account && previousCustomerId.HasValue)
        {
            _inscan.CustomerId = previousCustomerId;
            _copyCustomerToShipper = true;
            ApplyCustomerToShipper();
        }
    }
    
    private async Task LoadPaymentModeAccount(PaymentMode paymentMode)
    {
        _controlAccountId = null;
        _controlAccountName = "";
        
        if (paymentMode == PaymentMode.COD || paymentMode == PaymentMode.CAD)
        {
            var controlType = paymentMode == PaymentMode.COD ? ControlAccountType.CODControl : ControlAccountType.CADControl;
            var setting = await DbContext.ControlAccountSettings
                .Include(s => s.AccountHead)
                .FirstOrDefaultAsync(s => s.AccountType == controlType && !s.IsDeleted);
            if (setting?.AccountHead != null)
            {
                _controlAccountId = setting.AccountHeadId;
                _controlAccountName = setting.AccountHead.Name;
            }
            else
            {
                _controlAccountName = paymentMode == PaymentMode.COD ? "COD Control (Not Configured)" : "CAD Control (Not Configured)";
            }
        }
        else if (paymentMode == PaymentMode.Prepaid)
        {
            var setting = await DbContext.ControlAccountSettings
                .Include(s => s.AccountHead)
                .FirstOrDefaultAsync(s => s.AccountType == ControlAccountType.PrepaidControl && !s.IsDeleted);
            if (setting?.AccountHead != null)
            {
                _controlAccountId = setting.AccountHeadId;
                _controlAccountName = setting.AccountHead.Name;
            }
            else
            {
                _controlAccountName = "Prepaid Control (Not Configured)";
            }
        }
        else if (paymentMode == PaymentMode.PickupCash)
        {
            var setting = await DbContext.ControlAccountSettings
                .Include(s => s.AccountHead)
                .FirstOrDefaultAsync(s => s.AccountType == ControlAccountType.CashAccount && !s.IsDeleted);
            if (setting?.AccountHead != null)
            {
                _controlAccountId = setting.AccountHeadId;
                _controlAccountName = setting.AccountHead.Name;
            }
            else
            {
                _controlAccountName = "Cash Account (Not Configured)";
            }
        }
    }
    
    private void OnCustomerChanged()
    {
        // Auto-populate shipper details when customer is selected for Account payment
        if (_inscan.PaymentModeId == PaymentMode.Account && _inscan.CustomerId.HasValue)
        {
            _copyCustomerToShipper = true;
            ApplyCustomerToShipper();
        }
        else
        {
            _copyCustomerToShipper = false;
        }
    }
    
    private void ApplyCustomerToShipper()
    {
        if (!_inscan.CustomerId.HasValue) return;
        
        var customer = _customers.FirstOrDefault(c => c.Id == _inscan.CustomerId.Value);
        if (customer != null)
        {
            _inscan.Consignor = customer.Name;
            _inscan.ConsignorPhone = customer.Phone;
            _inscan.ConsignorMobile = customer.Mobile;
            
            var primaryAddress = customer.Addresses.FirstOrDefault(a => a.AddressType == "Primary" && !a.IsDeleted) 
                                 ?? customer.Addresses.FirstOrDefault(a => !a.IsDeleted);
            if (primaryAddress != null)
            {
                var addressParts = new[] { primaryAddress.BuildingName, primaryAddress.Street, primaryAddress.Area }
                    .Where(s => !string.IsNullOrWhiteSpace(s));
                _inscan.ConsignorAddress1 = string.Join(", ", addressParts);
                _inscan.ConsignorCity = primaryAddress.City;
                _inscan.ConsignorState = primaryAddress.State;
                _inscan.ConsignorCountry = primaryAddress.Country;
                _inscan.ConsignorPostalCode = primaryAddress.PostalCode;
                
                var city = _cities.FirstOrDefault(c => 
                    c.Name == primaryAddress.City && 
                    (c.Country?.Name == primaryAddress.Country || c.State?.Name == primaryAddress.State));
                if (city == null)
                    city = _cities.FirstOrDefault(c => c.Name == primaryAddress.City);
                if (city != null)
                {
                    _selectedConsignorCity = city;
                }
            }
        }
    }
    
    private void OnCopyToShipperChanged()
    {
        if (_copyCustomerToShipper && _inscan.CustomerId.HasValue)
        {
            ApplyCustomerToShipper();
        }
        else if (!_copyCustomerToShipper)
        {
            // Clear shipper details when unchecked
            _inscan.Consignor = null;
            _inscan.ConsignorPhone = null;
            _inscan.ConsignorMobile = null;
            _inscan.ConsignorAddress1 = null;
            _inscan.ConsignorCity = null;
            _inscan.ConsignorState = null;
            _inscan.ConsignorCountry = null;
            _inscan.ConsignorPostalCode = null;
            _selectedConsignorCity = null;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        
        _customers = await DbContext.Parties.Include(p => p.Addresses).Where(p => p.PartyType == PartyType.Customer && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        _forwardingAgents = await DbContext.Parties.Where(p => p.PartyType == PartyType.ForwardingAgent && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        _cities = await DbContext.Cities.Include(c => c.Country).Include(c => c.State).Where(c => c.IsActive).OrderBy(c => c.Name).ToListAsync();
        _shipmentModes = await DbContext.ShipmentModes.Where(s => s.IsActive && !s.IsDeleted).OrderBy(s => s.SortOrder).ToListAsync();
        _serviceTypes = await DbContext.ServiceTypes.Where(s => s.IsActive && !s.IsDeleted).OrderBy(s => s.SortOrder).ToListAsync();
        _airports = await DbContext.Ports.Where(p => p.PortType == PortType.Airport && p.IsActive && !p.IsDeleted).OrderBy(p => p.Name).ToListAsync();
        _courierEmployees = await DbContext.Employees.Include(e => e.Designation).Include(e => e.Department).Where(e => e.IsActive && (e.Designation!.Name == "Courier" || e.Department!.Name == "Couriers")).OrderBy(e => e.Name).ToListAsync();
        _operationsEmployees = await DbContext.Employees.Include(e => e.Department).Where(e => e.IsActive && e.Department!.Name == "Operations").OrderBy(e => e.Name).ToListAsync();
        
        _currentBranch = await DbContext.Branches.Include(b => b.Country).FirstOrDefaultAsync(b => !b.IsDeleted && b.IsActive);
        if (_currentBranch != null)
        {
            _nextAWBPreview = await AWBNumberService.PreviewNextAWBNumber(_currentBranch.Id);
        }
        
        // Customer Portal: Load logged-in customer's Party based on user email
        if (_isCustomerPortal)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;
                if (long.TryParse(userIdClaim, out var userId))
                {
                    var dbUser = await DbContext.Users.FindAsync(userId);
                    if (dbUser != null)
                    {
                        _loggedInCustomerParty = await DbContext.Parties
                            .Include(p => p.Addresses)
                            .FirstOrDefaultAsync(p => p.Email == dbUser.Email && p.PartyType == PartyType.Customer && !p.IsDeleted);
                    }
                }
            }
        }

        if (Id > 0)
        {
            _autoGenerateAWB = false;
            var existing = await DbContext.InscanMasters.FindAsync(Id);
            if (existing != null)
            {
                _inscan = existing;
                _transactionDate = _inscan.TransactionDate.ToLocalTime();
                _bookingTime = _inscan.TransactionDate.ToLocalTime().TimeOfDay;
                _createdBy = $"{_inscan.CreatedByName ?? "Unknown"} | {_inscan.CreatedAt:dd-MMM}";
                _modifiedBy = _inscan.ModifiedAt.HasValue ? $"{_inscan.ModifiedByName ?? "Unknown"} | {_inscan.ModifiedAt:dd-MMM}" : "";
                _selectedForwardingAgent = _forwardingAgents.FirstOrDefault(p => p.Id == _inscan.ForwardingAgentId);
                await LoadExistingOtherCharges();
                SyncSelectedCitiesFromInscan();
            }
        }
        else
        {
            if (_autoGenerateAWB && _currentBranch != null)
            {
                _inscan.AWBNo = _nextAWBPreview;
            }
            else
            {
                _inscan.AWBNo = await GenerateFallbackAWBNo();
            }
            _inscan.TransactionDate = DateTime.UtcNow;
            _inscan.ConsignorCountry = "India";
            _inscan.ConsigneeCountry = "India";
            
            // Customer Portal: Auto-fill Payment Mode = Account, Customer, and Shipper details
            if (_isCustomerPortal && _loggedInCustomerParty != null)
            {
                _inscan.PaymentModeId = PaymentMode.Account;
                _inscan.CustomerId = _loggedInCustomerParty.Id;
                _copyCustomerToShipper = true;
                
                // Auto-populate shipper/consignor from customer
                _inscan.Consignor = _loggedInCustomerParty.Name;
                _inscan.ConsignorPhone = _loggedInCustomerParty.Phone;
                _inscan.ConsignorMobile = _loggedInCustomerParty.Mobile;
                
                var primaryAddress = _loggedInCustomerParty.Addresses
                    .Where(a => !a.IsDeleted)
                    .FirstOrDefault(a => a.AddressType == "Primary") 
                    ?? _loggedInCustomerParty.Addresses.FirstOrDefault(a => !a.IsDeleted);
                
                if (primaryAddress != null)
                {
                    var addressParts = new[] { primaryAddress.BuildingName, primaryAddress.Street, primaryAddress.Area }
                        .Where(s => !string.IsNullOrWhiteSpace(s));
                    _inscan.ConsignorAddress1 = string.Join(", ", addressParts);
                    _inscan.ConsignorCity = primaryAddress.City;
                    _inscan.ConsignorState = primaryAddress.State;
                    _inscan.ConsignorCountry = primaryAddress.Country;
                    _inscan.ConsignorPostalCode = primaryAddress.PostalCode;
                    
                    var city = _cities.FirstOrDefault(c => 
                        c.Name == primaryAddress.City && 
                        (c.Country?.Name == primaryAddress.Country || c.State?.Name == primaryAddress.State));
                    if (city == null)
                        city = _cities.FirstOrDefault(c => c.Name == primaryAddress.City);
                    if (city != null)
                    {
                        _selectedConsignorCity = city;
                    }
                }
            }
        }
        
        await LoadPaymentModeAccount(_inscan.PaymentModeId);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && convertPickup && Id == 0 && !_pickupDialogOpened)
        {
            _pickupDialogOpened = true;
            await OpenPickupRequestSelector();
            StateHasChanged();
        }
    }

    private async Task<string> GenerateFallbackAWBNo()
    {
        var today = DateTime.Today.ToString("yyyyMMdd");
        var count = await DbContext.InscanMasters.CountAsync(i => i.AWBNo.StartsWith(today)) + 1;
        return $"{today}{count:D4}";
    }
    
    private Task<IEnumerable<City>> SearchCities(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(_cities.Take(20).AsEnumerable());
        
        var matches = _cities.Where(c => c.Name.Contains(value, StringComparison.OrdinalIgnoreCase)).Take(20);
        return Task.FromResult(matches.AsEnumerable());
    }

    private Task<IEnumerable<Party>> SearchForwardingAgents(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(_forwardingAgents.Take(20).AsEnumerable());
        
        var matches = _forwardingAgents.Where(p => p.Name.Contains(value, StringComparison.OrdinalIgnoreCase)).Take(20);
        return Task.FromResult(matches.AsEnumerable());
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;
                if (int.TryParse(userIdClaim, out var userId))
                {
                    _currentUserId = userId;
                }
                
                _currentUserName = user.FindFirst("FullName")?.Value 
                    ?? user.FindFirst(ClaimTypes.Name)?.Value 
                    ?? user.Identity.Name 
                    ?? "Unknown User";
            }
        }
        catch
        {
            _currentUserName = "System User";
        }
    }
    
    private void OnConsignorCityChanged(City? city)
    {
        _selectedConsignorCity = city;
        if (city != null)
        {
            _inscan.ConsignorCity = city.Name;
            // Force update state and country from the selected city's data
            var cityData = _cities.FirstOrDefault(c => c.Id == city.Id);
            _inscan.ConsignorState = cityData?.State?.Name ?? city.State?.Name ?? "";
            _inscan.ConsignorCountry = cityData?.Country?.Name ?? city.Country?.Name ?? "";
        }
        else
        {
            _inscan.ConsignorCity = "";
            _inscan.ConsignorState = "";
            _inscan.ConsignorCountry = "";
        }
        CalculateMovementType();
        StateHasChanged();
    }
    
    private void OnConsigneeCityChanged(City? city)
    {
        _selectedConsigneeCity = city;
        if (city != null)
        {
            _inscan.ConsigneeCity = city.Name;
            // Force update state and country from the selected city's data
            var cityData = _cities.FirstOrDefault(c => c.Id == city.Id);
            _inscan.ConsigneeState = cityData?.State?.Name ?? city.State?.Name ?? "";
            _inscan.ConsigneeCountry = cityData?.Country?.Name ?? city.Country?.Name ?? "";
        }
        else
        {
            _inscan.ConsigneeCity = "";
            _inscan.ConsigneeState = "";
            _inscan.ConsigneeCountry = "";
        }
        CalculateMovementType();
        StateHasChanged();
    }
    
    private void CalculateMovementType()
    {
        if (_currentBranch?.CountryId == null)
            return;
        
        var branchCountryId = _currentBranch.CountryId;
        var originCountryId = _selectedConsignorCity?.CountryId;
        var destCountryId = _selectedConsigneeCity?.CountryId;
        
        // Only calculate when both cities are set - leave unchanged otherwise
        if (originCountryId == null || destCountryId == null)
            return;
        
        bool originIsBranch = originCountryId == branchCountryId;
        bool destIsBranch = destCountryId == branchCountryId;
        
        if (originIsBranch && destIsBranch)
        {
            // Domestic: Both origin and destination are branch country
            _inscan.MovementTypeId = MovementType.Domestic;
        }
        else if (originIsBranch && !destIsBranch)
        {
            // Export: Origin is branch country, destination is foreign
            _inscan.MovementTypeId = MovementType.InternationalExport;
        }
        else if (!originIsBranch && destIsBranch)
        {
            // Import: Origin is foreign, destination is branch country
            _inscan.MovementTypeId = MovementType.InternationalImport;
        }
        else
        {
            // Transhipment: Both origin and destination are foreign
            _inscan.MovementTypeId = MovementType.Transhipment;
        }
    }
    
    private void SyncSelectedCitiesFromInscan()
    {
        if (!string.IsNullOrWhiteSpace(_inscan.ConsignorCity))
        {
            _selectedConsignorCity = _cities.FirstOrDefault(c => c.Name.Equals(_inscan.ConsignorCity, StringComparison.OrdinalIgnoreCase));
        }
        if (!string.IsNullOrWhiteSpace(_inscan.ConsigneeCity))
        {
            _selectedConsigneeCity = _cities.FirstOrDefault(c => c.Name.Equals(_inscan.ConsigneeCity, StringComparison.OrdinalIgnoreCase));
        }
    }
    
    private async Task OpenPickupRequestSelector()
    {
        var dialog = await DialogService.ShowAsync<PickupRequestSelectDialog>("Select Pickup Request", 
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is PickupConversionResult conversionResult)
        {
            _sourcePickupRequest = conversionResult.PickupRequest;
            _sourceShipment = conversionResult.Shipment;
            await PopulateFromPickupRequest();
        }
    }
    
    private async Task OpenBulkUploadDialog()
    {
        var customerDialog = await DialogService.ShowAsync<SelectCustomerForUploadDialog>("Select Customer",
            new DialogOptions { MaxWidth = MaxWidth.Small, CloseOnEscapeKey = true });
        var customerResult = await customerDialog.Result;
        
        if (customerResult!.Canceled || customerResult.Data is not Party selectedCustomer)
            return;
        
        var parameters = new DialogParameters<BulkShipmentUploadDialog>
        {
            { x => x.BranchId, _currentBranch?.Id },
            { x => x.CompanyId, _inscan.CompanyId },
            { x => x.FinancialYearId, _inscan.FinancialYearId },
            { x => x.DefaultOriginCountry, "UAE" },
            { x => x.CustomerId, selectedCustomer.Id },
            { x => x.CustomerName, selectedCustomer.Name }
        };
        
        var dialog = await DialogService.ShowAsync<BulkShipmentUploadDialog>("Bulk Shipment Upload", 
            parameters, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true, CloseOnEscapeKey = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is int createdCount && createdCount > 0)
        {
            Snackbar.Add($"{createdCount} shipments were created. Go to AWB List to view them.", Severity.Info);
        }
    }
    
    private Task PopulateFromPickupRequest()
    {
        if (_sourcePickupRequest == null) return Task.CompletedTask;
        
        _inscan.PickupRequestId = _sourcePickupRequest.Id;
        
        _inscan.CustomerId = _sourcePickupRequest.CustomerId;
        _inscan.Consignor = _sourcePickupRequest.CustomerName;
        _inscan.ConsignorPhone = _sourcePickupRequest.Phone;
        _inscan.ConsignorMobile = _sourcePickupRequest.Mobile;
        _inscan.ConsignorAddress1 = _sourcePickupRequest.PickupAddress;
        _inscan.ConsignorCity = _sourcePickupRequest.City;
        _inscan.ConsignorState = _sourcePickupRequest.State;
        _inscan.ConsignorCountry = _sourcePickupRequest.Country ?? "India";
        _inscan.ConsignorPostalCode = _sourcePickupRequest.PostalCode;
        _inscan.ReferenceNo = _sourcePickupRequest.ReferenceNo;
        
        if (_sourceShipment != null)
        {
            _inscan.PickupRequestShipmentId = _sourceShipment.Id;
            
            _inscan.Consignee = _sourceShipment.Consignee;
            _inscan.ConsigneePhone = _sourceShipment.ConsigneePhone;
            _inscan.ConsigneeMobile = _sourceShipment.ConsigneeMobile;
            _inscan.ConsigneeAddress1 = _sourceShipment.ConsigneeAddress1;
            _inscan.ConsigneeCity = _sourceShipment.ConsigneeCity;
            _inscan.ConsigneeState = _sourceShipment.ConsigneeState;
            _inscan.ConsigneeCountry = _sourceShipment.ConsigneeCountry ?? "India";
            _inscan.ConsigneePostalCode = _sourceShipment.ConsigneePostalCode;
            
            _inscan.Pieces = _sourceShipment.Pieces ?? 1;
            _inscan.Weight = _sourceShipment.Weight;
            _inscan.Length = _sourceShipment.Length;
            _inscan.Width = _sourceShipment.Width;
            _inscan.Height = _sourceShipment.Height;
            _inscan.VolumetricWeight = _sourceShipment.VolumetricWeight;
            
            _inscan.CargoDescription = _sourceShipment.CargoDescription;
            _inscan.SpecialInstructions = _sourceShipment.SpecialInstructions;
            if (!string.IsNullOrEmpty(_sourceShipment.ReferenceNo))
            {
                _inscan.ReferenceNo = _sourceShipment.ReferenceNo;
            }
            
            _inscan.PaymentModeId = _sourceShipment.PaymentModeId;
            _inscan.DocumentTypeId = _sourceShipment.DocumentTypeId;
            
            if (!string.IsNullOrEmpty(_sourceShipment.AWBNo))
            {
                _inscan.AWBNo = _sourceShipment.AWBNo;
                _autoGenerateAWB = false;
            }
            else if (_autoGenerateAWB && _currentBranch != null)
            {
                _inscan.AWBNo = _nextAWBPreview;
            }
        }
        
        SyncSelectedCitiesFromInscan();
        Snackbar.Add($"Loaded data from Pickup Request {_sourcePickupRequest.PickupNo}", Severity.Info);
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void ClearPickupSource()
    {
        _sourcePickupRequest = null;
        _sourceShipment = null;
        _inscan.PickupRequestId = null;
        _inscan.PickupRequestShipmentId = null;
    }

    private async Task Save()
    {
        var validationErrors = ValidateRequiredFields();
        if (validationErrors.Count > 0)
        {
            foreach (var error in validationErrors)
            {
                Snackbar.Add(error, Severity.Error);
            }
            return;
        }

        await _form.Validate();
        if (!_formIsValid) return;

        try
        {
            if (_transactionDate.HasValue)
            {
                var date = _transactionDate.Value.Date;
                if (_bookingTime.HasValue)
                    date = date.Add(_bookingTime.Value);
                _inscan.TransactionDate = DateTime.SpecifyKind(date, DateTimeKind.Utc);
            }

            _inscan.VolumetricWeight = VolumetricWeight;
            _inscan.ChargeableWeight = ChargeableWeight;
            _inscan.NetTotal = NetTotal;
            _inscan.IsCOD = _inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD;
            _inscan.ForwardingAgentId = _selectedForwardingAgent?.Id;

            if (Id == 0)
            {
                if (_autoGenerateAWB && _currentBranch != null)
                {
                    _inscan.AWBNo = await AWBNumberService.GenerateNextAWBNumber(_currentBranch.Id);
                    _inscan.IsAutoGenerated = true;
                }
                
                _inscan.CreatedAt = DateTime.UtcNow;
                _inscan.CreatedBy = _currentUserId;
                _inscan.CreatedByName = _currentUserName;
                _inscan.CourierStatusId = CourierStatus.Pending;
                
                var (barcodeH, barcodeV) = BarcodeService.GenerateBothBarcodes(_inscan.AWBNo);
                _inscan.BarcodeImage = barcodeH;
                _inscan.BarcodeImageVertical = barcodeV;
                
                DbContext.InscanMasters.Add(_inscan);
                await DbContext.SaveChangesAsync();
                
                var pickupNoRef = _inscan.PickupRequestId.HasValue ? $" (from Pickup Request)" : "";
                await ShipmentStatusService.SetStatus(
                    _inscan.Id, "PICKUP_REQUESTED", "AWBEntry", _inscan.PickupRequestId, "PickupRequest",
                    null, _inscan.ConsignorCity, null, null,
                    $"AWB {_inscan.AWBNo} created{pickupNoRef}", isAutomatic: false);
                
                if (_inscan.PickupRequestId.HasValue && _inscan.PickupRequestShipmentId.HasValue)
                {
                    var shipmentLine = await DbContext.PickupRequestShipments.FindAsync(_inscan.PickupRequestShipmentId.Value);
                    if (shipmentLine != null)
                    {
                        shipmentLine.AWBId = _inscan.Id;
                        shipmentLine.AWBNo = _inscan.AWBNo;
                        shipmentLine.Status = ShipmentLineStatus.Booked;
                        shipmentLine.BookedAt = DateTime.UtcNow;
                    }
                    
                    var pickupRequest = await DbContext.PickupRequests
                        .Include(p => p.Shipments)
                        .FirstOrDefaultAsync(p => p.Id == _inscan.PickupRequestId.Value);
                        
                    if (pickupRequest != null)
                    {
                        var allBooked = pickupRequest.Shipments.All(s => s.Status == ShipmentLineStatus.Booked || s.Status == ShipmentLineStatus.Cancelled);
                        if (allBooked)
                        {
                            pickupRequest.IsConverted = true;
                            pickupRequest.ConvertedAt = DateTime.UtcNow;
                        }
                    }
                    
                    await DbContext.SaveChangesAsync();
                }
            }
            else
            {
                _inscan.ModifiedAt = DateTime.UtcNow;
                _inscan.ModifiedBy = _currentUserId;
                _inscan.ModifiedByName = _currentUserName;
                DbContext.InscanMasters.Update(_inscan);
                await DbContext.SaveChangesAsync();
            }
            
            await SaveOtherCharges();

            Snackbar.Add(Id > 0 ? "AWB updated successfully" : "AWB created successfully", Severity.Success);
            NavigationManager.NavigateTo("/awb-list");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving AWB: {ex.Message}", Severity.Error);
        }
    }

    private List<string> ValidateRequiredFields()
    {
        var errors = new List<string>();

        if (!_autoGenerateAWB && Id == 0 && string.IsNullOrWhiteSpace(_inscan.AWBNo))
            errors.Add("AWB Number is required");

        if (!_transactionDate.HasValue)
            errors.Add("Booking Date is required");

        if (string.IsNullOrWhiteSpace(_inscan.Consignor))
            errors.Add("Shipper/Consignor Name is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsignorAddress1))
            errors.Add("Shipper Address is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsignorCity))
            errors.Add("Shipper City is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsignorCountry))
            errors.Add("Shipper Country is required");

        if (string.IsNullOrWhiteSpace(_inscan.Consignee))
            errors.Add("Consignee Name is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsigneeAddress1))
            errors.Add("Consignee Address is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsigneeCity))
            errors.Add("Consignee City is required");

        if (string.IsNullOrWhiteSpace(_inscan.ConsigneeCountry))
            errors.Add("Consignee Country is required");

        if (_inscan.Pieces <= 0)
            errors.Add("Number of Pieces must be greater than 0");

        if (_inscan.Weight <= 0)
            errors.Add("Weight must be greater than 0");

        if (_inscan.PaymentModeId == PaymentMode.Account && !_inscan.CustomerId.HasValue && !_isPrepaidAWB)
            errors.Add("Customer Account is required for Account payment mode");

        if ((_inscan.PaymentModeId == PaymentMode.COD || _inscan.PaymentModeId == PaymentMode.CAD) && _inscan.CODAmount <= 0)
            errors.Add("COD Amount is required for COD/CAD payment mode");

        return errors;
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/awb-list");
    }

    private async Task OpenOtherChargesDialog()
    {
        var existingCharges = _selectedOtherCharges.Select(c => new AWBOtherCharge
        {
            OtherChargeTypeId = c.ChargeTypeId,
            Amount = c.Amount
        }).ToList();
        var parameters = new DialogParameters<OtherChargesDialog>
        {
            { x => x.ExistingCharges, existingCharges }
        };
        var dialog = await DialogService.ShowAsync<OtherChargesDialog>("Select Other Charges", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is List<AWBOtherCharge> selectedCharges)
        {
            var chargeTypes = await DbContext.OtherChargeTypes.ToListAsync();
            _selectedOtherCharges = selectedCharges.Select(c => new OtherChargeSelection
            {
                ChargeTypeId = c.OtherChargeTypeId,
                ChargeName = chargeTypes.FirstOrDefault(ct => ct.Id == c.OtherChargeTypeId)?.Name ?? "Unknown",
                Amount = c.Amount
            }).ToList();
            _inscan.OtherCharge = _selectedOtherCharges.Sum(c => c.Amount);
        }
    }

    private async Task LoadExistingOtherCharges()
    {
        if (Id > 0)
        {
            var charges = await DbContext.AWBOtherCharges
                .Include(c => c.OtherChargeType)
                .Where(c => c.InscanId == Id)
                .ToListAsync();
            _selectedOtherCharges = charges.Select(c => new OtherChargeSelection
            {
                ChargeTypeId = c.OtherChargeTypeId,
                ChargeName = c.OtherChargeType?.Name ?? "Unknown",
                Amount = c.Amount
            }).ToList();
            _inscan.OtherCharge = _selectedOtherCharges.Sum(c => c.Amount);
        }
    }

    private async Task SaveOtherCharges()
    {
        var inscanId = _inscan.Id;
        if (inscanId > 0)
        {
            var existingCharges = await DbContext.AWBOtherCharges.Where(c => c.InscanId == inscanId).ToListAsync();
            DbContext.AWBOtherCharges.RemoveRange(existingCharges);

            foreach (var charge in _selectedOtherCharges)
            {
                DbContext.AWBOtherCharges.Add(new AWBOtherCharge
                {
                    InscanId = inscanId,
                    OtherChargeTypeId = charge.ChargeTypeId,
                    Amount = charge.Amount
                });
            }
            await DbContext.SaveChangesAsync();
        }
    }

    private class OtherChargeSelection
    {
        public long ChargeTypeId { get; set; }
        public string ChargeName { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }
}

@page "/customer/dashboard"
@layout CustomerLayout
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>My Dashboard - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            @if (!string.IsNullOrEmpty(_company?.Logo) && !_logoLoadFailed)
            {
                <img src="@GetLogoDataUrl()" 
                     alt="@(_company.Name ?? "Company Logo")" 
                     style="height: 60px; object-fit: contain;"
                     @onerror="OnLogoLoadError" />
            }
            else if (!string.IsNullOrEmpty(_company?.Name))
            {
                <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 60px; height: 60px; font-size: 1.5rem;">
                    @(_company.Name.Substring(0, Math.Min(2, _company.Name.Length)).ToUpper())
                </MudAvatar>
            }
            <MudStack Spacing="0">
                <MudText Typo="Typo.h5">Welcome, @_customerName</MudText>
                @if (!string.IsNullOrEmpty(_company?.Name))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_company.Name</MudText>
                }
            </MudStack>
        </MudStack>
    </MudStack>
    
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-pickups"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.TotalPickups</MudText>
                        <MudText Typo="Typo.body2">Pickup Requests</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=pending"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Pending</MudText>
                        <MudText Typo="Typo.body2">Pending</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=intransit"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.FlightTakeoff" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.InTransit</MudText>
                        <MudText Typo="Typo.body2">In Transit</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=delivered"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Delivered</MudText>
                        <MudText Typo="Typo.body2">Delivered</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    
    <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=returned"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Undo" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Returned</MudText>
                        <MudText Typo="Typo.body2">Returned</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=outfordelivery"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.DirectionsBike" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.OutForDelivery</MudText>
                        <MudText Typo="Typo.body2">Out for Delivery</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.TotalShipments</MudText>
                        <MudText Typo="Typo.body2">Total Shipments</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-tickets"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.OpenTickets</MudText>
                        <MudText Typo="Typo.body2">Open Tickets</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    
    <MudGrid Class="mt-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Pickups</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateTo("/customer/my-pickups"))">View All</MudButton>
                </MudStack>
                
                @if (_recentPickups.Any())
                {
                    <MudList T="PickupRequest">
                        @foreach (var pickup in _recentPickups)
                        {
                            <MudListItem T="PickupRequest">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.subtitle2">@pickup.PickupNo</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @pickup.RequestDate.ToString("dd MMM yyyy") - @(pickup.Shipments?.Count ?? 0) shipment(s)
                                        </MudText>
                                    </MudStack>
                                    <MudChip T="string" Color="@GetStatusColor(pickup.Status)" Size="Size.Small">@pickup.Status</MudChip>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No pickup requests yet</MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Shipments</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateTo("/customer/my-shipments"))">View All</MudButton>
                </MudStack>
                
                @if (_recentShipments.Any())
                {
                    <MudList T="InscanMaster">
                        @foreach (var awb in _recentShipments)
                        {
                            <MudListItem T="InscanMaster">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.subtitle2">@awb.AWBNo</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            To: @awb.Consignee - @awb.ConsigneeCity
                                        </MudText>
                                    </MudStack>
                                    <MudChip T="string" Color="@GetAWBStatusColor(awb.CourierStatusId)" Size="Size.Small">@awb.CourierStatusId</MudChip>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No shipments yet</MudAlert>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
    
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" GutterBottom="true" Align="Align.Center">Quick Actions</MudText>
        <MudGrid Justify="Justify.Center" Spacing="3">
            <MudItem xs="6" sm="4" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => NavigateTo("/customer/pickup-request"))">
                    Create Request
                </MudButton>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Timeline" OnClick="@(() => NavigateTo("/customer/track"))">
                    Timeline
                </MudButton>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Warning" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Receipt" OnClick="@(() => NavigateTo("/customer/invoices"))">
                    Invoice
                </MudButton>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth="true"
                           StartIcon="@Icons.Material.Filled.MenuBook" OnClick="@(() => NavigateTo("/customer/ledger"))">
                    Ledger
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    private string _customerName = "Customer";
    private long? _customerId;
    private DashboardStats _stats = new();
    private List<PickupRequest> _recentPickups = new();
    private List<InscanMaster> _recentShipments = new();
    private Company? _company;
    private bool _logoLoadFailed = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanyInfo();
        await LoadCustomerInfo();
        await LoadStats();
        await LoadRecentData();
    }

    private async Task LoadCompanyInfo()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _company = await dbContext.Companies
            .FirstOrDefaultAsync(c => c.IsActive && !c.IsDeleted);
    }

    private async Task LoadCustomerInfo()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId")?.Value;
            if (long.TryParse(userIdClaim, out var userId))
            {
                var dbUser = await dbContext.Users.FindAsync(userId);
                if (dbUser != null)
                {
                    _customerName = dbUser.FullName ?? dbUser.Username;
                    
                    var party = await dbContext.Parties
                        .FirstOrDefaultAsync(p => p.Email == dbUser.Email && !p.IsDeleted);
                    if (party != null)
                    {
                        _customerId = party.Id;
                    }
                }
            }
        }
    }

    private async Task LoadStats()
    {
        if (_customerId.HasValue)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            _stats.TotalPickups = await dbContext.PickupRequests
                .CountAsync(p => p.CustomerId == _customerId && !p.IsDeleted);
            
            _stats.TotalShipments = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted);
            
            _stats.Pending = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.Pending);
            
            _stats.InTransit = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && 
                    (a.CourierStatusId == CourierStatus.InTransit || a.CourierStatusId == CourierStatus.PickedUp));
            
            _stats.OutForDelivery = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.OutForDelivery);
            
            _stats.Delivered = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.Delivered);
            
            _stats.Returned = await dbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.IsReturnedToConsignor);
            
            _stats.OpenTickets = await dbContext.Tickets
                .CountAsync(t => t.PartyId == _customerId && !t.IsDeleted && 
                    (t.Status == TicketStatus.Open || t.Status == TicketStatus.InProgress || t.Status == TicketStatus.PendingCustomer));
        }
    }

    private async Task LoadRecentData()
    {
        if (_customerId.HasValue)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            _recentPickups = await dbContext.PickupRequests
                .Include(p => p.Shipments)
                .Where(p => p.CustomerId == _customerId && !p.IsDeleted)
                .OrderByDescending(p => p.RequestDate)
                .Take(5)
                .ToListAsync();
            
            _recentShipments = await dbContext.InscanMasters
                .Where(a => a.CustomerId == _customerId && !a.IsDeleted)
                .OrderByDescending(a => a.TransactionDate)
                .Take(5)
                .ToListAsync();
        }
    }

    private void NavigateTo(string url)
    {
        NavigationManager.NavigateTo(url);
    }

    private Color GetStatusColor(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => Color.Info,
        PickupStatus.AssignedForCollection => Color.Warning,
        PickupStatus.ShipmentCollected => Color.Primary,
        PickupStatus.Inscanned => Color.Success,
        PickupStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private Color GetAWBStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Pending => Color.Info,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Warning,
        CourierStatus.Delivered => Color.Success,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private string GetLogoDataUrl()
    {
        if (string.IsNullOrEmpty(_company?.Logo))
            return string.Empty;
        if (_company.Logo.StartsWith("data:"))
            return _company.Logo;
        if (_company.Logo.StartsWith("http://") || _company.Logo.StartsWith("https://") || _company.Logo.StartsWith("/"))
            return _company.Logo;
        if (_company.Logo.Contains(".") && !_company.Logo.Contains("/"))
            return $"/uploads/logos/{_company.Logo}";
        return $"data:image/png;base64,{_company.Logo}";
    }

    private void OnLogoLoadError()
    {
        _logoLoadFailed = true;
        StateHasChanged();
    }

    private class DashboardStats
    {
        public int TotalPickups { get; set; }
        public int TotalShipments { get; set; }
        public int Pending { get; set; }
        public int InTransit { get; set; }
        public int OutForDelivery { get; set; }
        public int Delivered { get; set; }
        public int Returned { get; set; }
        public int OpenTickets { get; set; }
    }
}

@page "/customer/dashboard"
@layout CustomerLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>My Dashboard - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h5" GutterBottom="true">Welcome, @_customerName</MudText>
    
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-pickups"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.TotalPickups</MudText>
                        <MudText Typo="Typo.body2">Pickup Requests</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=pending"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Pending</MudText>
                        <MudText Typo="Typo.body2">Pending</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=intransit"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.FlightTakeoff" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.InTransit</MudText>
                        <MudText Typo="Typo.body2">In Transit</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=delivered"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Delivered</MudText>
                        <MudText Typo="Typo.body2">Delivered</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    
    <MudGrid Class="mt-4">
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=returned"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Undo" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.Returned</MudText>
                        <MudText Typo="Typo.body2">Returned</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments?status=outfordelivery"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.DirectionsBike" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.OutForDelivery</MudText>
                        <MudText Typo="Typo.body2">Out for Delivery</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="4">
            <MudCard Style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white;" Class="cursor-pointer" @onclick="@(() => NavigateTo("/customer/my-shipments"))">
                <MudCardContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" />
                        <MudText Typo="Typo.h3">@_stats.TotalShipments</MudText>
                        <MudText Typo="Typo.body2">Total Shipments</MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    
    <MudGrid Class="mt-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Pickups</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateTo("/customer/my-pickups"))">View All</MudButton>
                </MudStack>
                
                @if (_recentPickups.Any())
                {
                    <MudList T="PickupRequest">
                        @foreach (var pickup in _recentPickups)
                        {
                            <MudListItem T="PickupRequest">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.subtitle2">@pickup.PickupNo</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @pickup.RequestDate.ToString("dd MMM yyyy") - @(pickup.Shipments?.Count ?? 0) shipment(s)
                                        </MudText>
                                    </MudStack>
                                    <MudChip T="string" Color="@GetStatusColor(pickup.Status)" Size="Size.Small">@pickup.Status</MudChip>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No pickup requests yet</MudAlert>
                }
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Recent Shipments</MudText>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateTo("/customer/my-shipments"))">View All</MudButton>
                </MudStack>
                
                @if (_recentShipments.Any())
                {
                    <MudList T="InscanMaster">
                        @foreach (var awb in _recentShipments)
                        {
                            <MudListItem T="InscanMaster">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.subtitle2">@awb.AWBNo</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            To: @awb.Consignee - @awb.ConsigneeCity
                                        </MudText>
                                    </MudStack>
                                    <MudChip T="string" Color="@GetAWBStatusColor(awb.CourierStatusId)" Size="Size.Small">@awb.CourierStatusId</MudChip>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No shipments yet</MudAlert>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
    
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceAround" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" 
                       StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => NavigateTo("/customer/pickup-request"))">
                Request New Pickup
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Large" 
                       StartIcon="@Icons.Material.Filled.Search" OnClick="@(() => NavigateTo("/customer/track"))">
                Track Shipment
            </MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private string _customerName = "Customer";
    private long? _customerId;
    private DashboardStats _stats = new();
    private List<PickupRequest> _recentPickups = new();
    private List<InscanMaster> _recentShipments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomerInfo();
        await LoadStats();
        await LoadRecentData();
    }

    private async Task LoadCustomerInfo()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId")?.Value;
            if (long.TryParse(userIdClaim, out var userId))
            {
                var dbUser = await DbContext.Users.FindAsync(userId);
                if (dbUser != null)
                {
                    _customerName = dbUser.FullName ?? dbUser.Username;
                    
                    var party = await DbContext.Parties
                        .FirstOrDefaultAsync(p => p.Email == dbUser.Email && !p.IsDeleted);
                    if (party != null)
                    {
                        _customerId = party.Id;
                    }
                }
            }
        }
    }

    private async Task LoadStats()
    {
        if (_customerId.HasValue)
        {
            _stats.TotalPickups = await DbContext.PickupRequests
                .CountAsync(p => p.CustomerId == _customerId && !p.IsDeleted);
            
            _stats.TotalShipments = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted);
            
            _stats.Pending = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.Pending);
            
            _stats.InTransit = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && 
                    (a.CourierStatusId == CourierStatus.InTransit || a.CourierStatusId == CourierStatus.PickedUp));
            
            _stats.OutForDelivery = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.OutForDelivery);
            
            _stats.Delivered = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.CourierStatusId == CourierStatus.Delivered);
            
            _stats.Returned = await DbContext.InscanMasters
                .CountAsync(a => a.CustomerId == _customerId && !a.IsDeleted && a.IsReturnedToConsignor);
        }
    }

    private async Task LoadRecentData()
    {
        if (_customerId.HasValue)
        {
            _recentPickups = await DbContext.PickupRequests
                .Include(p => p.Shipments)
                .Where(p => p.CustomerId == _customerId && !p.IsDeleted)
                .OrderByDescending(p => p.RequestDate)
                .Take(5)
                .ToListAsync();
            
            _recentShipments = await DbContext.InscanMasters
                .Where(a => a.CustomerId == _customerId && !a.IsDeleted)
                .OrderByDescending(a => a.TransactionDate)
                .Take(5)
                .ToListAsync();
        }
    }

    private void NavigateTo(string url)
    {
        NavigationManager.NavigateTo(url);
    }

    private Color GetStatusColor(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => Color.Info,
        PickupStatus.AssignedForCollection => Color.Warning,
        PickupStatus.ShipmentCollected => Color.Primary,
        PickupStatus.Inscanned => Color.Success,
        PickupStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private Color GetAWBStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Pending => Color.Info,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.OutForDelivery => Color.Warning,
        CourierStatus.Delivered => Color.Success,
        CourierStatus.Returned => Color.Error,
        _ => Color.Default
    };

    private class DashboardStats
    {
        public int TotalPickups { get; set; }
        public int TotalShipments { get; set; }
        public int Pending { get; set; }
        public int InTransit { get; set; }
        public int OutForDelivery { get; set; }
        public int Delivered { get; set; }
        public int Returned { get; set; }
    }
}

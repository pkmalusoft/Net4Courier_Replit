@page "/drs-submission"
@page "/drs-submission/{DRSId:long}"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject DRSReconciliationService ReconciliationService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Courier Day-End Submission</PageTitle>

<style>
    .mobile-card {
        margin-bottom: 12px;
        padding: 16px;
    }
    .mobile-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .mobile-card-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
    }
    .touch-button {
        min-height: 48px;
        font-size: 16px;
    }
    .summary-card {
        text-align: center;
        padding: 16px;
        border-radius: 8px;
    }
    @@media (max-width: 600px) {
        .desktop-table {
            display: none !important;
        }
        .mobile-cards {
            display: block !important;
        }
    }
    @@media (min-width: 601px) {
        .desktop-table {
            display: block !important;
        }
        .mobile-cards {
            display: none !important;
        }
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-2 py-md-4">
    <MudText Typo="Typo.h5" Class="mb-4">Courier Day-End Submission</MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (_drs == null)
    {
        <MudPaper Class="pa-3 pa-md-4">
            <MudText Typo="Typo.h6" Class="mb-4">Select DRS to Submit</MudText>

            <div class="desktop-table">
                <MudTable Items="@_openDRSList" Dense="true" Hover="true" Class="mt-4">
                    <HeaderContent>
                        <MudTh>DRS No</MudTh>
                        <MudTh>Date</MudTh>
                        <MudTh>Courier</MudTh>
                        <MudTh>Total AWBs</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Action</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.DRSNo</MudTd>
                        <MudTd>@context.DRSDate.ToString("dd-MMM-yyyy")</MudTd>
                        <MudTd>@context.DeliveryEmployeeName</MudTd>
                        <MudTd>@context.TotalAWBs</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary"
                                       OnClick="@(() => SelectDRS(context))">
                                Select
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>No unreconciled DRS found</MudText>
                    </NoRecordsContent>
                </MudTable>
            </div>

            <div class="mobile-cards mt-4">
                @if (_openDRSList.Any())
                {
                    @foreach (var drs in _openDRSList)
                    {
                        <MudPaper Class="mobile-card" Elevation="2">
                            <div class="mobile-card-header">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@drs.DRSNo</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(drs.Status)">
                                    @drs.Status
                                </MudChip>
                            </div>
                            <div class="mobile-card-row">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Date</MudText>
                                <MudText Typo="Typo.body2">@drs.DRSDate.ToString("dd-MMM-yyyy")</MudText>
                            </div>
                            <div class="mobile-card-row">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Courier</MudText>
                                <MudText Typo="Typo.body2">@drs.DeliveryEmployeeName</MudText>
                            </div>
                            <div class="mobile-card-row">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">AWBs</MudText>
                                <MudText Typo="Typo.body2">@drs.TotalAWBs</MudText>
                            </div>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                       Class="mt-3 touch-button" OnClick="@(() => SelectDRS(drs))">
                                <MudIcon Icon="@Icons.Material.Filled.TouchApp" Class="mr-2" />
                                Select This DRS
                            </MudButton>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No unreconciled DRS found</MudAlert>
                }
            </div>
        </MudPaper>
    }
    else
    {
        <MudStack Spacing="3">
            <MudPaper Class="pa-3 pa-md-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">DRS: @_drs.DRSNo</MudText>
                    <MudChip T="string" Color="@GetStatusColor(_drs.Status)">@_drs.Status</MudChip>
                </MudStack>

                <MudGrid Spacing="2">
                    <MudItem xs="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Date</MudText>
                        <MudText Typo="Typo.body1">@_drs.DRSDate.ToString("dd-MMM-yyyy")</MudText>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Courier</MudText>
                        <MudText Typo="Typo.body1">@_drs.DeliveryEmployeeName</MudText>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Vehicle</MudText>
                        <MudText Typo="Typo.body1">@(_drs.VehicleNo ?? "-")</MudText>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Total AWBs</MudText>
                        <MudText Typo="Typo.body1">@_summary.TotalAWBs</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudText Typo="Typo.subtitle1" Class="mt-2">Delivery Summary</MudText>
            <MudGrid Spacing="2">
                <MudItem xs="4">
                    <MudPaper Class="summary-card" Elevation="0" Style="background-color: #e8f5e9;">
                        <MudText Typo="Typo.h4" Color="Color.Success">@_summary.DeliveredCount</MudText>
                        <MudText Typo="Typo.caption">Delivered</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="4">
                    <MudPaper Class="summary-card" Elevation="0" Style="background-color: #fff3e0;">
                        <MudText Typo="Typo.h4" Color="Color.Warning">@_summary.PendingCount</MudText>
                        <MudText Typo="Typo.caption">Pending</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="4">
                    <MudPaper Class="summary-card" Elevation="0" Style="background-color: #ffebee;">
                        <MudText Typo="Typo.h4" Color="Color.Error">@_summary.ReturnedCount</MudText>
                        <MudText Typo="Typo.caption">Returned</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudPaper Class="pa-3 pa-md-4">
                <MudText Typo="Typo.subtitle1" Class="mb-3">Expected Collections</MudText>
                <MudStack Spacing="1">
                    <div class="mobile-card-row">
                        <MudText Typo="Typo.body2">COD (Material Cost)</MudText>
                        <MudText Typo="Typo.body2">₹@_summary.TotalMaterialCost.ToString("N2")</MudText>
                    </div>
                    <div class="mobile-card-row">
                        <MudText Typo="Typo.body2">Courier Charges (ToPay)</MudText>
                        <MudText Typo="Typo.body2">₹@_summary.TotalCourierCharges.ToString("N2")</MudText>
                    </div>
                    <div class="mobile-card-row">
                        <MudText Typo="Typo.body2">Pickup Cash</MudText>
                        <MudText Typo="Typo.body2">₹@_summary.PickupCash.ToString("N2")</MudText>
                    </div>
                    <div class="mobile-card-row">
                        <MudText Typo="Typo.body2">Outstanding Collected</MudText>
                        <MudText Typo="Typo.body2">₹@_summary.OutstandingCollected.ToString("N2")</MudText>
                    </div>
                    <MudDivider Class="my-2" />
                    <div class="mobile-card-row" style="background-color: #e3f2fd; padding: 8px; border-radius: 4px;">
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">Total Expected</MudText>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">₹@_summary.ExpectedTotal.ToString("N2")</MudText>
                    </div>
                </MudStack>
            </MudPaper>

            <MudPaper Class="pa-3 pa-md-4">
                <MudText Typo="Typo.h6" Class="mb-3">Cash Submission</MudText>

                @if (_drs.Status == DRSStatus.Open)
                {
                    <MudStack Spacing="3">
                        <MudNumericField @bind-Value="_cashAmount" Label="Cash Amount" 
                                         Format="N2" Adornment="Adornment.Start" AdornmentText="₹"
                                         Variant="Variant.Outlined" />

                        <MudTextField @bind-Value="_remarks" Label="Remarks" Lines="2" 
                                      Variant="Variant.Outlined" />

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                   Class="touch-button" OnClick="SubmitCash" Disabled="@_saving">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            <MudIcon Icon="@Icons.Material.Filled.Payment" Class="mr-2" />
                            Submit Cash
                        </MudButton>
                    </MudStack>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mb-3">
                        Cash already submitted: ₹@_summary.CashSubmitted.ToString("N2")
                    </MudAlert>
                    
                    @if (_summary.IsAcknowledged)
                    {
                        <MudAlert Severity="Severity.Success">
                            Receipt acknowledged: ₹@_summary.CashReceived.ToString("N2")
                        </MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning">
                            Awaiting accountant acknowledgement
                        </MudAlert>
                    }
                }
            </MudPaper>

            <MudPaper Class="pa-3 pa-md-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Expenses</MudText>
                    @if (_drs.Status == DRSStatus.Open || _drs.Status == DRSStatus.Submitted)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   OnClick="@(() => _showExpenseDialog = true)" Class="touch-button"
                                   Style="min-height: 40px;">
                            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-1" />
                            Add
                        </MudButton>
                    }
                </MudStack>

                @if (_expenses.Any())
                {
                    <MudStack Spacing="2">
                        @foreach (var expense in _expenses)
                        {
                            <MudPaper Class="pa-3" Elevation="1">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <div>
                                        <MudText Typo="Typo.body1" Style="font-weight: 500;">@expense.ExpenseType</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@expense.Description</MudText>
                                    </div>
                                    <div style="text-align: right;">
                                        <MudText Typo="Typo.body1" Style="font-weight: 500;">₹@expense.Amount.ToString("N2")</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="@GetExpenseStatusColor(expense.Status)">
                                            @expense.Status
                                        </MudChip>
                                    </div>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                    <MudDivider Class="my-3" />
                    <div class="mobile-card-row" style="padding: 8px 0;">
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">Total Expenses</MudText>
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">₹@_summary.TotalExpenses.ToString("N2")</MudText>
                    </div>
                }
                else
                {
                    <MudAlert Severity="Severity.Normal" Variant="Variant.Text">
                        No expenses declared
                    </MudAlert>
                }
            </MudPaper>

            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                       Class="touch-button" OnClick="@(() => _drs = null)">
                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
                Back to DRS List
            </MudButton>
        </MudStack>
    }
</MudContainer>

<MudDialog @bind-Visible="_showExpenseDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Expense</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudSelect @bind-Value="_newExpense.ExpenseType" Label="Expense Type" Variant="Variant.Outlined">
                @foreach (ExpenseType type in Enum.GetValues<ExpenseType>())
                {
                    <MudSelectItem Value="@type">@type</MudSelectItem>
                }
            </MudSelect>
            
            <MudNumericField @bind-Value="_newExpense.Amount" Label="Amount" Format="N2"
                             Adornment="Adornment.Start" AdornmentText="₹" Variant="Variant.Outlined" />
            
            <MudTextField @bind-Value="_newExpense.Description" Label="Description" 
                          Variant="Variant.Outlined" />

            <MudFileUpload T="IBrowserFile" Accept=".jpg,.jpeg,.png,.pdf" FilesChanged="OnBillFileChanged">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                               StartIcon="@Icons.Material.Filled.CameraAlt" Class="touch-button">
                        Upload Bill Photo
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
            @if (!string.IsNullOrEmpty(_billFileName))
            {
                <MudAlert Severity="Severity.Success" Dense="true">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-1" /> @_billFileName
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudStack Row="true" Spacing="2" Style="width: 100%; padding: 8px;">
            <MudButton OnClick="@(() => _showExpenseDialog = false)" Variant="Variant.Outlined"
                       FullWidth="true" Class="touch-button">Cancel</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddExpense"
                       FullWidth="true" Class="touch-button">Add Expense</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public long DRSId { get; set; }

    private bool _loading;
    private bool _saving;
    private List<DRS> _openDRSList = new();
    private DRS? _drs;
    private DRSReconciliationSummary _summary = new();
    private List<CourierExpense> _expenses = new();
    
    private decimal _cashAmount;
    private string? _remarks;
    
    private bool _showExpenseDialog;
    private CourierExpense _newExpense = new();
    private string? _billFileName;
    private IBrowserFile? _billFile;

    protected override async Task OnInitializedAsync()
    {
        if (DRSId > 0)
        {
            await LoadDRS(DRSId);
        }
        else
        {
            await LoadOpenDRSList();
        }
    }

    private async Task LoadOpenDRSList()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _loading = true;
        StateHasChanged();

        try
        {
            var query = dbContext.DRSs
                .Where(d => !d.IsDeleted && (d.Status == DRSStatus.Open || d.Status == DRSStatus.Submitted));

            _openDRSList = await query.OrderByDescending(d => d.DRSDate).Take(50).ToListAsync();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task SelectDRS(DRS drs)
    {
        await LoadDRS(drs.Id);
    }

    private async Task LoadDRS(long id)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _loading = true;
        StateHasChanged();

        try
        {
            _drs = await dbContext.DRSs
                .Include(d => d.Details)
                    .ThenInclude(d => d.Inscan)
                .Include(d => d.CashSubmissions)
                .Include(d => d.Expenses)
                .FirstOrDefaultAsync(d => d.Id == id);

            if (_drs != null)
            {
                _summary = ReconciliationService.CalculateSummary(_drs);
                _expenses = _drs.Expenses.OrderBy(e => e.ExpenseDate).ToList();
                _cashAmount = _summary.ExpectedTotal;
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task SubmitCash()
    {
        if (_drs == null || _cashAmount <= 0)
        {
            Snackbar.Add("Please enter a valid cash amount", Severity.Warning);
            return;
        }

        _saving = true;
        StateHasChanged();

        try
        {
            var submission = new CourierCashSubmission
            {
                DRSId = _drs.Id,
                CourierId = _drs.DeliveryEmployeeId ?? 0,
                CourierName = _drs.DeliveryEmployeeName,
                SubmissionDate = DateTime.UtcNow.Date,
                CashSubmittedAmount = _cashAmount,
                Remarks = _remarks
            };

            await ReconciliationService.SubmitCash(submission);
            Snackbar.Add("Cash submitted successfully", Severity.Success);
            await LoadDRS(_drs.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private void OnBillFileChanged(IBrowserFile file)
    {
        _billFile = file;
        _billFileName = file.Name;
    }

    private async Task AddExpense()
    {
        if (_drs == null || _newExpense.Amount <= 0)
        {
            Snackbar.Add("Please enter a valid expense amount", Severity.Warning);
            return;
        }

        try
        {
            _newExpense.DRSId = _drs.Id;
            _newExpense.CourierId = _drs.DeliveryEmployeeId ?? 0;
            _newExpense.CourierName = _drs.DeliveryEmployeeName;
            _newExpense.ExpenseDate = DateTime.UtcNow;

            if (_billFile != null)
            {
                var uploadsPath = Path.Combine("wwwroot", "uploads", "expenses");
                Directory.CreateDirectory(uploadsPath);
                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_billFile.Name)}";
                var filePath = Path.Combine(uploadsPath, fileName);
                
                await using var stream = new FileStream(filePath, FileMode.Create);
                await _billFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);
                _newExpense.BillImagePath = $"/uploads/expenses/{fileName}";
            }

            await ReconciliationService.AddExpense(_newExpense);
            Snackbar.Add("Expense added successfully", Severity.Success);

            _showExpenseDialog = false;
            _newExpense = new CourierExpense();
            _billFile = null;
            _billFileName = null;

            await LoadDRS(_drs.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(DRSStatus status) => status switch
    {
        DRSStatus.Open => Color.Default,
        DRSStatus.Submitted => Color.Info,
        DRSStatus.PartiallyReconciled => Color.Warning,
        DRSStatus.Reconciled => Color.Success,
        DRSStatus.Closed => Color.Dark,
        _ => Color.Default
    };

    private Color GetExpenseStatusColor(ExpenseStatus status) => status switch
    {
        ExpenseStatus.Pending => Color.Warning,
        ExpenseStatus.Approved => Color.Success,
        ExpenseStatus.Rejected => Color.Error,
        _ => Color.Default
    };
}

@inject ApplicationDbContext DbContext
@inject IWebHostEnvironment Environment
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities

<MudDialog Style="min-width: 800px; overflow: visible;">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Business" />
            <MudText Typo="Typo.h6">@(IsNew ? "Add New Customer" : $"Edit: {Party.Name}")</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <div style="overflow: visible;">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
            <MudTabPanel Text="General Info" Icon="@Icons.Material.Filled.Info">
                <MudForm @ref="_form" @bind-IsValid="_formIsValid">
                    <MudGrid Spacing="2">
                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Basic Information</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label class="required">Company</label>
                                <select class="native-select dense" @bind="Party.CompanyId">
                                    @foreach (var company in _companies)
                                    {
                                        <option value="@company.Id">@company.Name</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label>Party Type</label>
                                <select class="native-select dense" value="@Party.PartyType" @onchange="OnPartyTypeChangedNative">
                                    @if (AllowedPartyTypes == null || AllowedPartyTypes.Contains(PartyType.Customer))
                                    {
                                        <option value="@PartyType.Customer">Customer</option>
                                    }
                                    @if (AllowedPartyTypes == null || AllowedPartyTypes.Contains(PartyType.DeliveryAgent))
                                    {
                                        <option value="@PartyType.DeliveryAgent">Delivery Agent</option>
                                    }
                                    @if (AllowedPartyTypes == null || AllowedPartyTypes.Contains(PartyType.CoLoader))
                                    {
                                        <option value="@PartyType.CoLoader">Co-Loader</option>
                                    }
                                    @if (AllowedPartyTypes == null || AllowedPartyTypes.Contains(PartyType.Supplier))
                                    {
                                        <option value="@PartyType.Supplier">Supplier</option>
                                    }
                                    @if (AllowedPartyTypes == null || AllowedPartyTypes.Contains(PartyType.ForwardingAgent))
                                    {
                                        <option value="@PartyType.ForwardingAgent">Forwarding Agent</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label>Account Type</label>
                                <select class="native-select dense" value="@Party.AccountTypeId" @onchange="OnAccountTypeChangedNative">
                                    <option value="">-- Select --</option>
                                    @foreach (var accType in _accountTypes)
                                    {
                                        <option value="@accType.Id">@accType.Name</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="Party.Name" Label="Customer Name" Required="true" 
                                          RequiredError="Name is required" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudTextField @bind-Value="Party.Code" Label="Code" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        @if (Party.PartyType == PartyType.Customer)
                        {
                            <MudItem xs="12" md="3">
                                <MudTextField @bind-Value="Party.CustomerAccountNo" Label="Account No" 
                                              Variant="Variant.Outlined" Dense="true"
                                              Disabled="@_autoGenerateAccountNo"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@(_autoGenerateAccountNo ? Icons.Material.Filled.AutoMode : Icons.Material.Filled.Edit)"
                                              OnAdornmentClick="ToggleAutoGenerate" />
                            </MudItem>
                        }
                        
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Contact Details</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="Party.ContactPerson" Label="Contact Person" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="Party.Email" Label="Email" InputType="InputType.Email" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="Party.TaxNumber" Label="Tax Number (TRN/VAT)" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudTextField @bind-Value="Party.Phone" Label="Phone" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudTextField @bind-Value="Party.Mobile" Label="Mobile" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="Party.ClientAddress" Label="Client Address" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Location</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label>Country</label>
                                <select class="native-select dense" value="@_countryId" @onchange="OnCountryChangedNative">
                                    <option value="">-- Select --</option>
                                    @foreach (var country in _countries)
                                    {
                                        <option value="@country.Id">@country.Name</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label>City</label>
                                <select class="native-select dense" value="@_cityId" @onchange="OnCityChangedNative" disabled="@(!_cities.Any())">
                                    <option value="">-- Select --</option>
                                    @foreach (var city in _cities)
                                    {
                                        <option value="@city.Id">@city.Name</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <div class="native-select-wrapper">
                                <label>Location</label>
                                <select class="native-select dense" value="@_location" @onchange="OnLocationChangedNative" disabled="@(!_locations.Any())">
                                    <option value="">-- Select --</option>
                                    @foreach (var loc in _locations)
                                    {
                                        <option value="@loc.Name">@loc.Name</option>
                                    }
                                </select>
                            </div>
                        </MudItem>
                        
                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Credit Terms</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="Party.CreditLimit" Label="Credit Limit" Variant="Variant.Outlined" Dense="true" Format="N0" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="Party.CreditDays" Label="Credit Days" Variant="Variant.Outlined" Dense="true" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-2">
                                <MudSwitch @bind-Value="Party.IsActive" Label="Active" Color="Color.Success" />
                            </MudStack>
                        </MudItem>

                        @if (Party.PartyType == PartyType.Customer)
                        {
                            <MudItem xs="12">
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Logo</MudText>
                            </MudItem>
                            <MudItem xs="12">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                    <MudFileUpload T="IBrowserFile" FilesChanged="OnLogoFileChanged" Accept=".png,.jpg,.jpeg,.gif,.svg">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Outlined" 
                                                       Color="Color.Primary" 
                                                       Size="Size.Small"
                                                       StartIcon="@Icons.Material.Filled.CloudUpload">
                                                Upload Logo
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                                    @if (!string.IsNullOrEmpty(Party.Logo))
                                    {
                                        <MudImage Src="@Party.Logo" Alt="Logo" Height="40" ObjectFit="ObjectFit.Contain" 
                                                  Style="border: 1px solid #ddd; border-radius: 4px; padding: 2px;" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" 
                                                       OnClick="RemoveLogo" Title="Remove" />
                                    }
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Max 2MB, PNG/JPG/SVG</MudText>
                                </MudStack>
                            </MudItem>
                        }
                    </MudGrid>
                </MudForm>
            </MudTabPanel>

            @if (Party.PartyType == PartyType.Customer && !IsNew)
            {
                <MudTabPanel Text="Branches / Departments" Icon="@Icons.Material.Filled.AccountTree">
                    <MudStack Spacing="2">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle1">Customer Branches & Departments</MudText>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" 
                                       StartIcon="@Icons.Material.Filled.Add" OnClick="AddBranch">
                                Add Branch
                            </MudButton>
                        </MudStack>

                        @if (_branches.Any())
                        {
                            <MudTable Items="@_branches" Dense="true" Hover="true" Bordered="true" Elevation="0">
                                <HeaderContent>
                                    <MudTh>Name</MudTh>
                                    <MudTh>Contact</MudTh>
                                    <MudTh>Phone</MudTh>
                                    <MudTh>Email</MudTh>
                                    <MudTh>City</MudTh>
                                    <MudTh Style="width: 100px;">Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Name">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            @if (context.IsHeadOffice)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                                            }
                                            @context.Name
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Contact">@context.ContactName</MudTd>
                                    <MudTd DataLabel="Phone">@(context.Phone ?? context.Mobile)</MudTd>
                                    <MudTd DataLabel="Email">@context.Email</MudTd>
                                    <MudTd DataLabel="City">@context.City</MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" 
                                                       OnClick="@(() => EditBranch(context))" Title="Edit" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" 
                                                       OnClick="@(() => DeleteBranch(context))" Title="Delete" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                                No branches or departments added. Click "Add Branch" to create one.
                            </MudAlert>
                        }
                    </MudStack>
                </MudTabPanel>
            }
        </MudTabs>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="!_formIsValid">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Party Party { get; set; } = new();
    [Parameter] public bool IsNew { get; set; }
    [Parameter] public List<PartyType>? AllowedPartyTypes { get; set; }

    private MudForm _form = null!;
    private bool _formIsValid;
    private List<Company> _companies = new();
    private List<Country> _countries = new();
    private List<City> _cities = new();
    private List<Location> _locations = new();
    private List<AccountType> _accountTypes = new();
    private List<CustomerBranch> _branches = new();
    private long? _countryId;
    private long? _cityId;
    private string? _location;
    private bool _autoGenerateAccountNo = true;

    protected override async Task OnInitializedAsync()
    {
        _companies = await DbContext.Companies.Where(c => c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        _countries = await DbContext.Countries.Where(c => c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        _accountTypes = await DbContext.AccountTypes.Where(a => a.IsActive && !a.IsDeleted).OrderBy(a => a.SortOrder).ToListAsync();

        if (IsNew)
        {
            if (_companies.Any())
                Party.CompanyId = _companies.First().Id;
            
            var india = _countries.FirstOrDefault(c => c.Name == "India");
            if (india != null)
            {
                _countryId = india.Id;
                _cities = await DbContext.Cities.Where(c => c.CountryId == india.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
            }
            
            _autoGenerateAccountNo = true;
            await GenerateNextAccountNo();
        }
        else
        {
            _autoGenerateAccountNo = string.IsNullOrEmpty(Party.CustomerAccountNo);
            if (_autoGenerateAccountNo)
            {
                await GenerateNextAccountNo();
            }
            await LoadExistingPartyAddress();
            await LoadBranches();
        }
    }

    private async Task LoadBranches()
    {
        _branches = await DbContext.CustomerBranches
            .Where(b => b.PartyId == Party.Id && !b.IsDeleted && b.IsActive)
            .OrderByDescending(b => b.IsHeadOffice)
            .ThenBy(b => b.Name)
            .ToListAsync();
    }
    
    private async Task GenerateNextAccountNo()
    {
        if (Party.PartyType != PartyType.Customer) return;
        
        var maxAccountNo = await DbContext.Parties
            .Where(p => p.PartyType == PartyType.Customer && !p.IsDeleted && p.CustomerAccountNo != null)
            .Select(p => p.CustomerAccountNo)
            .ToListAsync();
        
        long maxNum = 0;
        foreach (var accNo in maxAccountNo)
        {
            if (long.TryParse(accNo, out var num) && num > maxNum)
                maxNum = num;
        }
        
        Party.CustomerAccountNo = (maxNum + 1).ToString().PadLeft(6, '0');
    }

    private async Task ToggleAutoGenerate()
    {
        _autoGenerateAccountNo = !_autoGenerateAccountNo;
        if (_autoGenerateAccountNo && Party.PartyType == PartyType.Customer)
        {
            await GenerateNextAccountNo();
        }
        StateHasChanged();
    }

    private async Task OnPartyTypeChanged(PartyType newType)
    {
        Party.PartyType = newType;
        
        if (newType == PartyType.Customer && _autoGenerateAccountNo)
        {
            await GenerateNextAccountNo();
        }
        else if (newType != PartyType.Customer)
        {
            Party.CustomerAccountNo = null;
        }
        
        StateHasChanged();
    }

    private async Task LoadExistingPartyAddress()
    {
        var primaryAddress = await DbContext.PartyAddresses
            .Where(a => a.PartyId == Party.Id && !a.IsDeleted)
            .OrderByDescending(a => a.IsDefault)
            .FirstOrDefaultAsync();

        if (primaryAddress != null)
        {
            var country = _countries.FirstOrDefault(c => c.Name == primaryAddress.Country);
            if (country != null)
            {
                _countryId = country.Id;
                _cities = await DbContext.Cities.Where(c => c.CountryId == country.Id && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();

                var city = _cities.FirstOrDefault(c => c.Name == primaryAddress.City);
                if (city != null)
                {
                    _cityId = city.Id;
                    _locations = await DbContext.Locations.Where(l => l.CityId == city.Id && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
                    _location = primaryAddress.Landmark;
                }
            }
        }
    }

    private async Task OnCountryChanged(long? countryId)
    {
        _countryId = countryId;
        _cityId = null;
        _location = null;
        _cities.Clear();
        _locations.Clear();

        if (countryId.HasValue)
        {
            _cities = await DbContext.Cities.Where(c => c.CountryId == countryId && c.IsActive && !c.IsDeleted).OrderBy(c => c.Name).ToListAsync();
        }
        StateHasChanged();
    }

    private async Task OnCityChanged(long? cityId)
    {
        _cityId = cityId;
        _location = null;
        _locations.Clear();

        if (cityId.HasValue)
        {
            _locations = await DbContext.Locations.Where(l => l.CityId == cityId && l.IsActive && !l.IsDeleted).OrderBy(l => l.Name).ToListAsync();
        }
        StateHasChanged();
    }

    private void OnLocationChanged(string? locationName)
    {
        _location = locationName;
        StateHasChanged();
    }

    // Native HTML select event handlers
    private void OnAccountTypeChangedNative(ChangeEventArgs e)
    {
        if (long.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            Party.AccountTypeId = id;
        }
        else
        {
            Party.AccountTypeId = null;
        }
        StateHasChanged();
    }

    private async Task OnPartyTypeChangedNative(ChangeEventArgs e)
    {
        if (Enum.TryParse<PartyType>(e.Value?.ToString(), out var newType))
        {
            await OnPartyTypeChanged(newType);
        }
    }

    private async Task OnCountryChangedNative(ChangeEventArgs e)
    {
        long? countryId = null;
        if (long.TryParse(e.Value?.ToString(), out var id))
        {
            countryId = id;
        }
        await OnCountryChanged(countryId);
    }

    private async Task OnCityChangedNative(ChangeEventArgs e)
    {
        long? cityId = null;
        if (long.TryParse(e.Value?.ToString(), out var id))
        {
            cityId = id;
        }
        await OnCityChanged(cityId);
    }

    private void OnLocationChangedNative(ChangeEventArgs e)
    {
        OnLocationChanged(e.Value?.ToString());
    }

    private async Task AddBranch()
    {
        var branch = new CustomerBranch { PartyId = Party.Id, IsActive = true };
        var result = await ShowBranchDialog(branch, true);
        if (result)
        {
            await LoadBranches();
        }
    }

    private async Task EditBranch(CustomerBranch branch)
    {
        var result = await ShowBranchDialog(branch, false);
        if (result)
        {
            await LoadBranches();
        }
    }

    private async Task<bool> ShowBranchDialog(CustomerBranch branch, bool isNew)
    {
        var parameters = new DialogParameters<CustomerBranchDialog>
        {
            { x => x.Branch, branch },
            { x => x.IsNew, isNew }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CustomerBranchDialog>(
            isNew ? "Add Branch" : "Edit Branch", parameters, options);
        var result = await dialog.Result;
        
        return result is { Canceled: false };
    }

    private async Task DeleteBranch(CustomerBranch branch)
    {
        branch.IsDeleted = true;
        branch.ModifiedAt = DateTime.UtcNow;
        DbContext.CustomerBranches.Update(branch);
        await DbContext.SaveChangesAsync();
        await LoadBranches();
        Snackbar.Add("Branch deleted", Severity.Success);
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        if (Party.PartyType == PartyType.Customer && _autoGenerateAccountNo)
        {
            await GenerateNextAccountNo();
        }

        if (IsNew)
        {
            Party.CreatedAt = DateTime.UtcNow;
            
            if (Party.PartyType == PartyType.Customer && (Party.CreditLimit > 0 || Party.CreditDays > 0))
            {
                Party.CreditApprovalStatus = CreditApprovalStatus.Pending;
            }
            else
            {
                Party.CreditApprovalStatus = CreditApprovalStatus.NotApplicable;
            }
            
            DbContext.Parties.Add(Party);
            await DbContext.SaveChangesAsync();

            if (_countryId.HasValue || _cityId.HasValue || !string.IsNullOrEmpty(_location))
            {
                var address = new PartyAddress
                {
                    PartyId = Party.Id,
                    AddressType = "Primary",
                    IsDefault = true,
                    Country = _countries.FirstOrDefault(c => c.Id == _countryId)?.Name,
                    City = _cities.FirstOrDefault(c => c.Id == _cityId)?.Name,
                    Landmark = _location,
                    CreatedAt = DateTime.UtcNow
                };
                DbContext.PartyAddresses.Add(address);
                await DbContext.SaveChangesAsync();
            }
        }
        else
        {
            Party.ModifiedAt = DateTime.UtcNow;
            
            if (Party.PartyType == PartyType.Customer)
            {
                bool hasCredit = Party.CreditLimit > 0 || Party.CreditDays > 0;
                
                if (hasCredit)
                {
                    if (Party.CreditApprovalStatus == CreditApprovalStatus.NotApplicable || 
                        Party.CreditApprovalStatus == CreditApprovalStatus.Rejected)
                    {
                        Party.CreditApprovalStatus = CreditApprovalStatus.Pending;
                    }
                }
            }
            
            DbContext.Parties.Update(Party);

            var primaryAddress = await DbContext.PartyAddresses
                .Where(a => a.PartyId == Party.Id && !a.IsDeleted)
                .OrderByDescending(a => a.IsDefault)
                .FirstOrDefaultAsync();

            if (primaryAddress != null)
            {
                primaryAddress.Country = _countries.FirstOrDefault(c => c.Id == _countryId)?.Name;
                primaryAddress.City = _cities.FirstOrDefault(c => c.Id == _cityId)?.Name;
                primaryAddress.Landmark = _location;
                primaryAddress.ModifiedAt = DateTime.UtcNow;
                DbContext.PartyAddresses.Update(primaryAddress);
            }
            else if (_countryId.HasValue || _cityId.HasValue || !string.IsNullOrEmpty(_location))
            {
                var address = new PartyAddress
                {
                    PartyId = Party.Id,
                    AddressType = "Primary",
                    IsDefault = true,
                    Country = _countries.FirstOrDefault(c => c.Id == _countryId)?.Name,
                    City = _cities.FirstOrDefault(c => c.Id == _cityId)?.Name,
                    Landmark = _location,
                    CreatedAt = DateTime.UtcNow
                };
                DbContext.PartyAddresses.Add(address);
            }

            await DbContext.SaveChangesAsync();
        }

        MudDialog.Close(DialogResult.Ok(Party));
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task OnLogoFileChanged(IBrowserFile file)
    {
        try
        {
            if (file.Size > 2 * 1024 * 1024)
            {
                Snackbar.Add("Logo file size must be less than 2MB", Severity.Warning);
                return;
            }

            var allowedExtensions = new[] { ".png", ".jpg", ".jpeg", ".gif", ".svg" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add("Invalid file type. Please upload PNG, JPG, GIF, or SVG", Severity.Warning);
                return;
            }

            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads", "logos");
            Directory.CreateDirectory(uploadsFolder);

            var fileName = $"customer_{(Party.Id > 0 ? Party.Id : DateTime.UtcNow.Ticks)}_{Guid.NewGuid():N}{extension}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            await using var stream = new FileStream(filePath, FileMode.Create);
            await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(stream);

            if (!string.IsNullOrEmpty(Party.Logo))
            {
                var oldPath = Path.Combine(Environment.WebRootPath, Party.Logo.TrimStart('/'));
                if (File.Exists(oldPath))
                    File.Delete(oldPath);
            }

            Party.Logo = $"/uploads/logos/{fileName}";
            Snackbar.Add("Logo uploaded successfully", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading logo: {ex.Message}", Severity.Error);
        }
    }

    private void RemoveLogo()
    {
        if (!string.IsNullOrEmpty(Party.Logo))
        {
            var filePath = Path.Combine(Environment.WebRootPath, Party.Logo.TrimStart('/'));
            if (File.Exists(filePath))
                File.Delete(filePath);
        }
        Party.Logo = null;
        StateHasChanged();
    }
}

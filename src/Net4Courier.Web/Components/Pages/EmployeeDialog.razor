@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudTabs Elevation="0" PanelClass="pa-2" Rounded="true" Border="true">
                <MudTabPanel Text="General Info" Icon="@Icons.Material.Filled.Person">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Employee.Code" Label="Employee Code*" Required="true"
                                          RequiredError="Code is required" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Employee.FirstName" Label="First Name" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Employee.LastName" Label="Last Name" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="12">
                            <MudTextField @bind-Value="Employee.Name" Label="Full Name*" Required="true"
                                          RequiredError="Name is required" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="long?" @bind-Value="Employee.DesignationId" Label="Designation" Variant="Variant.Outlined">
                                <MudSelectItem T="long?" Value="@((long?)null)">-- Select Designation --</MudSelectItem>
                                @foreach (var designation in Designations)
                                {
                                    <MudSelectItem T="long?" Value="@designation.Id">@designation.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="long?" @bind-Value="Employee.DepartmentId" Label="Department" Variant="Variant.Outlined">
                                <MudSelectItem T="long?" Value="@((long?)null)">-- Select Department --</MudSelectItem>
                                @foreach (var department in Departments)
                                {
                                    <MudSelectItem T="long?" Value="@department.Id">@department.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="long?" @bind-Value="Employee.BranchId" Label="Branch" Variant="Variant.Outlined">
                                <MudSelectItem T="long?" Value="@((long?)null)">-- Select Branch --</MudSelectItem>
                                @foreach (var branch in Branches)
                                {
                                    <MudSelectItem T="long?" Value="@branch.Id">@branch.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="EmployeeStatus" @bind-Value="Employee.Status" Label="Status" Variant="Variant.Outlined">
                                @foreach (var status in Enum.GetValues<EmployeeStatus>())
                                {
                                    <MudSelectItem T="EmployeeStatus" Value="@status">@status.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_joiningDate" Label="Joining Date" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="_dateOfBirth" Label="Date of Birth" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudSwitch @bind-Value="Employee.IsActive" Label="Active" Color="Color.Primary" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Contact" Icon="@Icons.Material.Filled.ContactPhone">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.Phone" Label="Phone" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.Mobile" Label="Mobile" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Employee.Email" Label="Email" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Employee.Address" Label="Address" Variant="Variant.Outlined" Lines="2" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.Country" Label="Country" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.State" Label="State" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.EmergencyContact" Label="Emergency Contact Name" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.EmergencyPhone" Label="Emergency Phone" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Bank & Salary" Icon="@Icons.Material.Filled.AccountBalance">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.BankName" Label="Bank Name" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.BankAccountNumber" Label="Account Number" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.BankIFSC" Label="IFSC/SWIFT Code" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="Employee.TaxIdNumber" Label="Tax ID Number" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="Employee.BaseSalary" Label="Base Salary" Variant="Variant.Outlined" Format="N2" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="User Account" Icon="@Icons.Material.Filled.AccountCircle">
                    <MudGrid Spacing="2">
                        <MudItem xs="12">
                            <MudSelect T="long?" @bind-Value="Employee.UserId" Label="Link to User Account" Variant="Variant.Outlined">
                                <MudSelectItem T="long?" Value="@((long?)null)">-- No User Account --</MudSelectItem>
                                @foreach (var user in Users)
                                {
                                    <MudSelectItem T="long?" Value="@user.Id">@user.Username (@user.FullName)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Link this employee to a user account for system login access
                            </MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Employee.Notes" Label="Notes" Variant="Variant.Outlined" Lines="3" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="@(!_isValid)">
            @(IsNew ? "Create" : "Save")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Employee Employee { get; set; } = new();
    [Parameter] public bool IsNew { get; set; }
    [Parameter] public List<Branch> Branches { get; set; } = new();
    [Parameter] public List<User> Users { get; set; } = new();
    [Parameter] public List<Designation> Designations { get; set; } = new();
    [Parameter] public List<Department> Departments { get; set; } = new();

    private MudForm? _form;
    private bool _isValid;
    private DateTime? _joiningDate;
    private DateTime? _dateOfBirth;

    protected override void OnParametersSet()
    {
        _joiningDate = Employee.JoiningDate;
        _dateOfBirth = Employee.DateOfBirth;
    }

    private async Task Save()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_isValid) return;
        }

        Employee.JoiningDate = _joiningDate.HasValue ? DateTime.SpecifyKind(_joiningDate.Value, DateTimeKind.Utc) : null;
        Employee.DateOfBirth = _dateOfBirth.HasValue ? DateTime.SpecifyKind(_dateOfBirth.Value, DateTimeKind.Utc) : null;

        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (IsNew)
        {
            Employee.CreatedAt = DateTime.UtcNow;
            dbContext.Employees.Add(Employee);
        }
        else
        {
            Employee.ModifiedAt = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc);
            dbContext.Employees.Update(Employee);
        }

        await dbContext.SaveChangesAsync();
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();
}

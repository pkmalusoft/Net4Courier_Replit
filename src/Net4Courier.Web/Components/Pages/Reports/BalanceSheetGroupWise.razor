@page "/reports/balance-sheet/groupwise"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Balance Sheet (Group-wise) - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Balance Sheet - Group-wise Consolidation</MudText>

        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_asAtDate" Label="As At Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" 
                           FullWidth="true" Class="mt-1" Disabled="_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" OnClick="ClearFilters" FullWidth="true" Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasData)
    {
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle1" Class="mb-4" Align="Align.Center">
                <strong>Balance Sheet as at @_asAtDate?.ToString("dd MMMM yyyy")</strong>
            </MudText>

            <MudExpansionPanels Class="mb-2">
                <MudExpansionPanel @bind-Expanded="_assetsExpanded">
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>ASSETS</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Success"><strong>@_totalAssets.ToString("N2")</strong></MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @foreach (var group in _assetGroups)
                        {
                            <MudExpansionPanels Class="ml-4 mb-1">
                                <MudExpansionPanel Dense="true" DisableGutters="true">
                                    <TitleContent>
                                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                            <MudText Typo="Typo.body2">@group.Code - @group.Name</MudText>
                                            <MudText Typo="Typo.body2"><strong>@group.TotalBalance.ToString("N2")</strong></MudText>
                                        </div>
                                    </TitleContent>
                                    <ChildContent>
                                        @foreach (var item in group.Children)
                                        {
                                            <div class="d-flex justify-space-between ml-6 py-1">
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">@item.Code - @item.Name</MudText>
                                                <MudText Typo="Typo.body2">@item.Balance.ToString("N2")</MudText>
                                            </div>
                                        }
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudExpansionPanels Class="mb-2">
                <MudExpansionPanel @bind-Expanded="_liabilitiesExpanded">
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>LIABILITIES</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Warning"><strong>@_totalLiabilities.ToString("N2")</strong></MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @foreach (var group in _liabilityGroups)
                        {
                            <MudExpansionPanels Class="ml-4 mb-1">
                                <MudExpansionPanel Dense="true" DisableGutters="true">
                                    <TitleContent>
                                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                            <MudText Typo="Typo.body2">@group.Code - @group.Name</MudText>
                                            <MudText Typo="Typo.body2"><strong>@group.TotalBalance.ToString("N2")</strong></MudText>
                                        </div>
                                    </TitleContent>
                                    <ChildContent>
                                        @foreach (var item in group.Children)
                                        {
                                            <div class="d-flex justify-space-between ml-6 py-1">
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">@item.Code - @item.Name</MudText>
                                                <MudText Typo="Typo.body2">@item.Balance.ToString("N2")</MudText>
                                            </div>
                                        }
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudExpansionPanels Class="mb-2">
                <MudExpansionPanel @bind-Expanded="_equityExpanded">
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>EQUITY</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Info"><strong>@(_totalEquity + _retainedEarnings).ToString("N2")</strong></MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @foreach (var group in _equityGroups)
                        {
                            <MudExpansionPanels Class="ml-4 mb-1">
                                <MudExpansionPanel Dense="true" DisableGutters="true">
                                    <TitleContent>
                                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                            <MudText Typo="Typo.body2">@group.Code - @group.Name</MudText>
                                            <MudText Typo="Typo.body2"><strong>@group.TotalBalance.ToString("N2")</strong></MudText>
                                        </div>
                                    </TitleContent>
                                    <ChildContent>
                                        @foreach (var item in group.Children)
                                        {
                                            <div class="d-flex justify-space-between ml-6 py-1">
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">@item.Code - @item.Name</MudText>
                                                <MudText Typo="Typo.body2">@item.Balance.ToString("N2")</MudText>
                                            </div>
                                        }
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        }
                        @if (_retainedEarnings != 0)
                        {
                            <div class="d-flex justify-space-between ml-4 py-2">
                                <MudText Typo="Typo.body1"><strong>Retained Earnings</strong></MudText>
                                <MudText Typo="Typo.body1" Color="Color.Primary"><strong>@_retainedEarnings.ToString("N2")</strong></MudText>
                            </div>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudDivider Class="my-4" />

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="2" Style="background: var(--mud-palette-success-lighten);">
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.h6"><strong>Total Assets</strong></MudText>
                            <MudText Typo="Typo.h6"><strong>@_totalAssets.ToString("N2")</strong></MudText>
                        </div>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="2" Style="background: var(--mud-palette-info-lighten);">
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.h6"><strong>Total Liabilities & Equity</strong></MudText>
                            <MudText Typo="Typo.h6"><strong>@(_totalLiabilities + _totalEquity + _retainedEarnings).ToString("N2")</strong></MudText>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @{
                var difference = _totalAssets - (_totalLiabilities + _totalEquity + _retainedEarnings);
            }
            @if (Math.Abs(difference) > 0.01m)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    Balance Sheet does not balance. Difference: @Math.Abs(difference).ToString("N2")
                </MudAlert>
            }
            else
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">
                    Balance Sheet is balanced. Assets = Liabilities + Equity
                </MudAlert>
            }
        </MudPaper>
    }
    else if (!_isLoading)
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a date and click Generate to view the Group-wise Balance Sheet.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private DateTime? _asAtDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private bool _isLoading;
    private bool _hasData;
    private bool _assetsExpanded = true;
    private bool _liabilitiesExpanded = true;
    private bool _equityExpanded = true;

    private List<AccountGroupItem> _assetGroups = new();
    private List<AccountGroupItem> _liabilityGroups = new();
    private List<AccountGroupItem> _equityGroups = new();
    private decimal _totalAssets;
    private decimal _totalLiabilities;
    private decimal _totalEquity;
    private decimal _retainedEarnings;

    private async Task LoadReport()
    {
        _isLoading = true;
        _assetGroups.Clear();
        _liabilityGroups.Clear();
        _equityGroups.Clear();
        _retainedEarnings = 0;

        try
        {
            var asAtUtc = _asAtDate.HasValue 
                ? DateTime.SpecifyKind(_asAtDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) 
                : DateTime.UtcNow;

            var accounts = await DbContext.AccountHeads
                .Where(a => a.IsActive)
                .OrderBy(a => a.Code)
                .ToListAsync();

            var journalEntries = await DbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => !e.IsDeleted && e.Journal.IsPosted && e.Journal.VoucherDate <= asAtUtc)
                .ToListAsync();

            var entriesByAccount = journalEntries.GroupBy(e => e.AccountHeadId)
                .ToDictionary(g => g.Key, g => g.ToList());

            var accountBalances = new Dictionary<long, decimal>();
            foreach (var account in accounts.Where(a => !a.IsGroup))
            {
                var opening = account.OpeningBalance ?? 0;
                var entries = entriesByAccount.GetValueOrDefault(account.Id, new List<JournalEntry>());
                var balance = opening + entries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));
                if (balance != 0)
                {
                    accountBalances[account.Id] = balance;
                }
            }

            var groupAccounts = accounts.Where(a => a.IsGroup).ToList();
            var leafAccounts = accounts.Where(a => !a.IsGroup).ToList();

            foreach (var classification in new[] { AccountClassification.Assets, AccountClassification.Liabilities, AccountClassification.Equity })
            {
                var classGroups = groupAccounts.Where(g => g.Classification == classification).ToList();
                var targetList = classification switch
                {
                    AccountClassification.Assets => _assetGroups,
                    AccountClassification.Liabilities => _liabilityGroups,
                    AccountClassification.Equity => _equityGroups,
                    _ => new List<AccountGroupItem>()
                };

                foreach (var group in classGroups)
                {
                    var children = leafAccounts
                        .Where(a => a.ParentId == group.Id && accountBalances.ContainsKey(a.Id))
                        .Select(a => new BalanceSheetItem
                        {
                            Code = a.Code,
                            Name = a.Name,
                            Balance = Math.Abs(accountBalances[a.Id])
                        })
                        .ToList();

                    if (children.Any())
                    {
                        targetList.Add(new AccountGroupItem
                        {
                            Code = group.Code,
                            Name = group.Name,
                            Children = children,
                            TotalBalance = children.Sum(c => c.Balance)
                        });
                    }
                }

                var ungrouped = leafAccounts
                    .Where(a => a.ParentId == null && a.Classification == classification && accountBalances.ContainsKey(a.Id))
                    .Select(a => new BalanceSheetItem
                    {
                        Code = a.Code,
                        Name = a.Name,
                        Balance = Math.Abs(accountBalances[a.Id])
                    })
                    .ToList();

                if (ungrouped.Any())
                {
                    targetList.Add(new AccountGroupItem
                    {
                        Code = "OTHER",
                        Name = "Other " + classification.ToString(),
                        Children = ungrouped,
                        TotalBalance = ungrouped.Sum(c => c.Balance)
                    });
                }
            }

            foreach (var account in leafAccounts.Where(a => a.Classification == AccountClassification.Income || a.Classification == AccountClassification.Expenditure))
            {
                if (accountBalances.TryGetValue(account.Id, out var balance))
                {
                    _retainedEarnings += balance;
                }
            }

            _totalAssets = _assetGroups.Sum(g => g.TotalBalance);
            _totalLiabilities = _liabilityGroups.Sum(g => g.TotalBalance);
            _totalEquity = _equityGroups.Sum(g => g.TotalBalance);
            _hasData = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading balance sheet: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private void ClearFilters()
    {
        _asAtDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
        _hasData = false;
        _assetGroups.Clear();
        _liabilityGroups.Clear();
        _equityGroups.Clear();
    }

    private class BalanceSheetItem
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public decimal Balance { get; set; }
    }

    private class AccountGroupItem
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public List<BalanceSheetItem> Children { get; set; } = new();
        public decimal TotalBalance { get; set; }
    }
}

@page "/reports/ops/sales-register"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Microsoft.JSInterop
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ReportExportService ExportService
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Sales Register - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h5">Sales Register</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.TableChart" 
                           OnClick="ExportExcel" Disabled="@(!_data.Any())">Excel</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           OnClick="ExportPdf" Disabled="@(!_data.Any())">PDF</MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="long?" Label="Branch" @bind-Value="_branchId" Clearable Variant="Variant.Outlined" Dense="true">
                    @foreach (var branch in _branches)
                    {
                        <MudSelectItem Value="@((long?)branch.Id)">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="bool" Label="View" @bind-Value="_showDetails" Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="false">Summary</MudSelectItem>
                    <MudSelectItem Value="true">Detailed</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" FullWidth="true">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
        else if (_showDetails && _data.Any())
        {
            <MudPaper Class="pa-4 mt-4" Elevation="1" Style="background: var(--mud-palette-grey-lighten-4);">
                <MudGrid>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Total AWBs</MudText>
                        <MudText Typo="Typo.h6">@_data.Count</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Freight</MudText>
                        <MudText Typo="Typo.h6">@_data.Sum(x => x.Freight).ToString("N2")</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Other Charges</MudText>
                        <MudText Typo="Typo.h6">@_data.Sum(x => x.OtherCharges).ToString("N2")</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Total Amount</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">@_data.Sum(x => x.Total).ToString("N2")</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudTable Items="@_data" Dense="true" Hover="true" Striped="true" Class="mt-4" FixedHeader="true" Height="450px">
                <HeaderContent>
                    <MudTh>AWB No</MudTh>
                    <MudTh>Date</MudTh>
                    <MudTh>Customer</MudTh>
                    <MudTh>Destination</MudTh>
                    <MudTh Style="text-align: center">Pcs</MudTh>
                    <MudTh Style="text-align: right">Weight</MudTh>
                    <MudTh Style="text-align: right">Freight</MudTh>
                    <MudTh Style="text-align: right">Others</MudTh>
                    <MudTh Style="text-align: right">Total</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.AWBNo</MudTd>
                    <MudTd>@context.Date.ToString("dd-MMM")</MudTd>
                    <MudTd>@context.Customer</MudTd>
                    <MudTd>@context.Destination</MudTd>
                    <MudTd Style="text-align: center">@context.Pieces</MudTd>
                    <MudTd Style="text-align: right">@context.Weight.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.Freight.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.OtherCharges.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right; font-weight: bold;">@context.Total.ToString("N2")</MudTd>
                </RowTemplate>
            </MudTable>
        }
        else if (!_showDetails && _summaryData.Any())
        {
            <MudTable Items="@_summaryData" Dense="true" Hover="true" Striped="true" Class="mt-4" FixedHeader="true" Height="500px">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh Style="text-align: center">AWB Count</MudTh>
                    <MudTh Style="text-align: center">Pieces</MudTh>
                    <MudTh Style="text-align: right">Weight (Kg)</MudTh>
                    <MudTh Style="text-align: right">Freight</MudTh>
                    <MudTh Style="text-align: right">Others</MudTh>
                    <MudTh Style="text-align: right">Total</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Date.ToString("dd-MMM-yyyy")</MudTd>
                    <MudTd Style="text-align: center">@context.AWBCount</MudTd>
                    <MudTd Style="text-align: center">@context.Pieces</MudTd>
                    <MudTd Style="text-align: right">@context.Weight.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.Freight.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.OtherCharges.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right; font-weight: bold;">@context.Total.ToString("N2")</MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTd><strong>Grand Total</strong></MudTd>
                    <MudTd Style="text-align: center"><strong>@_summaryData.Sum(x => x.AWBCount)</strong></MudTd>
                    <MudTd Style="text-align: center"><strong>@_summaryData.Sum(x => x.Pieces)</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_summaryData.Sum(x => x.Weight).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_summaryData.Sum(x => x.Freight).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_summaryData.Sum(x => x.OtherCharges).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_summaryData.Sum(x => x.Total).ToString("N2")</strong></MudTd>
                </FooterContent>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Click Generate to load sales register.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<SalesDto> _data = new();
    private List<SalesSummaryDto> _summaryData = new();
    private List<Branch> _branches = new();
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private long? _branchId;
    private bool _showDetails;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _branches = await dbContext.Branches.Where(b => b.IsActive).OrderBy(b => b.Name).ToListAsync();
    }

    private async Task LoadData()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _isLoading = true;
        _data.Clear();
        _summaryData.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) : DateTime.MinValue;
            var toUtc = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) : DateTime.MaxValue;

            var query = dbContext.InscanMasters
                .Where(a => a.TransactionDate >= fromUtc && a.TransactionDate <= toUtc);

            if (_branchId.HasValue)
                query = query.Where(a => a.BranchId == _branchId);

            var awbs = await query.OrderBy(a => a.TransactionDate).ThenBy(a => a.AWBNo).ToListAsync();

            _data = awbs.Select(a => new SalesDto
            {
                AWBNo = a.AWBNo ?? "",
                Date = a.TransactionDate,
                Customer = a.Consignor ?? "",
                Destination = a.ConsigneeCity ?? "",
                Pieces = a.Pieces ?? 0,
                Weight = a.Weight ?? 0,
                Freight = a.CourierCharge ?? 0,
                OtherCharges = (a.NetTotal ?? 0) - (a.CourierCharge ?? 0),
                Total = a.NetTotal ?? 0
            }).ToList();

            _summaryData = _data.GroupBy(d => d.Date.Date)
                .Select(g => new SalesSummaryDto
                {
                    Date = g.Key,
                    AWBCount = g.Count(),
                    Pieces = g.Sum(x => x.Pieces),
                    Weight = g.Sum(x => x.Weight),
                    Freight = g.Sum(x => x.Freight),
                    OtherCharges = g.Sum(x => x.OtherCharges),
                    Total = g.Sum(x => x.Total)
                })
                .OrderBy(s => s.Date)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task ExportExcel()
    {
        if (_showDetails)
        {
            var columns = new Dictionary<string, Func<SalesDto, object?>>
            {
                { "AWB No", x => x.AWBNo },
                { "Date", x => x.Date },
                { "Customer", x => x.Customer },
                { "Destination", x => x.Destination },
                { "Pieces", x => x.Pieces },
                { "Weight", x => x.Weight },
                { "Freight", x => x.Freight },
                { "Other Charges", x => x.OtherCharges },
                { "Total", x => x.Total }
            };

            var bytes = ExportService.ExportToExcel("Sales Register Detail", _data, columns);
            await DownloadFile(bytes, "SalesRegisterDetail.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        }
        else
        {
            var columns = new Dictionary<string, Func<SalesSummaryDto, object?>>
            {
                { "Date", x => x.Date },
                { "AWB Count", x => x.AWBCount },
                { "Pieces", x => x.Pieces },
                { "Weight", x => x.Weight },
                { "Freight", x => x.Freight },
                { "Other Charges", x => x.OtherCharges },
                { "Total", x => x.Total }
            };

            var bytes = ExportService.ExportToExcel("Sales Register Summary", _summaryData, columns);
            await DownloadFile(bytes, "SalesRegisterSummary.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        }
    }

    private async Task ExportPdf()
    {
        var subtitle = $"Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";

        if (_showDetails)
        {
            var columns = new Dictionary<string, Func<SalesDto, object?>>
            {
                { "AWB No", x => x.AWBNo },
                { "Date", x => x.Date },
                { "Customer", x => x.Customer },
                { "Dest", x => x.Destination },
                { "Pcs", x => x.Pieces },
                { "Weight", x => x.Weight },
                { "Freight", x => x.Freight },
                { "Others", x => x.OtherCharges },
                { "Total", x => x.Total }
            };

            var totals = new Dictionary<string, decimal>
            {
                { "Pcs", _data.Sum(x => x.Pieces) },
                { "Weight", _data.Sum(x => x.Weight) },
                { "Freight", _data.Sum(x => x.Freight) },
                { "Others", _data.Sum(x => x.OtherCharges) },
                { "Total", _data.Sum(x => x.Total) }
            };

            var bytes = ExportService.ExportToPdf("Sales Register (Detail)", subtitle, _data, columns, totals);
            await DownloadFile(bytes, "SalesRegisterDetail.pdf", "application/pdf");
        }
        else
        {
            var columns = new Dictionary<string, Func<SalesSummaryDto, object?>>
            {
                { "Date", x => x.Date },
                { "AWBs", x => x.AWBCount },
                { "Pieces", x => x.Pieces },
                { "Weight", x => x.Weight },
                { "Freight", x => x.Freight },
                { "Others", x => x.OtherCharges },
                { "Total", x => x.Total }
            };

            var totals = new Dictionary<string, decimal>
            {
                { "AWBs", _summaryData.Sum(x => x.AWBCount) },
                { "Pieces", _summaryData.Sum(x => x.Pieces) },
                { "Weight", _summaryData.Sum(x => x.Weight) },
                { "Freight", _summaryData.Sum(x => x.Freight) },
                { "Others", _summaryData.Sum(x => x.OtherCharges) },
                { "Total", _summaryData.Sum(x => x.Total) }
            };

            var bytes = ExportService.ExportToPdf("Sales Register (Summary)", subtitle, _summaryData, columns, totals);
            await DownloadFile(bytes, "SalesRegisterSummary.pdf", "application/pdf");
        }
    }

    private async Task DownloadFile(byte[] bytes, string filename, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", filename, base64, contentType);
    }

    private class SalesDto
    {
        public string AWBNo { get; set; } = "";
        public DateTime Date { get; set; }
        public string Customer { get; set; } = "";
        public string Destination { get; set; } = "";
        public int Pieces { get; set; }
        public decimal Weight { get; set; }
        public decimal Freight { get; set; }
        public decimal OtherCharges { get; set; }
        public decimal Total { get; set; }
    }

    private class SalesSummaryDto
    {
        public DateTime Date { get; set; }
        public int AWBCount { get; set; }
        public int Pieces { get; set; }
        public decimal Weight { get; set; }
        public decimal Freight { get; set; }
        public decimal OtherCharges { get; set; }
        public decimal Total { get; set; }
    }
}

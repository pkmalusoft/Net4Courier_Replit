@page "/reports/ar/customer-ledger"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Microsoft.JSInterop
@inject ApplicationDbContext DbContext
@inject ReportExportService ExportService
@inject IGmailEmailService EmailService
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Customer Ledger - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h5">Customer Ledger</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.TableChart" 
                           OnClick="ExportExcel" Disabled="@(!_data.Any())">Excel</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           OnClick="ExportPdf" Disabled="@(!_data.Any())">PDF</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Email" 
                           OnClick="SendEmail" Disabled="@(!_data.Any() || _isSendingEmail)">
                    @if (_isSendingEmail) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                    Email
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="3">
                <MudSelect T="long?" Label="Customer" @bind-Value="_customerId" Variant="Variant.Outlined" Dense="true">
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem Value="@((long?)customer.Id)">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" FullWidth="true">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
        else if (_data.Any())
        {
            <MudPaper Class="pa-4 mt-4" Elevation="1" Style="background: var(--mud-palette-grey-lighten-4);">
                <MudGrid>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Opening Balance</MudText>
                        <MudText Typo="Typo.h6">@_openingBalance.ToString("N2")</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Total Debit</MudText>
                        <MudText Typo="Typo.h6">@_data.Sum(x => x.Debit).ToString("N2")</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Total Credit</MudText>
                        <MudText Typo="Typo.h6">@_data.Sum(x => x.Credit).ToString("N2")</MudText>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudText Typo="Typo.caption">Closing Balance</MudText>
                        <MudText Typo="Typo.h6" Color="@(_closingBalance >= 0 ? Color.Default : Color.Error)">
                            @_closingBalance.ToString("N2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudTable Items="@_data" Dense="true" Hover="true" Striped="true" Class="mt-4" FixedHeader="true" Height="450px">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Voucher No</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Particulars</MudTh>
                    <MudTh Style="text-align: right">Debit</MudTh>
                    <MudTh Style="text-align: right">Credit</MudTh>
                    <MudTh Style="text-align: right">Balance</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Date.ToString("dd-MMM-yyyy")</MudTd>
                    <MudTd>@context.VoucherNo</MudTd>
                    <MudTd>@context.VoucherType</MudTd>
                    <MudTd>@context.Particulars</MudTd>
                    <MudTd Style="text-align: right">@(context.Debit > 0 ? context.Debit.ToString("N2") : "")</MudTd>
                    <MudTd Style="text-align: right">@(context.Credit > 0 ? context.Credit.ToString("N2") : "")</MudTd>
                    <MudTd Style="text-align: right; font-weight: bold;">@context.Balance.ToString("N2")</MudTd>
                </RowTemplate>
            </MudTable>
        }
        else if (!_isLoading && _customerId.HasValue)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No transactions found for the selected period.</MudAlert>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Select a customer and click Generate to load ledger.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<LedgerEntry> _data = new();
    private List<Party> _customers = new();
    private long? _customerId;
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 4, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private decimal _openingBalance;
    private decimal _closingBalance;
    private bool _isLoading;
    private bool _isSendingEmail;
    private Net4Courier.Masters.Entities.Branch? _currentBranch;

    protected override async Task OnInitializedAsync()
    {
        _customers = await DbContext.Parties
            .Where(p => p.IsActive && !p.IsDeleted && p.PartyType == PartyType.Customer)
            .OrderBy(p => p.Name)
            .ToListAsync();

        _currentBranch = await DbContext.Branches.FirstOrDefaultAsync(b => b.IsActive && !b.IsDeleted);
    }

    private async Task LoadData()
    {
        if (!_customerId.HasValue)
        {
            Snackbar.Add("Please select a customer", Severity.Warning);
            return;
        }

        _isLoading = true;
        _data.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) : DateTime.MinValue;
            var toUtc = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1), DateTimeKind.Utc) : DateTime.MaxValue;

            var customer = await DbContext.Parties.FindAsync(_customerId.Value);
            _openingBalance = 0;

            // Get invoices for this customer
            var invoices = await DbContext.Invoices
                .Where(i => i.CustomerId == _customerId && !i.IsDeleted)
                .Where(i => i.InvoiceDate >= fromUtc && i.InvoiceDate < toUtc)
                .OrderBy(i => i.InvoiceDate)
                .ThenBy(i => i.Id)
                .ToListAsync();

            // Get receipts for this customer
            var receipts = await DbContext.Receipts
                .Where(r => r.CustomerId == _customerId && !r.IsDeleted)
                .Where(r => r.ReceiptDate >= fromUtc && r.ReceiptDate < toUtc)
                .OrderBy(r => r.ReceiptDate)
                .ThenBy(r => r.Id)
                .ToListAsync();

            // Combine and sort by date
            var allTransactions = new List<(DateTime Date, string VoucherNo, string VoucherType, string Particulars, decimal Debit, decimal Credit)>();

            foreach (var inv in invoices)
            {
                allTransactions.Add((inv.InvoiceDate, inv.InvoiceNo ?? "", "Invoice", $"Invoice - {inv.TotalAWBs} AWB(s)", inv.NetTotal ?? 0, 0));
            }

            foreach (var rcp in receipts)
            {
                allTransactions.Add((rcp.ReceiptDate, rcp.ReceiptNo ?? "", "Receipt", rcp.Remarks ?? "Payment Received", 0, rcp.Amount ?? 0));
            }

            // Also check journals with PartyId
            var journalEntries = await DbContext.Journals
                .Include(j => j.Entries)
                .Where(j => j.VoucherDate >= fromUtc && j.VoucherDate < toUtc)
                .Where(j => j.Entries.Any(e => e.PartyId == _customerId))
                .OrderBy(j => j.VoucherDate)
                .ThenBy(j => j.Id)
                .ToListAsync();

            foreach (var journal in journalEntries)
            {
                var entry = journal.Entries.FirstOrDefault(e => e.PartyId == _customerId);
                if (entry != null)
                {
                    allTransactions.Add((journal.VoucherDate, journal.VoucherNo ?? "", journal.VoucherType ?? "Journal", journal.Narration ?? "", entry.Debit ?? 0, entry.Credit ?? 0));
                }
            }

            // Sort all transactions by date
            allTransactions = allTransactions.OrderBy(t => t.Date).ThenBy(t => t.VoucherNo).ToList();

            decimal runningBalance = _openingBalance;

            foreach (var txn in allTransactions)
            {
                runningBalance = runningBalance + txn.Debit - txn.Credit;

                _data.Add(new LedgerEntry
                {
                    Date = txn.Date,
                    VoucherNo = txn.VoucherNo,
                    VoucherType = txn.VoucherType,
                    Particulars = txn.Particulars,
                    Debit = txn.Debit,
                    Credit = txn.Credit,
                    Balance = runningBalance
                });
            }

            _closingBalance = runningBalance;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task ExportExcel()
    {
        var columns = new Dictionary<string, Func<LedgerEntry, object?>>
        {
            { "Date", x => x.Date },
            { "Voucher No", x => x.VoucherNo },
            { "Type", x => x.VoucherType },
            { "Particulars", x => x.Particulars },
            { "Debit", x => x.Debit },
            { "Credit", x => x.Credit },
            { "Balance", x => x.Balance }
        };

        var bytes = ExportService.ExportToExcel("Customer Ledger", _data, columns);
        await DownloadFile(bytes, "CustomerLedger.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private async Task ExportPdf()
    {
        var columns = new Dictionary<string, Func<LedgerEntry, object?>>
        {
            { "Date", x => x.Date },
            { "Voucher No", x => x.VoucherNo },
            { "Type", x => x.VoucherType },
            { "Particulars", x => x.Particulars },
            { "Debit", x => x.Debit },
            { "Credit", x => x.Credit },
            { "Balance", x => x.Balance }
        };

        var totals = new Dictionary<string, decimal>
        {
            { "Debit", _data.Sum(x => x.Debit) },
            { "Credit", _data.Sum(x => x.Credit) }
        };

        var customerName = _customers.FirstOrDefault(s => s.Id == _customerId)?.Name ?? "";
        var subtitle = $"Customer: {customerName} | Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";
        var bytes = ExportService.ExportToPdf("Customer Ledger", subtitle, _data, columns, totals);
        await DownloadFile(bytes, "CustomerLedger.pdf", "application/pdf");
    }

    private async Task DownloadFile(byte[] bytes, string filename, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", filename, base64, contentType);
    }

    private async Task SendEmail()
    {
        if (!_customerId.HasValue || !_data.Any())
        {
            Snackbar.Add("Please generate the report first", Severity.Warning);
            return;
        }

        var customer = _customers.FirstOrDefault(c => c.Id == _customerId);
        if (customer == null)
        {
            Snackbar.Add("Customer not found", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(customer.Email))
        {
            Snackbar.Add("Customer does not have an email address configured", Severity.Warning);
            return;
        }

        _isSendingEmail = true;
        StateHasChanged();

        try
        {
            var columns = new Dictionary<string, Func<LedgerEntry, object?>>
            {
                { "Date", x => x.Date },
                { "Voucher No", x => x.VoucherNo },
                { "Type", x => x.VoucherType },
                { "Particulars", x => x.Particulars },
                { "Debit", x => x.Debit },
                { "Credit", x => x.Credit },
                { "Balance", x => x.Balance }
            };

            var totals = new Dictionary<string, decimal>
            {
                { "Debit", _data.Sum(x => x.Debit) },
                { "Credit", _data.Sum(x => x.Credit) }
            };

            var subtitle = $"Customer: {customer.Name} | Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";
            var pdfBytes = ExportService.ExportToPdf("Customer Ledger", subtitle, _data, columns, totals);

            var fromEmail = _currentBranch?.Email ?? "noreply@net4courier.com";
            var fromName = _currentBranch?.Name ?? "Net4Courier";
            var subject = $"Customer Ledger - {customer.Name} ({_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy})";

            var htmlBody = $@"
                <html>
                <body style='font-family: Arial, sans-serif;'>
                    <h2>Customer Ledger</h2>
                    <p>Dear {customer.Name},</p>
                    <p>Please find attached your Customer Ledger for the period {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}.</p>
                    <table style='border-collapse: collapse; margin: 20px 0;'>
                        <tr><td style='padding: 5px 10px;'><strong>Opening Balance:</strong></td><td style='padding: 5px 10px;'>{_openingBalance:N2}</td></tr>
                        <tr><td style='padding: 5px 10px;'><strong>Total Debit:</strong></td><td style='padding: 5px 10px;'>{_data.Sum(x => x.Debit):N2}</td></tr>
                        <tr><td style='padding: 5px 10px;'><strong>Total Credit:</strong></td><td style='padding: 5px 10px;'>{_data.Sum(x => x.Credit):N2}</td></tr>
                        <tr><td style='padding: 5px 10px;'><strong>Closing Balance:</strong></td><td style='padding: 5px 10px;'>{_closingBalance:N2}</td></tr>
                    </table>
                    <p>Best Regards,<br/>{fromName}</p>
                </body>
                </html>";

            var fileName = $"CustomerLedger_{customer.Code}_{_fromDate:yyyyMMdd}_{_toDate:yyyyMMdd}.pdf";
            var success = await EmailService.SendEmailWithAttachmentAsync(
                customer.Email,
                customer.Name,
                subject,
                htmlBody,
                pdfBytes,
                fileName,
                "application/pdf",
                fromEmail,
                fromName
            );

            if (success)
            {
                Snackbar.Add($"Email sent successfully to {customer.Email}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send email. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending email: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSendingEmail = false;
            StateHasChanged();
        }
    }

    private class LedgerEntry
    {
        public DateTime Date { get; set; }
        public string VoucherNo { get; set; } = "";
        public string VoucherType { get; set; } = "";
        public string Particulars { get; set; } = "";
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
    }
}

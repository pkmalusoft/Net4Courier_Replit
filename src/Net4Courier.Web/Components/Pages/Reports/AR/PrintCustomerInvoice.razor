@page "/reports/ar/print-invoice/{InvoiceId:long}"
@page "/reports/ar/print-invoice"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@using Microsoft.JSInterop
@inject ApplicationDbContext DbContext
@inject ReportingService ReportingService
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Print Invoice - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h5">Print Customer Invoice</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           OnClick="ExportPdf" Disabled="@(_invoice == null)">Download PDF</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Print" 
                           OnClick="PrintInvoice" Disabled="@(_invoice == null)">Print</MudButton>
            </MudItem>
        </MudGrid>

        @if (InvoiceId == 0)
        {
            <MudGrid Class="mt-4">
                <MudItem xs="12" sm="4">
                    <MudAutocomplete T="Invoice" Label="Search Invoice" @bind-Value="_selectedInvoice"
                                     SearchFunc="@SearchInvoices" ToStringFunc="@(x => x?.InvoiceNo ?? "")"
                                     Variant="Variant.Outlined" Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadInvoice" FullWidth="true"
                               Disabled="@(_selectedInvoice == null)">
                        Load
                    </MudButton>
                </MudItem>
            </MudGrid>
        }

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
        else if (_invoice != null)
        {
            <MudDivider Class="my-4" />
            
            <MudPaper Class="pa-6" Outlined="true">
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.h4" Class="mb-2">@(_company?.Name ?? "Net4Courier")</MudText>
                        <MudText Typo="Typo.body2">@(_company?.Address ?? "")</MudText>
                        <MudText Typo="Typo.body2">@(_company?.City?.Name ?? ""), @(_company?.Country?.Name ?? "")</MudText>
                        <MudText Typo="Typo.body2">Phone: @(_company?.Phone ?? "")</MudText>
                        @if (!string.IsNullOrEmpty(_company?.TaxNumber))
                        {
                            <MudText Typo="Typo.body2">TRN: @_company.TaxNumber</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6" Class="text-right">
                        <MudText Typo="Typo.h5" Color="Color.Primary">INVOICE</MudText>
                        <MudText Typo="Typo.h6">@_invoice.InvoiceNo</MudText>
                        <MudText Typo="Typo.body2">Date: @_invoice.InvoiceDate.ToString("dd-MMM-yyyy")</MudText>
                        @if (_invoice.DueDate.HasValue)
                        {
                            <MudText Typo="Typo.body2">Due: @_invoice.DueDate.Value.ToString("dd-MMM-yyyy")</MudText>
                        }
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_invoice.Status.ToString())" Class="mt-2">
                            @_invoice.Status.ToString()
                        </MudChip>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Bill To:</MudText>
                        <MudText Typo="Typo.body1"><strong>@_invoice.CustomerName</strong></MudText>
                        <MudText Typo="Typo.body2">@_invoice.CustomerAddress</MudText>
                        @if (!string.IsNullOrEmpty(_invoice.CustomerTaxNo))
                        {
                            <MudText Typo="Typo.body2">TRN: @_invoice.CustomerTaxNo</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6">
                        @if (_invoice.PeriodFrom.HasValue && _invoice.PeriodTo.HasValue)
                        {
                            <MudText Typo="Typo.body2">
                                <strong>Period:</strong> @_invoice.PeriodFrom.Value.ToString("dd-MMM-yyyy") to @_invoice.PeriodTo.Value.ToString("dd-MMM-yyyy")
                            </MudText>
                        }
                    </MudItem>
                </MudGrid>

                <MudTable Items="@_invoice.Details" Dense="true" Class="mt-4" Elevation="0" Outlined="true">
                    <HeaderContent>
                        <MudTh>#</MudTh>
                        <MudTh>AWB No</MudTh>
                        <MudTh>Date</MudTh>
                        <MudTh>Origin</MudTh>
                        <MudTh>Destination</MudTh>
                        <MudTh Style="text-align: center">Pcs</MudTh>
                        <MudTh Style="text-align: right">Weight</MudTh>
                        <MudTh Style="text-align: right">Rate</MudTh>
                        <MudTh Style="text-align: right">Amount</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        @{
                            var idx = _invoice.Details.ToList().IndexOf(context) + 1;
                        }
                        <MudTd>@idx</MudTd>
                        <MudTd>@context.AWBNo</MudTd>
                        <MudTd>@context.AWBDate?.ToString("dd-MMM")</MudTd>
                        <MudTd>@context.Origin</MudTd>
                        <MudTd>@context.Destination</MudTd>
                        <MudTd Style="text-align: center">@context.Pieces</MudTd>
                        <MudTd Style="text-align: right">@(context.Weight?.ToString("N2") ?? "0.00")</MudTd>
                        <MudTd Style="text-align: right">@(context.CourierCharge?.ToString("N2") ?? "0.00")</MudTd>
                        <MudTd Style="text-align: right">@(context.Total?.ToString("N2") ?? "0.00")</MudTd>
                    </RowTemplate>
                </MudTable>

                <MudGrid Class="mt-4">
                    <MudItem xs="6">
                        @if (!string.IsNullOrEmpty(_invoice.Remarks))
                        {
                            <MudText Typo="Typo.body2"><strong>Remarks:</strong> @_invoice.Remarks</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6">
                        <MudPaper Class="pa-3" Outlined="true">
                            <MudStack Spacing="1">
                                <div class="d-flex justify-space-between">
                                    <MudText>Sub Total:</MudText>
                                    <MudText>@((_invoice.SubTotal ?? 0).ToString("N2"))</MudText>
                                </div>
                                @if ((_invoice.TaxAmount ?? 0) > 0)
                                {
                                    <div class="d-flex justify-space-between">
                                        <MudText>Tax (@(_invoice.TaxPercent ?? 0)%):</MudText>
                                        <MudText>@((_invoice.TaxAmount ?? 0).ToString("N2"))</MudText>
                                    </div>
                                }
                                @if ((_invoice.DiscountAmount ?? 0) > 0)
                                {
                                    <div class="d-flex justify-space-between">
                                        <MudText>Discount:</MudText>
                                        <MudText>-@((_invoice.DiscountAmount ?? 0).ToString("N2"))</MudText>
                                    </div>
                                }
                                <MudDivider />
                                <div class="d-flex justify-space-between">
                                    <MudText Typo="Typo.subtitle1"><strong>Net Total:</strong></MudText>
                                    <MudText Typo="Typo.subtitle1"><strong>@((_invoice.NetTotal ?? 0).ToString("N2"))</strong></MudText>
                                </div>
                                @if ((_invoice.PaidAmount ?? 0) > 0)
                                {
                                    <div class="d-flex justify-space-between">
                                        <MudText>Paid:</MudText>
                                        <MudText Color="Color.Success">@((_invoice.PaidAmount ?? 0).ToString("N2"))</MudText>
                                    </div>
                                    <div class="d-flex justify-space-between">
                                        <MudText Typo="Typo.subtitle1"><strong>Balance:</strong></MudText>
                                        <MudText Typo="Typo.subtitle1" Color="Color.Error"><strong>@((_invoice.BalanceAmount ?? 0).ToString("N2"))</strong></MudText>
                                    </div>
                                }
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (!_isLoading && InvoiceId > 0)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-4">Invoice not found.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public long InvoiceId { get; set; }

    private Invoice? _invoice;
    private Invoice? _selectedInvoice;
    private Company? _company;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        _company = await DbContext.Companies
            .Include(c => c.City)
            .Include(c => c.Country)
            .FirstOrDefaultAsync();

        if (InvoiceId > 0)
        {
            await LoadInvoiceById(InvoiceId);
        }
    }

    private async Task<IEnumerable<Invoice>> SearchInvoices(string search, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(search))
            return await DbContext.Invoices.OrderByDescending(i => i.InvoiceDate).Take(20).ToListAsync();

        return await DbContext.Invoices
            .Where(i => i.InvoiceNo!.Contains(search) || i.CustomerName!.Contains(search))
            .OrderByDescending(i => i.InvoiceDate)
            .Take(20)
            .ToListAsync();
    }

    private async Task LoadInvoice()
    {
        if (_selectedInvoice != null)
        {
            await LoadInvoiceById(_selectedInvoice.Id);
        }
    }

    private async Task LoadInvoiceById(long id)
    {
        _isLoading = true;

        try
        {
            _invoice = await DbContext.Invoices
                .Include(i => i.Details)
                .FirstOrDefaultAsync(i => i.Id == id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task ExportPdf()
    {
        if (_invoice == null) return;

        try
        {
            var bytes = ReportingService.GenerateInvoicePdf(_invoice);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("downloadFile", $"Invoice_{_invoice.InvoiceNo}.pdf", base64, "application/pdf");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task PrintInvoice()
    {
        if (_invoice == null) return;

        try
        {
            var bytes = ReportingService.GenerateInvoicePdf(_invoice);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("eval", $@"
                var byteCharacters = atob('{base64}');
                var byteNumbers = new Array(byteCharacters.length);
                for (var i = 0; i < byteCharacters.length; i++) {{
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }}
                var byteArray = new Uint8Array(byteNumbers);
                var blob = new Blob([byteArray], {{type: 'application/pdf'}});
                var url = URL.createObjectURL(blob);
                var printWindow = window.open(url, '_blank');
                if (printWindow) {{
                    printWindow.onload = function() {{
                        printWindow.focus();
                        printWindow.print();
                    }};
                }}
            ");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error printing: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Posted" => Color.Success,
        "Paid" => Color.Info,
        "Cancelled" => Color.Error,
        _ => Color.Default
    };
}

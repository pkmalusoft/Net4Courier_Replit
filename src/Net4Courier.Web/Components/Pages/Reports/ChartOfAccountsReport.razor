@page "/n4c-reports/chart-of-accounts"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Chart of Accounts</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h5">Chart of Accounts</MudText>
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex justify-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport">
                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-1" /> Refresh
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-3">
            <MudItem xs="12" md="4">
                <MudSelect T="AccountClassification?" Label="Classification" @bind-Value="_selectedClassification" Clearable>
                    @foreach (AccountClassification classification in Enum.GetValues(typeof(AccountClassification)))
                    {
                        <MudSelectItem Value="@((AccountClassification?)classification)">@classification</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField T="string" Label="Search" @bind-Value="_searchText" 
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudCheckBox @bind-Value="_showInactive" Label="Show Inactive Accounts" />
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (_groupedAccounts.Any())
        {
            <div class="mt-4">
                @foreach (var group in _groupedAccounts.OrderBy(g => (int)g.Key))
                {
                    <MudExpansionPanels Class="mb-2">
                        <MudExpansionPanel InitiallyExpanded="true">
                            <TitleContent>
                                <MudGrid>
                                    <MudItem xs="8">
                                        <MudIcon Icon="@GetClassificationIcon(group.Key)" Class="mr-2" />
                                        <MudText Typo="Typo.subtitle1" Style="display: inline;">
                                            <strong>@group.Key</strong>
                                        </MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">
                                            @group.Value.Count accounts
                                        </MudChip>
                                    </MudItem>
                                    <MudItem xs="4" Style="text-align: right">
                                        <MudText Color="@GetClassificationColor(group.Key)">
                                            Balance: @group.Value.Sum(a => a.Balance).ToString("N2")
                                        </MudText>
                                    </MudItem>
                                </MudGrid>
                            </TitleContent>
                            <ChildContent>
                                <MudTable Items="@group.Value" Hover="true" Dense="true" Striped="true">
                                    <HeaderContent>
                                        @if (!_hideAccountCodes)
                                        {
                                            <MudTh>Code</MudTh>
                                        }
                                        <MudTh>Account Name</MudTh>
                                        <MudTh>Group</MudTh>
                                        <MudTh>Nature</MudTh>
                                        <MudTh Style="text-align: center">Status</MudTh>
                                        <MudTh Style="text-align: right">Balance</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        @if (!_hideAccountCodes)
                                        {
                                            <MudTd>
                                                <MudText Typo="Typo.body2"><strong>@context.Code</strong></MudText>
                                            </MudTd>
                                        }
                                        <MudTd>
                                            @if (context.Level > 0)
                                            {
                                                <span style="margin-left: @(context.Level * 20)px">@context.Name</span>
                                            }
                                            else
                                            {
                                                @context.Name
                                            }
                                        </MudTd>
                                        <MudTd>@context.AccountGroup</MudTd>
                                        <MudTd>@context.AccountNature</MudTd>
                                        <MudTd Style="text-align: center">
                                            @if (context.IsActive)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                                            }
                                            else
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Error">Inactive</MudChip>
                                            }
                                        </MudTd>
                                        <MudTd Style="text-align: right">
                                            <MudText Color="@(context.Balance >= 0 ? Color.Success : Color.Error)">
                                                @context.Balance.ToString("N2")
                                            </MudText>
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            </div>

            <MudPaper Class="pa-3 mt-4" Elevation="0" Style="background-color: #f5f5f5;">
                <MudGrid>
                    <MudItem xs="4">
                        <MudText><strong>Total Accounts:</strong> @_groupedAccounts.SelectMany(g => g.Value).Count()</MudText>
                    </MudItem>
                    <MudItem xs="4">
                        <MudText><strong>Active:</strong> @_groupedAccounts.SelectMany(g => g.Value).Count(a => a.IsActive)</MudText>
                    </MudItem>
                    <MudItem xs="4" Style="text-align: right">
                        <MudText><strong>Inactive:</strong> @_groupedAccounts.SelectMany(g => g.Value).Count(a => !a.IsActive)</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No accounts found. Click Refresh to load accounts.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private AccountClassification? _selectedClassification;
    private string? _searchText;
    private bool _showInactive = false;
    private bool _isLoading = false;
    private bool _hideAccountCodes;
    private Dictionary<AccountClassification, List<AccountItem>> _groupedAccounts = new();

    protected override async Task OnInitializedAsync()
    {
        LoadBranchSettings();
        await LoadReport();
    }

    private void LoadBranchSettings()
    {
        var authProvider = (AppAuthStateProvider)AuthStateProvider;
        _hideAccountCodes = authProvider.CurrentBranch?.HideAccountCodes ?? false;
    }

    private async Task LoadReport()
    {
        _isLoading = true;
        _groupedAccounts.Clear();
        StateHasChanged();

        try
        {
            var accountsQuery = DbContext.AccountHeads
                .Include(a => a.Parent)
                .AsQueryable();

            if (_selectedClassification.HasValue)
                accountsQuery = accountsQuery.Where(a => a.Classification == _selectedClassification.Value);

            if (!_showInactive)
                accountsQuery = accountsQuery.Where(a => a.IsActive);

            if (!string.IsNullOrEmpty(_searchText))
                accountsQuery = accountsQuery.Where(a => 
                    a.Name.Contains(_searchText) || a.Code.Contains(_searchText));

            var accounts = await accountsQuery.OrderBy(a => a.Code).ToListAsync();

            var journals = await DbContext.Journals
                .Include(j => j.Entries)
                .ToListAsync();
            var allEntries = journals.SelectMany(j => j.Entries).ToList();

            var items = accounts.Select(a => new AccountItem
            {
                Id = a.Id,
                Code = a.Code,
                Name = a.Name,
                Classification = a.Classification,
                AccountGroup = a.AccountGroup.ToString(),
                AccountNature = a.AccountNature.ToString(),
                IsActive = a.IsActive,
                Level = a.Level,
                Balance = allEntries.Where(e => e.AccountHeadId == a.Id)
                    .Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0))
            }).ToList();

            _groupedAccounts = items.GroupBy(a => a.Classification)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading chart of accounts: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetClassificationIcon(AccountClassification classification)
    {
        return classification switch
        {
            AccountClassification.Assets => Icons.Material.Filled.AccountBalance,
            AccountClassification.Liabilities => Icons.Material.Filled.CreditCard,
            AccountClassification.Equity => Icons.Material.Filled.Savings,
            AccountClassification.Income => Icons.Material.Filled.TrendingUp,
            AccountClassification.Expenditure => Icons.Material.Filled.TrendingDown,
            _ => Icons.Material.Filled.AccountTree
        };
    }

    private Color GetClassificationColor(AccountClassification classification)
    {
        return classification switch
        {
            AccountClassification.Assets => Color.Primary,
            AccountClassification.Liabilities => Color.Error,
            AccountClassification.Equity => Color.Info,
            AccountClassification.Income => Color.Success,
            AccountClassification.Expenditure => Color.Error,
            _ => Color.Default
        };
    }

    private class AccountItem
    {
        public long Id { get; set; }
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public AccountClassification Classification { get; set; }
        public string AccountGroup { get; set; } = "";
        public string AccountNature { get; set; } = "";
        public bool IsActive { get; set; }
        public int Level { get; set; }
        public decimal Balance { get; set; }
    }
}

@page "/reports/ap/supplier-statement"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Microsoft.JSInterop
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ReportExportService ExportService
@inject IGmailEmailService EmailService
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Supplier Statement - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h5">Supplier Statement</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.TableChart" 
                           OnClick="ExportExcel" Disabled="@(!_data.Any())">Excel</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           OnClick="ExportPdf" Disabled="@(!_data.Any())">PDF</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Email" 
                           OnClick="SendEmail" Disabled="@(!_data.Any() || _isSendingEmail)">
                    @if (_isSendingEmail) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                    Email
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="3">
                <MudSelect T="long?" Label="Supplier" @bind-Value="_supplierId" Variant="Variant.Outlined" Dense="true">
                    @foreach (var supplier in _suppliers)
                    {
                        <MudSelectItem Value="@((long?)supplier.Id)">@supplier.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" FullWidth="true">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
        else if (_data.Any())
        {
            <MudPaper Class="pa-4 mt-4" Elevation="1" Outlined="true">
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.h6">@_supplierName</MudText>
                        <MudText Typo="Typo.body2">@_supplierAddress</MudText>
                    </MudItem>
                    <MudItem xs="6" Class="text-right">
                        <MudText Typo="Typo.body2">Statement Period</MudText>
                        <MudText Typo="Typo.subtitle1">@_fromDate?.ToString("dd-MMM-yyyy") to @_toDate?.ToString("dd-MMM-yyyy")</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudTable Items="@_data" Dense="true" Hover="true" Striped="true" Class="mt-4" FixedHeader="true" Height="400px">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Reference</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh Style="text-align: right">Invoice</MudTh>
                    <MudTh Style="text-align: right">Payment</MudTh>
                    <MudTh Style="text-align: right">Balance</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Date.ToString("dd-MMM-yyyy")</MudTd>
                    <MudTd>@context.Reference</MudTd>
                    <MudTd>@context.Description</MudTd>
                    <MudTd Style="text-align: right">@(context.Invoice > 0 ? context.Invoice.ToString("N2") : "")</MudTd>
                    <MudTd Style="text-align: right">@(context.Payment > 0 ? context.Payment.ToString("N2") : "")</MudTd>
                    <MudTd Style="text-align: right; font-weight: bold;">@context.Balance.ToString("N2")</MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTd colspan="3"><strong>Totals</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.Invoice).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.Payment).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_closingBalance.ToString("N2")</strong></MudTd>
                </FooterContent>
            </MudTable>
        }
        else if (!_isLoading && _supplierId.HasValue)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No transactions found for the selected period.</MudAlert>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Select a supplier and click Generate to load statement.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<StatementEntry> _data = new();
    private List<Party> _suppliers = new();
    private long? _supplierId;
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private string _supplierName = "";
    private string _supplierAddress = "";
    private decimal _closingBalance;
    private bool _isLoading;
    private bool _isSendingEmail;
    private Net4Courier.Masters.Entities.Branch? _currentBranch;

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _suppliers = await dbContext.Parties
            .Where(p => p.IsActive && p.AccountNature == PartyAccountNature.Payable)
            .OrderBy(p => p.Name)
            .ToListAsync();
        
        _currentBranch = await dbContext.Branches.FirstOrDefaultAsync(b => b.IsActive && !b.IsDeleted);
    }

    private async Task LoadData()
    {
        if (!_supplierId.HasValue)
        {
            Snackbar.Add("Please select a supplier", Severity.Warning);
            return;
        }

        await using var dbContext = await DbFactory.CreateDbContextAsync();

        _isLoading = true;
        _data.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) : DateTime.MinValue;
            var toUtc = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) : DateTime.MaxValue;

            var supplier = await dbContext.Parties.FindAsync(_supplierId.Value);
            if (supplier != null)
            {
                _supplierName = supplier.Name;
                _supplierAddress = supplier.ClientAddress ?? "";
            }

            var journalEntries = await dbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => e.PartyId == _supplierId && e.Journal.VoucherDate >= fromUtc && e.Journal.VoucherDate <= toUtc)
                .OrderBy(e => e.Journal.VoucherDate)
                .ToListAsync();

            var allEntries = new List<StatementEntry>();

            foreach (var entry in journalEntries)
            {
                allEntries.Add(new StatementEntry
                {
                    Date = entry.Journal.VoucherDate,
                    Reference = entry.Journal.VoucherNo ?? "",
                    Description = entry.Journal.Narration ?? entry.Journal.VoucherType ?? "",
                    Invoice = entry.Credit ?? 0,
                    Payment = entry.Debit ?? 0
                });
            }

            allEntries = allEntries.OrderBy(e => e.Date).ThenBy(e => e.Reference).ToList();

            decimal runningBalance = 0;
            foreach (var entry in allEntries)
            {
                runningBalance = runningBalance + entry.Invoice - entry.Payment;
                entry.Balance = runningBalance;
            }

            _data = allEntries;
            _closingBalance = runningBalance;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task ExportExcel()
    {
        var columns = new Dictionary<string, Func<StatementEntry, object?>>
        {
            { "Date", x => x.Date },
            { "Reference", x => x.Reference },
            { "Description", x => x.Description },
            { "Invoice", x => x.Invoice },
            { "Payment", x => x.Payment },
            { "Balance", x => x.Balance }
        };

        var bytes = ExportService.ExportToExcel("Supplier Statement", _data, columns);
        await DownloadFile(bytes, "SupplierStatement.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private async Task ExportPdf()
    {
        var columns = new Dictionary<string, Func<StatementEntry, object?>>
        {
            { "Date", x => x.Date },
            { "Reference", x => x.Reference },
            { "Description", x => x.Description },
            { "Invoice", x => x.Invoice },
            { "Payment", x => x.Payment },
            { "Balance", x => x.Balance }
        };

        var totals = new Dictionary<string, decimal>
        {
            { "Invoice", _data.Sum(x => x.Invoice) },
            { "Payment", _data.Sum(x => x.Payment) },
            { "Balance", _closingBalance }
        };

        var subtitle = $"Supplier: {_supplierName} | Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";
        var bytes = ExportService.ExportToPdf("Supplier Statement", subtitle, _data, columns, totals);
        await DownloadFile(bytes, "SupplierStatement.pdf", "application/pdf");
    }

    private async Task DownloadFile(byte[] bytes, string filename, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", filename, base64, contentType);
    }

    private async Task SendEmail()
    {
        if (!_supplierId.HasValue || !_data.Any())
        {
            Snackbar.Add("Please generate the report first", Severity.Warning);
            return;
        }

        var supplier = _suppliers.FirstOrDefault(s => s.Id == _supplierId);
        if (supplier == null)
        {
            Snackbar.Add("Supplier not found", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(supplier.Email))
        {
            Snackbar.Add("Supplier does not have an email address configured", Severity.Warning);
            return;
        }

        _isSendingEmail = true;
        StateHasChanged();

        try
        {
            var columns = new Dictionary<string, Func<StatementEntry, object?>>
            {
                { "Date", x => x.Date },
                { "Reference", x => x.Reference },
                { "Description", x => x.Description },
                { "Invoice", x => x.Invoice },
                { "Payment", x => x.Payment },
                { "Balance", x => x.Balance }
            };

            var totals = new Dictionary<string, decimal>
            {
                { "Invoice", _data.Sum(x => x.Invoice) },
                { "Payment", _data.Sum(x => x.Payment) },
                { "Balance", _closingBalance }
            };

            var subtitle = $"Supplier: {_supplierName} | Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";
            var pdfBytes = ExportService.ExportToPdf("Supplier Statement", subtitle, _data, columns, totals);

            var fromEmail = _currentBranch?.Email ?? "noreply@net4courier.com";
            var fromName = _currentBranch?.Name ?? "Net4Courier";
            var subject = $"Supplier Statement - {_supplierName} ({_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy})";

            var htmlBody = $@"
                <html>
                <body style='font-family: Arial, sans-serif;'>
                    <h2>Supplier Statement</h2>
                    <p>Dear {_supplierName},</p>
                    <p>Please find attached your Supplier Statement for the period {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}.</p>
                    <table style='border-collapse: collapse; margin: 20px 0;'>
                        <tr><td style='padding: 5px 10px;'><strong>Total Invoice:</strong></td><td style='padding: 5px 10px;'>{_data.Sum(x => x.Invoice):N2}</td></tr>
                        <tr><td style='padding: 5px 10px;'><strong>Total Payment:</strong></td><td style='padding: 5px 10px;'>{_data.Sum(x => x.Payment):N2}</td></tr>
                        <tr><td style='padding: 5px 10px;'><strong>Closing Balance:</strong></td><td style='padding: 5px 10px;'>{_closingBalance:N2}</td></tr>
                    </table>
                    <p>Best Regards,<br/>{fromName}</p>
                </body>
                </html>";

            var fileName = $"SupplierStatement_{supplier.Code}_{_fromDate:yyyyMMdd}_{_toDate:yyyyMMdd}.pdf";
            var success = await EmailService.SendEmailWithAttachmentAsync(
                supplier.Email,
                _supplierName,
                subject,
                htmlBody,
                pdfBytes,
                fileName,
                "application/pdf",
                fromEmail,
                fromName
            );

            if (success)
            {
                Snackbar.Add($"Email sent successfully to {supplier.Email}", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send email. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending email: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSendingEmail = false;
            StateHasChanged();
        }
    }

    private class StatementEntry
    {
        public DateTime Date { get; set; }
        public string Reference { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Invoice { get; set; }
        public decimal Payment { get; set; }
        public decimal Balance { get; set; }
    }
}

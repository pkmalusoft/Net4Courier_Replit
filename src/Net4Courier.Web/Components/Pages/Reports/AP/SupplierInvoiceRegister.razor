@page "/reports/ap/supplier-invoice-register"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Microsoft.JSInterop
@inject ApplicationDbContext DbContext
@inject ReportExportService ExportService
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Supplier Invoice Register - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h5">Supplier Invoice Register</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.TableChart" 
                           OnClick="ExportExcel" Disabled="@(!_data.Any())">Excel</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf" 
                           OnClick="ExportPdf" Disabled="@(!_data.Any())">PDF</MudButton>
            </MudItem>
        </MudGrid>

        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect T="long?" Label="Supplier" @bind-Value="_supplierId" Clearable Variant="Variant.Outlined" Dense="true">
                    @foreach (var supplier in _suppliers)
                    {
                        <MudSelectItem Value="@((long?)supplier.Id)">@supplier.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="string" Label="Status" @bind-Value="_status" Clearable Variant="Variant.Outlined" Dense="true">
                    <MudSelectItem Value="@("Draft")">Draft</MudSelectItem>
                    <MudSelectItem Value="@("Posted")">Posted</MudSelectItem>
                    <MudSelectItem Value="@("Paid")">Paid</MudSelectItem>
                    <MudSelectItem Value="@("Cancelled")">Cancelled</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadData" FullWidth="true">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mt-4" />
        }
        else if (_data.Any())
        {
            <MudTable Items="@_data" Dense="true" Hover="true" Striped="true" Class="mt-4" FixedHeader="true" Height="500px">
                <HeaderContent>
                    <MudTh>Invoice No</MudTh>
                    <MudTh>Date</MudTh>
                    <MudTh>Supplier</MudTh>
                    <MudTh>Ref No</MudTh>
                    <MudTh Style="text-align: right">Gross</MudTh>
                    <MudTh Style="text-align: right">Tax</MudTh>
                    <MudTh Style="text-align: right">Net Total</MudTh>
                    <MudTh Style="text-align: right">Paid</MudTh>
                    <MudTh Style="text-align: right">Balance</MudTh>
                    <MudTh>Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.InvoiceNo</MudTd>
                    <MudTd>@context.InvoiceDate.ToString("dd-MMM-yyyy")</MudTd>
                    <MudTd>@context.SupplierName</MudTd>
                    <MudTd>@context.RefNo</MudTd>
                    <MudTd Style="text-align: right">@context.GrossAmount.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.TaxAmount.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.NetTotal.ToString("N2")</MudTd>
                    <MudTd Style="text-align: right">@context.PaidAmount.ToString("N2")</MudTd>
                    <MudTd Style="@($"text-align: right; font-weight: bold; {(context.BalanceAmount > 0 ? "color: red;" : "")}")">
                        @context.BalanceAmount.ToString("N2")
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
                    </MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTd colspan="4"><strong>Total (@_data.Count invoices)</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.GrossAmount).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.TaxAmount).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.NetTotal).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.PaidAmount).ToString("N2")</strong></MudTd>
                    <MudTd Style="text-align: right"><strong>@_data.Sum(x => x.BalanceAmount).ToString("N2")</strong></MudTd>
                    <MudTd></MudTd>
                </FooterContent>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Click Generate to load invoice register.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<InvoiceDto> _data = new();
    private List<Party> _suppliers = new();
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private long? _supplierId;
    private string? _status;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        _suppliers = await DbContext.Parties
            .Where(p => p.IsActive && p.AccountNature == PartyAccountNature.Payable)
            .OrderBy(p => p.Name)
            .ToListAsync();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        _data.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) : DateTime.MinValue;
            var toUtc = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) : DateTime.MaxValue;

            var query = DbContext.Journals
                .Include(j => j.Entries)
                .Where(j => j.VoucherDate >= fromUtc && j.VoucherDate <= toUtc)
                .Where(j => j.VoucherType == "Purchase" || j.VoucherType == "Expense");

            if (_supplierId.HasValue)
                query = query.Where(j => j.Entries.Any(e => e.PartyId == _supplierId));

            var journals = await query.OrderByDescending(j => j.VoucherDate).ThenByDescending(j => j.VoucherNo).ToListAsync();

            var suppliers = await DbContext.Parties.Where(p => p.AccountNature == PartyAccountNature.Payable).ToListAsync();

            _data = journals.Select(j =>
            {
                var entry = j.Entries.FirstOrDefault(e => e.PartyId.HasValue);
                var supplier = suppliers.FirstOrDefault(s => s.Id == entry?.PartyId);
                return new InvoiceDto
                {
                    InvoiceNo = j.VoucherNo ?? "",
                    InvoiceDate = j.VoucherDate,
                    SupplierName = supplier?.Name ?? "",
                    RefNo = j.Reference ?? "",
                    GrossAmount = entry?.Credit ?? 0,
                    TaxAmount = 0,
                    NetTotal = entry?.Credit ?? 0,
                    PaidAmount = 0,
                    BalanceAmount = entry?.Credit ?? 0,
                    Status = "Posted"
                };
            }).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private async Task ExportExcel()
    {
        var columns = new Dictionary<string, Func<InvoiceDto, object?>>
        {
            { "Invoice No", x => x.InvoiceNo },
            { "Date", x => x.InvoiceDate },
            { "Supplier", x => x.SupplierName },
            { "Ref No", x => x.RefNo },
            { "Gross Amount", x => x.GrossAmount },
            { "Tax Amount", x => x.TaxAmount },
            { "Net Total", x => x.NetTotal },
            { "Paid Amount", x => x.PaidAmount },
            { "Balance", x => x.BalanceAmount },
            { "Status", x => x.Status }
        };

        var bytes = ExportService.ExportToExcel("Supplier Invoice Register", _data, columns);
        await DownloadFile(bytes, "SupplierInvoiceRegister.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
    }

    private async Task ExportPdf()
    {
        var columns = new Dictionary<string, Func<InvoiceDto, object?>>
        {
            { "Invoice No", x => x.InvoiceNo },
            { "Date", x => x.InvoiceDate },
            { "Supplier", x => x.SupplierName },
            { "Gross", x => x.GrossAmount },
            { "Tax", x => x.TaxAmount },
            { "Net Total", x => x.NetTotal },
            { "Paid", x => x.PaidAmount },
            { "Balance", x => x.BalanceAmount },
            { "Status", x => x.Status }
        };

        var totals = new Dictionary<string, decimal>
        {
            { "Gross", _data.Sum(x => x.GrossAmount) },
            { "Tax", _data.Sum(x => x.TaxAmount) },
            { "Net Total", _data.Sum(x => x.NetTotal) },
            { "Paid", _data.Sum(x => x.PaidAmount) },
            { "Balance", _data.Sum(x => x.BalanceAmount) }
        };

        var subtitle = $"Period: {_fromDate:dd-MMM-yyyy} to {_toDate:dd-MMM-yyyy}";
        var bytes = ExportService.ExportToPdf("Supplier Invoice Register", subtitle, _data, columns, totals);
        await DownloadFile(bytes, "SupplierInvoiceRegister.pdf", "application/pdf");
    }

    private async Task DownloadFile(byte[] bytes, string filename, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", filename, base64, contentType);
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Posted" => Color.Success,
        "Paid" => Color.Info,
        "Cancelled" => Color.Error,
        _ => Color.Default
    };

    private class InvoiceDto
    {
        public string InvoiceNo { get; set; } = "";
        public DateTime InvoiceDate { get; set; }
        public string SupplierName { get; set; } = "";
        public string RefNo { get; set; } = "";
        public decimal GrossAmount { get; set; }
        public decimal TaxAmount { get; set; }
        public decimal NetTotal { get; set; }
        public decimal PaidAmount { get; set; }
        public decimal BalanceAmount { get; set; }
        public string Status { get; set; } = "";
    }
}

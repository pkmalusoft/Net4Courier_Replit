@page "/reports/day-book"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Day Book - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Day Book</MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_selectedDate" Label="Select Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="string" @bind-Value="_voucherType" Label="Voucher Type" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("All")">All Types</MudSelectItem>
                    <MudSelectItem Value="@("CV")">Cash Voucher</MudSelectItem>
                    <MudSelectItem Value="@("BV")">Bank Voucher</MudSelectItem>
                    <MudSelectItem Value="@("JV")">Journal Voucher</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDayBook" 
                           FullWidth="true" Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        </MudPaper>
    }
    else if (_vouchers.Any())
    {
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudGrid Class="mb-3">
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">Day Book - @_selectedDate?.ToString("dd MMMM yyyy")</MudText>
                    <MudText Typo="Typo.caption">@_vouchers.Count voucher(s) found</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Debit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@_totalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Credit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@_totalCredit.ToString("N2")</MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>

            @foreach (var voucher in _vouchers)
            {
                <MudCard Class="mb-3" Outlined="true">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.subtitle1">
                                        <b>@voucher.VoucherNo</b>
                                        <MudChip T="string" Size="Size.Small" Color="@GetVoucherTypeColor(voucher.VoucherType)" Class="ml-2">
                                            @GetVoucherTypeName(voucher.VoucherType)
                                        </MudChip>
                                        @if (voucher.IsPosted)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-1">Posted</MudChip>
                                        }
                                    </MudText>
                                    <MudText Typo="Typo.caption">@voucher.Narration</MudText>
                                </MudStack>
                                <MudStack Spacing="0" AlignItems="AlignItems.End">
                                    <MudText Typo="Typo.body2"><b>@voucher.TotalDebit?.ToString("N2")</b></MudText>
                                </MudStack>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudSimpleTable Dense="true" Hover="true">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th style="text-align:right; width:120px;">Debit</th>
                                    <th style="text-align:right; width:120px;">Credit</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in voucher.Entries)
                                {
                                    <tr>
                                        <td>@entry.AccountName</td>
                                        <td style="text-align:right">
                                            @if ((entry.Debit ?? 0) > 0)
                                            {
                                                <span style="color: var(--mud-palette-error);">@entry.Debit?.ToString("N2")</span>
                                            }
                                        </td>
                                        <td style="text-align:right">
                                            @if ((entry.Credit ?? 0) > 0)
                                            {
                                                <span style="color: var(--mud-palette-success);">@entry.Credit?.ToString("N2")</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudCardContent>
                </MudCard>
            }
        </MudPaper>
    }
    else if (_hasSearched)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudAlert Severity="Severity.Info">No vouchers found for the selected date.</MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private DateTime? _selectedDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private string _voucherType = "All";
    private List<Journal> _vouchers = new();
    private decimal _totalDebit;
    private decimal _totalCredit;
    private bool _isLoading;
    private bool _hasSearched;

    private async Task LoadDayBook()
    {
        _isLoading = true;
        _hasSearched = true;
        _vouchers.Clear();

        try
        {
            var dateUtc = DateTime.SpecifyKind(_selectedDate!.Value.Date, DateTimeKind.Utc);
            var endDateUtc = dateUtc.AddDays(1).AddTicks(-1);

            var query = DbContext.Journals
                .Include(j => j.Entries)
                .Where(j => !j.IsDeleted && 
                       j.VoucherDate >= dateUtc && j.VoucherDate <= endDateUtc);

            if (_voucherType != "All")
                query = query.Where(j => j.VoucherType == _voucherType);

            _vouchers = await query
                .OrderBy(j => j.VoucherNo)
                .ToListAsync();

            _totalDebit = _vouchers.Sum(v => v.TotalDebit ?? 0);
            _totalCredit = _vouchers.Sum(v => v.TotalCredit ?? 0);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading day book: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private Color GetVoucherTypeColor(string? type) => type switch
    {
        "CV" => Color.Info,
        "BV" => Color.Primary,
        "JV" => Color.Secondary,
        _ => Color.Default
    };

    private string GetVoucherTypeName(string? type) => type switch
    {
        "CV" => "Cash",
        "BV" => "Bank",
        "JV" => "Journal",
        _ => type ?? "Unknown"
    };
}

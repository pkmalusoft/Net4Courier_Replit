@page "/reports/trial-balance-detail"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar

<PageTitle>Trial Balance - Detailed</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">Trial Balance - Detailed with Transactions</MudText>

        <MudGrid>
            <MudItem xs="12" md="3">
                <MudDatePicker Label="From Date" @bind-Date="_fromDate" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudDatePicker Label="To Date" @bind-Date="_toDate" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="long?" Label="Branch" @bind-Value="_selectedBranchId" Clearable>
                    @foreach (var branch in _branches)
                    {
                        <MudSelectItem Value="@((long?)branch.Id)">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" Class="mr-2">
                    <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-1" /> Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (_reportData.Any())
        {
            <div class="mt-4">
                @foreach (var account in _reportData)
                {
                    <MudExpansionPanels Class="mb-2">
                        <MudExpansionPanel IsInitiallyExpanded="false">
                            <TitleContent>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.subtitle1">
                                            <strong>@account.AccountCode</strong> - @account.AccountName
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@account.Classification</MudText>
                                    </MudItem>
                                    <MudItem xs="3" Style="text-align: right">
                                        <MudText Color="Color.Success">Dr: @account.TotalDebit.ToString("N2")</MudText>
                                    </MudItem>
                                    <MudItem xs="3" Style="text-align: right">
                                        <MudText Color="Color.Error">Cr: @account.TotalCredit.ToString("N2")</MudText>
                                    </MudItem>
                                </MudGrid>
                            </TitleContent>
                            <ChildContent>
                                <MudTable Items="@account.Transactions" Hover="true" Dense="true" Striped="true">
                                    <HeaderContent>
                                        <MudTh>Date</MudTh>
                                        <MudTh>Voucher No</MudTh>
                                        <MudTh>Type</MudTh>
                                        <MudTh>Narration</MudTh>
                                        <MudTh Style="text-align: right">Debit</MudTh>
                                        <MudTh Style="text-align: right">Credit</MudTh>
                                        <MudTh Style="text-align: right">Balance</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.VoucherDate.ToString("dd/MM/yyyy")</MudTd>
                                        <MudTd>@context.VoucherNo</MudTd>
                                        <MudTd>@context.VoucherType</MudTd>
                                        <MudTd>@context.Narration</MudTd>
                                        <MudTd Style="text-align: right">@(context.Debit > 0 ? context.Debit.ToString("N2") : "")</MudTd>
                                        <MudTd Style="text-align: right">@(context.Credit > 0 ? context.Credit.ToString("N2") : "")</MudTd>
                                        <MudTd Style="text-align: right">@context.RunningBalance.ToString("N2")</MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            </div>

            <MudPaper Class="pa-3 mt-4" Elevation="2">
                <MudGrid>
                    <MudItem xs="4">
                        <MudText Typo="Typo.h6">Grand Total</MudText>
                        <MudText Typo="Typo.caption">@_reportData.Count accounts with transactions</MudText>
                    </MudItem>
                    <MudItem xs="4" Style="text-align: right">
                        <MudText Typo="Typo.h6" Color="Color.Success">
                            Dr: @_reportData.Sum(x => x.TotalDebit).ToString("N2")
                        </MudText>
                    </MudItem>
                    <MudItem xs="4" Style="text-align: right">
                        <MudText Typo="Typo.h6" Color="Color.Error">
                            Cr: @_reportData.Sum(x => x.TotalCredit).ToString("N2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No data found for the selected criteria. Please generate the report.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private DateTime? _fromDate = new DateTime(DateTime.Today.Year, 1, 1);
    private DateTime? _toDate = DateTime.Today;
    private long? _selectedBranchId;
    private bool _isLoading = false;
    private List<AccountDetailItem> _reportData = new();
    private List<Branch> _branches = new();

    protected override async Task OnInitializedAsync()
    {
        _branches = await DbContext.Branches.Where(b => b.IsActive).OrderBy(b => b.Name).ToListAsync();
    }

    private async Task LoadReport()
    {
        if (!_fromDate.HasValue || !_toDate.HasValue)
        {
            Snackbar.Add("Please select date range", Severity.Warning);
            return;
        }

        _isLoading = true;
        _reportData.Clear();
        StateHasChanged();

        try
        {
            var fromDateUtc = DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc);
            var toDateUtc = DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc);

            var accountHeads = await DbContext.AccountHeads
                .Where(a => a.IsActive)
                .OrderBy(a => a.Code)
                .ToListAsync();

            var journalsQueryBase = DbContext.Journals
                .Include(j => j.Entries)
                .Where(j => j.VoucherDate >= fromDateUtc && j.VoucherDate <= toDateUtc);

            if (_selectedBranchId.HasValue)
            {
                journalsQueryBase = journalsQueryBase.Where(j => j.BranchId == _selectedBranchId.Value);
            }

            var journals = await journalsQueryBase
                .OrderBy(j => j.VoucherDate)
                .ThenBy(j => j.Id)
                .ToListAsync();

            foreach (var account in accountHeads)
            {
                var accountJournals = journals
                    .Where(j => j.Entries.Any(e => e.AccountHeadId == account.Id))
                    .OrderBy(j => j.VoucherDate)
                    .ToList();
                
                if (!accountJournals.Any()) continue;

                var transactions = new List<TransactionItem>();
                decimal runningBalance = 0;

                foreach (var journal in accountJournals)
                {
                    var entry = journal.Entries.FirstOrDefault(e => e.AccountHeadId == account.Id);
                    if (entry == null) continue;

                    var debit = entry.Debit ?? 0;
                    var credit = entry.Credit ?? 0;
                    runningBalance += debit - credit;
                    
                    transactions.Add(new TransactionItem
                    {
                        VoucherDate = journal.VoucherDate,
                        VoucherNo = journal.VoucherNo,
                        VoucherType = journal.VoucherType ?? "",
                        Narration = entry.Narration ?? journal.Narration ?? "",
                        Debit = debit,
                        Credit = credit,
                        RunningBalance = runningBalance
                    });
                }

                _reportData.Add(new AccountDetailItem
                {
                    AccountCode = account.Code,
                    AccountName = account.Name,
                    Classification = account.Classification.ToString(),
                    TotalDebit = transactions.Sum(t => t.Debit),
                    TotalCredit = transactions.Sum(t => t.Credit),
                    ClosingBalance = runningBalance,
                    Transactions = transactions
                });
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class AccountDetailItem
    {
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string Classification { get; set; } = "";
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public decimal ClosingBalance { get; set; }
        public List<TransactionItem> Transactions { get; set; } = new();
    }

    private class TransactionItem
    {
        public DateTime VoucherDate { get; set; }
        public string VoucherNo { get; set; } = "";
        public string VoucherType { get; set; } = "";
        public string Narration { get; set; } = "";
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal RunningBalance { get; set; }
    }
}

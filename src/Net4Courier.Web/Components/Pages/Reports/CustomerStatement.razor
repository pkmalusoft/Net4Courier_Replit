@page "/reports/customer-statement"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar

<PageTitle>Customer Statement</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">Customer Statement</MudText>

        <MudGrid>
            <MudItem xs="12" md="3">
                <MudAutocomplete T="Party" Label="Select Customer" @bind-Value="_selectedCustomer"
                                 SearchFunc="@SearchCustomers" ToStringFunc="@(p => p?.Name ?? "")"
                                 ShowProgressIndicator="true" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="From Date" @bind-Date="_fromDate" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudDatePicker Label="To Date" @bind-Date="_toDate" DateFormat="dd/MM/yyyy" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="long?" Label="Branch" @bind-Value="_selectedBranchId" Clearable>
                    @foreach (var branch in _branches)
                    {
                        <MudSelectItem Value="@((long?)branch.Id)">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" Class="mr-2">
                    <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-1" /> Generate
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="PrintStatement">
                    <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-1" /> Print
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (_statementLoaded)
        {
            <MudPaper Class="pa-4 my-4" Elevation="2" id="statement-content">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.h6">Statement of Account</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Period: @_fromDate?.ToString("dd/MM/yyyy") to @_toDate?.ToString("dd/MM/yyyy")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="6" Style="text-align: right">
                        <MudText Typo="Typo.caption">Statement Date: @DateTime.Today.ToString("dd/MM/yyyy")</MudText>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-3" />

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle1"><strong>@_selectedCustomer?.Name</strong></MudText>
                        @if (!string.IsNullOrEmpty(_selectedCustomer?.Code))
                        {
                            <MudText Typo="Typo.body2">Code: @_selectedCustomer?.Code</MudText>
                        }
                        @if (_customerAddress != null)
                        {
                            <MudText Typo="Typo.body2">@_customerAddress.Street</MudText>
                            <MudText Typo="Typo.body2">@_customerAddress.City, @_customerAddress.State @_customerAddress.PostalCode</MudText>
                        }
                    </MudItem>
                    <MudItem xs="12" md="6" Style="text-align: right">
                        <MudText Typo="Typo.body2"><strong>Opening Balance:</strong> @_openingBalance.ToString("N2")</MudText>
                        <MudText Typo="Typo.body2"><strong>Total Debits:</strong> @_transactions.Sum(t => t.Debit).ToString("N2")</MudText>
                        <MudText Typo="Typo.body2"><strong>Total Credits:</strong> @_transactions.Sum(t => t.Credit).ToString("N2")</MudText>
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Color="@(_closingBalance >= 0 ? Color.Success : Color.Error)">
                            <strong>Balance Due: @_closingBalance.ToString("N2")</strong>
                        </MudText>
                    </MudItem>
                </MudGrid>

                <MudTable Items="@_transactions" Hover="true" Striped="true" Dense="true" Class="mt-4">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Reference</MudTh>
                        <MudTh>Description</MudTh>
                        <MudTh Style="text-align: right">Charges</MudTh>
                        <MudTh Style="text-align: right">Payments</MudTh>
                        <MudTh Style="text-align: right">Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.VoucherDate.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd>@context.VoucherNo</MudTd>
                        <MudTd>@context.Narration</MudTd>
                        <MudTd Style="text-align: right">@(context.Debit > 0 ? context.Debit.ToString("N2") : "-")</MudTd>
                        <MudTd Style="text-align: right">@(context.Credit > 0 ? context.Credit.ToString("N2") : "-")</MudTd>
                        <MudTd Style="text-align: right">@context.RunningBalance.ToString("N2")</MudTd>
                    </RowTemplate>
                </MudTable>

                <MudDivider Class="my-3" />

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            This statement is for informational purposes. Please contact us for any discrepancies.
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="6" Style="text-align: right">
                        <MudText Typo="Typo.h6">
                            Amount Due: <strong Color="@(_closingBalance >= 0 ? Color.Error : Color.Success)">@_closingBalance.ToString("N2")</strong>
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">Select a customer and date range to generate the statement.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private Party? _selectedCustomer;
    private PartyAddress? _customerAddress;
    private DateTime? _fromDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime? _toDate = DateTime.Today;
    private long? _selectedBranchId;
    private bool _isLoading = false;
    private bool _statementLoaded = false;
    private List<StatementTransaction> _transactions = new();
    private List<Branch> _branches = new();
    private decimal _openingBalance = 0;
    private decimal _closingBalance = 0;

    protected override async Task OnInitializedAsync()
    {
        _branches = await DbContext.Branches.Where(b => b.IsActive).OrderBy(b => b.Name).ToListAsync();
    }

    private async Task<IEnumerable<Party>> SearchCustomers(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return await DbContext.Parties.Where(p => p.IsActive).Take(10).ToListAsync();

        return await DbContext.Parties
            .Where(p => p.IsActive && (p.Name.Contains(value) || (p.Code != null && p.Code.Contains(value))))
            .Take(20)
            .ToListAsync();
    }

    private async Task LoadReport()
    {
        if (_selectedCustomer == null)
        {
            Snackbar.Add("Please select a customer", Severity.Warning);
            return;
        }

        if (!_fromDate.HasValue || !_toDate.HasValue)
        {
            Snackbar.Add("Please select date range", Severity.Warning);
            return;
        }

        _isLoading = true;
        _statementLoaded = false;
        _transactions.Clear();
        StateHasChanged();

        try
        {
            _customerAddress = await DbContext.PartyAddresses
                .FirstOrDefaultAsync(a => a.PartyId == _selectedCustomer.Id && a.IsDefault);

            var fromDateUtc = DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc);
            var toDateUtc = DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc);

            var journalsQuery = DbContext.Journals
                .Include(j => j.Entries)
                .Where(j => j.Entries.Any(e => e.PartyId == _selectedCustomer.Id));

            if (_selectedBranchId.HasValue)
            {
                journalsQuery = journalsQuery.Where(j => j.BranchId == _selectedBranchId.Value);
            }

            var openingJournals = await journalsQuery
                .Where(j => j.VoucherDate < fromDateUtc)
                .ToListAsync();

            var openingEntries = openingJournals.SelectMany(j => j.Entries.Where(e => e.PartyId == _selectedCustomer.Id)).ToList();
            _openingBalance = openingEntries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));

            var periodJournals = await journalsQuery
                .Where(j => j.VoucherDate >= fromDateUtc && j.VoucherDate <= toDateUtc)
                .OrderBy(j => j.VoucherDate)
                .ThenBy(j => j.Id)
                .ToListAsync();

            decimal runningBalance = _openingBalance;

            _transactions.Add(new StatementTransaction
            {
                VoucherDate = _fromDate.Value,
                VoucherNo = "",
                Narration = "Opening Balance",
                Debit = 0,
                Credit = 0,
                RunningBalance = _openingBalance
            });

            foreach (var journal in periodJournals)
            {
                var entry = journal.Entries.FirstOrDefault(e => e.PartyId == _selectedCustomer.Id);
                if (entry == null) continue;

                var debit = entry.Debit ?? 0;
                var credit = entry.Credit ?? 0;
                runningBalance += debit - credit;
                
                _transactions.Add(new StatementTransaction
                {
                    VoucherDate = journal.VoucherDate,
                    VoucherNo = journal.VoucherNo,
                    Narration = entry.Narration ?? journal.Narration ?? "",
                    Debit = debit,
                    Credit = credit,
                    RunningBalance = runningBalance
                });
            }

            _closingBalance = runningBalance;
            _statementLoaded = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void PrintStatement()
    {
        Snackbar.Add("Print functionality - Use browser print (Ctrl+P)", Severity.Info);
    }

    private class StatementTransaction
    {
        public DateTime VoucherDate { get; set; }
        public string VoucherNo { get; set; } = "";
        public string Narration { get; set; } = "";
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal RunningBalance { get; set; }
    }
}

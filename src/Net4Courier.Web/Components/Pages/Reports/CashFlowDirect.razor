@page "/reports/cash-flow/direct"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Cash Flow (Direct Method) - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Cash Flow Statement - Direct Method</MudText>

        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" 
                           FullWidth="true" Class="mt-1" Disabled="_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" OnClick="ClearFilters" FullWidth="true" Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasData)
    {
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle1" Class="mb-4" Align="Align.Center">
                <strong>Cash Flow Statement for @_fromDate?.ToString("dd MMM yyyy") to @_toDate?.ToString("dd MMM yyyy")</strong>
            </MudText>

            <MudPaper Class="pa-3 mb-4" Elevation="1" Style="background: var(--mud-palette-grey-lighten-4);">
                <div class="d-flex justify-space-between">
                    <MudText Typo="Typo.subtitle1">Opening Cash & Bank Balance</MudText>
                    <MudText Typo="Typo.subtitle1"><strong>@_openingCashBalance.ToString("N2")</strong></MudText>
                </div>
            </MudPaper>

            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel InitiallyExpanded="true">
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>Cash Flow from Operating Activities</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Style="@GetAmountStyle(_operatingNet)">
                                <strong>@_operatingNet.ToString("N2")</strong>
                            </MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @if (_operatingReceipts.Any())
                        {
                            <MudText Typo="Typo.body2" Class="mb-2" Color="Color.Success"><strong>Receipts</strong></MudText>
                            <MudSimpleTable Dense="true" Class="mb-3" Style="background: var(--mud-palette-success-lighten);">
                                <tbody>
                                    @foreach (var item in _operatingReceipts)
                                    {
                                        <tr>
                                            <td>@item.Description</td>
                                            <td style="text-align: right; width: 120px;">@item.Amount.ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: bold;">
                                        <td>Total Receipts</td>
                                        <td style="text-align: right;">@_operatingReceipts.Sum(r => r.Amount).ToString("N2")</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                        @if (_operatingPayments.Any())
                        {
                            <MudText Typo="Typo.body2" Class="mb-2" Color="Color.Error"><strong>Payments</strong></MudText>
                            <MudSimpleTable Dense="true" Style="background: var(--mud-palette-error-lighten);">
                                <tbody>
                                    @foreach (var item in _operatingPayments)
                                    {
                                        <tr>
                                            <td>@item.Description</td>
                                            <td style="text-align: right; width: 120px;">@item.Amount.ToString("N2")</td>
                                        </tr>
                                    }
                                    <tr style="font-weight: bold;">
                                        <td>Total Payments</td>
                                        <td style="text-align: right;">@_operatingPayments.Sum(p => p.Amount).ToString("N2")</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>Cash Flow from Investing Activities</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Style="@GetAmountStyle(_investingNet)">
                                <strong>@_investingNet.ToString("N2")</strong>
                            </MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @if (_investingItems.Any())
                        {
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    @foreach (var item in _investingItems)
                                    {
                                        <tr>
                                            <td>@item.Description</td>
                                            <td style="text-align: right; width: 120px; @GetAmountStyle(item.Amount)">
                                                @item.Amount.ToString("N2")
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No investing activities in this period</MudText>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudExpansionPanels Class="mb-3">
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <MudText Typo="Typo.subtitle1"><strong>Cash Flow from Financing Activities</strong></MudText>
                            <MudText Typo="Typo.subtitle1" Style="@GetAmountStyle(_financingNet)">
                                <strong>@_financingNet.ToString("N2")</strong>
                            </MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        @if (_financingItems.Any())
                        {
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    @foreach (var item in _financingItems)
                                    {
                                        <tr>
                                            <td>@item.Description</td>
                                            <td style="text-align: right; width: 120px; @GetAmountStyle(item.Amount)">
                                                @item.Amount.ToString("N2")
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No financing activities in this period</MudText>
                        }
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudDivider Class="my-4" />

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="2" Style="@($"background: {(_netChange >= 0 ? "var(--mud-palette-success-lighten)" : "var(--mud-palette-error-lighten)")};")">
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.h6"><strong>Net Change in Cash</strong></MudText>
                            <MudText Typo="Typo.h6" Style="@GetAmountStyle(_netChange)">
                                <strong>@_netChange.ToString("N2")</strong>
                            </MudText>
                        </div>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="2" Style="background: var(--mud-palette-primary-lighten);">
                        <div class="d-flex justify-space-between">
                            <MudText Typo="Typo.h6"><strong>Closing Cash Balance</strong></MudText>
                            <MudText Typo="Typo.h6"><strong>@_closingCashBalance.ToString("N2")</strong></MudText>
                        </div>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else if (!_isLoading)
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a date range and click Generate to view the Direct Method Cash Flow Statement.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 1, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private bool _isLoading;
    private bool _hasData;

    private decimal _openingCashBalance;
    private decimal _closingCashBalance;
    private decimal _netChange;
    private decimal _operatingNet;
    private decimal _investingNet;
    private decimal _financingNet;

    private List<CashFlowItem> _operatingReceipts = new();
    private List<CashFlowItem> _operatingPayments = new();
    private List<CashFlowItem> _investingItems = new();
    private List<CashFlowItem> _financingItems = new();

    private async Task LoadReport()
    {
        _isLoading = true;
        _operatingReceipts.Clear();
        _operatingPayments.Clear();
        _investingItems.Clear();
        _financingItems.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue 
                ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) 
                : DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 1, 1), DateTimeKind.Utc);
            var toUtc = _toDate.HasValue 
                ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) 
                : DateTime.UtcNow;

            var allAccounts = await DbContext.AccountHeads
                .Where(a => a.IsActive && !a.IsGroup)
                .ToListAsync();

            var cashBankAccountIds = allAccounts
                .Where(a => a.AccountNature == AccountNature.CashAccount || 
                            a.AccountNature == AccountNature.BankAccount ||
                            a.Name.ToLower().Contains("cash") || 
                            a.Name.ToLower().Contains("bank"))
                .Select(a => a.Id)
                .ToList();

            var accountLookup = allAccounts.ToDictionary(a => a.Id);

            _openingCashBalance = 0;
            foreach (var cashAccountId in cashBankAccountIds)
            {
                var account = accountLookup.GetValueOrDefault(cashAccountId);
                if (account == null) continue;

                var priorEntries = await DbContext.JournalEntries
                    .Include(e => e.Journal)
                    .Where(e => !e.IsDeleted && e.Journal.IsPosted && 
                           e.AccountHeadId == cashAccountId && e.Journal.VoucherDate < fromUtc)
                    .ToListAsync();

                _openingCashBalance += (account.OpeningBalance ?? 0) + priorEntries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));
            }

            var periodEntries = await DbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => !e.IsDeleted && e.Journal.IsPosted && 
                       cashBankAccountIds.Contains(e.AccountHeadId) &&
                       e.Journal.VoucherDate >= fromUtc && e.Journal.VoucherDate <= toUtc)
                .ToListAsync();

            var journalIds = periodEntries.Select(e => e.JournalId).Distinct().ToList();
            var allEntriesByJournal = await DbContext.JournalEntries
                .Where(e => journalIds.Contains(e.JournalId))
                .ToListAsync();

            var entriesByJournal = allEntriesByJournal.GroupBy(e => e.JournalId).ToDictionary(g => g.Key, g => g.ToList());

            decimal incomeReceipts = 0, expensePayments = 0, assetPurchases = 0, assetSales = 0, equityReceipts = 0, equityPayments = 0, liabilityReceipts = 0;

            foreach (var entry in periodEntries)
            {
                var contraEntries = entriesByJournal.GetValueOrDefault(entry.JournalId, new List<JournalEntry>())
                    .Where(e => e.Id != entry.Id)
                    .ToList();

                var contraAccountId = contraEntries.FirstOrDefault()?.AccountHeadId;
                var contraAccount = contraAccountId.HasValue ? accountLookup.GetValueOrDefault(contraAccountId.Value) : null;

                if (contraAccount == null) continue;

                var debit = entry.Debit ?? 0;
                var credit = entry.Credit ?? 0;

                if (debit > 0)
                {
                    switch (contraAccount.Classification)
                    {
                        case AccountClassification.Income:
                            incomeReceipts += debit;
                            break;
                        case AccountClassification.Assets:
                            assetSales += debit;
                            break;
                        case AccountClassification.Liabilities:
                            liabilityReceipts += debit;
                            break;
                        case AccountClassification.Equity:
                            equityReceipts += debit;
                            break;
                    }
                }
                else if (credit > 0)
                {
                    switch (contraAccount.Classification)
                    {
                        case AccountClassification.Expenditure:
                            expensePayments += credit;
                            break;
                        case AccountClassification.Assets:
                            assetPurchases += credit;
                            break;
                        case AccountClassification.Equity:
                            equityPayments += credit;
                            break;
                    }
                }
            }

            if (incomeReceipts > 0)
                _operatingReceipts.Add(new CashFlowItem { Description = "Receipts from Customers", Amount = incomeReceipts });
            if (liabilityReceipts > 0)
                _operatingReceipts.Add(new CashFlowItem { Description = "Other Operating Receipts", Amount = liabilityReceipts });
            if (expensePayments > 0)
                _operatingPayments.Add(new CashFlowItem { Description = "Payments to Suppliers/Expenses", Amount = expensePayments });

            if (assetPurchases > 0)
                _investingItems.Add(new CashFlowItem { Description = "Purchase of Assets", Amount = -assetPurchases });
            if (assetSales > 0)
                _investingItems.Add(new CashFlowItem { Description = "Sale of Assets", Amount = assetSales });

            if (equityReceipts > 0)
                _financingItems.Add(new CashFlowItem { Description = "Capital Contributions", Amount = equityReceipts });
            if (equityPayments > 0)
                _financingItems.Add(new CashFlowItem { Description = "Drawings/Dividends", Amount = -equityPayments });

            _operatingNet = _operatingReceipts.Sum(r => r.Amount) - _operatingPayments.Sum(p => p.Amount);
            _investingNet = _investingItems.Sum(i => i.Amount);
            _financingNet = _financingItems.Sum(f => f.Amount);

            _netChange = _operatingNet + _investingNet + _financingNet;
            _closingCashBalance = _openingCashBalance + _netChange;
            _hasData = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private void ClearFilters()
    {
        _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 1, 1), DateTimeKind.Utc);
        _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
        _hasData = false;
    }

    private string GetAmountStyle(decimal amount)
    {
        if (amount > 0) return "color: var(--mud-palette-success);";
        if (amount < 0) return "color: var(--mud-palette-error);";
        return "";
    }

    private class CashFlowItem
    {
        public string Description { get; set; } = "";
        public decimal Amount { get; set; }
    }
}

@page "/reports/balance-sheet"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Balance Sheet - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Balance Sheet</MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_asAtDate" Label="As At Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadBalanceSheet" 
                           FullWidth="true" Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        </MudPaper>
    }
    else if (_hasData)
    {
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-4">
                Balance Sheet as at @_asAtDate?.ToString("dd MMMM yyyy")
            </MudText>

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                        <thead>
                            <tr style="background: var(--mud-palette-success-lighten);">
                                <th colspan="2"><strong>ASSETS</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _assets)
                            {
                                <tr>
                                    <td style="padding-left: 16px;">@item.Code - @item.Name</td>
                                    <td style="text-align: right; width: 120px;">@item.Balance.ToString("N2")</td>
                                </tr>
                            }
                            <tr style="background: var(--mud-palette-grey-lighten-3); font-weight: bold;">
                                <td><strong>Total Assets</strong></td>
                                <td style="text-align: right;"><strong>@_totalAssets.ToString("N2")</strong></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                        <thead>
                            <tr style="background: var(--mud-palette-warning-lighten);">
                                <th colspan="2"><strong>LIABILITIES</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _liabilities)
                            {
                                <tr>
                                    <td style="padding-left: 16px;">@item.Code - @item.Name</td>
                                    <td style="text-align: right; width: 120px;">@item.Balance.ToString("N2")</td>
                                </tr>
                            }
                            <tr style="background: var(--mud-palette-grey-lighten-3); font-weight: bold;">
                                <td><strong>Total Liabilities</strong></td>
                                <td style="text-align: right;"><strong>@_totalLiabilities.ToString("N2")</strong></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>

                    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Class="mt-4">
                        <thead>
                            <tr style="background: var(--mud-palette-info-lighten);">
                                <th colspan="2"><strong>EQUITY</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in _equity)
                            {
                                <tr>
                                    <td style="padding-left: 16px;">@item.Code - @item.Name</td>
                                    <td style="text-align: right; width: 120px;">@item.Balance.ToString("N2")</td>
                                </tr>
                            }
                            @if (_retainedEarnings != 0)
                            {
                                <tr>
                                    <td style="padding-left: 16px;">Retained Earnings</td>
                                    <td style="text-align: right;">@_retainedEarnings.ToString("N2")</td>
                                </tr>
                            }
                            <tr style="background: var(--mud-palette-grey-lighten-3); font-weight: bold;">
                                <td><strong>Total Equity</strong></td>
                                <td style="text-align: right;"><strong>@(_totalEquity + _retainedEarnings).ToString("N2")</strong></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>

                    <MudSimpleTable Dense="true" Bordered="true" Class="mt-4">
                        <tbody>
                            <tr style="background: var(--mud-palette-primary-lighten); font-weight: bold;">
                                <td><strong>Total Liabilities & Equity</strong></td>
                                <td style="text-align: right; width: 120px;">
                                    <strong>@(_totalLiabilities + _totalEquity + _retainedEarnings).ToString("N2")</strong>
                                </td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudItem>
            </MudGrid>

            @if (Math.Abs(_totalAssets - (_totalLiabilities + _totalEquity + _retainedEarnings)) < 0.01m)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">Balance Sheet is balanced.</MudAlert>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    Balance Sheet is not balanced. Difference: @Math.Abs(_totalAssets - (_totalLiabilities + _totalEquity + _retainedEarnings)).ToString("N2")
                </MudAlert>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private DateTime? _asAtDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private List<BalanceSheetItem> _assets = new();
    private List<BalanceSheetItem> _liabilities = new();
    private List<BalanceSheetItem> _equity = new();
    private decimal _totalAssets;
    private decimal _totalLiabilities;
    private decimal _totalEquity;
    private decimal _retainedEarnings;
    private bool _isLoading;
    private bool _hasData;

    private async Task LoadBalanceSheet()
    {
        _isLoading = true;
        _assets.Clear();
        _liabilities.Clear();
        _equity.Clear();

        try
        {
            var asAtUtc = _asAtDate.HasValue 
                ? DateTime.SpecifyKind(_asAtDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) 
                : DateTime.UtcNow;

            var accounts = await DbContext.AccountHeads
                .Where(a => a.IsActive && !a.IsGroup)
                .OrderBy(a => a.Code)
                .ToListAsync();

            var journalEntries = await DbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => !e.IsDeleted && e.Journal.IsPosted && e.Journal.VoucherDate <= asAtUtc)
                .ToListAsync();

            var entriesByAccount = journalEntries.GroupBy(e => e.AccountHeadId)
                .ToDictionary(g => g.Key, g => g.ToList());

            foreach (var account in accounts)
            {
                var opening = account.OpeningBalance ?? 0;
                var entries = entriesByAccount.GetValueOrDefault(account.Id, new List<JournalEntry>());
                var balance = opening + entries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));
                
                if (balance == 0) continue;

                var item = new BalanceSheetItem { Code = account.Code, Name = account.Name, Balance = Math.Abs(balance) };

                switch (account.Classification)
                {
                    case AccountClassification.Assets:
                        _assets.Add(item);
                        break;
                    case AccountClassification.Liabilities:
                        _liabilities.Add(item);
                        break;
                    case AccountClassification.Equity:
                        _equity.Add(item);
                        break;
                    case AccountClassification.Income:
                    case AccountClassification.Expenditure:
                        _retainedEarnings += balance;
                        break;
                }
            }

            _totalAssets = _assets.Sum(a => a.Balance);
            _totalLiabilities = _liabilities.Sum(l => l.Balance);
            _totalEquity = _equity.Sum(e => e.Balance);
            _hasData = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading balance sheet: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private class BalanceSheetItem
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public decimal Balance { get; set; }
    }
}

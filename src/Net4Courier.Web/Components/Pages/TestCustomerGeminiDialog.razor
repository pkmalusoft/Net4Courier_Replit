@using MudBlazor

<style>
    .custom-mud-select {
        width: 100%;
        height: 40px;
        padding: 8px 12px;
        font-size: 0.875rem;
        font-family: "Roboto", sans-serif;
        color: #424242;
        background-color: #fff;
        border: 1px solid #c4c4c4;
        border-radius: 4px;
        outline: none;
        transition: border 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%23757575%22%20d%3D%22M7%2010l5%205%205-5z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
    }
    .custom-mud-select:focus {
        border: 2px solid #594AE2;
        padding: 7px 11px;
    }
    .custom-mud-select:disabled {
        background-color: #f5f5f5;
        color: #bdbdbd;
    }
    .custom-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
        display: block;
        font-weight: 500;
    }
</style>

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudAvatar Color="Color.Primary" Size="Size.Small" Variant="Variant.Filled">
                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
            </MudAvatar>
            <MudText Typo="Typo.h6">New Customer Onboarding</MudText>
        </MudStack>
    </TitleContent>
    
    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-0 mt-2">
            
            <MudGrid Spacing="2">
                <MudItem xs="12" md="4">
                    <label class="custom-label">Company Entity *</label>
                    <select @bind="_companyId" class="custom-mud-select">
                        <option value="1">ABC Logistics Ltd</option>
                        <option value="2">XYZ Courier Inc</option>
                        <option value="3">Global Express Co</option>
                    </select>
                </MudItem>
                <MudItem xs="12" md="4">
                    <label class="custom-label">Party Type *</label>
                    <select @bind="_partyType" class="custom-mud-select">
                        <option value="Customer">Customer</option>
                        <option value="Vendor">Vendor</option>
                        <option value="Agent">Agent</option>
                    </select>
                </MudItem>
                <MudItem xs="12" md="4">
                    <label class="custom-label">Account Type *</label>
                    <select @bind="_accountTypeId" class="custom-mud-select">
                        <option value="">-- Select --</option>
                        <option value="1">Credit Account</option>
                        <option value="2">Cash / Walk-in</option>
                        <option value="3">Prepaid</option>
                    </select>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudGrid Spacing="3">
                
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3"><b>Business Profile</b></MudText>
                    
                    <MudStack Spacing="2">
                        <MudTextField @bind-Value="_customerName" Label="Customer Name" Required="true" 
                                      Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        
                        <MudStack Row="true">
                            <MudTextField @bind-Value="_shortCode" Label="Short Code" 
                                          Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                            <MudTextField @bind-Value="_accountNo" Label="Account No" Disabled="true" 
                                          Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" 
                                          Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Lock" />
                        </MudStack>

                        <MudTextField @bind-Value="_contactPerson" Label="Contact Person" 
                                      Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        
                        <MudStack Row="true">
                            <MudTextField @bind-Value="_phone" Label="Phone" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                            <MudTextField @bind-Value="_email" Label="Email" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                        </MudStack>
                    </MudStack>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-3"><b>Location & Financials</b></MudText>
                    
                    <MudStack Spacing="2">
                        <MudGrid Spacing="2">
                            <MudItem xs="6">
                                <label class="custom-label">Country</label>
                                <select value="@_countryId" @onchange="OnCountryChanged" class="custom-mud-select">
                                    <option value="">-- Select --</option>
                                    <option value="1">United Arab Emirates</option>
                                    <option value="2">Saudi Arabia</option>
                                    <option value="3">Qatar</option>
                                </select>
                            </MudItem>
                            <MudItem xs="6">
                                <label class="custom-label">City</label>
                                <select value="@_cityId" @onchange="OnCityChanged" disabled="@(!_countryId.HasValue)" class="custom-mud-select">
                                    <option value="">-- Select --</option>
                                    @foreach (var city in _cities)
                                    {
                                        <option value="@city.Id">@city.Name</option>
                                    }
                                </select>
                            </MudItem>
                        </MudGrid>

                        <MudGrid Spacing="2">
                             <MudItem xs="6">
                                <label class="custom-label">Area / Locality</label>
                                <select @bind="_areaId" disabled="@(!_cityId.HasValue)" class="custom-mud-select">
                                    <option value="">-- Select --</option>
                                    @foreach (var area in _areas)
                                    {
                                        <option value="@area.Id">@area.Name</option>
                                    }
                                </select>
                            </MudItem>
                             <MudItem xs="6">
                                <MudTextField @bind-Value="_address" Label="Building / Street" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                             </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2"/>

                        <MudGrid Spacing="2">
                            <MudItem xs="6">
                                <MudNumericField @bind-Value="_creditLimit" Label="Credit Limit" 
                                                 Variant="Variant.Outlined" Dense="true" Format="N2" Margin="Margin.Dense"
                                                 Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudNumericField @bind-Value="_creditDays" Label="Credit Days" 
                                                 Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" />
                            </MudItem>
                        </MudGrid>
                        
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Save" Variant="Variant.Filled" Color="Color.Primary" Class="ml-2">Create Customer</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance? MudDialog { get; set; }

    private long _companyId = 1;
    private string _partyType = "Customer";
    private string _accountTypeId = "1";
    private string _customerName = "";
    private string _shortCode = "";
    private string _accountNo = "AUTO-GEN";
    private string _contactPerson = "";
    private string _email = "";
    private string _phone = "";
    private string _address = "";
    private long? _countryId;
    private long? _cityId;
    private string _areaId = "";
    private decimal _creditLimit = 0;
    private int _creditDays = 30;
    private bool _isActive = true;

    private List<(long Id, string Name)> _cities = new();
    private List<(long Id, string Name)> _areas = new();

    private readonly Dictionary<long, List<(long Id, string Name)>> _citiesByCountry = new()
    {
        { 1, new() { (1, "Dubai"), (2, "Abu Dhabi"), (3, "Sharjah") } },
        { 2, new() { (5, "Riyadh"), (6, "Jeddah") } },
        { 3, new() { (8, "Doha") } }
    };

    private readonly Dictionary<long, List<(long Id, string Name)>> _areasByCity = new()
    {
        { 1, new() { (1, "Deira"), (2, "Bur Dubai"), (3, "Jumeirah") } },
        { 2, new() { (5, "Khalifa City"), (6, "Reem Island") } },
        { 5, new() { (11, "Olaya"), (12, "Al Malaz") } }
    };

    private void OnCountryChanged(ChangeEventArgs e)
    {
        _countryId = null;
        _cityId = null;
        _areaId = "";
        _cities.Clear();
        _areas.Clear();

        if (long.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            _countryId = id;
            if (_citiesByCountry.TryGetValue(id, out var cities))
            {
                _cities = cities;
            }
        }
    }

    private void OnCityChanged(ChangeEventArgs e)
    {
        _cityId = null;
        _areaId = "";
        _areas.Clear();

        if (long.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            _cityId = id;
            if (_areasByCity.TryGetValue(id, out var areas))
            {
                _areas = areas;
            }
        }
    }

    private void Cancel() => MudDialog?.Cancel();
    private void Save() => MudDialog?.Close(DialogResult.Ok(true));
}

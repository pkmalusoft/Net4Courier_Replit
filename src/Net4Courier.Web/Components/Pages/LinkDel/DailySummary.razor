@page "/linkdel/summary"
@layout Net4Courier.Web.Components.Layout.LinkDelLayout
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<div class="ld-summary">
    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">Daily Summary</MudText>
    <MudText Typo="Typo.body2" Style="color: #94a3b8; margin-bottom: 16px;">@_selectedDate.ToString("dddd, dd MMMM yyyy")</MudText>

    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="PrevDay"
                   StartIcon="@Icons.Material.Filled.ChevronLeft" Style="border-radius: 8px;">Prev</MudButton>
        <MudButton Variant="@(_selectedDate.Date == DateTime.UtcNow.Date ? Variant.Filled : Variant.Outlined)"
                   Color="Color.Primary" Size="Size.Small" OnClick="GoToday" Style="flex: 1; border-radius: 8px;">Today</MudButton>
        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="NextDay"
                   EndIcon="@Icons.Material.Filled.ChevronRight" Style="border-radius: 8px;"
                   Disabled="@(_selectedDate.Date >= DateTime.UtcNow.Date)">Next</MudButton>
    </div>

    @if (_isLoading)
    {
        <div style="display: flex; justify-content: center; padding: 40px 0;">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </div>
    }
    else
    {
        <MudPaper Elevation="0" Style="border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #64748b; margin-bottom: 12px;">Operations</MudText>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <div style="text-align: center; background: #eff6ff; border-radius: 8px; padding: 12px 8px;">
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #2563eb;">@_pickupsCompleted</MudText>
                    <MudText Typo="Typo.caption" Style="color: #64748b;">Pickups</MudText>
                </div>
                <div style="text-align: center; background: #f0fdf4; border-radius: 8px; padding: 12px 8px;">
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #16a34a;">@_deliveriesCompleted</MudText>
                    <MudText Typo="Typo.caption" Style="color: #64748b;">Delivered</MudText>
                </div>
                <div style="text-align: center; background: #fef2f2; border-radius: 8px; padding: 12px 8px;">
                    <MudText Typo="Typo.h5" Style="font-weight: 700; color: #dc2626;">@_deliveryAttempts</MudText>
                    <MudText Typo="Typo.caption" Style="color: #64748b;">Attempts</MudText>
                </div>
            </div>
        </MudPaper>

        <MudPaper Elevation="0" Style="border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #64748b; margin-bottom: 12px;">Collections</MudText>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                <MudText Typo="Typo.body2" Style="color: #64748b;">COD Collected</MudText>
                <MudText Typo="Typo.body2" Style="font-weight: 700; color: #16a34a;">@_codCollected.ToString("N2")</MudText>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                <MudText Typo="Typo.body2" Style="color: #64748b;">Cash Submitted</MudText>
                <MudText Typo="Typo.body2" Style="font-weight: 700; color: #2563eb;">@_cashSubmitted.ToString("N2")</MudText>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1e293b;">Cash in Hand</MudText>
                <MudText Typo="Typo.body2" Style="@($"font-weight: 700; color: {(_cashInHand > 0 ? "#f59e0b" : "#16a34a")};")">@_cashInHand.ToString("N2")</MudText>
            </div>
        </MudPaper>

        <MudPaper Elevation="0" Style="border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #64748b; margin-bottom: 12px;">Expenses</MudText>
            @if (_expenseBreakdown.Any())
            {
                @foreach (var exp in _expenseBreakdown)
                {
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f5f9;">
                        <MudText Typo="Typo.body2" Style="color: #64748b;">@exp.Type</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@exp.Amount.ToString("N2")</MudText>
                    </div>
                }
                <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 4px;">
                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1e293b;">Total Expenses</MudText>
                    <MudText Typo="Typo.body2" Style="font-weight: 700; color: #ef4444;">@_totalExpenses.ToString("N2")</MudText>
                </div>
            }
            else
            {
                <MudText Typo="Typo.body2" Style="color: #94a3b8; text-align: center; padding: 8px 0;">No expenses recorded</MudText>
            }
        </MudPaper>

        <MudPaper Elevation="0" Style="border-radius: 12px; padding: 16px; background: linear-gradient(135deg, #556ee6, #7c3aed);">
            <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Net Position</MudText>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.6);">Collections - Expenses - Submitted</MudText>
                    <MudText Typo="Typo.h4" Style="font-weight: 700; color: #fff;">@_netPosition.ToString("N2")</MudText>
                </div>
                <MudIcon Icon="@(_netPosition >= 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)"
                         Style="color: rgba(255,255,255,0.5); font-size: 2.5rem;" />
            </div>
        </MudPaper>
    }
</div>

<style>
    .ld-summary {
        max-width: 600px;
        margin: 0 auto;
    }
</style>

@code {
    private long _userId;
    private bool _isLoading = true;
    private DateTime _selectedDate = DateTime.UtcNow.Date;

    private int _pickupsCompleted;
    private int _deliveriesCompleted;
    private int _deliveryAttempts;
    private decimal _codCollected;
    private decimal _cashSubmitted;
    private decimal _cashInHand;
    private decimal _totalExpenses;
    private decimal _netPosition;
    private List<ExpenseBreakdownItem> _expenseBreakdown = new();

    private class ExpenseBreakdownItem
    {
        public string Type { get; set; } = "";
        public decimal Amount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst("UserId")?.Value;
        if (long.TryParse(userIdClaim, out var uid))
            _userId = uid;

        await LoadSummary();
    }

    private async Task PrevDay()
    {
        _selectedDate = _selectedDate.AddDays(-1);
        await LoadSummary();
    }

    private async Task NextDay()
    {
        if (_selectedDate.Date < DateTime.UtcNow.Date)
        {
            _selectedDate = _selectedDate.AddDays(1);
            await LoadSummary();
        }
    }

    private async Task GoToday()
    {
        _selectedDate = DateTime.UtcNow.Date;
        await LoadSummary();
    }

    private async Task LoadSummary()
    {
        _isLoading = true;
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var date = _selectedDate.Date;
            var nextDate = date.AddDays(1);

            _pickupsCompleted = await db.PickupRequests
                .Where(p => p.CourierId == _userId && !p.IsDeleted
                    && p.Status == PickupStatus.ShipmentCollected
                    && p.CollectedAt.HasValue && p.CollectedAt.Value >= date && p.CollectedAt.Value < nextDate)
                .CountAsync();

            var drsIds = await db.DRSs
                .Where(d => d.DeliveryEmployeeId == (int)_userId && !d.IsDeleted && d.DRSDate.Date == date)
                .Select(d => d.Id)
                .ToListAsync();

            if (drsIds.Any())
            {
                _deliveriesCompleted = await db.DRSDetails
                    .Where(dd => drsIds.Contains(dd.DRSId) && !dd.IsDeleted && dd.Status == "Delivered")
                    .CountAsync();

                _deliveryAttempts = await db.DRSDetails
                    .Where(dd => drsIds.Contains(dd.DRSId) && !dd.IsDeleted && (dd.Status == "Attempted" || dd.Status == "RTS"))
                    .CountAsync();

                _codCollected = await db.DRSDetails
                    .Where(dd => drsIds.Contains(dd.DRSId) && !dd.IsDeleted && dd.CollectedAmount.HasValue)
                    .SumAsync(dd => dd.CollectedAmount ?? 0);

                _cashSubmitted = await db.CourierCashSubmissions
                    .Where(s => drsIds.Contains(s.DRSId) && !s.IsDeleted)
                    .SumAsync(s => s.CashSubmittedAmount);
            }
            else
            {
                _deliveriesCompleted = 0;
                _deliveryAttempts = 0;
                _codCollected = 0;
                _cashSubmitted = 0;
            }

            _cashInHand = _codCollected - _cashSubmitted;

            var expenses = await db.CourierExpenses
                .Where(e => e.CourierId == (int)_userId && !e.IsDeleted
                    && e.ExpenseDate >= date && e.ExpenseDate < nextDate)
                .ToListAsync();

            _expenseBreakdown = expenses
                .GroupBy(e => e.ExpenseType)
                .Select(g => new ExpenseBreakdownItem
                {
                    Type = g.Key.ToString(),
                    Amount = g.Sum(e => e.Amount)
                })
                .OrderByDescending(e => e.Amount)
                .ToList();

            _totalExpenses = expenses.Sum(e => e.Amount);
            _netPosition = _codCollected - _totalExpenses - _cashSubmitted;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[LinkDel] Summary load error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }
}

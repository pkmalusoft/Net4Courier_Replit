@page "/customer/pickup-request"
@layout CustomerLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums

<PageTitle>Request Pickup - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h5" GutterBottom="true" Align="Align.Center">Request a Pickup</MudText>
    
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudStack Spacing="3">
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudDatePicker @bind-Date="_scheduledDate" Label="Preferred Pickup Date" Variant="Variant.Outlined" 
                                       DateFormat="dd/MM/yyyy" Required="true" MinDate="DateTime.Today" 
                                       AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="long?" Value="_entity.PickupScheduleId" Label="Pickup Schedule" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter" ValueChanged="OnScheduleChanged">
                            <MudSelectItem T="long?" Value="@((long?)null)">-- Select Schedule --</MudSelectItem>
                            @foreach (var schedule in _pickupSchedules)
                            {
                                <MudSelectItem T="long?" Value="@((long?)schedule.Id)">@schedule.DisplayText</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="BookingVehicleType?" @bind-Value="_entity.BookingVehicle" Label="Booking Vehicle" 
                                   Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem T="BookingVehicleType?" Value="@((BookingVehicleType?)null)">-- Select Vehicle --</MudSelectItem>
                            <MudSelectItem T="BookingVehicleType?" Value="BookingVehicleType.TwoWheeler">Two-Wheeler</MudSelectItem>
                            <MudSelectItem T="BookingVehicleType?" Value="BookingVehicleType.ThreeWheeler">Three-Wheeler</MudSelectItem>
                            <MudSelectItem T="BookingVehicleType?" Value="BookingVehicleType.FourWheeler">Four-Wheeler</MudSelectItem>
                            <MudSelectItem T="BookingVehicleType?" Value="BookingVehicleType.MiniTruck">Mini Truck</MudSelectItem>
                            <MudSelectItem T="BookingVehicleType?" Value="BookingVehicleType.HeavyTruck">Heavy Truck</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>
                
                <MudDivider />
                <MudText Typo="Typo.subtitle1" GutterBottom="true">Pickup Address (Your Location)</MudText>
                
                @if (_savedAddresses.Any())
                {
                    <MudSelect T="long?" Value="_selectedAddressId" Label="Select Saved Address" Variant="Variant.Outlined" 
                               ValueChanged="OnAddressSelected" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="long?" Value="@((long?)null)">-- Enter New Address --</MudSelectItem>
                        @foreach (var addr in _savedAddresses)
                        {
                            <MudSelectItem T="long?" Value="@((long?)addr.Id)">
                                @addr.AddressType: @addr.Street, @addr.City - @addr.PostalCode
                            </MudSelectItem>
                        }
                    </MudSelect>
                }
                
                <MudTextField @bind-Value="_entity.PickupAddress" Label="Pickup Address" Variant="Variant.Outlined" 
                              Required="true" Lines="2" />
                
                <MudGrid>
                    <MudItem xs="12" sm="3">
                        <MudAutocomplete T="City" Label="City" Value="_selectedCity" SearchFunc="SearchCities"
                                         ToStringFunc="@(c => c?.Name ?? string.Empty)" Variant="Variant.Outlined"
                                         ShowProgressIndicator="true" Dense="true" ResetValueOnEmptyText="true"
                                         ValueChanged="OnCitySelected" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_entity.State" Label="State" Variant="Variant.Outlined" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_entity.Country" Label="Country" Variant="Variant.Outlined" ReadOnly="true" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudTextField @bind-Value="_entity.PostalCode" Label="Postal Code" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                </MudGrid>
                
                <MudTextField @bind-Value="_entity.Landmark" Label="Landmark (optional)" Variant="Variant.Outlined" />
                
                <MudDivider />
                <MudText Typo="Typo.subtitle1" GutterBottom="true">Contact Details</MudText>
                
                <MudTextField @bind-Value="_entity.ContactPerson" Label="Contact Person" Variant="Variant.Outlined" Required="true" />
                
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.Mobile" Label="Mobile" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.Phone" Label="Alternate Phone" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
                
                <MudTextField @bind-Value="_entity.SpecialInstructions" Label="Special Instructions (optional)" Variant="Variant.Outlined" Lines="2"
                              Placeholder="Any special handling requirements?" />
            </MudStack>
        </MudForm>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.subtitle1">Shipments (@_shipments.Count)</MudText>
                <MudCheckBox T="bool" @bind-Value="_enableShipments" Label="Enable Shipments" Color="Color.Primary" Dense="true" />
            </MudStack>
            <MudStack Row="true" Spacing="2">
                <MudFileUpload T="IBrowserFile" Accept=".csv,.xlsx,.xls" FilesChanged="OnFileUpload" MaximumFileCount="1" Disabled="@(!_enableShipments)">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Upload" Disabled="@(!_enableShipments)">
                            Upload CSV/Excel
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
                <MudButton Variant="Variant.Text" Color="Color.Info" StartIcon="@Icons.Material.Filled.Download" OnClick="DownloadTemplate" Disabled="@(!_enableShipments)">
                    Template
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddShipment" Disabled="@(!_enableShipments)">
                    Add Shipment
                </MudButton>
            </MudStack>
        </MudStack>
        
        @if (_uploadErrors.Any())
        {
            <MudAlert Severity="Severity.Warning" Class="mb-3" ShowCloseIcon="true" CloseIconClicked="() => _uploadErrors.Clear()">
                <MudText Typo="Typo.body2"><strong>Upload Warnings:</strong></MudText>
                @foreach (var error in _uploadErrors.Take(5))
                {
                    <MudText Typo="Typo.caption">@error</MudText>
                }
                @if (_uploadErrors.Count > 5)
                {
                    <MudText Typo="Typo.caption">...and @(_uploadErrors.Count - 5) more</MudText>
                }
            </MudAlert>
        }
        
        @if (!_enableShipments)
        {
            <MudAlert Severity="Severity.Info" Dense="true">Enable shipments to add consignee details for your pickup request.</MudAlert>
        }
        else if (_shipments.Count == 0)
        {
            <MudAlert Severity="Severity.Info">Add at least one shipment to continue</MudAlert>
        }
        else
        {
            <MudStack Spacing="3">
                @foreach (var (shipment, index) in _shipments.Select((s, i) => (s, i)))
                {
                    <MudCard Outlined="true">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">Shipment #@(index + 1)</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                               OnClick="@(() => RemoveShipment(index))" />
                            </MudStack>
                            
                            <MudText Typo="Typo.subtitle2" GutterBottom="true">Receiver Details</MudText>
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.Consignee" Label="Receiver Name" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.ConsigneePhone" Label="Receiver Phone" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudTextField @bind-Value="shipment.ConsigneeAddress1" Label="Delivery Address" Variant="Variant.Outlined" 
                                          Required="true" Class="mt-2" />
                            
                            <MudGrid>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneeCity" Label="City" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneeState" Label="State" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneePostalCode" Label="Postal Code" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudDivider Class="my-3" />
                            <MudText Typo="Typo.subtitle2" GutterBottom="true">Package Details</MudText>
                            
                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="shipment.Pieces" Label="Pieces" Variant="Variant.Outlined" Min="1" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="shipment.Weight" Label="Weight (kg)" Variant="Variant.Outlined" Format="F2" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudSelect T="DocumentType" @bind-Value="shipment.DocumentTypeId" Label="Shipment Type" 
                                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                        <MudSelectItem Value="DocumentType.Letter">Letter</MudSelectItem>
                                        <MudSelectItem Value="DocumentType.Document">Document</MudSelectItem>
                                        <MudSelectItem Value="DocumentType.ParcelUpto30Kg">Parcel Upto 30kg</MudSelectItem>
                                        <MudSelectItem Value="DocumentType.ParcelAbove30Kg">Parcel Above 30kg</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                            </MudGrid>
                            
                            <MudGrid>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Length" Label="Length (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Width" Label="Width (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Height" Label="Height (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudTextField @bind-Value="shipment.CargoDescription" Label="Package Description" Variant="Variant.Outlined" 
                                          Placeholder="What are you sending?" Class="mt-2" />
                            
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.ReferenceNo" Label="Your Reference" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="shipment.DeclaredValue" Label="Declared Value" Variant="Variant.Outlined" Format="F2" />
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    </MudPaper>
    
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText>
                <strong>Total Shipments:</strong> @_shipments.Count | 
                <strong>Total Pieces:</strong> @_shipments.Sum(s => s.Pieces ?? 0) | 
                <strong>Total Weight:</strong> @_shipments.Sum(s => s.Weight ?? 0).ToString("F2") kg
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" Size="Size.Large"
                       Disabled="@(!_isValid || (_enableShipments && _shipments.Count == 0))" StartIcon="@Icons.Material.Filled.Send">
                Submit Pickup Request
            </MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@inject IJSRuntime JSRuntime

@code {
    private PickupRequest _entity = new();
    private List<PickupRequestShipment> _shipments = new();
    private MudForm _form = null!;
    private bool _isValid;
    private DateTime? _scheduledDate = DateTime.Today.AddDays(1);
    private List<PartyAddress> _savedAddresses = new();
    private long? _selectedAddressId;
    private Party? _customerParty;
    private long? _customerId;
    private List<string> _uploadErrors = new();
    private City? _selectedCity;
    private List<PickupSchedule> _pickupSchedules = new();
    private bool _enableShipments = false;

    protected override async Task OnInitializedAsync()
    {
        _pickupSchedules = await DbContext.PickupSchedules
            .Where(s => s.IsActive && !s.IsDeleted)
            .OrderBy(s => s.SortOrder)
            .ToListAsync();
            
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId")?.Value;
            if (long.TryParse(userIdClaim, out var userId))
            {
                var dbUser = await DbContext.Users.FindAsync(userId);
                if (dbUser != null)
                {
                    _entity.Email = dbUser.Email;
                    _entity.ContactPerson = dbUser.FullName;
                    _entity.Phone = dbUser.Phone;
                    
                    _customerParty = await DbContext.Parties
                        .Include(p => p.Addresses)
                        .FirstOrDefaultAsync(p => p.Email == dbUser.Email && !p.IsDeleted);
                    
                    if (_customerParty != null)
                    {
                        _customerId = _customerParty.Id;
                        _savedAddresses = _customerParty.Addresses.Where(a => !a.IsDeleted).ToList();
                        
                        // Auto-populate shipper details from customer's primary address
                        var primaryAddress = _savedAddresses.FirstOrDefault(a => a.AddressType == "Primary") 
                                             ?? _savedAddresses.FirstOrDefault();
                        if (primaryAddress != null)
                        {
                            _selectedAddressId = primaryAddress.Id;
                            OnAddressSelected(primaryAddress.Id);
                        }
                    }
                }
            }
        }
        
        AddShipment();
    }

    private void AddShipment()
    {
        _shipments.Add(new PickupRequestShipment
        {
            LineNo = _shipments.Count + 1,
            Pieces = 1,
            DocumentTypeId = DocumentType.Document,
            PaymentModeId = PaymentMode.Prepaid
        });
    }

    private void RemoveShipment(int index)
    {
        if (_shipments.Count > 0)
        {
            _shipments.RemoveAt(index);
            for (int i = 0; i < _shipments.Count; i++)
            {
                _shipments[i].LineNo = i + 1;
            }
        }
    }

    private void OnAddressSelected(long? addressId)
    {
        _selectedAddressId = addressId;
        if (addressId.HasValue)
        {
            var addr = _savedAddresses.FirstOrDefault(a => a.Id == addressId.Value);
            if (addr != null)
            {
                _entity.AddressId = addr.Id;
                _entity.PickupAddress = $"{addr.BuildingName}, {addr.Street}, {addr.Area}".Trim().Trim(',');
                _entity.City = addr.City;
                _entity.State = addr.State;
                _entity.Country = addr.Country;
                _entity.PostalCode = addr.PostalCode;
                _entity.Landmark = addr.Landmark;
            }
        }
    }

    private void OnScheduleChanged(long? scheduleId)
    {
        _entity.PickupScheduleId = scheduleId;
        var schedule = _pickupSchedules.FirstOrDefault(s => s.Id == scheduleId);
        _entity.PickupScheduleName = schedule?.Name;
    }

    private async Task<IEnumerable<City>> SearchCities(string value)
    {
        if (string.IsNullOrWhiteSpace(value) || value.Length < 2)
            return Enumerable.Empty<City>();
        
        var searchValue = value.ToLower();
        return await DbContext.Cities
            .Include(c => c.State)
            .Include(c => c.Country)
            .Where(c => c.IsActive && !c.IsDeleted && c.Name.ToLower().Contains(searchValue))
            .OrderBy(c => c.Name)
            .Take(15)
            .ToListAsync();
    }

    private async Task OnCitySelected(City? city)
    {
        _selectedCity = city;
        
        if (city != null)
        {
            _entity.City = city.Name;
            _entity.State = city.State?.Name;
            _entity.Country = city.Country?.Name;
        }
        else
        {
            _entity.City = null;
            _entity.State = null;
            _entity.Country = null;
        }
        
        await Task.CompletedTask;
    }

    private async Task Submit()
    {
        if (_enableShipments && _shipments.Count == 0)
        {
            Snackbar.Add("Please add at least one shipment or disable the shipments checkbox", Severity.Warning);
            return;
        }

        _entity.PickupNo = await GeneratePickupNo();
        _entity.RequestDate = DateTime.UtcNow;
        _entity.ScheduledDate = _scheduledDate.HasValue ? DateTime.SpecifyKind(_scheduledDate.Value, DateTimeKind.Utc) : null;
        _entity.Status = PickupStatus.PickupRequest;
        _entity.EstimatedPieces = _enableShipments ? _shipments.Sum(s => s.Pieces ?? 0) : 0;
        _entity.EstimatedWeight = _enableShipments ? _shipments.Sum(s => s.Weight ?? 0) : 0;
        
        if (_customerParty != null)
        {
            _entity.CustomerId = _customerParty.Id;
            _entity.CustomerName = _customerParty.Name;
        }
        else
        {
            _entity.CustomerName = _entity.ContactPerson;
        }
        
        if (_enableShipments)
        {
            foreach (var shipment in _shipments)
            {
                _entity.Shipments.Add(shipment);
            }
        }
        
        DbContext.PickupRequests.Add(_entity);
        await DbContext.SaveChangesAsync();
        
        var message = _enableShipments 
            ? $"Pickup request {_entity.PickupNo} with {_shipments.Count} shipment(s) submitted successfully!"
            : $"Pickup request {_entity.PickupNo} submitted successfully!";
        Snackbar.Add(message, Severity.Success);
        NavigationManager.NavigateTo("/customer/my-pickups");
    }

    private async Task<string> GeneratePickupNo()
    {
        var today = DateTime.UtcNow.Date;
        var count = await DbContext.PickupRequests
            .Where(p => p.RequestDate >= today)
            .CountAsync();
        return $"PU{DateTime.UtcNow:yyyyMMdd}{(count + 1):D4}";
    }

    private async Task OnFileUpload(IBrowserFile file)
    {
        _uploadErrors.Clear();
        
        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            
            var lines = content.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            
            if (lines.Length < 2)
            {
                Snackbar.Add("File is empty or has no data rows", Severity.Warning);
                return;
            }
            
            var headers = lines[0].Split(',').Select(h => h.Trim().ToLower()).ToArray();
            var nameIdx = Array.FindIndex(headers, h => h.Contains("name") || h.Contains("consignee"));
            var phoneIdx = Array.FindIndex(headers, h => h.Contains("phone") || h.Contains("mobile"));
            var addressIdx = Array.FindIndex(headers, h => h.Contains("address"));
            var cityIdx = Array.FindIndex(headers, h => h.Contains("city"));
            var postalIdx = Array.FindIndex(headers, h => h.Contains("postal") || h.Contains("pin") || h.Contains("zip"));
            var piecesIdx = Array.FindIndex(headers, h => h.Contains("piece") || h.Contains("qty"));
            var weightIdx = Array.FindIndex(headers, h => h.Contains("weight"));
            var descIdx = Array.FindIndex(headers, h => h.Contains("desc") || h.Contains("content"));
            var refIdx = Array.FindIndex(headers, h => h.Contains("ref") || h.Contains("order"));
            
            int imported = 0;
            for (int i = 1; i < lines.Length; i++)
            {
                try
                {
                    var cols = ParseCsvLine(lines[i]);
                    if (cols.Length == 0) continue;
                    
                    var shipment = new PickupRequestShipment
                    {
                        LineNo = _shipments.Count + 1,
                        Consignee = GetCol(cols, nameIdx),
                        ConsigneePhone = GetCol(cols, phoneIdx),
                        ConsigneeAddress1 = GetCol(cols, addressIdx),
                        ConsigneeCity = GetCol(cols, cityIdx),
                        ConsigneePostalCode = GetCol(cols, postalIdx),
                        CargoDescription = GetCol(cols, descIdx),
                        ReferenceNo = GetCol(cols, refIdx),
                        DocumentTypeId = DocumentType.Document,
                        PaymentModeId = PaymentMode.Prepaid
                    };
                    
                    if (int.TryParse(GetCol(cols, piecesIdx), out var pieces))
                        shipment.Pieces = pieces;
                    else
                        shipment.Pieces = 1;
                    
                    if (decimal.TryParse(GetCol(cols, weightIdx), out var weight))
                        shipment.Weight = weight;
                    
                    if (string.IsNullOrWhiteSpace(shipment.Consignee) || string.IsNullOrWhiteSpace(shipment.ConsigneeCity))
                    {
                        _uploadErrors.Add($"Row {i + 1}: Missing required fields (name or city)");
                        continue;
                    }
                    
                    _shipments.Add(shipment);
                    imported++;
                }
                catch (Exception ex)
                {
                    _uploadErrors.Add($"Row {i + 1}: {ex.Message}");
                }
            }
            
            Snackbar.Add($"Imported {imported} shipments from file", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading file: {ex.Message}", Severity.Error);
        }
    }

    private string[] ParseCsvLine(string line)
    {
        var result = new List<string>();
        var inQuotes = false;
        var current = "";
        
        foreach (var c in line)
        {
            if (c == '"') { inQuotes = !inQuotes; }
            else if (c == ',' && !inQuotes) { result.Add(current.Trim()); current = ""; }
            else { current += c; }
        }
        result.Add(current.Trim());
        return result.ToArray();
    }

    private string GetCol(string[] cols, int idx) => idx >= 0 && idx < cols.Length ? cols[idx] : "";

    private async Task DownloadTemplate()
    {
        var csv = "ReceiverName,Phone,Address,City,PostalCode,Pieces,Weight,Description,Reference\n";
        csv += "John Doe,+971501234567,123 Main St,Dubai,12345,1,0.5,Documents,ORD-001\n";
        csv += "Jane Smith,+971509876543,456 Oak Ave,Abu Dhabi,54321,2,1.5,Parcel,ORD-002";
        
        var bytes = System.Text.Encoding.UTF8.GetBytes(csv);
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("eval", $"{{ const a=document.createElement('a'); a.href='data:text/csv;base64,{base64}'; a.download='shipment_template.csv'; a.click(); }}");
    }
}

@page "/customer/pickup-request"
@layout CustomerLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums

<PageTitle>Request Pickup - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h5" GutterBottom="true" Align="Align.Center">Request a Pickup</MudText>
    
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudStack Spacing="3">
                <MudDatePicker @bind-Date="_scheduledDate" Label="Preferred Pickup Date" Variant="Variant.Outlined" 
                               DateFormat="dd/MM/yyyy" Required="true" MinDate="DateTime.Today" />
                
                <MudDivider />
                <MudText Typo="Typo.subtitle1" GutterBottom="true">Pickup Address (Your Location)</MudText>
                
                @if (_savedAddresses.Any())
                {
                    <MudSelect T="long?" Value="_selectedAddressId" Label="Select Saved Address" Variant="Variant.Outlined" 
                               ValueChanged="OnAddressSelected" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem T="long?" Value="@((long?)null)">-- Enter New Address --</MudSelectItem>
                        @foreach (var addr in _savedAddresses)
                        {
                            <MudSelectItem T="long?" Value="@((long?)addr.Id)">
                                @addr.AddressType: @addr.Street, @addr.City - @addr.PostalCode
                            </MudSelectItem>
                        }
                    </MudSelect>
                }
                
                <MudTextField @bind-Value="_entity.PickupAddress" Label="Pickup Address" Variant="Variant.Outlined" 
                              Required="true" Lines="2" />
                
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.City" Label="City" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.PostalCode" Label="Postal Code" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                </MudGrid>
                
                <MudTextField @bind-Value="_entity.Landmark" Label="Landmark (optional)" Variant="Variant.Outlined" />
                
                <MudDivider />
                <MudText Typo="Typo.subtitle1" GutterBottom="true">Contact Details</MudText>
                
                <MudTextField @bind-Value="_entity.ContactPerson" Label="Contact Person" Variant="Variant.Outlined" Required="true" />
                
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.Mobile" Label="Mobile" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_entity.Phone" Label="Alternate Phone" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
                
                <MudTextField @bind-Value="_entity.SpecialInstructions" Label="Special Instructions (optional)" Variant="Variant.Outlined" Lines="2"
                              Placeholder="Any special handling requirements?" />
            </MudStack>
        </MudForm>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.subtitle1">Shipments (@_shipments.Count)</MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddShipment">
                Add Shipment
            </MudButton>
        </MudStack>
        
        @if (_shipments.Count == 0)
        {
            <MudAlert Severity="Severity.Info">Add at least one shipment to continue</MudAlert>
        }
        else
        {
            <MudStack Spacing="3">
                @foreach (var (shipment, index) in _shipments.Select((s, i) => (s, i)))
                {
                    <MudCard Outlined="true">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">Shipment #@(index + 1)</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                               OnClick="@(() => RemoveShipment(index))" />
                            </MudStack>
                            
                            <MudText Typo="Typo.subtitle2" GutterBottom="true">Receiver Details</MudText>
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.Consignee" Label="Receiver Name" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.ConsigneePhone" Label="Receiver Phone" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudTextField @bind-Value="shipment.ConsigneeAddress1" Label="Delivery Address" Variant="Variant.Outlined" 
                                          Required="true" Class="mt-2" />
                            
                            <MudGrid>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneeCity" Label="City" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneeState" Label="State" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="shipment.ConsigneePostalCode" Label="Postal Code" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudDivider Class="my-3" />
                            <MudText Typo="Typo.subtitle2" GutterBottom="true">Package Details</MudText>
                            
                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="shipment.Pieces" Label="Pieces" Variant="Variant.Outlined" Min="1" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="shipment.Weight" Label="Weight (kg)" Variant="Variant.Outlined" Format="F2" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudSelect T="DocumentType" @bind-Value="shipment.DocumentTypeId" Label="Content Type" 
                                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                        <MudSelectItem Value="DocumentType.Document">Document</MudSelectItem>
                                        <MudSelectItem Value="DocumentType.Parcel">Parcel</MudSelectItem>
                                    </MudSelect>
                                </MudItem>
                            </MudGrid>
                            
                            <MudGrid>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Length" Label="Length (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Width" Label="Width (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                                <MudItem xs="4">
                                    <MudNumericField @bind-Value="shipment.Height" Label="Height (cm)" Variant="Variant.Outlined" Format="F1" />
                                </MudItem>
                            </MudGrid>
                            
                            <MudTextField @bind-Value="shipment.CargoDescription" Label="Package Description" Variant="Variant.Outlined" 
                                          Placeholder="What are you sending?" Class="mt-2" />
                            
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="shipment.ReferenceNo" Label="Your Reference" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="shipment.DeclaredValue" Label="Declared Value" Variant="Variant.Outlined" Format="F2" />
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    </MudPaper>
    
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText>
                <strong>Total Shipments:</strong> @_shipments.Count | 
                <strong>Total Pieces:</strong> @_shipments.Sum(s => s.Pieces ?? 0) | 
                <strong>Total Weight:</strong> @_shipments.Sum(s => s.Weight ?? 0).ToString("F2") kg
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit" Size="Size.Large"
                       Disabled="@(!_isValid || _shipments.Count == 0)" StartIcon="@Icons.Material.Filled.Send">
                Submit Pickup Request
            </MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private PickupRequest _entity = new();
    private List<PickupRequestShipment> _shipments = new();
    private MudForm _form = null!;
    private bool _isValid;
    private DateTime? _scheduledDate = DateTime.Today.AddDays(1);
    private List<PartyAddress> _savedAddresses = new();
    private long? _selectedAddressId;
    private Party? _customerParty;
    private long? _customerId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst("UserId")?.Value;
            if (long.TryParse(userIdClaim, out var userId))
            {
                var dbUser = await DbContext.Users.FindAsync(userId);
                if (dbUser != null)
                {
                    _entity.Email = dbUser.Email;
                    _entity.ContactPerson = dbUser.FullName;
                    _entity.Phone = dbUser.Phone;
                    
                    _customerParty = await DbContext.Parties
                        .Include(p => p.Addresses)
                        .FirstOrDefaultAsync(p => p.Email == dbUser.Email && !p.IsDeleted);
                    
                    if (_customerParty != null)
                    {
                        _customerId = _customerParty.Id;
                        _savedAddresses = _customerParty.Addresses.Where(a => !a.IsDeleted).ToList();
                    }
                }
            }
        }
        
        AddShipment();
    }

    private void AddShipment()
    {
        _shipments.Add(new PickupRequestShipment
        {
            LineNo = _shipments.Count + 1,
            Pieces = 1,
            DocumentTypeId = DocumentType.Document,
            PaymentModeId = PaymentMode.Prepaid
        });
    }

    private void RemoveShipment(int index)
    {
        if (_shipments.Count > 0)
        {
            _shipments.RemoveAt(index);
            for (int i = 0; i < _shipments.Count; i++)
            {
                _shipments[i].LineNo = i + 1;
            }
        }
    }

    private void OnAddressSelected(long? addressId)
    {
        _selectedAddressId = addressId;
        if (addressId.HasValue)
        {
            var addr = _savedAddresses.FirstOrDefault(a => a.Id == addressId.Value);
            if (addr != null)
            {
                _entity.AddressId = addr.Id;
                _entity.PickupAddress = $"{addr.BuildingName}, {addr.Street}, {addr.Area}".Trim().Trim(',');
                _entity.City = addr.City;
                _entity.State = addr.State;
                _entity.Country = addr.Country;
                _entity.PostalCode = addr.PostalCode;
                _entity.Landmark = addr.Landmark;
            }
        }
    }

    private async Task Submit()
    {
        if (_shipments.Count == 0)
        {
            Snackbar.Add("Please add at least one shipment", Severity.Warning);
            return;
        }

        _entity.PickupNo = await GeneratePickupNo();
        _entity.RequestDate = DateTime.UtcNow;
        _entity.ScheduledDate = _scheduledDate.HasValue ? DateTime.SpecifyKind(_scheduledDate.Value, DateTimeKind.Utc) : null;
        _entity.Status = PickupStatus.PickupRequest;
        _entity.EstimatedPieces = _shipments.Sum(s => s.Pieces ?? 0);
        _entity.EstimatedWeight = _shipments.Sum(s => s.Weight ?? 0);
        
        if (_customerParty != null)
        {
            _entity.CustomerId = _customerParty.Id;
            _entity.CustomerName = _customerParty.Name;
        }
        else
        {
            _entity.CustomerName = _entity.ContactPerson;
        }
        
        foreach (var shipment in _shipments)
        {
            _entity.Shipments.Add(shipment);
        }
        
        DbContext.PickupRequests.Add(_entity);
        await DbContext.SaveChangesAsync();
        
        Snackbar.Add($"Pickup request {_entity.PickupNo} with {_shipments.Count} shipment(s) submitted successfully!", Severity.Success);
        NavigationManager.NavigateTo("/customer/my-pickups");
    }

    private async Task<string> GeneratePickupNo()
    {
        var today = DateTime.UtcNow.Date;
        var count = await DbContext.PickupRequests
            .Where(p => p.RequestDate >= today)
            .CountAsync();
        return $"PU{DateTime.UtcNow:yyyyMMdd}{(count + 1):D4}";
    }
}

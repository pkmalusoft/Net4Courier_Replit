@page "/ar-settings"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Web.Services
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject AppAuthStateProvider AuthState
@rendermode InteractiveServer

<PageTitle>AR Settings - Net4Courier</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">Account Receivables Settings</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
        <MudTabPanel Text="General Settings" Icon="@Icons.Material.Filled.Settings">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Invoice Settings</MudText>
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_invoicePrefix" Label="Invoice Number Prefix" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_invoiceStartNo" Label="Starting Invoice Number" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_defaultPaymentTerms" Label="Default Payment Terms (Days)" Variant="Variant.Outlined" />
                            <MudSwitch @bind-Value="_autoGenerateInvoiceNo" Label="Auto-Generate Invoice Numbers" Color="Color.Primary" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Receipt Settings</MudText>
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_receiptPrefix" Label="Receipt Number Prefix" Variant="Variant.Outlined" />
                            <MudNumericField @bind-Value="_receiptStartNo" Label="Starting Receipt Number" Variant="Variant.Outlined" />
                            <MudSwitch @bind-Value="_autoAllocateReceipts" Label="Auto-Allocate Receipts to Oldest Invoices" Color="Color.Primary" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Credit Control</MudText>
                        <MudStack Spacing="3">
                            <MudNumericField @bind-Value="_defaultCreditLimit" Label="Default Credit Limit" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="@AuthState.CurrencyCode" />
                            <MudNumericField @bind-Value="_defaultCreditDays" Label="Default Credit Days" Variant="Variant.Outlined" />
                            <MudSwitch @bind-Value="_enforceCredit" Label="Enforce Credit Limits" Color="Color.Primary" />
                            <MudSwitch @bind-Value="_blockOverdueCustomers" Label="Block Orders for Overdue Customers" Color="Color.Warning" />
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Reminders & Notifications</MudText>
                        <MudStack Spacing="3">
                            <MudSwitch @bind-Value="_sendPaymentReminders" Label="Send Payment Reminders" Color="Color.Primary" />
                            <MudNumericField @bind-Value="_reminderDaysBefore" Label="Days Before Due Date" Variant="Variant.Outlined" Disabled="@(!_sendPaymentReminders)" />
                            <MudSwitch @bind-Value="_sendOverdueNotice" Label="Send Overdue Notices" Color="Color.Warning" />
                            <MudNumericField @bind-Value="_overdueNoticeDays" Label="Days After Due Date" Variant="Variant.Outlined" Disabled="@(!_sendOverdueNotice)" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <MudTabPanel Text="Invoice Footer" Icon="@Icons.Material.Filled.Description">
            <MudGrid>
                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Terms & Conditions</MudText>
                        <MudText Typo="Typo.caption" Class="mb-2">Enter the terms and conditions that will appear on printed invoices (one per line)</MudText>
                        <MudTextField @bind-Value="_termsAndConditions" 
                                      Label="Terms & Conditions" 
                                      Variant="Variant.Outlined" 
                                      Lines="8"
                                      FullWidth="true"
                                      Placeholder="1. Payment should be made in cash or cheque in favour of [Company Name]&#10;2. In case of any discrepancy in the Invoice, please notify within 3 working days from the receipt of invoice failing which it will be deemed correct.&#10;3. Alteration/overwrite on invoices are not allowed.&#10;4. Payment should be made in account payee cheque or remitted to below mentioned bank account." />
                    </MudPaper>
                </MudItem>

                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Bank Account Details</MudText>
                        <MudText Typo="Typo.caption" Class="mb-3">Enter bank details for invoice payments (English & Arabic)</MudText>
                        
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">English</MudText>
                                <MudStack Spacing="2">
                                    <MudTextField @bind-Value="_bankAccountTitle" Label="Account Title" Variant="Variant.Outlined" />
                                    <MudTextField @bind-Value="_bankAccountNumber" Label="Account Number" Variant="Variant.Outlined" />
                                    <MudTextField @bind-Value="_bankIBANNumber" Label="IBAN Number" Variant="Variant.Outlined" />
                                    <MudTextField @bind-Value="_bankAccountType" Label="Account Type" Variant="Variant.Outlined" Placeholder="e.g. Business Current Account" />
                                    <MudTextField @bind-Value="_bankCurrency" Label="Currency" Variant="Variant.Outlined" Placeholder="e.g. AED" />
                                    <MudTextField @bind-Value="_bankSWIFTCode" Label="Bank SWIFT Code" Variant="Variant.Outlined" />
                                    <MudTextField @bind-Value="_bankName" Label="Bank Name" Variant="Variant.Outlined" />
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Secondary" Style="text-align: right; direction: rtl;">العربية</MudText>
                                <MudStack Spacing="2">
                                    <MudTextField @bind-Value="_bankAccountTitleArabic" Label="اسم الحساب (Account Title)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" />
                                    <MudTextField Value="@_bankAccountNumber" Label="رقم الحساب (Account Number)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" ReadOnly="true" />
                                    <MudTextField Value="@_bankIBANNumber" Label="رقم ايبان (IBAN Number)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" ReadOnly="true" />
                                    <MudTextField @bind-Value="_bankAccountTypeArabic" Label="نوع الحساب (Account Type)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" Placeholder="مثال: حساب جاري للشركات" />
                                    <MudTextField Value="@GetArabicCurrency()" Label="العملة (Currency)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" ReadOnly="true" />
                                    <MudTextField Value="@_bankSWIFTCode" Label="رمز SWIFT (SWIFT Code)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" ReadOnly="true" />
                                    <MudTextField @bind-Value="_bankNameArabic" Label="اسم البنك (Bank Name)" Variant="Variant.Outlined" Style="direction: rtl; text-align: right;" />
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
    </MudTabs>

    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveSettings" Disabled="@_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save Settings
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private string _invoicePrefix = "INV-";
    private int _invoiceStartNo = 1001;
    private int _defaultPaymentTerms = 30;
    private bool _autoGenerateInvoiceNo = true;

    private string _receiptPrefix = "REC-";
    private int _receiptStartNo = 1001;
    private bool _autoAllocateReceipts = true;

    private decimal _defaultCreditLimit = 50000;
    private int _defaultCreditDays = 30;
    private bool _enforceCredit = true;
    private bool _blockOverdueCustomers = false;

    private bool _sendPaymentReminders = true;
    private int _reminderDaysBefore = 3;
    private bool _sendOverdueNotice = true;
    private int _overdueNoticeDays = 7;

    private string _termsAndConditions = "";
    private string _bankAccountTitle = "";
    private string _bankAccountTitleArabic = "";
    private string _bankAccountNumber = "";
    private string _bankIBANNumber = "";
    private string _bankAccountType = "";
    private string _bankAccountTypeArabic = "";
    private string _bankCurrency = "";
    private string _bankSWIFTCode = "";
    private string _bankName = "";
    private string _bankNameArabic = "";

    private bool _isSaving = false;
    private Company? _company;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            _company = await dbContext.Companies.FirstOrDefaultAsync(c => !c.IsDeleted);
            
            if (_company != null)
            {
                _termsAndConditions = _company.InvoiceTermsAndConditions ?? "";
                _bankAccountTitle = _company.BankAccountTitle ?? "";
                _bankAccountTitleArabic = _company.BankAccountTitleArabic ?? "";
                _bankAccountNumber = _company.BankAccountNumber ?? "";
                _bankIBANNumber = _company.BankIBANNumber ?? "";
                _bankAccountType = _company.BankAccountType ?? "";
                _bankAccountTypeArabic = _company.BankAccountTypeArabic ?? "";
                _bankCurrency = _company.BankCurrency ?? "";
                _bankSWIFTCode = _company.BankSWIFTCode ?? "";
                _bankName = _company.BankName ?? "";
                _bankNameArabic = _company.BankNameArabic ?? "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ARSettings] Error loading settings: {ex.Message}");
        }
    }

    private string GetArabicCurrency()
    {
        return _bankCurrency?.ToUpper() switch
        {
            "AED" => "درهم",
            "USD" => "دولار أمريكي",
            "EUR" => "يورو",
            "GBP" => "جنيه إسترليني",
            "SAR" => "ريال سعودي",
            _ => _bankCurrency ?? ""
        };
    }

    private async Task SaveSettings()
    {
        _isSaving = true;
        StateHasChanged();

        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var company = await dbContext.Companies.FirstOrDefaultAsync(c => !c.IsDeleted);
            
            if (company != null)
            {
                company.InvoiceTermsAndConditions = _termsAndConditions;
                company.BankAccountTitle = _bankAccountTitle;
                company.BankAccountTitleArabic = _bankAccountTitleArabic;
                company.BankAccountNumber = _bankAccountNumber;
                company.BankIBANNumber = _bankIBANNumber;
                company.BankAccountType = _bankAccountType;
                company.BankAccountTypeArabic = _bankAccountTypeArabic;
                company.BankCurrency = _bankCurrency;
                company.BankSWIFTCode = _bankSWIFTCode;
                company.BankName = _bankName;
                company.BankNameArabic = _bankNameArabic;

                await dbContext.SaveChangesAsync();
                Snackbar.Add("AR Settings saved successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Company not found", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }
}

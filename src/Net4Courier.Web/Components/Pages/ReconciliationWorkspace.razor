@page "/bank-reconciliation/{ReconciliationId:long}"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject IBankReconciliationService ReconciliationService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Web.Services

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (_reconciliation == null)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" />
                <MudText Typo="Typo.h5">@_reconciliation.ReconciliationNumber</MudText>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_reconciliation.Status)">
                    @_reconciliation.Status.ToString()
                </MudChip>
            </MudStack>
        </MudStack>

        <MudPaper Class="pa-4 mb-4" Elevation="1">
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Bank Account</MudText>
                    <MudText Typo="Typo.body1"><b>@_reconciliation.BankAccount?.AccountName</b></MudText>
                    <MudText Typo="Typo.caption">@_reconciliation.BankAccount?.BankName</MudText>
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Statement Date</MudText>
                    <MudText Typo="Typo.body1"><b>@_reconciliation.StatementDate.ToString("dd-MMM-yyyy")</b></MudText>
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Statement Balance</MudText>
                    <MudText Typo="Typo.body1"><b>@_reconciliation.StatementClosingBalance.ToString("N2")</b></MudText>
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Book Balance</MudText>
                    <MudText Typo="Typo.body1"><b>@_reconciliation.BookClosingBalance.ToString("N2")</b></MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Difference</MudText>
                    <MudText Typo="Typo.body1" Color="@(_reconciliation.DifferenceAmount == 0 ? Color.Success : Color.Error)">
                        <b>@_reconciliation.DifferenceAmount.ToString("N2")</b>
                    </MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTabIndex">
            <MudTabPanel Text="Import Statement" Icon="@Icons.Material.Filled.Upload">
                @RenderImportTab()
            </MudTabPanel>

            <MudTabPanel Text="Auto Match" Icon="@Icons.Material.Filled.AutoAwesome">
                @RenderAutoMatchTab()
            </MudTabPanel>

            <MudTabPanel Text="Manual Match" Icon="@Icons.Material.Filled.CompareArrows">
                @RenderManualMatchTab()
            </MudTabPanel>

            <MudTabPanel Text="Adjustments" Icon="@Icons.Material.Filled.Edit">
                @RenderAdjustmentsTab()
            </MudTabPanel>

            <MudTabPanel Text="Finalize" Icon="@Icons.Material.Filled.CheckCircle">
                @RenderFinalizeTab()
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

<style>
    .selected-row {
        background-color: var(--mud-palette-primary-lighten) !important;
    }
</style>

@code {
    [Parameter]
    public long ReconciliationId { get; set; }

    private int _activeTabIndex = 0;
    private Net4Courier.Finance.Entities.BankReconciliation? _reconciliation;
    private List<BankStatementLine> _statementLines = new();
    private List<Journal> _unmatchedVouchers = new();
    private List<ReconciliationMatch> _matches = new();
    private List<ReconciliationAdjustment> _adjustments = new();

    private BankStatementLine? _selectedStatementLine;
    private Journal? _selectedVoucher;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reconciliation: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadData()
    {
        try
        {
            _reconciliation = await DbContext.BankReconciliations
                .Include(r => r.BankAccount)
                .FirstOrDefaultAsync(r => r.Id == ReconciliationId);

            if (_reconciliation == null)
            {
                Snackbar.Add("Reconciliation not found", Severity.Error);
                Navigation.NavigateTo("/bank-reconciliation");
                return;
            }

            _statementLines = await DbContext.BankStatementLines
                .Where(l => l.BankStatementImport!.BankReconciliationId == ReconciliationId)
                .OrderBy(l => l.TransactionDate)
                .ToListAsync();

            var bankAccountHeadId = _reconciliation.BankAccount?.AccountHeadId ?? 0;
            _unmatchedVouchers = await DbContext.Journals
                .Where(j => j.VoucherType == "BV" 
                         && j.IsPosted 
                         && j.Entries.Any(e => e.AccountHeadId == bankAccountHeadId)
                         && !DbContext.ReconciliationMatches.Any(m => m.JournalId == j.Id && !m.IsReversed))
                .OrderBy(j => j.VoucherDate)
                .ToListAsync();

            _matches = await DbContext.ReconciliationMatches
                .Include(m => m.BankStatementLine)
                .Include(m => m.Journal)
                .Where(m => m.BankReconciliationId == ReconciliationId && !m.IsReversed)
                .OrderByDescending(m => m.MatchedAt)
                .ToListAsync();

            _adjustments = await DbContext.ReconciliationAdjustments
                .Where(a => a.BankReconciliationId == ReconciliationId)
                .OrderByDescending(a => a.CreatedAt)
                .ToListAsync();

            _selectedStatementLine = null;
            _selectedVoucher = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
    }

    private RenderFragment RenderImportTab() => __builder =>
    {
        <MudText Typo="Typo.h6" Class="mb-4">Upload Bank Statement</MudText>
        
        @if (_reconciliation?.Status == ReconciliationStatus.Locked)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">This reconciliation is locked. No changes can be made.</MudAlert>
        }
        else
        {
            <MudStack Spacing="4">
                <MudText Typo="Typo.body2">Import your bank statement CSV file. The system will parse the transactions and add them to this reconciliation session.</MudText>
                
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload"
                           OnClick="OpenImportDialog">
                    Import CSV Statement
                </MudButton>

                @if (_statementLines.Count > 0)
                {
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1"><b>Imported Statement Lines (@_statementLines.Count)</b></MudText>
                    <MudTable Items="@_statementLines" Dense="true" Hover="true" FixedHeader="true" Height="350px">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Reference</MudTh>
                            <MudTh Style="text-align:right">Debit</MudTh>
                            <MudTh Style="text-align:right">Credit</MudTh>
                            <MudTh>Matched</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.TransactionDate.ToString("dd-MMM-yyyy")</MudTd>
                            <MudTd>@context.Description</MudTd>
                            <MudTd>@context.ReferenceNumber</MudTd>
                            <MudTd Style="text-align:right">@(context.DebitAmount > 0 ? context.DebitAmount.ToString("N2") : "")</MudTd>
                            <MudTd Style="text-align:right">@(context.CreditAmount > 0 ? context.CreditAmount.ToString("N2") : "")</MudTd>
                            <MudTd>
                                @if (context.IsMatched)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudStack>
        }
    };

    private RenderFragment RenderAutoMatchTab() => __builder =>
    {
        <MudText Typo="Typo.h6" Class="mb-4">Automatic Matching</MudText>

        @if (_reconciliation?.Status == ReconciliationStatus.Locked)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">This reconciliation is locked. No changes can be made.</MudAlert>
        }
        else
        {
            <MudStack Spacing="4">
                <MudText Typo="Typo.body2">Run the auto-match algorithm to automatically match statement lines with bank vouchers based on amount, date, and reference.</MudText>
                
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AutoMode"
                               OnClick="AutoMatch">
                        Run Auto-Match Algorithm
                    </MudButton>
                </MudStack>

                <MudGrid Class="mt-4">
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="1" Style="text-align:center">
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_statementLines.Count</MudText>
                            <MudText Typo="Typo.caption">Total Statement Lines</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="1" Style="text-align:center">
                            <MudText Typo="Typo.h4" Color="Color.Success">@_statementLines.Count(l => l.IsMatched)</MudText>
                            <MudText Typo="Typo.caption">Matched</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="1" Style="text-align:center">
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_statementLines.Count(l => !l.IsMatched)</MudText>
                            <MudText Typo="Typo.caption">Unmatched</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudStack>
        }
    };

    private RenderFragment RenderManualMatchTab() => __builder =>
    {
        <MudText Typo="Typo.h6" Class="mb-4">Manual Matching</MudText>

        @if (_reconciliation?.Status == ReconciliationStatus.Locked)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">This reconciliation is locked. No changes can be made.</MudAlert>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mb-4">Select a statement line on the left and a voucher on the right to manually match them.</MudText>

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.subtitle1"><b>Unmatched Statement Lines</b></MudText>
                            <MudChip T="string" Size="Size.Small">@_statementLines.Count(l => !l.IsMatched) unmatched</MudChip>
                        </MudStack>
                        <MudTable Items="@_statementLines.Where(l => !l.IsMatched).ToList()" Dense="true" Hover="true" FixedHeader="true" Height="350px"
                                  RowClassFunc="@((line, _) => _selectedStatementLine?.Id == line.Id ? "selected-row" : "")"
                                  OnRowClick="@((TableRowClickEventArgs<BankStatementLine> args) => SelectStatementLine(args.Item))">
                            <HeaderContent>
                                <MudTh>Date</MudTh>
                                <MudTh>Description</MudTh>
                                <MudTh Style="text-align:right">Debit</MudTh>
                                <MudTh Style="text-align:right">Credit</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.TransactionDate.ToString("dd-MMM")</MudTd>
                                <MudTd>
                                    <MudText Typo="Typo.body2" Style="max-width:200px;overflow:hidden;text-overflow:ellipsis">
                                        @context.Description
                                    </MudText>
                                </MudTd>
                                <MudTd Style="text-align:right">@(context.DebitAmount > 0 ? context.DebitAmount.ToString("N2") : "")</MudTd>
                                <MudTd Style="text-align:right">@(context.CreditAmount > 0 ? context.CreditAmount.ToString("N2") : "")</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.subtitle1"><b>Bank Vouchers (Unmatched)</b></MudText>
                            <MudChip T="string" Size="Size.Small">@_unmatchedVouchers.Count unmatched</MudChip>
                        </MudStack>
                        <MudTable Items="@_unmatchedVouchers" Dense="true" Hover="true" FixedHeader="true" Height="350px"
                                  RowClassFunc="@((voucher, _) => _selectedVoucher?.Id == voucher.Id ? "selected-row" : "")"
                                  OnRowClick="@((TableRowClickEventArgs<Journal> args) => SelectVoucher(args.Item))">
                            <HeaderContent>
                                <MudTh>Voucher No</MudTh>
                                <MudTh>Date</MudTh>
                                <MudTh>Reference</MudTh>
                                <MudTh Style="text-align:right">Amount</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.VoucherNo</MudTd>
                                <MudTd>@context.VoucherDate.ToString("dd-MMM")</MudTd>
                                <MudTd>@context.Reference</MudTd>
                                <MudTd Style="text-align:right">@((context.TotalDebit ?? context.TotalCredit ?? 0).ToString("N2"))</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @if (_selectedStatementLine != null && _selectedVoucher != null)
            {
                <MudPaper Class="pa-3 mt-4" Elevation="2" Style="background-color: var(--mud-palette-primary-lighten);">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText>
                            Match statement line <b>@_selectedStatementLine.Description?.Substring(0, Math.Min(40, _selectedStatementLine.Description?.Length ?? 0))...</b> 
                            with voucher <b>@_selectedVoucher.VoucherNo</b>?
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateManualMatch">
                            Match Selected
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }

            <MudPaper Class="pa-3 mt-4" Elevation="1">
                <MudText Typo="Typo.subtitle1" Class="mb-2"><b>Matched Transactions (@_matches.Count)</b></MudText>
                <MudTable Items="@_matches" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>Statement Line</MudTh>
                        <MudTh>Voucher</MudTh>
                        <MudTh Style="text-align:right">Amount</MudTh>
                        <MudTh>Match Type</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.BankStatementLine?.Description?.Substring(0, Math.Min(30, context.BankStatementLine?.Description?.Length ?? 0))...</MudTd>
                        <MudTd>@context.Journal?.VoucherNo</MudTd>
                        <MudTd Style="text-align:right">@context.MatchedAmount.ToString("N2")</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@(context.MatchType == MatchType.Automatic ? Color.Info : Color.Default)">
                                @context.MatchType.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            @if (!context.IsReversed && _reconciliation?.Status != ReconciliationStatus.Locked)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.LinkOff" Size="Size.Small" Color="Color.Warning"
                                               OnClick="@(() => UnmatchTransaction(context))" Title="Unmatch" />
                            }
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Align="Align.Center" Class="py-2">No matches yet.</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudPaper>
        }
    };

    private RenderFragment RenderAdjustmentsTab() => __builder =>
    {
        <MudText Typo="Typo.h6" Class="mb-4">Bank Adjustments</MudText>

        @if (_reconciliation?.Status == ReconciliationStatus.Locked)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">This reconciliation is locked. No changes can be made.</MudAlert>
        }
        else
        {
            <MudStack Spacing="4">
                <MudText Typo="Typo.body2">Add bank fees, interest, and other adjustments that appear on the bank statement but are not yet recorded in the books.</MudText>
                
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenAdjustmentDialog">
                    Add Adjustment
                </MudButton>

                @if (_adjustments.Count > 0)
                {
                    <MudTable Items="@_adjustments" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Date</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh Style="text-align:right">Amount</MudTh>
                            <MudTh>Posted</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.CreatedAt.ToString("dd-MMM-yyyy")</MudTd>
                            <MudTd>@context.AdjustmentType.ToString()</MudTd>
                            <MudTd>@context.Description</MudTd>
                            <MudTd Style="text-align:right">@context.Amount.ToString("N2")</MudTd>
                            <MudTd>
                                @if (context.IsPosted)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudStack>
        }
    };

    private RenderFragment RenderFinalizeTab() => __builder =>
    {
        <MudText Typo="Typo.h6" Class="mb-4">Finalize Reconciliation</MudText>

        @if (_reconciliation?.Status == ReconciliationStatus.Locked)
        {
            <MudAlert Severity="Severity.Success" Class="mb-4">This reconciliation has been completed and locked.</MudAlert>
        }
        else
        {
            <MudStack Spacing="4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudText Typo="Typo.subtitle1" Class="mb-3"><b>Reconciliation Summary</b></MudText>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Statement Closing Balance:</MudText>
                                    <MudText><b>@_reconciliation?.StatementClosingBalance.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Book Closing Balance:</MudText>
                                    <MudText><b>@_reconciliation?.BookClosingBalance.ToString("N2")</b></MudText>
                                </MudStack>
                                <MudDivider />
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Difference:</MudText>
                                    <MudText Color="@(_reconciliation?.DifferenceAmount == 0 ? Color.Success : Color.Error)">
                                        <b>@_reconciliation?.DifferenceAmount.ToString("N2")</b>
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudText Typo="Typo.subtitle1" Class="mb-3"><b>Matching Statistics</b></MudText>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Total Statement Lines:</MudText>
                                    <MudText><b>@_statementLines.Count</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Matched Lines:</MudText>
                                    <MudText Color="Color.Success"><b>@_statementLines.Count(l => l.IsMatched)</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Unmatched Lines:</MudText>
                                    <MudText Color="Color.Warning"><b>@_statementLines.Count(l => !l.IsMatched)</b></MudText>
                                </MudStack>
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText>Adjustments:</MudText>
                                    <MudText><b>@_adjustments.Count</b></MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                @if (_reconciliation?.DifferenceAmount != 0)
                {
                    <MudAlert Severity="Severity.Warning">
                        The reconciliation cannot be completed while there is a difference. Please match all transactions or add adjustments.
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Success">
                        The reconciliation balances! You can now complete and lock this reconciliation.
                    </MudAlert>
                }

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Check"
                               OnClick="CompleteReconciliation" Disabled="@(_reconciliation?.DifferenceAmount != 0)">
                        Complete & Lock Reconciliation
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="GoBack">
                        Cancel & Return
                    </MudButton>
                </MudStack>
            </MudStack>
        }
    };

    private void GoBack() => Navigation.NavigateTo("/bank-reconciliation");

    private Color GetStatusColor(ReconciliationStatus status) => status switch
    {
        ReconciliationStatus.Draft => Color.Default,
        ReconciliationStatus.InProgress => Color.Warning,
        ReconciliationStatus.Completed => Color.Success,
        ReconciliationStatus.Locked => Color.Info,
        _ => Color.Default
    };

    private void SelectStatementLine(BankStatementLine line)
    {
        _selectedStatementLine = _selectedStatementLine?.Id == line.Id ? null : line;
    }

    private void SelectVoucher(Journal voucher)
    {
        _selectedVoucher = _selectedVoucher?.Id == voucher.Id ? null : voucher;
    }

    private async Task AutoMatch()
    {
        var count = await ReconciliationService.AutoMatchTransactions(ReconciliationId, 1);
        Snackbar.Add($"Auto-matched {count} transactions", count > 0 ? Severity.Success : Severity.Info);
        await LoadData();
    }

    private async Task CreateManualMatch()
    {
        if (_selectedStatementLine == null || _selectedVoucher == null) return;

        var success = await ReconciliationService.CreateManualMatch(
            ReconciliationId, 
            _selectedStatementLine.Id, 
            _selectedVoucher.Id, 
            1);

        if (success)
        {
            Snackbar.Add("Match created successfully", Severity.Success);
            await LoadData();
        }
        else
        {
            Snackbar.Add("Failed to create match", Severity.Error);
        }
    }

    private async Task UnmatchTransaction(ReconciliationMatch match)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Unmatch Transaction",
            "Are you sure you want to unmatch this transaction?",
            yesText: "Unmatch", cancelText: "Cancel");

        if (confirm == true)
        {
            await ReconciliationService.UnmatchTransaction(match.Id, 1, "Manual unmatch");
            Snackbar.Add("Transaction unmatched", Severity.Success);
            await LoadData();
        }
    }

    private async Task OpenImportDialog()
    {
        var parameters = new DialogParameters<ImportStatementDialog>();
        parameters.Add(x => x.ReconciliationId, ReconciliationId);

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ImportStatementDialog>("Import Bank Statement", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await ReconciliationService.UpdateReconciliationBalances(ReconciliationId);
            await LoadData();
        }
    }

    private async Task OpenAdjustmentDialog()
    {
        var parameters = new DialogParameters<ReconciliationAdjustmentDialog>();
        parameters.Add(x => x.ReconciliationId, ReconciliationId);

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ReconciliationAdjustmentDialog>("Add Adjustment", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await ReconciliationService.UpdateReconciliationBalances(ReconciliationId);
            await LoadData();
        }
    }

    private async Task CompleteReconciliation()
    {
        if (_reconciliation == null) return;

        var confirm = await DialogService.ShowMessageBox(
            "Complete Reconciliation",
            "This will mark the reconciliation as completed and lock it. Continue?",
            yesText: "Complete", cancelText: "Cancel");

        if (confirm == true)
        {
            var success = await ReconciliationService.CompleteReconciliation(ReconciliationId, 1);
            if (success)
            {
                Snackbar.Add("Reconciliation completed and locked", Severity.Success);
            }
            else
            {
                Snackbar.Add("Cannot complete: difference must be zero", Severity.Warning);
            }
            await LoadData();
        }
    }
}

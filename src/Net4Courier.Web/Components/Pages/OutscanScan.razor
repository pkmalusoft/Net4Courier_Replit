@page "/outscan-scan/{DrsId:long}"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject Net4Courier.Web.Services.ShipmentStatusService ShipmentStatusService
@inject ILogger<OutscanScan> Logger
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Masters.Entities

<PageTitle>Outscan - Scan AWBs - Net4Courier</PageTitle>

@if (_drs == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h5">Outscan: @_drs.DRSNo</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @_drs.DeliveryEmployeeName | @_drs.VehicleNo | @_drs.DRSDate.ToString("dd MMM yyyy")
            </MudText>
        </MudStack>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Print"
                       Href="@($"/drs-print/{DrsId}")">
                Print DRS
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.ArrowBack"
                       Href="/outscan">
                Back to List
            </MudButton>
        </MudStack>
    </MudStack>

    @if (_drs.Status != DRSStatus.Closed)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background-color: #fff3e0;">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Size="Size.Large" Color="Color.Warning" />
                <MudTextField @bind-Value="_scanInput" Label="Scan AWB Number" Variant="Variant.Outlined" 
                              Immediate="true" OnKeyDown="OnScanKeyDown" Placeholder="Scan or type AWB number..."
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                              AdornmentColor="Color.Primary" OnAdornmentClick="ProcessScan"
                              Style="flex-grow: 1;" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ProcessScan"
                           StartIcon="@Icons.Material.Filled.Add" Size="Size.Large">
                    Add
                </MudButton>
            </MudStack>
            @if (!string.IsNullOrEmpty(_scanMessage))
            {
                <MudAlert Severity="@_scanSeverity" Class="mt-2" Dense="true">@_scanMessage</MudAlert>
            }
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">This DRS is closed. No more AWBs can be added.</MudAlert>
    }

    <MudPaper Class="pa-3 mb-4" Elevation="2" Style="background-color: #e3f2fd;">
        <MudStack Row="true" Justify="Justify.SpaceAround">
            <MudStack Spacing="0" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4" Color="Color.Primary">@_drsDetails.Count</MudText>
                <MudText Typo="Typo.caption">Total AWBs</MudText>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" />
            <MudStack Spacing="0" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4" Color="Color.Success">@_drsDetails.Count(d => d.Status == "Delivered")</MudText>
                <MudText Typo="Typo.caption">Delivered</MudText>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" />
            <MudStack Spacing="0" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4" Color="Color.Warning">@_drsDetails.Count(d => d.Status == "Pending")</MudText>
                <MudText Typo="Typo.caption">Pending</MudText>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" />
            <MudStack Spacing="0" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4" Color="Color.Tertiary">@_totalCOD.ToString("N0")</MudText>
                <MudText Typo="Typo.caption">Total COD</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudTable Items="@_drsDetails" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>#</MudTh>
            <MudTh>AWB No</MudTh>
            <MudTh>Consignee</MudTh>
            <MudTh>Destination</MudTh>
            <MudTh>Pcs</MudTh>
            <MudTh Style="text-align: right;">COD</MudTh>
            <MudTh>Status</MudTh>
            @if (_drs.Status != DRSStatus.Closed)
            {
                <MudTh>Actions</MudTh>
            }
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="#">@context.Sequence</MudTd>
            <MudTd DataLabel="AWB No">
                <MudLink Href="@($"/awb-entry/{context.InscanId}")">@context.Inscan?.AWBNo</MudLink>
            </MudTd>
            <MudTd DataLabel="Consignee">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.body2">@context.Inscan?.Consignee</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Inscan?.ConsigneePhone</MudText>
                </MudStack>
            </MudTd>
            <MudTd DataLabel="Destination">@context.Inscan?.ConsigneeCity</MudTd>
            <MudTd DataLabel="Pcs">@context.Inscan?.Pieces</MudTd>
            <MudTd DataLabel="COD" Style="text-align: right;">
                @if (context.Inscan?.MovementTypeId == MovementType.InternationalImport)
                {
                    <strong>@GetImportTotalCharges(context.Inscan).ToString("N2")</strong>
                }
                else if (context.CODAmount > 0)
                {
                    <strong>@context.CODAmount?.ToString("N2")</strong>
                }
            </MudTd>
            <MudTd DataLabel="Status">
                @switch (context.Status)
                {
                    case "Delivered":
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Delivered</MudChip>
                        break;
                    case "Returned":
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Returned</MudChip>
                        break;
                    default:
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Pending</MudChip>
                        break;
                }
            </MudTd>
            @if (_drs.Status != DRSStatus.Closed)
            {
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Warning"
                                   OnClick="@(() => OpenStatusDialog(context))" Title="Update Status" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => RemoveFromDRS(context))" Title="Remove from DRS" />
                </MudTd>
            }
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No AWBs added to this DRS yet. Scan AWB numbers above to add.</MudText>
        </NoRecordsContent>
    </MudTable>
}

@code {
    [Parameter] public long DrsId { get; set; }
    
    private DRS? _drs;
    private List<DRSDetail> _drsDetails = new();
    private string _scanInput = string.Empty;
    private string _scanMessage = string.Empty;
    private Severity _scanSeverity = Severity.Info;
    private decimal _totalCOD;
    private decimal _branchVatPercent;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _drs = await dbContext.Set<DRS>().FirstOrDefaultAsync(d => d.Id == DrsId);
        
        if (_drs == null)
        {
            Navigation.NavigateTo("/outscan");
            return;
        }
        
        _drsDetails = await dbContext.Set<DRSDetail>()
            .Include(d => d.Inscan)
            .Where(d => d.DRSId == DrsId)
            .OrderBy(d => d.Sequence)
            .ToListAsync();

        var branchId = _drsDetails.FirstOrDefault()?.Inscan?.BranchId;
        if (branchId.HasValue)
        {
            var branch = await dbContext.Set<Branch>().FirstOrDefaultAsync(b => b.Id == branchId.Value);
            _branchVatPercent = branch?.VatPercentage ?? 0;
        }

        var healAwbNos = _drsDetails
            .Where(d => d.Inscan?.AWBNo != null)
            .Select(d => d.Inscan!.AWBNo)
            .Distinct()
            .ToList();
        var healImportTotals = new Dictionary<string, decimal>();
        if (healAwbNos.Any())
        {
            var impList = await dbContext.ImportShipments
                .Where(imp => healAwbNos.Contains(imp.AWBNo) && !imp.IsDeleted)
                .Select(imp => new { imp.AWBNo, imp.DutyAmount, imp.VATAmount, imp.OtherCharges, imp.CODAmount })
                .ToListAsync();
            foreach (var imp in impList)
            {
                var total = (imp.DutyAmount ?? 0) + (imp.VATAmount ?? 0) + (imp.OtherCharges ?? 0) + (imp.CODAmount ?? 0);
                if (!healImportTotals.ContainsKey(imp.AWBNo) || total > healImportTotals[imp.AWBNo])
                    healImportTotals[imp.AWBNo] = total;
            }
        }

        foreach (var detail in _drsDetails)
        {
            if ((detail.CODAmount == null || detail.CODAmount == 0) && detail.Inscan != null)
            {
                if (detail.Inscan.PaymentModeId == PaymentMode.COD || detail.Inscan.IsCOD)
                    detail.CODAmount = detail.Inscan.CODAmount ?? 0;
            }
            var awbNo = detail.Inscan?.AWBNo;
            if (!string.IsNullOrEmpty(awbNo) && healImportTotals.TryGetValue(awbNo, out var importTotal))
            {
                if (importTotal > (detail.CODAmount ?? 0))
                {
                    detail.CODAmount = importTotal;
                }
            }
        }
            
        _totalCOD = _drsDetails.Sum(d =>
        {
            if (d.Inscan?.MovementTypeId == MovementType.InternationalImport)
                return GetImportTotalCharges(d.Inscan);
            return d.CODAmount ?? 0;
        });
        
        await UpdateDRSCounts();
    }

    private async Task OnScanKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ProcessScan();
        }
    }

    private async Task ProcessScan()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        Logger.LogInformation("[OUTSCAN] ProcessScan started. Input: {Input}", _scanInput);
        
        if (string.IsNullOrWhiteSpace(_scanInput))
        {
            _scanMessage = "Please enter an AWB number";
            _scanSeverity = Severity.Warning;
            Logger.LogWarning("[OUTSCAN] Empty input");
            return;
        }
        
        try
        {
            var awbNo = _scanInput.Trim().ToUpper();
            Logger.LogInformation("[OUTSCAN] Step 1: Processing AWB {AwbNo}", awbNo);
            
            var existingInDrs = _drsDetails.Any(d => d.Inscan?.AWBNo == awbNo);
            if (existingInDrs)
            {
                _scanMessage = $"AWB {awbNo} is already in this DRS";
                _scanSeverity = Severity.Warning;
                _scanInput = string.Empty;
                Logger.LogWarning("[OUTSCAN] AWB already in DRS");
                return;
            }
            
            Logger.LogInformation("[OUTSCAN] Step 2: Looking up AWB in database");
            var awb = await dbContext.InscanMasters
                .FirstOrDefaultAsync(a => a.AWBNo == awbNo && !a.IsDeleted);
            
            if (awb == null)
            {
                Logger.LogInformation("[OUTSCAN] AWB not found in InscanMasters, checking ImportShipments");
                var importShipment = await dbContext.ImportShipments
                    .FirstOrDefaultAsync(s => s.AWBNo == awbNo && !s.IsDeleted);
                
                if (importShipment != null)
                {
                    Logger.LogInformation("[OUTSCAN] Found import shipment: Id={Id}, Status={Status}", importShipment.Id, importShipment.Status);
                    await ProcessImportShipmentOutscan(importShipment, awbNo);
                    return;
                }
                
                _scanMessage = $"AWB {awbNo} not found";
                _scanSeverity = Severity.Error;
                _scanInput = string.Empty;
                Logger.LogWarning("[OUTSCAN] AWB not found in database");
                return;
            }
            Logger.LogInformation("[OUTSCAN] AWB found: Id={Id}, Status={Status}", awb.Id, awb.CourierStatusId);
            
            Logger.LogInformation("[OUTSCAN] Step 3: Checking shipment status history");
            var currentStatusInfo = await dbContext.ShipmentStatusHistories
                .Where(h => h.InscanMasterId == awb.Id)
                .OrderByDescending(h => h.ChangedAt)
                .ThenByDescending(h => h.Id)
                .Select(h => new { h.StatusId, StatusCode = h.Status != null ? h.Status.Code : null })
                .FirstOrDefaultAsync();
            Logger.LogInformation("[OUTSCAN] Status history result: {StatusInfo}", currentStatusInfo?.StatusCode ?? "null");
            
            var allowedStatusCodes = new[] { "INSCAN_ORIGIN", "INSCAN_DESTINATION", "RETURN_INSCAN", "DESTINATION_PROCESSED", "QC_COMPLETED" };
            
            if (currentStatusInfo != null && !string.IsNullOrEmpty(currentStatusInfo.StatusCode) && !allowedStatusCodes.Contains(currentStatusInfo.StatusCode))
            {
                var statusName = await dbContext.ShipmentStatuses
                    .Where(s => s.Id == currentStatusInfo.StatusId)
                    .Select(s => s.Name)
                    .FirstOrDefaultAsync() ?? "Unknown";
                _scanMessage = $"AWB {awbNo} is not available for outscan. Current status: {statusName}";
                _scanSeverity = Severity.Warning;
                _scanInput = string.Empty;
                Logger.LogWarning("[OUTSCAN] AWB status not allowed for outscan: {Status}", statusName);
                return;
            }
            else if (currentStatusInfo == null && awb.CourierStatusId != CourierStatus.InscanAtOrigin)
            {
                _scanMessage = $"AWB {awbNo} is not available for outscan. AWB must be inscanned first. Current status: {awb.CourierStatusId}";
                _scanSeverity = Severity.Warning;
                _scanInput = string.Empty;
                Logger.LogWarning("[OUTSCAN] AWB not inscanned. CourierStatusId: {Status}", awb.CourierStatusId);
                return;
            }
            
            Logger.LogInformation("[OUTSCAN] Step 4: Checking if AWB is in another DRS");
            var existingDrsDetails = await dbContext.Set<DRSDetail>()
                .Include(d => d.DRS)
                .Where(d => d.InscanId == awb.Id)
                .OrderByDescending(d => d.Id)
                .ToListAsync();

            if (existingDrsDetails.Any())
            {
                var onOpenDrs = existingDrsDetails.FirstOrDefault(d => d.DRS.Status != DRSStatus.Closed);
                if (onOpenDrs != null)
                {
                    _scanMessage = $"AWB {awbNo} is already assigned to open DRS {onOpenDrs.DRS.DRSNo}";
                    _scanSeverity = Severity.Warning;
                    _scanInput = string.Empty;
                    Logger.LogWarning("[OUTSCAN] AWB already in open DRS {DRSNo}", onOpenDrs.DRS.DRSNo);
                    return;
                }

                var lastDetail = existingDrsDetails.First();
                var allowedForReoutscan = new[] { "Delivered", "Returned", "RTS" };
                if (!allowedForReoutscan.Contains(lastDetail.Status))
                {
                    _scanMessage = $"AWB {awbNo} was on DRS {lastDetail.DRS.DRSNo} with status '{lastDetail.Status}'. It must be returned (RTO) before re-outscan.";
                    _scanSeverity = Severity.Warning;
                    _scanInput = string.Empty;
                    Logger.LogWarning("[OUTSCAN] AWB needs RTO before re-outscan. Last status: {Status} on DRS {DRS}", lastDetail.Status, lastDetail.DRS.DRSNo);
                    return;
                }
            }
            
            Logger.LogInformation("[OUTSCAN] Step 5: Creating DRS detail");
            var nextSequence = _drsDetails.Count + 1;
            var codAmount = awb.PaymentModeId == PaymentMode.COD ? (awb.CODAmount ?? 0) : 0;
            var previousAttempts = existingDrsDetails.Count;
            
            var detail = new DRSDetail
            {
                DRSId = DrsId,
                InscanId = awb.Id,
                Sequence = nextSequence,
                AttemptNo = previousAttempts + 1,
                Status = "Pending",
                CODAmount = codAmount,
                CreatedAt = DateTime.UtcNow,
                IsActive = true
            };
            
            dbContext.Set<DRSDetail>().Add(detail);
            Logger.LogInformation("[OUTSCAN] DRS detail created");
            
            Logger.LogInformation("[OUTSCAN] Step 6: Updating AWB status");
            awb.CourierStatusId = CourierStatus.OutForDelivery;
            awb.ModifiedAt = DateTime.UtcNow;
            
            Logger.LogInformation("[OUTSCAN] Step 7: Creating AWB tracking entry");
            var tracking = new AWBTracking
            {
                InscanId = awb.Id,
                EventDateTime = DateTime.UtcNow,
                StatusId = CourierStatus.OutForDelivery,
                Remarks = $"Out for delivery - Added to DRS {_drs!.DRSNo}",
                CreatedAt = DateTime.UtcNow,
                IsPublic = true,
                IsDeleted = false
            };
            dbContext.AWBTrackings.Add(tracking);
            
            Logger.LogInformation("[OUTSCAN] Step 8: Saving changes to database");
            try
            {
                await dbContext.SaveChangesAsync();
                Logger.LogInformation("[OUTSCAN] Database save successful");
            }
            catch (Exception dbEx)
            {
                var innerMessage = dbEx.InnerException?.Message ?? "No inner exception";
                Logger.LogError(dbEx, "[OUTSCAN] Database save FAILED. Inner: {Inner}", innerMessage);
                throw new Exception($"Database save failed: {innerMessage}", dbEx);
            }
            
            Logger.LogInformation("[OUTSCAN] Step 9: Calling ShipmentStatusService.SetStatus");
            await ShipmentStatusService.SetStatus(
                awb.Id, "OUT_FOR_DELIVERY", "Outscan", _drs!.Id, "DRS",
                null, awb.ConsigneeCity, null, null,
                $"Assigned to DRS {_drs.DRSNo} - {_drs.DeliveryEmployeeName}", isAutomatic: true);
            Logger.LogInformation("[OUTSCAN] ShipmentStatusService.SetStatus completed");
        
            _scanMessage = $"AWB {awbNo} added successfully";
            _scanSeverity = Severity.Success;
            _scanInput = string.Empty;
            
            Logger.LogInformation("[OUTSCAN] Step 10: Reloading data");
            await LoadData();
            Logger.LogInformation("[OUTSCAN] ProcessScan completed successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[OUTSCAN] ERROR: {Message}. StackTrace: {StackTrace}", ex.Message, ex.StackTrace);
            _scanMessage = $"Error adding AWB: {ex.Message}";
            _scanSeverity = Severity.Error;
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveFromDRS(DRSDetail detail)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        dbContext.Set<DRSDetail>().Remove(detail);
        
        if (detail.Inscan != null)
        {
            detail.Inscan.CourierStatusId = CourierStatus.InTransit;
            detail.Inscan.ModifiedAt = DateTime.UtcNow;
            
            var tracking = new AWBTracking
            {
                InscanId = detail.InscanId,
                EventDateTime = DateTime.UtcNow,
                StatusId = CourierStatus.InTransit,
                Remarks = $"Removed from DRS {_drs!.DRSNo}",
                CreatedAt = DateTime.UtcNow,
                IsPublic = true,
                IsDeleted = false
            };
            dbContext.AWBTrackings.Add(tracking);
        }
        
        await dbContext.SaveChangesAsync();
        Snackbar.Add("AWB removed from DRS", Severity.Info);
        await LoadData();
    }

    private async Task UpdateDRSCounts()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (_drs == null) return;
        
        _drs.TotalAWBs = _drsDetails.Count;
        _drs.DeliveredCount = _drsDetails.Count(d => d.Status == "Delivered");
        _drs.PendingCount = _drsDetails.Count(d => d.Status == "Pending");
        _drs.ReturnedCount = _drsDetails.Count(d => d.Status == "Returned");
        _drs.TotalCOD = _drsDetails.Sum(d =>
        {
            if (d.Inscan?.MovementTypeId == MovementType.InternationalImport)
                return GetImportTotalCharges(d.Inscan);
            return d.CODAmount ?? 0;
        });
        _drs.CollectedCOD = _drsDetails.Where(d => d.Status == "Delivered").Sum(d => d.CollectedAmount ?? 0);
        
        await dbContext.SaveChangesAsync();
    }

    private async Task ProcessImportShipmentOutscan(ImportShipment importShipment, string awbNo)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        try
        {
            var existingInDrs = _drsDetails.Any(d => d.Inscan?.AWBNo == awbNo);
            if (existingInDrs)
            {
                _scanMessage = $"AWB {awbNo} is already in this DRS";
                _scanSeverity = Severity.Warning;
                _scanInput = string.Empty;
                return;
            }

            var allowedImportStatuses = new[] { 
                ImportShipmentStatus.Inscanned, 
                ImportShipmentStatus.ReceivedAtWarehouse, 
                ImportShipmentStatus.Cleared, 
                ImportShipmentStatus.Released 
            };
            if (!allowedImportStatuses.Contains(importShipment.Status))
            {
                _scanMessage = $"Import AWB {awbNo} is not available for outscan. Current status: {importShipment.Status}";
                _scanSeverity = Severity.Warning;
                _scanInput = string.Empty;
                return;
            }

            InscanMaster linkedAwb;
            if (importShipment.LinkedInscanMasterId.HasValue)
            {
                linkedAwb = await dbContext.InscanMasters.FindAsync(importShipment.LinkedInscanMasterId.Value);
                if (linkedAwb == null)
                {
                    linkedAwb = CreateInscanMasterFromImport(importShipment);
                    dbContext.InscanMasters.Add(linkedAwb);
                    await dbContext.SaveChangesAsync();
                    importShipment.LinkedInscanMasterId = linkedAwb.Id;
                }
            }
            else
            {
                linkedAwb = CreateInscanMasterFromImport(importShipment);
                dbContext.InscanMasters.Add(linkedAwb);
                await dbContext.SaveChangesAsync();
                importShipment.LinkedInscanMasterId = linkedAwb.Id;
            }

            var existingImportDrsDetails = await dbContext.Set<DRSDetail>()
                .Include(d => d.DRS)
                .Where(d => d.InscanId == linkedAwb.Id)
                .OrderByDescending(d => d.Id)
                .ToListAsync();

            if (existingImportDrsDetails.Any())
            {
                var onOpenDrs = existingImportDrsDetails.FirstOrDefault(d => d.DRS.Status != DRSStatus.Closed);
                if (onOpenDrs != null)
                {
                    _scanMessage = $"Import AWB {awbNo} is already assigned to open DRS {onOpenDrs.DRS.DRSNo}";
                    _scanSeverity = Severity.Warning;
                    _scanInput = string.Empty;
                    return;
                }

                var lastDetail = existingImportDrsDetails.First();
                var allowedForReoutscan = new[] { "Delivered", "Returned", "RTS" };
                if (!allowedForReoutscan.Contains(lastDetail.Status))
                {
                    _scanMessage = $"Import AWB {awbNo} was on DRS {lastDetail.DRS.DRSNo} with status '{lastDetail.Status}'. It must be returned (RTO) before re-outscan.";
                    _scanSeverity = Severity.Warning;
                    _scanInput = string.Empty;
                    return;
                }
            }

            var nextSequence = _drsDetails.Count + 1;
            var codAmount = (importShipment.DutyAmount ?? 0) + (importShipment.VATAmount ?? 0) + (importShipment.OtherCharges ?? 0) + (importShipment.CODAmount ?? 0);
            if (codAmount == 0 && importShipment.IsCOD)
                codAmount = importShipment.CODAmount ?? 0;
            var previousImportAttempts = existingImportDrsDetails.Count;

            var detail = new DRSDetail
            {
                DRSId = DrsId,
                InscanId = linkedAwb.Id,
                Sequence = nextSequence,
                AttemptNo = previousImportAttempts + 1,
                Status = "Pending",
                CODAmount = codAmount,
                CreatedAt = DateTime.UtcNow,
                IsActive = true
            };
            dbContext.Set<DRSDetail>().Add(detail);

            linkedAwb.CourierStatusId = CourierStatus.OutForDelivery;
            linkedAwb.ModifiedAt = DateTime.UtcNow;

            importShipment.Status = ImportShipmentStatus.HandedOver;
            importShipment.HandedOverAt = DateTime.UtcNow;
            importShipment.ModifiedAt = DateTime.UtcNow;

            var tracking = new AWBTracking
            {
                InscanId = linkedAwb.Id,
                EventDateTime = DateTime.UtcNow,
                StatusId = CourierStatus.OutForDelivery,
                Remarks = $"Import shipment out for delivery - Added to DRS {_drs!.DRSNo}",
                CreatedAt = DateTime.UtcNow,
                IsPublic = true,
                IsDeleted = false
            };
            dbContext.AWBTrackings.Add(tracking);

            await dbContext.SaveChangesAsync();

            await ShipmentStatusService.SetStatus(
                linkedAwb.Id, "OUT_FOR_DELIVERY", "Outscan", _drs!.Id, "DRS",
                null, importShipment.ConsigneeCity, null, null,
                $"Import shipment assigned to DRS {_drs.DRSNo} - {_drs.DeliveryEmployeeName}", isAutomatic: true);

            _scanMessage = $"Import AWB {awbNo} added successfully";
            _scanSeverity = Severity.Success;
            _scanInput = string.Empty;

            await LoadData();
            Logger.LogInformation("[OUTSCAN] Import shipment outscan completed successfully");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "[OUTSCAN] ERROR processing import shipment: {Message}", ex.Message);
            _scanMessage = $"Error adding import AWB: {ex.Message}";
            _scanSeverity = Severity.Error;
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private InscanMaster CreateInscanMasterFromImport(ImportShipment importShipment)
    {
        return new InscanMaster
        {
            AWBNo = importShipment.AWBNo,
            TransactionDate = DateTime.UtcNow,
            Consignor = importShipment.ShipperName,
            ConsignorPhone = importShipment.ShipperPhone,
            ConsignorAddress1 = importShipment.ShipperAddress,
            ConsignorCity = importShipment.ShipperCity,
            ConsignorCountry = importShipment.ShipperCountry,
            Consignee = importShipment.ConsigneeName,
            ConsigneePhone = importShipment.ConsigneePhone,
            ConsigneeMobile = importShipment.ConsigneeMobile,
            ConsigneeAddress1 = importShipment.ConsigneeAddress,
            ConsigneeCity = importShipment.ConsigneeCity,
            ConsigneeState = importShipment.ConsigneeState,
            ConsigneeCountry = importShipment.ConsigneeCountry,
            ConsigneePostalCode = importShipment.ConsigneePostalCode,
            Pieces = importShipment.Pieces,
            Weight = importShipment.Weight,
            VolumetricWeight = importShipment.VolumetricWeight,
            ChargeableWeight = importShipment.ChargeableWeight,
            CargoDescription = importShipment.ContentsDescription,
            SpecialInstructions = importShipment.SpecialInstructions,
            CourierStatusId = CourierStatus.InscanAtOrigin,
            PaymentModeId = importShipment.IsCOD ? PaymentMode.COD : PaymentMode.Prepaid,
            MovementTypeId = MovementType.InternationalImport,
            IsCOD = importShipment.IsCOD,
            CODAmount = importShipment.CODAmount,
            CustomsValue = importShipment.DeclaredValue,
            Currency = importShipment.Currency,
            DutyVatAmount = (importShipment.DutyAmount ?? 0) + (importShipment.VATAmount ?? 0),
            ReferenceNo = importShipment.ReferenceNo,
            Remarks = $"Auto-created from import shipment #{importShipment.Id}",
            IsAutoGenerated = true,
            CreatedAt = DateTime.UtcNow,
            IsActive = true
        };
    }

    private async Task OpenStatusDialog(DRSDetail detail)
    {
        if (detail.Inscan == null) return;
        
        var parameters = new DialogParameters<UpdateStatusDialog> { { x => x.Shipment, detail.Inscan } };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Status", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var updatedInscan = await dbContext.InscanMasters.FindAsync(detail.InscanId);
            if (updatedInscan != null)
            {
                var latestStatus = await dbContext.ShipmentStatusHistories
                    .Include(h => h.Status)
                    .Where(h => h.InscanMasterId == detail.InscanId)
                    .OrderByDescending(h => h.ChangedAt)
                    .ThenByDescending(h => h.Id)
                    .FirstOrDefaultAsync();

                if (latestStatus?.Status != null)
                {
                    var returnCodes = new[] { "RETURN_TO_ORIGIN", "RETURN_INSCAN", "RETURN_COMPLETED" };
                    if (returnCodes.Contains(latestStatus.Status.Code))
                    {
                        var drsDetail = await dbContext.Set<DRSDetail>().FindAsync(detail.Id);
                        if (drsDetail != null)
                        {
                            drsDetail.Status = "Returned";
                            await dbContext.SaveChangesAsync();
                        }
                    }
                }
            }

            await LoadData();
            await UpdateDRSCounts();
        }
    }

    private decimal GetImportTotalCharges(InscanMaster? inscan)
    {
        if (inscan == null) return 0;
        if (inscan.NetTotal.HasValue && inscan.NetTotal.Value > 0)
            return inscan.NetTotal.Value;
        var baseCharges = ((inscan.CourierCharge ?? 0) + (inscan.OtherCharge ?? 0) + (inscan.FuelSurcharge ?? 0))
            * (1 + (inscan.TaxPercent ?? 0) / 100) - (inscan.Discount ?? 0)
            + (inscan.DutyVatAmount ?? 0) + (inscan.CODAmount ?? 0);
        var importVat = inscan.TaxAmount ?? 0;
        if (importVat == 0 && (inscan.CustomsValue ?? 0) > 0)
            importVat = (inscan.CustomsValue ?? 0) * _branchVatPercent / 100;
        return baseCharges + importVat;
    }
}

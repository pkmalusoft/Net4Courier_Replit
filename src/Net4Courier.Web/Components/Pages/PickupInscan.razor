@page "/pickup-inscan"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject Net4Courier.Web.Services.ShipmentStatusService ShipmentStatusService
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>INSCAN - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">INSCAN - Warehouse Receiving</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
    Receive collected shipments into the warehouse.
</MudText>

<MudPaper Class="pa-3 mb-4" Elevation="1">
    <MudRadioGroup T="InscanMode" @bind-Value="_scanMode">
        <MudRadio Value="InscanMode.AWB" Color="Color.Primary" Dense="true">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" />
                <MudText>AWB</MudText>
            </MudStack>
        </MudRadio>
        <MudRadio Value="InscanMode.PickupRequest" Color="Color.Primary" Dense="true">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" />
                <MudText>Pickup Request</MudText>
            </MudStack>
        </MudRadio>
    </MudRadioGroup>
</MudPaper>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">
                @(_scanMode == InscanMode.PickupRequest ? "Scan or Enter Pickup No" : "Scan or Enter AWB No")
            </MudText>
            <MudTextField @ref="_scanField" @bind-Value="_scanInput" 
                          Label="@(_scanMode == InscanMode.PickupRequest ? "Pickup No / Barcode" : "AWB No / Barcode")" 
                          Variant="Variant.Outlined" 
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                          OnKeyUp="OnScanKeyUp" FullWidth="true" AutoFocus="true"
                          Placeholder="@(_scanMode == InscanMode.PickupRequest ? "Scan barcode or type pickup number..." : "Scan barcode or type AWB number...")" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ProcessScan" FullWidth="true" Class="mt-3"
                       StartIcon="@Icons.Material.Filled.Warehouse" Size="Size.Large" Disabled="@_processing">
                @if (_processing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <text>Processing...</text>
                }
                else
                {
                    <text>RECEIVE INTO WAREHOUSE</text>
                }
            </MudButton>
            
            @if (!string.IsNullOrEmpty(_lastMessage))
            {
                <MudAlert Severity="@_lastSeverity" Class="mt-3" Dense="true">@_lastMessage</MudAlert>
            }
        </MudPaper>

        @if (_scanMode == InscanMode.PickupRequest)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Pending for INSCAN</MudText>
                <MudList T="PickupRequest" Dense="true">
                    @foreach (var pickup in _pendingPickups)
                    {
                        <MudListItem OnClick="@(() => SelectPickup(pickup))">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1"><strong>@pickup.PickupNo</strong></MudText>
                                    <MudText Typo="Typo.caption">@pickup.CustomerName - @pickup.City</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Primary">
                                        @(pickup.Shipments?.Count ?? 0) shipment(s)
                                    </MudText>
                                </MudStack>
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Collected</MudChip>
                            </MudStack>
                        </MudListItem>
                    }
                    @if (!_pendingPickups.Any())
                    {
                        <MudListItem>
                            <MudText Color="Color.Secondary">No pending pickups for INSCAN</MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        }
        else
        {
            <MudPaper Class="pa-4 mt-4" Elevation="2">
                <MudText Typo="Typo.h6" GutterBottom="true">Pending AWBs for INSCAN</MudText>
                <MudList T="InscanMaster" Dense="true">
                    @foreach (var awb in _pendingAWBs)
                    {
                        <MudListItem OnClick="@(() => SelectAWB(awb))">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1"><strong>@awb.AWBNo</strong></MudText>
                                    <MudText Typo="Typo.caption">@awb.Consignor → @awb.Consignee</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Primary">
                                        @awb.ConsignorCity → @awb.ConsigneeCity
                                    </MudText>
                                </MudStack>
                                <MudChip T="string" Color="Color.Info" Size="Size.Small">@awb.CourierStatusId</MudChip>
                            </MudStack>
                        </MudListItem>
                    }
                    @if (!_pendingAWBs.Any())
                    {
                        <MudListItem>
                            <MudText Color="Color.Secondary">No pending AWBs for INSCAN</MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        }
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Recently Received Today</MudText>
            @if (_scanMode == InscanMode.PickupRequest)
            {
                <MudSimpleTable Hover="true" Dense="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Pickup No</th>
                            <th>Customer</th>
                            <th>Shipments</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pickup in _inscannedToday)
                        {
                            <tr>
                                <td>@pickup.PickupNo</td>
                                <td>@pickup.CustomerName</td>
                                <td>
                                    @{
                                        var shipmentCount = pickup.Shipments?.Count ?? 0;
                                        var pendingCount = pickup.Shipments?.Count(s => s.Status == ShipmentLineStatus.Pending) ?? 0;
                                    }
                                    <MudChip T="string" Color="@(pendingCount > 0 ? Color.Warning : Color.Success)" Size="Size.Small">
                                        @pendingCount / @shipmentCount pending
                                    </MudChip>
                                </td>
                                <td>@pickup.InscannedAt?.ToString("HH:mm")</td>
                            </tr>
                        }
                        @if (!_inscannedToday.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center">No received pickups today</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudSimpleTable Hover="true" Dense="true" Striped="true">
                    <thead>
                        <tr>
                            <th>AWB No</th>
                            <th>Consignee</th>
                            <th>Destination</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var awb in _receivedAWBsToday)
                        {
                            <tr>
                                <td>
                                    @awb.AWBNo
                                    @if (awb.Source == "Import")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-1">Import</MudChip>
                                    }
                                </td>
                                <td>@awb.Consignee</td>
                                <td>@awb.Destination</td>
                                <td>@awb.ReceivedAt?.ToString("HH:mm")</td>
                            </tr>
                        }
                        @if (!_receivedAWBsToday.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center">No received AWBs today</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
        </MudPaper>

        <MudGrid Class="mt-4">
            <MudItem xs="6">
                <MudPaper Class="pa-4" Elevation="2" Style="background-color: #e8f5e9;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h3" Color="Color.Success">
                                @(_scanMode == InscanMode.PickupRequest ? _inscannedToday.Count : _receivedAWBsToday.Count)
                            </MudText>
                            <MudText Typo="Typo.body2">
                                @(_scanMode == InscanMode.PickupRequest ? "Pickups Received" : "AWBs Received")
                            </MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Warehouse" Size="Size.Large" Color="Color.Success" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="6">
                <MudPaper Class="pa-4" Elevation="2" Style="background-color: #fff3e0;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h3" Color="Color.Warning">
                                @(_scanMode == InscanMode.PickupRequest ? _pendingConversionCount : _pendingAWBs.Count)
                            </MudText>
                            <MudText Typo="Typo.body2">
                                @(_scanMode == InscanMode.PickupRequest ? "Pending Conversion" : "Pending INSCAN")
                            </MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Transform" Size="Size.Large" Color="Color.Warning" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery] public long? pickupId { get; set; }
    
    private InscanMode _scanMode = InscanMode.AWB;
    private string _scanInput = "";
    private string _lastMessage = "";
    private Severity _lastSeverity = Severity.Info;
    private List<PickupRequest> _pendingPickups = new();
    private List<PickupRequest> _inscannedToday = new();
    private List<InscanMaster> _pendingAWBs = new();
    private List<InscanMaster> _inscannedAWBsToday = new();
    private List<ReceivedAWBDisplay> _receivedAWBsToday = new();
    
    private record ReceivedAWBDisplay(string AWBNo, string Consignee, string Destination, DateTime? ReceivedAt, string Source);
    private MudTextField<string>? _scanField;
    private bool _processing;
    private int _pendingConversionCount;
    private string _currentUsername = "System";
    private string _currentBranchCity = "";

    private enum InscanMode
    {
        PickupRequest,
        AWB
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadData();
        
        if (pickupId.HasValue)
        {
            var pickup = _pendingPickups.FirstOrDefault(p => p.Id == pickupId.Value);
            if (pickup != null)
            {
                _scanInput = pickup.PickupNo;
            }
        }
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUsername = user.Identity.Name ?? "System";
            var branchIdClaim = user.FindFirst("BranchId")?.Value;
            if (long.TryParse(branchIdClaim, out var branchId))
            {
                await using var context = await DbFactory.CreateDbContextAsync();
                var branch = await context.Branches.Include(b => b.City).FirstOrDefaultAsync(b => b.Id == branchId);
                _currentBranchCity = branch?.City?.Name ?? "";
            }
        }
    }

    private async Task LoadData()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        var today = DateTime.UtcNow.Date;
        
        _pendingPickups = await context.PickupRequests
            .Include(p => p.Shipments)
            .Where(p => p.Status == PickupStatus.ShipmentCollected && !p.IsDeleted)
            .OrderByDescending(p => p.CollectedAt)
            .Take(50)
            .ToListAsync();
            
        _inscannedToday = await context.PickupRequests
            .Include(p => p.Shipments)
            .Where(p => p.Status == PickupStatus.Inscanned && !p.IsDeleted && p.InscannedAt >= today)
            .OrderByDescending(p => p.InscannedAt)
            .Take(50)
            .ToListAsync();
            
        _pendingConversionCount = await context.PickupRequests
            .Where(p => p.Status == PickupStatus.Inscanned && !p.IsDeleted && !p.IsConverted)
            .SelectMany(p => p.Shipments)
            .CountAsync(s => s.Status == ShipmentLineStatus.Pending);
            
        _pendingAWBs = await context.InscanMasters
            .Where(a => a.CourierStatusId == CourierStatus.PickedUp && !a.IsDeleted)
            .OrderByDescending(a => a.TransactionDate)
            .Take(50)
            .ToListAsync();
            
        _inscannedAWBsToday = await context.InscanMasters
            .Where(a => a.CourierStatusId == CourierStatus.InscanAtOrigin && !a.IsDeleted && a.ModifiedAt >= today)
            .OrderByDescending(a => a.ModifiedAt)
            .Take(50)
            .ToListAsync();
        
        var importShipmentsToday = await context.ImportShipments
            .Where(s => s.Status == ImportShipmentStatus.ReceivedAtWarehouse && !s.IsDeleted && s.ModifiedAt >= today)
            .OrderByDescending(s => s.ModifiedAt)
            .Take(50)
            .ToListAsync();
        
        _receivedAWBsToday = _inscannedAWBsToday
            .Select(a => new ReceivedAWBDisplay(a.AWBNo, a.Consignee ?? "", a.ConsigneeCity ?? "", a.ModifiedAt, "Domestic"))
            .Concat(importShipmentsToday.Select(s => new ReceivedAWBDisplay(s.AWBNo ?? "", s.ConsigneeName ?? "", s.ConsigneeCity ?? "", s.ModifiedAt, "Import")))
            .OrderByDescending(r => r.ReceivedAt)
            .Take(50)
            .ToList();
    }

    private async Task OnScanKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ProcessScan();
        }
    }

    private async Task ProcessScan()
    {
        if (string.IsNullOrWhiteSpace(_scanInput))
        {
            _lastMessage = _scanMode == InscanMode.PickupRequest 
                ? "Please enter or scan a pickup number" 
                : "Please enter or scan an AWB number";
            _lastSeverity = Severity.Warning;
            return;
        }

        _processing = true;
        StateHasChanged();

        try
        {
            if (_scanMode == InscanMode.PickupRequest)
            {
                await ProcessPickupScan();
            }
            else
            {
                await ProcessAWBScan();
            }
        }
        finally
        {
            _processing = false;
            _scanInput = "";
            StateHasChanged();
            
            if (_scanField != null)
            {
                await _scanField.FocusAsync();
            }
        }
    }

    private async Task ProcessPickupScan()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        
        var pickup = await context.PickupRequests
            .Include(p => p.Shipments)
            .FirstOrDefaultAsync(p => p.PickupNo == _scanInput.Trim() && !p.IsDeleted);

        if (pickup == null)
        {
            _lastMessage = $"Pickup {_scanInput} not found";
            _lastSeverity = Severity.Error;
            Snackbar.Add(_lastMessage, Severity.Error);
        }
        else if (pickup.Status == PickupStatus.Inscanned)
        {
            _lastMessage = $"Pickup {_scanInput} already inscanned";
            _lastSeverity = Severity.Warning;
            Snackbar.Add(_lastMessage, Severity.Warning);
        }
        else if (pickup.Status != PickupStatus.ShipmentCollected)
        {
            _lastMessage = $"Pickup {_scanInput} status is {pickup.Status}. Expected: Shipment Collected";
            _lastSeverity = Severity.Warning;
            Snackbar.Add(_lastMessage, Severity.Warning);
        }
        else
        {
            pickup.Status = PickupStatus.Inscanned;
            pickup.InscannedAt = DateTime.UtcNow;
            pickup.InscannedBy = _currentUsername;
            
            var awbCount = 0;
            var inscannedAwbIds = new List<long>();
            if (pickup.Shipments != null)
            {
                foreach (var shipment in pickup.Shipments)
                {
                    if (shipment.AWBId.HasValue)
                    {
                        var awb = await context.InscanMasters.FindAsync(shipment.AWBId.Value);
                        if (awb != null)
                        {
                            awb.CourierStatusId = CourierStatus.InscanAtOrigin;
                            awb.ModifiedAt = DateTime.UtcNow;
                            awb.ModifiedByName = _currentUsername;
                            inscannedAwbIds.Add(awb.Id);
                            awbCount++;
                        }
                    }
                }
            }
            
            await context.SaveChangesAsync();
            
            foreach (var awbId in inscannedAwbIds)
            {
                await ShipmentStatusService.SetStatus(
                    awbId, "INSCAN_ORIGIN", "PickupInscan", pickup.Id, "PickupRequest",
                    null, !string.IsNullOrEmpty(_currentBranchCity) ? _currentBranchCity : pickup.City, null, null,
                    $"AWB received into warehouse via Pickup {pickup.PickupNo}", isAutomatic: true);
            }
            
            var shipmentCount = pickup.Shipments?.Count ?? 0;
            _lastMessage = $"Pickup {_scanInput} received into warehouse! {shipmentCount} shipment(s), {awbCount} AWB(s) updated to InscanAtOrigin.";
            _lastSeverity = Severity.Success;
            Snackbar.Add(_lastMessage, Severity.Success);
            
            await LoadData();
        }
    }

    private async Task ProcessAWBScan()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        var awbNo = _scanInput.Trim();
        
        var awb = await context.InscanMasters
            .FirstOrDefaultAsync(a => a.AWBNo == awbNo && !a.IsDeleted);

        if (awb != null)
        {
            if (awb.CourierStatusId == CourierStatus.InscanAtOrigin)
            {
                _lastMessage = $"AWB {awbNo} already inscanned at origin";
                _lastSeverity = Severity.Warning;
                Snackbar.Add(_lastMessage, Severity.Warning);
            }
            else
            {
                awb.CourierStatusId = CourierStatus.InscanAtOrigin;
                awb.ModifiedAt = DateTime.UtcNow;
                awb.ModifiedByName = _currentUsername;
                
                await context.SaveChangesAsync();
                
                await ShipmentStatusService.SetStatus(
                    awb.Id, "INSCAN_ORIGIN", "PickupInscan", null, null,
                    null, !string.IsNullOrEmpty(_currentBranchCity) ? _currentBranchCity : awb.ConsignorCity, null, null,
                    $"AWB received into warehouse via direct scan", isAutomatic: true);
                
                _lastMessage = $"AWB {awbNo} received into warehouse! Status updated to InscanAtOrigin.";
                _lastSeverity = Severity.Success;
                Snackbar.Add(_lastMessage, Severity.Success);
                
                await LoadData();
            }
            return;
        }
        
        var importShipment = await context.ImportShipments
            .FirstOrDefaultAsync(s => s.AWBNo == awbNo && !s.IsDeleted);
        
        if (importShipment != null)
        {
            if (importShipment.Status == ImportShipmentStatus.ReceivedAtWarehouse)
            {
                _lastMessage = $"Import AWB {awbNo} already received at warehouse";
                _lastSeverity = Severity.Warning;
                Snackbar.Add(_lastMessage, Severity.Warning);
            }
            else
            {
                importShipment.Status = ImportShipmentStatus.ReceivedAtWarehouse;
                importShipment.ModifiedAt = DateTime.UtcNow;
                
                await context.SaveChangesAsync();
                
                _lastMessage = $"Import AWB {awbNo} received at warehouse! Status updated to Received at Origin Facility.";
                _lastSeverity = Severity.Success;
                Snackbar.Add(_lastMessage, Severity.Success);
                
                await LoadData();
            }
            return;
        }
        
        _lastMessage = $"AWB {awbNo} not found in system";
        _lastSeverity = Severity.Warning;
        Snackbar.Add(_lastMessage, Severity.Warning);
    }

    private void SelectPickup(PickupRequest pickup)
    {
        _scanInput = pickup.PickupNo;
    }

    private void SelectAWB(InscanMaster awb)
    {
        _scanInput = awb.AWBNo;
    }
}

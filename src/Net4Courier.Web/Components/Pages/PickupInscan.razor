@page "/pickup-inscan"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums

<PageTitle>INSCAN - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">INSCAN - Warehouse Receiving</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
    Receive collected shipments into the warehouse.
</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Scan or Enter Pickup No</MudText>
            <MudTextField @ref="_scanField" @bind-Value="_scanInput" Label="Pickup No / Barcode" Variant="Variant.Outlined" 
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                          OnKeyUp="OnScanKeyUp" FullWidth="true" AutoFocus="true"
                          Placeholder="Scan barcode or type pickup number..." />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ProcessScan" FullWidth="true" Class="mt-3"
                       StartIcon="@Icons.Material.Filled.Warehouse" Size="Size.Large" Disabled="@_processing">
                @if (_processing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <text>Processing...</text>
                }
                else
                {
                    <text>RECEIVE INTO WAREHOUSE</text>
                }
            </MudButton>
            
            @if (!string.IsNullOrEmpty(_lastMessage))
            {
                <MudAlert Severity="@_lastSeverity" Class="mt-3" Dense="true">@_lastMessage</MudAlert>
            }
        </MudPaper>

        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Pending for INSCAN</MudText>
            <MudList T="PickupRequest" Dense="true">
                @foreach (var pickup in _pendingPickups)
                {
                    <MudListItem OnClick="@(() => SelectPickup(pickup))">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body1"><strong>@pickup.PickupNo</strong></MudText>
                                <MudText Typo="Typo.caption">@pickup.CustomerName - @pickup.City</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Primary">
                                    @(pickup.Shipments?.Count ?? 0) shipment(s)
                                </MudText>
                            </MudStack>
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Collected</MudChip>
                        </MudStack>
                    </MudListItem>
                }
                @if (!_pendingPickups.Any())
                {
                    <MudListItem>
                        <MudText Color="Color.Secondary">No pending pickups for INSCAN</MudText>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" GutterBottom="true">Recently Received Today</MudText>
            <MudSimpleTable Hover="true" Dense="true" Striped="true">
                <thead>
                    <tr>
                        <th>Pickup No</th>
                        <th>Customer</th>
                        <th>Shipments</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pickup in _inscannedToday)
                    {
                        <tr>
                            <td>@pickup.PickupNo</td>
                            <td>@pickup.CustomerName</td>
                            <td>
                                @{
                                    var shipmentCount = pickup.Shipments?.Count ?? 0;
                                    var pendingCount = pickup.Shipments?.Count(s => s.Status == ShipmentLineStatus.Pending) ?? 0;
                                }
                                <MudChip T="string" Color="@(pendingCount > 0 ? Color.Warning : Color.Success)" Size="Size.Small">
                                    @pendingCount / @shipmentCount pending
                                </MudChip>
                            </td>
                            <td>@pickup.InscannedAt?.ToString("HH:mm")</td>
                        </tr>
                    }
                    @if (!_inscannedToday.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center">No received pickups today</td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        </MudPaper>

        <MudGrid Class="mt-4">
            <MudItem xs="6">
                <MudPaper Class="pa-4" Elevation="2" Style="background-color: #e8f5e9;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h3" Color="Color.Success">@_inscannedToday.Count</MudText>
                            <MudText Typo="Typo.body2">Pickups Received</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Warehouse" Size="Size.Large" Color="Color.Success" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="6">
                <MudPaper Class="pa-4" Elevation="2" Style="background-color: #fff3e0;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h3" Color="Color.Warning">@_pendingConversionCount</MudText>
                            <MudText Typo="Typo.body2">Pending Conversion</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Transform" Size="Size.Large" Color="Color.Warning" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery] public long? pickupId { get; set; }
    
    private string _scanInput = "";
    private string _lastMessage = "";
    private Severity _lastSeverity = Severity.Info;
    private List<PickupRequest> _pendingPickups = new();
    private List<PickupRequest> _inscannedToday = new();
    private MudTextField<string>? _scanField;
    private bool _processing;
    private int _pendingConversionCount;
    private string _currentUsername = "System";

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadData();
        
        if (pickupId.HasValue)
        {
            var pickup = _pendingPickups.FirstOrDefault(p => p.Id == pickupId.Value);
            if (pickup != null)
            {
                _scanInput = pickup.PickupNo;
            }
        }
    }

    private async Task LoadCurrentUser()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            _currentUsername = user.Identity.Name ?? "System";
        }
    }

    private async Task LoadData()
    {
        var today = DateTime.UtcNow.Date;
        
        _pendingPickups = await DbContext.PickupRequests
            .Include(p => p.Shipments)
            .Where(p => p.Status == PickupStatus.ShipmentCollected && !p.IsDeleted)
            .OrderByDescending(p => p.CollectedAt)
            .Take(50)
            .ToListAsync();
            
        _inscannedToday = await DbContext.PickupRequests
            .Include(p => p.Shipments)
            .Where(p => p.Status == PickupStatus.Inscanned && !p.IsDeleted && p.InscannedAt >= today)
            .OrderByDescending(p => p.InscannedAt)
            .Take(50)
            .ToListAsync();
            
        _pendingConversionCount = await DbContext.PickupRequests
            .Where(p => p.Status == PickupStatus.Inscanned && !p.IsDeleted && !p.IsConverted)
            .SelectMany(p => p.Shipments)
            .CountAsync(s => s.Status == ShipmentLineStatus.Pending);
    }

    private async Task OnScanKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ProcessScan();
        }
    }

    private async Task ProcessScan()
    {
        if (string.IsNullOrWhiteSpace(_scanInput))
        {
            _lastMessage = "Please enter or scan a pickup number";
            _lastSeverity = Severity.Warning;
            return;
        }

        _processing = true;
        StateHasChanged();

        try
        {
            var pickup = await DbContext.PickupRequests
                .Include(p => p.Shipments)
                .FirstOrDefaultAsync(p => p.PickupNo == _scanInput.Trim() && !p.IsDeleted);

            if (pickup == null)
            {
                _lastMessage = $"Pickup {_scanInput} not found";
                _lastSeverity = Severity.Error;
                Snackbar.Add(_lastMessage, Severity.Error);
            }
            else if (pickup.Status == PickupStatus.Inscanned)
            {
                _lastMessage = $"Pickup {_scanInput} already inscanned";
                _lastSeverity = Severity.Warning;
                Snackbar.Add(_lastMessage, Severity.Warning);
            }
            else if (pickup.Status != PickupStatus.ShipmentCollected)
            {
                _lastMessage = $"Pickup {_scanInput} status is {pickup.Status}. Expected: Shipment Collected";
                _lastSeverity = Severity.Warning;
                Snackbar.Add(_lastMessage, Severity.Warning);
            }
            else
            {
                pickup.Status = PickupStatus.Inscanned;
                pickup.InscannedAt = DateTime.UtcNow;
                pickup.InscannedBy = _currentUsername;
                
                await DbContext.SaveChangesAsync();
                
                var shipmentCount = pickup.Shipments?.Count ?? 0;
                _lastMessage = $"Pickup {_scanInput} received into warehouse! {shipmentCount} shipment(s) pending conversion.";
                _lastSeverity = Severity.Success;
                Snackbar.Add(_lastMessage, Severity.Success);
                
                await LoadData();
            }
        }
        finally
        {
            _processing = false;
            _scanInput = "";
            StateHasChanged();
            
            if (_scanField != null)
            {
                await _scanField.FocusAsync();
            }
        }
    }

    private void SelectPickup(PickupRequest pickup)
    {
        _scanInput = pickup.PickupNo;
    }
}

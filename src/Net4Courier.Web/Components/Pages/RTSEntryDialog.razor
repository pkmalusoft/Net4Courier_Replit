@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" Class="mr-2" />
            Create Return to Shipper (RTS)
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (!_originalShipmentSelected)
        {
            <MudText Class="mb-4">Search and select the original shipment to create an RTS:</MudText>
            
            <MudStack Row="true" Spacing="2" Class="mb-4">
                <MudTextField @bind-Value="_searchAWB" Label="Search AWB Number" Variant="Variant.Outlined" 
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" 
                              OnAdornmentClick="SearchOriginalShipment" OnKeyDown="OnSearchKeyDown" Style="flex-grow:1" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchOriginalShipment">Search</MudButton>
            </MudStack>
            
            @if (_searchResults.Any())
            {
                <MudTable Items="@_searchResults" Hover="true" Striped="true" Dense="true" FixedHeader="true" Height="300px">
                    <HeaderContent>
                        <MudTh>AWB No</MudTh>
                        <MudTh>Date</MudTh>
                        <MudTh>Consignor (Shipper)</MudTh>
                        <MudTh>Consignee (Receiver)</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Action</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.AWBNo</MudTd>
                        <MudTd>@context.TransactionDate.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd>@context.Consignor</MudTd>
                        <MudTd>@context.Consignee</MudTd>
                        <MudTd><MudChip T="string" Size="Size.Small">@context.CourierStatusId</MudChip></MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="@(() => SelectOriginalShipment(context))">
                                Select
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText>No shipments found matching your search.</MudText>
                    </NoRecordsContent>
                </MudTable>
            }
            else if (_searchPerformed)
            {
                <MudAlert Severity="Severity.Info">No shipments found. Please try a different AWB number.</MudAlert>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Creating RTS for AWB: <strong>@_originalShipment!.AWBNo</strong>
                <br/>Original route: @_originalShipment.Consignor → @_originalShipment.Consignee
                <br/>RTS route (swapped): @_originalShipment.Consignee → @_originalShipment.Consignor
            </MudAlert>
            
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">RTS Details</MudText>
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudSelect T="RTSChargeMode" @bind-Value="_rtsChargeMode" Label="Charge Mode" Variant="Variant.Outlined" Required="true">
                        <MudSelectItem T="RTSChargeMode" Value="@RTSChargeMode.Free">Free (No Charge)</MudSelectItem>
                        <MudSelectItem T="RTSChargeMode" Value="@RTSChargeMode.Chargeable">Chargeable</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_rtsReason" Label="RTS Reason" Variant="Variant.Outlined" Lines="1" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Shipment Details (Editable)</MudText>
                </MudItem>
                
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_pieces" Label="Pieces" Variant="Variant.Outlined" Min="1" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_weight" Label="Weight (kg)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect T="DocumentType" @bind-Value="_documentType" Label="Shipment Type" Variant="Variant.Outlined">
                        <MudSelectItem T="DocumentType" Value="@DocumentType.Letter">Letter</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.Document">Document</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelUpto30Kg">Parcel Upto 30kg</MudSelectItem>
                        <MudSelectItem T="DocumentType" Value="@DocumentType.ParcelAbove30Kg">Parcel Above 30kg</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_length" Label="Length (cm)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_width" Label="Width (cm)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_height" Label="Height (cm)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="_cargoDescription" Label="Cargo Description" Variant="Variant.Outlined" Lines="2" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="_specialInstructions" Label="Special Instructions" Variant="Variant.Outlined" Lines="2" />
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        @if (_originalShipmentSelected)
        {
            <MudButton OnClick="BackToSearch" Color="Color.Default">Back</MudButton>
        }
        <MudButton OnClick="Cancel">Cancel</MudButton>
        @if (_originalShipmentSelected)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateRTS" Disabled="@_saving">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Create RTS
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = null!;
    [Inject] private ShipmentStatusService ShipmentStatusService { get; set; } = null!;
    
    private string _searchAWB = "";
    private List<InscanMaster> _searchResults = new();
    private bool _searchPerformed = false;
    private bool _originalShipmentSelected = false;
    private InscanMaster? _originalShipment;
    private bool _saving = false;
    
    private RTSChargeMode _rtsChargeMode = RTSChargeMode.Free;
    private string _rtsReason = "";
    private int? _pieces = 1;
    private decimal? _weight;
    private DocumentType _documentType = DocumentType.Document;
    private decimal? _length;
    private decimal? _width;
    private decimal? _height;
    private string _cargoDescription = "";
    private string _specialInstructions = "";

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchOriginalShipment();
        }
    }

    private async Task SearchOriginalShipment()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (string.IsNullOrWhiteSpace(_searchAWB))
        {
            Snackbar.Add("Please enter an AWB number to search", Severity.Warning);
            return;
        }

        var allowedStatusIds = new long[] { 14, 16 };
        
        var eligibleShipmentIds = await dbContext.ShipmentStatusHistories
            .GroupBy(h => h.InscanMasterId)
            .Select(g => new { InscanMasterId = g.Key, LatestStatusId = g.OrderByDescending(h => h.ChangedAt).ThenByDescending(h => h.Id).First().StatusId })
            .Where(x => allowedStatusIds.Contains(x.LatestStatusId))
            .Select(x => x.InscanMasterId)
            .ToListAsync();
        
        _searchResults = await dbContext.InscanMasters
            .Where(i => !i.IsDeleted && !i.IsRTS && eligibleShipmentIds.Contains(i.Id) && i.AWBNo.Contains(_searchAWB))
            .OrderByDescending(i => i.TransactionDate)
            .Take(20)
            .ToListAsync();
        
        _searchPerformed = true;
    }

    private void SelectOriginalShipment(InscanMaster shipment)
    {
        _originalShipment = shipment;
        _originalShipmentSelected = true;
        
        _pieces = shipment.Pieces ?? 1;
        _weight = shipment.Weight;
        _documentType = shipment.DocumentTypeId;
        _length = shipment.Length;
        _width = shipment.Width;
        _height = shipment.Height;
        _cargoDescription = shipment.CargoDescription ?? "";
        _specialInstructions = shipment.SpecialInstructions ?? "";
    }

    private void BackToSearch()
    {
        _originalShipmentSelected = false;
        _originalShipment = null;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task CreateRTS()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (_originalShipment == null) return;
        
        var currentStatus = await dbContext.ShipmentStatusHistories
            .Where(h => h.InscanMasterId == _originalShipment.Id)
            .OrderByDescending(h => h.ChangedAt)
            .ThenByDescending(h => h.Id)
            .Select(h => h.StatusId)
            .FirstOrDefaultAsync();
        
        var allowedForRTS = new long[] { 14, 16 };
        if (!allowedForRTS.Contains(currentStatus))
        {
            Snackbar.Add("RTS can only be created for shipments with status Out for Delivery (14) or Delivered (16)", Severity.Warning);
            return;
        }
        
        if (_originalShipment.IsRTS || _originalShipment.OriginalShipmentId != null)
        {
            Snackbar.Add("Cannot create RTS from an RTS shipment", Severity.Warning);
            return;
        }
        
        var existingRTS = await dbContext.InscanMasters
            .AnyAsync(i => i.OriginalShipmentId == _originalShipment.Id && i.IsRTS && !i.IsDeleted);
        if (existingRTS)
        {
            Snackbar.Add("An RTS already exists for this shipment", Severity.Warning);
            return;
        }
        
        _saving = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "System";
            var userIdClaim = authState.User.FindFirst("UserId")?.Value;
            long? userId = userIdClaim != null ? long.Parse(userIdClaim) : null;
            
            var rtsAWBNo = _originalShipment.AWBNo;
            
            var rtsShipment = new InscanMaster
            {
                AWBNo = rtsAWBNo,
                TransactionDate = DateTime.UtcNow,
                FinancialYearId = _originalShipment.FinancialYearId,
                CompanyId = _originalShipment.CompanyId,
                BranchId = _originalShipment.BranchId,
                DepotId = _originalShipment.DepotId,
                CustomerId = _originalShipment.CustomerId,
                
                Consignor = _originalShipment.Consignee,
                ConsignorContact = _originalShipment.ConsigneeContact,
                ConsignorPhone = _originalShipment.ConsigneePhone,
                ConsignorMobile = _originalShipment.ConsigneeMobile,
                ConsignorAddress1 = _originalShipment.ConsigneeAddress1,
                ConsignorAddress2 = _originalShipment.ConsigneeAddress2,
                ConsignorCity = _originalShipment.ConsigneeCity,
                ConsignorState = _originalShipment.ConsigneeState,
                ConsignorCountry = _originalShipment.ConsigneeCountry,
                ConsignorPostalCode = _originalShipment.ConsigneePostalCode,
                ConsignorLocation = _originalShipment.ConsigneeLocation,
                
                Consignee = _originalShipment.Consignor,
                ConsigneeContact = _originalShipment.ConsignorContact,
                ConsigneePhone = _originalShipment.ConsignorPhone,
                ConsigneeMobile = _originalShipment.ConsignorMobile,
                ConsigneeAddress1 = _originalShipment.ConsignorAddress1,
                ConsigneeAddress2 = _originalShipment.ConsignorAddress2,
                ConsigneeCity = _originalShipment.ConsignorCity,
                ConsigneeState = _originalShipment.ConsignorState,
                ConsigneeCountry = _originalShipment.ConsignorCountry,
                ConsigneePostalCode = _originalShipment.ConsignorPostalCode,
                ConsigneeLocation = _originalShipment.ConsignorLocation,
                
                Pieces = _pieces,
                Weight = _weight,
                ChargeableWeight = _weight,
                Length = _length,
                Width = _width,
                Height = _height,
                
                CargoDescription = _cargoDescription,
                SpecialInstructions = _specialInstructions,
                
                CourierStatusId = CourierStatus.Pending,
                PaymentModeId = _rtsChargeMode == RTSChargeMode.Free ? PaymentMode.Account : _originalShipment.PaymentModeId,
                MovementTypeId = _originalShipment.MovementTypeId,
                DocumentTypeId = _documentType,
                ShipmentModeId = _originalShipment.ShipmentModeId,
                
                NetTotal = _rtsChargeMode == RTSChargeMode.Free ? 0 : null,
                
                IsRTS = true,
                OriginalShipmentId = _originalShipment.Id,
                RTSChargeMode = _rtsChargeMode,
                RTSCreatedAt = DateTime.UtcNow,
                RTSCreatedByUserId = userId,
                RTSCreatedByUserName = userName,
                RTSReason = _rtsReason,
                
                IsActive = true,
                CreatedAt = DateTime.UtcNow
            };
            
            if (_length.HasValue && _width.HasValue && _height.HasValue)
            {
                rtsShipment.VolumetricWeight = (_length.Value * _width.Value * _height.Value) / 5000;
                rtsShipment.ChargeableWeight = Math.Max(rtsShipment.Weight ?? 0, rtsShipment.VolumetricWeight ?? 0);
            }
            
            dbContext.InscanMasters.Add(rtsShipment);
            await dbContext.SaveChangesAsync();
            
            await ShipmentStatusService.SetStatus(
                rtsShipment.Id,
                "RTS_REQUESTED",
                "RTS_CREATED",
                eventRefId: _originalShipment.Id,
                eventRefType: "OriginalShipment",
                userId: userId,
                userName: userName,
                remarks: $"RTS created from original AWB {_originalShipment.AWBNo}. Reason: {_rtsReason}",
                isAutomatic: false
            );
            
            await ShipmentStatusService.SetStatus(
                _originalShipment.Id,
                "RTS_REQUESTED",
                "RTS_LINKED",
                eventRefId: rtsShipment.Id,
                eventRefType: "RTSShipment",
                userId: userId,
                userName: userName,
                remarks: $"RTS shipment created and linked",
                isAutomatic: true
            );
            
            MudDialog.Close(DialogResult.Ok(rtsShipment.Id));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating RTS: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}

@page "/bank-reconciliation"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">Bank Reconciliation</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenStartReconciliationDialog">
            Start New Reconciliation
        </MudButton>
    </MudStack>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect T="long?" @bind-Value="_filterBankAccountId" Label="Bank Account"
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    @foreach (var account in _bankAccounts)
                    {
                        <MudSelectItem Value="@((long?)account.Id)">@account.AccountNumber - @account.AccountName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect T="ReconciliationStatus?" @bind-Value="_filterStatus" Label="Status"
                           Variant="Variant.Outlined" Dense="true" Clearable="true">
                    <MudSelectItem Value="@((ReconciliationStatus?)ReconciliationStatus.Draft)">Draft</MudSelectItem>
                    <MudSelectItem Value="@((ReconciliationStatus?)ReconciliationStatus.InProgress)">In Progress</MudSelectItem>
                    <MudSelectItem Value="@((ReconciliationStatus?)ReconciliationStatus.Completed)">Completed</MudSelectItem>
                    <MudSelectItem Value="@((ReconciliationStatus?)ReconciliationStatus.Locked)">Locked</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_filterFromDate" Label="From Date"
                               Variant="Variant.Outlined" DateFormat="dd-MMM-yyyy" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_filterToDate" Label="To Date"
                               Variant="Variant.Outlined" DateFormat="dd-MMM-yyyy" />
            </MudItem>
            <MudItem xs="12" sm="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadReconciliations" FullWidth="true">
                    Apply Filters
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else
    {
        <MudTable Items="@_reconciliations" Hover="true" Dense="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh>Rec. No</MudTh>
                <MudTh>Bank Account</MudTh>
                <MudTh>Statement Date</MudTh>
                <MudTh Style="text-align:right">Statement Balance</MudTh>
                <MudTh Style="text-align:right">Book Balance</MudTh>
                <MudTh Style="text-align:right">Difference</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="width:100px">Progress</MudTh>
                <MudTh Style="width:120px">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ReconciliationNumber</MudTd>
                <MudTd>@context.BankAccount?.AccountName (@context.BankAccount?.BankName)</MudTd>
                <MudTd>@context.StatementDate.ToString("dd-MMM-yyyy")</MudTd>
                <MudTd Style="text-align:right">@context.StatementClosingBalance.ToString("N2")</MudTd>
                <MudTd Style="text-align:right">@context.BookClosingBalance.ToString("N2")</MudTd>
                <MudTd Style="text-align:right">
                    <MudText Color="@(context.DifferenceAmount == 0 ? Color.Success : Color.Error)">
                        @context.DifferenceAmount.ToString("N2")
                    </MudText>
                </MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status.ToString()
                    </MudChip>
                </MudTd>
                <MudTd>
                    @{
                        var (matched, total) = GetMatchProgress(context);
                        var progress = total > 0 ? (double)matched / total * 100 : 0;
                    }
                    <MudTooltip Text="@($"{matched}/{total} lines matched")">
                        <MudProgressLinear Value="@progress" Color="Color.Primary" Size="Size.Medium" Rounded="true" />
                    </MudTooltip>
                </MudTd>
                <MudTd>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Primary"
                                       OnClick="@(() => OpenWorkspace(context.Id))" Title="Open Workspace" />
                        @if (context.Status == ReconciliationStatus.Draft || context.Status == ReconciliationStatus.InProgress)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => DeleteReconciliation(context))" Title="Delete" />
                        }
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">No reconciliations found.</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudContainer>

@code {
    private bool _isLoading = false;
    private List<Net4Courier.Finance.Entities.BankReconciliation> _reconciliations = new();
    private List<BankAccount> _bankAccounts = new();
    
    private long? _filterBankAccountId;
    private ReconciliationStatus? _filterStatus;
    private DateTime? _filterFromDate;
    private DateTime? _filterToDate;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadBankAccounts();
            await LoadReconciliations();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading page: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadBankAccounts()
    {
        try
        {
            _bankAccounts = await DbContext.BankAccounts
                .Where(b => b.IsActive)
                .OrderBy(b => b.BankName)
                .ThenBy(b => b.AccountName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading bank accounts: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadReconciliations()
    {
        _isLoading = true;
        try
        {
            var query = DbContext.BankReconciliations
                .Include(r => r.BankAccount)
                .Include(r => r.StatementImports)
                    .ThenInclude(i => i.StatementLines)
                .AsQueryable();

            if (_filterBankAccountId.HasValue)
                query = query.Where(r => r.BankAccountId == _filterBankAccountId.Value);

            if (_filterStatus.HasValue)
                query = query.Where(r => r.Status == _filterStatus.Value);

            if (_filterFromDate.HasValue)
            {
                var fromDate = DateTime.SpecifyKind(_filterFromDate.Value.Date, DateTimeKind.Utc);
                query = query.Where(r => r.StatementDate >= fromDate);
            }

            if (_filterToDate.HasValue)
            {
                var toDate = DateTime.SpecifyKind(_filterToDate.Value.Date, DateTimeKind.Utc);
                query = query.Where(r => r.StatementDate <= toDate);
            }

            _reconciliations = await query
                .OrderByDescending(r => r.StatementDate)
                .ThenByDescending(r => r.Id)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reconciliations: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(ReconciliationStatus status) => status switch
    {
        ReconciliationStatus.Draft => Color.Default,
        ReconciliationStatus.InProgress => Color.Warning,
        ReconciliationStatus.Completed => Color.Success,
        ReconciliationStatus.Locked => Color.Info,
        _ => Color.Default
    };

    private (int matched, int total) GetMatchProgress(Net4Courier.Finance.Entities.BankReconciliation rec)
    {
        var lines = rec.StatementImports.SelectMany(i => i.StatementLines).ToList();
        return (lines.Count(l => l.IsMatched), lines.Count);
    }

    private async Task OpenStartReconciliationDialog()
    {
        var parameters = new DialogParameters<StartReconciliationDialog>();
        parameters.Add(x => x.BankAccounts, _bankAccounts);

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<StartReconciliationDialog>("Start New Reconciliation", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadReconciliations();
            if (result.Data is long recId)
            {
                OpenWorkspace(recId);
            }
        }
    }

    private void OpenWorkspace(long reconciliationId)
    {
        Navigation.NavigateTo($"/bank-reconciliation/{reconciliationId}");
    }

    private async Task DeleteReconciliation(Net4Courier.Finance.Entities.BankReconciliation rec)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Reconciliation",
            $"Are you sure you want to delete reconciliation {rec.ReconciliationNumber}?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            DbContext.BankReconciliations.Remove(rec);
            await DbContext.SaveChangesAsync();
            await LoadReconciliations();
            Snackbar.Add("Reconciliation deleted", Severity.Success);
        }
    }
}

@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using System.Security.Claims
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Update" Class="mr-2" />
            Update Import Status - @(ImportShipment?.AWBNo ?? "Unknown")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Current Status</MudText>
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@FormatStatus(ImportShipment?.Status ?? ImportShipmentStatus.Expected)</MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Changed By</MudText>
                    <MudText Typo="Typo.body2"><strong>@_currentUserName</strong></MudText>
                </MudItem>
            </MudGrid>

            <MudDivider />

            <MudSelect T="ImportShipmentStatus?" 
                       @bind-Value="_selectedStatus" 
                       Label="New Status *"
                       Variant="Variant.Outlined"
                       Required="true"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var status in _availableStatuses)
                {
                    <MudSelectItem Value="@((ImportShipmentStatus?)status)">
                        @FormatStatus(status)
                    </MudSelectItem>
                }
            </MudSelect>

            <MudTextField @bind-Value="_location"
                          Label="Location"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Dubai Hub, Warehouse A" />

            <MudTextField @bind-Value="_remarks"
                          Label="Reason for Status Change"
                          Variant="Variant.Outlined"
                          Lines="3"
                          Placeholder="Enter the reason for this status change..." />

            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                Status change will be recorded with your user details and timestamp for audit purposes.
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="UpdateStatus" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!CanSubmit || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update Status
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public ImportShipment? ImportShipment { get; set; }

    private List<ImportShipmentStatus> _availableStatuses = new();
    private ImportShipmentStatus? _selectedStatus;
    private string _location = "";
    private string _remarks = "";
    private bool _isSaving = false;
    private long? _currentUserId;
    private string _currentUserName = "Unknown User";

    private bool CanSubmit => _selectedStatus.HasValue && !string.IsNullOrWhiteSpace(_remarks);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        _availableStatuses = Enum.GetValues<ImportShipmentStatus>()
            .Where(s => s != ImportShipment?.Status)
            .OrderBy(s => (int)s)
            .ToList();
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;
                if (long.TryParse(userIdClaim, out var userId))
                {
                    _currentUserId = userId;
                }

                _currentUserName = user.FindFirst("FullName")?.Value 
                    ?? user.FindFirst(ClaimTypes.Name)?.Value 
                    ?? user.Identity.Name 
                    ?? "Unknown User";
            }
        }
        catch
        {
            _currentUserName = "System User";
        }
    }

    private async Task UpdateStatus()
    {
        if (!_selectedStatus.HasValue || string.IsNullOrWhiteSpace(_remarks) || ImportShipment == null) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var shipment = await dbContext.ImportShipments.FindAsync(ImportShipment.Id);

            if (shipment == null)
            {
                Snackbar.Add("Import shipment not found", Severity.Error);
                return;
            }

            var oldStatus = shipment.Status;
            shipment.Status = _selectedStatus.Value;
            shipment.ModifiedAt = DateTime.UtcNow;
            shipment.ModifiedBy = (int?)_currentUserId;

            switch (_selectedStatus.Value)
            {
                case ImportShipmentStatus.Inscanned:
                    shipment.InscannedAt ??= DateTime.UtcNow;
                    break;
                case ImportShipmentStatus.Cleared:
                    shipment.CustomsClearedAt ??= DateTime.UtcNow;
                    break;
                case ImportShipmentStatus.Released:
                    shipment.ReleasedAt ??= DateTime.UtcNow;
                    break;
                case ImportShipmentStatus.HandedOver:
                    shipment.HandedOverAt ??= DateTime.UtcNow;
                    break;
            }

            var note = new ImportShipmentNote
            {
                ImportShipmentId = shipment.Id,
                Category = NoteCategory.Operations,
                NoteText = $"Status changed from {FormatStatus(oldStatus)} to {FormatStatus(_selectedStatus.Value)}. Location: {(_location ?? "N/A")}. Reason: {_remarks.Trim()}",
                AddedByUserId = _currentUserId,
                AddedByUserName = _currentUserName,
                AddedAt = DateTime.UtcNow,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                CreatedBy = (int?)_currentUserId
            };

            dbContext.Set<ImportShipmentNote>().Add(note);
            await dbContext.SaveChangesAsync();

            Snackbar.Add($"Import status updated to: {FormatStatus(_selectedStatus.Value)}", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private string FormatStatus(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.Expected => "Expected",
        ImportShipmentStatus.Inscanned => "Inscanned",
        ImportShipmentStatus.ReceivedAtWarehouse => "Received at Warehouse",
        ImportShipmentStatus.PendingCustoms => "Pending Customs",
        ImportShipmentStatus.CustomsHold => "Customs Hold",
        ImportShipmentStatus.UnderExamination => "Under Examination",
        ImportShipmentStatus.AwaitingDocuments => "Awaiting Documents",
        ImportShipmentStatus.Cleared => "Cleared",
        ImportShipmentStatus.Released => "Released",
        ImportShipmentStatus.HandedOver => "Handed Over",
        ImportShipmentStatus.OnHold => "On Hold",
        _ => status.ToString()
    };

    private void Cancel() => MudDialog.Cancel();
}

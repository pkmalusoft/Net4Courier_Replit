@using MudBlazor
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Masters.Entities

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_formValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">AWB Information</MudText>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="Shipment.AWBNo" Label="AWB No *" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudSelect T="PaymentMode" Label="Payment Mode" @bind-Value="Shipment.PaymentMode" Variant="Variant.Outlined">
                        @foreach (PaymentMode mode in Enum.GetValues(typeof(PaymentMode)))
                        {
                            <MudSelectItem Value="mode">@mode.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="Shipment.ReferenceNo" Label="Reference No" Variant="Variant.Outlined" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Consignee (Receiver) Details</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="Shipment.ConsigneeName" Label="Consignee Name *" Variant="Variant.Outlined" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="Shipment.ConsigneePhone" Label="Consignee Phone" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Shipment.ConsigneeAddress" Label="Consignee Address" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="Shipment.ConsigneeCity" Label="City" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="Shipment.ConsigneeState" Label="State" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudAutocomplete T="Country" Label="Country *" Value="_consigneeCountry"
                                     SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                     Variant="Variant.Outlined" Required="true" ValueChanged="OnConsigneeCountryChanged" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="Shipment.ConsigneePostalCode" Label="Postal Code" Variant="Variant.Outlined" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Shipper Details</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="Shipment.ShipperName" Label="Shipper Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="Country" Label="Shipper Country" Value="_shipperCountry"
                                     SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                     Variant="Variant.Outlined" ValueChanged="OnShipperCountryChanged" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Package Details</MudText>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudNumericField @bind-Value="Shipment.Pieces" Label="Pieces *" Variant="Variant.Outlined" Min="1" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudNumericField @bind-Value="Shipment.Weight" Label="Weight (Kg) *" Variant="Variant.Outlined" Min="0.01M" Step="0.01M" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudNumericField @bind-Value="Shipment.DeclaredValue" Label="Declared Value" Variant="Variant.Outlined" Min="0M" Step="0.01M" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="Shipment.Currency" Label="Currency" Variant="Variant.Outlined" Placeholder="USD" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="Shipment.ContentsDescription" Label="Contents Description" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="Shipment.HSCode" Label="HS Code" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Shipment.SpecialInstructions" Label="Special Instructions" Variant="Variant.Outlined" Lines="2" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!_formValid)">
            @(IsNew ? "Add Shipment" : "Update Shipment")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }
    
    [Parameter] public ImportShipment Shipment { get; set; } = new();
    [Parameter] public bool IsNew { get; set; } = true;
    [Parameter] public List<Country> Countries { get; set; } = new();
    
    private MudForm? _form;
    private bool _formValid = false;
    private Country? _consigneeCountry;
    private Country? _shipperCountry;
    
    protected override void OnInitialized()
    {
        // Set default values
        if (IsNew)
        {
            Shipment.Pieces = 1;
            Shipment.Weight = 0.5m;
            Shipment.Currency = "USD";
            Shipment.PaymentMode = PaymentMode.Prepaid;
        }
        else
        {
            // Find countries by name
            if (!string.IsNullOrEmpty(Shipment.ConsigneeCountry))
                _consigneeCountry = Countries.FirstOrDefault(c => c.Name == Shipment.ConsigneeCountry);
            if (!string.IsNullOrEmpty(Shipment.ShipperCountry))
                _shipperCountry = Countries.FirstOrDefault(c => c.Name == Shipment.ShipperCountry);
        }
    }
    
    private Task<IEnumerable<Country>> SearchCountries(string value)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(Countries.Take(20));
        
        return Task.FromResult(Countries.Where(c => c.Name.Contains(value, StringComparison.OrdinalIgnoreCase)).Take(20));
    }
    
    private void OnConsigneeCountryChanged(Country? country)
    {
        _consigneeCountry = country;
        Shipment.ConsigneeCountry = country?.Name ?? string.Empty;
    }
    
    private void OnShipperCountryChanged(Country? country)
    {
        _shipperCountry = country;
        Shipment.ShipperCountry = country?.Name;
    }
    
    private void Cancel() => MudDialog?.Cancel();
    
    private void Submit() => MudDialog?.Close(DialogResult.Ok(Shipment));
}

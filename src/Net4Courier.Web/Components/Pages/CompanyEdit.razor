@page "/companies/new"
@page "/companies/{Id:long}"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>@(IsNew ? "New Company" : "Edit Company") - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">@(IsNew ? "New Company" : "Edit Company")</MudText>
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
    }
    else if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudForm @ref="_form" @bind-IsValid="_isValid">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Name" 
                                      Label="Company Name" 
                                      Required="true"
                                      RequiredError="Company name is required"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Code" 
                                      Label="Company Code" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Email" 
                                      Label="Email" 
                                      InputType="InputType.Email"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Phone" 
                                      Label="Phone" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_company.Address" 
                                      Label="Address" 
                                      Lines="3"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Location</MudText>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" Value="_company.CountryId" 
                                   ValueChanged="OnCountryChanged"
                                   Label="Country" 
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   Dense="true"
                                   MaxHeight="300"
                                   AnchorOrigin="Origin.BottomCenter"
                                   TransformOrigin="Origin.TopCenter"
                                   PopoverClass="mud-popover-fixed">
                            @foreach (var country in _countries)
                            {
                                <MudSelectItem T="long?" Value="@((long?)country.Id)">@country.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" Value="_company.StateId" 
                                   ValueChanged="OnStateChanged"
                                   Label="State" 
                                   Variant="Variant.Outlined"
                                   Disabled="@(!_company.CountryId.HasValue)"
                                   Clearable="true"
                                   Dense="true"
                                   MaxHeight="300"
                                   AnchorOrigin="Origin.BottomCenter"
                                   TransformOrigin="Origin.TopCenter"
                                   PopoverClass="mud-popover-fixed">
                            @foreach (var state in _states)
                            {
                                <MudSelectItem T="long?" Value="@((long?)state.Id)">@state.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" @bind-Value="_company.CityId" 
                                   Label="City" 
                                   Variant="Variant.Outlined"
                                   Disabled="@(!_company.StateId.HasValue)"
                                   Clearable="true"
                                   Dense="true"
                                   MaxHeight="300"
                                   AnchorOrigin="Origin.BottomCenter"
                                   TransformOrigin="Origin.TopCenter"
                                   PopoverClass="mud-popover-fixed">
                            @foreach (var city in _cities)
                            {
                                <MudSelectItem T="long?" Value="@((long?)city.Id)">@city.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_company.PostalCode" 
                                      Label="Postal Code" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Additional Information</MudText>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Website" 
                                      Label="Website" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.TaxNumber" 
                                      Label="Tax Number" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.RegistrationNumber" 
                                      Label="Registration Number" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="0" 
                                  Style="background-color: var(--mud-palette-background-grey);">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1"><strong>Active Status</strong></MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Enable or disable this company
                                    </MudText>
                                </MudStack>
                                <MudSwitch @bind-Value="_company.IsActive" 
                                          Color="Color.Primary"
                                          Label="@(_company.IsActive ? "Active" : "Inactive")" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" Class="mt-4">
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       OnClick="Save" 
                                       Disabled="@(!_isValid || _saving)">
                                @if (_saving)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Saving...</MudText>
                                }
                                else
                                {
                                    <MudText>Save Company</MudText>
                                }
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Default" 
                                       OnClick="Cancel"
                                       Disabled="@_saving">
                                Cancel
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public long? Id { get; set; }
    
    private bool IsNew => !Id.HasValue;
    
    private MudForm _form = null!;
    private bool _isValid;
    private bool _loading = true;
    private bool _saving;
    private string? _errorMessage;
    
    private Company _company = new() { IsActive = true };
    private List<Country> _countries = new();
    private List<State> _states = new();
    private List<City> _cities = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCountries();
        
        if (!IsNew)
        {
            await LoadCompany();
        }
        
        _loading = false;
    }

    private async Task LoadCompany()
    {
        _company = await DbContext.Companies
            .FirstOrDefaultAsync(c => c.Id == Id && !c.IsDeleted) ?? new();
            
        if (_company.Id == 0)
        {
            _errorMessage = "Company not found";
            return;
        }
        
        if (_company.CountryId.HasValue)
        {
            await LoadStates(_company.CountryId.Value);
        }
        
        if (_company.StateId.HasValue)
        {
            await LoadCities(_company.StateId.Value);
        }
    }

    private async Task LoadCountries()
    {
        _countries = await DbContext.Countries
            .Where(c => c.IsActive && !c.IsDeleted)
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private async Task LoadStates(long countryId)
    {
        _states = await DbContext.States
            .Where(s => s.CountryId == countryId && s.IsActive && !s.IsDeleted)
            .OrderBy(s => s.Name)
            .ToListAsync();
    }

    private async Task LoadCities(long stateId)
    {
        _cities = await DbContext.Cities
            .Where(c => c.StateId == stateId && c.IsActive && !c.IsDeleted)
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private Task<IEnumerable<long?>> SearchCountries(string value)
    {
        var results = _countries
            .Where(c => string.IsNullOrEmpty(value) || c.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(c => (long?)c.Id);
        return Task.FromResult(results);
    }

    private Task<IEnumerable<long?>> SearchStates(string value)
    {
        var results = _states
            .Where(s => string.IsNullOrEmpty(value) || s.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(s => (long?)s.Id);
        return Task.FromResult(results);
    }

    private Task<IEnumerable<long?>> SearchCities(string value)
    {
        var results = _cities
            .Where(c => string.IsNullOrEmpty(value) || c.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(c => (long?)c.Id);
        return Task.FromResult(results);
    }

    private async Task OnCountryChanged(long? countryId)
    {
        _company.CountryId = countryId;
        _company.StateId = null;
        _company.CityId = null;
        _states.Clear();
        _cities.Clear();
        
        if (countryId.HasValue)
        {
            await LoadStates(countryId.Value);
        }
    }

    private async Task OnStateChanged(long? stateId)
    {
        _company.StateId = stateId;
        _company.CityId = null;
        _cities.Clear();
        
        if (stateId.HasValue)
        {
            await LoadCities(stateId.Value);
        }
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_isValid) return;
        
        _saving = true;
        try
        {
            if (IsNew)
            {
                _company.CreatedAt = DateTime.UtcNow;
                DbContext.Companies.Add(_company);
            }
            else
            {
                _company.ModifiedAt = DateTime.UtcNow;
                DbContext.Companies.Update(_company);
            }
            
            await DbContext.SaveChangesAsync();
            Snackbar.Add(IsNew ? "Company created successfully" : "Company updated successfully", Severity.Success);
            Navigation.NavigateTo("/companies");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => Navigation.NavigateTo("/companies");
}

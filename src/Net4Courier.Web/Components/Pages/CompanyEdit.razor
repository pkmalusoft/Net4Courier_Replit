@page "/companies/new"
@page "/companies/{Id:long}"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IWebHostEnvironment Environment

<PageTitle>@(IsNew ? "New Company" : "Edit Company") - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">@(IsNew ? "New Company" : "Edit Company")</MudText>
    
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
    }
    else if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudForm @ref="_form" @bind-IsValid="_isValid">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Name" 
                                      Label="Company Name" 
                                      Required="true"
                                      RequiredError="Company name is required"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Code" 
                                      Label="Company Code" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Email" 
                                      Label="Email" 
                                      InputType="InputType.Email"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Phone" 
                                      Label="Phone" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_company.Address" 
                                      Label="Address" 
                                      Lines="3"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Location</MudText>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" Value="_company.CountryId" 
                                   ValueChanged="OnCountryChanged"
                                   Label="Country" 
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            @foreach (var country in _countries)
                            {
                                <MudSelectItem T="long?" Value="@((long?)country.Id)">@country.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" Value="_company.StateId" 
                                   ValueChanged="OnStateChanged"
                                   Label="State" 
                                   Variant="Variant.Outlined"
                                   Disabled="@(!_company.CountryId.HasValue)"
                                   Clearable="true">
                            @foreach (var state in _states)
                            {
                                <MudSelectItem T="long?" Value="@((long?)state.Id)">@state.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSelect T="long?" @bind-Value="_company.CityId" 
                                   Label="City" 
                                   Variant="Variant.Outlined"
                                   Disabled="@(!_company.StateId.HasValue)"
                                   Clearable="true">
                            @foreach (var city in _cities)
                            {
                                <MudSelectItem T="long?" Value="@((long?)city.Id)">@city.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_company.PostalCode" 
                                      Label="Postal Code" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Additional Information</MudText>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.Website" 
                                      Label="Website" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.TaxNumber" 
                                      Label="Tax Number" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_company.RegistrationNumber" 
                                      Label="Registration Number" 
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Company Logo</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudStack>
                            <MudFileUpload T="IBrowserFile" FilesChanged="OnLogoFileChanged" Accept=".png,.jpg,.jpeg,.gif,.svg">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               StartIcon="@Icons.Material.Filled.CloudUpload">
                                        Upload Logo
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Recommended: 200x60 pixels, PNG or SVG format
                            </MudText>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        @if (!string.IsNullOrEmpty(_company.Logo))
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudImage Src="@_company.Logo" Alt="Company Logo" Height="60" ObjectFit="ObjectFit.Contain" 
                                          Style="border: 1px solid #ddd; border-radius: 4px; padding: 4px;" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" 
                                               OnClick="RemoveLogo" Title="Remove Logo" />
                            </MudStack>
                        }
                        else
                        {
                            <MudPaper Class="pa-4 d-flex align-center justify-center" Style="height: 68px; border: 1px dashed #ccc;" Elevation="0">
                                <MudText Color="Color.Secondary">No logo uploaded</MudText>
                            </MudPaper>
                        }
                    </MudItem>

                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="0" 
                                  Style="background-color: var(--mud-palette-background-grey);">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1"><strong>Active Status</strong></MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Enable or disable this company
                                    </MudText>
                                </MudStack>
                                <MudSwitch @bind-Value="_company.IsActive" 
                                          Color="Color.Primary"
                                          Label="@(_company.IsActive ? "Active" : "Inactive")" />
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" Class="mt-4">
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       OnClick="Save" 
                                       Disabled="@(!_isValid || _saving)">
                                @if (_saving)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Saving...</MudText>
                                }
                                else
                                {
                                    <MudText>Save Company</MudText>
                                }
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Default" 
                                       OnClick="Cancel"
                                       Disabled="@_saving">
                                Cancel
                            </MudButton>
                            @if (!IsNew)
                            {
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Info" 
                                           Href="/branches"
                                           StartIcon="@Icons.Material.Filled.Business">
                                    Manage Branches
                                </MudButton>
                            }
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public long? Id { get; set; }
    
    private bool IsNew => !Id.HasValue;
    
    private MudForm _form = null!;
    private bool _isValid;
    private bool _loading = true;
    private bool _saving;
    private string? _errorMessage;
    
    private Company _company = new() { IsActive = true };
    private List<Country> _countries = new();
    private List<State> _states = new();
    private List<City> _cities = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCountries();
        
        if (!IsNew)
        {
            await LoadCompany();
        }
        
        _loading = false;
    }

    private async Task LoadCompany()
    {
        _company = await DbContext.Companies
            .FirstOrDefaultAsync(c => c.Id == Id && !c.IsDeleted) ?? new();
            
        if (_company.Id == 0)
        {
            _errorMessage = "Company not found";
            return;
        }
        
        if (_company.CountryId.HasValue)
        {
            await LoadStates(_company.CountryId.Value);
        }
        
        if (_company.StateId.HasValue)
        {
            await LoadCities(_company.StateId.Value);
        }
    }

    private async Task LoadCountries()
    {
        _countries = await DbContext.Countries
            .Where(c => c.IsActive && !c.IsDeleted)
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private async Task LoadStates(long countryId)
    {
        _states = await DbContext.States
            .Where(s => s.CountryId == countryId && s.IsActive && !s.IsDeleted)
            .OrderBy(s => s.Name)
            .ToListAsync();
    }

    private async Task LoadCities(long stateId)
    {
        _cities = await DbContext.Cities
            .Where(c => c.StateId == stateId && c.IsActive && !c.IsDeleted)
            .OrderBy(c => c.Name)
            .ToListAsync();
    }

    private Task<IEnumerable<long?>> SearchCountries(string value, CancellationToken cancellationToken)
    {
        var results = _countries
            .Where(c => string.IsNullOrEmpty(value) || c.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(c => (long?)c.Id);
        return Task.FromResult(results);
    }

    private Task<IEnumerable<long?>> SearchStates(string value, CancellationToken cancellationToken)
    {
        var results = _states
            .Where(s => string.IsNullOrEmpty(value) || s.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(s => (long?)s.Id);
        return Task.FromResult(results);
    }

    private Task<IEnumerable<long?>> SearchCities(string value, CancellationToken cancellationToken)
    {
        var results = _cities
            .Where(c => string.IsNullOrEmpty(value) || c.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(c => (long?)c.Id);
        return Task.FromResult(results);
    }

    private async Task OnCountryChanged(long? countryId)
    {
        _company.CountryId = countryId;
        _company.StateId = null;
        _company.CityId = null;
        _states.Clear();
        _cities.Clear();
        
        if (countryId.HasValue)
        {
            await LoadStates(countryId.Value);
        }
    }

    private async Task OnStateChanged(long? stateId)
    {
        _company.StateId = stateId;
        _company.CityId = null;
        _cities.Clear();
        
        if (stateId.HasValue)
        {
            await LoadCities(stateId.Value);
        }
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_isValid) return;
        
        _saving = true;
        try
        {
            if (IsNew)
            {
                _company.CreatedAt = DateTime.UtcNow;
                DbContext.Companies.Add(_company);
            }
            else
            {
                _company.ModifiedAt = DateTime.UtcNow;
                DbContext.Companies.Update(_company);
            }
            
            await DbContext.SaveChangesAsync();
            Snackbar.Add(IsNew ? "Company created successfully" : "Company updated successfully", Severity.Success);
            Navigation.NavigateTo("/companies");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => Navigation.NavigateTo("/companies");

    private async Task OnLogoFileChanged(IBrowserFile file)
    {
        try
        {
            if (file.Size > 2 * 1024 * 1024)
            {
                Snackbar.Add("Logo file size must be less than 2MB", Severity.Warning);
                return;
            }

            var allowedExtensions = new[] { ".png", ".jpg", ".jpeg", ".gif", ".svg" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add("Invalid file type. Please upload PNG, JPG, GIF, or SVG", Severity.Warning);
                return;
            }

            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads", "logos");
            Directory.CreateDirectory(uploadsFolder);

            var fileName = $"company_{(_company.Id > 0 ? _company.Id : DateTime.UtcNow.Ticks)}_{Guid.NewGuid():N}{extension}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            await using var stream = new FileStream(filePath, FileMode.Create);
            await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(stream);

            if (!string.IsNullOrEmpty(_company.Logo))
            {
                var oldPath = Path.Combine(Environment.WebRootPath, _company.Logo.TrimStart('/'));
                if (File.Exists(oldPath))
                    File.Delete(oldPath);
            }

            _company.Logo = $"/uploads/logos/{fileName}";
            Snackbar.Add("Logo uploaded successfully", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading logo: {ex.Message}", Severity.Error);
        }
    }

    private void RemoveLogo()
    {
        if (!string.IsNullOrEmpty(_company.Logo))
        {
            var filePath = Path.Combine(Environment.WebRootPath, _company.Logo.TrimStart('/'));
            if (File.Exists(filePath))
                File.Delete(filePath);
        }
        _company.Logo = null;
        StateHasChanged();
    }
}

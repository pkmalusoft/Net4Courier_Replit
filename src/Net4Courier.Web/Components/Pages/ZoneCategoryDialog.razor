@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(IsEdit ? "Edit Zone Category" : "New Zone Category")</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Model.Code" Label="Code" Required="true" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Model.Name" Label="Name" Required="true" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect T="MovementType" @bind-Value="Model.MovementType" Label="Movement Type" Required="true" Variant="Variant.Outlined">
                    <MudSelectItem Value="MovementType.Domestic">Domestic</MudSelectItem>
                    <MudSelectItem Value="MovementType.InternationalExport">International Export</MudSelectItem>
                    <MudSelectItem Value="MovementType.InternationalImport">International Import</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudAutocomplete T="Party" Label="Carrier (Forwarding Agent)" @bind-Value="SelectedCarrier"
                                 SearchFunc="SearchCarriers" ToStringFunc="@(p => p?.Name ?? "")"
                                 Variant="Variant.Outlined" Clearable="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField T="int" @bind-Value="Model.SortOrder" Label="Sort Order" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="Model.Description" Label="Description" Lines="2" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private MudDialogInstance? MudDialog { get; set; }

    [Parameter] 
    public ZoneCategory Model { get; set; } = new();

    [Parameter] 
    public bool IsEdit { get; set; }

    [Parameter]
    public Party? SelectedCarrier { get; set; }

    private void Cancel() => MudDialog?.Cancel();

    private void Submit()
    {
        if (string.IsNullOrWhiteSpace(Model.Code) || string.IsNullOrWhiteSpace(Model.Name))
        {
            return;
        }
        Model.ForwardingAgentId = SelectedCarrier?.Id;
        MudDialog?.Close(DialogResult.Ok(Model));
    }

    private async Task<IEnumerable<Party>> SearchCarriers(string value)
    {
        var query = DbContext.Parties
            .Where(p => !p.IsDeleted && p.PartyType == PartyType.ForwardingAgent);

        if (!string.IsNullOrWhiteSpace(value))
        {
            query = query.Where(p => p.Name.ToLower().Contains(value.ToLower()) ||
                                     p.Code.ToLower().Contains(value.ToLower()));
        }

        return await query.Take(20).ToListAsync();
    }
}

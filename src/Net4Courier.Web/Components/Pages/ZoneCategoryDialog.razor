@using Net4Courier.Masters.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(IsEdit ? "Edit Zone Category" : "New Zone Category")</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Model.Code" Label="Code" Required="true" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="Model.Name" Label="Name" Required="true" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect T="ZoneCategoryType" @bind-Value="Model.CategoryType" Label="Category Type" Required="true" Variant="Variant.Outlined">
                    <MudSelectItem Value="ZoneCategoryType.ForwardingAgent">Forwarding Agent</MudSelectItem>
                    <MudSelectItem Value="ZoneCategoryType.DeliveryAgent">Delivery Agent</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect T="MovementType" @bind-Value="Model.MovementType" Label="Movement Type" Required="true" Variant="Variant.Outlined">
                    @if (Model.CategoryType == ZoneCategoryType.DeliveryAgent)
                    {
                        <MudSelectItem Value="MovementType.Domestic">Domestic</MudSelectItem>
                    }
                    else
                    {
                        <MudSelectItem Value="MovementType.InternationalExport">International Export</MudSelectItem>
                        <MudSelectItem Value="MovementType.InternationalImport">International Import</MudSelectItem>
                        <MudSelectItem Value="MovementType.Transhipment">Transhipment</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                @if (Model.CategoryType == ZoneCategoryType.ForwardingAgent)
                {
                    <MudAutocomplete T="Party" Label="Forwarding Agent" @bind-Value="SelectedForwardingAgent"
                                     SearchFunc="SearchForwardingAgents" ToStringFunc="@(p => p?.Name ?? "")"
                                     Variant="Variant.Outlined" Clearable="true" />
                }
                else
                {
                    <MudAutocomplete T="Party" Label="Delivery Agent" @bind-Value="SelectedDeliveryAgent"
                                     SearchFunc="SearchDeliveryAgents" ToStringFunc="@(p => p?.Name ?? "")"
                                     Variant="Variant.Outlined" Clearable="true" />
                }
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField T="int" @bind-Value="Model.SortOrder" Label="Sort Order" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="Model.Description" Label="Description" Lines="2" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
        
        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
            @if (Model.CategoryType == ZoneCategoryType.DeliveryAgent)
            {
                <span><strong>Delivery Agent:</strong> Used for Domestic / Last-Mile shipments within your branch country.</span>
            }
            else
            {
                <span><strong>Forwarding Agent:</strong> Used for Export / Import / Transhipment shipments via international carriers.</span>
            }
        </MudAlert>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private MudDialogInstance? MudDialog { get; set; }

    [Parameter] 
    public ZoneCategory Model { get; set; } = new();

    [Parameter] 
    public bool IsEdit { get; set; }

    [Parameter]
    public Party? SelectedForwardingAgent { get; set; }

    [Parameter]
    public Party? SelectedDeliveryAgent { get; set; }

    private void Cancel() => MudDialog?.Cancel();

    private void Submit()
    {
        if (string.IsNullOrWhiteSpace(Model.Code) || string.IsNullOrWhiteSpace(Model.Name))
        {
            return;
        }
        
        if (Model.CategoryType == ZoneCategoryType.ForwardingAgent)
        {
            Model.ForwardingAgentId = SelectedForwardingAgent?.Id;
            Model.DeliveryAgentId = null;
        }
        else
        {
            Model.DeliveryAgentId = SelectedDeliveryAgent?.Id;
            Model.ForwardingAgentId = null;
        }
        
        MudDialog?.Close(DialogResult.Ok(Model));
    }

    private async Task<IEnumerable<Party>> SearchForwardingAgents(string value, CancellationToken cancellationToken)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var query = dbContext.Parties
            .Where(p => !p.IsDeleted && p.PartyType == PartyType.ForwardingAgent);

        if (!string.IsNullOrWhiteSpace(value))
        {
            query = query.Where(p => p.Name.ToLower().Contains(value.ToLower()) ||
                                     p.Code.ToLower().Contains(value.ToLower()));
        }

        return await query.Take(20).ToListAsync();
    }

    private async Task<IEnumerable<Party>> SearchDeliveryAgents(string value, CancellationToken cancellationToken)
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        var query = dbContext.Parties
            .Where(p => !p.IsDeleted && p.PartyType == PartyType.DeliveryAgent);

        if (!string.IsNullOrWhiteSpace(value))
        {
            query = query.Where(p => p.Name.ToLower().Contains(value.ToLower()) ||
                                     p.Code.ToLower().Contains(value.ToLower()));
        }

        return await query.Take(20).ToListAsync();
    }
}

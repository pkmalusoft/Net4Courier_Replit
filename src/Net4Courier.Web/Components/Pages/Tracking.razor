@page "/tracking"
@page "/tracking/{AWBNumber}"
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject ShipmentStatusService StatusService
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Track Shipment | Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-8">
    <MudText Typo="Typo.h4" Class="mb-6">Track Shipment</MudText>
    
    <MudPaper Elevation="1" Class="pa-4 mb-6">
        <MudGrid>
            <MudItem xs="12" sm="9" md="10">
                <MudTextField @bind-Value="_searchTerm" 
                              Label="Enter AWB Number" 
                              Placeholder="e.g., AWB-000001, AWB-000002"
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                              Immediate="true"
                              HelperText="Separate multiple AWB numbers with commas for bulk tracking"
                              OnKeyDown="@(async e => { if (e.Key == "Enter") await TrackShipments(); })" />
            </MudItem>
            <MudItem xs="12" sm="3" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           StartIcon="@Icons.Material.Filled.Search"
                           OnClick="TrackShipments" 
                           FullWidth="true"
                           Disabled="@_isLoading"
                           Style="height: 56px;">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                    }
                    else
                    {
                        <MudText>TRACK</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasSearched && !_isLoading)
    {
        @if (_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                The following AWB number(s) were not found: <strong>@string.Join(", ", _notFoundAwbs)</strong>
            </MudAlert>
        }

        @if (_shipmentResults.Any())
        {
            @if (_shipmentResults.Count > 1)
            {
                <MudText Typo="Typo.subtitle1" Class="mb-4">Found @_shipmentResults.Count shipment(s)</MudText>
            }
            
            @foreach (var result in _shipmentResults)
            {
                <MudGrid Class="mb-6">
                    <MudItem xs="12" md="8">
                        <MudPaper Elevation="1" Class="pa-5">
                            <div class="d-flex justify-space-between align-center mb-4">
                                <div>
                                    <MudText Typo="Typo.h5">@result.Shipment.AWBNo</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Booked on @result.Shipment.TransactionDate.ToString("dd MMM yyyy")</MudText>
                                </div>
                                <MudChip T="string" Color="@GetStatusColor(result.Shipment.CourierStatusId)" Variant="Variant.Filled" Size="Size.Medium">
                                    @GetStatusDisplayName(result.Shipment.CourierStatusId)
                                </MudChip>
                            </div>

                            <MudGrid Class="mb-4">
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">From</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Consignor ?? "N/A")</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorAddress1))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsignorAddress1</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorAddress2))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsignorAddress2</MudText>
                                    }
                                    <MudText Typo="Typo.body2">@GetOriginFull(result.Shipment)</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorPhone))
                                    {
                                        <MudText Typo="Typo.body2">Phone: @result.Shipment.ConsignorPhone</MudText>
                                    }
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">To</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Consignee ?? "N/A")</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeAddress1))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsigneeAddress1</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeAddress2))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsigneeAddress2</MudText>
                                    }
                                    <MudText Typo="Typo.body2">@GetDestinationFull(result.Shipment)</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneePhone))
                                    {
                                        <MudText Typo="Typo.body2">Phone: @result.Shipment.ConsigneePhone</MudText>
                                    }
                                </MudItem>
                            </MudGrid>

                            <MudDivider Class="my-4" />

                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Service</MudText>
                                    <MudText Typo="Typo.body1">@(result.ServiceTypeName ?? "Standard")</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Pieces</MudText>
                                    <MudText Typo="Typo.body1">@(result.Shipment.Pieces ?? 1)</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Weight</MudText>
                                    <MudText Typo="Typo.body1">@((result.Shipment.ChargeableWeight ?? result.Shipment.Weight ?? 0).ToString("0.00")) kg</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Payment</MudText>
                                    <MudText Typo="Typo.body1">@(result.Shipment.PaymentModeId.ToString())</MudText>
                                </MudItem>
                            </MudGrid>

                            @if (result.Shipment.CourierStatusId == CourierStatus.Delivered && result.Shipment.DeliveredDate.HasValue)
                            {
                                <MudAlert Severity="Severity.Success" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.CheckCircle">
                                    Delivered on: @result.Shipment.DeliveredDate.Value.ToString("dd MMM yyyy")
                                </MudAlert>
                            }
                            else if (result.Shipment.CourierStatusId == CourierStatus.OutForDelivery)
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.LocalShipping">
                                    Out for Delivery Today
                                </MudAlert>
                            }
                        </MudPaper>

                        <MudPaper Elevation="1" Class="pa-5 mt-4">
                            <MudText Typo="Typo.h6" Class="mb-4">Tracking History</MudText>
                            
                            @if (result.Timeline.Any())
                            {
                                <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineAlign="TimelineAlign.Default">
                                    @foreach (var eventItem in result.Timeline.OrderByDescending(t => t.ChangedAt))
                                    {
                                        <MudTimelineItem Color="@GetEventColor(eventItem)" Size="Size.Medium" Variant="Variant.Filled">
                                            <ItemContent>
                                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                                                    @(eventItem.Status?.Name ?? eventItem.EventType)@(!string.IsNullOrEmpty(eventItem.Remarks) ? $": {eventItem.Remarks}" : "")
                                                </MudText>
                                                @if (!string.IsNullOrEmpty(eventItem.LocationName))
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@eventItem.LocationName</MudText>
                                                }
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @eventItem.ChangedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                                                    @if (!string.IsNullOrEmpty(eventItem.UserName))
                                                    {
                                                        <span> - By @eventItem.UserName</span>
                                                    }
                                                </MudText>
                                            </ItemContent>
                                        </MudTimelineItem>
                                    }
                                </MudTimeline>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center pa-4">
                                    No tracking events recorded yet.
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12" md="4">
                        @if (result.Shipment.PaymentModeId == PaymentMode.COD && result.Shipment.CODAmount > 0)
                        {
                            <MudPaper Elevation="1" Class="pa-5 mb-4">
                                <MudText Typo="Typo.h6" Class="mb-4">COD Details</MudText>
                                
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>COD Amount</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Currency ?? "AED") @result.Shipment.CODAmount?.ToString("N2")</MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText>Status</MudText>
                                    <MudChip T="string" Color="@GetCODStatusColor(result.Shipment)" Size="Size.Small" Variant="Variant.Filled">
                                        @GetCODStatusText(result.Shipment)
                                    </MudChip>
                                </div>
                            </MudPaper>
                        }

                        <MudPaper Elevation="1" Class="pa-5">
                            <MudText Typo="Typo.h6" Class="mb-4">Charges</MudText>
                            
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText>Courier Charges</MudText>
                                <MudText>@(result.Shipment.Currency ?? "AED") @(result.Shipment.CourierCharge?.ToString("N2") ?? "0.00")</MudText>
                            </div>
                            
                            @if (result.Shipment.FuelSurcharge > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>Fuel Surcharge</MudText>
                                    <MudText>@(result.Shipment.Currency ?? "AED") @result.Shipment.FuelSurcharge?.ToString("N2")</MudText>
                                </div>
                            }
                            
                            @if (result.Shipment.OtherCharge > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>Other Charges</MudText>
                                    <MudText>@(result.Shipment.Currency ?? "AED") @result.Shipment.OtherCharge?.ToString("N2")</MudText>
                                </div>
                            }
                            
                            @if (result.Shipment.Discount > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Color="Color.Success">Discount</MudText>
                                    <MudText Color="Color.Success">-@(result.Shipment.Currency ?? "AED") @result.Shipment.Discount?.ToString("N2")</MudText>
                                </div>
                            }
                            
                            <MudDivider Class="my-3" />
                            
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Total</MudText>
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;" Color="Color.Primary">
                                    @(result.Shipment.Currency ?? "AED") @(result.Shipment.NetTotal?.ToString("N2") ?? "0.00")
                                </MudText>
                            </div>
                        </MudPaper>

                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => OpenUpdateStatusDialog(result.Shipment))"
                                   FullWidth="true"
                                   Class="mt-4">
                            Update Status
                        </MudButton>
                    </MudItem>
                </MudGrid>
                
                @if (_shipmentResults.Count > 1 && result != _shipmentResults.Last())
                {
                    <MudDivider Class="my-6" />
                }
            }
        }
        else if (!_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                Please enter one or more AWB numbers to track.
            </MudAlert>
        }
    }
</MudContainer>

@code {
    [Parameter] public string? AWBNumber { get; set; }
    
    private string _searchTerm = "";
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private List<ShipmentTrackingResult> _shipmentResults = new();
    private List<string> _notFoundAwbs = new();

    private class ShipmentTrackingResult
    {
        public InscanMaster Shipment { get; set; } = null!;
        public List<ShipmentStatusHistory> Timeline { get; set; } = new();
        public string? ServiceTypeName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(AWBNumber))
        {
            _searchTerm = AWBNumber;
            await TrackShipments();
        }
    }

    private async Task TrackShipments()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm)) return;

        _isLoading = true;
        _hasSearched = true;
        _shipmentResults.Clear();
        _notFoundAwbs.Clear();
        StateHasChanged();

        try
        {
            var awbNumbers = _searchTerm
                .Split(new[] { ',', ';', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(a => a.Trim().ToUpper())
                .Where(a => !string.IsNullOrEmpty(a))
                .Distinct()
                .ToList();

            foreach (var awb in awbNumbers)
            {
                var shipment = await DbContext.InscanMasters
                    .FirstOrDefaultAsync(i => i.AWBNo == awb || i.ReferenceNo == awb);

                if (shipment != null)
                {
                    string? serviceTypeName = null;
                    if (shipment.ProductTypeId.HasValue)
                    {
                        var serviceType = await DbContext.ServiceTypes.FirstOrDefaultAsync(s => s.Id == shipment.ProductTypeId);
                        serviceTypeName = serviceType?.Name;
                    }
                    
                    var result = new ShipmentTrackingResult
                    {
                        Shipment = shipment,
                        ServiceTypeName = serviceTypeName
                    };
                    
                    result.Timeline = await StatusService.GetTimeline(shipment.Id);
                    _shipmentResults.Add(result);
                }
                else
                {
                    _notFoundAwbs.Add(awb);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error tracking shipments: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetOriginFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsignorCity)) parts.Add(shipment.ConsignorCity);
        if (!string.IsNullOrEmpty(shipment.ConsignorPostalCode)) parts.Add(shipment.ConsignorPostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsignorCountry)) parts.Add(shipment.ConsignorCountry);
        return parts.Any() ? string.Join(", ", parts) : "";
    }

    private string GetDestinationFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsigneeCity)) parts.Add(shipment.ConsigneeCity);
        if (!string.IsNullOrEmpty(shipment.ConsigneePostalCode)) parts.Add(shipment.ConsigneePostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsigneeCountry)) parts.Add(shipment.ConsigneeCountry);
        return parts.Any() ? string.Join(", ", parts) : "";
    }

    private Color GetStatusColor(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Delivered => Color.Success,
            CourierStatus.OutForDelivery => Color.Info,
            CourierStatus.InTransit or CourierStatus.InscanAtDestination => Color.Primary,
            CourierStatus.NotDelivered or CourierStatus.ReturnToOrigin or CourierStatus.Cancelled => Color.Error,
            CourierStatus.OnHold => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetStatusDisplayName(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => "Pending",
            CourierStatus.AssignedToPickup => "Assigned for Pickup",
            CourierStatus.PickedUp => "Picked Up",
            CourierStatus.InscanAtOrigin => "At Origin Hub",
            CourierStatus.InTransit => "In Transit",
            CourierStatus.InscanAtDestination => "At Destination Hub",
            CourierStatus.OutForDelivery => "Out for Delivery",
            CourierStatus.Delivered => "Delivered",
            CourierStatus.NotDelivered => "Delivery Failed",
            CourierStatus.ReturnToOrigin => "Returning",
            CourierStatus.Returned => "Returned",
            CourierStatus.OnHold => "On Hold",
            CourierStatus.Cancelled => "Cancelled",
            _ => status.ToString()
        };
    }

    private Color GetEventColor(ShipmentStatusHistory eventItem)
    {
        if (eventItem.Status?.IsTerminal == true) return Color.Success;
        if (eventItem.Status?.IsException == true) return Color.Error;
        
        var groupCode = eventItem.StatusGroup?.Code ?? "";
        return groupCode switch
        {
            "DELIVERY" => Color.Success,
            "EXCEPTION" => Color.Error,
            "TRANSIT" => Color.Primary,
            "COLLECTION" => Color.Info,
            _ => Color.Default
        };
    }

    private Color GetCODStatusColor(InscanMaster shipment)
    {
        if (shipment.CourierStatusId == CourierStatus.Delivered)
            return Color.Success;
        if (shipment.CourierStatusId == CourierStatus.Cancelled)
            return Color.Error;
        return Color.Warning;
    }

    private string GetCODStatusText(InscanMaster shipment)
    {
        if (shipment.CourierStatusId == CourierStatus.Delivered)
            return "Collected";
        if (shipment.CourierStatusId == CourierStatus.Cancelled)
            return "Cancelled";
        return "Pending";
    }

    private async Task OpenUpdateStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.Shipment, shipment }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Shipment Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var trackingResult = _shipmentResults.FirstOrDefault(r => r.Shipment.Id == shipment.Id);
            if (trackingResult != null)
            {
                trackingResult.Timeline = await StatusService.GetTimeline(shipment.Id);
                trackingResult.Shipment = await DbContext.InscanMasters
                    .FirstOrDefaultAsync(i => i.Id == shipment.Id) ?? shipment;
            }
            StateHasChanged();
        }
    }
}

@page "/tracking"
@page "/tracking/{AWBNumber}"
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Net4Courier.Operations.Enums
@using Net4Courier.Masters.Entities
@inject ApplicationDbContext DbContext
@inject ShipmentStatusService StatusService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Track Shipment | Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-8">
    <MudText Typo="Typo.h4" Class="mb-6">Track Shipment</MudText>
    
    <MudPaper Elevation="1" Class="pa-4 mb-6">
        <MudGrid>
            <MudItem xs="12">
                <MudRadioGroup @bind-Value="_searchType" Row="true">
                    <MudRadio Value="@SearchType.AWBNumber" Color="Color.Primary">AWB Number</MudRadio>
                    <MudRadio Value="@SearchType.PickupRequestNumber" Color="Color.Primary">Pickup Request Number</MudRadio>
                    <MudRadio Value="@SearchType.ReferenceNumber" Color="Color.Primary">Reference Number</MudRadio>
                </MudRadioGroup>
            </MudItem>
            <MudItem xs="12" sm="9" md="10">
                <MudTextField @bind-Value="_searchTerm" 
                              Label="@GetSearchLabel()" 
                              Placeholder="@GetSearchPlaceholder()"
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                              Immediate="true"
                              HelperText="Separate multiple entries with commas for bulk tracking"
                              OnKeyDown="@(async e => { if (e.Key == "Enter") await TrackShipments(); })" />
            </MudItem>
            <MudItem xs="12" sm="3" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           StartIcon="@Icons.Material.Filled.Search"
                           OnClick="TrackShipments" 
                           FullWidth="true"
                           Disabled="@_isLoading"
                           Style="height: 56px;">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true"/>
                    }
                    else
                    {
                        <MudText>TRACK</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasSearched && !_isLoading)
    {
        @if (_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                The following AWB number(s) were not found: <strong>@string.Join(", ", _notFoundAwbs)</strong>
            </MudAlert>
        }

        @if (_shipmentResults.Any())
        {
            @if (_shipmentResults.Count > 1)
            {
                <MudText Typo="Typo.subtitle1" Class="mb-4">Found @_shipmentResults.Count shipment(s)</MudText>
            }
            
            @foreach (var result in _shipmentResults)
            {
                <MudGrid Class="mb-6">
                    <MudItem xs="12" md="6">
                        <MudPaper Elevation="1" Class="pa-5">
                            <div class="d-flex justify-space-between align-center mb-4 flex-wrap gap-2">
                                <div>
                                    <MudText Typo="Typo.h5">@result.Shipment.AWBNo</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Booked on @result.Shipment.TransactionDate.ToString("dd MMM yyyy")</MudText>
                                </div>
                                <div class="d-flex align-center gap-2 flex-wrap">
                                    <MudChip T="string" Color="@GetStatusColor(result.Shipment.CourierStatusId)" Variant="Variant.Filled" Size="Size.Medium">
                                        @GetStatusDisplayName(result.Shipment.CourierStatusId)
                                    </MudChip>
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               OnClick="@(() => EditShipment(result.Shipment.Id))">
                                        Edit
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Secondary" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Print"
                                               OnClick="@(() => PrintTrackingDetails(result))">
                                        Print
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Warning" 
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Update"
                                               OnClick="@(() => OpenChangeStatusDialog(result.Shipment))">
                                        Change Status
                                    </MudButton>
                                </div>
                            </div>

                            <MudGrid Class="mb-4">
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">From</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Consignor ?? "N/A")</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorAddress1))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsignorAddress1</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorAddress2))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsignorAddress2</MudText>
                                    }
                                    <MudText Typo="Typo.body2">@GetOriginFull(result.Shipment)</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsignorPhone))
                                    {
                                        <MudText Typo="Typo.body2">Phone: @result.Shipment.ConsignorPhone</MudText>
                                    }
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">To</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Consignee ?? "N/A")</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeContact))
                                    {
                                        <MudText Typo="Typo.body2">Contact: @result.Shipment.ConsigneeContact</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeAddress1))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsigneeAddress1</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeAddress2))
                                    {
                                        <MudText Typo="Typo.body2">@result.Shipment.ConsigneeAddress2</MudText>
                                    }
                                    <MudText Typo="Typo.body2">@GetDestinationFull(result.Shipment)</MudText>
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneePhone))
                                    {
                                        <MudText Typo="Typo.body2">Phone: @result.Shipment.ConsigneePhone</MudText>
                                    }
                                    @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeMobile) && result.Shipment.ConsigneeMobile != result.Shipment.ConsigneePhone)
                                    {
                                        <MudText Typo="Typo.body2">Mobile: @result.Shipment.ConsigneeMobile</MudText>
                                    }
                                </MudItem>
                            </MudGrid>

                            <MudDivider Class="my-4" />

                            <MudGrid>
                                <MudItem xs="6" sm="4">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Service</MudText>
                                    <MudText Typo="Typo.body2">@(result.ServiceTypeName ?? "Standard")</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="4">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@(result.Shipment.DocumentTypeId == DocumentType.Document ? Color.Info : Color.Warning)">
                                        @(result.Shipment.DocumentTypeId == DocumentType.Document ? "DOCS" : "NON-DOCS")
                                    </MudChip>
                                </MudItem>
                                <MudItem xs="6" sm="4">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Pieces</MudText>
                                    <MudText Typo="Typo.body2">@(result.Shipment.Pieces ?? 1)</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="4">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Weight</MudText>
                                    <MudText Typo="Typo.body2">@((result.Shipment.ChargeableWeight ?? result.Shipment.Weight ?? 0).ToString("0.00")) kg</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="4">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Payment</MudText>
                                    <MudText Typo="Typo.body2">@(result.Shipment.PaymentModeId.ToString())</MudText>
                                </MudItem>
                            </MudGrid>
                            
                            @if (!string.IsNullOrEmpty(result.Shipment.CargoDescription))
                            {
                                <MudGrid Class="mt-3">
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Commodity / Contents</MudText>
                                        <MudText Typo="Typo.body2">@result.Shipment.CargoDescription</MudText>
                                    </MudItem>
                                </MudGrid>
                            }

                            @if (result.Shipment.CourierStatusId == CourierStatus.Delivered && result.Shipment.DeliveredDate.HasValue)
                            {
                                <MudAlert Severity="Severity.Success" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.CheckCircle">
                                    Delivered on: @result.Shipment.DeliveredDate.Value.ToString("dd MMM yyyy")
                                </MudAlert>
                            }
                            else if (result.Shipment.CourierStatusId == CourierStatus.OutForDelivery)
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.LocalShipping">
                                    Out for Delivery Today
                                </MudAlert>
                            }
                        </MudPaper>

                        @if (result.Shipment.PaymentModeId == PaymentMode.COD && result.Shipment.CODAmount > 0)
                        {
                            <MudPaper Elevation="1" Class="pa-4 mt-4">
                                <MudText Typo="Typo.h6" Class="mb-3">COD Details</MudText>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>COD Amount</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Currency ?? "AED") @result.Shipment.CODAmount?.ToString("N2")</MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText>Status</MudText>
                                    <MudChip T="string" Color="@GetCODStatusColor(result.Shipment)" Size="Size.Small" Variant="Variant.Filled">
                                        @GetCODStatusText(result.Shipment)
                                    </MudChip>
                                </div>
                            </MudPaper>
                        }

                        <MudPaper Elevation="1" Class="pa-4 mt-4">
                            <MudText Typo="Typo.h6" Class="mb-3">Charges</MudText>
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudText>Courier Charges</MudText>
                                <MudText>@(result.Shipment.Currency ?? "AED") @(result.Shipment.CourierCharge?.ToString("N2") ?? "0.00")</MudText>
                            </div>
                            @if (result.Shipment.FuelSurcharge > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>Fuel Surcharge</MudText>
                                    <MudText>@(result.Shipment.Currency ?? "AED") @result.Shipment.FuelSurcharge?.ToString("N2")</MudText>
                                </div>
                            }
                            @if (result.Shipment.OtherCharge > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText>Other Charges</MudText>
                                    <MudText>@(result.Shipment.Currency ?? "AED") @result.Shipment.OtherCharge?.ToString("N2")</MudText>
                                </div>
                            }
                            @if (result.Shipment.Discount > 0)
                            {
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Color="Color.Success">Discount</MudText>
                                    <MudText Color="Color.Success">-@(result.Shipment.Currency ?? "AED") @result.Shipment.Discount?.ToString("N2")</MudText>
                                </div>
                            }
                            <MudDivider Class="my-2" />
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Total</MudText>
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;" Color="Color.Primary">
                                    @(result.Shipment.Currency ?? "AED") @(result.Shipment.NetTotal?.ToString("N2") ?? "0.00")
                                </MudText>
                            </div>
                        </MudPaper>

                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Update"
                                   OnClick="@(() => OpenUpdateStatusDialog(result.Shipment))"
                                   FullWidth="true"
                                   Class="mt-4">
                            Update Status
                        </MudButton>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudPaper Elevation="1" Class="pa-5" Style="height: 100%;">
                            <MudText Typo="Typo.h6" Class="mb-4">Tracking History</MudText>
                            
                            @if (result.Timeline.Any())
                            {
                                <div style="max-height: 500px; overflow-y: auto;">
                                    <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineAlign="TimelineAlign.Default">
                                        @foreach (var eventItem in result.Timeline.OrderByDescending(t => t.ChangedAt))
                                        {
                                            <MudTimelineItem Color="@GetEventColor(eventItem)" Size="Size.Medium" Variant="Variant.Filled">
                                                <ItemContent>
                                                    <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                                                        @(eventItem.Status?.Name ?? eventItem.EventType)@(!string.IsNullOrEmpty(eventItem.Remarks) ? $": {eventItem.Remarks}" : "")
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(eventItem.LocationName))
                                                    {
                                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@eventItem.LocationName</MudText>
                                                    }
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @eventItem.ChangedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                                                        @if (!string.IsNullOrEmpty(eventItem.UserName))
                                                        {
                                                            <span> - By @eventItem.UserName</span>
                                                        }
                                                    </MudText>
                                                </ItemContent>
                                            </MudTimelineItem>
                                        }
                                    </MudTimeline>
                                </div>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center pa-4">
                                    No tracking events recorded yet.
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                
                @if (_shipmentResults.Count > 1 && result != _shipmentResults.Last())
                {
                    <MudDivider Class="my-6" />
                }
            }
        }
        
        @if (_importShipmentResults.Any())
        {
            <MudText Typo="Typo.subtitle1" Class="mb-4 mt-4">
                <MudIcon Icon="@Icons.Material.Filled.LocalShipping" /> Found @_importShipmentResults.Count import shipment(s)
            </MudText>
            
            @foreach (var importShipment in _importShipmentResults)
            {
                <MudPaper Elevation="1" Class="pa-5 mb-4">
                    <div class="d-flex justify-space-between align-center mb-4 flex-wrap gap-2">
                        <div>
                            <MudText Typo="Typo.h5">@importShipment.AWBNo</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Import Ref: @importShipment.ImportMaster?.ImportRefNo
                            </MudText>
                        </div>
                        <div class="d-flex align-center gap-2 flex-wrap">
                            <MudChip T="string" Color="@GetImportStatusColor(importShipment.Status)" Variant="Variant.Filled" Size="Size.Medium">
                                @importShipment.Status.ToString()
                            </MudChip>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Visibility"
                                       Href="@($"/import-shipment/{importShipment.Id}")">
                                View
                            </MudButton>
                        </div>
                    </div>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Consignee</MudText>
                            <MudText>@importShipment.ConsigneeName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @importShipment.ConsigneeCity, @importShipment.ConsigneeCountry
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Shipment Details</MudText>
                            <MudText>Pieces: @importShipment.Pieces | Weight: @importShipment.Weight kg</MudText>
                            @if (!string.IsNullOrEmpty(importShipment.ReferenceNo))
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Ref: @importShipment.ReferenceNo
                                </MudText>
                            }
                        </MudItem>
                    </MudGrid>
                    
                    @if (importShipment.InscannedAt.HasValue)
                    {
                        <MudAlert Severity="Severity.Success" Dense="true" Class="mt-3">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-1" Size="Size.Small" />
                            Inscanned on @(importShipment.InscannedAt?.ToString("dd MMM yyyy HH:mm") ?? "N/A")
                        </MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                            <MudIcon Icon="@Icons.Material.Filled.PendingActions" Class="mr-1" Size="Size.Small" />
                            Pending Inscan
                        </MudAlert>
                    }
                </MudPaper>
            }
        }
        
        @if (!_shipmentResults.Any() && !_importShipmentResults.Any() && !_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                Please enter one or more AWB numbers to track.
            </MudAlert>
        }
    }
</MudContainer>

@code {
    [Parameter] public string? AWBNumber { get; set; }
    
    private enum SearchType { AWBNumber, PickupRequestNumber, ReferenceNumber }
    
    private string _searchTerm = "";
    private SearchType _searchType = SearchType.AWBNumber;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private List<ShipmentTrackingResult> _shipmentResults = new();
    private List<ImportShipment> _importShipmentResults = new();
    private List<string> _notFoundAwbs = new();

    private class ShipmentTrackingResult
    {
        public InscanMaster Shipment { get; set; } = null!;
        public List<ShipmentStatusHistory> Timeline { get; set; } = new();
        public string? ServiceTypeName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(AWBNumber))
        {
            _searchTerm = AWBNumber;
            await TrackShipments();
        }
    }
    
    private string GetSearchLabel() => _searchType switch
    {
        SearchType.AWBNumber => "Enter AWB Number",
        SearchType.PickupRequestNumber => "Enter Pickup Request Number",
        SearchType.ReferenceNumber => "Enter Reference Number",
        _ => "Enter Search Term"
    };
    
    private string GetSearchPlaceholder() => _searchType switch
    {
        SearchType.AWBNumber => "e.g., DXB90090001, DXB90090002",
        SearchType.PickupRequestNumber => "e.g., PKP-2026-0001",
        SearchType.ReferenceNumber => "e.g., REF001, REF002",
        _ => "Enter value to search"
    };

    private async Task TrackShipments()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm)) return;

        _isLoading = true;
        _hasSearched = true;
        _shipmentResults.Clear();
        _importShipmentResults.Clear();
        _notFoundAwbs.Clear();
        StateHasChanged();

        try
        {
            var searchTerms = _searchTerm
                .Split(new[] { ',', ';', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(a => a.Trim())
                .Where(a => !string.IsNullOrEmpty(a))
                .Distinct()
                .ToList();

            foreach (var term in searchTerms)
            {
                List<InscanMaster> shipments = new();
                
                switch (_searchType)
                {
                    case SearchType.AWBNumber:
                        var awbShipment = await DbContext.InscanMasters
                            .FirstOrDefaultAsync(i => i.AWBNo.ToUpper() == term.ToUpper());
                        if (awbShipment != null) shipments.Add(awbShipment);
                        break;
                        
                    case SearchType.PickupRequestNumber:
                        var pickup = await DbContext.PickupRequests
                            .FirstOrDefaultAsync(p => p.PickupNo.ToUpper() == term.ToUpper());
                        if (pickup != null)
                        {
                            shipments = await DbContext.InscanMasters
                                .Where(i => i.PickupRequestId == pickup.Id)
                                .ToListAsync();
                        }
                        break;
                        
                    case SearchType.ReferenceNumber:
                        shipments = await DbContext.InscanMasters
                            .Where(i => i.ReferenceNo != null && i.ReferenceNo.ToUpper() == term.ToUpper())
                            .ToListAsync();
                        break;
                }

                if (shipments.Any())
                {
                    foreach (var shipment in shipments)
                    {
                        string? serviceTypeName = null;
                        if (shipment.ProductTypeId.HasValue)
                        {
                            var serviceType = await DbContext.ServiceTypes.FirstOrDefaultAsync(s => s.Id == shipment.ProductTypeId);
                            serviceTypeName = serviceType?.Name;
                        }
                        
                        var result = new ShipmentTrackingResult
                        {
                            Shipment = shipment,
                            ServiceTypeName = serviceTypeName
                        };
                        
                        result.Timeline = await StatusService.GetTimeline(shipment.Id);
                        _shipmentResults.Add(result);
                    }
                }
                else
                {
                    // Also search in ImportShipments if not found in InscanMasters
                    ImportShipment? importShipment = null;
                    switch (_searchType)
                    {
                        case SearchType.AWBNumber:
                            importShipment = await DbContext.ImportShipments
                                .Include(s => s.ImportMaster)
                                .FirstOrDefaultAsync(i => i.AWBNo != null && i.AWBNo.ToUpper() == term.ToUpper());
                            break;
                        case SearchType.ReferenceNumber:
                            importShipment = await DbContext.ImportShipments
                                .Include(s => s.ImportMaster)
                                .FirstOrDefaultAsync(i => i.ReferenceNo != null && i.ReferenceNo.ToUpper() == term.ToUpper());
                            break;
                    }
                    
                    if (importShipment != null)
                    {
                        _importShipmentResults.Add(importShipment);
                    }
                    else
                    {
                        _notFoundAwbs.Add(term);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error tracking shipments: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string GetOriginFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsignorCity)) parts.Add(shipment.ConsignorCity);
        if (!string.IsNullOrEmpty(shipment.ConsignorPostalCode)) parts.Add(shipment.ConsignorPostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsignorCountry)) parts.Add(shipment.ConsignorCountry);
        return parts.Any() ? string.Join(", ", parts) : "";
    }

    private string GetDestinationFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsigneeCity)) parts.Add(shipment.ConsigneeCity);
        if (!string.IsNullOrEmpty(shipment.ConsigneePostalCode)) parts.Add(shipment.ConsigneePostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsigneeCountry)) parts.Add(shipment.ConsigneeCountry);
        return parts.Any() ? string.Join(", ", parts) : "";
    }

    private Color GetStatusColor(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Delivered => Color.Success,
            CourierStatus.OutForDelivery => Color.Info,
            CourierStatus.InTransit or CourierStatus.InscanAtDestination => Color.Primary,
            CourierStatus.NotDelivered or CourierStatus.ReturnToOrigin or CourierStatus.Cancelled => Color.Error,
            CourierStatus.OnHold => Color.Warning,
            _ => Color.Default
        };
    }
    
    private Color GetImportStatusColor(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.Expected => Color.Default,
        ImportShipmentStatus.Inscanned => Color.Info,
        ImportShipmentStatus.PendingCustoms => Color.Warning,
        ImportShipmentStatus.CustomsHold => Color.Error,
        ImportShipmentStatus.Cleared => Color.Success,
        ImportShipmentStatus.OnHold => Color.Error,
        ImportShipmentStatus.Released => Color.Success,
        _ => Color.Default
    };

    private string GetStatusDisplayName(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => "Pending",
            CourierStatus.AssignedToPickup => "Assigned for Pickup",
            CourierStatus.PickedUp => "Picked Up",
            CourierStatus.InscanAtOrigin => "At Origin Hub",
            CourierStatus.InTransit => "In Transit",
            CourierStatus.InscanAtDestination => "At Destination Hub",
            CourierStatus.OutForDelivery => "Out for Delivery",
            CourierStatus.Delivered => "Delivered",
            CourierStatus.NotDelivered => "Delivery Failed",
            CourierStatus.ReturnToOrigin => "Returning",
            CourierStatus.Returned => "Returned",
            CourierStatus.OnHold => "On Hold",
            CourierStatus.Cancelled => "Cancelled",
            _ => status.ToString()
        };
    }

    private Color GetEventColor(ShipmentStatusHistory eventItem)
    {
        if (eventItem.Status?.IsTerminal == true) return Color.Success;
        if (eventItem.Status?.IsException == true) return Color.Error;
        
        var groupCode = eventItem.StatusGroup?.Code ?? "";
        return groupCode switch
        {
            "DELIVERY" => Color.Success,
            "EXCEPTION" => Color.Error,
            "TRANSIT" => Color.Primary,
            "COLLECTION" => Color.Info,
            _ => Color.Default
        };
    }

    private Color GetCODStatusColor(InscanMaster shipment)
    {
        if (shipment.CourierStatusId == CourierStatus.Delivered)
            return Color.Success;
        if (shipment.CourierStatusId == CourierStatus.Cancelled)
            return Color.Error;
        return Color.Warning;
    }

    private string GetCODStatusText(InscanMaster shipment)
    {
        if (shipment.CourierStatusId == CourierStatus.Delivered)
            return "Collected";
        if (shipment.CourierStatusId == CourierStatus.Cancelled)
            return "Cancelled";
        return "Pending";
    }

    private async Task OpenUpdateStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.Shipment, shipment }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Shipment Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var trackingResult = _shipmentResults.FirstOrDefault(r => r.Shipment.Id == shipment.Id);
            if (trackingResult != null)
            {
                trackingResult.Timeline = await StatusService.GetTimeline(shipment.Id);
                trackingResult.Shipment = await DbContext.InscanMasters
                    .FirstOrDefaultAsync(i => i.Id == shipment.Id) ?? shipment;
            }
            StateHasChanged();
        }
    }

    private void EditShipment(long shipmentId)
    {
        NavigationManager.NavigateTo($"/awb-entry/{shipmentId}");
    }
    
    private async Task OpenChangeStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.Shipment, shipment },
            { x => x.EntityType, EntityType.Shipment }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };
        
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>(
            "Change Status", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            // Refresh the timeline for this shipment after status change
            var trackingResult = _shipmentResults.FirstOrDefault(r => r.Shipment.Id == shipment.Id);
            if (trackingResult != null)
            {
                trackingResult.Timeline = await StatusService.GetTimeline(shipment.Id);
                
                // Reload shipment to get updated status
                var updatedShipment = await DbContext.InscanMasters.FirstOrDefaultAsync(s => s.Id == shipment.Id);
                if (updatedShipment != null)
                {
                    trackingResult.Shipment = updatedShipment;
                }
                
                StateHasChanged();
            }
        }
    }

    private async Task PrintTrackingDetails(ShipmentTrackingResult result)
    {
        var printContent = GeneratePrintHtml(result);
        await JSRuntime.InvokeVoidAsync("printContent", printContent);
    }

    private string GeneratePrintHtml(ShipmentTrackingResult result)
    {
        var shipment = result.Shipment;
        var timeline = result.Timeline;
        
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<html><head><title>Tracking Details - " + shipment.AWBNo + "</title>");
        sb.AppendLine("<style>");
        sb.AppendLine("body { font-family: Arial, sans-serif; margin: 20px; }");
        sb.AppendLine("h1 { color: #1976d2; margin-bottom: 5px; }");
        sb.AppendLine("h2 { color: #333; margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }");
        sb.AppendLine(".header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }");
        sb.AppendLine(".status { background: #4caf50; color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px; }");
        sb.AppendLine(".info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }");
        sb.AppendLine(".info-box { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }");
        sb.AppendLine(".info-box h3 { margin: 0 0 10px 0; color: #666; font-size: 12px; text-transform: uppercase; }");
        sb.AppendLine(".info-box p { margin: 3px 0; }");
        sb.AppendLine(".timeline { margin-top: 20px; }");
        sb.AppendLine(".timeline-item { display: flex; margin-bottom: 15px; }");
        sb.AppendLine(".timeline-dot { width: 12px; height: 12px; background: #1976d2; border-radius: 50%; margin-right: 15px; margin-top: 5px; }");
        sb.AppendLine(".timeline-content { flex: 1; }");
        sb.AppendLine(".timeline-date { color: #666; font-size: 12px; }");
        sb.AppendLine(".timeline-status { font-weight: bold; }");
        sb.AppendLine(".shipment-details { margin-top: 20px; }");
        sb.AppendLine(".detail-row { display: flex; border-bottom: 1px solid #eee; padding: 8px 0; }");
        sb.AppendLine(".detail-label { width: 150px; color: #666; }");
        sb.AppendLine(".detail-value { flex: 1; }");
        sb.AppendLine("@media print { body { margin: 0; } }");
        sb.AppendLine("</style></head><body>");
        
        sb.AppendLine("<div class='header'>");
        sb.AppendLine($"<div><h1>AWB: {shipment.AWBNo}</h1>");
        sb.AppendLine($"<p>Booked on {shipment.TransactionDate:dd MMM yyyy}</p></div>");
        sb.AppendLine($"<span class='status'>{GetStatusDisplayName(shipment.CourierStatusId)}</span>");
        sb.AppendLine("</div>");
        
        sb.AppendLine("<div class='info-grid'>");
        sb.AppendLine("<div class='info-box'>");
        sb.AppendLine("<h3>From (Shipper)</h3>");
        sb.AppendLine($"<p><strong>{shipment.Consignor ?? "N/A"}</strong></p>");
        if (!string.IsNullOrEmpty(shipment.ConsignorAddress1)) sb.AppendLine($"<p>{shipment.ConsignorAddress1}</p>");
        if (!string.IsNullOrEmpty(shipment.ConsignorAddress2)) sb.AppendLine($"<p>{shipment.ConsignorAddress2}</p>");
        sb.AppendLine($"<p>{GetOriginFull(shipment)}</p>");
        if (!string.IsNullOrEmpty(shipment.ConsignorPhone)) sb.AppendLine($"<p>Phone: {shipment.ConsignorPhone}</p>");
        sb.AppendLine("</div>");
        
        sb.AppendLine("<div class='info-box'>");
        sb.AppendLine("<h3>To (Consignee)</h3>");
        sb.AppendLine($"<p><strong>{shipment.Consignee ?? "N/A"}</strong></p>");
        if (!string.IsNullOrEmpty(shipment.ConsigneeContact)) sb.AppendLine($"<p>Contact: {shipment.ConsigneeContact}</p>");
        if (!string.IsNullOrEmpty(shipment.ConsigneeAddress1)) sb.AppendLine($"<p>{shipment.ConsigneeAddress1}</p>");
        if (!string.IsNullOrEmpty(shipment.ConsigneeAddress2)) sb.AppendLine($"<p>{shipment.ConsigneeAddress2}</p>");
        sb.AppendLine($"<p>{GetDestinationFull(shipment)}</p>");
        if (!string.IsNullOrEmpty(shipment.ConsigneeMobile)) sb.AppendLine($"<p>Mobile: {shipment.ConsigneeMobile}</p>");
        sb.AppendLine("</div>");
        sb.AppendLine("</div>");
        
        sb.AppendLine("<h2>Shipment Details</h2>");
        sb.AppendLine("<div class='shipment-details'>");
        sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Reference No:</span><span class='detail-value'>{shipment.ReferenceNo ?? "N/A"}</span></div>");
        sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Pieces:</span><span class='detail-value'>{shipment.Pieces}</span></div>");
        sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Weight:</span><span class='detail-value'>{shipment.Weight:F2} kg</span></div>");
        sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Document Type:</span><span class='detail-value'>{GetDocumentTypeLabel(shipment.DocumentTypeId)}</span></div>");
        sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Payment Mode:</span><span class='detail-value'>{GetPaymentModeLabel(shipment.PaymentModeId)}</span></div>");
        if (!string.IsNullOrEmpty(result.ServiceTypeName))
            sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Service Type:</span><span class='detail-value'>{result.ServiceTypeName}</span></div>");
        if (!string.IsNullOrEmpty(shipment.CargoDescription))
            sb.AppendLine($"<div class='detail-row'><span class='detail-label'>Description:</span><span class='detail-value'>{shipment.CargoDescription}</span></div>");
        if (shipment.CODAmount > 0)
            sb.AppendLine($"<div class='detail-row'><span class='detail-label'>COD Amount:</span><span class='detail-value'>{shipment.CODAmount:N2}</span></div>");
        sb.AppendLine("</div>");
        
        if (timeline?.Any() == true)
        {
            sb.AppendLine("<h2>Tracking History</h2>");
            sb.AppendLine("<div class='timeline'>");
            foreach (var evt in timeline.OrderByDescending(t => t.ChangedAt))
            {
                sb.AppendLine("<div class='timeline-item'>");
                sb.AppendLine("<div class='timeline-dot'></div>");
                sb.AppendLine("<div class='timeline-content'>");
                sb.AppendLine($"<div class='timeline-date'>{evt.ChangedAt:dd MMM yyyy HH:mm}</div>");
                sb.AppendLine($"<div class='timeline-status'>{evt.Status?.Name ?? "Status Update"}</div>");
                if (!string.IsNullOrEmpty(evt.Remarks))
                    sb.AppendLine($"<div>{evt.Remarks}</div>");
                if (!string.IsNullOrEmpty(evt.LocationName))
                    sb.AppendLine($"<div style='color:#666;font-size:12px;'>Location: {evt.LocationName}</div>");
                sb.AppendLine("</div></div>");
            }
            sb.AppendLine("</div>");
        }
        
        sb.AppendLine($"<p style='margin-top:30px;color:#666;font-size:11px;text-align:center;'>Printed on {DateTime.Now:dd MMM yyyy HH:mm} | Net4Courier</p>");
        sb.AppendLine("</body></html>");
        
        return sb.ToString();
    }

    private string GetDocumentTypeLabel(DocumentType docType)
    {
        return docType switch
        {
            DocumentType.Letter => "Letter",
            DocumentType.Document => "Document",
            DocumentType.ParcelUpto30Kg => "Parcel Upto 30kg",
            DocumentType.ParcelAbove30Kg => "Parcel Above 30kg",
            _ => docType.ToString()
        };
    }

    private string GetPaymentModeLabel(PaymentMode paymentMode)
    {
        return paymentMode switch
        {
            PaymentMode.Prepaid => "Prepaid",
            PaymentMode.COD => "Cash on Delivery",
            PaymentMode.Account => "Account",
            PaymentMode.PickupCash => "Pickup Cash",
            PaymentMode.CAD => "Cash Against Delivery",
            _ => paymentMode.ToString()
        };
    }
}

@page "/tracking"
@page "/tracking/{AWBNumber}"
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@using Net4Courier.Operations.Enums
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ShipmentStatusService StatusService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@inject AppAuthStateProvider AuthState
@inject IDateTimeService DateTimeService
@rendermode InteractiveServer

<PageTitle>Track Shipment | Net4Courier</PageTitle>

<style>
    .tracking-search-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .tracking-main-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        position: relative;
    }
    .tracking-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
        z-index: 1;
    }
    .tracking-content {
        padding: 1.5rem;
    }
    .tracking-footer {
        background: #f8fafc;
        padding: 1rem 1.5rem;
        border-top: 1px solid #f0f0f0;
    }
    .route-section {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    @@media (min-width: 960px) {
        .route-section {
            flex-direction: row;
            align-items: flex-start;
        }
    }
    .route-point {
        flex: 1;
    }
    .route-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .route-label .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    .route-label.from { color: #6b7280; }
    .route-label.from .dot { background: #d1d5db; }
    .route-label.to { color: #594AE2; }
    .route-label.to .dot { background: #594AE2; }
    .route-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }
    .route-address {
        font-size: 0.875rem;
        color: #6b7280;
        line-height: 1.5;
    }
    .route-phone {
        font-size: 0.875rem;
        color: #9ca3af;
        margin-top: 0.25rem;
    }
    .route-arrow {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 60px;
        opacity: 0.3;
    }
    @@media (min-width: 960px) {
        .route-arrow {
            display: flex;
        }
    }
    .route-arrow-line {
        border-top: 2px dashed #9ca3af;
        width: 100%;
    }
    .specs-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    @@media (min-width: 600px) {
        .specs-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    .spec-item label {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-bottom: 0.25rem;
        display: block;
    }
    .spec-item .value {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }
    .timeline-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 100%;
    }
    .timeline-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        font-weight: 500;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .timeline-content {
        padding: 1.5rem;
        max-height: 500px;
        overflow-y: auto;
    }
    .action-btn {
        padding: 0.5rem;
        border-radius: 50%;
        color: #6b7280;
        transition: all 0.2s;
        background: transparent;
        border: none;
        cursor: pointer;
    }
    .action-btn:hover {
        color: #594AE2;
        background: #f0f0ff;
    }
</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
    <MudText Typo="Typo.h5" Class="mb-4" Style="font-weight: 500; color: #374151;">Track Shipment</MudText>
    
    <div class="tracking-search-card pa-5 mb-6">
        <div class="d-flex flex-column flex-md-row gap-4 align-center">
            <MudRadioGroup @bind-Value="_searchType" Class="d-flex flex-row gap-4">
                <MudRadio Value="@SearchType.AWBNumber" Color="Color.Primary" Dense="true">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">AWB Number</MudText>
                </MudRadio>
                <MudRadio Value="@SearchType.PickupRequestNumber" Color="Color.Primary" Dense="true">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">Pickup Ref</MudText>
                </MudRadio>
                <MudRadio Value="@SearchType.ReferenceNumber" Color="Color.Primary" Dense="true">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">Ref Number</MudText>
                </MudRadio>
            </MudRadioGroup>
            
            <MudTextField @bind-Value="_searchTerm" 
                          Placeholder="@GetSearchPlaceholder()"
                          Variant="Variant.Outlined" 
                          Adornment="Adornment.End" 
                          AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                          Immediate="true"
                          Margin="Margin.Dense"
                          Class="flex-grow-1"
                          Style="min-width: 250px;"
                          OnKeyDown="@(async e => { if (e.Key == "Enter") await TrackShipments(); })" />
            
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Size="Size.Medium" 
                       OnClick="TrackShipments" 
                       Disabled="@_isLoading"
                       Style="height: 40px; min-width: 120px; text-transform: uppercase; font-weight: 500;">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface"/>
                }
                else
                {
                    <span>Track</span>
                }
            </MudButton>
        </div>
    </div>

    @if (_hasSearched && !_isLoading)
    {
        @if (_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                The following AWB number(s) were not found: <strong>@string.Join(", ", _notFoundAwbs)</strong>
            </MudAlert>
        }

        @if (_shipmentResults.Any())
        {
            @if (_shipmentResults.Count > 1)
            {
                <MudText Typo="Typo.subtitle1" Class="mb-4" Style="color: #6b7280;">Found @_shipmentResults.Count shipment(s)</MudText>
            }
            
            @foreach (var result in _shipmentResults)
            {
                <MudGrid Spacing="4" Class="mb-6">
                    <MudItem xs="12" lg="8">
                        <div class="tracking-main-card">
                            <div class="tracking-header d-flex flex-column flex-sm-row justify-space-between align-start align-sm-center gap-3">
                                <div>
                                    <MudText Typo="Typo.caption" Style="font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em;">AWB Number</MudText>
                                    <div class="d-flex align-center gap-3 mt-1">
                                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@result.Shipment.AWBNo</MudText>
                                        <MudChip T="string" Color="@GetStatusColor(result.Shipment.CourierStatusId)" Size="Size.Small" Variant="Variant.Filled" Style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">
                                            @GetStatusDisplayName(result.Shipment.CourierStatusId)
                                        </MudChip>
                                    </div>
                                    <MudText Typo="Typo.caption" Style="color: #9ca3af; margin-top: 4px;">Booked on @DateTimeService.FormatDate(result.Shipment.TransactionDate, "dd MMM yyyy")</MudText>
                                </div>
                                
                                <div class="d-flex align-center gap-1">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                   Size="Size.Small" 
                                                   Color="Color.Default"
                                                   OnClick="@(() => EditShipment(result.Shipment.Id))"
                                                   Title="Edit" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Primary" OnClick="@(() => PrintAWBA5(result.Shipment.Id))" Title="Print AWB (A5)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Label" Size="Size.Small" Color="Color.Secondary" OnClick="@(() => PrintLabel(result.Shipment.Id))" Title="Print Label" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Color="Color.Info" OnClick="@(() => PrintTrackingDetails(result))" Title="Tracking Details" />
                                    @if ((result.Shipment.DutyVatAmount ?? 0) > 0 || ((result.Shipment.OtherCharge ?? 0) > 0 && result.Shipment.MovementTypeId == Net4Courier.Kernel.Enums.MovementType.InternationalImport))
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Small" Color="Color.Warning" OnClick="@(() => PrintDutyReceipt(result.Shipment.Id))" Title="Duty Receipt" />
                                    }
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               Size="Size.Small"
                                               Class="ml-2"
                                               Style="text-transform: uppercase; font-size: 0.75rem;"
                                               OnClick="@(() => OpenChangeStatusDialog(result.Shipment))">
                                        Change Status
                                    </MudButton>
                                </div>
                            </div>

                            <div class="tracking-content">
                                <div class="route-section mb-6">
                                    <div class="route-point">
                                        <div class="route-label from">
                                            <span class="dot"></span> From
                                        </div>
                                        <div class="route-name">@(result.Shipment.Consignor ?? "N/A")</div>
                                        <div class="route-address">
                                            @if (!string.IsNullOrEmpty(result.Shipment.ConsignorAddress1))
                                            {
                                                @result.Shipment.ConsignorAddress1<br/>
                                            }
                                            @GetOriginFull(result.Shipment)
                                        </div>
                                        @if (!string.IsNullOrEmpty(result.Shipment.ConsignorPhone))
                                        {
                                            <div class="route-phone">@result.Shipment.ConsignorPhone</div>
                                        }
                                    </div>
                                    
                                    <div class="route-arrow">
                                        <div class="route-arrow-line"></div>
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Style="color: #9ca3af; margin-top: -10px; background: white; padding: 0 4px;" />
                                    </div>
                                    
                                    <div class="route-point">
                                        <div class="route-label to">
                                            <span class="dot"></span> To
                                        </div>
                                        <div class="route-name">@(result.Shipment.Consignee ?? "N/A")</div>
                                        <div class="route-address">
                                            @if (!string.IsNullOrEmpty(result.Shipment.ConsigneeAddress1))
                                            {
                                                @result.Shipment.ConsigneeAddress1<br/>
                                            }
                                            @GetDestinationFull(result.Shipment)
                                        </div>
                                        @if (!string.IsNullOrEmpty(result.Shipment.ConsigneePhone))
                                        {
                                            <div class="route-phone">@result.Shipment.ConsigneePhone</div>
                                        }
                                    </div>
                                </div>

                                <MudDivider Class="my-4" />

                                <div class="specs-grid">
                                    <div class="spec-item">
                                        <label>Service</label>
                                        <div class="value">@(result.ServiceTypeName ?? "Standard")</div>
                                    </div>
                                    <div class="spec-item">
                                        <label>Type</label>
                                        <MudChip T="string" Size="Size.Small" Color="@(result.Shipment.DocumentTypeId == DocumentType.Document ? Color.Info : Color.Warning)" Style="margin-top: -4px;">
                                            @(result.Shipment.DocumentTypeId == DocumentType.Document ? "DOCS" : "NON-DOCS")
                                        </MudChip>
                                    </div>
                                    <div class="spec-item">
                                        <label>Pieces</label>
                                        <div class="value">@(result.Shipment.Pieces ?? 1)</div>
                                    </div>
                                    <div class="spec-item">
                                        <label>Weight</label>
                                        <div class="value">@((result.Shipment.ChargeableWeight ?? result.Shipment.Weight ?? 0).ToString("0.00")) kg</div>
                                    </div>
                                    <div class="spec-item">
                                        <label>Payment</label>
                                        <div class="value">@(result.Shipment.PaymentModeId.ToString())</div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(result.Shipment.CargoDescription))
                                    {
                                        <div class="spec-item" style="grid-column: span 2;">
                                            <label>Commodity</label>
                                            <div class="value">@result.Shipment.CargoDescription</div>
                                        </div>
                                    }
                                </div>

                                @if (result.Shipment.CourierStatusId == CourierStatus.Delivered && result.Shipment.DeliveredDate.HasValue)
                                {
                                    <MudAlert Severity="Severity.Success" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.CheckCircle">
                                        Delivered on: @DateTimeService.FormatDate(result.Shipment.DeliveredDate, "dd MMM yyyy")
                                    </MudAlert>
                                }
                                else if (result.Shipment.CourierStatusId == CourierStatus.OutForDelivery)
                                {
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.LocalShipping">
                                        Out for Delivery Today
                                    </MudAlert>
                                }
                            </div>

                            <div class="tracking-footer d-flex justify-space-between align-center">
                                <MudText Typo="Typo.body2" Style="color: #6b7280;">Total Charges</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">
                                    @(result.Shipment.Currency ?? AuthState.CurrencyCode) @CalculateTotalCharges(result.Shipment).ToString("N2")
                                </MudText>
                            </div>
                        </div>

                        @if (result.Shipment.PaymentModeId == PaymentMode.COD && result.Shipment.CODAmount > 0)
                        {
                            <div class="tracking-main-card mt-4 pa-4">
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">COD Details</MudText>
                                    <MudChip T="string" Color="@GetCODStatusColor(result.Shipment)" Size="Size.Small" Variant="Variant.Filled">
                                        @GetCODStatusText(result.Shipment)
                                    </MudChip>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.body2" Style="color: #6b7280;">Amount to Collect</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.Shipment.Currency ?? AuthState.CurrencyCode) @result.Shipment.CODAmount?.ToString("N2")</MudText>
                                </div>
                            </div>
                        }
                    </MudItem>

                    <MudItem xs="12" lg="4">
                        <div class="timeline-card">
                            <div class="timeline-header">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                Tracking History
                            </div>
                            
                            <div class="timeline-content">
                                @if (result.Timeline.Any())
                                {
                                    <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineAlign="TimelineAlign.Default" DisableModifiers="true">
                                        @foreach (var eventItem in result.Timeline.OrderByDescending(t => t.ChangedAt))
                                        {
                                            <MudTimelineItem Color="@GetEventColor(eventItem)" Size="Size.Small" Variant="Variant.Filled">
                                                <ItemContent>
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1f2937;">
                                                        @(eventItem.Status?.Name ?? eventItem.EventType)
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(eventItem.Remarks))
                                                    {
                                                        <MudText Typo="Typo.caption" Style="color: #6b7280;">@eventItem.Remarks</MudText>
                                                    }
                                                    @if (!string.IsNullOrEmpty(eventItem.LocationName))
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" Style="font-size: 0.7rem; height: 20px; padding: 0 6px;">
                                                            @eventItem.LocationName
                                                        </MudChip>
                                                    }
                                                    <MudText Typo="Typo.caption" Style="color: #9ca3af; margin-top: 4px;">
                                                        @DateTimeService.FormatDateTime(eventItem.ChangedAt, "dd MMM yyyy, HH:mm")
                                                    </MudText>
                                                </ItemContent>
                                            </MudTimelineItem>
                                        }
                                    </MudTimeline>
                                }
                                else
                                {
                                    <div class="text-center pa-4">
                                        <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Large" Style="color: #d1d5db; margin-bottom: 8px;" />
                                        <MudText Typo="Typo.body2" Style="color: #9ca3af;">
                                            No tracking events recorded yet.
                                        </MudText>
                                    </div>
                                }
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
                
                @if (_shipmentResults.Count > 1 && result != _shipmentResults.Last())
                {
                    <MudDivider Class="my-6" />
                }
            }
        }
        
        @if (_importTrackingResults.Any())
        {
            @foreach (var result in _importTrackingResults)
            {
                <MudGrid Spacing="4" Class="mb-6">
                    <MudItem xs="12" lg="8">
                        <div class="tracking-main-card">
                            <div class="tracking-header d-flex flex-column flex-sm-row justify-space-between align-start align-sm-center gap-3">
                                <div>
                                    <MudText Typo="Typo.caption" Style="font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em;">AWB Number</MudText>
                                    <div class="d-flex align-center gap-3 mt-1">
                                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@result.ImportShipment.AWBNo</MudText>
                                        <MudChip T="string" Color="@GetImportStatusColor(result.ImportShipment.Status)" Size="Size.Small" Variant="Variant.Filled" Style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">
                                            @result.ImportShipment.Status.ToString()
                                        </MudChip>
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Outlined">Import</MudChip>
                                    </div>
                                    <MudText Typo="Typo.caption" Style="color: #9ca3af; margin-top: 4px;">
                                        Created on @DateTimeService.FormatDate(result.ImportShipment.CreatedAt, "dd MMM yyyy")
                                        @if (!string.IsNullOrEmpty(result.ImportShipment.ImportMaster?.ImportRefNo))
                                        {
                                            <span> | Import Ref: @result.ImportShipment.ImportMaster.ImportRefNo</span>
                                        }
                                    </MudText>
                                </div>
                                
                                <div class="d-flex align-center gap-1">
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                   Size="Size.Small" 
                                                   Color="Color.Default"
                                                   Href="@($"/import-shipment/{result.ImportShipment.Id}")"
                                                   Title="View Details" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Primary" OnClick="@(() => PrintImportAWBA5(result.ImportShipment.AWBNo))" Title="Print AWB (A5)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Label" Size="Size.Small" Color="Color.Secondary" OnClick="@(() => PrintImportLabel(result.ImportShipment.AWBNo))" Title="Print Label" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Color="Color.Info" OnClick="@(() => PrintImportTrackingDetails(result))" Title="Tracking Details" />
                                    @if ((result.ImportShipment.DutyAmount ?? 0) > 0 || (result.ImportShipment.VATAmount ?? 0) > 0 || (result.ImportShipment.TotalCustomsCharges ?? 0) > 0)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Small" Color="Color.Warning" OnClick="@(() => PrintImportDutyReceipt(result.ImportShipment.AWBNo))" Title="Duty Receipt" />
                                    }
                                </div>
                            </div>

                            <div class="tracking-content">
                                <div class="route-section mb-6">
                                    <div class="route-point">
                                        <div class="route-label from">
                                            <span class="dot"></span> From (Shipper)
                                        </div>
                                        <div class="route-name">@(result.ImportShipment.ShipperName ?? "N/A")</div>
                                        <div class="route-address">
                                            @if (!string.IsNullOrEmpty(result.ImportShipment.ShipperAddress))
                                            {
                                                @result.ImportShipment.ShipperAddress<br/>
                                            }
                                            @GetImportOriginFull(result.ImportShipment)
                                        </div>
                                        @if (!string.IsNullOrEmpty(result.ImportShipment.ShipperPhone))
                                        {
                                            <div class="route-phone">@result.ImportShipment.ShipperPhone</div>
                                        }
                                    </div>
                                    
                                    <div class="route-arrow">
                                        <div class="route-arrow-line"></div>
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" Style="color: #9ca3af; margin-top: -10px; background: white; padding: 0 4px;" />
                                    </div>
                                    
                                    <div class="route-point">
                                        <div class="route-label to">
                                            <span class="dot"></span> To (Consignee)
                                        </div>
                                        <div class="route-name">@(result.ImportShipment.ConsigneeName ?? "N/A")</div>
                                        <div class="route-address">
                                            @if (!string.IsNullOrEmpty(result.ImportShipment.ConsigneeAddress))
                                            {
                                                @result.ImportShipment.ConsigneeAddress<br/>
                                            }
                                            @GetImportDestinationFull(result.ImportShipment)
                                        </div>
                                        @if (!string.IsNullOrEmpty(result.ImportShipment.ConsigneePhone))
                                        {
                                            <div class="route-phone">@result.ImportShipment.ConsigneePhone</div>
                                        }
                                    </div>
                                </div>

                                <MudDivider Class="my-4" />

                                <div class="specs-grid">
                                    <div class="spec-item">
                                        <label>Type</label>
                                        <MudChip T="string" Size="Size.Small" Color="@(result.ImportShipment.ShipmentType == ImportShipmentType.Document ? Color.Info : Color.Warning)" Style="margin-top: -4px;">
                                            @(result.ImportShipment.ShipmentType == ImportShipmentType.Document ? "DOCS" : "NON-DOCS")
                                        </MudChip>
                                    </div>
                                    <div class="spec-item">
                                        <label>Pieces</label>
                                        <div class="value">@result.ImportShipment.Pieces</div>
                                    </div>
                                    <div class="spec-item">
                                        <label>Weight</label>
                                        <div class="value">@((result.ImportShipment.ChargeableWeight ?? result.ImportShipment.Weight).ToString("0.00")) kg</div>
                                    </div>
                                    <div class="spec-item">
                                        <label>Payment</label>
                                        <div class="value">@result.ImportShipment.PaymentMode.ToString()</div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(result.ImportShipment.ContentsDescription))
                                    {
                                        <div class="spec-item" style="grid-column: span 2;">
                                            <label>Contents</label>
                                            <div class="value">@result.ImportShipment.ContentsDescription</div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(result.ImportShipment.ReferenceNo))
                                    {
                                        <div class="spec-item">
                                            <label>Reference</label>
                                            <div class="value">@result.ImportShipment.ReferenceNo</div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(result.ImportShipment.HSCode))
                                    {
                                        <div class="spec-item">
                                            <label>HS Code</label>
                                            <div class="value">@result.ImportShipment.HSCode</div>
                                        </div>
                                    }
                                </div>

                                @if (result.ImportShipment.Status == ImportShipmentStatus.HandedOver && result.ImportShipment.HandedOverAt.HasValue)
                                {
                                    <MudAlert Severity="Severity.Success" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.CheckCircle">
                                        Handed over on: @DateTimeService.FormatDate(result.ImportShipment.HandedOverAt, "dd MMM yyyy")
                                    </MudAlert>
                                }
                                else if (result.ImportShipment.Status == ImportShipmentStatus.Inscanned && result.ImportShipment.InscannedAt.HasValue)
                                {
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.Inventory">
                                        Inscanned on: @DateTimeService.FormatDate(result.ImportShipment.InscannedAt, "dd MMM yyyy")
                                    </MudAlert>
                                }
                            </div>

                            <div class="tracking-footer d-flex justify-space-between align-center">
                                <MudText Typo="Typo.body2" Style="color: #6b7280;">Total Customs Charges</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">
                                    @(result.ImportShipment.Currency ?? AuthState.CurrencyCode) @((result.ImportShipment.TotalCustomsCharges ?? 0).ToString("N2"))
                                </MudText>
                            </div>
                        </div>

                        @if (result.ImportShipment.IsCOD && (result.ImportShipment.CODAmount ?? 0) > 0)
                        {
                            <div class="tracking-main-card mt-4 pa-4">
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">COD Details</MudText>
                                </div>
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.body2" Style="color: #6b7280;">Amount to Collect</MudText>
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@(result.ImportShipment.Currency ?? AuthState.CurrencyCode) @result.ImportShipment.CODAmount?.ToString("N2")</MudText>
                                </div>
                            </div>
                        }
                    </MudItem>

                    <MudItem xs="12" lg="4">
                        <div class="timeline-card">
                            <div class="timeline-header">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                Tracking History
                            </div>
                            
                            <div class="timeline-content">
                                @if (result.Timeline.Any())
                                {
                                    <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineAlign="TimelineAlign.Default" DisableModifiers="true">
                                        @foreach (var eventItem in result.Timeline.OrderByDescending(t => t.Timestamp))
                                        {
                                            <MudTimelineItem Color="@GetImportEventColor(eventItem.EventType)" Size="Size.Small" Variant="Variant.Filled">
                                                <ItemContent>
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1f2937;">
                                                        @eventItem.EventType
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(eventItem.UserName))
                                                    {
                                                        <MudText Typo="Typo.caption" Style="color: #6b7280;">By: @eventItem.UserName</MudText>
                                                    }
                                                    <MudText Typo="Typo.caption" Style="color: #9ca3af; margin-top: 4px;">
                                                        @DateTimeService.FormatDateTime(eventItem.Timestamp, "dd MMM yyyy, HH:mm")
                                                    </MudText>
                                                </ItemContent>
                                            </MudTimelineItem>
                                        }
                                    </MudTimeline>
                                }
                                else
                                {
                                    <div class="text-center pa-4">
                                        <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Large" Style="color: #d1d5db; margin-bottom: 8px;" />
                                        <MudText Typo="Typo.body2" Style="color: #9ca3af;">
                                            No tracking events recorded yet.
                                        </MudText>
                                    </div>
                                }
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
                
                @if (_importTrackingResults.Count > 1 && result != _importTrackingResults.Last())
                {
                    <MudDivider Class="my-6" />
                }
            }
        }
        
        @if (!_shipmentResults.Any() && !_importTrackingResults.Any() && !_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                Please enter one or more AWB numbers to track.
            </MudAlert>
        }
    }
</MudContainer>

@code {
    [Parameter] public string? AWBNumber { get; set; }
    [SupplyParameterFromQuery(Name = "awb")] public string? AwbQuery { get; set; }
    
    private enum SearchType { AWBNumber, PickupRequestNumber, ReferenceNumber }
    
    private string _searchTerm = "";
    private SearchType _searchType = SearchType.AWBNumber;
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private List<ShipmentTrackingResult> _shipmentResults = new();
    private List<ImportTrackingResult> _importTrackingResults = new();
    private List<string> _notFoundAwbs = new();

    private class ShipmentTrackingResult
    {
        public InscanMaster Shipment { get; set; } = null!;
        public List<ShipmentStatusHistory> Timeline { get; set; } = new();
        public string? ServiceTypeName { get; set; }
    }

    private class ImportTrackingResult
    {
        public ImportShipment ImportShipment { get; set; } = null!;
        public List<ImportTimelineEvent> Timeline { get; set; } = new();
    }

    private class ImportTimelineEvent
    {
        public string EventType { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public string? UserName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(AWBNumber))
        {
            _searchTerm = AWBNumber;
            await TrackShipments();
        }
        else if (!string.IsNullOrEmpty(AwbQuery))
        {
            _searchTerm = AwbQuery;
            await TrackShipments();
        }
    }

    private string GetSearchLabel() => _searchType switch
    {
        SearchType.AWBNumber => "AWB Number",
        SearchType.PickupRequestNumber => "Pickup Request Number",
        SearchType.ReferenceNumber => "Reference Number",
        _ => "AWB Number"
    };

    private string GetSearchPlaceholder() => _searchType switch
    {
        SearchType.AWBNumber => "Enter AWB number(s), separated by commas...",
        SearchType.PickupRequestNumber => "Enter pickup request number...",
        SearchType.ReferenceNumber => "Enter reference number...",
        _ => "Enter number..."
    };

    private async Task TrackShipments()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
            return;

        _isLoading = true;
        _hasSearched = true;
        _shipmentResults.Clear();
        _importTrackingResults.Clear();
        _notFoundAwbs.Clear();

        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            
            var searchTerms = _searchTerm.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                         .Select(s => s.Trim())
                                         .Where(s => !string.IsNullOrEmpty(s))
                                         .Distinct()
                                         .ToList();

            foreach (var term in searchTerms)
            {
                var found = false;

                if (_searchType == SearchType.AWBNumber)
                {
                    var shipment = await dbContext.InscanMasters
                        .FirstOrDefaultAsync(i => i.AWBNo == term && !i.IsDeleted);

                    if (shipment != null)
                    {
                        var timeline = await dbContext.ShipmentStatusHistories
                            .Include(t => t.Status)
                            .Where(t => t.InscanMasterId == shipment.Id)
                            .OrderByDescending(t => t.ChangedAt)
                            .ToListAsync();

                        var serviceTypeName = shipment.ShipmentModeId.HasValue 
                            ? (await dbContext.ShipmentModes.FindAsync(shipment.ShipmentModeId.Value))?.Name 
                            : null;

                        _shipmentResults.Add(new ShipmentTrackingResult
                        {
                            Shipment = shipment,
                            Timeline = timeline,
                            ServiceTypeName = serviceTypeName ?? "Standard"
                        });
                        found = true;
                    }

                    var importShipments = await dbContext.ImportShipments
                        .Include(i => i.ImportMaster)
                        .Where(i => i.AWBNo == term && !i.IsDeleted)
                        .ToListAsync();

                    foreach (var importShipment in importShipments)
                    {
                        _importTrackingResults.Add(new ImportTrackingResult
                        {
                            ImportShipment = importShipment,
                            Timeline = BuildImportTimeline(importShipment)
                        });
                        found = true;
                    }
                }
                else if (_searchType == SearchType.PickupRequestNumber)
                {
                    if (!long.TryParse(term, out var pickupRequestId))
                        continue;
                    
                    var shipments = await dbContext.InscanMasters
                        .Where(i => i.PickupRequestId == pickupRequestId && !i.IsDeleted)
                        .ToListAsync();

                    foreach (var shipment in shipments)
                    {
                        var timeline = await dbContext.ShipmentStatusHistories
                            .Include(t => t.Status)
                            .Where(t => t.InscanMasterId == shipment.Id)
                            .OrderByDescending(t => t.ChangedAt)
                            .ToListAsync();

                        var serviceTypeName = shipment.ShipmentModeId.HasValue 
                            ? (await dbContext.ShipmentModes.FindAsync(shipment.ShipmentModeId.Value))?.Name 
                            : null;

                        _shipmentResults.Add(new ShipmentTrackingResult
                        {
                            Shipment = shipment,
                            Timeline = timeline,
                            ServiceTypeName = serviceTypeName ?? "Standard"
                        });
                        found = true;
                    }
                }
                else if (_searchType == SearchType.ReferenceNumber)
                {
                    var shipments = await dbContext.InscanMasters
                        .Where(i => i.ReferenceNo == term && !i.IsDeleted)
                        .ToListAsync();

                    foreach (var shipment in shipments)
                    {
                        var timeline = await dbContext.ShipmentStatusHistories
                            .Include(t => t.Status)
                            .Where(t => t.InscanMasterId == shipment.Id)
                            .OrderByDescending(t => t.ChangedAt)
                            .ToListAsync();

                        var serviceTypeName = shipment.ShipmentModeId.HasValue 
                            ? (await dbContext.ShipmentModes.FindAsync(shipment.ShipmentModeId.Value))?.Name 
                            : null;

                        _shipmentResults.Add(new ShipmentTrackingResult
                        {
                            Shipment = shipment,
                            Timeline = timeline,
                            ServiceTypeName = serviceTypeName ?? "Standard"
                        });
                        found = true;
                    }

                    var importShipments = await dbContext.ImportShipments
                        .Include(i => i.ImportMaster)
                        .Where(i => i.ReferenceNo == term && !i.IsDeleted)
                        .ToListAsync();

                    foreach (var importShipment in importShipments)
                    {
                        _importTrackingResults.Add(new ImportTrackingResult
                        {
                            ImportShipment = importShipment,
                            Timeline = BuildImportTimeline(importShipment)
                        });
                        found = true;
                    }
                }

                if (!found)
                {
                    _notFoundAwbs.Add(term);
                }
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(CourierStatus status) => status switch
    {
        CourierStatus.Delivered => Color.Success,
        CourierStatus.OutForDelivery => Color.Info,
        CourierStatus.InTransit => Color.Primary,
        CourierStatus.Pending => Color.Warning,
        CourierStatus.NotDelivered => Color.Error,
        CourierStatus.ReturnToOrigin => Color.Error,
        _ => Color.Default
    };

    private string GetStatusDisplayName(CourierStatus status) => status switch
    {
        CourierStatus.Delivered => "Delivered",
        CourierStatus.OutForDelivery => "Out for Delivery",
        CourierStatus.InTransit => "In Transit",
        CourierStatus.Pending => "Pending",
        CourierStatus.NotDelivered => "Not Delivered",
        CourierStatus.ReturnToOrigin => "Return to Origin",
        _ => status.ToString()
    };

    private Color GetEventColor(ShipmentStatusHistory entry)
    {
        if (entry.Status == null)
            return Color.Default;
            
        return entry.Status.Code switch
        {
            "DELIVERED" => Color.Success,
            "OUT_FOR_DELIVERY" or "OFD" => Color.Info,
            "IN_TRANSIT" => Color.Primary,
            "PICKED_UP" or "PICKUP_DONE" => Color.Success,
            "EXCEPTION" or "FAILED" => Color.Error,
            _ => Color.Default
        };
    }

    private string GetOriginFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsignorCity)) parts.Add(shipment.ConsignorCity);
        if (!string.IsNullOrEmpty(shipment.ConsignorPostalCode)) parts.Add(shipment.ConsignorPostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsignorCountry)) parts.Add(shipment.ConsignorCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private string GetDestinationFull(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsigneeCity)) parts.Add(shipment.ConsigneeCity);
        if (!string.IsNullOrEmpty(shipment.ConsigneePostalCode)) parts.Add(shipment.ConsigneePostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsigneeCountry)) parts.Add(shipment.ConsigneeCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private Color GetImportStatusColor(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.HandedOver => Color.Success,
        ImportShipmentStatus.Released => Color.Info,
        ImportShipmentStatus.ReceivedAtWarehouse => Color.Secondary,
        ImportShipmentStatus.Inscanned => Color.Primary,
        ImportShipmentStatus.Expected => Color.Warning,
        _ => Color.Default
    };

    private Color GetCODStatusColor(InscanMaster shipment)
    {
        if (shipment.CODCollected)
            return Color.Success;
        return Color.Warning;
    }

    private string GetCODStatusText(InscanMaster shipment)
    {
        if (shipment.CODCollected)
            return "Collected";
        return "Pending";
    }

    private void EditShipment(long id)
    {
        NavigationManager.NavigateTo($"/awb-entry/{id}");
    }

    private async Task PrintAWBA5(long id)
    {
        await OpenPdfPreview($"/api/report/awb/{id}", "AWB Print");
    }

    private async Task PrintLabel(long id)
    {
        await OpenPdfPreview($"/api/report/awb-label/{id}", "AWB Label");
    }

    private async Task PrintDutyReceipt(long id)
    {
        await OpenPdfPreview($"/api/report/duty-receipt/{id}", "Duty Receipt");
    }

    private async Task PrintTrackingDetails(ShipmentTrackingResult result)
    {
        if (result?.Shipment?.AWBNo != null)
        {
            await OpenPdfPreview($"/api/report/tracking/{result.Shipment.AWBNo}", "Tracking Details");
        }
    }

    private async Task OpenPdfPreview(string url, string title)
    {
        var parameters = new DialogParameters<PdfPreviewDialog>
        {
            { x => x.PdfUrl, url },
            { x => x.Title, title }
        };
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseOnEscapeKey = true,
            NoHeader = false
        };
        await DialogService.ShowAsync<PdfPreviewDialog>(title, parameters, options);
    }

    private async Task OpenChangeStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog> { { x => x.Shipment, shipment } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Status", parameters, options);
        var result = await dialog.Result;
        
        if (!result!.Canceled)
        {
            await TrackShipments();
        }
    }

    private decimal CalculateTotalCharges(InscanMaster shipment)
    {
        if (shipment.NetTotal.HasValue && shipment.NetTotal.Value > 0)
            return shipment.NetTotal.Value;
        
        var courierCharge = shipment.CourierCharge ?? 0;
        var otherCharge = shipment.OtherCharge ?? 0;
        var fuelSurcharge = shipment.FuelSurcharge ?? 0;
        var taxPercent = shipment.TaxPercent ?? 0;
        var discount = shipment.Discount ?? 0;
        var dutyVat = shipment.DutyVatAmount ?? 0;
        var cod = shipment.CODAmount ?? 0;
        
        var subtotal = courierCharge + otherCharge + fuelSurcharge;
        var taxAmount = subtotal * (taxPercent / 100);
        var total = subtotal + taxAmount - discount + dutyVat + cod;
        
        return total;
    }

    private List<ImportTimelineEvent> BuildImportTimeline(ImportShipment shipment)
    {
        var timeline = new List<ImportTimelineEvent>();
        
        timeline.Add(new ImportTimelineEvent
        {
            EventType = "Shipment Created",
            Timestamp = shipment.CreatedAt
        });

        if (shipment.InscannedAt.HasValue)
        {
            timeline.Add(new ImportTimelineEvent
            {
                EventType = "Inscanned",
                Timestamp = shipment.InscannedAt.Value,
                UserName = shipment.InscannedByUserName
            });
        }

        if (shipment.CustomsClearedAt.HasValue)
        {
            timeline.Add(new ImportTimelineEvent
            {
                EventType = "Customs Cleared",
                Timestamp = shipment.CustomsClearedAt.Value,
                UserName = shipment.CustomsClearedByUserName
            });
        }

        if (shipment.ReleasedAt.HasValue)
        {
            timeline.Add(new ImportTimelineEvent
            {
                EventType = "Released",
                Timestamp = shipment.ReleasedAt.Value,
                UserName = shipment.ReleasedByUserName
            });
        }

        if (shipment.HandedOverAt.HasValue)
        {
            timeline.Add(new ImportTimelineEvent
            {
                EventType = "Handed Over",
                Timestamp = shipment.HandedOverAt.Value,
                UserName = shipment.HandedOverToUserName
            });
        }

        return timeline;
    }

    private string GetImportOriginFull(ImportShipment shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ShipperCity)) parts.Add(shipment.ShipperCity);
        if (!string.IsNullOrEmpty(shipment.ShipperCountry)) parts.Add(shipment.ShipperCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private string GetImportDestinationFull(ImportShipment shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsigneeCity)) parts.Add(shipment.ConsigneeCity);
        if (!string.IsNullOrEmpty(shipment.ConsigneePostalCode)) parts.Add(shipment.ConsigneePostalCode);
        if (!string.IsNullOrEmpty(shipment.ConsigneeCountry)) parts.Add(shipment.ConsigneeCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private Color GetImportEventColor(string eventType) => eventType switch
    {
        "Handed Over" => Color.Success,
        "Released" => Color.Info,
        "Customs Cleared" => Color.Primary,
        "Inscanned" => Color.Secondary,
        "Shipment Created" => Color.Default,
        _ => Color.Default
    };

    private async Task PrintImportAWBA5(string awbNo)
    {
        await OpenPdfPreview($"/api/report/awb-by-awbno/{awbNo}", "AWB Print");
    }

    private async Task PrintImportLabel(string awbNo)
    {
        await OpenPdfPreview($"/api/report/awb-label-by-awbno/{awbNo}", "AWB Label");
    }

    private async Task PrintImportDutyReceipt(string awbNo)
    {
        await OpenPdfPreview($"/api/report/duty-receipt-by-awbno/{awbNo}", "Duty Receipt");
    }

    private async Task PrintImportTrackingDetails(ImportTrackingResult result)
    {
        if (result?.ImportShipment?.AWBNo != null)
        {
            await OpenPdfPreview($"/api/report/tracking/{result.ImportShipment.AWBNo}", "Tracking Details");
        }
    }
}

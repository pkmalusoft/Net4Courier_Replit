@page "/tracking"
@page "/tracking/{AWBNumber}"
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using Net4Courier.Kernel.Enums
@inject ApplicationDbContext DbContext
@inject ShipmentStatusService StatusService
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Track Your Shipment | Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-8">
    <MudPaper Elevation="3" Class="pa-8 mb-6 text-center">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">Track Your Shipment</MudText>
        <MudText Typo="Typo.body1" Class="mb-6">Enter your AWB or Reference Number(s) to get the latest status. Separate multiple numbers with commas.</MudText>
        
        <MudGrid Justify="Justify.Center">
            <MudItem xs="12" sm="8" md="6">
                <MudTextField @bind-Value="_searchTerm" 
                              Label="Enter Tracking Number(s)" 
                              Placeholder="e.g., AWB001, AWB002, AWB003"
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              OnAdornmentClick="TrackShipments"
                              Immediate="true"
                              HelperText="Separate multiple AWB numbers with commas"
                              OnKeyDown="@(async e => { if (e.Key == "Enter") await TrackShipments(); })" />
            </MudItem>
            <MudItem xs="12" sm="4" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           OnClick="TrackShipments" 
                           FullWidth="true"
                           Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ms-2">Searching...</MudText>
                    }
                    else
                    {
                        <MudText>Track</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasSearched && !_isLoading)
    {
        @if (_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                <MudText>The following AWB number(s) were not found: <strong>@string.Join(", ", _notFoundAwbs)</strong></MudText>
            </MudAlert>
        }

        @if (_shipmentResults.Any())
        {
            <MudText Typo="Typo.h6" Class="mb-4">Found @_shipmentResults.Count shipment(s)</MudText>
            
            @foreach (var result in _shipmentResults)
            {
                <MudExpansionPanels Class="mb-4" Elevation="3">
                    <MudExpansionPanel @bind-IsExpanded="result.IsExpanded">
                        <TitleContent>
                            <div class="d-flex align-center gap-4">
                                <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Color="Color.Primary" />
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.subtitle1"><strong>@result.Shipment.AWBNo</strong></MudText>
                                    <MudText Typo="Typo.caption">@result.Shipment.Consignor â†’ @result.Shipment.Consignee</MudText>
                                </div>
                                <MudChip T="string" Color="@GetStatusColor(result.Shipment.CourierStatusId)" Size="Size.Small">
                                    @GetStatusDisplayName(result.Shipment.CourierStatusId)
                                </MudChip>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            <MudGrid>
                                <MudItem xs="12" md="4">
                                    <MudCard Elevation="0" Class="h-100" Style="background-color: var(--mud-palette-background-grey);">
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudText Typo="Typo.h6">Shipment Details</MudText>
                                            </CardHeaderContent>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudList T="string" Dense="true">
                                                <MudListItem Icon="@Icons.Material.Filled.Person">
                                                    <MudText Typo="Typo.caption">Sender</MudText>
                                                    <MudText>@(result.Shipment.Consignor ?? "N/A")</MudText>
                                                </MudListItem>
                                                <MudListItem Icon="@Icons.Material.Filled.PersonOutline">
                                                    <MudText Typo="Typo.caption">Receiver</MudText>
                                                    <MudText>@(result.Shipment.Consignee ?? "N/A")</MudText>
                                                </MudListItem>
                                                <MudDivider Class="my-2"/>
                                                <MudListItem Icon="@Icons.Material.Filled.Place">
                                                    <MudText Typo="Typo.caption">Origin</MudText>
                                                    <MudText>@GetOrigin(result.Shipment)</MudText>
                                                </MudListItem>
                                                <MudListItem Icon="@Icons.Material.Filled.Flag">
                                                    <MudText Typo="Typo.caption">Destination</MudText>
                                                    <MudText>@GetDestination(result.Shipment)</MudText>
                                                </MudListItem>
                                                <MudDivider Class="my-2"/>
                                                <MudListItem Icon="@Icons.Material.Filled.Scale">
                                                    <MudText Typo="Typo.caption">Weight / Pieces</MudText>
                                                    <MudText>@((result.Shipment.ChargeableWeight ?? result.Shipment.Weight ?? 0).ToString("0.00")) kg / @(result.Shipment.Pieces ?? 1) pcs</MudText>
                                                </MudListItem>
                                                <MudListItem Icon="@Icons.Material.Filled.CalendarToday">
                                                    <MudText Typo="Typo.caption">Booking Date</MudText>
                                                    <MudText>@result.Shipment.TransactionDate.ToString("dd MMM yyyy")</MudText>
                                                </MudListItem>
                                            </MudList>
                                        </MudCardContent>
                                        <MudCardActions Class="pa-4">
                                            <MudButton Variant="Variant.Filled" 
                                                       Color="Color.Secondary" 
                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                       OnClick="@(() => OpenUpdateStatusDialog(result.Shipment))"
                                                       FullWidth="true">
                                                Update Status
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>

                                <MudItem xs="12" md="8">
                                    <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudText Typo="Typo.h6">Tracking History</MudText>
                                            </CardHeaderContent>
                                            <CardHeaderActions>
                                                <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="@(() => LoadTimeline(result))" />
                                            </CardHeaderActions>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            @if (result.Timeline.Any())
                                            {
                                                <MudTimeline TimelinePosition="TimelinePosition.Start">
                                                    @foreach (var eventItem in result.Timeline.OrderByDescending(t => t.ChangedAt))
                                                    {
                                                        <MudTimelineItem Color="@GetEventColor(eventItem)" Size="Size.Small">
                                                            <ItemOpposite>
                                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                    @eventItem.ChangedAt.ToLocalTime().ToString("dd MMM yyyy")
                                                                </MudText>
                                                                <MudText Typo="Typo.caption" Style="display:block">
                                                                    @eventItem.ChangedAt.ToLocalTime().ToString("HH:mm")
                                                                </MudText>
                                                            </ItemOpposite>
                                                            <ItemContent>
                                                                <MudText Typo="Typo.subtitle2">@(eventItem.Status?.Name ?? eventItem.EventType)</MudText>
                                                                <MudText Typo="Typo.body2">@(eventItem.LocationName ?? eventItem.StatusGroup?.Name)</MudText>
                                                                @if (!string.IsNullOrEmpty(eventItem.Remarks))
                                                                {
                                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@eventItem.Remarks</MudText>
                                                                }
                                                                @if (!string.IsNullOrEmpty(eventItem.UserName))
                                                                {
                                                                    <MudText Typo="Typo.caption" Class="mud-text-disabled">By: @eventItem.UserName</MudText>
                                                                }
                                                            </ItemContent>
                                                        </MudTimelineItem>
                                                    }
                                                </MudTimeline>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center pa-4">
                                                    No tracking events recorded yet.
                                                </MudText>
                                            }
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            </MudGrid>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        }
        else if (!_notFoundAwbs.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                Please enter one or more AWB numbers to track.
            </MudAlert>
        }
    }
</MudContainer>

@code {
    [Parameter] public string? AWBNumber { get; set; }
    
    private string _searchTerm = "";
    private bool _isLoading = false;
    private bool _hasSearched = false;
    private List<ShipmentTrackingResult> _shipmentResults = new();
    private List<string> _notFoundAwbs = new();

    private class ShipmentTrackingResult
    {
        public InscanMaster Shipment { get; set; } = null!;
        public List<ShipmentStatusHistory> Timeline { get; set; } = new();
        public bool IsExpanded { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(AWBNumber))
        {
            _searchTerm = AWBNumber;
            await TrackShipments();
        }
    }

    private async Task TrackShipments()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm)) return;

        _isLoading = true;
        _hasSearched = true;
        _shipmentResults.Clear();
        _notFoundAwbs.Clear();
        StateHasChanged();

        try
        {
            var awbNumbers = _searchTerm
                .Split(new[] { ',', ';', '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(a => a.Trim().ToUpper())
                .Where(a => !string.IsNullOrEmpty(a))
                .Distinct()
                .ToList();

            foreach (var awb in awbNumbers)
            {
                var shipment = await DbContext.InscanMasters
                    .FirstOrDefaultAsync(i => i.AWBNo == awb || i.ReferenceNo == awb);

                if (shipment != null)
                {
                    var result = new ShipmentTrackingResult
                    {
                        Shipment = shipment,
                        IsExpanded = awbNumbers.Count == 1
                    };
                    
                    result.Timeline = await StatusService.GetTimeline(shipment.Id);
                    _shipmentResults.Add(result);
                }
                else
                {
                    _notFoundAwbs.Add(awb);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error tracking shipments: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTimeline(ShipmentTrackingResult result)
    {
        result.Timeline = await StatusService.GetTimeline(result.Shipment.Id);
        StateHasChanged();
    }

    private string GetOrigin(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsignorCity)) parts.Add(shipment.ConsignorCity);
        if (!string.IsNullOrEmpty(shipment.ConsignorCountry)) parts.Add(shipment.ConsignorCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private string GetDestination(InscanMaster shipment)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(shipment.ConsigneeCity)) parts.Add(shipment.ConsigneeCity);
        if (!string.IsNullOrEmpty(shipment.ConsigneeCountry)) parts.Add(shipment.ConsigneeCountry);
        return parts.Any() ? string.Join(", ", parts) : "N/A";
    }

    private Color GetStatusColor(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Delivered => Color.Success,
            CourierStatus.OutForDelivery => Color.Info,
            CourierStatus.InTransit or CourierStatus.InscanAtDestination => Color.Primary,
            CourierStatus.NotDelivered or CourierStatus.ReturnToOrigin or CourierStatus.Cancelled => Color.Error,
            CourierStatus.OnHold => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetStatusDisplayName(CourierStatus status)
    {
        return status switch
        {
            CourierStatus.Pending => "Pending",
            CourierStatus.AssignedToPickup => "Assigned for Pickup",
            CourierStatus.PickedUp => "Picked Up",
            CourierStatus.InscanAtOrigin => "At Origin Hub",
            CourierStatus.InTransit => "In Transit",
            CourierStatus.InscanAtDestination => "At Destination Hub",
            CourierStatus.OutForDelivery => "Out for Delivery",
            CourierStatus.Delivered => "Delivered",
            CourierStatus.NotDelivered => "Delivery Failed",
            CourierStatus.ReturnToOrigin => "Returning",
            CourierStatus.Returned => "Returned",
            CourierStatus.OnHold => "On Hold",
            CourierStatus.Cancelled => "Cancelled",
            _ => status.ToString()
        };
    }

    private Color GetEventColor(ShipmentStatusHistory eventItem)
    {
        if (eventItem.Status?.IsTerminal == true) return Color.Success;
        if (eventItem.Status?.IsException == true) return Color.Error;
        
        var groupCode = eventItem.StatusGroup?.Code ?? "";
        return groupCode switch
        {
            "DELIVERY" => Color.Success,
            "EXCEPTION" => Color.Error,
            "TRANSIT" => Color.Primary,
            "COLLECTION" => Color.Info,
            _ => Color.Default
        };
    }

    private async Task OpenUpdateStatusDialog(InscanMaster shipment)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.Shipment, shipment }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Update Shipment Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            var trackingResult = _shipmentResults.FirstOrDefault(r => r.Shipment.Id == shipment.Id);
            if (trackingResult != null)
            {
                await LoadTimeline(trackingResult);
                trackingResult.Shipment = await DbContext.InscanMasters.FirstOrDefaultAsync(i => i.Id == shipment.Id) ?? shipment;
            }
            StateHasChanged();
        }
    }
}

@page "/drs-cash-receipt"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject DRSReconciliationService ReconciliationService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>DRS Cash Receipt</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5">DRS Cash Receipt - Accountant</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenNewReceiptDialog">
            New Receipt
        </MudButton>
    </MudStack>

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudDatePicker Label="Date" @bind-Date="_filterDate" DateFormat="dd-MMM-yyyy" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        </MudItem>
        <MudItem xs="12" md="4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadPendingSubmissions">
                Search
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="mt-4" />
    }
    else
    {
        <MudTable Items="@_submissions" Dense="true" Hover="true" Class="mt-4">
            <HeaderContent>
                <MudTh>Receipt No</MudTh>
                <MudTh>DRS No</MudTh>
                <MudTh>Date</MudTh>
                <MudTh>Courier</MudTh>
                <MudTh>Expected</MudTh>
                <MudTh>Received</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@(context.ReceiptNo ?? "-")</MudTd>
                <MudTd>@context.DRS?.DRSNo</MudTd>
                <MudTd>@context.SubmissionDate.ToString("dd-MMM-yyyy")</MudTd>
                <MudTd>@context.CourierName</MudTd>
                <MudTd Class="text-right">@context.CashSubmittedAmount.ToString("N2")</MudTd>
                <MudTd Class="text-right">@((context.ReceivedAmount ?? 0).ToString("N2"))</MudTd>
                <MudTd>
                    @if (context.IsAcknowledged)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Received</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Pending</MudChip>
                    }
                </MudTd>
                <MudTd>
                    @if (!context.IsAcknowledged)
                    {
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary"
                                   OnClick="@(() => OpenReceiptDialog(context))">
                            Receive
                        </MudButton>
                    }
                    else
                    {
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Print" Size="Size.Small" Color="Color.Default"
                                           OnClick="@(() => PrintReceipt(context.Id))" Title="Print" />
                            <MudIconButton Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Default"
                                           OnClick="@(() => OpenEmailDialog(context))" Title="Email" />
                            <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Info"
                                       OnClick="@(() => GoToReconcile(context.DRSId, context.Id))">
                                Reconcile
                            </MudButton>
                        </MudStack>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No receipts found for selected date</MudText>
            </NoRecordsContent>
        </MudTable>

        <MudExpansionPanels Class="mt-4">
            <MudExpansionPanel Text="Today's Summary" InitiallyExpanded="true">
                <MudGrid>
                    <MudItem xs="6" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0">
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_pendingCount</MudText>
                            <MudText Typo="Typo.caption">Pending Receipts</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0">
                            <MudText Typo="Typo.h4" Color="Color.Success">@_acknowledgedCount</MudText>
                            <MudText Typo="Typo.caption">Acknowledged</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0">
                            <MudText Typo="Typo.h6" Color="Color.Warning">@_pendingAmount.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption">Pending Amount</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0">
                            <MudText Typo="Typo.h6" Color="Color.Success">@_receivedAmount.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption">Received Amount</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudContainer>

<MudDialog @bind-Visible="_showNewReceiptDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Issue New Cash Receipt</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudAutocomplete T="DRS" Label="Select DRS" @bind-Value="_selectedDRS"
                                 SearchFunc="SearchDRS" ToStringFunc="@(d => d == null ? "" : $"{d.DRSNo} | {d.DRSDate:dd-MMM-yyyy} | {d.DeliveryEmployeeName}")"
                                 Variant="Variant.Outlined" Dense="true" ShowProgressIndicator="true">
                    <ItemTemplate Context="drs">
                        <MudText>@drs.DRSNo | @drs.DRSDate.ToString("dd-MMM-yyyy") | @drs.DeliveryEmployeeName</MudText>
                    </ItemTemplate>
                </MudAutocomplete>
            </MudItem>

            <MudItem xs="6">
                <MudText Typo="Typo.caption">Courier</MudText>
                <MudText Typo="Typo.body1">@(_selectedDRS?.DeliveryEmployeeName ?? "-")</MudText>
            </MudItem>
            <MudItem xs="6">
                <MudText Typo="Typo.caption">DRS Date</MudText>
                <MudText Typo="Typo.body1">@(_selectedDRS?.DRSDate.ToString("dd-MMM-yyyy") ?? "-")</MudText>
            </MudItem>
            <MudItem xs="12">
                <MudText Typo="Typo.caption">Expected Collection</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary">@((_selectedDRS?.ExpectedTotal ?? 0).ToString("N2"))</MudText>
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
            </MudItem>
            <MudItem xs="12">
                <MudNumericField @bind-Value="_newReceiptAmount" Label="Cash Received" Format="N2"
                                 Adornment="Adornment.Start" AdornmentText="₹" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_newReceiptRemarks" Label="Remarks" Lines="2" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showNewReceiptDialog = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="IssueNewReceipt" 
                   Disabled="@(_saving || _selectedDRS == null)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Issue Receipt
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_showReceiptDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Acknowledge Cash Receipt</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedSubmission != null)
        {
            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption">DRS No</MudText>
                    <MudText Typo="Typo.body1">@_selectedSubmission.DRS?.DRSNo</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption">Courier</MudText>
                    <MudText Typo="Typo.body1">@_selectedSubmission.CourierName</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Submitted Amount</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@_selectedSubmission.CashSubmittedAmount.ToString("N2")</MudText>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudNumericField @bind-Value="_receivedCashAmount" Label="Received Amount" Format="N2"
                             Adornment="Adornment.Start" AdornmentText="₹" Variant="Variant.Outlined" Class="mb-4" />

            @if (_receivedCashAmount != _selectedSubmission.CashSubmittedAmount)
            {
                <MudAlert Severity="@(_receivedCashAmount < _selectedSubmission.CashSubmittedAmount ? Severity.Warning : Severity.Info)" Class="mb-4">
                    Difference: @((_receivedCashAmount - _selectedSubmission.CashSubmittedAmount).ToString("N2"))
                </MudAlert>
            }

            <MudTextField @bind-Value="_receiptRemarks" Label="Remarks" Lines="2" Variant="Variant.Outlined" />
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showReceiptDialog = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AcknowledgeReceipt" Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Acknowledge Receipt
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_showEmailDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Email Cash Receipt</MudText>
    </TitleContent>
    <DialogContent>
        @if (_emailSubmission != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Receipt</MudText>
                    <MudText Typo="Typo.body1">@_emailSubmission.ReceiptNo - @_emailSubmission.CourierName</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_emailAddress" Label="Email Address" Variant="Variant.Outlined"
                                  Placeholder="Enter recipient email" Required="true" />
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showEmailDialog = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendEmail" 
                   Disabled="@(_sending || string.IsNullOrEmpty(_emailAddress))">
            @if (_sending)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Send Email
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading;
    private bool _saving;
    private DateTime? _filterDate = DateTime.UtcNow.Date;
    private List<CourierCashSubmission> _submissions = new();
    
    private int _pendingCount;
    private int _acknowledgedCount;
    private decimal _pendingAmount;
    private decimal _receivedAmount;

    private bool _showReceiptDialog;
    private CourierCashSubmission? _selectedSubmission;
    private decimal _receivedCashAmount;
    private string? _receiptRemarks;

    private bool _showNewReceiptDialog;
    private DRS? _selectedDRS;
    private decimal _newReceiptAmount;
    private string? _newReceiptRemarks;

    private bool _showEmailDialog;
    private bool _sending;
    private CourierCashSubmission? _emailSubmission;
    private string? _emailAddress;

    protected override async Task OnInitializedAsync()
    {
        await LoadPendingSubmissions();
    }

    private async Task LoadPendingSubmissions()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var query = context.CourierCashSubmissions
                .Include(c => c.DRS)
                .AsQueryable();

            if (_filterDate.HasValue)
            {
                var date = DateTime.SpecifyKind(_filterDate.Value.Date, DateTimeKind.Utc);
                query = query.Where(c => c.SubmissionDate.Date == date);
            }

            _submissions = await query.OrderByDescending(c => c.SubmissionTime).ToListAsync();

            _pendingCount = _submissions.Count(s => !s.IsAcknowledged);
            _acknowledgedCount = _submissions.Count(s => s.IsAcknowledged);
            _pendingAmount = _submissions.Where(s => !s.IsAcknowledged).Sum(s => s.CashSubmittedAmount);
            _receivedAmount = _submissions.Where(s => s.IsAcknowledged).Sum(s => s.ReceivedAmount ?? 0);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<DRS>> SearchDRS(string value, CancellationToken token)
    {
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var existingDrsIds = await context.CourierCashSubmissions
                .Select(c => c.DRSId)
                .Distinct()
                .ToListAsync(token);

            var query = context.DRSs
                .Include(d => d.Details)
                .AsNoTracking()
                .Where(d => !d.IsDeleted && d.Status != DRSStatus.Reconciled && !existingDrsIds.Contains(d.Id))
                .AsQueryable();

            if (!string.IsNullOrEmpty(value))
            {
                query = query.Where(d => d.DRSNo.Contains(value) || 
                                         (d.DeliveryEmployeeName != null && d.DeliveryEmployeeName.Contains(value)));
            }

            var results = await query
                .OrderByDescending(d => d.DRSDate)
                .Take(20)
                .ToListAsync(token);

            foreach (var drs in results)
            {
                if ((drs.ExpectedTotal ?? 0) == 0 && drs.Details.Any())
                {
                    drs.ExpectedTotal = drs.Details.Sum(d => d.CollectedAmount ?? d.CODAmount ?? 0);
                }
            }

            return results;
        }
        catch (OperationCanceledException)
        {
            return Enumerable.Empty<DRS>();
        }
        catch (InvalidOperationException)
        {
            return Enumerable.Empty<DRS>();
        }
    }

    private void OpenNewReceiptDialog()
    {
        _selectedDRS = null;
        _newReceiptAmount = 0;
        _newReceiptRemarks = null;
        _showNewReceiptDialog = true;
    }

    private async Task IssueNewReceipt()
    {
        if (_selectedDRS == null) return;

        _saving = true;
        StateHasChanged();

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "System";

            var submission = new CourierCashSubmission
            {
                DRSId = _selectedDRS.Id,
                CourierId = _selectedDRS.DeliveryEmployeeId ?? 0,
                CourierName = _selectedDRS.DeliveryEmployeeName,
                SubmissionDate = DateTime.UtcNow.Date,
                CashSubmittedAmount = _selectedDRS.ExpectedTotal ?? 0,
                SubmissionTime = DateTime.UtcNow,
                ReceivedById = 0,
                ReceivedByName = userName,
                ReceivedAt = DateTime.UtcNow,
                ReceivedAmount = _newReceiptAmount,
                ReceiptNo = await GenerateReceiptNumber(context),
                Remarks = _newReceiptRemarks,
                IsAcknowledged = true
            };

            context.CourierCashSubmissions.Add(submission);

            var drs = await context.DRSs.FindAsync(_selectedDRS.Id);
            if (drs != null)
            {
                drs.Status = DRSStatus.Submitted;
                drs.SubmittedAt = DateTime.UtcNow;
                drs.ActualReceived = _newReceiptAmount;
            }

            await context.SaveChangesAsync();

            Snackbar.Add($"Receipt {submission.ReceiptNo} issued successfully", Severity.Success);
            _showNewReceiptDialog = false;
            await LoadPendingSubmissions();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private async Task<string> GenerateReceiptNumber(ApplicationDbContext context)
    {
        var today = DateTime.UtcNow;
        var prefix = $"RCP{today:yyyyMMdd}";
        
        var lastReceipt = await context.CourierCashSubmissions
            .Where(c => c.ReceiptNo != null && c.ReceiptNo.StartsWith(prefix))
            .OrderByDescending(c => c.ReceiptNo)
            .FirstOrDefaultAsync();

        int sequence = 1;
        if (lastReceipt?.ReceiptNo != null)
        {
            var lastNum = lastReceipt.ReceiptNo.Substring(prefix.Length);
            if (int.TryParse(lastNum, out int num))
                sequence = num + 1;
        }

        return $"{prefix}{sequence:D4}";
    }

    private void OpenReceiptDialog(CourierCashSubmission submission)
    {
        _selectedSubmission = submission;
        _receivedCashAmount = submission.CashSubmittedAmount;
        _receiptRemarks = null;
        _showReceiptDialog = true;
    }

    private async Task AcknowledgeReceipt()
    {
        if (_selectedSubmission == null) return;

        _saving = true;
        StateHasChanged();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "System";

            await ReconciliationService.AcknowledgeReceipt(
                _selectedSubmission.Id,
                0,
                userName,
                _receivedCashAmount
            );

            Snackbar.Add("Receipt acknowledged successfully", Severity.Success);
            _showReceiptDialog = false;
            await LoadPendingSubmissions();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private void GoToReconcile(long drsId, long submissionId)
    {
        Navigation.NavigateTo($"/drs-reconcile/{drsId}/{submissionId}");
    }

    private void PrintReceipt(long submissionId)
    {
        Navigation.NavigateTo($"/api/report/cash-receipt/{submissionId}", forceLoad: true);
    }

    private void OpenEmailDialog(CourierCashSubmission submission)
    {
        _emailSubmission = submission;
        _emailAddress = null;
        _showEmailDialog = true;
    }

    private async Task SendEmail()
    {
        if (_emailSubmission == null || string.IsNullOrEmpty(_emailAddress)) return;

        _sending = true;
        StateHasChanged();

        try
        {
            var http = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };
            var response = await http.PostAsync($"/api/report/cash-receipt/{_emailSubmission.Id}/email?email={Uri.EscapeDataString(_emailAddress)}", null);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Email sent successfully", Severity.Success);
                _showEmailDialog = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to send email: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _sending = false;
            StateHasChanged();
        }
    }
}

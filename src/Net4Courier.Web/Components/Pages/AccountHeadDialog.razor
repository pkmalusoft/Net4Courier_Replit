@inject ApplicationDbContext DbContext
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
            @(IsNew ? "Add Account" : "Edit Account")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_formIsValid">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="Account.Code" Label="Code" Required="true" 
                                  RequiredError="Code is required" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="Account.Name" Label="Account Name" Required="true" 
                                  RequiredError="Name is required" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="AccountType" @bind-Value="Account.AccountType" Label="Account Type" 
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter">
                        <MudSelectItem T="AccountType" Value="AccountType.Asset">Asset</MudSelectItem>
                        <MudSelectItem T="AccountType" Value="AccountType.Liability">Liability</MudSelectItem>
                        <MudSelectItem T="AccountType" Value="AccountType.Income">Income</MudSelectItem>
                        <MudSelectItem T="AccountType" Value="AccountType.Expense">Expense</MudSelectItem>
                        <MudSelectItem T="AccountType" Value="AccountType.Equity">Equity</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="AccountGroup" @bind-Value="Account.AccountGroup" Label="Account Group" 
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter">
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.CurrentAsset">Current Asset</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.FixedAsset">Fixed Asset</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.CurrentLiability">Current Liability</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.LongTermLiability">Long Term Liability</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.DirectIncome">Direct Income</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.IndirectIncome">Indirect Income</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.DirectExpense">Direct Expense</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.IndirectExpense">Indirect Expense</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.Capital">Capital</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.BankAccount">Bank Account</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.CashAccount">Cash Account</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.Receivable">Receivable</MudSelectItem>
                        <MudSelectItem T="AccountGroup" Value="AccountGroup.Payable">Payable</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="long?" @bind-Value="Account.ParentId" Label="Parent Account" 
                               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" Clearable="true">
                        @foreach (var parent in _parentAccounts)
                        {
                            <MudSelectItem T="long?" Value="@parent.Id">@parent.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="Account.OpeningBalance" Label="Opening Balance" 
                                     Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Value="Account.IsGroup" Label="Is Group Account" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Value="Account.IsActive" Label="Active" Color="Color.Success" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="!_formIsValid">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public AccountHead Account { get; set; } = new();
    [Parameter] public bool IsNew { get; set; }

    private MudForm _form = null!;
    private bool _formIsValid;
    private List<AccountHead> _parentAccounts = new();

    protected override async Task OnInitializedAsync()
    {
        _parentAccounts = await DbContext.AccountHeads
            .Where(a => a.IsGroup && a.IsActive && !a.IsDeleted && a.Id != Account.Id)
            .OrderBy(a => a.Name)
            .ToListAsync();
    }

    private async Task Save()
    {
        await _form.Validate();
        if (!_formIsValid) return;

        if (IsNew)
        {
            Account.CreatedAt = DateTime.UtcNow;
            DbContext.AccountHeads.Add(Account);
        }
        else
        {
            Account.ModifiedAt = DateTime.UtcNow;
            DbContext.AccountHeads.Update(Account);
        }
        await DbContext.SaveChangesAsync();
        MudDialog.Close(DialogResult.Ok(Account));
    }

    private void Cancel() => MudDialog.Cancel();
}

@page "/launchpad"
@page "/favourites"
@page "/menu-dashboard"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject FavoriteService FavoriteService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Favourites</PageTitle>

<style>
    .launchpad-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .favorite-card {
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .favorite-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    .card-header-primary { background: linear-gradient(135deg, #594AE2 0%, #7B6FE8 100%); }
    .card-header-info { background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%); }
    .card-header-success { background: linear-gradient(135deg, #00C853 0%, #69F0AE 100%); }
    .card-header-warning { background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%); }

    .favorite-item {
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
    }

    .favorite-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #594AE2 0%, #7B6FE8 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .favorite-text {
        flex: 1;
    }

    .favorite-title {
        font-weight: 500;
        font-size: 0.95rem;
    }

    .favorite-route {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
    }

    .remove-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .favorite-card:hover .remove-btn {
        opacity: 1;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .category-section {
        margin-bottom: 32px;
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--mud-palette-primary);
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <div class="launchpad-header">
        <div>
            <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 500;">
                <MudIcon Icon="@Icons.Material.Filled.Star" Class="mr-2" />Favourites
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Your frequently used modules. Click "Add" to add more.</MudText>
        </div>
        <MudStack Row="true" Spacing="2">
            <MudTextField @bind-Value="_searchText" Placeholder="Search favourites..."
                          Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" Style="width: 280px;" Dense="true" />
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog">
                Add
            </MudButton>
        </MudStack>
    </div>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (!_favorites.Any())
    {
        <div class="empty-state">
            <MudIcon Icon="@Icons.Material.Filled.StarBorder" Size="Size.Large" Color="Color.Secondary" Style="font-size: 4rem;" />
            <MudText Typo="Typo.h6" Class="mt-4">No favourites yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Click "Add" to add your frequently used menus here, or right-click any navigation menu item.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialog">
                Add Your First Favourite
            </MudButton>
        </div>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var favorite in FilteredFavorites)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="favorite-card" @onclick="() => NavigateTo(favorite.Route)">
                        <MudCardContent Class="pa-0">
                            <div class="favorite-item">
                                <div class="favorite-icon">
                                    <MudIcon Icon="@(favorite.MenuIcon ?? Icons.Material.Filled.Link)" />
                                </div>
                                <div class="favorite-text">
                                    <div class="favorite-title">@favorite.MenuName</div>
                                    <div class="favorite-route">@favorite.Route</div>
                                </div>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" 
                                               Class="remove-btn" Color="Color.Error"
                                               OnClick="@(async () => await RemoveFavorite(favorite))" 
                                               OnClick:stopPropagation="true" />
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<MudDialog @bind-Visible="_showAddDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />Add to Favourites
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Select a menu item to add to your favourites.
        </MudText>
        <MudTextField @bind-Value="_menuSearchText" Label="Search menus..." Variant="Variant.Outlined" 
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true" Class="mb-4" />
        <MudPaper MaxHeight="400px" Style="overflow-y: auto;">
            <MudList T="AvailableMenuItem" Clickable="true" Dense="true">
                @foreach (var item in FilteredAvailableMenus)
                {
                    <MudListItem T="AvailableMenuItem" Icon="@item.Icon" OnClick="() => AddMenuItem(item)">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                            <div>
                                <MudText>@item.Title</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@item.Category</MudText>
                            </div>
                            @if (_existingCodes.Contains(item.MenuCode))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text">Added</MudChip>
                            }
                        </MudStack>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _showAddDialog = false">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading = true;
    private string _searchText = "";
    private string _menuSearchText = "";
    private long _userId = 0;
    private List<UserFavorite> _favorites = new();
    private HashSet<string> _existingCodes = new();
    private bool _showAddDialog = false;
    private List<AvailableMenuItem> _availableMenus = new();

    private IEnumerable<UserFavorite> FilteredFavorites => string.IsNullOrWhiteSpace(_searchText)
        ? _favorites
        : _favorites.Where(f => f.MenuName.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<AvailableMenuItem> FilteredAvailableMenus => string.IsNullOrWhiteSpace(_menuSearchText)
        ? _availableMenus
        : _availableMenus.Where(m => m.Title.Contains(_menuSearchText, StringComparison.OrdinalIgnoreCase) || 
                                      m.Category.Contains(_menuSearchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAndFavorites();
        InitializeAvailableMenus();
        _loading = false;
    }

    private async Task LoadUserAndFavorites()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User?.FindFirst("UserId")?.Value;
        if (long.TryParse(userIdClaim, out var userId))
        {
            _userId = userId;
            _favorites = await FavoriteService.GetUserFavoritesAsync(userId);
            _existingCodes = _favorites.Select(f => f.MenuCode).ToHashSet();
        }
    }

    private void NavigateTo(string? route)
    {
        if (!string.IsNullOrEmpty(route))
        {
            NavigationManager.NavigateTo(route);
        }
    }

    private async Task RemoveFavorite(UserFavorite favorite)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Remove Favourite",
            $"Remove '{favorite.MenuName}' from your favourites?",
            yesText: "Remove", cancelText: "Cancel");

        if (confirm == true)
        {
            await FavoriteService.RemoveFavoriteByIdAsync(favorite.Id);
            _favorites.Remove(favorite);
            _existingCodes.Remove(favorite.MenuCode);
            Snackbar.Add("Removed from Favourites", Severity.Info);
        }
    }

    private void OpenAddDialog()
    {
        _menuSearchText = "";
        _showAddDialog = true;
    }

    private async Task AddMenuItem(AvailableMenuItem item)
    {
        if (_existingCodes.Contains(item.MenuCode))
        {
            Snackbar.Add("Already in your favourites", Severity.Info);
            return;
        }

        try
        {
            var favorite = await FavoriteService.AddFavoriteAsync(_userId, item.MenuCode, item.Title, item.Icon, item.Route, item.Category);
            _favorites.Add(favorite);
            _existingCodes.Add(item.MenuCode);
            Snackbar.Add($"Added '{item.Title}' to Favourites!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to add: {ex.Message}", Severity.Error);
        }
    }

    private void InitializeAvailableMenus()
    {
        _availableMenus = new List<AvailableMenuItem>
        {
            new("Global Dashboard", Icons.Material.Filled.Home, "/", "DASHBOARD", "Dashboards"),
            new("Operations Dashboard", Icons.Material.Filled.Speed, "/operational-desktop", "OPS_DASHBOARD", "Dashboards"),
            new("Customer Dashboard", Icons.Material.Filled.People, "/customer/dashboard", "CUST_DASHBOARD", "Dashboards"),
            
            new("Pickup Dashboard", Icons.Material.Filled.Dashboard, "/pickup-dashboard", "PICKUP_DASHBOARD", "Operations"),
            new("Pickup Schedules", Icons.Material.Filled.Schedule, "/pickup-schedules", "PICKUP_SCHEDULES", "Operations"),
            new("Courier Commitments", Icons.Material.Filled.AssignmentTurnedIn, "/pickup-commitments", "PICKUP_COMMITMENTS", "Operations"),
            new("Inscan", Icons.Material.Filled.QrCodeScanner, "/pickup-inscan", "INSCAN", "Operations"),
            new("Outscan (DRS)", Icons.Material.Filled.ExitToApp, "/outscan", "OUTSCAN", "Operations"),
            new("Proof of Delivery", Icons.Material.Filled.CameraAlt, "/pod-scanner", "POD", "Operations"),
            new("Transfer Orders", Icons.Material.Filled.TransferWithinAStation, "/transfer-orders", "TRANSFER", "Operations"),
            new("RTS / RTO", Icons.Material.Filled.SwapHoriz, "/rts-list", "RTS", "Operations"),
            new("Shipments", Icons.Material.Filled.ListAlt, "/awb-list", "AWB_LIST", "Operations"),
            
            new("Import Manifest", Icons.Material.Filled.FlightLand, "/import-dashboard", "IMPORT", "Import/Export"),
            new("Customs Processing", Icons.Material.Filled.Gavel, "/import-customs", "CUSTOMS", "Import/Export"),
            
            new("Customer Profiles", Icons.Material.Filled.Person, "/customers", "CUSTOMERS", "Customers & CRM"),
            new("New Customer", Icons.Material.Filled.PersonAdd, "/customer-new", "CUSTOMER_NEW", "Customers & CRM"),
            new("Contracts & Pricing", Icons.Material.Filled.Handshake, "/contracts-pricing", "CONTRACTS", "Customers & CRM"),
            new("SLA Management", Icons.Material.Filled.Verified, "/sla-management", "SLA", "Customers & CRM"),
            new("Customer AWB Issue", Icons.Material.Filled.Assignment, "/customer-awb-issue", "AWB_ISSUE", "Customers & CRM"),
            new("Tickets Dashboard", Icons.Material.Filled.Dashboard, "/tickets-dashboard", "TICKETS_DASHBOARD", "Customers & CRM"),
            new("Complaints / Tickets", Icons.Material.Filled.SupportAgent, "/complaints", "TICKETS", "Customers & CRM"),
            
            new("Rate Calculator", Icons.Material.Filled.Calculate, "/rate-enquiry", "RATE_CALC", "Pricing"),
            new("Rate Cards", Icons.Material.Filled.TableChart, "/rate-cards", "RATE_CARDS", "Pricing"),
            new("Rate Simulator", Icons.Material.Filled.Science, "/rate-simulator", "RATE_SIM", "Pricing"),
            new("Zone Categories", Icons.Material.Filled.Category, "/zone-categories", "ZONE_CAT", "Pricing"),
            new("Zones", Icons.Material.Filled.GridOn, "/zone-matrix", "ZONES", "Pricing"),
            new("Fuel Surcharge", Icons.Material.Filled.LocalGasStation, "/fuel-surcharge", "FUEL", "Pricing"),
            
            new("Invoicing", Icons.Material.Filled.Description, "/customer-invoices", "INVOICES", "Finance"),
            new("Generate Invoice", Icons.Material.Filled.Add, "/customer-invoicing", "INVOICE_GEN", "Finance"),
            new("Receipts", Icons.Material.Filled.ReceiptLong, "/receipts", "RECEIPTS", "Finance"),
            new("Vendor Bills", Icons.Material.Filled.Receipt, "/vendor-bills", "VENDOR_BILLS", "Finance"),
            new("Payments", Icons.Material.Filled.Payments, "/payments", "PAYMENTS", "Finance"),
            new("Journal Entry", Icons.Material.Filled.Book, "/gl/journal-entry", "JOURNAL", "Finance"),
            new("Chart of Accounts", Icons.Material.Filled.AccountTree, "/gl/chart-of-accounts", "COA", "Finance"),
            new("Cash & Bank", Icons.Material.Filled.Payments, "/cash-bank-transactions", "CASH_BANK", "Finance"),
            
            new("Companies", Icons.Material.Filled.Domain, "/companies", "COMPANIES", "Masters"),
            new("Branches", Icons.Material.Filled.AccountTree, "/branches", "BRANCHES", "Masters"),
            new("Users", Icons.Material.Filled.People, "/users", "USERS", "Masters"),
            new("Roles", Icons.Material.Filled.Security, "/roles", "ROLES", "Masters"),
            new("Employees", Icons.Material.Filled.Badge, "/employees", "EMPLOYEES", "Masters"),
            new("Countries", Icons.Material.Filled.Flag, "/countries", "COUNTRIES", "Masters"),
            new("States", Icons.Material.Filled.Map, "/states", "STATES", "Masters"),
            new("Cities", Icons.Material.Filled.LocationCity, "/cities", "CITIES", "Masters"),
            new("Locations", Icons.Material.Filled.Place, "/locations", "LOCATIONS", "Masters"),
            new("Service Types", Icons.Material.Filled.Category, "/service-types", "SERVICE_TYPES", "Masters"),
            
            new("Audit Logs", Icons.Material.Filled.History, "/audit-logs", "AUDIT", "Compliance"),
            new("Empost Settlements", Icons.Material.Filled.Receipt, "/empost-settlements", "EMPOST", "Compliance"),
        };
    }

    private class AvailableMenuItem
    {
        public string Title { get; set; }
        public string Icon { get; set; }
        public string Route { get; set; }
        public string MenuCode { get; set; }
        public string Category { get; set; }

        public AvailableMenuItem(string title, string icon, string route, string menuCode, string category)
        {
            Title = title;
            Icon = icon;
            Route = route;
            MenuCode = menuCode;
            Category = category;
        }
    }
}

@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Web.Services
@using System.Security.Claims
@inject ApplicationDbContext DbContext
@inject ShipmentStatusService StatusService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Update" Class="mr-2" />
            Update Status - @Shipment.AWBNo
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Current Status</MudText>
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@Shipment.CourierStatusId</MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Changed By</MudText>
                    <MudText Typo="Typo.body2"><strong>@_currentUserName</strong></MudText>
                </MudItem>
            </MudGrid>
            
            <MudDivider />
            
            <MudSelect T="long?" 
                       @bind-Value="_selectedGroupId" 
                       Label="Status Group *"
                       Variant="Variant.Outlined"
                       Required="true"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var group in _statusGroups)
                {
                    <MudSelectItem Value="@((long?)group.Id)">
                        <div class="d-flex align-center gap-2">
                            @if (!string.IsNullOrEmpty(group.ColorCode))
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {group.ColorCode}; font-size: 12px;")" />
                            }
                            @group.Name
                        </div>
                    </MudSelectItem>
                }
            </MudSelect>
            
            @if (_selectedGroupId.HasValue)
            {
                <MudSelect T="long?" 
                           @bind-Value="_selectedStatusId" 
                           Label="New Status *"
                           Variant="Variant.Outlined"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var status in GetFilteredStatuses())
                    {
                        <MudSelectItem Value="@((long?)status.Id)">
                            @status.Name
                            @if (!string.IsNullOrEmpty(status.TimelineDescription))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary"> - @status.TimelineDescription</MudText>
                            }
                        </MudSelectItem>
                    }
                </MudSelect>
            }
            
            <MudTextField @bind-Value="_location"
                          Label="Location"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Dubai Hub, Warehouse A" />
            
            <MudTextField @bind-Value="_remarks"
                          Label="Reason for Status Change *"
                          Variant="Variant.Outlined"
                          Lines="3"
                          Required="true"
                          RequiredError="Please provide a reason for this status change"
                          Placeholder="Enter the reason for this status change..." />

            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                Status change will be recorded with your user details and timestamp for audit purposes.
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="UpdateStatus" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!CanSubmit || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update Status
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public InscanMaster Shipment { get; set; } = new();

    private List<ShipmentStatusGroup> _statusGroups = new();
    private List<ShipmentStatus> _allStatuses = new();
    private long? _selectedGroupId;
    private long? _selectedStatusId;
    private string _location = "";
    private string _remarks = "";
    private bool _isSaving = false;
    private long? _currentUserId;
    private string _currentUserName = "Unknown User";

    private bool CanSubmit => _selectedStatusId.HasValue && !string.IsNullOrWhiteSpace(_remarks);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        
        _statusGroups = await DbContext.ShipmentStatusGroups
            .Where(g => g.IsActive)
            .OrderBy(g => g.SequenceNo)
            .ToListAsync();
            
        _allStatuses = await DbContext.ShipmentStatuses
            .Where(s => s.IsActive)
            .OrderBy(s => s.SequenceNo)
            .ToListAsync();
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;
                if (long.TryParse(userIdClaim, out var userId))
                {
                    _currentUserId = userId;
                }

                _currentUserName = user.FindFirst("FullName")?.Value 
                    ?? user.FindFirst(ClaimTypes.Name)?.Value 
                    ?? user.Identity.Name 
                    ?? "Unknown User";
            }
        }
        catch
        {
            _currentUserName = "System User";
        }
    }

    private IEnumerable<ShipmentStatus> GetFilteredStatuses()
    {
        if (!_selectedGroupId.HasValue) return Enumerable.Empty<ShipmentStatus>();
        return _allStatuses.Where(s => s.StatusGroupId == _selectedGroupId.Value);
    }

    private async Task UpdateStatus()
    {
        if (!_selectedStatusId.HasValue || string.IsNullOrWhiteSpace(_remarks)) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var status = _allStatuses.FirstOrDefault(s => s.Id == _selectedStatusId.Value);
            if (status == null)
            {
                Snackbar.Add("Status not found", Severity.Error);
                return;
            }

            var result = await StatusService.SetStatus(
                inscanMasterId: Shipment.Id,
                statusCode: status.Code,
                eventType: "MANUAL_UPDATE",
                branchId: Shipment.BranchId,
                locationName: string.IsNullOrWhiteSpace(_location) ? null : _location.Trim(),
                userId: _currentUserId,
                userName: _currentUserName,
                remarks: _remarks.Trim(),
                isAutomatic: false
            );

            if (result != null)
            {
                Snackbar.Add($"Status updated to: {status.Name}", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add("Failed to update status", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}

@using MudBlazor
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Operations.Enums
@using Net4Courier.Kernel.Enums
@using Net4Courier.Web.Services
@using System.Security.Claims
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ShipmentStatusService StatusService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Update" Class="mr-2" />
            Update Status - @DisplayReference
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Current Status</MudText>
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@CurrentStatusDisplay</MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Changed By</MudText>
                    <MudText Typo="Typo.body2"><strong>@_currentUserName</strong></MudText>
                </MudItem>
            </MudGrid>
            
            <MudDivider />
            
            <MudSelect T="long?" 
                       @bind-Value="_selectedGroupId" 
                       Label="Status Group *"
                       Variant="Variant.Outlined"
                       Required="true"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var group in _statusGroups)
                {
                    <MudSelectItem Value="@((long?)group.Id)">
                        <div class="d-flex align-center gap-2">
                            @if (!string.IsNullOrEmpty(group.ColorCode))
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {group.ColorCode}; font-size: 12px;")" />
                            }
                            @group.Name
                        </div>
                    </MudSelectItem>
                }
            </MudSelect>
            
            @if (_selectedGroupId.HasValue)
            {
                <MudSelect T="long?" 
                           @bind-Value="_selectedStatusId" 
                           Label="New Status *"
                           Variant="Variant.Outlined"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var status in GetFilteredStatuses())
                    {
                        <MudSelectItem Value="@((long?)status.Id)">
                            @status.Name
                            @if (!string.IsNullOrEmpty(status.TimelineDescription))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary"> - @status.TimelineDescription</MudText>
                            }
                        </MudSelectItem>
                    }
                </MudSelect>
            }
            
            <MudTextField @bind-Value="_location"
                          Label="Location"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Dubai Hub, Warehouse A" />
            
            <MudTextField @bind-Value="_remarks"
                          Label="Reason for Status Change"
                          Variant="Variant.Outlined"
                          Lines="3"
                          Placeholder="Enter the reason for this status change (optional)..." />

            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                Status change will be recorded with your user details and timestamp for audit purposes.
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="UpdateStatus" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!CanSubmit || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update Status
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public InscanMaster? Shipment { get; set; }
    [Parameter] public PickupRequest? PickupRequest { get; set; }
    [Parameter] public ImportShipment? ImportShipment { get; set; }
    [Parameter] public EntityType EntityType { get; set; } = EntityType.Shipment;

    private List<ShipmentStatusGroup> _statusGroups = new();
    private List<ShipmentStatus> _allStatuses = new();
    private long? _selectedGroupId;
    private long? _selectedStatusId;
    private string _location = "";
    private string _remarks = "";
    private bool _isSaving = false;
    private long? _currentUserId;
    private string _currentUserName = "Unknown User";
    private long? _currentBranchId;

    private bool CanSubmit => _selectedStatusId.HasValue && !string.IsNullOrWhiteSpace(_remarks);
    
    private string DisplayReference => EntityType switch
    {
        EntityType.Shipment => Shipment?.AWBNo ?? "Unknown",
        EntityType.ImportShipment => ImportShipment?.AWBNo ?? "Unknown",
        EntityType.Pickup => PickupRequest?.PickupNo ?? "Unknown",
        _ => "Unknown"
    };
        
    private string CurrentStatusDisplay
    {
        get
        {
            if (EntityType == EntityType.Shipment)
            {
                return Shipment?.CourierStatusId.ToString() ?? "Unknown";
            }
            else if (EntityType == EntityType.ImportShipment)
            {
                return FormatImportStatus(ImportShipment?.Status ?? ImportShipmentStatus.Expected);
            }
            else
            {
                if (PickupRequest?.StatusId.HasValue == true)
                {
                    var status = _allStatuses.FirstOrDefault(s => s.Id == PickupRequest.StatusId.Value);
                    return status?.Name ?? PickupRequest.Status.ToString();
                }
                return PickupRequest?.Status.ToString() ?? "Unknown";
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        await LoadStatusGroups();
    }

    private async Task LoadUserInfo()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst("UserId")?.Value;
                if (long.TryParse(userIdClaim, out var userId))
                {
                    _currentUserId = userId;
                }

                var branchIdClaim = user.FindFirst("BranchId")?.Value;
                if (long.TryParse(branchIdClaim, out var branchId))
                {
                    _currentBranchId = branchId;
                }

                _currentUserName = user.FindFirst("FullName")?.Value 
                    ?? user.FindFirst(ClaimTypes.Name)?.Value 
                    ?? user.Identity.Name 
                    ?? "Unknown User";
            }
        }
        catch
        {
            _currentUserName = "System User";
        }
    }

    private async Task LoadStatusGroups()
    {
        await using var dbContext = await DbContextFactory.CreateDbContextAsync();
        
        if (EntityType == EntityType.Pickup)
        {
            _statusGroups = await dbContext.ShipmentStatusGroups
                .Where(g => g.IsActive && (g.Code == "PRE_PICKUP" || g.Code == "COLLECTION"))
                .OrderBy(g => g.SequenceNo)
                .ToListAsync();
        }
        else if (EntityType == EntityType.ImportShipment)
        {
            _statusGroups = await dbContext.ShipmentStatusGroups
                .Where(g => g.IsActive && g.Code == "IMPORT")
                .OrderBy(g => g.SequenceNo)
                .ToListAsync();
        }
        else
        {
            _statusGroups = await dbContext.ShipmentStatusGroups
                .Where(g => g.IsActive)
                .OrderBy(g => g.SequenceNo)
                .ToListAsync();
        }

        var groupIds = _statusGroups.Select(g => g.Id).ToList();
        _allStatuses = await dbContext.ShipmentStatuses
            .Where(s => s.IsActive && groupIds.Contains(s.StatusGroupId))
            .OrderBy(s => s.SequenceNo)
            .ToListAsync();
    }

    private IEnumerable<ShipmentStatus> GetFilteredStatuses()
    {
        if (!_selectedGroupId.HasValue) return Enumerable.Empty<ShipmentStatus>();
        return _allStatuses.Where(s => s.StatusGroupId == _selectedGroupId.Value);
    }

    private async Task UpdateStatus()
    {
        if (!_selectedStatusId.HasValue || string.IsNullOrWhiteSpace(_remarks)) return;

        _isSaving = true;
        StateHasChanged();

        try
        {
            var status = _allStatuses.FirstOrDefault(s => s.Id == _selectedStatusId.Value);
            if (status == null)
            {
                Snackbar.Add("Status not found", Severity.Error);
                return;
            }

            if (EntityType == EntityType.Shipment && Shipment != null)
            {
                var result = await StatusService.SetStatus(
                    inscanMasterId: Shipment.Id,
                    statusCode: status.Code,
                    eventType: "MANUAL_UPDATE",
                    branchId: Shipment.BranchId,
                    locationName: string.IsNullOrWhiteSpace(_location) ? null : _location.Trim(),
                    userId: _currentUserId,
                    userName: _currentUserName,
                    remarks: _remarks.Trim(),
                    isAutomatic: false
                );

                if (result != null)
                {
                    Snackbar.Add($"Status updated to: {status.Name}", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to update status", Severity.Error);
                }
            }
            else if (EntityType == EntityType.ImportShipment && ImportShipment != null)
            {
                await UpdateImportShipmentStatus(status);
            }
            else if (EntityType == EntityType.Pickup && PickupRequest != null)
            {
                await UpdatePickupRequestStatus(status);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task UpdateImportShipmentStatus(ShipmentStatus status)
    {
        if (ImportShipment == null) return;

        await using var dbContext = await DbContextFactory.CreateDbContextAsync();
        var shipment = await dbContext.ImportShipments.FindAsync(ImportShipment.Id);

        if (shipment == null)
        {
            Snackbar.Add("Import shipment not found", Severity.Error);
            return;
        }

        var oldStatus = shipment.Status;
        if (!status.Code.StartsWith("IMP_"))
        {
            Snackbar.Add("Please select a status from the Import Shipment group", Severity.Warning);
            return;
        }
        var newImportStatus = MapStatusCodeToImportEnum(status.Code);
        shipment.Status = newImportStatus;
        shipment.ModifiedAt = DateTime.UtcNow;
        shipment.ModifiedBy = (int?)_currentUserId;

        switch (newImportStatus)
        {
            case ImportShipmentStatus.Inscanned:
                shipment.InscannedAt ??= DateTime.UtcNow;
                break;
            case ImportShipmentStatus.Cleared:
                shipment.CustomsClearedAt ??= DateTime.UtcNow;
                break;
            case ImportShipmentStatus.Released:
                shipment.ReleasedAt ??= DateTime.UtcNow;
                break;
            case ImportShipmentStatus.HandedOver:
                shipment.HandedOverAt ??= DateTime.UtcNow;
                break;
        }

        var note = new ImportShipmentNote
        {
            ImportShipmentId = shipment.Id,
            Category = NoteCategory.Operations,
            NoteText = $"Status changed from {FormatImportStatus(oldStatus)} to {FormatImportStatus(newImportStatus)}. Location: {(_location ?? "N/A")}. Reason: {_remarks.Trim()}",
            AddedByUserId = _currentUserId,
            AddedByUserName = _currentUserName,
            AddedAt = DateTime.UtcNow,
            IsActive = true,
            CreatedAt = DateTime.UtcNow,
            CreatedBy = (int?)_currentUserId
        };

        dbContext.Set<ImportShipmentNote>().Add(note);
        await dbContext.SaveChangesAsync();

        Snackbar.Add($"Import status updated to: {status.Name}", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private async Task UpdatePickupRequestStatus(ShipmentStatus status)
    {
        if (PickupRequest == null) return;

        await using var dbContext = await DbContextFactory.CreateDbContextAsync();
        
        var pickup = await dbContext.PickupRequests.FindAsync(PickupRequest.Id);
        if (pickup == null)
        {
            Snackbar.Add("Pickup request not found", Severity.Error);
            return;
        }

        pickup.StatusId = status.Id;
        pickup.StatusGroupId = status.StatusGroupId;
        pickup.ModifiedAt = DateTime.UtcNow;
        pickup.ModifiedBy = (int?)_currentUserId;

        var oldEnumStatus = pickup.Status;
        pickup.Status = MapStatusCodeToPickupEnum(status.Code);

        if (status.Code == "ASSIGNED_FOR_COLLECTION")
        {
            pickup.AssignedAt = DateTime.UtcNow;
        }
        else if (status.Code == "SHIPMENT_COLLECTED")
        {
            pickup.CollectedAt = DateTime.UtcNow;
        }

        var history = new PickupStatusHistory
        {
            PickupRequestId = pickup.Id,
            StatusId = status.Id,
            StatusGroupId = status.StatusGroupId,
            EventType = "MANUAL_UPDATE",
            BranchId = _currentBranchId ?? pickup.BranchId,
            LocationName = string.IsNullOrWhiteSpace(_location) ? null : _location.Trim(),
            UserId = _currentUserId,
            UserName = _currentUserName,
            Remarks = _remarks.Trim(),
            ChangedAt = DateTime.UtcNow,
            IsAutomatic = false,
            IsActive = true,
            CreatedAt = DateTime.UtcNow,
            CreatedBy = (int?)_currentUserId
        };

        dbContext.PickupStatusHistories.Add(history);
        await dbContext.SaveChangesAsync();

        Snackbar.Add($"Pickup status updated to: {status.Name}", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private ImportShipmentStatus MapStatusCodeToImportEnum(string statusCode)
    {
        return statusCode switch
        {
            "IMP_EXPECTED" => ImportShipmentStatus.Expected,
            "IMP_INSCANNED" => ImportShipmentStatus.Inscanned,
            "IMP_RECEIVED_WAREHOUSE" => ImportShipmentStatus.ReceivedAtWarehouse,
            "IMP_PENDING_CUSTOMS" => ImportShipmentStatus.PendingCustoms,
            "IMP_CUSTOMS_HOLD" => ImportShipmentStatus.CustomsHold,
            "IMP_UNDER_EXAMINATION" => ImportShipmentStatus.UnderExamination,
            "IMP_AWAITING_DOCUMENTS" => ImportShipmentStatus.AwaitingDocuments,
            "IMP_CLEARED" => ImportShipmentStatus.Cleared,
            "IMP_RELEASED" => ImportShipmentStatus.Released,
            "IMP_HANDED_OVER" => ImportShipmentStatus.HandedOver,
            "IMP_ON_HOLD" => ImportShipmentStatus.OnHold,
            _ => ImportShipmentStatus.Expected
        };
    }

    private PickupStatus MapStatusCodeToPickupEnum(string statusCode)
    {
        return statusCode switch
        {
            "PICKUP_REQUESTED" => PickupStatus.PickupRequest,
            "PICKUP_SCHEDULED" => PickupStatus.PickupRequest,
            "PICKUP_ATTEMPTED" => PickupStatus.Attempted,
            "ASSIGNED_FOR_COLLECTION" => PickupStatus.AssignedForCollection,
            "SHIPMENT_COLLECTED" => PickupStatus.ShipmentCollected,
            "PICKUP_MANIFESTED" => PickupStatus.Inscanned,
            _ => PickupStatus.PickupRequest
        };
    }

    private string FormatImportStatus(ImportShipmentStatus status) => status switch
    {
        ImportShipmentStatus.Expected => "Expected",
        ImportShipmentStatus.Inscanned => "Inscanned",
        ImportShipmentStatus.ReceivedAtWarehouse => "Received at Warehouse",
        ImportShipmentStatus.PendingCustoms => "Pending Customs",
        ImportShipmentStatus.CustomsHold => "Customs Hold",
        ImportShipmentStatus.UnderExamination => "Under Examination",
        ImportShipmentStatus.AwaitingDocuments => "Awaiting Documents",
        ImportShipmentStatus.Cleared => "Cleared",
        ImportShipmentStatus.Released => "Released",
        ImportShipmentStatus.HandedOver => "Handed Over",
        ImportShipmentStatus.OnHold => "On Hold",
        _ => status.ToString()
    };

    private void Cancel() => MudDialog.Cancel();
}

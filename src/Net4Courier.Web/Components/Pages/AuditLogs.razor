@page "/audit-logs"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Kernel.Entities
@using Net4Courier.Masters.Entities
@using System.Text.Json
@using Net4Courier.Web.Services
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDateTimeService DateTimeService
@attribute [Authorize(Roles = "Administrator,PlatformAdmin,Manager")]

<PageTitle>Audit Logs - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <div>
                <MudText Typo="Typo.h5" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />Audit Logs
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Track all user transactions and changes</MudText>
            </div>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="LoadAuditLogs">Refresh</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Download"
                           OnClick="ExportToExcel">Export to Excel</MudButton>
            </MudStack>
        </MudStack>

        <MudGrid>
            <MudItem xs="12" sm="6" md="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" Variant="Variant.Outlined" 
                               DateFormat="dd/MM/yyyy" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" Variant="Variant.Outlined" 
                               DateFormat="dd/MM/yyyy" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="string" @bind-Value="_selectedEntity" Label="Entity" Variant="Variant.Outlined" Clearable="true">
                    <MudSelectItem T="string" Value="@("")">All Entities</MudSelectItem>
                    @foreach (var entity in _entityNames)
                    {
                        <MudSelectItem T="string" Value="@entity">@entity</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" @bind-Value="_selectedAction" Label="Action" Variant="Variant.Outlined" Clearable="true">
                    <MudSelectItem T="int?" Value="@((int?)null)">All Actions</MudSelectItem>
                    <MudSelectItem T="int?" Value="@((int?)1)">Create</MudSelectItem>
                    <MudSelectItem T="int?" Value="@((int?)2)">Update</MudSelectItem>
                    <MudSelectItem T="int?" Value="@((int?)3)">Delete</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="long?" @bind-Value="_selectedUserId" Label="User" Variant="Variant.Outlined" Clearable="true">
                    <MudSelectItem T="long?" Value="@((long?)null)">All Users</MudSelectItem>
                    @foreach (var user in _users)
                    {
                        <MudSelectItem T="long?" Value="@((long?)user.Id)">@user.FullName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2" Class="d-flex align-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                           OnClick="LoadAuditLogs" StartIcon="@Icons.Material.Filled.Search">Search</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4">
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudDataGrid T="AuditLog" Items="@_auditLogs" Dense="true" Hover="true" Bordered="true"
                         RowsPerPage="25" Striped="true">
                <Columns>
                    <TemplateColumn Title="Date/Time">
                        <CellTemplate>
                            @DateTimeService.FormatDateTime(context.Item.Timestamp, "dd/MM/yyyy HH:mm:ss")
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.EntityName" Title="Entity" />
                    <PropertyColumn Property="x => x.EntityId" Title="Record ID" />
                    <TemplateColumn Title="Action">
                        <CellTemplate>
                            @{
                                var action = context.Item.Action;
                                var (color, icon, text) = action switch
                                {
                                    AuditAction.Create => (Color.Success, Icons.Material.Filled.Add, "Created"),
                                    AuditAction.Update => (Color.Warning, Icons.Material.Filled.Edit, "Updated"),
                                    AuditAction.Delete => (Color.Error, Icons.Material.Filled.Delete, "Deleted"),
                                    _ => (Color.Default, Icons.Material.Filled.Info, "Unknown")
                                };
                            }
                            <MudChip T="string" Color="@color" Size="Size.Small" Icon="@icon">@text</MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.UserName" Title="User" />
                    <PropertyColumn Property="x => x.BranchName" Title="Branch" />
                    <TemplateColumn Title="Changes">
                        <CellTemplate>
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                       OnClick="@(() => ShowChangesDialog(context.Item))">
                                View Details
                            </MudButton>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="AuditLog" />
                </PagerContent>
            </MudDataGrid>

            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-3">
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Total Records: @_auditLogs.Count
                </MudText>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

<MudDialog @bind-Visible="_showDetailsDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Class="mr-2" />
            Audit Log Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedAuditLog != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Log Information</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudSimpleTable Dense="true" Hover="true">
                                <tbody>
                                    <tr><td><strong>Entity</strong></td><td>@_selectedAuditLog.EntityName</td></tr>
                                    <tr><td><strong>Record ID</strong></td><td>@_selectedAuditLog.EntityId</td></tr>
                                    <tr><td><strong>Action</strong></td><td>@_selectedAuditLog.Action</td></tr>
                                    <tr><td><strong>Timestamp</strong></td><td>@DateTimeService.FormatDateTime(_selectedAuditLog.Timestamp, "dd/MM/yyyy HH:mm:ss")</td></tr>
                                    <tr><td><strong>User</strong></td><td>@_selectedAuditLog.UserName</td></tr>
                                    <tr><td><strong>Branch</strong></td><td>@_selectedAuditLog.BranchName</td></tr>
                                    <tr><td><strong>IP Address</strong></td><td>@(_selectedAuditLog.IPAddress ?? "N/A")</td></tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Changes Summary</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (_selectedAuditLog.Action == AuditAction.Create)
                            {
                                <MudAlert Severity="Severity.Success" Dense="true" Class="mb-2">New record created</MudAlert>
                            }
                            else if (_selectedAuditLog.Action == AuditAction.Delete)
                            {
                                <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">Record deleted</MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">Record modified</MudAlert>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                @if (!string.IsNullOrEmpty(_selectedAuditLog.OldValues))
                {
                    <MudItem xs="12" sm="6">
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Color="Color.Error">Old Values</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent Style="max-height: 300px; overflow-y: auto;">
                                <pre style="font-size: 12px; white-space: pre-wrap; word-break: break-all;">@FormatJson(_selectedAuditLog.OldValues)</pre>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
                @if (!string.IsNullOrEmpty(_selectedAuditLog.NewValues))
                {
                    <MudItem xs="12" sm="6">
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Color="Color.Success">New Values</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent Style="max-height: 300px; overflow-y: auto;">
                                <pre style="font-size: 12px; white-space: pre-wrap; word-break: break-all;">@FormatJson(_selectedAuditLog.NewValues)</pre>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showDetailsDialog = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<AuditLog> _auditLogs = new();
    private List<User> _users = new();
    private List<string> _entityNames = new();
    private bool _isLoading = true;
    
    private DateTime? _fromDate = DateTime.Today.AddDays(-7);
    private DateTime? _toDate = DateTime.Today;
    private string _selectedEntity = "";
    private int? _selectedAction;
    private long? _selectedUserId;
    
    private bool _showDetailsDialog;
    private AuditLog? _selectedAuditLog;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilters();
        await LoadAuditLogs();
    }

    private async Task LoadFilters()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _users = await dbContext.Users
            .Where(u => u.IsActive && !u.IsDeleted)
            .OrderBy(u => u.FullName)
            .ToListAsync();
            
        _entityNames = await dbContext.AuditLogs
            .Select(a => a.EntityName)
            .Distinct()
            .OrderBy(e => e)
            .ToListAsync();
    }

    private async Task LoadAuditLogs()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var query = dbContext.AuditLogs.AsQueryable();

            if (_fromDate.HasValue)
            {
                var fromUtc = DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc);
                query = query.Where(a => a.Timestamp >= fromUtc);
            }

            if (_toDate.HasValue)
            {
                var toUtc = DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1), DateTimeKind.Utc);
                query = query.Where(a => a.Timestamp < toUtc);
            }

            if (!string.IsNullOrEmpty(_selectedEntity))
            {
                query = query.Where(a => a.EntityName == _selectedEntity);
            }

            if (_selectedAction.HasValue)
            {
                var action = (AuditAction)_selectedAction.Value;
                query = query.Where(a => a.Action == action);
            }

            if (_selectedUserId.HasValue)
            {
                query = query.Where(a => a.UserId == _selectedUserId.Value);
            }

            _auditLogs = await query
                .OrderByDescending(a => a.Timestamp)
                .Take(1000)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading audit logs: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowChangesDialog(AuditLog auditLog)
    {
        _selectedAuditLog = auditLog;
        _showDetailsDialog = true;
    }

    private string FormatJson(string json)
    {
        try
        {
            var doc = JsonDocument.Parse(json);
            return JsonSerializer.Serialize(doc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }

    private void ExportToExcel()
    {
        var queryParams = new List<string>();
        
        if (_fromDate.HasValue)
            queryParams.Add($"fromDate={_fromDate.Value:yyyy-MM-dd}");
        if (_toDate.HasValue)
            queryParams.Add($"toDate={_toDate.Value:yyyy-MM-dd}");
        if (!string.IsNullOrEmpty(_selectedEntity))
            queryParams.Add($"entityName={Uri.EscapeDataString(_selectedEntity)}");
        if (_selectedAction.HasValue)
            queryParams.Add($"action={_selectedAction.Value}");
        if (_selectedUserId.HasValue)
            queryParams.Add($"userId={_selectedUserId.Value}");
        
        var url = "/api/export/audit-logs";
        if (queryParams.Count > 0)
            url += "?" + string.Join("&", queryParams);
        
        NavigationManager.NavigateTo(url, forceLoad: true);
    }
}

@using Microsoft.EntityFrameworkCore
@using Net4Courier.Masters.Entities
@using Net4Courier.Infrastructure.Data
@using ZoneMatrixEntity = Net4Courier.Masters.Entities.ZoneMatrix
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(_isNew ? "New Zone" : "Edit Zone")</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_zone.ZoneCode" Label="Zone Code" Required="true"
                              Variant="Variant.Outlined" Margin="Margin.Dense" MaxLength="20" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField T="int" @bind-Value="_zone.SortOrder" Label="Sort Order"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_zone.ZoneName" Label="Zone Name" Required="true"
                              Variant="Variant.Outlined" Margin="Margin.Dense" MaxLength="100" />
            </MudItem>
            <MudItem xs="12">
                <MudAutocomplete T="Country" @bind-Value="_selectedCountry" Label="Default Country"
                                 SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
            <MudItem xs="12">
                <MudAutocomplete T="City" @bind-Value="_selectedCity" Label="Default City"
                                 SearchFunc="SearchCities" ToStringFunc="@(c => c?.Name ?? "")"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Disabled="@_saving">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public long ZoneId { get; set; }

    private ZoneMatrixEntity _zone = new();
    private Country? _selectedCountry;
    private City? _selectedCity;
    private bool _isNew => ZoneId == 0;
    private bool _saving;

    protected override async Task OnInitializedAsync()
    {
        if (!_isNew)
        {
            _zone = await DbContext.ZoneMatrices.FirstOrDefaultAsync(z => z.Id == ZoneId) ?? new ZoneMatrixEntity();
            if (_zone.CountryId.HasValue)
            {
                _selectedCountry = await DbContext.Countries.FindAsync(_zone.CountryId.Value);
            }
            if (_zone.CityId.HasValue)
            {
                _selectedCity = await DbContext.Cities.FindAsync(_zone.CityId.Value);
            }
        }
        else
        {
            _zone = new ZoneMatrixEntity { IsActive = true };
        }
    }

    private async Task<IEnumerable<Country>> SearchCountries(string value)
    {
        var query = DbContext.Countries.Where(c => !c.IsDeleted && c.IsActive);
        if (!string.IsNullOrWhiteSpace(value))
        {
            query = query.Where(c => c.Name.ToLower().Contains(value.ToLower()) ||
                                     (c.Code != null && c.Code.ToLower().Contains(value.ToLower())));
        }
        return await query.OrderBy(c => c.Name).Take(20).ToListAsync();
    }

    private async Task<IEnumerable<City>> SearchCities(string value)
    {
        var query = DbContext.Cities.Where(c => !c.IsDeleted && c.IsActive);
        if (_selectedCountry != null)
        {
            query = query.Where(c => c.CountryId == _selectedCountry.Id);
        }
        if (!string.IsNullOrWhiteSpace(value))
        {
            query = query.Where(c => c.Name.ToLower().Contains(value.ToLower()));
        }
        return await query.OrderBy(c => c.Name).Take(20).ToListAsync();
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_zone.ZoneCode) || string.IsNullOrWhiteSpace(_zone.ZoneName))
        {
            Snackbar.Add("Zone code and name are required", Severity.Error);
            return;
        }

        _saving = true;
        try
        {
            _zone.CountryId = _selectedCountry?.Id;
            _zone.CityId = _selectedCity?.Id;

            if (_isNew)
            {
                _zone.CreatedAt = DateTime.UtcNow;
                DbContext.ZoneMatrices.Add(_zone);
            }
            else
            {
                _zone.ModifiedAt = DateTime.UtcNow;
            }

            await DbContext.SaveChangesAsync();
            MudDialog.Close(DialogResult.Ok(true));
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}

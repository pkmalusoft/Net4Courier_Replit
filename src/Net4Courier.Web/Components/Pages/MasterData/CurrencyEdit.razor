@page "/gl/currencies/new"
@page "/gl/currencies/edit/{Id:guid}"
@using Microsoft.AspNetCore.Authorization
@using Truebooks.Platform.Contracts.DTOs
@attribute [Authorize]

@inject Net4Courier.Web.Interfaces.ICurrencyService CurrencyService
@inject Truebooks.Platform.Core.MultiTenancy.ITenantContext TenantContext
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">@(Id.HasValue ? "Edit" : "New") Currency</MudText>

    <MudPaper Class="pa-6" Elevation="2">
        <MudForm @ref="form" @bind-IsValid="@formIsValid">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="currency.Code" 
                                Label="Currency Code" 
                                Required="true"
                                Variant="Variant.Outlined"
                                RequiredError="Currency code is required"
                                MaxLength="3"
                                HelperText="3-letter code (e.g., USD, EUR, GBP)"
                                Disabled="@Id.HasValue" />
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="currency.Name" 
                                Label="Currency Name" 
                                Required="true"
                                Variant="Variant.Outlined"
                                RequiredError="Currency name is required"
                                MaxLength="100"
                                HelperText="Full name (e.g., US Dollar, Euro)" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="currency.Symbol" 
                                Label="Symbol" 
                                Variant="Variant.Outlined"
                                MaxLength="10"
                                HelperText="e.g., $, €, £" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Value="currency.IsBaseCurrency" 
                               Label="Base Currency" 
                               Color="Color.Primary"
                               Disabled="@(Id.HasValue && existingIsBaseCurrency)" />
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="ml-8">
                        Mark as the primary currency for your organization
                    </MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Value="currency.IsActive" 
                               Label="Active" 
                               Color="Color.Primary" />
                    <MudText Typo="Typo.caption" Color="Color.Default" Class="ml-8">
                        Only active currencies are available for selection
                    </MudText>
                </MudItem>
            </MudGrid>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
            }

            <MudDivider Class="my-6" />

            <MudGrid>
                <MudItem xs="12" sm="6" md="4">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              FullWidth="true" 
                              OnClick="Save" 
                              Disabled="isLoading">
                        Save
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Secondary" 
                              FullWidth="true" 
                              OnClick="Cancel" 
                              Disabled="isLoading">
                        Cancel
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private MudForm? form;
    private bool formIsValid;
    private CurrencyModel currency = new();
    private string errorMessage = "";
    private bool isLoading = false;
    private bool existingIsBaseCurrency = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (Id.HasValue)
            {
                var tenantId = TenantContext.TenantId ?? Guid.Empty;
                var existing = await CurrencyService.GetByIdAsync(tenantId, Id.Value);
                if (existing != null)
                {
                    currency = new CurrencyModel
                    {
                        Id = existing.Id,
                        Code = existing.Code,
                        Name = existing.Name,
                        Symbol = existing.Symbol ?? "",
                        IsBaseCurrency = existing.IsBaseCurrency,
                        IsActive = existing.IsActive
                    };
                    existingIsBaseCurrency = currency.IsBaseCurrency;
                }
            }
            else
            {
                currency.IsActive = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load currency: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
    }

    private async Task Save()
    {
        if (!formIsValid)
        {
            Snackbar.Add("Please fill all required fields correctly", Severity.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(currency.Code) || currency.Code.Length != 3)
        {
            Snackbar.Add("Currency code must be exactly 3 characters", Severity.Warning);
            return;
        }

        errorMessage = "";
        isLoading = true;

        try
        {
            var tenantId = TenantContext.TenantId ?? Guid.Empty;
            currency.Code = currency.Code.ToUpper();

            if (Id.HasValue)
            {
                var request = new UpdateCurrencyRequest(
                    Id.Value,
                    currency.Code,
                    currency.Name,
                    currency.Symbol,
                    currency.IsBaseCurrency,
                    currency.IsActive
                );
                await CurrencyService.UpdateAsync(tenantId, Id.Value, request);
                Snackbar.Add("Currency updated successfully", Severity.Success);
            }
            else
            {
                var request = new CreateCurrencyRequest(
                    currency.Code,
                    currency.Name,
                    currency.Symbol,
                    currency.IsBaseCurrency,
                    currency.IsActive
                );
                await CurrencyService.CreateAsync(tenantId, request);
                Snackbar.Add("Currency created successfully", Severity.Success);
            }
            Navigation.NavigateTo("/gl/currencies");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/gl/currencies");
    }

    public class CurrencyModel
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Symbol { get; set; } = string.Empty;
        public bool IsBaseCurrency { get; set; }
        public bool IsActive { get; set; } = true;
    }
}

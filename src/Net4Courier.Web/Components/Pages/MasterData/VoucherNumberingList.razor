@page "/gl/voucher-numbering"
@attribute [Authorize]

@using PlatformServices = Truebooks.Platform.Contracts.Services
@using PlatformDTOs = Truebooks.Platform.Contracts.DTOs
@using Microsoft.AspNetCore.Authorization
@using Truebooks.Platform.Core.MultiTenancy

@inject PlatformServices.IVoucherNumberingService VoucherNumberingService
@inject Truebooks.Platform.Core.MultiTenancy.ITenantContext TenantContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Voucher Numbering Setup</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
            Configure voucher number prefixes for each transaction type. Once transactions are created, configurations become locked to maintain data integrity.
        </MudAlert>

        <MudButton Variant="Variant.Filled" 
                  Color="Color.Primary" 
                  StartIcon="@Icons.Material.Filled.Add"
                  OnClick="CreateNew"
                  Class="mb-2">
            New Configuration
        </MudButton>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudDataGrid T="PlatformDTOs.VoucherNumberingDto" 
                     Items="@voucherConfigs" 
                     Filterable="true"
                     FilterMode="DataGridFilterMode.ColumnFilterRow"
                     SortMode="SortMode.Multiple"
                     Dense="true"
                     Hover="true">
            <Columns>
                <PropertyColumn Property="x => x.TransactionTypeName" Title="Transaction Type" />
                <PropertyColumn Property="x => x.Prefix" Title="Prefix" />
                <PropertyColumn Property="x => x.NextNumber" Title="Next Number" />
                <PropertyColumn Property="x => x.NumberLength" Title="Length" />
                <PropertyColumn Property="x => x.Separator" Title="Separator" />
                <PropertyColumn Property="x => x.NextVoucherPreview" Title="Next Voucher Preview">
                    <CellTemplate>
                        <MudChip Size="MudBlazor.Size.Small" Color="Color.Info">@context.Item.NextVoucherPreview</MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.StatusText" Title="Status">
                    <CellTemplate>
                        <MudChip Size="MudBlazor.Size.Small" 
                                Color="@(context.Item.IsLocked ? Color.Warning : Color.Success)">
                            @context.Item.StatusText
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                      Color="Color.Primary" 
                                      Size="MudBlazor.Size.Small"
                                      OnClick="@(() => Edit(context.Item))"
                                      Disabled="@context.Item.IsLocked" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                      Color="Color.Error" 
                                      Size="MudBlazor.Size.Small"
                                      OnClick="@(() => Delete(context.Item))"
                                      Disabled="@context.Item.IsLocked" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudContainer>

@code {
    private List<PlatformDTOs.VoucherNumberingDto> voucherConfigs = new();
    private bool isLoading = false;

    private Guid GetTenantId() => TenantContext.TenantId ?? Guid.Parse("11111111-1111-1111-1111-111111111111");

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var tenantId = GetTenantId();
            var result = await VoucherNumberingService.GetAllAsync(tenantId);
            voucherConfigs = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading voucher numbering: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/master-data/voucher-numbering/new");
    }

    private void Edit(PlatformDTOs.VoucherNumberingDto voucher)
    {
        if (voucher.IsLocked)
        {
            Snackbar.Add("This configuration is locked and cannot be edited", Severity.Warning);
            return;
        }
        Navigation.NavigateTo($"/master-data/voucher-numbering/edit/{voucher.Id}");
    }

    private async Task Delete(PlatformDTOs.VoucherNumberingDto voucher)
    {
        if (voucher.IsLocked)
        {
            Snackbar.Add("This configuration is locked and cannot be deleted", Severity.Warning);
            return;
        }

        try
        {
            var tenantId = GetTenantId();
            await VoucherNumberingService.DeleteAsync(tenantId, voucher.Id);
            Snackbar.Add("Configuration deleted successfully", Severity.Success);
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting configuration: {ex.Message}", Severity.Error);
        }
    }
}

@page "/pickup-workflow"
@using Net4Courier.Operations.Entities

<PageTitle>Pickup Workflow - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Pickup Workflow</MudText>
<MudText Typo="Typo.body1" Class="mb-4">Complete guide to the pickup request lifecycle from creation to AWB conversion.</MudText>

<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Workflow Diagram</MudText>
            <MudPaper Class="pa-4" Style="background-color: #f5f5f5; font-family: monospace; white-space: pre; overflow-x: auto;">
@WorkflowDiagram
            </MudPaper>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Status Codes</MudText>
            <MudTable Items="@_statusCodes" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Status</MudTh>
                    <MudTh>Value</MudTh>
                    <MudTh>Description</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudChip T="string" Color="@GetStatusColor(context.Value)" Size="Size.Small">@context.Name</MudChip>
                    </MudTd>
                    <MudTd>@context.Value</MudTd>
                    <MudTd>@context.Description</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Available Actions by Status</MudText>
            <MudTable Items="@_statusActions" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Current Status</MudTh>
                    <MudTh>Available Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudChip T="string" Color="@GetStatusColor(context.Value)" Size="Size.Small">@context.Name</MudChip>
                    </MudTd>
                    <MudTd>@context.Actions</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">Workflow Steps</MudText>
    <MudTimeline TimelinePosition="TimelinePosition.Start">
        <MudTimelineItem Color="Color.Warning" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 1</MudText>
                <MudText Typo="Typo.body1"><strong>Create Pickup Request</strong></MudText>
                <MudText Typo="Typo.body2">Customer calls or submits online request. Enter customer details, pickup address, and add shipment lines with consignee details. System assigns Pickup Request Number (e.g., PKP-2026-0001).</MudText>
            </ItemContent>
        </MudTimelineItem>
        <MudTimelineItem Color="Color.Info" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 2</MudText>
                <MudText Typo="Typo.body1"><strong>Assign Courier</strong></MudText>
                <MudText Typo="Typo.body2">Click the Assign button on the pickup request. Select a courier from the dropdown. Courier receives pickup details with address and special instructions.</MudText>
            </ItemContent>
        </MudTimelineItem>
        <MudTimelineItem Color="Color.Success" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 3a - Success</MudText>
                <MudText Typo="Typo.body1"><strong>Mark Collected</strong></MudText>
                <MudText Typo="Typo.body2">Courier arrives at customer location, verifies packages, and collects shipment. Click "Mark Collected" to update status.</MudText>
            </ItemContent>
        </MudTimelineItem>
        <MudTimelineItem Color="Color.Error" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 3b - Failed</MudText>
                <MudText Typo="Typo.body1"><strong>Mark Attempted</strong></MudText>
                <MudText Typo="Typo.body2">If courier cannot collect (customer unavailable, address wrong, etc.), click "Mark Attempted" and enter reason. The pickup can then be re-assigned to another courier.</MudText>
            </ItemContent>
        </MudTimelineItem>
        <MudTimelineItem Color="Color.Secondary" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 4</MudText>
                <MudText Typo="Typo.body1"><strong>Inscan at Warehouse</strong></MudText>
                <MudText Typo="Typo.body2">Courier brings packages to warehouse. Scan packages at inscan station, verify weight and piece count.</MudText>
            </ItemContent>
        </MudTimelineItem>
        <MudTimelineItem Color="Color.Primary" Variant="Variant.Filled">
            <ItemContent>
                <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Step 5</MudText>
                <MudText Typo="Typo.body1"><strong>Convert to AWB</strong></MudText>
                <MudText Typo="Typo.body2">From the pickup request, click "Convert to AWB". System creates AWB from shipment lines. Each shipment line becomes a separate AWB entry.</MudText>
            </ItemContent>
        </MudTimelineItem>
    </MudTimeline>
</MudPaper>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">Business Rules</MudText>
    <MudList T="string" Dense="true">
        <MudListItem Icon="@Icons.Material.Filled.Rule">
            <strong>Shipment Lines Required:</strong> Pickup requests must have at least one shipment line with consignee details before converting to AWB.
        </MudListItem>
        <MudListItem Icon="@Icons.Material.Filled.Rule">
            <strong>City Selection:</strong> UAE cities must be selected from dropdown (auto-populates State/Country).
        </MudListItem>
        <MudListItem Icon="@Icons.Material.Filled.Rule">
            <strong>Re-assignment:</strong> Attempted pickups can be re-assigned to the same or different courier.
        </MudListItem>
        <MudListItem Icon="@Icons.Material.Filled.Rule">
            <strong>Timestamps:</strong> All status changes are recorded with date/time and user info.
        </MudListItem>
        <MudListItem Icon="@Icons.Material.Filled.Rule">
            <strong>Audit Trail:</strong> Complete history of status changes maintained in PickupStatusHistory.
        </MudListItem>
    </MudList>
</MudPaper>

<MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/pickup-management" StartIcon="@Icons.Material.Filled.ArrowForward">
    Go to Pickup Management
</MudButton>

@code {
    private const string WorkflowDiagram = @"
┌──────────────────┐     ┌───────────────────────┐     ┌─────────────────┐
│  Pickup Request  │────▶│ Assigned for Collection│────▶│    Collected    │
│   (Status = 1)   │     │      (Status = 2)      │     │   (Status = 4)  │
└──────────────────┘     └───────────────────────┘     └─────────────────┘
                                    │                          │
                                    │ Failed                   │
                                    ▼                          ▼
                         ┌──────────────────┐          ┌─────────────────┐
                         │    Attempted     │          │    Inscanned    │
                         │   (Status = 3)   │          │   (Status = 5)  │
                         └──────────────────┘          └─────────────────┘
                                    │                          │
                                    │ Re-assign                │
                                    └────────────▶─────────────┘
                                                       │
                                                       ▼
                                               ┌─────────────────┐
                                               │   AWB Created   │
                                               └─────────────────┘
";

    private List<StatusInfo> _statusCodes = new()
    {
        new("Pickup Request", 1, "Initial request created"),
        new("Assigned for Collection", 2, "Courier assigned to collect"),
        new("Attempted", 3, "Collection failed (customer unavailable, etc.)"),
        new("Shipment Collected", 4, "Courier has collected the shipment"),
        new("Inscanned", 5, "Shipment received at warehouse"),
        new("Cancelled", 6, "Request cancelled")
    };

    private List<StatusAction> _statusActions = new()
    {
        new("Pickup Request", 1, "Assign to Courier, Cancel"),
        new("Assigned for Collection", 2, "Mark Collected, Mark Attempted"),
        new("Attempted", 3, "Re-assign to Courier"),
        new("Shipment Collected", 4, "Inscan at Warehouse"),
        new("Inscanned", 5, "Convert to AWB"),
        new("Cancelled", 6, "No further action")
    };

    private Color GetStatusColor(int value) => value switch
    {
        1 => Color.Warning,
        2 => Color.Info,
        3 => Color.Error,
        4 => Color.Success,
        5 => Color.Secondary,
        6 => Color.Dark,
        _ => Color.Default
    };

    private record StatusInfo(string Name, int Value, string Description);
    private record StatusAction(string Name, int Value, string Actions);
}

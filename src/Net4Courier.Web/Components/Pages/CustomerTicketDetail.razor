@page "/customer/ticket/{Id:long}"
@layout CustomerLayout
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Components.Layout

<PageTitle>Ticket Details - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_ticket == null)
    {
        <MudAlert Severity="Severity.Error">Ticket not found or you don't have access to view it.</MudAlert>
        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" Class="mt-3">
            Back to My Tickets
        </MudButton>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" />
            <MudText Typo="Typo.h5">Ticket @_ticket.TicketNo</MudText>
            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_ticket.Status)">@GetStatusText(_ticket.Status)</MudChip>
            <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(_ticket.Priority)">@_ticket.Priority</MudChip>
        </MudStack>

        <MudGrid Spacing="3">
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.h6" GutterBottom="true">@_ticket.Subject</MudText>
                    <MudDivider Class="mb-3" />
                    
                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@_ticket.Description</MudText>
                    
                    @if (!string.IsNullOrEmpty(_ticket.AWBNo))
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Related Shipment: <strong>@_ticket.AWBNo</strong></MudText>
                            </MudStack>
                        </MudAlert>
                    }
                </MudPaper>

                <MudPaper Class="pa-4 mt-3" Elevation="1">
                    <MudText Typo="Typo.subtitle1" GutterBottom="true">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Class="mr-1" /> Conversation
                    </MudText>
                    <MudDivider Class="mb-3" />

                    @if (!_comments.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                            No responses yet. Our team will respond as soon as possible.
                        </MudText>
                    }
                    else
                    {
                        @foreach (var comment in _comments)
                        {
                            var isCustomer = comment.IsFromCustomer;
                            <MudPaper Class="pa-3 mb-2" Style="@(isCustomer ? "background-color: #e3f2fd;" : "background-color: #f5f5f5;")">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@(isCustomer ? Icons.Material.Filled.Person : Icons.Material.Filled.SupportAgent)" 
                                                 Size="Size.Small" Color="@(isCustomer ? Color.Primary : Color.Secondary)" />
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                            @(isCustomer ? "You" : (comment.UserName ?? "Support"))
                                        </MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @comment.CreatedAt.ToString("dd MMM yyyy HH:mm")
                                    </MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="mt-2" Style="white-space: pre-wrap;">@comment.Comment</MudText>
                            </MudPaper>
                        }
                    }

                    @if (_ticket.Status != TicketStatus.Closed && _ticket.Status != TicketStatus.Cancelled)
                    {
                        <MudDivider Class="my-3" />
                        <MudTextField @bind-Value="_newComment" Label="Add a Response" Variant="Variant.Outlined" Lines="3"
                                      Placeholder="Type your message here..." />
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddComment" 
                                   Disabled="@(string.IsNullOrWhiteSpace(_newComment) || _saving)" Class="mt-2">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Send Response
                        </MudButton>
                    }
                </MudPaper>

                @if (_ticket.Status == TicketStatus.Resolved && _ticket.CustomerRating == null)
                {
                    <MudPaper Class="pa-4 mt-3" Elevation="1" Style="background-color: #fff3e0;">
                        <MudText Typo="Typo.subtitle1" GutterBottom="true">
                            <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-1" /> Rate Our Support
                        </MudText>
                        <MudText Typo="Typo.body2" Class="mb-3">Please rate your experience with our support team:</MudText>
                        <MudRating @bind-SelectedValue="_rating" MaxValue="5" Size="Size.Large" />
                        <MudTextField @bind-Value="_feedback" Label="Feedback (Optional)" Variant="Variant.Outlined" Lines="2" Class="mt-3" />
                        <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="SubmitRating" 
                                   Disabled="@(_rating == 0 || _savingRating)" Class="mt-2">
                            Submit Rating
                        </MudButton>
                    </MudPaper>
                }
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="1">
                    <MudText Typo="Typo.subtitle1" GutterBottom="true">Ticket Information</MudText>
                    <MudDivider Class="mb-3" />
                    
                    <MudStack Spacing="2">
                        <MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Ticket Number</MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@_ticket.TicketNo</MudText>
                        </MudStack>
                        <MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Category</MudText>
                            <MudText Typo="Typo.body2">@(_ticket.CategoryName ?? "-")</MudText>
                        </MudStack>
                        <MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                            <MudText Typo="Typo.body2">@_ticket.CreatedAt.ToString("dd MMM yyyy HH:mm")</MudText>
                        </MudStack>
                        @if (_ticket.FirstResponseAt.HasValue)
                        {
                            <MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">First Response</MudText>
                                <MudText Typo="Typo.body2">@_ticket.FirstResponseAt.Value.ToString("dd MMM yyyy HH:mm")</MudText>
                            </MudStack>
                        }
                        @if (_ticket.ResolvedAt.HasValue)
                        {
                            <MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Resolved</MudText>
                                <MudText Typo="Typo.body2">@_ticket.ResolvedAt.Value.ToString("dd MMM yyyy HH:mm")</MudText>
                            </MudStack>
                        }
                        @if (!string.IsNullOrEmpty(_ticket.AssignedToUserName))
                        {
                            <MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Assigned To</MudText>
                                <MudText Typo="Typo.body2">@_ticket.AssignedToUserName</MudText>
                            </MudStack>
                        }
                    </MudStack>
                </MudPaper>

                @if (!string.IsNullOrEmpty(_ticket.ResolutionNotes))
                {
                    <MudPaper Class="pa-4 mt-3" Elevation="1" Style="background-color: #e8f5e9;">
                        <MudText Typo="Typo.subtitle1" GutterBottom="true">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" Class="mr-1" />
                            Resolution
                        </MudText>
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@_ticket.ResolutionNotes</MudText>
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public long Id { get; set; }

    private Ticket? _ticket;
    private List<TicketComment> _comments = new();
    private bool _loading = true;
    private long _customerId;
    private string _customerName = "";
    
    private string _newComment = "";
    private bool _saving;
    
    private int _rating;
    private string _feedback = "";
    private bool _savingRating;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserContext();
        await LoadTicket();
    }

    private async Task LoadUserContext()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var customerIdClaim = user.FindFirst("CustomerId")?.Value;
            var customerNameClaim = user.FindFirst("CustomerName")?.Value;
            
            if (long.TryParse(customerIdClaim, out var cid))
            {
                _customerId = cid;
                _customerName = customerNameClaim ?? "";
            }
        }
    }

    private async Task LoadTicket()
    {
        _loading = true;
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            
            _ticket = await db.Tickets
                .FirstOrDefaultAsync(t => t.Id == Id && !t.IsDeleted && t.PartyId == _customerId);

            if (_ticket != null)
            {
                _comments = await db.TicketComments
                    .Where(c => c.TicketId == Id && !c.IsDeleted)
                    .OrderBy(c => c.CreatedAt)
                    .ToListAsync();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task AddComment()
    {
        if (string.IsNullOrWhiteSpace(_newComment)) return;
        if (_customerId == 0)
        {
            Snackbar.Add("Session expired. Please log in again.", Severity.Error);
            return;
        }

        _saving = true;
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            
            var ticket = await db.Tickets.FirstOrDefaultAsync(t => t.Id == Id && t.PartyId == _customerId && !t.IsDeleted);
            if (ticket == null)
            {
                Snackbar.Add("Ticket not found or access denied", Severity.Error);
                return;
            }
            
            var comment = new TicketComment
            {
                TicketId = Id,
                Comment = _newComment.Trim(),
                IsFromCustomer = true,
                CreatedAt = DateTime.UtcNow,
                UserName = _customerName
            };

            db.TicketComments.Add(comment);
            
            ticket.ModifiedAt = DateTime.UtcNow;
            if (ticket.Status == TicketStatus.PendingCustomer)
            {
                ticket.Status = TicketStatus.Open;
            }

            await db.SaveChangesAsync();
            
            _comments.Add(comment);
            _newComment = "";
            _ticket = ticket;
            
            Snackbar.Add("Response sent successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending response: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SubmitRating()
    {
        if (_rating == 0) return;
        if (_customerId == 0)
        {
            Snackbar.Add("Session expired. Please log in again.", Severity.Error);
            return;
        }

        _savingRating = true;
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            
            var ticket = await db.Tickets.FirstOrDefaultAsync(t => t.Id == Id && t.PartyId == _customerId && !t.IsDeleted);
            if (ticket == null)
            {
                Snackbar.Add("Ticket not found or access denied", Severity.Error);
                return;
            }
            
            ticket.CustomerRating = _rating;
            ticket.CustomerFeedback = string.IsNullOrWhiteSpace(_feedback) ? null : _feedback.Trim();
            ticket.ModifiedAt = DateTime.UtcNow;
            
            await db.SaveChangesAsync();
            _ticket = ticket;
            
            Snackbar.Add("Thank you for your feedback!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error submitting rating: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingRating = false;
        }
    }

    private void GoBack() => NavigationManager.NavigateTo("/customer/my-tickets");

    private Color GetPriorityColor(TicketPriority priority) => priority switch
    {
        TicketPriority.Urgent => Color.Error,
        TicketPriority.High => Color.Warning,
        TicketPriority.Medium => Color.Info,
        TicketPriority.Low => Color.Default,
        _ => Color.Default
    };

    private Color GetStatusColor(TicketStatus status) => status switch
    {
        TicketStatus.Open => Color.Primary,
        TicketStatus.InProgress => Color.Info,
        TicketStatus.PendingCustomer => Color.Warning,
        TicketStatus.Resolved => Color.Success,
        TicketStatus.Closed => Color.Default,
        TicketStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(TicketStatus status) => status switch
    {
        TicketStatus.Open => "Open",
        TicketStatus.InProgress => "In Progress",
        TicketStatus.PendingCustomer => "Awaiting Your Response",
        TicketStatus.Resolved => "Resolved",
        TicketStatus.Closed => "Closed",
        TicketStatus.Cancelled => "Cancelled",
        _ => status.ToString()
    };
}

@page "/labels/a5-landscape"
@page "/labels/a5-landscape/{AwbId:long}"
@inject IJSRuntime JSRuntime
@inject Net4Courier.Infrastructure.Data.ApplicationDbContext Db
@inject Net4Courier.Operations.Services.BarcodeService BarcodeService
@using Microsoft.EntityFrameworkCore

<div class="no-print" style="text-align:center;padding:20px;background:#f1f5f9;">
    <button onclick="printA5Label()" style="padding:10px 32px;font-size:16px;font-weight:700;background:#1e3a8a;color:white;border:none;border-radius:24px;cursor:pointer;">
        PRINT A5 LABEL
    </button>
    <div style="font-size:12px;color:#64748b;margin-top:8px;font-style:italic;">Optimized for A5 Landscape (210mm Ã— 148mm)</div>
</div>

<div class="a5-page-wrap">
    <div id="a5-label-printable" class="a5-label">

        <table class="header-table">
            <tr>
                <td class="header-left">
                    @if (_logoBase64 != null)
                    {
                        <img src="@_logoBase64" style="height:32px;display:block;" />
                    }
                    else
                    {
                        <div class="company-name">@_companyName</div>
                    }
                    <div class="service-tag">@LabelData.ServiceType</div>
                </td>
                <td class="header-center">
                    <div class="route-pill">
                        <span class="route-origin">@LabelData.Origin</span>
                        <span class="route-arrow">&#10132;</span>
                        <span class="route-dest">@LabelData.Destination</span>
                    </div>
                </td>
                <td class="header-right">
                    <div class="awb-caption">WAYBILL NUMBER</div>
                    <div class="awb-number">@LabelData.Waybill</div>
                    <div class="awb-date">@LabelData.BookingDate</div>
                </td>
            </tr>
        </table>

        <div class="body-area">
            <div class="body-left">
                <table class="addr-table">
                    <tr>
                        <td class="addr-cell shipper-cell">
                            <div class="addr-header">FROM (SHIPPER)</div>
                            <div class="addr-body">
                                <div class="addr-name">@LabelData.Shipper.Name</div>
                                <div class="addr-text">@LabelData.Shipper.Address</div>
                                <div class="addr-phone">&#9742; @LabelData.Shipper.Phone</div>
                            </div>
                        </td>
                        <td class="addr-cell receiver-cell">
                            <div class="addr-header addr-header-dark">TO (RECEIVER)</div>
                            <div class="addr-body">
                                <div class="addr-name-lg">@LabelData.Receiver.Name</div>
                                <div class="addr-text-lg">@LabelData.Receiver.Address</div>
                                <div class="addr-phone-lg">&#9742; @LabelData.Receiver.Phone</div>
                            </div>
                        </td>
                    </tr>
                </table>

                @if (!string.IsNullOrWhiteSpace(LabelData.Instructions))
                {
                    <div class="instructions-bar">
                        <span class="inst-label">SPECIAL INSTRUCTIONS:</span>
                        <span class="inst-text">@LabelData.Instructions</span>
                    </div>
                }
            </div>

            <div class="body-right">
                <div class="barcode-box">
                    @if (_barcodeBase64 != null)
                    {
                        <img src="data:image/png;base64,@_barcodeBase64" class="barcode-img" />
                    }
                    else
                    {
                        <div class="barcode-placeholder">
                            @for (int i = 0; i < 40; i++)
                            {
                                var w = i % 3 == 0 ? "2px" : "1px";
                                <span style="display:inline-block;width:@w;height:36px;background:black;margin-right:1px;"></span>
                            }
                        </div>
                    }
                    <div class="barcode-text">@SpaceOutText(LabelData.Waybill)</div>
                </div>

                <table class="metrics-table">
                    <tr>
                        <td class="metric-cell">
                            <div class="metric-label">WEIGHT</div>
                            <div class="metric-value">@LabelData.Weight</div>
                        </td>
                        <td class="metric-cell metric-border-left">
                            <div class="metric-label">PIECES</div>
                            <div class="metric-value">@LabelData.Pieces</div>
                        </td>
                    </tr>
                </table>

                <div class="cod-box">
                    <div class="cod-label">COLLECT CASH</div>
                    <div class="cod-amount">
                        <span class="cod-currency">@LabelData.Currency</span>
                        <span class="cod-value">@LabelData.Cod</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pod-section">
            <div class="pod-title">POD - PROOF OF DELIVERY</div>
            <table class="pod-table">
                <tr>
                    <td class="pod-cell">
                        <div class="pod-line"></div>
                        <div class="pod-cap">Customer Sign / Stamp</div>
                    </td>
                    <td class="pod-cell">
                        <div class="pod-line"></div>
                        <div class="pod-cap">Courier Pickup Date</div>
                    </td>
                    <td class="pod-cell">
                        <div class="pod-line"></div>
                        <div class="pod-cap">Delivery Success Date</div>
                    </td>
                </tr>
            </table>
        </div>

        <div class="label-footer">
            <span>Account: @LabelData.AccountNo</span>
            <span>Page 1 of 1</span>
        </div>

    </div>
</div>

<style>
    * { box-sizing: border-box; }

    .a5-page-wrap {
        display: flex;
        justify-content: center;
        padding: 24px 0;
        background: #f1f5f9;
    }

    .a5-label {
        width: 210mm;
        height: 148mm;
        background: white;
        border: 2px solid #1a1a1a;
        padding: 6mm 7mm 5mm 7mm;
        font-family: Arial, Helvetica, sans-serif;
        color: #111;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .header-table {
        width: 100%;
        border-collapse: collapse;
        border-bottom: 2px solid #111;
        padding-bottom: 4mm;
        margin-bottom: 4mm;
    }
    .header-table td { vertical-align: middle; padding-bottom: 3mm; }
    .header-left { width: 30%; }
    .header-center { width: 35%; text-align: center; }
    .header-right { width: 35%; text-align: right; }

    .company-name {
        font-size: 22px;
        font-weight: 900;
        font-style: italic;
        color: #1e3a8a;
        line-height: 1;
    }
    .service-tag {
        display: inline-block;
        background: #1e3a8a;
        color: white;
        font-size: 7px;
        font-weight: 700;
        padding: 1px 6px;
        border-radius: 2px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
    }

    .route-pill {
        display: inline-flex;
        align-items: center;
        border: 2px solid #111;
        border-radius: 24px;
        padding: 4px 18px;
        gap: 8px;
    }
    .route-origin { font-size: 14px; font-weight: 700; }
    .route-arrow { font-size: 14px; }
    .route-dest { font-size: 14px; font-weight: 900; text-decoration: underline; text-underline-offset: 3px; }

    .awb-caption { font-size: 8px; font-weight: 600; color: #666; letter-spacing: 0.5px; }
    .awb-number { font-size: 22px; font-weight: 900; line-height: 1.1; letter-spacing: 1px; }
    .awb-date { font-size: 10px; color: #888; }

    .body-area {
        display: flex;
        gap: 4mm;
        flex: 1;
        min-height: 0;
        margin-bottom: 3mm;
    }
    .body-left {
        flex: 6;
        display: flex;
        flex-direction: column;
        gap: 3mm;
    }
    .body-right {
        flex: 4;
        display: flex;
        flex-direction: column;
        gap: 2.5mm;
    }

    .addr-table {
        width: 100%;
        border-collapse: collapse;
        flex: 1;
    }
    .addr-cell {
        width: 50%;
        vertical-align: top;
        border: 1px solid #333;
    }
    .shipper-cell { border-right: none; }
    .receiver-cell { border-width: 2px; }

    .addr-header {
        background: #e8ecf1;
        border-bottom: 1px solid #333;
        padding: 2px 6px;
        font-size: 8px;
        font-weight: 800;
        letter-spacing: 0.5px;
    }
    .addr-header-dark {
        background: #1a1a1a;
        color: white;
        border-bottom: 2px solid #1a1a1a;
    }
    .addr-body { padding: 5px 7px; }
    .addr-name { font-size: 11px; font-weight: 800; text-transform: uppercase; }
    .addr-name-lg { font-size: 13px; font-weight: 900; text-transform: uppercase; }
    .addr-text { font-size: 9px; color: #444; line-height: 1.3; margin-top: 2px; }
    .addr-text-lg { font-size: 10px; line-height: 1.3; margin-top: 2px; }
    .addr-phone { font-size: 9px; font-weight: 700; margin-top: 6px; }
    .addr-phone-lg { font-size: 11px; font-weight: 800; margin-top: 6px; }

    .instructions-bar {
        border: 1.5px solid #333;
        padding: 4px 8px;
        font-size: 9px;
        background: #fffbeb;
    }
    .inst-label { font-weight: 900; font-size: 8px; letter-spacing: 0.3px; }
    .inst-text { font-style: italic; margin-left: 4px; }

    .barcode-box {
        border: 1.5px solid #333;
        padding: 6px 8px;
        text-align: center;
    }
    .barcode-img { height: 40px; max-width: 100%; display: block; margin: 0 auto; }
    .barcode-placeholder { text-align: center; line-height: 0; }
    .barcode-text { font-size: 10px; font-weight: 600; letter-spacing: 5px; margin-top: 3px; }

    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        border: 1.5px solid #333;
    }
    .metric-cell { padding: 3px 6px; text-align: center; width: 50%; }
    .metric-border-left { border-left: 1.5px solid #333; }
    .metric-label { font-size: 7px; font-weight: 700; color: #666; letter-spacing: 0.5px; }
    .metric-value { font-size: 16px; font-weight: 900; }

    .cod-box {
        background: #1a1a1a;
        color: white;
        padding: 5px 8px;
        border-radius: 4px;
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .cod-label { font-size: 8px; font-weight: 700; letter-spacing: 1px; opacity: 0.85; }
    .cod-amount { display: flex; align-items: baseline; justify-content: center; gap: 4px; }
    .cod-currency { font-size: 12px; font-weight: 700; }
    .cod-value { font-size: 28px; font-weight: 900; line-height: 1.1; }

    .pod-section {
        border-top: 2px solid #111;
        padding-top: 3mm;
        margin-top: auto;
    }
    .pod-title { font-size: 10px; font-weight: 900; margin-bottom: 2mm; }
    .pod-table { width: 100%; border-collapse: collapse; }
    .pod-cell { width: 33.33%; padding: 0 12px 0 0; vertical-align: top; }
    .pod-line { border-bottom: 1px solid #111; height: 14px; }
    .pod-cap { font-size: 7px; color: #c44; font-weight: 600; margin-top: 2px; }

    .label-footer {
        display: flex;
        justify-content: space-between;
        font-size: 9px;
        font-weight: 600;
        color: #1e3a8a;
        margin-top: 2mm;
        padding-top: 1mm;
    }

    @@media print {
        .no-print { display: none !important; }
        body { margin: 0; padding: 0; }
        .a5-page-wrap { padding: 0; background: white; }
        .a5-label {
            width: 210mm;
            height: 148mm;
            border: none;
            box-shadow: none;
            margin: 0;
        }
        @@page {
            size: A5 landscape;
            margin: 0;
        }
    }
</style>

<script suppress-error="BL9992">
    function printA5Label() {
        var el = document.getElementById('a5-label-printable');
        if (!el) return;
        var html = el.outerHTML;
        var styles = '';
        var styleTags = document.querySelectorAll('style');
        for (var i = 0; i < styleTags.length; i++) { styles += styleTags[i].outerHTML; }
        var w = window.open('', '_blank', 'width=1000,height=700');
        w.document.write('<html><head><title>AWB Label</title>' + styles +
            '<style>@@page{size:A5 landscape;margin:0;}body{margin:0;padding:0;}.no-print{display:none!important;}.a5-page-wrap{padding:0;background:white;}</style></head><body>' +
            '<div class="a5-page-wrap">' + html + '</div></body></html>');
        w.document.close();
        w.focus();
        setTimeout(function () { w.print(); }, 600);
    }
</script>

@code {
    [Parameter] public long AwbId { get; set; }

    private A5LabelModel LabelData = new();
    private string? _logoBase64;
    private string? _barcodeBase64;
    private string _companyName = "Net4Courier";

    private string SpaceOutText(string text)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return string.Join(" ", text.ToCharArray());
    }

    protected override async Task OnInitializedAsync()
    {
        if (AwbId > 0)
            await LoadShipmentData();
        else
            LoadDemoData();
    }

    private async Task LoadShipmentData()
    {
        var awb = await Db.InscanMasters.FindAsync(AwbId);
        if (awb == null) return;

        if (awb.BarcodeImage == null && !string.IsNullOrEmpty(awb.AWBNo))
        {
            var (h, v) = BarcodeService.GenerateBothBarcodes(awb.AWBNo);
            awb.BarcodeImage = h;
        }

        if (awb.BarcodeImage != null)
            _barcodeBase64 = Convert.ToBase64String(awb.BarcodeImage);

        if (awb.BranchId.HasValue)
        {
            var branch = await Db.Branches.Include(b => b.Company).FirstOrDefaultAsync(b => b.Id == awb.BranchId);
            if (branch?.Company != null)
            {
                _companyName = branch.Company.Name ?? "Net4Courier";
                if (!string.IsNullOrEmpty(branch.Company.Logo))
                    _logoBase64 = branch.Company.Logo;
            }
        }

        var shipperPhone = CombinePhone(awb.ConsignorPhone, awb.ConsignorMobile);
        var receiverPhone = CombinePhone(awb.ConsigneePhone, awb.ConsigneeMobile);
        var shipperAddress = BuildAddress(awb.ConsignorAddress1, awb.ConsignorAddress2, awb.ConsignorCity, awb.ConsignorCountry);
        var receiverAddress = BuildAddress(awb.ConsigneeAddress1, awb.ConsigneeAddress2, awb.ConsigneeCity, awb.ConsigneeCountry);

        var weight = awb.ChargeableWeight ?? awb.Weight ?? 0;
        var pieces = awb.Pieces ?? 1;
        var codAmount = awb.IsCOD ? (awb.CODAmount ?? 0) : 0;
        var vatAmount = awb.TaxAmount ?? 0;
        var dutyAmount = awb.DutyVatAmount ?? 0;
        var totalCollect = codAmount + vatAmount + dutyAmount;

        LabelData = new A5LabelModel
        {
            Waybill = awb.AWBNo ?? "",
            BookingDate = awb.TransactionDate.ToString("dd/MM/yyyy"),
            AccountNo = awb.CustomerId?.ToString() ?? "",
            ServiceType = awb.CargoDescription ?? "E-COMMERCE DELIVERY",
            Origin = (awb.ConsignorCity ?? "").ToUpper(),
            Destination = (awb.ConsigneeCity ?? "").ToUpper(),
            Cod = totalCollect > 0 ? totalCollect.ToString("N2") : "0.00",
            Currency = awb.Currency ?? "AED",
            Weight = $"{weight:F2} KG",
            Pieces = pieces.ToString(),
            Instructions = awb.Remarks ?? "",
            Shipper = new A5Entity { Name = awb.Consignor ?? "", Address = shipperAddress, Phone = shipperPhone },
            Receiver = new A5Entity { Name = awb.Consignee ?? "", Address = receiverAddress, Phone = receiverPhone }
        };
    }

    private void LoadDemoData()
    {
        LabelData = new A5LabelModel
        {
            Waybill = "ND23291",
            BookingDate = "23/01/2026",
            AccountNo = "ND1134",
            ServiceType = "E-COMMERCE DELIVERY",
            Origin = "DUBAI",
            Destination = "AJMAN",
            Cod = "1.00",
            Currency = "AED",
            Weight = "0.00 KG",
            Pieces = "1",
            Instructions = "Fragile - Handle with care. Please call before delivery.",
            Shipper = new A5Entity { Name = "A&F FASHION / ADIL", Address = "UMMO RAMOOL, DUBAI, UAE", Phone = "+971523379386" },
            Receiver = new A5Entity { Name = "ROLNDY WILKINS", Address = "AJMAN ROWDA 1, STREET 118, AJMAN, UAE", Phone = "1234" }
        };
    }

    private string BuildAddress(string? addr1, string? addr2, string? city, string? country)
    {
        var parts = new List<string>();
        var street = $"{addr1} {addr2}".Trim();
        if (!string.IsNullOrEmpty(street)) parts.Add(street);
        if (!string.IsNullOrEmpty(city)) parts.Add(city);
        if (!string.IsNullOrEmpty(country)) parts.Add(country);
        return string.Join(", ", parts).ToUpper();
    }

    private string CombinePhone(string? phone, string? mobile)
    {
        if (!string.IsNullOrWhiteSpace(mobile)) return mobile;
        if (!string.IsNullOrWhiteSpace(phone)) return phone;
        return "";
    }

    public class A5LabelModel
    {
        public string Waybill { get; set; } = "";
        public string BookingDate { get; set; } = "";
        public string AccountNo { get; set; } = "";
        public string ServiceType { get; set; } = "";
        public string Origin { get; set; } = "";
        public string Destination { get; set; } = "";
        public string Cod { get; set; } = "";
        public string Currency { get; set; } = "AED";
        public string Weight { get; set; } = "";
        public string Pieces { get; set; } = "";
        public string Instructions { get; set; } = "";
        public A5Entity Shipper { get; set; } = new();
        public A5Entity Receiver { get; set; } = new();
    }

    public class A5Entity
    {
        public string Name { get; set; } = "";
        public string Address { get; set; } = "";
        public string Phone { get; set; } = "";
    }
}

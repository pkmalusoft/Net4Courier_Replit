@page "/labels/a5-landscape"
@page "/labels/a5-landscape/{AwbId:long}"
@inject IJSRuntime JSRuntime
@inject Net4Courier.Infrastructure.Data.ApplicationDbContext Db
@inject Net4Courier.Operations.Services.BarcodeService BarcodeService
@using Microsoft.EntityFrameworkCore

<div class="no-print" style="text-align:center;padding:20px;background:#f1f5f9;">
    <button onclick="printA5Label()" style="padding:10px 32px;font-size:16px;font-weight:700;background:#1e3a8a;color:white;border:none;border-radius:24px;cursor:pointer;">
        PRINT A5 LABEL
    </button>
    <div style="font-size:12px;color:#64748b;margin-top:8px;font-style:italic;">Optimized for A5 Landscape (210mm x 148mm)</div>
</div>

<div class="a5-page-wrap">
    <div id="a5-label-printable" class="a5-label">

        <table class="header-table">
            <tr>
                <td class="header-left">
                    @if (_logoBase64 != null)
                    {
                        <img src="@_logoBase64" style="height:22px;display:block;" />
                    }
                    else
                    {
                        <div class="company-name">@_companyName</div>
                    }
                    <div class="service-tag">@LabelData.ServiceType</div>
                </td>
                <td class="header-center">
                    <div class="route-pill">
                        <span class="route-origin">@LabelData.Origin</span>
                        <span class="route-arrow">&#10132;</span>
                        <span class="route-dest">@LabelData.Destination</span>
                    </div>
                </td>
                <td class="header-right">
                    <div class="awb-caption">WAYBILL NUMBER</div>
                    <div class="awb-number">@LabelData.Waybill</div>
                </td>
            </tr>
        </table>

        <div class="info-row">
            <span><span class="info-label">Account No</span> <span class="info-value">@LabelData.AccountNo</span></span>
            <span><span class="info-label">Booking Date :</span> <span class="info-value">@LabelData.BookingDate</span></span>
            <span><span class="info-label">Shipper's Reference</span> <span class="info-value">@LabelData.ShipperReference</span></span>
        </div>

        <div class="body-area">
            <div class="body-left">
                <table class="addr-table">
                    <tr>
                        <td class="addr-cell shipper-cell">
                            <div class="addr-header">FROM (SHIPPER)</div>
                            <div class="addr-body">
                                <div class="addr-name">@LabelData.Shipper.Name</div>
                                <div class="addr-text">@LabelData.Shipper.Address</div>
                                <div class="addr-phone">
                                    <span class="phone-label">Tel:</span> <span class="phone-val">@LabelData.Shipper.Tel</span>
                                    @if (!string.IsNullOrWhiteSpace(LabelData.Shipper.Mob))
                                    {
                                        <span class="phone-spacer"></span>
                                        <span class="phone-label">Mob:</span> <span class="phone-val">@LabelData.Shipper.Mob</span>
                                    }
                                </div>
                            </div>
                        </td>
                        <td class="addr-cell receiver-cell">
                            <div class="addr-header addr-header-dark">TO (RECEIVER)</div>
                            <div class="addr-body">
                                <div class="addr-name-lg">@LabelData.Receiver.Name</div>
                                <div class="addr-text-lg">@LabelData.Receiver.Address</div>
                                <div class="addr-phone-lg">
                                    <span class="phone-label">Tel:</span> <span class="phone-val">@LabelData.Receiver.Tel</span>
                                    @if (!string.IsNullOrWhiteSpace(LabelData.Receiver.Mob))
                                    {
                                        <span class="phone-spacer"></span>
                                        <span class="phone-label">Mob:</span> <span class="phone-val">@LabelData.Receiver.Mob</span>
                                    }
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>

                <div class="instructions-bar">
                    <span class="inst-label">Item Description / Special Instruction:</span>
                    <span class="inst-text">@LabelData.Instructions</span>
                </div>
            </div>

            <div class="body-right">
                <div class="barcode-box">
                    @if (_barcodeBase64 != null)
                    {
                        <img src="data:image/png;base64,@_barcodeBase64" class="barcode-img" />
                    }
                    else
                    {
                        <div class="barcode-placeholder">
                            @for (int i = 0; i < 40; i++)
                            {
                                var w = i % 3 == 0 ? "2px" : "1px";
                                <span style="display:inline-block;width:@w;height:30px;background:black;margin-right:1px;"></span>
                            }
                        </div>
                    }
                    <div class="barcode-text">@SpaceOutText(LabelData.Waybill)</div>
                </div>

                <table class="metrics-table">
                    <tr>
                        <td class="metric-cell">
                            <div class="metric-label">PIECES</div>
                            <div class="metric-value">@LabelData.Pieces</div>
                        </td>
                        <td class="metric-cell metric-border-left">
                            <div class="metric-label">WEIGHT</div>
                            <div class="metric-value">@LabelData.Weight</div>
                        </td>
                        <td class="metric-cell metric-border-left">
                            <div class="metric-label">V.WEIGHT</div>
                            <div class="metric-value">@LabelData.VolumetricWeight</div>
                        </td>
                    </tr>
                </table>

                @if (LabelData.IsReturnService)
                {
                    <div class="return-service-tag">RETURN SERVICE</div>
                }

                <div class="cod-box">
                    <div class="cod-label">COLLECT CASH</div>
                    <div class="cod-amount">
                        <span class="cod-currency">@LabelData.Currency</span>
                        <span class="cod-value">@LabelData.Cod</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pod-section">
            <div class="pod-header-row">
                <div class="pod-header-left">
                    <div class="pod-desc-label">Item Description / Special Instruction</div>
                    <div class="pod-desc-text">@LabelData.Instructions</div>
                </div>
                <div class="pod-header-right">
                    <div class="pod-title">Proof of Delivery</div>
                    <div class="pod-condition">Consignment Received in Good Condition</div>
                </div>
            </div>

            <div class="pod-fields-row">
                <div class="pod-left-col">
                    <div class="pod-field-label">Collected By (Name &amp; Signature)</div>
                    <div class="pod-field-line"></div>
                    <div class="pod-service-type">
                        <span class="pod-field-label">Service Type : </span>
                        <span class="pod-service-val">@LabelData.ServiceType</span>
                    </div>
                    <div class="pod-field-label">Date &amp; Time</div>
                    <div class="pod-field-line"></div>
                </div>
                <div class="pod-right-col">
                    <div class="pod-field-label">Name &amp; Signature</div>
                    <div class="pod-field-line"></div>
                    <div class="pod-field-label">Date &amp; Time</div>
                    <div class="pod-field-line"></div>
                    <div class="pod-field-label">Delivered By (Name &amp; Signature)</div>
                    <div class="pod-field-line"></div>
                    <div class="pod-field-label">Date &amp; Time</div>
                </div>
            </div>
        </div>

        <div class="label-footer">
            <div class="footer-top">
                @if (!string.IsNullOrWhiteSpace(LabelData.SpecialInstructions))
                {
                    <span class="footer-instructions"><span style="font-weight:800;">Instructions:</span> @LabelData.SpecialInstructions</span>
                }
            </div>
            <div class="footer-bottom">
                <span>
                    @if (!string.IsNullOrEmpty(LabelData.AccountNo))
                    {
                        <span>Account: @LabelData.AccountNo</span>
                    }
                    @if (!string.IsNullOrEmpty(_website))
                    {
                        <span style="margin-left:16px;">@_website</span>
                    }
                </span>
                <span>Page 1 of 1</span>
            </div>
        </div>

    </div>
</div>

<style>
    * { box-sizing: border-box; }

    .a5-page-wrap {
        display: flex;
        justify-content: center;
        padding: 24px 0;
        background: #f1f5f9;
    }

    .a5-label {
        width: 210mm;
        height: 148mm;
        background: white;
        border: 2px solid #1a1a1a;
        padding: 5mm 7mm 5mm 7mm;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 8px;
        color: #111;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .header-table {
        width: 100%;
        border-collapse: collapse;
        border-bottom: 2px solid #111;
        padding-bottom: 3mm;
        margin-bottom: 2mm;
    }
    .header-table td { vertical-align: middle; padding-bottom: 3mm; }
    .header-left { width: 30%; }
    .header-center { width: 35%; text-align: center; }
    .header-right { width: 35%; text-align: right; }

    .company-name {
        font-size: 20px;
        font-weight: 900;
        font-style: italic;
        color: #1e3a8a;
        line-height: 1;
    }
    .service-tag {
        display: inline-block;
        background: #1e3a8a;
        color: white;
        font-size: 7px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 2px;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-top: 3px;
    }

    .route-pill {
        display: inline-flex;
        align-items: center;
        border: 2px solid #111;
        border-radius: 22px;
        padding: 4px 16px;
        gap: 8px;
    }
    .route-origin { font-size: 13px; font-weight: 700; }
    .route-arrow { font-size: 14px; }
    .route-dest { font-size: 13px; font-weight: 900; text-decoration: underline; text-underline-offset: 2px; }

    .awb-caption { font-size: 8px; font-weight: 600; color: #666; letter-spacing: 0.5px; }
    .awb-number { font-size: 18px; font-weight: 900; line-height: 1.1; letter-spacing: 1px; }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0 4px 0;
        border-bottom: 1px solid #ddd;
        margin-bottom: 3mm;
    }
    .info-label { font-size: 7px; font-weight: 700; color: #666; }
    .info-value { font-size: 8px; font-weight: 700; color: #111; }

    .body-area {
        display: flex;
        gap: 4mm;
        flex: 1;
        min-height: 0;
        margin-bottom: 3mm;
    }
    .body-left {
        flex: 6;
        display: flex;
        flex-direction: column;
        gap: 3mm;
    }
    .body-right {
        flex: 4;
        display: flex;
        flex-direction: column;
        gap: 3mm;
    }

    .addr-table {
        width: 100%;
        border-collapse: collapse;
        flex: 1;
    }
    .addr-cell {
        width: 50%;
        vertical-align: top;
        border: 1px solid #333;
    }
    .shipper-cell { border-right: none; }
    .receiver-cell { border-width: 2px; }

    .addr-header {
        background: #e8ecf1;
        border-bottom: 1px solid #333;
        padding: 2px 6px;
        font-size: 7px;
        font-weight: 800;
        letter-spacing: 0.5px;
    }
    .addr-header-dark {
        background: #1a1a1a;
        color: white;
        border-bottom: 2px solid #1a1a1a;
    }
    .addr-body { padding: 4px 6px; }
    .addr-name { font-size: 11px; font-weight: 900; text-transform: uppercase; }
    .addr-name-lg { font-size: 10px; font-weight: 900; text-transform: uppercase; }
    .addr-text { font-size: 8px; color: #333; line-height: 1.4; margin-top: 1px; }
    .addr-text-lg { font-size: 7px; line-height: 1.4; margin-top: 1px; }
    .addr-phone { font-size: 8px; font-weight: 700; margin-top: 3px; }
    .addr-phone-lg { font-size: 7px; font-weight: 800; margin-top: 3px; }
    .phone-label { font-size: 7px; font-weight: 600; color: #666; }
    .phone-val { font-weight: 700; }
    .phone-spacer { display: inline-block; width: 10px; }

    .instructions-bar {
        border: 1px solid #333;
        padding: 4px 8px;
        font-size: 7px;
        background: #fffbeb;
    }
    .inst-label { font-weight: 900; font-size: 7px; letter-spacing: 0.3px; }
    .inst-text { font-style: italic; margin-left: 4px; font-size: 7px; }

    .barcode-box {
        border: 1px solid #333;
        padding: 5px 8px;
        text-align: center;
    }
    .barcode-img { height: 30px; max-width: 100%; display: block; margin: 0 auto; }
    .barcode-placeholder { text-align: center; line-height: 0; }
    .barcode-text { font-size: 9px; font-weight: 600; letter-spacing: 4px; margin-top: 3px; }

    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #333;
    }
    .metric-cell { padding: 3px 6px; text-align: center; width: 33.33%; }
    .metric-border-left { border-left: 1px solid #333; }
    .metric-label { font-size: 6px; font-weight: 700; color: #666; letter-spacing: 0.5px; }
    .metric-value { font-size: 12px; font-weight: 900; }

    .return-service-tag {
        background: #dc2626;
        color: white;
        font-size: 7px;
        font-weight: 700;
        text-align: center;
        padding: 2px 6px;
    }

    .cod-box {
        background: #1a1a1a;
        color: white;
        padding: 6px 8px;
        border-radius: 4px;
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .cod-label { font-size: 7px; font-weight: 700; letter-spacing: 1px; opacity: 0.85; }
    .cod-amount { display: flex; align-items: baseline; justify-content: center; gap: 4px; }
    .cod-currency { font-size: 9px; font-weight: 700; }
    .cod-value { font-size: 22px; font-weight: 900; line-height: 1.1; }

    .pod-section {
        border-top: 2px solid #111;
        padding-top: 3mm;
        margin-top: auto;
    }

    .pod-header-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3mm;
    }
    .pod-header-left { flex: 1; }
    .pod-header-right { flex: 1; text-align: right; }
    .pod-desc-label { font-size: 7px; font-weight: 700; color: #666; }
    .pod-desc-text { font-size: 7px; margin-top: 2px; }
    .pod-title { font-size: 8px; font-weight: 900; }
    .pod-condition { font-size: 6px; color: #666; margin-top: 2px; }

    .pod-fields-row {
        display: flex;
        gap: 14px;
    }
    .pod-left-col { flex: 1; }
    .pod-right-col { flex: 1; }
    .pod-field-label { font-size: 6px; color: #c44; font-weight: 600; margin-top: 3px; }
    .pod-field-line { border-bottom: 0.5px solid #111; height: 10px; }
    .pod-service-type { margin-top: 3px; }
    .pod-service-val { font-size: 7px; font-weight: 700; }

    .label-footer {
        font-size: 7px;
        font-weight: 600;
        color: #1e3a5f;
        margin-top: 2mm;
        padding-top: 2mm;
    }
    .footer-top {
        margin-bottom: 1mm;
    }
    .footer-instructions {
        font-size: 7px;
        font-style: italic;
        color: #b45309;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        display: inline-block;
    }
    .footer-bottom {
        display: flex;
        justify-content: space-between;
    }

    @@media print {
        .no-print { display: none !important; }
        body { margin: 0; padding: 0; }
        .a5-page-wrap { padding: 0; background: white; }
        .a5-label {
            width: 210mm;
            height: 148mm;
            border: none;
            box-shadow: none;
            margin: 0;
        }
        @@page {
            size: A5 landscape;
            margin: 0;
        }
    }
</style>

<script suppress-error="BL9992">
    function printA5Label() {
        var el = document.getElementById('a5-label-printable');
        if (!el) return;
        var html = el.outerHTML;
        var styles = '';
        var styleTags = document.querySelectorAll('style');
        for (var i = 0; i < styleTags.length; i++) { styles += styleTags[i].outerHTML; }
        var w = window.open('', '_blank', 'width=1000,height=700');
        w.document.write('<html><head><title>AWB Label</title>' + styles +
            '<style>@@page{size:A5 landscape;margin:0;}body{margin:0;padding:0;}.no-print{display:none!important;}.a5-page-wrap{padding:0;background:white;}</style></head><body>' +
            '<div class="a5-page-wrap">' + html + '</div></body></html>');
        w.document.close();
        w.focus();
        setTimeout(function () { w.print(); }, 600);
    }
</script>

@code {
    [Parameter] public long AwbId { get; set; }

    private A5LabelModel LabelData = new();
    private string? _logoBase64;
    private string? _barcodeBase64;
    private string _companyName = "Net4Courier";
    private string? _website;

    private string SpaceOutText(string text)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return string.Join(" ", text.ToCharArray());
    }

    protected override async Task OnInitializedAsync()
    {
        if (AwbId > 0)
            await LoadShipmentData();
        else
            LoadDemoData();
    }

    private async Task LoadShipmentData()
    {
        var awb = await Db.InscanMasters.FindAsync(AwbId);
        if (awb == null) return;

        if (awb.BarcodeImage == null && !string.IsNullOrEmpty(awb.AWBNo))
        {
            var (h, v) = BarcodeService.GenerateBothBarcodes(awb.AWBNo);
            awb.BarcodeImage = h;
        }

        if (awb.BarcodeImage != null)
            _barcodeBase64 = Convert.ToBase64String(awb.BarcodeImage);

        if (awb.BranchId.HasValue)
        {
            var branch = await Db.Branches.Include(b => b.Company).FirstOrDefaultAsync(b => b.Id == awb.BranchId);
            if (branch?.Company != null)
            {
                _companyName = branch.Company.Name ?? "Net4Courier";
                _website = branch.Company.Website;
                if (!string.IsNullOrEmpty(branch.Company.Logo))
                    _logoBase64 = branch.Company.Logo;
            }
        }

        if (_logoBase64 == null)
        {
            var company = await Db.Companies.FirstOrDefaultAsync(c => !c.IsDeleted);
            if (company != null)
            {
                if (string.IsNullOrEmpty(_companyName) || _companyName == "Net4Courier")
                    _companyName = company.Name ?? "Net4Courier";
                _website ??= company.Website;
                if (!string.IsNullOrEmpty(company.Logo))
                    _logoBase64 = company.Logo;
            }
        }

        var shipperAddress = BuildAddress(awb.ConsignorAddress1, awb.ConsignorAddress2, awb.ConsignorCity, awb.ConsignorCountry);
        var receiverAddress = BuildAddress(awb.ConsigneeAddress1, awb.ConsigneeAddress2, awb.ConsigneeCity, awb.ConsigneeCountry);

        string customerAccountNo = "";
        if (awb.CustomerId.HasValue)
        {
            var customer = await Db.Parties.FirstOrDefaultAsync(p => p.Id == awb.CustomerId.Value);
            customerAccountNo = customer?.CustomerAccountNo ?? "";
        }

        var weight = awb.ChargeableWeight ?? awb.Weight ?? 0;
        var vWeight = awb.VolumetricWeight ?? 0;
        var pieces = awb.Pieces ?? 1;
        var codAmount = awb.IsCOD ? (awb.CODAmount ?? 0) : 0;
        var vatAmount = awb.TaxAmount ?? 0;
        var dutyAmount = awb.DutyVatAmount ?? 0;
        var totalCollect = codAmount + vatAmount + dutyAmount;

        var originCountryCode = await ResolveCountryCode(awb.ConsignorCountry);
        var destCountryCode = await ResolveCountryCode(awb.ConsigneeCountry);

        LabelData = new A5LabelModel
        {
            Waybill = awb.AWBNo ?? "",
            BookingDate = awb.TransactionDate.ToString("dd/MM/yyyy"),
            AccountNo = customerAccountNo,
            ShipperReference = awb.ReferenceNo ?? "",
            ServiceType = awb.CargoDescription ?? "E-COMMERCE DELIVERY",
            Origin = originCountryCode,
            Destination = destCountryCode,
            Cod = totalCollect > 0 ? totalCollect.ToString("N2") : "0.00",
            Currency = awb.Currency ?? "AED",
            Weight = $"{weight:F2} KG",
            VolumetricWeight = $"{vWeight:F2}",
            Pieces = pieces.ToString(),
            IsReturnService = awb.IsReturnedToConsignor,
            Instructions = awb.Remarks ?? "",
            SpecialInstructions = awb.SpecialInstructions ?? "",
            Shipper = new A5Entity { Name = awb.Consignor ?? "", Address = shipperAddress, Tel = awb.ConsignorPhone ?? "", Mob = awb.ConsignorMobile ?? "" },
            Receiver = new A5Entity { Name = awb.Consignee ?? "", Address = receiverAddress, Tel = awb.ConsigneePhone ?? "", Mob = awb.ConsigneeMobile ?? "" }
        };
    }

    private void LoadDemoData()
    {
        LabelData = new A5LabelModel
        {
            Waybill = "ND23291",
            BookingDate = "23/01/2026",
            AccountNo = "ND1134",
            ShipperReference = "REF-2026-001",
            ServiceType = "E-COMMERCE DELIVERY",
            Origin = "AE",
            Destination = "AE",
            Cod = "1.00",
            Currency = "AED",
            Weight = "0.00 KG",
            VolumetricWeight = "0.00",
            Pieces = "1",
            IsReturnService = false,
            Instructions = "Fragile - Handle with care. Please call before delivery.",
            SpecialInstructions = "Call before delivery. Do not leave at door.",
            Shipper = new A5Entity { Name = "A&F FASHION / ADIL", Address = "UMMO RAMOOL, DUBAI, UAE", Tel = "+971523379386", Mob = "" },
            Receiver = new A5Entity { Name = "ROLNDY WILKINS", Address = "AJMAN ROWDA 1, STREET 118, AJMAN, UAE", Tel = "1234", Mob = "+971551234567" }
        };
        _website = "www.net4courier.com";
    }

    private async Task<string> ResolveCountryCode(string? countryName)
    {
        if (string.IsNullOrWhiteSpace(countryName)) return "---";
        var country = await Db.Countries.AsNoTracking()
            .FirstOrDefaultAsync(c => c.Code != null && (c.Name == countryName || c.Code == countryName));
        if (country?.Code != null) return country.Code.ToUpper();
        if (countryName.Length <= 3) return countryName.ToUpper();
        return countryName.Substring(0, 3).ToUpper();
    }

    private string BuildAddress(string? addr1, string? addr2, string? city, string? country)
    {
        var parts = new List<string>();
        var street = $"{addr1} {addr2}".Trim();
        if (!string.IsNullOrEmpty(street)) parts.Add(street);
        if (!string.IsNullOrEmpty(city)) parts.Add(city);
        if (!string.IsNullOrEmpty(country)) parts.Add(country);
        return string.Join(", ", parts).ToUpper();
    }

    public class A5LabelModel
    {
        public string Waybill { get; set; } = "";
        public string BookingDate { get; set; } = "";
        public string AccountNo { get; set; } = "";
        public string ShipperReference { get; set; } = "";
        public string ServiceType { get; set; } = "";
        public string Origin { get; set; } = "";
        public string Destination { get; set; } = "";
        public string Cod { get; set; } = "";
        public string Currency { get; set; } = "AED";
        public string Weight { get; set; } = "";
        public string VolumetricWeight { get; set; } = "";
        public string Pieces { get; set; } = "";
        public bool IsReturnService { get; set; }
        public string Instructions { get; set; } = "";
        public string SpecialInstructions { get; set; } = "";
        public A5Entity Shipper { get; set; } = new();
        public A5Entity Receiver { get; set; } = new();
    }

    public class A5Entity
    {
        public string Name { get; set; } = "";
        public string Address { get; set; } = "";
        public string Tel { get; set; } = "";
        public string Mob { get; set; } = "";
    }
}

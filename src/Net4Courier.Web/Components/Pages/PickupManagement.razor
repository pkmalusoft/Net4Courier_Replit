@page "/pickup-management"
@page "/pickup-dashboard"
@inject ApplicationDbContext DbContext
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject PickupCommitmentService CommitmentService
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Operations.Enums
@using Net4Courier.Masters.Entities
@using Net4Courier.Web.Services
@using ClosedXML.Excel

<PageTitle>Pickup Dashboard - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Pickup Dashboard</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="2">
            <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_fromDate" Label="From" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_toDate" Label="To" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="PickupStatus?" @bind-Value="_statusFilter" Label="Status" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="PickupStatus?" Value="@((PickupStatus?)null)">All Status</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.PickupRequest">Pickup Request</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.AssignedForCollection">Assigned for Collection</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.Attempted">Attempted</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.ShipmentCollected">Shipment Collected</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.Inscanned">Inscanned</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.Cancelled">Cancelled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="long?" @bind-Value="_courierFilter" Label="Courier" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="long?" Value="@((long?)null)">All Couriers</MudSelectItem>
                @foreach (var courier in _courierEmployees)
                {
                    <MudSelectItem T="long?" Value="@((long?)courier.Id)">@courier.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="1">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="Search" FullWidth="true" Class="mt-1">Search</MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="1">
            <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.FileDownload" 
                       OnClick="DownloadExcel" Disabled="@(!_pickups.Any())" FullWidth="true" Class="mt-1">Excel</MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/pickup-request-new" FullWidth="true" Class="mt-1">
                New
            </MudButton>
        </MudItem>
    </MudGrid>
    <MudGrid Class="mt-2">
        <MudItem xs="12" sm="6" md="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Description" 
                       OnClick="DownloadTemplate" FullWidth="true">Download Template</MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudFileUpload T="IBrowserFile" Accept=".xlsx,.xls" FilesChanged="OnExcelFileSelected" Class="ma-0">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.CloudUpload" 
                               FullWidth="true" Disabled="@_isUploading">
                        @if (_isUploading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            @:Uploading...
                        }
                        else
                        {
                            @:Upload Excel
                        }
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudGrid Class="mb-4">
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #fff3e0;">
            <MudText Typo="Typo.h5" Color="Color.Warning">@_statusCounts.GetValueOrDefault(PickupStatus.PickupRequest)</MudText>
            <MudText Typo="Typo.caption">Pending</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #e3f2fd;">
            <MudText Typo="Typo.h5" Color="Color.Info">@_statusCounts.GetValueOrDefault(PickupStatus.AssignedForCollection)</MudText>
            <MudText Typo="Typo.caption">Assigned</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #e8f5e9;">
            <MudText Typo="Typo.h5" Color="Color.Success">@_statusCounts.GetValueOrDefault(PickupStatus.ShipmentCollected)</MudText>
            <MudText Typo="Typo.caption">Collected</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center cursor-pointer" Style="background-color: #fce4ec;" @onclick="() => _showCommitmentFilter = CommitmentFilterType.Committed">
            <MudText Typo="Typo.h5" Style="color: #ad1457;">@_commitmentStats.ActiveCommitments</MudText>
            <MudText Typo="Typo.caption">Committed</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center cursor-pointer" Style="background-color: #ffebee;" @onclick="() => _showCommitmentFilter = CommitmentFilterType.ExpiringSoon">
            <MudText Typo="Typo.h5" Color="Color.Error">@_commitmentStats.ExpiringSoon</MudText>
            <MudText Typo="Typo.caption">Expiring Soon</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="4" md="2">
        <MudPaper Class="pa-3 d-flex flex-column align-center cursor-pointer" Style="background-color: #e8f5e9;" @onclick="() => _showCommitmentFilter = CommitmentFilterType.Available">
            <MudText Typo="Typo.h5" Style="color: #2e7d32;">@_commitmentStats.AvailablePickups</MudText>
            <MudText Typo="Typo.caption">Available</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@if (_showCommitmentFilter != CommitmentFilterType.None)
{
    <MudPaper Class="pa-2 mb-4" Elevation="1" Style="background-color: #f5f5f5;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" />
            <MudText Typo="Typo.body2">
                Showing: <strong>@GetCommitmentFilterLabel()</strong>
            </MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="() => { _showCommitmentFilter = CommitmentFilterType.None; Search(); }">
                Clear Filter
            </MudButton>
        </MudStack>
    </MudPaper>
}

@if (!_courierFilter.HasValue && _activeCommitments.Any())
{
    <MudText Typo="Typo.subtitle1" Class="mb-2 mt-4" Style="font-weight: 600;">Active Commitments by Courier</MudText>
    @foreach (var group in GetCommittedPickupsGroupedByCourier())
    {
        var courierKey = group.Key;
        <MudExpansionPanels Class="mb-2">
            <MudExpansionPanel Expanded="@IsExpanded(courierKey)" ExpandedChanged="@(v => SetExpanded(courierKey, v))">
                <TitleContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@group.Key</MudText>
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@group.Count() pickups</MudChip>
                    </MudStack>
                </TitleContent>
                <ChildContent>
                    <MudTable Items="@group.ToList()" Hover="true" Striped="true" Dense="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Pickup No</MudTh>
                            <MudTh>Request Date</MudTh>
                            <MudTh>Customer</MudTh>
                            <MudTh>Address</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Commitment</MudTh>
                            <MudTh Style="width: 180px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Pickup No">
                                <MudLink Href="@($"/pickup-request-edit/{context.Id}")">@context.PickupNo</MudLink>
                            </MudTd>
                            <MudTd DataLabel="Request Date">@context.RequestDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
                            <MudTd DataLabel="Customer">@context.CustomerName</MudTd>
                            <MudTd DataLabel="Address">@context.City, @context.PostalCode</MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@GetStatusText(context.Status)</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Commitment">
                                @{
                                    var grpCommitment = GetActiveCommitment(context.Id);
                                    if (grpCommitment != null)
                                    {
                                        var grpTimeRemaining = grpCommitment.ExpiresAt - DateTime.UtcNow;
                                        var grpIsExpiring = grpTimeRemaining.TotalMinutes <= 10;
                                        <MudChip T="string" Size="Size.Small" Color="@(grpIsExpiring ? Color.Error : Color.Info)">
                                            @(grpCommitment.Status == PickupCommitmentStatus.Confirmed ? "Confirmed" : FormatTimeRemaining(grpTimeRemaining))
                                        </MudChip>
                                    }
                                }
                            </MudTd>
                            <MudTd>
                                @{
                                    var grpPickupCommitment = GetActiveCommitment(context.Id);
                                }
                                @if (grpPickupCommitment != null && grpPickupCommitment.Status == PickupCommitmentStatus.Active)
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" 
                                               OnClick="@(() => ConfirmCommitment(grpPickupCommitment))">Confirm</MudButton>
                                    <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small"
                                               OnClick="@(() => OverrideCommitment(context, grpPickupCommitment))">Override</MudButton>
                                }
                                else if (context.Status == PickupStatus.PickupRequest)
                                {
                                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                               OnClick="@(() => OpenAssignDialog(context))">Assign</MudButton>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </ChildContent>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
}
else
{
<MudPaper Elevation="2">
    <MudTable Items="@GetFilteredPickups()" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary" Breakpoint="Breakpoint.Sm">
        <HeaderContent>
            <MudTh>Pickup No</MudTh>
            <MudTh>Request Date</MudTh>
            <MudTh>Customer</MudTh>
            <MudTh>Address</MudTh>
            <MudTh>Est. Pieces</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Commitment</MudTh>
            <MudTh>Courier</MudTh>
            <MudTh Style="width: 200px;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Pickup No">
                <MudLink Href="@($"/pickup-request-edit/{context.Id}")">@context.PickupNo</MudLink>
            </MudTd>
            <MudTd DataLabel="Request Date">@context.RequestDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Customer">@context.CustomerName</MudTd>
            <MudTd DataLabel="Address">@context.City, @context.PostalCode</MudTd>
            <MudTd DataLabel="Est. Pieces">@context.EstimatedPieces</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@GetStatusText(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="Commitment">
                @{
                    var commitment = GetActiveCommitment(context.Id);
                    if (commitment != null)
                    {
                        var timeRemaining = commitment.ExpiresAt - DateTime.UtcNow;
                        var isExpiringSoon = timeRemaining.TotalMinutes <= 10;
                        var chipColor = isExpiringSoon ? Color.Error : Color.Info;
                        var statusText = commitment.Status == PickupCommitmentStatus.Confirmed ? "Confirmed" : 
                                         (isExpiringSoon ? $"{(int)timeRemaining.TotalMinutes}m left" : "Committed");
                        <MudStack Spacing="0">
                            <MudChip T="string" Color="@chipColor" Size="Size.Small" Icon="@Icons.Material.Filled.Schedule">
                                @statusText
                            </MudChip>
                            @if (commitment.Status == PickupCommitmentStatus.Active && timeRemaining.TotalMinutes > 0)
                            {
                                <MudText Typo="Typo.caption" Color="@(isExpiringSoon ? Color.Error : Color.Default)">
                                    @FormatTimeRemaining(timeRemaining)
                                </MudText>
                            }
                        </MudStack>
                    }
                    else if (context.Status == PickupStatus.PickupRequest)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Outlined">Available</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Default">-</MudText>
                    }
                }
            </MudTd>
            <MudTd DataLabel="Courier">
                @if (!string.IsNullOrEmpty(context.CourierName))
                {
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@context.CourierName</MudText>
                        @if (!string.IsNullOrEmpty(context.CourierPhone))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Default">@context.CourierPhone</MudText>
                        }
                    </MudStack>
                }
                else
                {
                    var commitment = GetActiveCommitment(context.Id);
                    if (commitment != null)
                    {
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2" Color="Color.Info">@commitment.CourierName</MudText>
                            <MudText Typo="Typo.caption">(Committed)</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudText>-</MudText>
                    }
                }
            </MudTd>
            <MudTd>
                @{
                    var pickupCommitment = GetActiveCommitment(context.Id);
                }
                @if (context.Status == PickupStatus.PickupRequest || context.Status == PickupStatus.Attempted)
                {
                    @if (pickupCommitment != null && pickupCommitment.Status == PickupCommitmentStatus.Active)
                    {
                        <MudTooltip Text="Override Commitment">
                            <MudIconButton Icon="@Icons.Material.Filled.SwapHoriz" Size="Size.Small" Color="Color.Warning" 
                                           OnClick="@(() => OverrideCommitment(context, pickupCommitment))" />
                        </MudTooltip>
                        <MudTooltip Text="Confirm & Assign">
                            <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" 
                                           OnClick="@(() => ConfirmCommitment(pickupCommitment))" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="Assign Courier">
                            <MudIconButton Icon="@Icons.Material.Filled.AssignmentInd" Size="Size.Small" Color="Color.Primary" 
                                           OnClick="@(() => OpenAssignDialog(context))" />
                        </MudTooltip>
                    }
                }
                @if (context.Status == PickupStatus.AssignedForCollection)
                {
                    <MudTooltip Text="Mark Collected">
                        <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" 
                                       OnClick="@(() => MarkCollected(context))" />
                    </MudTooltip>
                    <MudTooltip Text="Mark Attempted">
                        <MudIconButton Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Small" Color="Color.Error" 
                                       OnClick="@(() => MarkAttempted(context))" />
                    </MudTooltip>
                }
                @if (context.Status == PickupStatus.ShipmentCollected)
                {
                    <MudTooltip Text="INSCAN">
                        <MudIconButton Icon="@Icons.Material.Filled.QrCodeScanner" Size="Size.Small" Color="Color.Secondary" 
                                       OnClick="@(() => NavigateToInscan(context))" />
                    </MudTooltip>
                }
                <MudTooltip Text="Edit">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Default" 
                                   Href="@($"/pickup-request-edit/{context.Id}")" />
                </MudTooltip>
                <MudTooltip Text="Change Status">
                    <MudIconButton Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Warning" 
                                   OnClick="@(() => OpenStatusChangeDialog(context))" />
                </MudTooltip>
                @if (context.Status == PickupStatus.PickupRequest)
                {
                    <MudTooltip Text="Cancel">
                        <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error" 
                                       OnClick="@(() => CancelPickup(context))" />
                    </MudTooltip>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No pickup requests found.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>
}

@if (_courierPerformance.Any())
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" GutterBottom="true">Courier Performance (Today)</MudText>
        <MudTable Items="@_courierPerformance" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Courier</MudTh>
                <MudTh>Active</MudTh>
                <MudTh>Confirmed</MudTh>
                <MudTh>Completed</MudTh>
                <MudTh>Expired</MudTh>
                <MudTh>Released</MudTh>
                <MudTh>Rate</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.CourierName</MudTd>
                <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Info">@context.Active</MudChip></MudTd>
                <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.Confirmed</MudChip></MudTd>
                <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Success">@context.Completed</MudChip></MudTd>
                <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.Expired</MudChip></MudTd>
                <MudTd><MudChip T="string" Size="Size.Small" Color="Color.Default">@context.Released</MudChip></MudTd>
                <MudTd>
                    <MudProgressLinear Color="@GetRateColor(context.CompletionRate)" Value="@((double)context.CompletionRate)" Max="100" Style="min-width: 80px;" />
                    <MudText Typo="Typo.caption">@context.CompletionRate.ToString("0.0")%</MudText>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}

@code {
    private List<PickupRequest> _pickups = new();
    private List<PickupCommitment> _activeCommitments = new();
    private Dictionary<long, PickupCommitment> _commitmentByPickup = new();
    private bool _loading = true;
    private string _searchString = "";
    private DateTime? _fromDate = DateTime.Today.AddDays(-7);
    private DateTime? _toDate = DateTime.Today;
    private PickupStatus? _statusFilter;
    private long? _courierFilter;
    private Dictionary<PickupStatus, int> _statusCounts = new();
    private List<Employee> _courierEmployees = new();
    private CommitmentSummary _commitmentStats = new();
    private List<CourierPerformanceRow> _courierPerformance = new();
    private CommitmentFilterType _showCommitmentFilter = CommitmentFilterType.None;
    private System.Timers.Timer? _refreshTimer;
    private Dictionary<string, bool> _expansionStates = new();
    private bool _isUploading = false;

    protected override async Task OnInitializedAsync()
    {
        _courierEmployees = await DbContext.Employees
            .Include(e => e.Designation)
            .Include(e => e.Department)
            .Where(e => !e.IsDeleted && e.IsActive && 
                ((e.Designation != null && EF.Functions.ILike(e.Designation.Name, "%courier%")) || 
                 (e.Department != null && EF.Functions.ILike(e.Department.Name, "%courier%"))))
            .OrderBy(e => e.Name)
            .ToListAsync();
        
        // If no courier employees found by designation/department, load all active employees as fallback
        if (!_courierEmployees.Any())
        {
            _courierEmployees = await DbContext.Employees
                .Where(e => !e.IsDeleted && e.IsActive)
                .OrderBy(e => e.Name)
                .ToListAsync();
        }
        await Search();
        await LoadStatusCounts();
        await LoadCommitmentData();
        await LoadCourierPerformance();
        StartAutoRefresh();
    }

    private CancellationTokenSource _cts = new();

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Timers.Timer(30000);
        _refreshTimer.Elapsed += async (s, e) =>
        {
            if (_cts.IsCancellationRequested) return;
            
            try
            {
                await InvokeAsync(async () =>
                {
                    if (_cts.IsCancellationRequested) return;
                    await LoadCommitmentDataFromFactory();
                    StateHasChanged();
                });
            }
            catch (ObjectDisposedException)
            {
            }
        };
        _refreshTimer.Start();
    }

    private async Task LoadCommitmentDataFromFactory()
    {
        await using var context = await DbContextFactory.CreateDbContextAsync();
        
        var pickupIds = _pickups.Select(p => p.Id).ToList();
        
        _activeCommitments = await context.PickupCommitments
            .Where(c => pickupIds.Contains(c.PickupRequestId) && 
                   (c.Status == PickupCommitmentStatus.Active || c.Status == PickupCommitmentStatus.Confirmed))
            .ToListAsync();

        _commitmentByPickup = _activeCommitments
            .GroupBy(c => c.PickupRequestId)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(c => c.CommittedAt).First());

        var pendingPickupIds = _pickups.Where(p => p.Status == PickupStatus.PickupRequest).Select(p => p.Id).ToList();
        var committedPickupIds = _activeCommitments.Where(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow)
            .Select(c => c.PickupRequestId).ToHashSet();

        _commitmentStats = new CommitmentSummary
        {
            ActiveCommitments = _activeCommitments.Count(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow),
            ExpiringSoon = _activeCommitments.Count(c => c.Status == PickupCommitmentStatus.Active && 
                                                         c.ExpiresAt > DateTime.UtcNow && 
                                                         (c.ExpiresAt - DateTime.UtcNow).TotalMinutes <= 10),
            AvailablePickups = pendingPickupIds.Count(id => !committedPickupIds.Contains(id))
        };
    }

    public void Dispose()
    {
        _cts.Cancel();
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }

    private async Task Search()
    {
        _loading = true;
        var query = DbContext.PickupRequests.Where(p => !p.IsDeleted).AsQueryable();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            query = query.Where(p => p.PickupNo.Contains(_searchString) || 
                                     (p.CustomerName != null && p.CustomerName.Contains(_searchString)) ||
                                     (p.ContactPerson != null && p.ContactPerson.Contains(_searchString)));
        }

        if (_fromDate.HasValue)
        {
            var from = DateTime.SpecifyKind(_fromDate.Value, DateTimeKind.Utc);
            query = query.Where(p => p.RequestDate >= from);
        }

        if (_toDate.HasValue)
        {
            var to = DateTime.SpecifyKind(_toDate.Value.AddDays(1), DateTimeKind.Utc);
            query = query.Where(p => p.RequestDate < to);
        }

        if (_statusFilter.HasValue)
        {
            query = query.Where(p => p.Status == _statusFilter.Value);
        }

        _pickups = await query.OrderByDescending(p => p.RequestDate).ThenByDescending(p => p.Id).Take(500).ToListAsync();
        await LoadCommitmentData();
        _loading = false;
    }

    private async Task LoadCommitmentData()
    {
        var pickupIds = _pickups.Select(p => p.Id).ToList();
        
        _activeCommitments = await DbContext.PickupCommitments
            .Where(c => pickupIds.Contains(c.PickupRequestId) && 
                   (c.Status == PickupCommitmentStatus.Active || c.Status == PickupCommitmentStatus.Confirmed))
            .ToListAsync();

        _commitmentByPickup = _activeCommitments
            .GroupBy(c => c.PickupRequestId)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(c => c.CommittedAt).First());

        var pendingPickupIds = _pickups.Where(p => p.Status == PickupStatus.PickupRequest).Select(p => p.Id).ToList();
        var committedPickupIds = _activeCommitments.Where(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow)
            .Select(c => c.PickupRequestId).ToHashSet();

        _commitmentStats = new CommitmentSummary
        {
            ActiveCommitments = _activeCommitments.Count(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow),
            ExpiringSoon = _activeCommitments.Count(c => c.Status == PickupCommitmentStatus.Active && 
                                                         c.ExpiresAt > DateTime.UtcNow && 
                                                         (c.ExpiresAt - DateTime.UtcNow).TotalMinutes <= 10),
            AvailablePickups = pendingPickupIds.Count(id => !committedPickupIds.Contains(id))
        };
    }

    private async Task LoadCourierPerformance()
    {
        var today = DateTime.UtcNow.Date;
        var todayCommitments = await DbContext.PickupCommitments
            .Where(c => c.CommittedAt >= today)
            .ToListAsync();

        _courierPerformance = todayCommitments
            .GroupBy(c => new { c.CourierId, c.CourierName })
            .Select(g => new CourierPerformanceRow
            {
                CourierId = g.Key.CourierId,
                CourierName = g.Key.CourierName,
                Active = g.Count(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow),
                Confirmed = g.Count(c => c.Status == PickupCommitmentStatus.Confirmed),
                Completed = g.Count(c => c.Status == PickupCommitmentStatus.Completed),
                Expired = g.Count(c => c.Status == PickupCommitmentStatus.Expired),
                Released = g.Count(c => c.Status == PickupCommitmentStatus.Released),
                Total = g.Count()
            })
            .OrderByDescending(x => x.Total)
            .Take(10)
            .ToList();
    }

    private List<PickupRequest> GetFilteredPickups()
    {
        var result = _pickups.AsEnumerable();

        if (_courierFilter.HasValue)
        {
            var courierPickupIds = _activeCommitments
                .Where(c => c.CourierId == _courierFilter.Value && 
                       (c.Status == PickupCommitmentStatus.Active || c.Status == PickupCommitmentStatus.Confirmed))
                .Select(c => c.PickupRequestId).ToHashSet();
            
            result = result.Where(p => courierPickupIds.Contains(p.Id) || p.CourierId == _courierFilter.Value);
        }

        if (_showCommitmentFilter != CommitmentFilterType.None)
        {
            var committedPickupIds = _activeCommitments
                .Where(c => c.Status == PickupCommitmentStatus.Active && c.ExpiresAt > DateTime.UtcNow)
                .Select(c => c.PickupRequestId).ToHashSet();

            var expiringSoonIds = _activeCommitments
                .Where(c => c.Status == PickupCommitmentStatus.Active && 
                            c.ExpiresAt > DateTime.UtcNow && 
                            (c.ExpiresAt - DateTime.UtcNow).TotalMinutes <= 10)
                .Select(c => c.PickupRequestId).ToHashSet();

            result = _showCommitmentFilter switch
            {
                CommitmentFilterType.Committed => result.Where(p => committedPickupIds.Contains(p.Id)),
                CommitmentFilterType.ExpiringSoon => result.Where(p => expiringSoonIds.Contains(p.Id)),
                CommitmentFilterType.Available => result.Where(p => p.Status == PickupStatus.PickupRequest && !committedPickupIds.Contains(p.Id)),
                _ => result
            };
        }

        return result.ToList();
    }

    private IEnumerable<IGrouping<string, PickupRequest>> GetPickupsGroupedByCourier()
    {
        var pickups = GetFilteredPickups();
        return pickups
            .Select(p => new { 
                Pickup = p, 
                CourierName = GetCourierNameForPickup(p) 
            })
            .GroupBy(x => x.CourierName, x => x.Pickup)
            .OrderBy(g => g.Key == "Unassigned" ? 1 : 0)
            .ThenBy(g => g.Key);
    }

    private IEnumerable<IGrouping<string, PickupRequest>> GetCommittedPickupsGroupedByCourier()
    {
        var committedPickupIds = _activeCommitments
            .Where(c => (c.Status == PickupCommitmentStatus.Active || c.Status == PickupCommitmentStatus.Confirmed) && c.ExpiresAt > DateTime.UtcNow)
            .Select(c => c.PickupRequestId).ToHashSet();

        var pickups = _pickups.Where(p => committedPickupIds.Contains(p.Id)).ToList();
        return pickups
            .Select(p => new { 
                Pickup = p, 
                CourierName = GetCommitmentCourierName(p.Id) 
            })
            .GroupBy(x => x.CourierName, x => x.Pickup)
            .OrderBy(g => g.Key);
    }

    private string GetCommitmentCourierName(long pickupId)
    {
        var commitment = GetActiveCommitment(pickupId);
        return commitment?.CourierName ?? "Unknown";
    }

    private string GetCourierNameForPickup(PickupRequest pickup)
    {
        var commitment = GetActiveCommitment(pickup.Id);
        if (commitment != null)
            return commitment.CourierName ?? "Unknown";
        if (!string.IsNullOrEmpty(pickup.CourierName))
            return pickup.CourierName;
        return "Unassigned";
    }

    private bool IsExpanded(string key)
    {
        return _expansionStates.TryGetValue(key, out var value) ? value : true;
    }

    private void SetExpanded(string key, bool value)
    {
        _expansionStates[key] = value;
    }

    private string GetCommitmentFilterLabel() => _showCommitmentFilter switch
    {
        CommitmentFilterType.Committed => "Committed Pickups",
        CommitmentFilterType.ExpiringSoon => "Expiring Soon",
        CommitmentFilterType.Available => "Available for Commitment",
        _ => "All"
    };

    private PickupCommitment? GetActiveCommitment(long pickupId)
    {
        return _commitmentByPickup.TryGetValue(pickupId, out var commitment) ? commitment : null;
    }

    private string FormatTimeRemaining(TimeSpan time)
    {
        if (time.TotalMinutes < 1) return "< 1 min";
        if (time.TotalMinutes < 60) return $"{(int)time.TotalMinutes} min";
        return $"{(int)time.TotalHours}h {time.Minutes}m";
    }

    private async Task LoadStatusCounts()
    {
        var today = DateTime.UtcNow.Date;
        var counts = await DbContext.PickupRequests
            .Where(p => !p.IsDeleted && p.RequestDate >= today.AddDays(-7))
            .GroupBy(p => p.Status)
            .Select(g => new { Status = g.Key, Count = g.Count() })
            .ToListAsync();
        _statusCounts = counts.ToDictionary(x => x.Status, x => x.Count);
    }

    private Color GetStatusColor(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => Color.Warning,
        PickupStatus.AssignedForCollection => Color.Info,
        PickupStatus.Attempted => Color.Error,
        PickupStatus.ShipmentCollected => Color.Success,
        PickupStatus.Inscanned => Color.Secondary,
        PickupStatus.Cancelled => Color.Dark,
        _ => Color.Default
    };

    private string GetStatusText(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => "Pickup Request",
        PickupStatus.AssignedForCollection => "Assigned",
        PickupStatus.Attempted => "Attempted",
        PickupStatus.ShipmentCollected => "Collected",
        PickupStatus.Inscanned => "Inscanned",
        PickupStatus.Cancelled => "Cancelled",
        _ => status.ToString()
    };

    private Color GetRateColor(decimal rate) => rate switch
    {
        >= 80 => Color.Success,
        >= 60 => Color.Warning,
        _ => Color.Error
    };

    private async Task ConfirmCommitment(PickupCommitment commitment)
    {
        var result = await CommitmentService.ConfirmCommitmentAsync(commitment.Id);
        if (result)
        {
            Snackbar.Add($"Commitment confirmed and pickup assigned to {commitment.CourierName}", Severity.Success);
            await Search();
            await LoadStatusCounts();
        }
        else
        {
            Snackbar.Add("Failed to confirm commitment - it may have expired", Severity.Error);
            await LoadCommitmentData();
        }
    }

    private async Task OverrideCommitment(PickupRequest pickup, PickupCommitment commitment)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Override Commitment",
            $"This will release the commitment from {commitment.CourierName} and allow you to assign to a different courier. Continue?",
            "Yes, Override", "Cancel");

        if (confirm == true)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("UserId")?.Value;
            var userName = authState.User.FindFirst("FullName")?.Value ?? authState.User.Identity?.Name ?? "System";
            var userId = long.TryParse(userIdClaim, out var uid) ? uid : (long?)null;

            await CommitmentService.ReleaseCommitmentAsync(commitment.Id, "Override by dispatcher", userId, userName);
            Snackbar.Add($"Commitment from {commitment.CourierName} released", Severity.Info);
            await OpenAssignDialog(pickup);
        }
    }

    private async Task OpenAssignDialog(PickupRequest pickup)
    {
        var parameters = new DialogParameters<AssignCourierDialog>
        {
            { x => x.CourierEmployees, _courierEmployees },
            { x => x.SelectedCourierId, pickup.CourierId }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AssignCourierDialog>("Assign Courier", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled && result.Data is long courierId)
        {
            var courier = _courierEmployees.FirstOrDefault(c => c.Id == courierId);
            if (courier != null)
            {
                pickup.CourierId = courierId;
                pickup.CourierName = courier.Name;
                pickup.CourierPhone = courier.Mobile ?? courier.Phone;
                pickup.Status = PickupStatus.AssignedForCollection;
                pickup.AssignedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
                Snackbar.Add($"Pickup assigned to {courier.Name}", Severity.Success);
                await Search();
                await LoadStatusCounts();
            }
        }
    }

    private async Task MarkCollected(PickupRequest pickup)
    {
        var confirm = await DialogService.ShowMessageBox("Confirm Collection", 
            $"Mark pickup {pickup.PickupNo} as collected?", "Yes", "No");
        if (confirm == true)
        {
            pickup.Status = PickupStatus.ShipmentCollected;
            pickup.CollectedAt = DateTime.UtcNow;

            var commitment = GetActiveCommitment(pickup.Id);
            if (commitment != null && commitment.Status == PickupCommitmentStatus.Confirmed)
            {
                await CommitmentService.CompleteCommitmentAsync(commitment.Id);
            }

            await DbContext.SaveChangesAsync();
            Snackbar.Add("Pickup marked as collected", Severity.Success);
            await Search();
            await LoadStatusCounts();
            await LoadCourierPerformance();
        }
    }

    private async Task MarkAttempted(PickupRequest pickup)
    {
        var parameters = new DialogParameters
        {
            ["PickupNo"] = pickup.PickupNo
        };
        
        var dialog = await DialogService.ShowAsync<AttemptedReasonDialog>("Mark as Attempted", parameters, 
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled && result.Data is string remarks)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("UserId")?.Value;
            var userName = authState.User.FindFirst("FullName")?.Value ?? authState.User.Identity?.Name ?? "System";
            
            pickup.Status = PickupStatus.Attempted;
            pickup.AttemptedAt = DateTime.UtcNow;
            pickup.AttemptedByUserId = long.TryParse(userIdClaim, out var uid) ? uid : null;
            pickup.AttemptedByUserName = userName;
            pickup.AttemptRemarks = remarks;
            
            await DbContext.SaveChangesAsync();
            Snackbar.Add("Pickup marked as attempted - can be reassigned", Severity.Warning);
            await Search();
            await LoadStatusCounts();
        }
    }

    private void NavigateToInscan(PickupRequest pickup)
    {
        NavigationManager.NavigateTo($"/pickup-inscan?pickupId={pickup.Id}");
    }

    private async Task CancelPickup(PickupRequest pickup)
    {
        var confirm = await DialogService.ShowMessageBox("Cancel Pickup", 
            $"Are you sure you want to cancel pickup {pickup.PickupNo}?", "Yes, Cancel", "No");
        if (confirm == true)
        {
            pickup.Status = PickupStatus.Cancelled;
            await DbContext.SaveChangesAsync();
            Snackbar.Add("Pickup cancelled", Severity.Warning);
            await Search();
            await LoadStatusCounts();
        }
    }

    private async Task OpenStatusChangeDialog(PickupRequest pickup)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.PickupRequest, pickup },
            { x => x.EntityType, EntityType.Pickup }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Change Status", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await Search();
            await LoadStatusCounts();
        }
    }

    private async Task DownloadExcel()
    {
        if (!_pickups.Any()) return;

        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Pickups");

        worksheet.Cell(1, 1).Value = "Pickup Dashboard";
        worksheet.Cell(1, 1).Style.Font.Bold = true;
        worksheet.Cell(1, 1).Style.Font.FontSize = 14;
        worksheet.Range(1, 1, 1, 8).Merge();

        var headers = new[] { "Pickup No", "Date", "Customer", "Address", "Est Pieces", "Status", "Commitment", "Courier" };
        for (int i = 0; i < headers.Length; i++)
        {
            worksheet.Cell(3, i + 1).Value = headers[i];
            worksheet.Cell(3, i + 1).Style.Font.Bold = true;
            worksheet.Cell(3, i + 1).Style.Fill.BackgroundColor = XLColor.LightGray;
        }

        int row = 4;
        foreach (var pickup in _pickups)
        {
            var commitment = GetActiveCommitment(pickup.Id);
            worksheet.Cell(row, 1).Value = pickup.PickupNo ?? "";
            worksheet.Cell(row, 2).Value = pickup.RequestDate.ToString("dd/MM/yyyy HH:mm");
            worksheet.Cell(row, 3).Value = pickup.CustomerName ?? "";
            worksheet.Cell(row, 4).Value = $"{pickup.City}, {pickup.PostalCode}";
            worksheet.Cell(row, 5).Value = pickup.EstimatedPieces;
            worksheet.Cell(row, 6).Value = GetStatusText(pickup.Status);
            worksheet.Cell(row, 7).Value = commitment != null ? $"Committed ({commitment.CourierName})" : 
                                           (pickup.Status == PickupStatus.PickupRequest ? "Available" : "-");
            worksheet.Cell(row, 8).Value = pickup.CourierName ?? (commitment?.CourierName ?? "-");
            row++;
        }

        worksheet.Row(row).Style.Font.Bold = true;
        worksheet.Cell(row, 4).Value = "Total:";
        worksheet.Cell(row, 5).Value = _pickups.Sum(p => p.EstimatedPieces);

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        var fileName = $"PickupDashboard_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));
    }

    private async Task DownloadTemplate()
    {
        using var workbook = new XLWorkbook();

        var ws1 = workbook.Worksheets.Add("PickupRequests");
        var pickupHeaders = new[] { "CustomerCode", "ContactPerson", "Phone", "Mobile", "Email", "PickupAddress", "City", "State", "Country", "PostalCode", "ScheduledDate", "EstimatedPieces", "EstimatedWeight", "SpecialInstructions", "ReferenceNo" };
        for (int i = 0; i < pickupHeaders.Length; i++)
        {
            ws1.Cell(1, i + 1).Value = pickupHeaders[i];
            ws1.Cell(1, i + 1).Style.Font.Bold = true;
            ws1.Cell(1, i + 1).Style.Fill.BackgroundColor = XLColor.LightBlue;
        }
        ws1.Cell(2, 1).Value = "CUST001";
        ws1.Cell(2, 4).Value = "+971501234567";
        ws1.Cell(2, 6).Value = "123 Main Street";
        ws1.Cell(2, 7).Value = "Dubai";
        ws1.Cell(2, 9).Value = "UAE";
        ws1.Cell(2, 11).Value = DateTime.Today.AddDays(1).ToString("dd/MM/yyyy");
        ws1.Cell(2, 12).Value = 5;
        ws1.Cell(2, 13).Value = 10.5;
        ws1.Columns().AdjustToContents();

        var ws2 = workbook.Worksheets.Add("ShipmentLines");
        var shipmentHeaders = new[] { "PickupRowNo", "Consignee", "ConsigneeContact", "ConsigneePhone", "ConsigneeMobile", "ConsigneeAddress1", "ConsigneeAddress2", "ConsigneeCity", "ConsigneeState", "ConsigneeCountry", "ConsigneePostalCode", "Pieces", "Weight", "Length", "Width", "Height", "CargoDescription", "ReferenceNo", "PaymentMode", "DocumentType", "DeclaredValue", "Currency" };
        for (int i = 0; i < shipmentHeaders.Length; i++)
        {
            ws2.Cell(1, i + 1).Value = shipmentHeaders[i];
            ws2.Cell(1, i + 1).Style.Font.Bold = true;
            ws2.Cell(1, i + 1).Style.Fill.BackgroundColor = XLColor.LightGreen;
        }
        ws2.Cell(2, 1).Value = 1;
        ws2.Cell(2, 2).Value = "John Doe";
        ws2.Cell(2, 6).Value = "456 Delivery Road";
        ws2.Cell(2, 8).Value = "Abu Dhabi";
        ws2.Cell(2, 10).Value = "UAE";
        ws2.Cell(2, 12).Value = 2;
        ws2.Cell(2, 13).Value = 5.0;
        ws2.Cell(2, 19).Value = "Prepaid";
        ws2.Cell(2, 20).Value = "Document";
        ws2.Columns().AdjustToContents();

        var ws3 = workbook.Worksheets.Add("Instructions");
        ws3.Cell(1, 1).Value = "Pickup Request Excel Upload Instructions";
        ws3.Cell(1, 1).Style.Font.Bold = true;
        ws3.Cell(1, 1).Style.Font.FontSize = 14;
        ws3.Cell(3, 1).Value = "Sheet 1 - PickupRequests:";
        ws3.Cell(3, 1).Style.Font.Bold = true;
        ws3.Cell(4, 1).Value = "- Each row creates one pickup request";
        ws3.Cell(5, 1).Value = "- CustomerCode: Must match an existing customer code in the system";
        ws3.Cell(6, 1).Value = "- Mobile is required";
        ws3.Cell(7, 1).Value = "- ScheduledDate format: dd/MM/yyyy";
        ws3.Cell(9, 1).Value = "Sheet 2 - ShipmentLines:";
        ws3.Cell(9, 1).Style.Font.Bold = true;
        ws3.Cell(10, 1).Value = "- PickupRowNo: Row number from PickupRequests sheet (starting from 1 for first data row)";
        ws3.Cell(11, 1).Value = "- Multiple shipment lines can reference the same PickupRowNo";
        ws3.Cell(12, 1).Value = "- Consignee and ConsigneeCity are required";
        ws3.Cell(13, 1).Value = "- PaymentMode: Prepaid, COD, Account, PickupCash (default: Prepaid)";
        ws3.Cell(14, 1).Value = "- DocumentType: Letter, Document, Parcel, Parcel Above 30Kg (default: Document)";
        ws3.Cell(16, 1).Value = "Note: Row 2 in each sheet contains sample data. Replace or delete it before uploading.";
        ws3.Cell(16, 1).Style.Font.Italic = true;
        ws3.Column(1).Width = 80;

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        var fileName = "PickupRequest_Template.xlsx";
        await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));
        Snackbar.Add("Template downloaded successfully", Severity.Success);
    }

    private async Task OnExcelFileSelected(IBrowserFile file)
    {
        if (file == null) return;

        _isUploading = true;
        StateHasChanged();

        try
        {
            using var stream = new MemoryStream();
            await file.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            stream.Position = 0;

            using var workbook = new XLWorkbook(stream);

            var pickupSheet = workbook.Worksheets.FirstOrDefault(w => w.Name == "PickupRequests");
            if (pickupSheet == null)
            {
                Snackbar.Add("Sheet 'PickupRequests' not found. Please use the correct template.", Severity.Error);
                return;
            }

            var customers = await DbContext.Parties
                .Where(p => p.PartyType == PartyType.Customer && !p.IsDeleted && p.IsActive && p.Code != null)
                .ToDictionaryAsync(p => p.Code!.ToUpper(), p => p);

            var pickupRows = new Dictionary<int, PickupRequest>();
            var shipmentLinesToPickupRow = new List<(int PickupRowNo, PickupRequestShipment Shipment)>();
            int successCount = 0;
            int errorCount = 0;
            var errors = new List<string>();
            bool hasValidationErrors = false;

            var today = DateTime.UtcNow.Date;
            var baseCount = await DbContext.PickupRequests.Where(p => p.RequestDate >= today).CountAsync();

            var lastRow = pickupSheet.LastRowUsed()?.RowNumber() ?? 1;
            for (int row = 2; row <= lastRow; row++)
            {
                var customerCode = pickupSheet.Cell(row, 1).GetString().Trim();
                var mobile = pickupSheet.Cell(row, 4).GetString().Trim();

                if (string.IsNullOrWhiteSpace(customerCode) && string.IsNullOrWhiteSpace(mobile))
                    continue;

                if (string.IsNullOrWhiteSpace(mobile))
                {
                    errors.Add($"Row {row}: Mobile is required");
                    errorCount++;
                    hasValidationErrors = true;
                    continue;
                }

                Party? customer = null;
                if (!string.IsNullOrWhiteSpace(customerCode))
                {
                    customers.TryGetValue(customerCode.ToUpper(), out customer);
                    if (customer == null)
                    {
                        errors.Add($"Row {row}: Customer code '{customerCode}' not found");
                        errorCount++;
                        hasValidationErrors = true;
                        continue;
                    }
                }

                var scheduledDateStr = pickupSheet.Cell(row, 11).GetString().Trim();
                DateTime? scheduledDate = null;
                if (!string.IsNullOrWhiteSpace(scheduledDateStr))
                {
                    if (DateTime.TryParseExact(scheduledDateStr, new[] { "dd/MM/yyyy", "yyyy-MM-dd", "MM/dd/yyyy" }, null, System.Globalization.DateTimeStyles.None, out var dt))
                        scheduledDate = DateTime.SpecifyKind(dt, DateTimeKind.Utc);
                    else if (pickupSheet.Cell(row, 11).TryGetValue<DateTime>(out var xlDt))
                        scheduledDate = DateTime.SpecifyKind(xlDt.Date, DateTimeKind.Utc);
                }

                int.TryParse(pickupSheet.Cell(row, 12).GetString().Trim(), out var estPieces);
                decimal.TryParse(pickupSheet.Cell(row, 13).GetString().Trim(), out var estWeight);

                var pickupNo = $"PU{DateTime.UtcNow:yyyyMMdd}{(baseCount + successCount + 1):D4}";

                var pickup = new PickupRequest
                {
                    PickupNo = pickupNo,
                    RequestDate = DateTime.UtcNow,
                    ScheduledDate = scheduledDate,
                    CustomerId = customer?.Id,
                    CustomerName = customer?.Name ?? pickupSheet.Cell(row, 2).GetString().Trim(),
                    ContactPerson = pickupSheet.Cell(row, 2).GetString().Trim(),
                    Phone = pickupSheet.Cell(row, 3).GetString().Trim(),
                    Mobile = mobile,
                    Email = pickupSheet.Cell(row, 5).GetString().Trim(),
                    PickupAddress = pickupSheet.Cell(row, 6).GetString().Trim(),
                    City = pickupSheet.Cell(row, 7).GetString().Trim(),
                    State = pickupSheet.Cell(row, 8).GetString().Trim(),
                    Country = pickupSheet.Cell(row, 9).GetString().Trim(),
                    PostalCode = pickupSheet.Cell(row, 10).GetString().Trim(),
                    EstimatedPieces = estPieces > 0 ? estPieces : null,
                    EstimatedWeight = estWeight > 0 ? estWeight : null,
                    SpecialInstructions = pickupSheet.Cell(row, 14).GetString().Trim(),
                    ReferenceNo = pickupSheet.Cell(row, 15).GetString().Trim(),
                    Status = PickupStatus.PickupRequest
                };

                pickupRows[row - 1] = pickup;
                successCount++;
            }

            var shipmentSheet = workbook.Worksheets.FirstOrDefault(w => w.Name == "ShipmentLines");
            int shipmentCount = 0;
            if (shipmentSheet != null)
            {
                var lineCountByPickup = new Dictionary<int, int>();
                var lastShipmentRow = shipmentSheet.LastRowUsed()?.RowNumber() ?? 1;
                for (int row = 2; row <= lastShipmentRow; row++)
                {
                    var rowNoStr = shipmentSheet.Cell(row, 1).GetString().Trim();
                    if (string.IsNullOrWhiteSpace(rowNoStr)) continue;

                    if (!int.TryParse(rowNoStr, out var pickupRowNo) || !pickupRows.ContainsKey(pickupRowNo))
                    {
                        errors.Add($"ShipmentLines Row {row}: Invalid PickupRowNo '{rowNoStr}'");
                        hasValidationErrors = true;
                        continue;
                    }

                    var consignee = shipmentSheet.Cell(row, 2).GetString().Trim();
                    if (string.IsNullOrWhiteSpace(consignee))
                    {
                        errors.Add($"ShipmentLines Row {row}: Consignee is required");
                        hasValidationErrors = true;
                        continue;
                    }

                    var consigneeCity = shipmentSheet.Cell(row, 8).GetString().Trim();
                    if (string.IsNullOrWhiteSpace(consigneeCity))
                    {
                        errors.Add($"ShipmentLines Row {row}: ConsigneeCity is required");
                        hasValidationErrors = true;
                        continue;
                    }

                    int.TryParse(shipmentSheet.Cell(row, 12).GetString().Trim(), out var pieces);
                    decimal.TryParse(shipmentSheet.Cell(row, 13).GetString().Trim(), out var weight);
                    decimal.TryParse(shipmentSheet.Cell(row, 14).GetString().Trim(), out var length);
                    decimal.TryParse(shipmentSheet.Cell(row, 15).GetString().Trim(), out var width);
                    decimal.TryParse(shipmentSheet.Cell(row, 16).GetString().Trim(), out var height);
                    decimal.TryParse(shipmentSheet.Cell(row, 21).GetString().Trim(), out var declaredValue);

                    var paymentModeStr = shipmentSheet.Cell(row, 19).GetString().Trim();
                    var paymentMode = paymentModeStr.ToLower() switch
                    {
                        "cod" => Net4Courier.Kernel.Enums.PaymentMode.COD,
                        "account" or "credit" => Net4Courier.Kernel.Enums.PaymentMode.Account,
                        "pickupcash" or "pickup cash" or "cash" => Net4Courier.Kernel.Enums.PaymentMode.PickupCash,
                        _ => Net4Courier.Kernel.Enums.PaymentMode.Prepaid
                    };

                    var docTypeStr = shipmentSheet.Cell(row, 20).GetString().Trim();
                    var docType = docTypeStr.ToLower() switch
                    {
                        "letter" => Net4Courier.Kernel.Enums.DocumentType.Letter,
                        "parcel" or "parcel upto 30kg" => Net4Courier.Kernel.Enums.DocumentType.ParcelUpto30Kg,
                        "parcel above 30kg" or "heavy parcel" => Net4Courier.Kernel.Enums.DocumentType.ParcelAbove30Kg,
                        _ => Net4Courier.Kernel.Enums.DocumentType.Document
                    };

                    if (!lineCountByPickup.ContainsKey(pickupRowNo))
                        lineCountByPickup[pickupRowNo] = 0;
                    lineCountByPickup[pickupRowNo]++;

                    shipmentLinesToPickupRow.Add((pickupRowNo, new PickupRequestShipment
                    {
                        LineNo = lineCountByPickup[pickupRowNo],
                        Consignee = consignee,
                        ConsigneeContact = shipmentSheet.Cell(row, 3).GetString().Trim(),
                        ConsigneePhone = shipmentSheet.Cell(row, 4).GetString().Trim(),
                        ConsigneeMobile = shipmentSheet.Cell(row, 5).GetString().Trim(),
                        ConsigneeAddress1 = shipmentSheet.Cell(row, 6).GetString().Trim(),
                        ConsigneeAddress2 = shipmentSheet.Cell(row, 7).GetString().Trim(),
                        ConsigneeCity = consigneeCity,
                        ConsigneeState = shipmentSheet.Cell(row, 9).GetString().Trim(),
                        ConsigneeCountry = shipmentSheet.Cell(row, 10).GetString().Trim(),
                        ConsigneePostalCode = shipmentSheet.Cell(row, 11).GetString().Trim(),
                        Pieces = pieces > 0 ? pieces : null,
                        Weight = weight > 0 ? weight : null,
                        Length = length > 0 ? length : null,
                        Width = width > 0 ? width : null,
                        Height = height > 0 ? height : null,
                        CargoDescription = shipmentSheet.Cell(row, 17).GetString().Trim(),
                        ReferenceNo = shipmentSheet.Cell(row, 18).GetString().Trim(),
                        PaymentModeId = paymentMode,
                        DocumentTypeId = docType,
                        DeclaredValue = declaredValue > 0 ? declaredValue : null,
                        Currency = shipmentSheet.Cell(row, 22).GetString().Trim(),
                        Status = ShipmentLineStatus.Pending
                    }));
                    shipmentCount++;
                }
            }

            if (successCount == 0)
            {
                var errorDetails = string.Join("\n", errors.Take(10));
                if (errors.Count > 10) errorDetails += $"\n...and {errors.Count - 10} more errors";
                Snackbar.Add("No valid pickup requests found. Please check the data and try again.", Severity.Error);
                if (errors.Any()) Snackbar.Add(errorDetails, Severity.Error);
                return;
            }

            var invalidShipmentPickupRows = shipmentLinesToPickupRow
                .Select(s => s.PickupRowNo)
                .Distinct()
                .Where(r => !pickupRows.ContainsKey(r))
                .ToList();
            shipmentLinesToPickupRow.RemoveAll(s => !pickupRows.ContainsKey(s.PickupRowNo));

            using var transaction = await DbContext.Database.BeginTransactionAsync();
            try
            {
                foreach (var kvp in pickupRows)
                {
                    DbContext.PickupRequests.Add(kvp.Value);
                }
                await DbContext.SaveChangesAsync();

                foreach (var (pickupRowNo, shipment) in shipmentLinesToPickupRow)
                {
                    shipment.PickupRequestId = pickupRows[pickupRowNo].Id;
                    DbContext.PickupRequestShipments.Add(shipment);
                }

                await DbContext.SaveChangesAsync();
                await transaction.CommitAsync();
            }
            catch
            {
                await transaction.RollbackAsync();
                throw;
            }

            var message = $"Upload complete: {successCount} pickup request(s) created";
            if (shipmentCount > 0) message += $", {shipmentCount} shipment line(s) added";
            if (errorCount > 0) message += $", {errorCount} row(s) skipped due to errors";
            Snackbar.Add(message, errorCount > 0 ? Severity.Warning : Severity.Success);

            if (errors.Any())
            {
                var errorDetails = string.Join("\n", errors.Take(10));
                if (errors.Count > 10) errorDetails += $"\n...and {errors.Count - 10} more errors";
                Snackbar.Add(errorDetails, Severity.Error);
            }

            await Search();
            await LoadStatusCounts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUploading = false;
            StateHasChanged();
        }
    }

    private enum CommitmentFilterType { None, Committed, ExpiringSoon, Available }

    private class CommitmentSummary
    {
        public int ActiveCommitments { get; set; }
        public int ExpiringSoon { get; set; }
        public int AvailablePickups { get; set; }
    }

    private class CourierPerformanceRow
    {
        public long CourierId { get; set; }
        public string CourierName { get; set; } = "";
        public int Active { get; set; }
        public int Confirmed { get; set; }
        public int Completed { get; set; }
        public int Expired { get; set; }
        public int Released { get; set; }
        public int Total { get; set; }
        public decimal CompletionRate => Total > 0 ? (decimal)Completed / Total * 100 : 0;
    }
}

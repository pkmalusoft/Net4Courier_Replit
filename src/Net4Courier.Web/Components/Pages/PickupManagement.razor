@page "/pickup-management"
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Operations.Enums
@using Net4Courier.Masters.Entities
@using ClosedXML.Excel

<PageTitle>Pickup Management - Net4Courier</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Pickup Management</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="6" md="2">
            <MudTextField @bind-Value="_searchString" Placeholder="Search..." Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Immediate="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_fromDate" Label="From" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudDatePicker @bind-Date="_toDate" Label="To" Variant="Variant.Outlined" DateFormat="dd/MM/yyyy" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="PickupStatus?" @bind-Value="_statusFilter" Label="Status" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem T="PickupStatus?" Value="@((PickupStatus?)null)">All Status</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.PickupRequest">Pickup Request</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.AssignedForCollection">Assigned for Collection</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.ShipmentCollected">Shipment Collected</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.Inscanned">Inscanned</MudSelectItem>
                <MudSelectItem T="PickupStatus?" Value="@PickupStatus.Cancelled">Cancelled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="Search" FullWidth="true" Class="mt-1">Search</MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="1">
            <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.FileDownload" 
                       OnClick="DownloadExcel" Disabled="@(!_pickups.Any())" FullWidth="true" Class="mt-1">Excel</MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/pickup-request-new" FullWidth="true" Class="mt-1">
                New
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudGrid Class="mb-4">
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #fff3e0;">
            <MudText Typo="Typo.h5" Color="Color.Warning">@_statusCounts.GetValueOrDefault(PickupStatus.PickupRequest)</MudText>
            <MudText Typo="Typo.caption">Pending Requests</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #e3f2fd;">
            <MudText Typo="Typo.h5" Color="Color.Info">@_statusCounts.GetValueOrDefault(PickupStatus.AssignedForCollection)</MudText>
            <MudText Typo="Typo.caption">Assigned</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #e8f5e9;">
            <MudText Typo="Typo.h5" Color="Color.Success">@_statusCounts.GetValueOrDefault(PickupStatus.ShipmentCollected)</MudText>
            <MudText Typo="Typo.caption">Collected</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="6" sm="3">
        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: #f3e5f5;">
            <MudText Typo="Typo.h5" Color="Color.Secondary">@_statusCounts.GetValueOrDefault(PickupStatus.Inscanned)</MudText>
            <MudText Typo="Typo.caption">Inscanned</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2">
    <MudTable Items="@_pickups" Hover="true" Striped="true" Loading="@_loading" LoadingProgressColor="Color.Primary" Breakpoint="Breakpoint.Sm">
        <HeaderContent>
            <MudTh>Pickup No</MudTh>
            <MudTh>Request Date</MudTh>
            <MudTh>Customer</MudTh>
            <MudTh>Address</MudTh>
            <MudTh>Est. Pieces</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Courier</MudTh>
            <MudTh Style="width: 180px;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Pickup No">
                <MudLink Href="@($"/pickup-request-edit/{context.Id}")">@context.PickupNo</MudLink>
            </MudTd>
            <MudTd DataLabel="Request Date">@context.RequestDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Customer">@context.CustomerName</MudTd>
            <MudTd DataLabel="Address">@context.City, @context.PostalCode</MudTd>
            <MudTd DataLabel="Est. Pieces">@context.EstimatedPieces</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@GetStatusText(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="Courier">@(context.CourierName ?? "-")</MudTd>
            <MudTd>
                @if (context.Status == PickupStatus.PickupRequest)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.AssignmentInd" Size="Size.Small" Color="Color.Primary" 
                                   OnClick="@(() => OpenAssignDialog(context))" Title="Assign Courier" />
                }
                @if (context.Status == PickupStatus.AssignedForCollection)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" 
                                   OnClick="@(() => MarkCollected(context))" Title="Mark Collected" />
                }
                @if (context.Status == PickupStatus.ShipmentCollected)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.QrCodeScanner" Size="Size.Small" Color="Color.Secondary" 
                                   OnClick="@(() => NavigateToInscan(context))" Title="INSCAN" />
                }
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Default" 
                               Href="@($"/pickup-request-edit/{context.Id}")" Title="Edit" />
                <MudIconButton Icon="@Icons.Material.Filled.Update" Size="Size.Small" Color="Color.Warning" 
                               OnClick="@(() => OpenStatusChangeDialog(context))" Title="Change Status" />
                @if (context.Status == PickupStatus.PickupRequest)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error" 
                                   OnClick="@(() => CancelPickup(context))" Title="Cancel" />
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No pickup requests found.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<PickupRequest> _pickups = new();
    private bool _loading = true;
    private string _searchString = "";
    private DateTime? _fromDate = DateTime.Today.AddDays(-7);
    private DateTime? _toDate = DateTime.Today;
    private PickupStatus? _statusFilter;
    private Dictionary<PickupStatus, int> _statusCounts = new();
    private List<Party> _couriers = new();

    protected override async Task OnInitializedAsync()
    {
        _couriers = await DbContext.Parties
            .Where(p => p.PartyType == PartyType.DeliveryAgent && !p.IsDeleted && p.IsActive)
            .OrderBy(p => p.Name)
            .ToListAsync();
        await Search();
        await LoadStatusCounts();
    }

    private async Task Search()
    {
        _loading = true;
        var query = DbContext.PickupRequests.Where(p => !p.IsDeleted).AsQueryable();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            query = query.Where(p => p.PickupNo.Contains(_searchString) || 
                                     (p.CustomerName != null && p.CustomerName.Contains(_searchString)) ||
                                     (p.ContactPerson != null && p.ContactPerson.Contains(_searchString)));
        }

        if (_fromDate.HasValue)
        {
            var from = DateTime.SpecifyKind(_fromDate.Value, DateTimeKind.Utc);
            query = query.Where(p => p.RequestDate >= from);
        }

        if (_toDate.HasValue)
        {
            var to = DateTime.SpecifyKind(_toDate.Value.AddDays(1), DateTimeKind.Utc);
            query = query.Where(p => p.RequestDate < to);
        }

        if (_statusFilter.HasValue)
        {
            query = query.Where(p => p.Status == _statusFilter.Value);
        }

        _pickups = await query.OrderByDescending(p => p.RequestDate).ThenByDescending(p => p.Id).Take(500).ToListAsync();
        _loading = false;
    }

    private async Task LoadStatusCounts()
    {
        var today = DateTime.UtcNow.Date;
        var counts = await DbContext.PickupRequests
            .Where(p => !p.IsDeleted && p.RequestDate >= today.AddDays(-7))
            .GroupBy(p => p.Status)
            .Select(g => new { Status = g.Key, Count = g.Count() })
            .ToListAsync();
        _statusCounts = counts.ToDictionary(x => x.Status, x => x.Count);
    }

    private Color GetStatusColor(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => Color.Warning,
        PickupStatus.AssignedForCollection => Color.Info,
        PickupStatus.ShipmentCollected => Color.Success,
        PickupStatus.Inscanned => Color.Secondary,
        PickupStatus.Cancelled => Color.Error,
        _ => Color.Default
    };

    private string GetStatusText(PickupStatus status) => status switch
    {
        PickupStatus.PickupRequest => "Pickup Request",
        PickupStatus.AssignedForCollection => "Assigned",
        PickupStatus.ShipmentCollected => "Collected",
        PickupStatus.Inscanned => "Inscanned",
        PickupStatus.Cancelled => "Cancelled",
        _ => status.ToString()
    };

    private async Task OpenAssignDialog(PickupRequest pickup)
    {
        var parameters = new DialogParameters<AssignCourierDialog>
        {
            { x => x.Couriers, _couriers },
            { x => x.SelectedCourierId, pickup.CourierId }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AssignCourierDialog>("Assign Courier", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled && result.Data is long courierId)
        {
            var courier = _couriers.FirstOrDefault(c => c.Id == courierId);
            if (courier != null)
            {
                pickup.CourierId = courierId;
                pickup.CourierName = courier.Name;
                pickup.CourierPhone = courier.Mobile ?? courier.Phone;
                pickup.Status = PickupStatus.AssignedForCollection;
                pickup.AssignedAt = DateTime.UtcNow;
                await DbContext.SaveChangesAsync();
                Snackbar.Add($"Pickup assigned to {courier.Name}", Severity.Success);
                await Search();
                await LoadStatusCounts();
            }
        }
    }

    private async Task MarkCollected(PickupRequest pickup)
    {
        var confirm = await DialogService.ShowMessageBox("Confirm Collection", 
            $"Mark pickup {pickup.PickupNo} as collected?", "Yes", "No");
        if (confirm == true)
        {
            pickup.Status = PickupStatus.ShipmentCollected;
            pickup.CollectedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            Snackbar.Add("Pickup marked as collected", Severity.Success);
            await Search();
            await LoadStatusCounts();
        }
    }

    private void NavigateToInscan(PickupRequest pickup)
    {
        NavigationManager.NavigateTo($"/pickup-inscan?pickupId={pickup.Id}");
    }

    private async Task CancelPickup(PickupRequest pickup)
    {
        var confirm = await DialogService.ShowMessageBox("Cancel Pickup", 
            $"Are you sure you want to cancel pickup {pickup.PickupNo}?", "Yes, Cancel", "No");
        if (confirm == true)
        {
            pickup.Status = PickupStatus.Cancelled;
            await DbContext.SaveChangesAsync();
            Snackbar.Add("Pickup cancelled", Severity.Warning);
            await Search();
            await LoadStatusCounts();
        }
    }

    private async Task OpenStatusChangeDialog(PickupRequest pickup)
    {
        var parameters = new DialogParameters<UpdateStatusDialog>
        {
            { x => x.PickupRequest, pickup },
            { x => x.EntityType, EntityType.Pickup }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Change Status", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await Search();
            await LoadStatusCounts();
        }
    }

    private async Task DownloadExcel()
    {
        if (!_pickups.Any()) return;

        using var workbook = new XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Pickups");

        worksheet.Cell(1, 1).Value = "Pickup Management";
        worksheet.Cell(1, 1).Style.Font.Bold = true;
        worksheet.Cell(1, 1).Style.Font.FontSize = 14;
        worksheet.Range(1, 1, 1, 7).Merge();

        var headers = new[] { "Pickup No", "Date", "Customer", "Address", "Est Pieces", "Status", "Courier" };
        for (int i = 0; i < headers.Length; i++)
        {
            worksheet.Cell(3, i + 1).Value = headers[i];
            worksheet.Cell(3, i + 1).Style.Font.Bold = true;
            worksheet.Cell(3, i + 1).Style.Fill.BackgroundColor = XLColor.LightGray;
        }

        int row = 4;
        foreach (var pickup in _pickups)
        {
            worksheet.Cell(row, 1).Value = pickup.PickupNo ?? "";
            worksheet.Cell(row, 2).Value = pickup.RequestDate.ToString("dd/MM/yyyy HH:mm");
            worksheet.Cell(row, 3).Value = pickup.CustomerName ?? "";
            worksheet.Cell(row, 4).Value = $"{pickup.City}, {pickup.PostalCode}";
            worksheet.Cell(row, 5).Value = pickup.EstimatedPieces;
            worksheet.Cell(row, 6).Value = GetStatusText(pickup.Status);
            worksheet.Cell(row, 7).Value = pickup.CourierName ?? "-";
            row++;
        }

        worksheet.Row(row).Style.Font.Bold = true;
        worksheet.Cell(row, 4).Value = "Total:";
        worksheet.Cell(row, 5).Value = _pickups.Sum(p => p.EstimatedPieces);

        worksheet.Columns().AdjustToContents();

        using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        var fileName = $"Pickups_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
        await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));
    }
}

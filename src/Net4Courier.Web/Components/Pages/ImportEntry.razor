@page "/import-entry"
@page "/import-entry/{Id:long}"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>@(IsNew ? "New Import" : "Edit Import") - Net4Courier</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-2" />

<MudText Typo="Typo.h4" GutterBottom="true">@(IsNew ? "New Import" : "Edit Import")</MudText>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudForm @ref="_form" @bind-IsValid="_formValid">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Import Basics</MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudText Typo="Typo.body2" Class="mb-1">Type *</MudText>
                            <MudButtonGroup OverrideStyles="false" Class="mb-2" Style="width: 100%;">
                                <MudButton Variant="@(_import.ShipmentDirection == ShipmentDirection.Import ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary" 
                                           OnClick="@(() => _import.ShipmentDirection = ShipmentDirection.Import)"
                                           StartIcon="@Icons.Material.Filled.CallReceived"
                                           Style="flex: 1;">Import</MudButton>
                                <MudButton Variant="@(_import.ShipmentDirection == ShipmentDirection.Export ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary"
                                           OnClick="@(() => _import.ShipmentDirection = ShipmentDirection.Export)"
                                           StartIcon="@Icons.Material.Filled.CallMade"
                                           Style="flex: 1;">Export</MudButton>
                            </MudButtonGroup>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="ImportMode" Label="Mode *" Value="_import.ImportMode" 
                                       ValueChanged="OnImportModeChanged"
                                       Variant="Variant.Outlined" Required="true">
                                <MudSelectItem Value="ImportMode.Air">
                                    <MudIcon Icon="@Icons.Material.Filled.Flight" Class="mr-2" /> Air
                                </MudSelectItem>
                                <MudSelectItem Value="ImportMode.Sea">
                                    <MudIcon Icon="@Icons.Material.Filled.DirectionsBoat" Class="mr-2" /> Sea
                                </MudSelectItem>
                                <MudSelectItem Value="ImportMode.Land">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" /> Land
                                </MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="MasterReferenceType" Label="Reference Type *" @bind-Value="_import.MasterReferenceType" 
                                       Variant="Variant.Outlined" Required="true">
                                @if (_import.ImportMode == ImportMode.Air)
                                {
                                    <MudSelectItem Value="MasterReferenceType.MAWB">MAWB</MudSelectItem>
                                }
                                else if (_import.ImportMode == ImportMode.Sea)
                                {
                                    <MudSelectItem Value="MasterReferenceType.BL">Bill of Lading</MudSelectItem>
                                }
                                else
                                {
                                    <MudSelectItem Value="MasterReferenceType.TruckWaybill">Truck Waybill</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.MasterReferenceNumber" Label="@_referenceLabel" 
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.CarrierName" Label="Carrier Name *" 
                                          Variant="Variant.Outlined" Required="true" 
                                          Placeholder="@GetCarrierPlaceholder()" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.CarrierCode" Label="Carrier Code" 
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="ImportMasterStatus" Label="Status" @bind-Value="_import.Status" 
                                       Variant="Variant.Outlined">
                                @foreach (ImportMasterStatus status in Enum.GetValues(typeof(ImportMasterStatus)))
                                {
                                    <MudSelectItem Value="status">@status.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="Party" Label="Co-Loader" @bind-Value="_selectedCoLoader"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Code} - {p.Name}" : "")">
                                <MudSelectItem T="Party" Value="@((Party?)null)">-- Select --</MudSelectItem>
                                @foreach (var coloader in _coLoaders)
                                {
                                    <MudSelectItem T="Party" Value="@coloader">@coloader.Code - @coloader.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Origin & Destination</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudAutocomplete T="Country" Label="Origin Country *" Value="_originCountry"
                                             SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                             Variant="Variant.Outlined" Required="true" 
                                             ValueChanged="OnOriginCountryChanged" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Port" Label="@(_import.ImportMode == ImportMode.Sea ? "Origin Port" : "Origin Airport")" 
                                       @bind-Value="_originPort"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Name} ({p.IATACode ?? p.Code})" : "")">
                                <MudSelectItem T="Port" Value="@((Port?)null)">-- Select --</MudSelectItem>
                                @foreach (var port in GetFilteredPorts())
                                {
                                    <MudSelectItem T="Port" Value="@port">@port.Name (@(port.IATACode ?? port.Code))</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudAutocomplete T="Country" Label="Destination Country *" Value="_destCountry"
                                             SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                             Variant="Variant.Outlined" Required="true" 
                                             ValueChanged="OnDestCountryChanged" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Port" Label="@(_import.ImportMode == ImportMode.Sea ? "Destination Port" : "Destination Airport")" 
                                       @bind-Value="_destinationPort"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Name} ({p.IATACode ?? p.Code})" : "")">
                                <MudSelectItem T="Port" Value="@((Port?)null)">-- Select --</MudSelectItem>
                                @foreach (var port in GetFilteredPorts())
                                {
                                    <MudSelectItem T="Port" Value="@port">@port.Name (@(port.IATACode ?? port.Code))</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Schedule</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="ETD" @bind-Date="_etd" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="ETA *" @bind-Date="_eta" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="Actual Arrival" @bind-Date="_actualArrival" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Cargo Details</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalBags" Label="Total Bags *" 
                                             Variant="Variant.Outlined" Min="0" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalShipments" Label="Total Shipments *" 
                                             Variant="Variant.Outlined" Min="0" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalGrossWeight" Label="Total Gross Weight (kg)" 
                                             Variant="Variant.Outlined" Min="0" Format="N3" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_import.ImportWarehouseName" Label="Import Warehouse *" 
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="CargoType" Label="Cargo Type" @bind-Value="_import.CargoType" 
                                       Variant="Variant.Outlined">
                                <MudSelectItem Value="CargoType.Courier">Courier</MudSelectItem>
                                <MudSelectItem Value="CargoType.Freight">Freight</MudSelectItem>
                                <MudSelectItem Value="CargoType.Express">Express</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
                
                <MudExpansionPanels Class="mt-4">
                    <MudExpansionPanel Text="Transport Details (Optional)">
                        <MudGrid>
                            @if (_import.ImportMode == ImportMode.Air)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.FlightNo" Label="Flight Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudDatePicker Label="Flight Date" @bind-Date="_flightDate" Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            else if (_import.ImportMode == ImportMode.Sea)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.VesselName" Label="Vessel Name" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.VoyageNumber" Label="Voyage Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            else
                            {
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.TruckNumber" Label="Truck Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.DriverName" Label="Driver Name" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.DriverPhone" Label="Driver Phone" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_import.ManifestNumber" Label="Manifest Number" 
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_import.Remarks" Label="Remarks" 
                                              Variant="Variant.Outlined" Lines="2" />
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudExpansionPanels>
                
                @* Shipments Detail Section *@
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <div class="d-flex justify-space-between align-center mb-4">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" />
                            Shipments (@_shipments.Count)
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                   OnClick="AddNewShipment" StartIcon="@Icons.Material.Filled.Add">
                            Add Shipment
                        </MudButton>
                    </div>
                    
                    @if (_shipments.Any())
                    {
                        <MudTable Items="_shipments" Dense="true" Hover="true" Striped="true" Bordered="true"
                                  Style="overflow-x: auto;">
                            <HeaderContent>
                                <MudTh>AWB No</MudTh>
                                <MudTh>Consignee Name</MudTh>
                                <MudTh>Consignee City</MudTh>
                                <MudTh>Consignee Country</MudTh>
                                <MudTh>Shipper Name</MudTh>
                                <MudTh Style="text-align: right;">Pcs</MudTh>
                                <MudTh Style="text-align: right;">Wt(Kg)</MudTh>
                                <MudTh>Contents</MudTh>
                                <MudTh Style="text-align: right;">Value</MudTh>
                                <MudTh>Payment</MudTh>
                                <MudTh Style="width: 100px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="AWB No">@context.AWBNo</MudTd>
                                <MudTd DataLabel="Consignee Name">@context.ConsigneeName</MudTd>
                                <MudTd DataLabel="Consignee City">@context.ConsigneeCity</MudTd>
                                <MudTd DataLabel="Consignee Country">@context.ConsigneeCountry</MudTd>
                                <MudTd DataLabel="Shipper Name">@context.ShipperName</MudTd>
                                <MudTd DataLabel="Pieces" Style="text-align: right;">@context.Pieces</MudTd>
                                <MudTd DataLabel="Weight" Style="text-align: right;">@context.Weight.ToString("N2")</MudTd>
                                <MudTd DataLabel="Contents">@(context.ContentsDescription?.Length > 20 ? context.ContentsDescription[..20] + "..." : context.ContentsDescription)</MudTd>
                                <MudTd DataLabel="Value" Style="text-align: right;">@(context.DeclaredValue?.ToString("N2") ?? "-") @context.Currency</MudTd>
                                <MudTd DataLabel="Payment">@context.PaymentMode.ToString()</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                                   OnClick="@(() => EditShipment(context))" Title="Edit" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                   OnClick="@(() => DeleteShipment(context))" Title="Delete" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                        
                        <MudStack Row="true" Class="mt-3" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Total: @_shipments.Count shipments, @_shipments.Sum(s => s.Pieces) pieces, @_shipments.Sum(s => s.Weight).ToString("N2") Kg
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                            No shipments added. Click "Add Shipment" to add line items.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Actions</MudText>
                    
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                   OnClick="SaveDraft" Disabled="@(!_formValid || _saving)">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                            Save Draft
                        </MudButton>
                        
                        @if (!IsNew)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" 
                                       Href="@($"/import-bags/{Id}")">
                                <MudIcon Icon="@Icons.Material.Filled.Inventory2" Class="mr-2" />
                                Manage Bags
                            </MudButton>
                            
                            <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" 
                                       Href="@($"/import-inscan/{Id}")">
                                <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Class="mr-2" />
                                Inscan Shipments
                            </MudButton>
                        }
                        
                        <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true" 
                                   Href="/import-dashboard">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
                            Back to List
                        </MudButton>
                    </MudStack>
                </MudPaper>
                
                @if (!IsNew)
                {
                    <MudPaper Class="pa-4 mt-4" Elevation="2">
                        <MudText Typo="Typo.subtitle1" Class="mb-3">Summary</MudText>
                        <MudStack Spacing="1">
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Import Ref:</MudText>
                                <MudText Typo="Typo.body2" Class="font-weight-bold">@_import.ImportRefNo</MudText>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Status:</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_import.Status.ToString()</MudChip>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Created:</MudText>
                                <MudText Typo="Typo.body2">@_import.CreatedAt.ToString("dd/MM/yyyy")</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                    
                    <MudPaper Class="pa-4 mt-4" Elevation="2">
                        <div class="d-flex justify-space-between align-center mb-3">
                            <MudText Typo="Typo.subtitle1">
                                <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Class="mr-1" />
                                Documents (@_documents.Count)
                            </MudText>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" 
                                       OnClick="OpenUploadDialog" StartIcon="@Icons.Material.Filled.Upload">
                                Upload
                            </MudButton>
                        </div>
                        
                        @if (_documents.Any())
                        {
                            <MudList T="ImportDocument" Dense="true">
                                @foreach (var doc in _documents)
                                {
                                    <MudListItem T="ImportDocument">
                                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                            <div>
                                                <MudText Typo="Typo.body2" Class="font-weight-bold">@doc.DocumentTypeName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@doc.OriginalFileName</MudText>
                                            </div>
                                            <div>
                                                <MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Small" 
                                                               OnClick="@(() => DownloadDocument(doc))" Title="Download" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                               OnClick="@(() => DeleteDocument(doc))" Title="Delete" />
                                            </div>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">No documents uploaded</MudText>
                        }
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    </MudForm>
}

@code {
    [Parameter] public long? Id { get; set; }
    
    private bool IsNew => !Id.HasValue || Id == 0;
    private bool _loading = true;
    private bool _saving = false;
    private MudForm? _form;
    private bool _formValid = false;
    
    private ImportMaster _import = new();
    private Country? _originCountry;
    private Country? _destCountry;
    private DateTime? _eta;
    private DateTime? _etd;
    private DateTime? _actualArrival;
    private DateTime? _flightDate;
    private List<Country> _countries = new();
    private List<Port> _ports = new();
    private Port? _originPort;
    private Port? _destinationPort;
    private List<ImportDocument> _documents = new();
    private string _referenceLabel = "Reference Number *";
    private List<Party> _coLoaders = new();
    private Party? _selectedCoLoader;
    private List<ImportShipment> _shipments = new();
    private List<Country> _allCountries = new();
    
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Import Dashboard", href: "/import-dashboard"),
        new BreadcrumbItem("Import Entry", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _loading = false;
    }

    private async Task LoadData()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _countries = await dbContext.Countries.Where(c => !c.IsDeleted && c.IsActive).OrderBy(c => c.Name).ToListAsync();
        
        // Load all ports (airports for Air mode)
        _ports = await dbContext.Ports
            .Where(p => p.IsActive && !p.IsDeleted)
            .OrderBy(p => p.Name)
            .ToListAsync();
        
        // Load co-loaders
        _coLoaders = await dbContext.Parties
            .Where(p => p.PartyType == PartyType.CoLoader && p.IsActive && !p.IsDeleted)
            .OrderBy(p => p.Code)
            .ToListAsync();
        
        if (!IsNew && Id.HasValue)
        {
            _import = await dbContext.ImportMasters.FirstOrDefaultAsync(i => i.Id == Id.Value && !i.IsDeleted) 
                      ?? new ImportMaster();
            
            if (_import.OriginCountryId.HasValue)
                _originCountry = _countries.FirstOrDefault(c => c.Id == _import.OriginCountryId);
            if (_import.DestinationCountryId.HasValue)
                _destCountry = _countries.FirstOrDefault(c => c.Id == _import.DestinationCountryId);
            
            _eta = _import.ETA;
            _etd = _import.ETD;
            _actualArrival = _import.ActualArrivalDate;
            _flightDate = _import.FlightDate;
            
            // Load selected ports by code
            if (!string.IsNullOrEmpty(_import.OriginPortCode))
                _originPort = _ports.FirstOrDefault(p => p.IATACode == _import.OriginPortCode || p.Code == _import.OriginPortCode);
            if (!string.IsNullOrEmpty(_import.DestinationPortCode))
                _destinationPort = _ports.FirstOrDefault(p => p.IATACode == _import.DestinationPortCode || p.Code == _import.DestinationPortCode);
            
            // Load selected co-loader
            if (_import.CoLoaderId.HasValue)
                _selectedCoLoader = _coLoaders.FirstOrDefault(c => c.Id == _import.CoLoaderId);
            
            _documents = await dbContext.ImportDocuments
                .Where(d => d.ImportMasterId == Id.Value && !d.IsDeleted)
                .OrderByDescending(d => d.UploadedAt)
                .ToListAsync();
            
            // Load shipments
            _shipments = await dbContext.ImportShipments
                .Where(s => s.ImportMasterId == Id.Value && !s.IsDeleted)
                .OrderBy(s => s.AWBNo)
                .ToListAsync();
        }
        else
        {
            _import.TransactionDate = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc);
            _import.Status = ImportMasterStatus.Draft;
        }
        UpdateReferenceLabel();
    }

    private void UpdateReferenceLabel()
    {
        _referenceLabel = _import.ImportMode switch
        {
            ImportMode.Air => "MAWB Number *",
            ImportMode.Sea => "BL Number *",
            ImportMode.Land => "Truck Waybill Number *",
            _ => "Reference Number *"
        };
    }

    private void OnImportModeChanged(ImportMode mode)
    {
        _import.ImportMode = mode;
        // Clear selected ports when mode changes since they may no longer be valid for new mode
        _originPort = null;
        _destinationPort = null;
        UpdateReferenceLabel();
    }

    private Task<IEnumerable<Country>> SearchCountries(string value)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_countries.Take(20));
        
        return Task.FromResult(_countries.Where(c => c.Name.Contains(value, StringComparison.OrdinalIgnoreCase)).Take(20));
    }

    private void OnOriginCountryChanged(Country? country)
    {
        _originCountry = country;
        _import.OriginCountryId = country?.Id;
        _import.OriginCountryName = country?.Name;
    }

    private void OnDestCountryChanged(Country? country)
    {
        _destCountry = country;
        _import.DestinationCountryId = country?.Id;
        _import.DestinationCountryName = country?.Name;
    }

    private string GetReferenceLabel() => _import.ImportMode switch
    {
        ImportMode.Air => "MAWB Number",
        ImportMode.Sea => "BL Number",
        ImportMode.Land => "Truck Waybill Number",
        _ => "Reference Number"
    };

    private string GetCarrierPlaceholder() => _import.ImportMode switch
    {
        ImportMode.Air => "e.g. Emirates, Qatar Airways",
        ImportMode.Sea => "e.g. Maersk, MSC",
        ImportMode.Land => "e.g. DHL Freight",
        _ => ""
    };

    private IEnumerable<Port> GetFilteredPorts()
    {
        var portType = _import.ImportMode switch
        {
            ImportMode.Air => PortType.Airport,
            ImportMode.Sea => PortType.Seaport,
            ImportMode.Land => PortType.LandBorder,
            _ => PortType.Airport
        };
        return _ports.Where(p => p.PortType == portType);
    }

    private async Task SaveDraft()
    {
        if (_form == null) return;
        await _form.Validate();
        if (!_formValid) return;

        _saving = true;
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            
            _import.ETA = _eta.HasValue ? DateTime.SpecifyKind(_eta.Value, DateTimeKind.Utc) : null;
            _import.ETD = _etd.HasValue ? DateTime.SpecifyKind(_etd.Value, DateTimeKind.Utc) : null;
            _import.ActualArrivalDate = _actualArrival.HasValue ? DateTime.SpecifyKind(_actualArrival.Value, DateTimeKind.Utc) : null;
            _import.FlightDate = _flightDate.HasValue ? DateTime.SpecifyKind(_flightDate.Value, DateTimeKind.Utc) : null;
            
            // Set port codes from selected ports
            _import.OriginPortCode = _originPort?.IATACode ?? _originPort?.Code;
            _import.DestinationPortCode = _destinationPort?.IATACode ?? _destinationPort?.Code;
            
            // Set co-loader info
            _import.CoLoaderId = _selectedCoLoader?.Id;
            _import.CoLoaderName = _selectedCoLoader?.Name;
            
            if (IsNew)
            {
                _import.ImportRefNo = await GenerateImportRefNo(dbContext);
                _import.CreatedAt = DateTime.UtcNow;
                dbContext.ImportMasters.Add(_import);
            }
            else
            {
                _import.ModifiedAt = DateTime.UtcNow;
                dbContext.ImportMasters.Update(_import);
            }
            
            await dbContext.SaveChangesAsync();
            Snackbar.Add("Import saved successfully", Severity.Success);
            
            if (IsNew)
                Navigation.NavigateTo($"/import-entry/{_import.Id}");
        }
        catch (Exception ex)
        {
            var innerMessage = ex.InnerException?.Message ?? ex.Message;
            Console.WriteLine($"Import save error: {ex}");
            Snackbar.Add($"Error saving import: {innerMessage}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task<string> GenerateImportRefNo(ApplicationDbContext dbContext)
    {
        var prefix = _import.ImportMode switch
        {
            ImportMode.Air => "IMP-AIR",
            ImportMode.Sea => "IMP-SEA",
            ImportMode.Land => "IMP-LND",
            _ => "IMP"
        };
        
        var today = DateTime.SpecifyKind(DateTime.UtcNow.Date, DateTimeKind.Utc);
        var tomorrow = today.AddDays(1);
        var count = await dbContext.ImportMasters
            .CountAsync(i => i.TransactionDate >= today && i.TransactionDate < tomorrow) + 1;
        
        return $"{prefix}-{today:yyyyMMdd}-{count:D4}";
    }
    
    private async Task OpenUploadDialog()
    {
        var parameters = new DialogParameters<ImportDocumentDialog>
        {
            { x => x.ImportMasterId, _import.Id }
        };
        
        var dialog = await DialogService.ShowAsync<ImportDocumentDialog>("Upload Document", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is ImportDocumentDialog.ImportDocumentUploadResult uploadResult)
        {
            await SaveUploadedDocument(uploadResult);
        }
    }
    
    private async Task SaveUploadedDocument(ImportDocumentDialog.ImportDocumentUploadResult uploadResult)
    {
        if (uploadResult.File == null) return;
        
        try
        {
            var uploadsDir = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "imports", _import.Id.ToString());
            Directory.CreateDirectory(uploadsDir);
            
            var storedFileName = $"{Guid.NewGuid()}{Path.GetExtension(uploadResult.File.Name)}";
            var filePath = Path.Combine(uploadsDir, storedFileName);
            
            await using var stream = new FileStream(filePath, FileMode.Create);
            await uploadResult.File.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var document = new ImportDocument
            {
                ImportMasterId = _import.Id,
                DocumentType = uploadResult.DocumentType,
                DocumentTypeName = uploadResult.DocumentTypeName,
                OriginalFileName = uploadResult.File.Name,
                StoredFileName = storedFileName,
                FilePath = $"/uploads/imports/{_import.Id}/{storedFileName}",
                ContentType = uploadResult.File.ContentType,
                FileSize = uploadResult.File.Size,
                Description = uploadResult.Description,
                UploadedAt = DateTime.UtcNow,
                CreatedAt = DateTime.UtcNow
            };
            
            dbContext.ImportDocuments.Add(document);
            await dbContext.SaveChangesAsync();
            
            _documents.Insert(0, document);
            Snackbar.Add("Document uploaded successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task DownloadDocument(ImportDocument document)
    {
        var url = document.FilePath;
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    
    private async Task DeleteDocument(ImportDocument document)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Document",
            $"Are you sure you want to delete '{document.OriginalFileName}'?",
            yesText: "Delete", cancelText: "Cancel");
        
        if (confirm != true) return;
        
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var doc = await dbContext.ImportDocuments.FindAsync(document.Id);
            if (doc != null)
            {
                doc.IsDeleted = true;
                doc.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
            }
            
            _documents.Remove(document);
            Snackbar.Add("Document deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task AddNewShipment()
    {
        // Must save import first if new
        if (IsNew)
        {
            Snackbar.Add("Please save the import first before adding shipments.", Severity.Warning);
            return;
        }
        
        var parameters = new DialogParameters<ImportShipmentDialog>
        {
            { x => x.Shipment, new ImportShipment { ImportMasterId = _import.Id } },
            { x => x.IsNew, true },
            { x => x.Countries, _countries }
        };
        
        var dialog = await DialogService.ShowAsync<ImportShipmentDialog>("Add Shipment", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is ImportShipment shipment)
        {
            await SaveShipment(shipment, true);
        }
    }
    
    private async Task EditShipment(ImportShipment shipment)
    {
        var editShipment = new ImportShipment
        {
            Id = shipment.Id,
            ImportMasterId = shipment.ImportMasterId,
            AWBNo = shipment.AWBNo,
            ConsigneeName = shipment.ConsigneeName,
            ConsigneeAddress = shipment.ConsigneeAddress,
            ConsigneeCity = shipment.ConsigneeCity,
            ConsigneeState = shipment.ConsigneeState,
            ConsigneeCountry = shipment.ConsigneeCountry,
            ConsigneePostalCode = shipment.ConsigneePostalCode,
            ConsigneePhone = shipment.ConsigneePhone,
            ShipperName = shipment.ShipperName,
            ShipperCountry = shipment.ShipperCountry,
            Pieces = shipment.Pieces,
            Weight = shipment.Weight,
            ContentsDescription = shipment.ContentsDescription,
            HSCode = shipment.HSCode,
            DeclaredValue = shipment.DeclaredValue,
            Currency = shipment.Currency,
            PaymentMode = shipment.PaymentMode,
            SpecialInstructions = shipment.SpecialInstructions,
            Status = shipment.Status,
            CreatedAt = shipment.CreatedAt
        };
        
        var parameters = new DialogParameters<ImportShipmentDialog>
        {
            { x => x.Shipment, editShipment },
            { x => x.IsNew, false },
            { x => x.Countries, _countries }
        };
        
        var dialog = await DialogService.ShowAsync<ImportShipmentDialog>("Edit Shipment", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is ImportShipment updatedShipment)
        {
            await SaveShipment(updatedShipment, false);
        }
    }
    
    private async Task SaveShipment(ImportShipment shipment, bool isNew)
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            
            if (isNew)
            {
                shipment.CreatedAt = DateTime.UtcNow;
                dbContext.ImportShipments.Add(shipment);
                await dbContext.SaveChangesAsync();
                _shipments.Add(shipment);
                Snackbar.Add("Shipment added successfully", Severity.Success);
            }
            else
            {
                var existing = await dbContext.ImportShipments.FindAsync(shipment.Id);
                if (existing != null)
                {
                    existing.AWBNo = shipment.AWBNo;
                    existing.ConsigneeName = shipment.ConsigneeName;
                    existing.ConsigneeAddress = shipment.ConsigneeAddress;
                    existing.ConsigneeCity = shipment.ConsigneeCity;
                    existing.ConsigneeState = shipment.ConsigneeState;
                    existing.ConsigneeCountry = shipment.ConsigneeCountry;
                    existing.ConsigneePostalCode = shipment.ConsigneePostalCode;
                    existing.ConsigneePhone = shipment.ConsigneePhone;
                    existing.ShipperName = shipment.ShipperName;
                    existing.ShipperCountry = shipment.ShipperCountry;
                    existing.Pieces = shipment.Pieces;
                    existing.Weight = shipment.Weight;
                    existing.ContentsDescription = shipment.ContentsDescription;
                    existing.HSCode = shipment.HSCode;
                    existing.DeclaredValue = shipment.DeclaredValue;
                    existing.Currency = shipment.Currency;
                    existing.PaymentMode = shipment.PaymentMode;
                    existing.SpecialInstructions = shipment.SpecialInstructions;
                    existing.ModifiedAt = DateTime.UtcNow;
                    await dbContext.SaveChangesAsync();
                    
                    // Update in local list
                    var idx = _shipments.FindIndex(s => s.Id == shipment.Id);
                    if (idx >= 0)
                    {
                        _shipments[idx] = existing;
                    }
                    Snackbar.Add("Shipment updated successfully", Severity.Success);
                }
            }
            
            // Update totals on import master
            await UpdateImportTotals();
        }
        catch (Exception ex)
        {
            var innerMessage = ex.InnerException?.Message ?? ex.Message;
            Snackbar.Add($"Error saving shipment: {innerMessage}", Severity.Error);
        }
    }
    
    private async Task DeleteShipment(ImportShipment shipment)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Shipment",
            $"Are you sure you want to delete shipment '{shipment.AWBNo}'?",
            yesText: "Delete", cancelText: "Cancel");
        
        if (confirm != true) return;
        
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var existing = await dbContext.ImportShipments.FindAsync(shipment.Id);
            if (existing != null)
            {
                existing.IsDeleted = true;
                existing.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
            }
            
            _shipments.Remove(shipment);
            await UpdateImportTotals();
            Snackbar.Add("Shipment deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task UpdateImportTotals()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var import = await dbContext.ImportMasters.FindAsync(_import.Id);
            if (import != null)
            {
                import.TotalShipments = _shipments.Count;
                import.TotalPieces = _shipments.Sum(s => s.Pieces);
                import.TotalGrossWeight = _shipments.Sum(s => s.Weight);
                import.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
                
                _import.TotalShipments = import.TotalShipments;
                _import.TotalPieces = import.TotalPieces;
                _import.TotalGrossWeight = import.TotalGrossWeight;
            }
        }
        catch { /* Ignore update totals error */ }
    }
}

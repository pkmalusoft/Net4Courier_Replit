@page "/import-entry"
@page "/import-entry/{Id:long}"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>@(IsNew ? "New Manifest" : "Edit Manifest") - Net4Courier</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-2" />

<MudText Typo="Typo.h4" GutterBottom="true">@(IsNew ? "New Manifest" : "Edit Manifest")</MudText>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudForm @ref="_form" @bind-IsValid="_formValid">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Import Basics</MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudText Typo="Typo.body2" Class="mb-1">Type *</MudText>
                            <MudButtonGroup OverrideStyles="false" Class="mb-2" Style="width: 100%;">
                                <MudButton Variant="@(_import.ShipmentDirection == ShipmentDirection.Import ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary" 
                                           OnClick="@(() => _import.ShipmentDirection = ShipmentDirection.Import)"
                                           StartIcon="@Icons.Material.Filled.CallReceived"
                                           Style="flex: 1;">Import</MudButton>
                                <MudButton Variant="@(_import.ShipmentDirection == ShipmentDirection.Export ? Variant.Filled : Variant.Outlined)"
                                           Color="Color.Primary"
                                           OnClick="@(() => _import.ShipmentDirection = ShipmentDirection.Export)"
                                           StartIcon="@Icons.Material.Filled.CallMade"
                                           Style="flex: 1;">Export</MudButton>
                            </MudButtonGroup>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="ImportMode" Label="Mode *" Value="_import.ImportMode" 
                                       ValueChanged="OnImportModeChanged"
                                       Variant="Variant.Outlined" Required="true">
                                <MudSelectItem Value="ImportMode.Air">
                                    <MudIcon Icon="@Icons.Material.Filled.Flight" Class="mr-2" /> Air
                                </MudSelectItem>
                                <MudSelectItem Value="ImportMode.Sea">
                                    <MudIcon Icon="@Icons.Material.Filled.DirectionsBoat" Class="mr-2" /> Sea
                                </MudSelectItem>
                                <MudSelectItem Value="ImportMode.Land">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" /> Land
                                </MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="MasterReferenceType" Label="Reference Type *" @bind-Value="_import.MasterReferenceType" 
                                       Variant="Variant.Outlined" Required="true">
                                @if (_import.ImportMode == ImportMode.Air)
                                {
                                    <MudSelectItem Value="MasterReferenceType.MAWB">MAWB</MudSelectItem>
                                }
                                else if (_import.ImportMode == ImportMode.Sea)
                                {
                                    <MudSelectItem Value="MasterReferenceType.BL">Bill of Lading</MudSelectItem>
                                }
                                else
                                {
                                    <MudSelectItem Value="MasterReferenceType.TruckWaybill">Truck Waybill</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.MasterReferenceNumber" Label="@_referenceLabel" 
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.CarrierName" Label="Carrier Name *" 
                                          Variant="Variant.Outlined" Required="true" 
                                          Placeholder="@GetCarrierPlaceholder()" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField @bind-Value="_import.CarrierCode" Label="Carrier Code" 
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="ImportMasterStatus" Label="Status" @bind-Value="_import.Status" 
                                       Variant="Variant.Outlined">
                                @foreach (ImportMasterStatus status in Enum.GetValues(typeof(ImportMasterStatus)))
                                {
                                    <MudSelectItem Value="status">@status.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="Party" Label="Co-Loader" @bind-Value="_selectedCoLoader"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Code} - {p.Name}" : "")">
                                <MudSelectItem T="Party" Value="@((Party?)null)">-- Select --</MudSelectItem>
                                @foreach (var coloader in _coLoaders)
                                {
                                    <MudSelectItem T="Party" Value="@coloader">@coloader.Code - @coloader.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Origin & Destination</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudAutocomplete T="Country" Label="Origin Country *" Value="_originCountry"
                                             SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                             Variant="Variant.Outlined" Required="true" 
                                             ValueChanged="OnOriginCountryChanged" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Port" Label="@GetOriginPortLabel()" 
                                       @bind-Value="_originPort"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Name} ({p.IATACode ?? p.Code})" : "")">
                                <MudSelectItem T="Port" Value="@((Port?)null)">-- Select --</MudSelectItem>
                                @foreach (var port in GetOriginFilteredPorts())
                                {
                                    <MudSelectItem T="Port" Value="@port">@port.Name (@(port.IATACode ?? port.Code))</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudAutocomplete T="Country" Label="Destination Country *" Value="_destCountry"
                                             SearchFunc="SearchCountries" ToStringFunc="@(c => c?.Name ?? "")"
                                             Variant="Variant.Outlined" Required="true" 
                                             ValueChanged="OnDestCountryChanged" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Port" Label="@GetDestPortLabel()" 
                                       @bind-Value="_destinationPort"
                                       Variant="Variant.Outlined" Dense="true"
                                       ToStringFunc="@(p => p != null ? $"{p.Name} ({p.IATACode ?? p.Code})" : "")">
                                <MudSelectItem T="Port" Value="@((Port?)null)">-- Select --</MudSelectItem>
                                @foreach (var port in GetDestFilteredPorts())
                                {
                                    <MudSelectItem T="Port" Value="@port">@port.Name (@(port.IATACode ?? port.Code))</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Schedule</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="ETD" @bind-Date="_etd" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="ETA *" @bind-Date="_eta" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudDatePicker Label="Actual Arrival" @bind-Date="_actualArrival" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-3">Cargo Details</MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalBags" Label="Total Bags *" 
                                             Variant="Variant.Outlined" Min="0" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalShipments" Label="Total Shipments *" 
                                             Variant="Variant.Outlined" Min="0" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="_import.TotalGrossWeight" Label="Total Gross Weight (kg)" 
                                             Variant="Variant.Outlined" Min="0" Format="N3" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_import.ImportWarehouseName" Label="Import Warehouse *" 
                                          Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="CargoType" Label="Cargo Type" @bind-Value="_import.CargoType" 
                                       Variant="Variant.Outlined">
                                <MudSelectItem Value="CargoType.Courier">Courier</MudSelectItem>
                                <MudSelectItem Value="CargoType.Freight">Freight</MudSelectItem>
                                <MudSelectItem Value="CargoType.Express">Express</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
                
                <MudExpansionPanels Class="mt-4">
                    <MudExpansionPanel Text="Transport Details (Optional)">
                        <MudGrid>
                            @if (_import.ImportMode == ImportMode.Air)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.FlightNo" Label="Flight Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudDatePicker Label="Flight Date" @bind-Date="_flightDate" Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            else if (_import.ImportMode == ImportMode.Sea)
                            {
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.VesselName" Label="Vessel Name" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_import.VoyageNumber" Label="Voyage Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            else
                            {
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.TruckNumber" Label="Truck Number" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.DriverName" Label="Driver Name" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudTextField @bind-Value="_import.DriverPhone" Label="Driver Phone" 
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                            }
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_import.ManifestNumber" Label="Manifest Number" 
                                              Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_import.Remarks" Label="Remarks" 
                                              Variant="Variant.Outlined" Lines="2" />
                            </MudItem>
                        </MudGrid>
                    </MudExpansionPanel>
                </MudExpansionPanels>
                
                @* Shipments Detail Section *@
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <div class="d-flex justify-space-between align-center mb-4">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" />
                            Shipments (@_shipments.Count)
                        </MudText>
                        @* Add Shipment button hidden - use Inscan feature instead
                        <MudTooltip Text="@(IsNew ? "Save the import first to add shipments" : "Add a new shipment")">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                       OnClick="AddNewShipment" StartIcon="@Icons.Material.Filled.Add"
                                       Disabled="@IsNew">
                                Add Shipment
                            </MudButton>
                        </MudTooltip>
                        *@
                    </div>
                    
                    @if (_shipments.Any())
                    {
                        <MudTable Items="_shipments" Dense="true" Hover="true" Striped="true" Bordered="true"
                                  Style="overflow-x: auto;">
                            <HeaderContent>
                                <MudTh>AWB No</MudTh>
                                <MudTh>Consignee Name</MudTh>
                                <MudTh>Address</MudTh>
                                <MudTh>City</MudTh>
                                <MudTh>Country</MudTh>
                                <MudTh>Phone</MudTh>
                                <MudTh>Secondary Mobile</MudTh>
                                <MudTh>Shipper Name</MudTh>
                                <MudTh>Shipper Address</MudTh>
                                <MudTh>Service Type</MudTh>
                                <MudTh>Inco Terms</MudTh>
                                <MudTh>Account No</MudTh>
                                <MudTh Style="text-align: right;">Pcs</MudTh>
                                <MudTh Style="text-align: right;">Wt(Kg)</MudTh>
                                <MudTh>Contents</MudTh>
                                <MudTh Style="text-align: right;">Value</MudTh>
                                <MudTh Style="text-align: right;">Duty/VAT</MudTh>
                                <MudTh Style="text-align: right;">COD/Coll</MudTh>
                                <MudTh>Payment</MudTh>
                                <MudTh Style="width: 130px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="AWB No">@context.AWBNo</MudTd>
                                <MudTd DataLabel="Consignee Name">@context.ConsigneeName</MudTd>
                                <MudTd DataLabel="Address">@(context.ConsigneeAddress?.Length > 25 ? context.ConsigneeAddress[..25] + "..." : context.ConsigneeAddress ?? "-")</MudTd>
                                <MudTd DataLabel="City">@(context.ConsigneeCity ?? "-")</MudTd>
                                <MudTd DataLabel="Country">@context.ConsigneeCountry</MudTd>
                                <MudTd DataLabel="Phone">@(context.ConsigneePhone ?? context.ConsigneeMobile ?? "-")</MudTd>
                                <MudTd DataLabel="Secondary Mobile">@(context.ConsigneeMobile2 ?? "-")</MudTd>
                                <MudTd DataLabel="Shipper Name">@context.ShipperName</MudTd>
                                <MudTd DataLabel="Shipper Address">@(context.ShipperAddress?.Length > 25 ? context.ShipperAddress[..25] + "..." : context.ShipperAddress ?? "-")</MudTd>
                                <MudTd DataLabel="Service Type">@(context.ServiceType ?? "-")</MudTd>
                                <MudTd DataLabel="Inco Terms">@(context.IncoTerms ?? "-")</MudTd>
                                <MudTd DataLabel="Account No">@(context.CustomerAccountNo ?? "-")</MudTd>
                                <MudTd DataLabel="Pieces" Style="text-align: right;">@context.Pieces</MudTd>
                                <MudTd DataLabel="Weight" Style="text-align: right;">@context.Weight.ToString("N2")</MudTd>
                                <MudTd DataLabel="Contents">@(context.ContentsDescription?.Length > 20 ? context.ContentsDescription[..20] + "..." : context.ContentsDescription)</MudTd>
                                <MudTd DataLabel="Value" Style="text-align: right;">@(context.DeclaredValue?.ToString("N2") ?? "-") @context.Currency</MudTd>
                                <MudTd DataLabel="Duty/VAT" Style="text-align: right;">@(context.DutyAmount?.ToString("N2") ?? "-")</MudTd>
                                <MudTd DataLabel="COD/Coll" Style="text-align: right;">@(context.CODAmount?.ToString("N2") ?? "-")</MudTd>
                                <MudTd DataLabel="Payment">@context.PaymentMode.ToString()</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.EditLocation" Size="Size.Small" Color="Color.Warning"
                                                   OnClick="@(() => OpenEditAddressDialog(context))" Title="Edit Address" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                                   OnClick="@(() => EditShipment(context))" Title="Edit All" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                   OnClick="@(() => DeleteShipment(context))" Title="Delete" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                        
                        <MudStack Row="true" Class="mt-3" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Total: @_shipments.Count shipments, @_shipments.Sum(s => s.Pieces) pieces, @_shipments.Sum(s => s.Weight).ToString("N2") Kg
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                            No shipments added. Use the "Inscan Shipments" button on the right to add shipments.
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" md="4">
                @if (IsNew)
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="false" Class="mb-4" Icon="@Icons.Material.Filled.Warning">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            Only after saving the header details, the Inscan and Manage Bags buttons will be enabled.
                        </MudText>
                    </MudAlert>
                }
                
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Actions</MudText>
                    
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                   OnClick="SaveDraft" Disabled="@(!_formValid || _saving)">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                            Save Draft
                        </MudButton>
                        
                        @if (!IsNew)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true" 
                                       Href="@($"/import-bags/{Id}")">
                                <MudIcon Icon="@Icons.Material.Filled.Inventory2" Class="mr-2" />
                                Manage Bags
                            </MudButton>
                            
                            <MudButton Variant="Variant.Outlined" Color="Color.Success" FullWidth="true" 
                                       Href="@($"/import-inscan/{Id}")">
                                <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Class="mr-2" />
                                Inscan Shipments
                            </MudButton>
                        }
                        
                        <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true" 
                                   Href="/import-dashboard">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
                            Back to List
                        </MudButton>
                    </MudStack>
                </MudPaper>
                
                @if (!IsNew)
                {
                    <MudPaper Class="pa-4 mt-4" Elevation="2">
                        <MudText Typo="Typo.subtitle1" Class="mb-3">Summary</MudText>
                        <MudStack Spacing="1">
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Import Ref:</MudText>
                                <MudText Typo="Typo.body2" Class="font-weight-bold">@_import.ImportRefNo</MudText>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Status:</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@_import.Status.ToString()</MudChip>
                            </div>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.body2">Created:</MudText>
                                <MudText Typo="Typo.body2">@_import.CreatedAt.ToString("dd/MM/yyyy")</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                    
                    <MudPaper Class="pa-4 mt-4" Elevation="2">
                        <div class="d-flex justify-space-between align-center mb-3">
                            <MudText Typo="Typo.subtitle1">
                                <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Class="mr-1" />
                                Documents (@_documents.Count)
                            </MudText>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" 
                                       OnClick="OpenUploadDialog" StartIcon="@Icons.Material.Filled.Upload">
                                Upload
                            </MudButton>
                        </div>
                        
                        @if (_documents.Any())
                        {
                            <MudList T="ImportDocument" Dense="true">
                                @foreach (var doc in _documents)
                                {
                                    <MudListItem T="ImportDocument">
                                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                            <div>
                                                <MudText Typo="Typo.body2" Class="font-weight-bold">@doc.DocumentTypeName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@doc.OriginalFileName</MudText>
                                            </div>
                                            <div>
                                                <MudIconButton Icon="@Icons.Material.Filled.Download" Size="Size.Small" 
                                                               OnClick="@(() => DownloadDocument(doc))" Title="Download" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                               OnClick="@(() => DeleteDocument(doc))" Title="Delete" />
                                            </div>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">No documents uploaded</MudText>
                        }
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    </MudForm>
}

<MudDialog @bind-Visible="_editAddressDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Edit Shipment - @(_editingAddressShipment?.AWBNo)
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="Consignee" Icon="@Icons.Material.Filled.Person">
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editName" Label="Consignee Name *" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editReferenceNo" Label="Reference No." Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editAddr" Label="Address" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editCity" Label="City" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editState" Label="State" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editCountry" Label="Country *" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editPostalCode" Label="Postal Code" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editPhone" Label="Phone" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editMobile" Label="Mobile" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editMobile2" Label="Secondary Mobile" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Shipper" Icon="@Icons.Material.Filled.Business">
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editShipperName" Label="Shipper Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editShipperPhone" Label="Shipper Phone" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editShipperAddress" Label="Shipper Address" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editShipperCity" Label="Shipper City" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editShipperCountry" Label="Shipper Country" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Shipment Details" Icon="@Icons.Material.Filled.Inventory">
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editPieces" Label="Pieces" Variant="Variant.Outlined" Min="1" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editWeight" Label="Weight (Kg)" Variant="Variant.Outlined" Min="0" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editChargeableWeight" Label="Chargeable Weight (Kg)" Variant="Variant.Outlined" Min="0" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="ImportShipmentType" @bind-Value="_editShipmentType" Label="Shipment Type" Variant="Variant.Outlined">
                            <MudSelectItem T="ImportShipmentType" Value="ImportShipmentType.Document">Document</MudSelectItem>
                            <MudSelectItem T="ImportShipmentType" Value="ImportShipmentType.NonDocument">Non-Document</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="ImportType" @bind-Value="_editImportType" Label="Import Type" Variant="Variant.Outlined">
                            <MudSelectItem T="ImportType" Value="ImportType.Courier">Courier</MudSelectItem>
                            <MudSelectItem T="ImportType" Value="ImportType.Commercial">Commercial</MudSelectItem>
                            <MudSelectItem T="ImportType" Value="ImportType.PersonalEffects">Personal Effects</MudSelectItem>
                            <MudSelectItem T="ImportType" Value="ImportType.Sample">Sample</MudSelectItem>
                            <MudSelectItem T="ImportType" Value="ImportType.Gift">Gift</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect T="PaymentMode" @bind-Value="_editPaymentMode" Label="Payment Mode" Variant="Variant.Outlined">
                            <MudSelectItem T="PaymentMode" Value="PaymentMode.Prepaid">Prepaid</MudSelectItem>
                            <MudSelectItem T="PaymentMode" Value="PaymentMode.COD">COD</MudSelectItem>
                            <MudSelectItem T="PaymentMode" Value="PaymentMode.Account">Account</MudSelectItem>
                            <MudSelectItem T="PaymentMode" Value="PaymentMode.PickupCash">Pickup Cash</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_editServiceType" Label="Service Type" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_editCustomerAccountNo" Label="Customer Account No" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_editIncoTerms" Label="Inco Terms" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editContentsDescription" Label="Contents Description" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editSpecialInstructions" Label="Special Instructions" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Customs & Charges" Icon="@Icons.Material.Filled.AttachMoney">
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editDeclaredValue" Label="Declared Value" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_editCurrency" Label="Currency" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_editHSCode" Label="HS Code" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editDutyAmount" Label="Duty Amount" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editVATAmount" Label="VAT Amount" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editOtherCharges" Label="Other Charges" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editTotalCustomsCharges" Label="Total Customs Charges" Variant="Variant.Outlined" Format="N2" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudCheckBox @bind-Value="_editIsCOD" Label="COD" Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_editCODAmount" Label="COD Amount" Variant="Variant.Outlined" Format="N2" Disabled="@(!_editIsCOD)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editImporterOfRecord" Label="Importer of Record" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editCustomsEntryNumber" Label="Customs Entry Number" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editExaminationRemarks" Label="Examination Remarks" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Remarks" Icon="@Icons.Material.Filled.Notes">
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editRemarks" Label="Remarks" Variant="Variant.Outlined" Lines="3" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditAddressDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="SaveEditedAddress" Variant="Variant.Filled" Color="Color.Primary" Disabled="@_savingAddress">
            @if (_savingAddress)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public long? Id { get; set; }
    
    private bool IsNew => !Id.HasValue || Id == 0;
    private bool _loading = true;
    private bool _saving = false;
    private MudForm? _form;
    private bool _formValid = false;
    
    private ImportMaster _import = new();
    private Country? _originCountry;
    private Country? _destCountry;
    private DateTime? _eta;
    private DateTime? _etd;
    private DateTime? _actualArrival;
    private DateTime? _flightDate;
    private List<Country> _countries = new();
    private List<Port> _ports = new();
    private Port? _originPort;
    private Port? _destinationPort;
    private List<ImportDocument> _documents = new();
    private string _referenceLabel = "Reference Number *";
    private List<Party> _coLoaders = new();
    private Party? _selectedCoLoader;
    private List<ImportShipment> _shipments = new();
    private List<Country> _allCountries = new();
    
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Manifest Dashboard", href: "/import-dashboard"),
        new BreadcrumbItem("Manifest Entry", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        _loading = false;
    }

    private async Task LoadData()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _countries = await dbContext.Countries.Where(c => !c.IsDeleted && c.IsActive).OrderBy(c => c.Name).ToListAsync();
        
        // Load all ports (airports for Air mode)
        _ports = await dbContext.Ports
            .Where(p => p.IsActive && !p.IsDeleted)
            .OrderBy(p => p.Name)
            .ToListAsync();
        
        // Load co-loaders
        _coLoaders = await dbContext.Parties
            .Where(p => p.PartyType == PartyType.CoLoader && p.IsActive && !p.IsDeleted)
            .OrderBy(p => p.Code)
            .ToListAsync();
        
        if (!IsNew && Id.HasValue)
        {
            _import = await dbContext.ImportMasters.FirstOrDefaultAsync(i => i.Id == Id.Value && !i.IsDeleted) 
                      ?? new ImportMaster();
            
            if (_import.OriginCountryId.HasValue)
                _originCountry = _countries.FirstOrDefault(c => c.Id == _import.OriginCountryId);
            if (_import.DestinationCountryId.HasValue)
                _destCountry = _countries.FirstOrDefault(c => c.Id == _import.DestinationCountryId);
            
            _eta = _import.ETA;
            _etd = _import.ETD;
            _actualArrival = _import.ActualArrivalDate;
            _flightDate = _import.FlightDate;
            
            // Load selected ports by code
            if (!string.IsNullOrEmpty(_import.OriginPortCode))
                _originPort = _ports.FirstOrDefault(p => p.IATACode == _import.OriginPortCode || p.Code == _import.OriginPortCode);
            if (!string.IsNullOrEmpty(_import.DestinationPortCode))
                _destinationPort = _ports.FirstOrDefault(p => p.IATACode == _import.DestinationPortCode || p.Code == _import.DestinationPortCode);
            
            // Load selected co-loader
            if (_import.CoLoaderId.HasValue)
                _selectedCoLoader = _coLoaders.FirstOrDefault(c => c.Id == _import.CoLoaderId);
            
            _documents = await dbContext.ImportDocuments
                .Where(d => d.ImportMasterId == Id.Value && !d.IsDeleted)
                .OrderByDescending(d => d.UploadedAt)
                .ToListAsync();
            
            // Load shipments
            _shipments = await dbContext.ImportShipments
                .Where(s => s.ImportMasterId == Id.Value && !s.IsDeleted)
                .OrderBy(s => s.AWBNo)
                .ToListAsync();
        }
        else
        {
            _import.TransactionDate = DateTime.SpecifyKind(DateTime.UtcNow, DateTimeKind.Utc);
            _import.Status = ImportMasterStatus.Draft;
        }
        UpdateReferenceLabel();
    }

    private void UpdateReferenceLabel()
    {
        _referenceLabel = _import.ImportMode switch
        {
            ImportMode.Air => "MAWB Number *",
            ImportMode.Sea => "BL Number *",
            ImportMode.Land => "Truck Waybill Number *",
            _ => "Reference Number *"
        };
    }

    private void OnImportModeChanged(ImportMode mode)
    {
        _import.ImportMode = mode;
        // Clear selected ports when mode changes since they may no longer be valid for new mode
        _originPort = null;
        _destinationPort = null;
        UpdateReferenceLabel();
    }

    private Task<IEnumerable<Country>> SearchCountries(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_countries.Take(20));
        
        return Task.FromResult(_countries.Where(c => c.Name.Contains(value, StringComparison.OrdinalIgnoreCase)).Take(20));
    }

    private async Task OnOriginCountryChanged(Country? country)
    {
        _originCountry = country;
        _import.OriginCountryId = country?.Id;
        _import.OriginCountryName = country?.Name;
        _originPort = null;
        
        if (country != null)
        {
            var availablePorts = GetOriginFilteredPorts().ToList();
            if (!availablePorts.Any())
            {
                await ShowNoPortsWarning("origin", country.Name ?? "");
            }
        }
        StateHasChanged();
    }

    private async Task OnDestCountryChanged(Country? country)
    {
        _destCountry = country;
        _import.DestinationCountryId = country?.Id;
        _import.DestinationCountryName = country?.Name;
        _destinationPort = null;
        
        if (country != null)
        {
            var availablePorts = GetDestFilteredPorts().ToList();
            if (!availablePorts.Any())
            {
                await ShowNoPortsWarning("destination", country.Name ?? "");
            }
        }
        StateHasChanged();
    }
    
    private async Task ShowNoPortsWarning(string portDirection, string countryName)
    {
        var portTypeName = _import.ImportMode switch
        {
            ImportMode.Air => "airports",
            ImportMode.Sea => "seaports",
            ImportMode.Land => "land borders",
            _ => "ports"
        };
        
        var result = await DialogService.ShowMessageBox(
            "No Ports Available",
            $"No {portTypeName} are available in {countryName}. Would you like to create new ports?",
            yesText: "Yes, Create Port",
            cancelText: "No, Leave Blank");
        
        if (result == true)
        {
            Navigation.NavigateTo($"/ports?returnUrl=/import-entry{(IsNew ? "" : $"/{Id}")}&country={countryName}");
        }
    }

    private string GetReferenceLabel() => _import.ImportMode switch
    {
        ImportMode.Air => "MAWB Number",
        ImportMode.Sea => "BL Number",
        ImportMode.Land => "Truck Waybill Number",
        _ => "Reference Number"
    };

    private string GetCarrierPlaceholder() => _import.ImportMode switch
    {
        ImportMode.Air => "e.g. Emirates, Qatar Airways",
        ImportMode.Sea => "e.g. Maersk, MSC",
        ImportMode.Land => "e.g. DHL Freight",
        _ => ""
    };

    private PortType GetPortTypeForMode() => _import.ImportMode switch
    {
        ImportMode.Air => PortType.Airport,
        ImportMode.Sea => PortType.Seaport,
        ImportMode.Land => PortType.LandBorder,
        _ => PortType.Airport
    };
    
    private IEnumerable<Port> GetOriginFilteredPorts()
    {
        var portType = GetPortTypeForMode();
        var filtered = _ports.Where(p => p.PortType == portType);
        
        if (_originCountry != null)
        {
            filtered = filtered.Where(p => 
                (!string.IsNullOrEmpty(_originCountry.Code) && string.Equals(p.CountryCode, _originCountry.Code, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(_originCountry.Name) && string.Equals(p.Country, _originCountry.Name, StringComparison.OrdinalIgnoreCase)));
        }
        
        return filtered;
    }
    
    private IEnumerable<Port> GetDestFilteredPorts()
    {
        var portType = GetPortTypeForMode();
        var filtered = _ports.Where(p => p.PortType == portType);
        
        if (_destCountry != null)
        {
            filtered = filtered.Where(p => 
                (!string.IsNullOrEmpty(_destCountry.Code) && string.Equals(p.CountryCode, _destCountry.Code, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(_destCountry.Name) && string.Equals(p.Country, _destCountry.Name, StringComparison.OrdinalIgnoreCase)));
        }
        
        return filtered;
    }
    
    private string GetOriginPortLabel() => _import.ImportMode switch
    {
        ImportMode.Air => "Origin Airport",
        ImportMode.Sea => "Origin Port",
        ImportMode.Land => "Origin Border",
        _ => "Origin Port"
    };
    
    private string GetDestPortLabel() => _import.ImportMode switch
    {
        ImportMode.Air => "Destination Airport",
        ImportMode.Sea => "Destination Port",
        ImportMode.Land => "Destination Border",
        _ => "Destination Port"
    };

    private async Task SaveDraft()
    {
        if (_form == null) return;
        await _form.Validate();
        if (!_formValid) return;

        _saving = true;
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            
            _import.ETA = _eta.HasValue ? DateTime.SpecifyKind(_eta.Value, DateTimeKind.Utc) : null;
            _import.ETD = _etd.HasValue ? DateTime.SpecifyKind(_etd.Value, DateTimeKind.Utc) : null;
            _import.ActualArrivalDate = _actualArrival.HasValue ? DateTime.SpecifyKind(_actualArrival.Value, DateTimeKind.Utc) : null;
            _import.FlightDate = _flightDate.HasValue ? DateTime.SpecifyKind(_flightDate.Value, DateTimeKind.Utc) : null;
            
            // Set port codes from selected ports
            _import.OriginPortCode = _originPort?.IATACode ?? _originPort?.Code;
            _import.DestinationPortCode = _destinationPort?.IATACode ?? _destinationPort?.Code;
            
            // Set co-loader info
            _import.CoLoaderId = _selectedCoLoader?.Id;
            _import.CoLoaderName = _selectedCoLoader?.Name;
            
            if (IsNew)
            {
                _import.ImportRefNo = await GenerateImportRefNo(dbContext);
                _import.CreatedAt = DateTime.UtcNow;
                dbContext.ImportMasters.Add(_import);
            }
            else
            {
                _import.ModifiedAt = DateTime.UtcNow;
                dbContext.ImportMasters.Update(_import);
            }
            
            await dbContext.SaveChangesAsync();
            Snackbar.Add("Import saved successfully", Severity.Success);
            
            if (IsNew)
                Navigation.NavigateTo($"/import-entry/{_import.Id}");
        }
        catch (Exception ex)
        {
            var innerMessage = ex.InnerException?.Message ?? ex.Message;
            Console.WriteLine($"Import save error: {ex}");
            Snackbar.Add($"Error saving import: {innerMessage}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task<string> GenerateImportRefNo(ApplicationDbContext dbContext)
    {
        var prefix = _import.ImportMode switch
        {
            ImportMode.Air => "IMP-AIR",
            ImportMode.Sea => "IMP-SEA",
            ImportMode.Land => "IMP-LND",
            _ => "IMP"
        };
        
        var today = DateTime.SpecifyKind(DateTime.UtcNow.Date, DateTimeKind.Utc);
        var tomorrow = today.AddDays(1);
        var count = await dbContext.ImportMasters
            .CountAsync(i => i.TransactionDate >= today && i.TransactionDate < tomorrow) + 1;
        
        return $"{prefix}-{today:yyyyMMdd}-{count:D4}";
    }
    
    private async Task OpenUploadDialog()
    {
        var parameters = new DialogParameters<ImportDocumentDialog>
        {
            { x => x.ImportMasterId, _import.Id }
        };
        
        var dialog = await DialogService.ShowAsync<ImportDocumentDialog>("Upload Document", parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        
        if (!result!.Canceled && result.Data is ImportDocumentDialog.ImportDocumentUploadResult uploadResult)
        {
            await SaveUploadedDocument(uploadResult);
        }
    }
    
    private async Task SaveUploadedDocument(ImportDocumentDialog.ImportDocumentUploadResult uploadResult)
    {
        if (uploadResult.File == null) return;
        
        try
        {
            var uploadsDir = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "imports", _import.Id.ToString());
            Directory.CreateDirectory(uploadsDir);
            
            var storedFileName = $"{Guid.NewGuid()}{Path.GetExtension(uploadResult.File.Name)}";
            var filePath = Path.Combine(uploadsDir, storedFileName);
            
            await using var stream = new FileStream(filePath, FileMode.Create);
            await uploadResult.File.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var document = new ImportDocument
            {
                ImportMasterId = _import.Id,
                DocumentType = uploadResult.DocumentType,
                DocumentTypeName = uploadResult.DocumentTypeName,
                OriginalFileName = uploadResult.File.Name,
                StoredFileName = storedFileName,
                FilePath = $"/uploads/imports/{_import.Id}/{storedFileName}",
                ContentType = uploadResult.File.ContentType,
                FileSize = uploadResult.File.Size,
                Description = uploadResult.Description,
                UploadedAt = DateTime.UtcNow,
                CreatedAt = DateTime.UtcNow
            };
            
            dbContext.ImportDocuments.Add(document);
            await dbContext.SaveChangesAsync();
            
            _documents.Insert(0, document);
            Snackbar.Add("Document uploaded successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task DownloadDocument(ImportDocument document)
    {
        var url = document.FilePath;
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }
    
    private async Task DeleteDocument(ImportDocument document)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Document",
            $"Are you sure you want to delete '{document.OriginalFileName}'?",
            yesText: "Delete", cancelText: "Cancel");
        
        if (confirm != true) return;
        
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var doc = await dbContext.ImportDocuments.FindAsync(document.Id);
            if (doc != null)
            {
                doc.IsDeleted = true;
                doc.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
            }
            
            _documents.Remove(document);
            Snackbar.Add("Document deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }
    
    // AddNewShipment method hidden - use Inscan feature instead
    // private void AddNewShipment()
    // {
    //     // Navigate to new shipment entry page
    //     Navigation.NavigateTo($"/import-shipment-entry/{_import.Id}/new");
    // }
    
    private ImportShipment? _editingAddressShipment;
    private bool _editAddressDialogVisible = false;
    private string _editName = "";
    private string _editAddr = "";
    private string _editCity = "";
    private string _editState = "";
    private string _editCountry = "";
    private string _editPostalCode = "";
    private string _editPhone = "";
    private string _editMobile = "";
    private string _editMobile2 = "";
    private string _editReferenceNo = "";
    private string _editShipperName = "";
    private string _editShipperAddress = "";
    private string _editShipperCity = "";
    private string _editShipperCountry = "";
    private string _editShipperPhone = "";
    private int _editPieces = 1;
    private decimal _editWeight = 0;
    private decimal? _editChargeableWeight;
    private ImportShipmentType _editShipmentType = ImportShipmentType.NonDocument;
    private ImportType _editImportType = ImportType.Courier;
    private PaymentMode _editPaymentMode = PaymentMode.Prepaid;
    private string _editContentsDescription = "";
    private string _editSpecialInstructions = "";
    private string _editServiceType = "";
    private string _editCustomerAccountNo = "";
    private string _editIncoTerms = "";
    private decimal? _editDeclaredValue;
    private string _editCurrency = "";
    private string _editHSCode = "";
    private decimal? _editDutyAmount;
    private decimal? _editVATAmount;
    private decimal? _editOtherCharges;
    private decimal? _editTotalCustomsCharges;
    private bool _editIsCOD = false;
    private decimal? _editCODAmount;
    private string _editImporterOfRecord = "";
    private string _editCustomsEntryNumber = "";
    private string _editExaminationRemarks = "";
    private string _editRemarks = "";
    private bool _savingAddress = false;

    private void OpenEditAddressDialog(ImportShipment shipment)
    {
        _editingAddressShipment = shipment;
        _editName = shipment.ConsigneeName ?? "";
        _editAddr = shipment.ConsigneeAddress ?? "";
        _editCity = shipment.ConsigneeCity ?? "";
        _editState = shipment.ConsigneeState ?? "";
        _editCountry = shipment.ConsigneeCountry ?? "";
        _editPostalCode = shipment.ConsigneePostalCode ?? "";
        _editPhone = shipment.ConsigneePhone ?? "";
        _editMobile = shipment.ConsigneeMobile ?? "";
        _editMobile2 = shipment.ConsigneeMobile2 ?? "";
        _editReferenceNo = shipment.ReferenceNo ?? "";
        _editShipperName = shipment.ShipperName ?? "";
        _editShipperAddress = shipment.ShipperAddress ?? "";
        _editShipperCity = shipment.ShipperCity ?? "";
        _editShipperCountry = shipment.ShipperCountry ?? "";
        _editShipperPhone = shipment.ShipperPhone ?? "";
        _editPieces = shipment.Pieces;
        _editWeight = shipment.Weight;
        _editChargeableWeight = shipment.ChargeableWeight;
        _editShipmentType = shipment.ShipmentType;
        _editImportType = shipment.ImportType;
        _editPaymentMode = shipment.PaymentMode;
        _editContentsDescription = shipment.ContentsDescription ?? "";
        _editSpecialInstructions = shipment.SpecialInstructions ?? "";
        _editServiceType = shipment.ServiceType ?? "";
        _editCustomerAccountNo = shipment.CustomerAccountNo ?? "";
        _editIncoTerms = shipment.IncoTerms ?? "";
        _editDeclaredValue = shipment.DeclaredValue;
        _editCurrency = shipment.Currency ?? "";
        _editHSCode = shipment.HSCode ?? "";
        _editDutyAmount = shipment.DutyAmount;
        _editVATAmount = shipment.VATAmount;
        _editOtherCharges = shipment.OtherCharges;
        _editTotalCustomsCharges = shipment.TotalCustomsCharges;
        _editIsCOD = shipment.IsCOD;
        _editCODAmount = shipment.CODAmount;
        _editImporterOfRecord = shipment.ImporterOfRecord ?? "";
        _editCustomsEntryNumber = shipment.CustomsEntryNumber ?? "";
        _editExaminationRemarks = shipment.ExaminationRemarks ?? "";
        _editRemarks = shipment.Remarks ?? "";
        _editAddressDialogVisible = true;
    }

    private void CloseEditAddressDialog()
    {
        _editAddressDialogVisible = false;
        _editingAddressShipment = null;
    }

    private async Task SaveEditedAddress()
    {
        if (_editingAddressShipment == null) return;
        _savingAddress = true;
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var entity = await dbContext.ImportShipments.FindAsync(_editingAddressShipment.Id);
            if (entity != null)
            {
                entity.ConsigneeName = _editName;
                entity.ConsigneeAddress = _editAddr;
                entity.ConsigneeCity = _editCity;
                entity.ConsigneeState = _editState;
                entity.ConsigneeCountry = _editCountry;
                entity.ConsigneePostalCode = _editPostalCode;
                entity.ConsigneePhone = _editPhone;
                entity.ConsigneeMobile = _editMobile;
                entity.ConsigneeMobile2 = string.IsNullOrWhiteSpace(_editMobile2) ? null : _editMobile2.Trim();
                entity.ReferenceNo = string.IsNullOrWhiteSpace(_editReferenceNo) ? null : _editReferenceNo.Trim();
                entity.ShipperName = string.IsNullOrWhiteSpace(_editShipperName) ? null : _editShipperName.Trim();
                entity.ShipperAddress = string.IsNullOrWhiteSpace(_editShipperAddress) ? null : _editShipperAddress.Trim();
                entity.ShipperCity = string.IsNullOrWhiteSpace(_editShipperCity) ? null : _editShipperCity.Trim();
                entity.ShipperCountry = string.IsNullOrWhiteSpace(_editShipperCountry) ? null : _editShipperCountry.Trim();
                entity.ShipperPhone = string.IsNullOrWhiteSpace(_editShipperPhone) ? null : _editShipperPhone.Trim();
                entity.Pieces = _editPieces;
                entity.Weight = _editWeight;
                entity.ChargeableWeight = _editChargeableWeight;
                entity.ShipmentType = _editShipmentType;
                entity.ImportType = _editImportType;
                entity.PaymentMode = _editPaymentMode;
                entity.ContentsDescription = string.IsNullOrWhiteSpace(_editContentsDescription) ? null : _editContentsDescription.Trim();
                entity.SpecialInstructions = string.IsNullOrWhiteSpace(_editSpecialInstructions) ? null : _editSpecialInstructions.Trim();
                entity.ServiceType = string.IsNullOrWhiteSpace(_editServiceType) ? null : _editServiceType.Trim();
                entity.CustomerAccountNo = string.IsNullOrWhiteSpace(_editCustomerAccountNo) ? null : _editCustomerAccountNo.Trim();
                entity.IncoTerms = string.IsNullOrWhiteSpace(_editIncoTerms) ? null : _editIncoTerms.Trim();
                entity.DeclaredValue = _editDeclaredValue;
                entity.Currency = string.IsNullOrWhiteSpace(_editCurrency) ? null : _editCurrency.Trim();
                entity.HSCode = string.IsNullOrWhiteSpace(_editHSCode) ? null : _editHSCode.Trim();
                entity.DutyAmount = _editDutyAmount;
                entity.VATAmount = _editVATAmount;
                entity.OtherCharges = _editOtherCharges;
                entity.TotalCustomsCharges = _editTotalCustomsCharges;
                entity.IsCOD = _editIsCOD;
                entity.CODAmount = _editIsCOD ? _editCODAmount : null;
                entity.ImporterOfRecord = string.IsNullOrWhiteSpace(_editImporterOfRecord) ? null : _editImporterOfRecord.Trim();
                entity.CustomsEntryNumber = string.IsNullOrWhiteSpace(_editCustomsEntryNumber) ? null : _editCustomsEntryNumber.Trim();
                entity.ExaminationRemarks = string.IsNullOrWhiteSpace(_editExaminationRemarks) ? null : _editExaminationRemarks.Trim();
                entity.Remarks = string.IsNullOrWhiteSpace(_editRemarks) ? null : _editRemarks.Trim();
                entity.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();

                _editingAddressShipment.ConsigneeName = _editName;
                _editingAddressShipment.ConsigneeAddress = _editAddr;
                _editingAddressShipment.ConsigneeCity = _editCity;
                _editingAddressShipment.ConsigneeState = _editState;
                _editingAddressShipment.ConsigneeCountry = _editCountry;
                _editingAddressShipment.ConsigneePostalCode = _editPostalCode;
                _editingAddressShipment.ConsigneePhone = _editPhone;
                _editingAddressShipment.ConsigneeMobile = _editMobile;
                _editingAddressShipment.ConsigneeMobile2 = entity.ConsigneeMobile2;
                _editingAddressShipment.ReferenceNo = entity.ReferenceNo;
                _editingAddressShipment.ShipperName = entity.ShipperName;
                _editingAddressShipment.ShipperAddress = entity.ShipperAddress;
                _editingAddressShipment.ShipperCity = entity.ShipperCity;
                _editingAddressShipment.ShipperCountry = entity.ShipperCountry;
                _editingAddressShipment.ShipperPhone = entity.ShipperPhone;
                _editingAddressShipment.Pieces = _editPieces;
                _editingAddressShipment.Weight = _editWeight;
                _editingAddressShipment.ChargeableWeight = _editChargeableWeight;
                _editingAddressShipment.ShipmentType = _editShipmentType;
                _editingAddressShipment.ImportType = _editImportType;
                _editingAddressShipment.PaymentMode = _editPaymentMode;
                _editingAddressShipment.ContentsDescription = entity.ContentsDescription;
                _editingAddressShipment.SpecialInstructions = entity.SpecialInstructions;
                _editingAddressShipment.ServiceType = entity.ServiceType;
                _editingAddressShipment.CustomerAccountNo = entity.CustomerAccountNo;
                _editingAddressShipment.IncoTerms = entity.IncoTerms;
                _editingAddressShipment.DeclaredValue = _editDeclaredValue;
                _editingAddressShipment.Currency = entity.Currency;
                _editingAddressShipment.HSCode = entity.HSCode;
                _editingAddressShipment.DutyAmount = _editDutyAmount;
                _editingAddressShipment.VATAmount = _editVATAmount;
                _editingAddressShipment.OtherCharges = _editOtherCharges;
                _editingAddressShipment.TotalCustomsCharges = _editTotalCustomsCharges;
                _editingAddressShipment.IsCOD = _editIsCOD;
                _editingAddressShipment.CODAmount = entity.CODAmount;
                _editingAddressShipment.ImporterOfRecord = entity.ImporterOfRecord;
                _editingAddressShipment.CustomsEntryNumber = entity.CustomsEntryNumber;
                _editingAddressShipment.ExaminationRemarks = entity.ExaminationRemarks;
                _editingAddressShipment.Remarks = entity.Remarks;

                Snackbar.Add("Shipment updated", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingAddress = false;
            _editAddressDialogVisible = false;
            _editingAddressShipment = null;
        }
    }

    private void EditShipment(ImportShipment shipment)
    {
        Navigation.NavigateTo($"/import-shipment-entry/{_import.Id}/{shipment.Id}");
    }
    
    private async Task DeleteShipment(ImportShipment shipment)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Shipment",
            $"Are you sure you want to delete shipment '{shipment.AWBNo}'?",
            yesText: "Delete", cancelText: "Cancel");
        
        if (confirm != true) return;
        
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var existing = await dbContext.ImportShipments.FindAsync(shipment.Id);
            if (existing != null)
            {
                existing.IsDeleted = true;
                existing.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
            }
            
            _shipments.Remove(shipment);
            await UpdateImportTotals();
            Snackbar.Add("Shipment deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task UpdateImportTotals()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var import = await dbContext.ImportMasters.FindAsync(_import.Id);
            if (import != null)
            {
                import.TotalShipments = _shipments.Count;
                import.TotalPieces = _shipments.Sum(s => s.Pieces);
                import.TotalGrossWeight = _shipments.Sum(s => s.Weight);
                import.ModifiedAt = DateTime.UtcNow;
                await dbContext.SaveChangesAsync();
                
                _import.TotalShipments = import.TotalShipments;
                _import.TotalPieces = import.TotalPieces;
                _import.TotalGrossWeight = import.TotalGrossWeight;
            }
        }
        catch { /* Ignore update totals error */ }
    }
}

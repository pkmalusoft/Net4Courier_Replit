@* Test dialog - Redesigned MudBlazor layout â€“ modern, clean, ERP-grade *@
@using MudBlazor

<MudDialog>
    <TitleContent>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudAvatar Color="Color.Primary" Size="Size.Medium">
                <MudIcon Icon="@Icons.Material.Filled.Business" />
            </MudAvatar>
            <MudStack Spacing="0">
                <MudText Typo="Typo.h6">Customer / Party Profile</MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    Core identity, business and location details
                </MudText>
            </MudStack>
        </MudStack>
    </TitleContent>
    
    <DialogContent>
        <MudGrid Spacing="3" Class="mt-2">

            <!-- LEFT COLUMN -->
            <MudItem xs="12" md="6">
                <MudCard Outlined="true">
                    <MudCardHeader>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">Core Identity</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <div class="native-select-wrapper">
                                <label class="required">Company</label>
                                <select class="native-select dense" @bind="_companyId">
                                    <option value="1">ABC Logistics Ltd</option>
                                    <option value="2">XYZ Courier Inc</option>
                                    <option value="3">Global Express Co</option>
                                </select>
                            </div>
                            <div class="native-select-wrapper">
                                <label class="required">Party Type</label>
                                <select class="native-select dense" @bind="_partyType">
                                    <option value="Customer">Customer</option>
                                    <option value="Vendor">Vendor</option>
                                    <option value="Agent">Agent</option>
                                    <option value="Employee">Employee</option>
                                </select>
                            </div>
                            <div class="native-select-wrapper">
                                <label>Account Type</label>
                                <select class="native-select dense" @bind="_accountTypeId">
                                    <option value="">-- Select --</option>
                                    <option value="1">Credit</option>
                                    <option value="2">Cash</option>
                                    <option value="3">Prepaid</option>
                                </select>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <MudCard Outlined="true" Class="mt-3">
                    <MudCardHeader>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">Business Details</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudTextField @bind-Value="_customerName" Label="Customer Name" Required="true" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <MudTextField @bind-Value="_shortCode" Label="Short Code" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <MudTextField @bind-Value="_accountNo" Label="Account No" Disabled="true" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <MudDivider Class="my-2" />
                            <MudTextField @bind-Value="_contactPerson" Label="Contact Person" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <MudTextField @bind-Value="_email" Label="Email" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <MudTextField @bind-Value="_phone" Label="Phone" 
                                          Variant="Variant.Outlined" Dense="true" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- RIGHT COLUMN -->
            <MudItem xs="12" md="6">
                <MudCard Outlined="true">
                    <MudCardHeader>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">Address</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudTextField @bind-Value="_address" Label="Street / PO Box" Lines="2" 
                                          Variant="Variant.Outlined" Dense="true" />
                            <div class="native-select-wrapper">
                                <label>Country</label>
                                <select class="native-select dense" value="@_countryId" @onchange="OnCountryChanged">
                                    <option value="">-- Select --</option>
                                    <option value="1">United Arab Emirates</option>
                                    <option value="2">Saudi Arabia</option>
                                    <option value="3">Qatar</option>
                                    <option value="4">Kuwait</option>
                                </select>
                            </div>
                            <div class="native-select-wrapper">
                                <label>City</label>
                                <select class="native-select dense" value="@_cityId" @onchange="OnCityChanged" disabled="@(!_countryId.HasValue)">
                                    <option value="">-- Select --</option>
                                    @foreach (var city in _cities)
                                    {
                                        <option value="@city.Id">@city.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="native-select-wrapper">
                                <label>Area / Locality</label>
                                <select class="native-select dense" @bind="_areaId" disabled="@(!_cityId.HasValue)">
                                    <option value="">-- Select --</option>
                                    @foreach (var area in _areas)
                                    {
                                        <option value="@area.Id">@area.Name</option>
                                    }
                                </select>
                            </div>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <MudCard Outlined="true" Class="mt-3">
                    <MudCardHeader>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">Credit & Status</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid Spacing="2">
                            <MudItem xs="6">
                                <MudNumericField @bind-Value="_creditLimit" Label="Credit Limit" 
                                                 Variant="Variant.Outlined" Dense="true" Format="N2" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudNumericField @bind-Value="_creditDays" Label="Credit Days" 
                                                 Variant="Variant.Outlined" Dense="true" />
                            </MudItem>
                        </MudGrid>
                        <MudSwitch @bind-Value="_isActive" Label="Active" Color="Color.Success" Class="mt-3" />
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance? MudDialog { get; set; }

    // Form fields
    private long _companyId = 1;
    private string _partyType = "Customer";
    private string _accountTypeId = "";
    private string _customerName = "";
    private string _shortCode = "";
    private string _accountNo = "AUTO-GENERATED";
    private string _contactPerson = "";
    private string _email = "";
    private string _phone = "";
    private string _address = "";
    private long? _countryId;
    private long? _cityId;
    private string _areaId = "";
    private decimal _creditLimit = 0;
    private int _creditDays = 30;
    private bool _isActive = true;

    // Demo data for cascading dropdowns
    private List<(long Id, string Name)> _cities = new();
    private List<(long Id, string Name)> _areas = new();

    private readonly Dictionary<long, List<(long Id, string Name)>> _citiesByCountry = new()
    {
        { 1, new() { (1, "Dubai"), (2, "Abu Dhabi"), (3, "Sharjah"), (4, "Ajman") } },
        { 2, new() { (5, "Riyadh"), (6, "Jeddah"), (7, "Dammam") } },
        { 3, new() { (8, "Doha"), (9, "Al Wakrah") } },
        { 4, new() { (10, "Kuwait City"), (11, "Hawally") } }
    };

    private readonly Dictionary<long, List<(long Id, string Name)>> _areasByCity = new()
    {
        { 1, new() { (1, "Deira"), (2, "Bur Dubai"), (3, "Jumeirah"), (4, "Marina") } },
        { 2, new() { (5, "Al Reem Island"), (6, "Khalifa City"), (7, "Al Maryah") } },
        { 3, new() { (8, "Al Majaz"), (9, "Al Nahda"), (10, "Industrial Area") } },
        { 5, new() { (11, "Olaya"), (12, "Al Malaz"), (13, "Diplomatic Quarter") } },
        { 6, new() { (14, "Al Balad"), (15, "Al Hamra"), (16, "Al Rawdah") } },
        { 8, new() { (17, "West Bay"), (18, "Al Sadd"), (19, "The Pearl") } }
    };

    private void OnCountryChanged(ChangeEventArgs e)
    {
        _countryId = null;
        _cityId = null;
        _areaId = "";
        _cities.Clear();
        _areas.Clear();

        if (long.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            _countryId = id;
            if (_citiesByCountry.TryGetValue(id, out var cities))
            {
                _cities = cities;
            }
        }
        StateHasChanged();
    }

    private void OnCityChanged(ChangeEventArgs e)
    {
        _cityId = null;
        _areaId = "";
        _areas.Clear();

        if (long.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            _cityId = id;
            if (_areasByCity.TryGetValue(id, out var areas))
            {
                _areas = areas;
            }
        }
        StateHasChanged();
    }

    private void Cancel() => MudDialog?.Cancel();

    private void Save() => MudDialog?.Close(DialogResult.Ok(true));
}

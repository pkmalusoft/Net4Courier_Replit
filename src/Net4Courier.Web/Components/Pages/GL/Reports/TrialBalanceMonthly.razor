@page "/n4c-reports/trial-balance-monthly"
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar

<PageTitle>Trial Balance - Monthly Comparison</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">Trial Balance - Monthly Comparison</MudText>

        <MudGrid>
            <MudItem xs="12" md="2">
                <MudSelect T="int" Label="Year" @bind-Value="_selectedYear">
                    @for (int y = DateTime.Today.Year; y >= DateTime.Today.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="int" Label="From Month" @bind-Value="_fromMonth">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <MudSelectItem Value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="int" Label="To Month" @bind-Value="_toMonth">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <MudSelectItem Value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="long?" Label="Branch" @bind-Value="_selectedBranchId" Clearable>
                    @foreach (var branch in _branches)
                    {
                        <MudSelectItem Value="@((long?)branch.Id)">@branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3" Class="d-flex align-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" Class="mr-2">
                    <MudIcon Icon="@Icons.Material.Filled.Search" Class="mr-1" /> Generate
                </MudButton>
            </MudItem>
        </MudGrid>

        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
        }
        else if (_reportData.Any())
        {
            <div class="mt-4" style="overflow-x: auto;">
                <MudTable Items="@_reportData" Hover="true" Striped="true" Dense="true" 
                          FixedHeader="true" Height="calc(100vh - 350px)">
                    <HeaderContent>
                        <MudTh Style="position: sticky; left: 0; background: white; z-index: 1;">Account</MudTh>
                        @foreach (var month in _months)
                        {
                            <MudTh Style="text-align: right; min-width: 120px;">@month</MudTh>
                        }
                        <MudTh Style="text-align: right; min-width: 120px;"><strong>Total</strong></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="position: sticky; left: 0; background: white;">
                            <MudText Typo="Typo.body2"><strong>@context.AccountCode</strong></MudText>
                            <MudText Typo="Typo.caption">@context.AccountName</MudText>
                        </MudTd>
                        @foreach (var month in _months)
                        {
                            var balance = context.MonthlyBalances.GetValueOrDefault(month, 0);
                            <MudTd Style="text-align: right;">
                                <MudText Color="@(balance >= 0 ? Color.Success : Color.Error)">
                                    @balance.ToString("N2")
                                </MudText>
                            </MudTd>
                        }
                        <MudTd Style="text-align: right;">
                            <strong>@context.MonthlyBalances.Values.Sum().ToString("N2")</strong>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </div>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">No data found for the selected criteria. Please generate the report.</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private int _selectedYear = DateTime.Today.Year;
    private int _fromMonth = 1;
    private int _toMonth = 12;
    private long? _selectedBranchId;
    private bool _isLoading = false;
    private List<MonthlyTrialBalanceItem> _reportData = new();
    private List<string> _months = new();
    private List<Branch> _branches = new();

    protected override async Task OnInitializedAsync()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _branches = await dbContext.Branches.Where(b => b.IsActive).OrderBy(b => b.Name).ToListAsync();
    }

    private async Task LoadReport()
    {
        if (_fromMonth > _toMonth)
        {
            Snackbar.Add("From month cannot be greater than To month", Severity.Warning);
            return;
        }

        _isLoading = true;
        _reportData.Clear();
        _months.Clear();
        StateHasChanged();

        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();

            for (int m = _fromMonth; m <= _toMonth; m++)
            {
                _months.Add(System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m));
            }

            var startDate = DateTime.SpecifyKind(new DateTime(_selectedYear, _fromMonth, 1), DateTimeKind.Utc);
            var endDate = DateTime.SpecifyKind(new DateTime(_selectedYear, _toMonth, DateTime.DaysInMonth(_selectedYear, _toMonth), 23, 59, 59), DateTimeKind.Utc);

            var accountHeads = await dbContext.AccountHeads
                .Where(a => a.IsActive)
                .OrderBy(a => a.Code)
                .ToListAsync();

            var journalsQuery = dbContext.Journals
                .Include(j => j.Entries)
                .Where(j => j.VoucherDate >= startDate && j.VoucherDate <= endDate);

            if (_selectedBranchId.HasValue)
            {
                journalsQuery = journalsQuery.Where(j => j.BranchId == _selectedBranchId.Value);
            }

            var journals = await journalsQuery.ToListAsync();

            foreach (var account in accountHeads)
            {
                var accountJournals = journals.Where(j => j.Entries.Any(e => e.AccountHeadId == account.Id)).ToList();
                if (!accountJournals.Any()) continue;

                var monthlyBalances = new Dictionary<string, decimal>();

                for (int m = _fromMonth; m <= _toMonth; m++)
                {
                    var monthJournals = accountJournals.Where(j => 
                        j.VoucherDate.Month == m && j.VoucherDate.Year == _selectedYear).ToList();
                    
                    var monthEntries = monthJournals.SelectMany(j => j.Entries.Where(e => e.AccountHeadId == account.Id)).ToList();
                    var debit = monthEntries.Sum(e => e.Debit ?? 0);
                    var credit = monthEntries.Sum(e => e.Credit ?? 0);
                    var monthName = System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m);
                    monthlyBalances[monthName] = debit - credit;
                }

                _reportData.Add(new MonthlyTrialBalanceItem
                {
                    AccountCode = account.Code,
                    AccountName = account.Name,
                    MonthlyBalances = monthlyBalances
                });
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class MonthlyTrialBalanceItem
    {
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public Dictionary<string, decimal> MonthlyBalances { get; set; } = new();
    }
}

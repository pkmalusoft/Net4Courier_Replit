@page "/reports/cash-bank-book"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Web.Services

<PageTitle>Cash & Bank Book - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Cash & Bank Book</MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect T="long?" @bind-Value="_selectedAccountId" Label="Select Account" Variant="Variant.Outlined">
                    <MudSelectItem Value="@((long?)null)">-- Select Account --</MudSelectItem>
                    @foreach (var acc in _cashBankAccounts)
                    {
                        <MudSelectItem Value="@((long?)acc.Id)">@(_hideAccountCodes ? acc.Name : $"{acc.Code} - {acc.Name}")</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadBook" 
                           Disabled="@(_selectedAccountId == null)" FullWidth="true" Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        </MudPaper>
    }
    else if (_entries.Any())
    {
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudGrid Class="mb-3">
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">@_selectedAccountName</MudText>
                    <MudText Typo="Typo.caption">
                        Period: @_fromDate?.ToString("dd-MMM-yyyy") to @_toDate?.ToString("dd-MMM-yyyy")
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Opening</MudText>
                            <MudText Typo="Typo.h6">@_openingBalance.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Receipts</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@_totalReceipts.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Payments</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@_totalPayments.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Closing</MudText>
                            <MudText Typo="Typo.h6" Color="@(_closingBalance >= 0 ? Color.Success : Color.Error)">
                                @_closingBalance.ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <MudTable Items="@_entries" Dense="true" Hover="true" Striped="true" FixedHeader="true" Height="500px">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Voucher No</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Particulars</MudTh>
                    <MudTh Style="text-align:right">Receipt</MudTh>
                    <MudTh Style="text-align:right">Payment</MudTh>
                    <MudTh Style="text-align:right">Balance</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Date.ToString("dd-MMM-yyyy")</MudTd>
                    <MudTd>@context.VoucherNo</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="@(context.Type == "Receipt" ? Color.Success : Color.Warning)">
                            @context.Type
                        </MudChip>
                    </MudTd>
                    <MudTd>@context.Particulars</MudTd>
                    <MudTd Style="text-align:right">
                        @if (context.Receipt > 0)
                        {
                            <span style="color: var(--mud-palette-success);">@context.Receipt.ToString("N2")</span>
                        }
                    </MudTd>
                    <MudTd Style="text-align:right">
                        @if (context.Payment > 0)
                        {
                            <span style="color: var(--mud-palette-error);">@context.Payment.ToString("N2")</span>
                        }
                    </MudTd>
                    <MudTd Style="text-align:right; font-weight:bold">
                        <span style="@(context.Balance >= 0 ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                            @context.Balance.ToString("N2")
                        </span>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
    else if (_hasSearched)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudAlert Severity="Severity.Info">No transactions found for the selected account and period.</MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private List<AccountHead> _cashBankAccounts = new();
    private long? _selectedAccountId;
    private string _selectedAccountName = "";
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private List<CashBankEntry> _entries = new();
    private decimal _openingBalance;
    private decimal _totalReceipts;
    private decimal _totalPayments;
    private decimal _closingBalance;
    private bool _isLoading;
    private bool _hasSearched;
    private bool _hideAccountCodes;

    protected override async Task OnInitializedAsync()
    {
        var authProvider = (AppAuthStateProvider)AuthStateProvider;
        _hideAccountCodes = authProvider.CurrentBranch?.HideAccountCodes ?? false;
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        _cashBankAccounts = await dbContext.AccountHeads
            .Where(a => a.IsActive && !a.IsGroup && 
                   (a.AccountNature == AccountNature.CashAccount || a.AccountNature == AccountNature.BankAccount))
            .OrderBy(a => a.AccountNature)
            .ThenBy(a => a.Code)
            .ToListAsync();
    }

    private async Task LoadBook()
    {
        if (_selectedAccountId == null) return;

        _isLoading = true;
        _hasSearched = true;
        _entries.Clear();

        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var account = _cashBankAccounts.First(a => a.Id == _selectedAccountId);
            _selectedAccountName = _hideAccountCodes ? account.Name : $"{account.Code} - {account.Name}";

            var fromUtc = _fromDate.HasValue ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) : DateTime.MinValue;
            var toUtc = _toDate.HasValue ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) : DateTime.MaxValue;

            var priorEntries = await dbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => e.AccountHeadId == _selectedAccountId && 
                       !e.IsDeleted && e.Journal.IsPosted && 
                       e.Journal.VoucherDate < fromUtc)
                .ToListAsync();

            _openingBalance = (account.OpeningBalance ?? 0) + 
                             priorEntries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));

            var entries = await dbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => e.AccountHeadId == _selectedAccountId && 
                       !e.IsDeleted && e.Journal.IsPosted &&
                       e.Journal.VoucherDate >= fromUtc && e.Journal.VoucherDate <= toUtc)
                .OrderBy(e => e.Journal.VoucherDate)
                .ThenBy(e => e.Journal.VoucherNo)
                .ToListAsync();

            decimal runningBalance = _openingBalance;
            foreach (var entry in entries)
            {
                var receipt = entry.Debit ?? 0;
                var payment = entry.Credit ?? 0;
                runningBalance += receipt - payment;

                _entries.Add(new CashBankEntry
                {
                    Date = entry.Journal.VoucherDate,
                    VoucherNo = entry.Journal.VoucherNo,
                    Type = receipt > 0 ? "Receipt" : "Payment",
                    Particulars = entry.Narration ?? entry.Journal.Narration ?? "",
                    Receipt = receipt,
                    Payment = payment,
                    Balance = runningBalance
                });
            }

            _totalReceipts = _entries.Sum(e => e.Receipt);
            _totalPayments = _entries.Sum(e => e.Payment);
            _closingBalance = runningBalance;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading cash/bank book: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private class CashBankEntry
    {
        public DateTime Date { get; set; }
        public string VoucherNo { get; set; } = "";
        public string Type { get; set; } = "";
        public string Particulars { get; set; } = "";
        public decimal Receipt { get; set; }
        public decimal Payment { get; set; }
        public decimal Balance { get; set; }
    }
}

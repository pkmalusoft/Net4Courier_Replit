@page "/gl/posting-setup"
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Finance.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Web.Services
@attribute [Authorize]

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Posting Setup</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h5">Posting Setup</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Configure which chart of accounts each amount field should post to
            </MudText>
        </div>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }
    else if (!_transactionTypes.Any())
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            No transaction page types defined. 
            Go to <MudLink Href="/gl/transaction-page-types">Transaction Page Types</MudLink> to create them first.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudSelect T="TransactionPageType" @bind-Value="_selectedType" Label="Transaction Type"
                           Variant="Variant.Outlined" Margin="Margin.Dense" ToStringFunc="@(t => t?.Name ?? "")">
                    @foreach (var type in _transactionTypes.Where(t => t.RequiresAutoPosting))
                    {
                        <MudSelectItem T="TransactionPageType" Value="@type">
                            @type.Name (@type.Code)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="8">
                @if (_selectedType != null && !_selectedType.RequiresAutoPosting)
                {
                    <MudAlert Severity="Severity.Info">
                        This transaction type is not marked for auto-posting.
                    </MudAlert>
                }
            </MudItem>
        </MudGrid>

        @if (_selectedType != null && _selectedType.RequiresAutoPosting)
        {
            var fields = TransactionFieldDefinitions.GetFieldsForTransactionType(_selectedType.Code);
            
            @if (!fields.Any())
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    No amount fields defined for this transaction type.
                </MudAlert>
            }
            else
            {
                <MudTable Items="@fields" Hover="true" Striped="true" Dense="true" Class="mt-4">
                    <HeaderContent>
                        <MudTh>Amount Field</MudTh>
                        <MudTh>Description</MudTh>
                        <MudTh Style="width: 250px;">Debit Account</MudTh>
                        <MudTh Style="width: 250px;">Credit Account</MudTh>
                        <MudTh Style="width: 80px;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        @{
                            var line = GetLineForField(context.Code);
                        }
                        <MudTd DataLabel="Amount Field">
                            <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Code</MudText>
                        </MudTd>
                        <MudTd DataLabel="Description">
                            <MudText Typo="Typo.body2">@context.Description</MudText>
                        </MudTd>
                        <MudTd DataLabel="Debit Account">
                            @if (line != null && !string.IsNullOrEmpty(line.DebitAccountCode))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                                    @(_hideAccountCodes || string.IsNullOrEmpty(line.DebitAccountCode) ? line.DebitAccountName : $"{line.DebitAccountCode} - {line.DebitAccountName}")
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Warning">Not configured</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit Account">
                            @if (line != null && !string.IsNullOrEmpty(line.CreditAccountCode))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                                    @(_hideAccountCodes || string.IsNullOrEmpty(line.CreditAccountCode) ? line.CreditAccountName : $"{line.CreditAccountCode} - {line.CreditAccountName}")
                                </MudChip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Warning">Not configured</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context, line))" Title="Configure" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="SeedDefaultsForType">Initialize All Fields</MudButton>
                </MudStack>
            }
        }
    }
</MudPaper>

<MudDialog @bind-Visible="_dialogVisible" Options="new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true }">
    <TitleContent>
        <MudText Typo="Typo.h6">Configure Posting for: @_editFieldName</MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4">
            <MudText Typo="Typo.body2">@_editFieldDescription</MudText>
        </MudAlert>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudAutocomplete T="GLChartOfAccount" @bind-Value="_selectedDebitAccount" Label="Debit Account"
                                 SearchFunc="SearchAccounts" ToStringFunc="@(a => a != null ? (_hideAccountCodes || string.IsNullOrEmpty(a.AccountCode) ? a.AccountName : $"{a.AccountCode} - {a.AccountName}") : "")"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudAutocomplete T="GLChartOfAccount" @bind-Value="_selectedCreditAccount" Label="Credit Account"
                                 SearchFunc="SearchAccounts" ToStringFunc="@(a => a != null ? (_hideAccountCodes || string.IsNullOrEmpty(a.AccountCode) ? a.AccountName : $"{a.AccountCode} - {a.AccountName}") : "")"
                                 Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_editDescription" Label="Notes (optional)" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveLine">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<TransactionPageType> _transactionTypes = new();
    private List<PostingSetupLine> _setupLines = new();
    private List<GLChartOfAccount> _accounts = new();
    private TransactionPageType? _selectedType;
    private bool _loading = true;
    private long? _companyId;
    private bool _hideAccountCodes;

    private bool _dialogVisible;
    private string _editFieldCode = string.Empty;
    private string _editFieldName = string.Empty;
    private string _editFieldDescription = string.Empty;
    private long _editLineId;
    private string? _editDescription;
    private GLChartOfAccount? _selectedDebitAccount;
    private GLChartOfAccount? _selectedCreditAccount;

    protected override async Task OnInitializedAsync()
    {
        var authProvider = (AppAuthStateProvider)AuthStateProvider;
        _hideAccountCodes = authProvider.CurrentBranch?.HideAccountCodes ?? false;
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var companyIdClaim = user.FindFirst("CompanyId")?.Value;
            if (long.TryParse(companyIdClaim, out var cid)) _companyId = cid;
        }
        if (_companyId == null || _companyId == 0)
        {
            _companyId = 1;
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();

            _transactionTypes = await context.TransactionPageTypes
                .Where(t => !t.IsDeleted)
                .OrderBy(t => t.SortOrder)
                .ToListAsync();

            _setupLines = await context.PostingSetupLines
                .Where(l => !l.IsDeleted && (l.CompanyId == null || l.CompanyId == _companyId))
                .ToListAsync();

            _accounts = await context.GLChartOfAccounts
                .Where(a => !a.IsDeleted && a.IsActive && (a.CompanyId == _companyId || a.CompanyId == null))
                .OrderBy(a => a.AccountCode)
                .ToListAsync();

            if (_selectedType == null && _transactionTypes.Any(t => t.RequiresAutoPosting))
            {
                _selectedType = _transactionTypes.FirstOrDefault(t => t.RequiresAutoPosting);
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private PostingSetupLine? GetLineForField(string fieldCode)
    {
        if (_selectedType == null) return null;
        return _setupLines.FirstOrDefault(l => 
            l.TransactionPageTypeId == _selectedType.Id && 
            l.LineItemCode == fieldCode);
    }

    private void OpenEditDialog(TransactionFieldDefinitions.FieldDefinition field, PostingSetupLine? existingLine)
    {
        _editFieldCode = field.Code;
        _editFieldName = field.Name;
        _editFieldDescription = field.Description;
        _editLineId = existingLine?.Id ?? 0;
        _editDescription = existingLine?.Description;
        _selectedDebitAccount = existingLine?.DebitAccountId != null 
            ? _accounts.FirstOrDefault(a => a.Id == existingLine.DebitAccountId) 
            : null;
        _selectedCreditAccount = existingLine?.CreditAccountId != null 
            ? _accounts.FirstOrDefault(a => a.Id == existingLine.CreditAccountId) 
            : null;
        _dialogVisible = true;
    }

    private void CloseDialog()
    {
        _dialogVisible = false;
    }

    private Task<IEnumerable<GLChartOfAccount>> SearchAccounts(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_accounts.Take(20));

        var result = _accounts.Where(a =>
            a.AccountCode.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            a.AccountName.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(20);
        return Task.FromResult(result);
    }

    private async Task SaveLine()
    {
        if (_selectedType == null) return;

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();

            if (_editLineId > 0)
            {
                var existing = await context.PostingSetupLines.FindAsync(_editLineId);
                if (existing != null)
                {
                    existing.DebitAccountId = _selectedDebitAccount?.Id;
                    existing.DebitAccountCode = _selectedDebitAccount?.AccountCode;
                    existing.DebitAccountName = _selectedDebitAccount?.AccountName;
                    existing.CreditAccountId = _selectedCreditAccount?.Id;
                    existing.CreditAccountCode = _selectedCreditAccount?.AccountCode;
                    existing.CreditAccountName = _selectedCreditAccount?.AccountName;
                    existing.Description = _editDescription;
                    existing.ModifiedAt = DateTime.UtcNow;
                }
            }
            else
            {
                var newLine = new PostingSetupLine
                {
                    TransactionPageTypeId = _selectedType.Id,
                    LineItemCode = _editFieldCode,
                    LineItemName = _editFieldName,
                    CompanyId = _companyId,
                    DebitAccountId = _selectedDebitAccount?.Id,
                    DebitAccountCode = _selectedDebitAccount?.AccountCode,
                    DebitAccountName = _selectedDebitAccount?.AccountName,
                    CreditAccountId = _selectedCreditAccount?.Id,
                    CreditAccountCode = _selectedCreditAccount?.AccountCode,
                    CreditAccountName = _selectedCreditAccount?.AccountName,
                    Description = _editDescription,
                    CreatedAt = DateTime.UtcNow
                };
                context.PostingSetupLines.Add(newLine);
            }

            await context.SaveChangesAsync();
            Snackbar.Add("Posting configuration saved", Severity.Success);
            CloseDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
    }

    private async Task SeedDefaultsForType()
    {
        if (_selectedType == null) return;

        var fields = TransactionFieldDefinitions.GetFieldsForTransactionType(_selectedType.Code);
        if (!fields.Any()) return;

        var confirmed = await DialogService.ShowMessageBox(
            "Initialize All Fields",
            $"This will create posting setup entries for all {fields.Count} amount fields of '{_selectedType.Name}'. Existing entries will not be modified. Continue?",
            yesText: "Yes", cancelText: "Cancel");

        if (confirmed != true) return;

        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            
            var existingCodes = await context.PostingSetupLines
                .Where(l => !l.IsDeleted && l.TransactionPageTypeId == _selectedType.Id && (l.CompanyId == null || l.CompanyId == _companyId))
                .Select(l => l.LineItemCode)
                .ToListAsync();

            var toAdd = fields
                .Where(f => !existingCodes.Contains(f.Code))
                .Select(f => new PostingSetupLine
                {
                    TransactionPageTypeId = _selectedType.Id,
                    LineItemCode = f.Code,
                    LineItemName = f.Name,
                    SortOrder = f.SortOrder,
                    CompanyId = _companyId,
                    CreatedAt = DateTime.UtcNow
                })
                .ToList();

            if (toAdd.Any())
            {
                context.PostingSetupLines.AddRange(toAdd);
                await context.SaveChangesAsync();
                Snackbar.Add($"Added {toAdd.Count} posting setup entries", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("All fields already have entries", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}

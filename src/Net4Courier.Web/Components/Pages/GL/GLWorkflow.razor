@page "/gl/workflow"
@inject ISnackbar Snackbar

<PageTitle>GL Workflow Configuration</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-6" Elevation="2">
        <MudText Typo="Typo.h4" Class="mb-2">GL Workflow Configuration</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
            Configure approval workflows, automation rules, and notification settings for GL transactions
        </MudText>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Approval Rules">
                <MudText Typo="Typo.h6" Class="mb-4">Journal Entry Approval Rules</MudText>
                <MudTable Items="@approvalRules" Dense="true" Hover="true" Bordered="true">
                    <HeaderContent>
                        <MudTh>Rule Name</MudTh>
                        <MudTh>Condition</MudTh>
                        <MudTh>Approver</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Name</MudTd>
                        <MudTd>@context.Condition</MudTd>
                        <MudTd>@context.Approver</MudTd>
                        <MudTd>
                            <MudSwitch @bind-Value="context.IsActive" Color="Color.Primary" />
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Class="mt-4">
                    Add Approval Rule
                </MudButton>
            </MudTabPanel>

            <MudTabPanel Text="Automation">
                <MudText Typo="Typo.h6" Class="mb-4">Automated Actions</MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudCard>
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.subtitle1">Auto-Post Recurring Entries</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Automatically post scheduled recurring journal entries
                                        </MudText>
                                    </div>
                                    <MudSwitch @bind-Value="autoPostRecurring" Color="Color.Primary" />
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12">
                        <MudCard>
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.subtitle1">Auto-Reverse Accruals</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Automatically create reversing entries for marked accruals
                                        </MudText>
                                    </div>
                                    <MudSwitch @bind-Value="autoReverseAccruals" Color="Color.Primary" />
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12">
                        <MudCard>
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.subtitle1">Currency Revaluation</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Run monthly currency revaluation on foreign currency accounts
                                        </MudText>
                                    </div>
                                    <MudSwitch @bind-Value="autoCurrencyReval" Color="Color.Primary" />
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12">
                        <MudCard>
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.subtitle1">Depreciation Posting</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Automatically post depreciation entries from Fixed Assets module
                                        </MudText>
                                    </div>
                                    <MudSwitch @bind-Value="autoDepreciation" Color="Color.Primary" />
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="Notifications">
                <MudText Typo="Typo.h6" Class="mb-4">Email Notifications</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudCard>
                            <MudCardContent>
                                <MudCheckBox @bind-Value="notifyOnApproval" Label="Notify when entry needs approval" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudCard>
                            <MudCardContent>
                                <MudCheckBox @bind-Value="notifyOnPosting" Label="Notify when entry is posted" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudCard>
                            <MudCardContent>
                                <MudCheckBox @bind-Value="notifyOnPeriodClose" Label="Notify before period close deadline" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudCard>
                            <MudCardContent>
                                <MudCheckBox @bind-Value="notifyOnRejection" Label="Notify when entry is rejected" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <MudTabPanel Text="Scheduled Jobs">
                <MudText Typo="Typo.h6" Class="mb-4">Scheduled Background Jobs</MudText>
                <MudTable Items="@scheduledJobs" Dense="true" Hover="true" Bordered="true">
                    <HeaderContent>
                        <MudTh>Job Name</MudTh>
                        <MudTh>Schedule</MudTh>
                        <MudTh>Last Run</MudTh>
                        <MudTh>Next Run</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Name</MudTd>
                        <MudTd>@context.Schedule</MudTd>
                        <MudTd>@context.LastRun?.ToString("g")</MudTd>
                        <MudTd>@context.NextRun?.ToString("g")</MudTd>
                        <MudTd>
                            <MudChip T="string" Color="@(context.IsEnabled ? Color.Success : Color.Default)" Size="Size.Small">
                                @(context.IsEnabled ? "Enabled" : "Disabled")
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary">Run Now</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>

        <MudDivider Class="my-4" />

        <div class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSettings">Save Configuration</MudButton>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private List<ApprovalRule> approvalRules = new()
    {
        new() { Name = "Large Transaction Approval", Condition = "Amount > 100,000", Approver = "Finance Manager", IsActive = true },
        new() { Name = "Inter-company Entry Approval", Condition = "Is Inter-company = True", Approver = "CFO", IsActive = true },
        new() { Name = "Manual Adjustment Approval", Condition = "Source = Manual", Approver = "Accounting Manager", IsActive = false }
    };

    private bool autoPostRecurring = true;
    private bool autoReverseAccruals = true;
    private bool autoCurrencyReval = false;
    private bool autoDepreciation = true;

    private bool notifyOnApproval = true;
    private bool notifyOnPosting = false;
    private bool notifyOnPeriodClose = true;
    private bool notifyOnRejection = true;

    private List<ScheduledJob> scheduledJobs = new()
    {
        new() { Name = "Post Recurring Entries", Schedule = "Daily at 6:00 AM", LastRun = DateTime.Now.AddDays(-1), NextRun = DateTime.Now.AddHours(2), IsEnabled = true },
        new() { Name = "Currency Revaluation", Schedule = "Monthly on 1st", LastRun = DateTime.Now.AddMonths(-1), NextRun = DateTime.Now.AddDays(15), IsEnabled = true },
        new() { Name = "Archive Old Entries", Schedule = "Yearly on Jan 1", LastRun = DateTime.Now.AddYears(-1), NextRun = DateTime.Now.AddMonths(6), IsEnabled = false }
    };

    private void SaveSettings()
    {
        Snackbar.Add("Workflow configuration saved successfully", Severity.Success);
    }

    private class ApprovalRule
    {
        public string Name { get; set; } = "";
        public string Condition { get; set; } = "";
        public string Approver { get; set; } = "";
        public bool IsActive { get; set; }
    }

    private class ScheduledJob
    {
        public string Name { get; set; } = "";
        public string Schedule { get; set; } = "";
        public DateTime? LastRun { get; set; }
        public DateTime? NextRun { get; set; }
        public bool IsEnabled { get; set; }
    }
}

@page "/gl/chart-of-accounts"
@attribute [Authorize]

@using PlatformDTOs = Truebooks.Platform.Contracts.DTOs
@using PlatformEnums = Truebooks.Platform.Contracts.Enums
@using Truebooks.Shared.UI.Dialogs
@using Microsoft.AspNetCore.Authorization
@using Truebooks.Platform.Core.MultiTenancy
@using Net4Courier.Web.Interfaces
@inject IChartOfAccountsService ChartOfAccountsService
@inject ITenantContext TenantContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Chart of Accounts</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="searchText" 
                             Label="Search" 
                             Placeholder="Code or Name"
                             Adornment="Adornment.Start" 
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             Immediate="true"
                             DebounceInterval="300"
                             OnDebounceIntervalElapsed="OnSearchChanged" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedType" Label="Account Type" T="string">
                    <MudSelectItem Value="@("All")">All Types</MudSelectItem>
                    <MudSelectItem Value="@("Asset")">Asset</MudSelectItem>
                    <MudSelectItem Value="@("Liability")">Liability</MudSelectItem>
                    <MudSelectItem Value="@("Equity")">Equity</MudSelectItem>
                    <MudSelectItem Value="@("Revenue")">Revenue</MudSelectItem>
                    <MudSelectItem Value="@("Expense")">Expense</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudCheckBox @bind-Value="showOnlyLeaf" Label="Show only leaf accounts" T="bool" />
            </MudItem>
            <MudItem xs="12" sm="2" Class="d-flex justify-end align-center gap-2">
                @if (!hasAccounts)
                {
                    <MudTooltip Text="Create Sample Chart of Accounts">
                        <MudIconButton Icon="@Icons.Material.Filled.AutoFixHigh"
                                      Color="Color.Warning"
                                      Variant="Variant.Filled"
                                      OnClick="SeedSampleAccounts" />
                    </MudTooltip>
                }
                <MudTooltip Text="New Account">
                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                  Color="Color.Primary"
                                  Variant="Variant.Filled"
                                  OnClick="CreateNew" />
                </MudTooltip>
                <MudMenu AnchorOrigin="Origin.BottomCenter" 
                         TransformOrigin="Origin.TopCenter">
                    <ActivatorContent>
                        <MudTooltip Text="Export">
                            <MudIconButton Icon="@Icons.Material.Filled.Download"
                                          Color="Color.Default"
                                          Variant="Variant.Filled" />
                        </MudTooltip>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem OnClick="ExportPdf" Icon="@Icons.Material.Filled.PictureAsPdf">PDF</MudMenuItem>
                        <MudMenuItem OnClick="ExportExcel" Icon="@Icons.Material.Filled.TableChart">Excel</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Style="height: 600px; overflow-y: auto;">
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudText Typo="Typo.h6">Account Hierarchy</MudText>
                    <div class="d-flex gap-1">
                        <MudTooltip Text="Expand All">
                            <MudIconButton Icon="@Icons.Material.Filled.UnfoldMore" 
                                          Size="MudBlazor.Size.Small" 
                                          OnClick="ExpandAll" />
                        </MudTooltip>
                        <MudTooltip Text="Collapse All">
                            <MudIconButton Icon="@Icons.Material.Filled.UnfoldLess" 
                                          Size="MudBlazor.Size.Small" 
                                          OnClick="CollapseAll" />
                        </MudTooltip>
                        @if (selectedNodeId.HasValue)
                        {
                            <MudTooltip Text="Clear Selection">
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                              Size="MudBlazor.Size.Small" 
                                              Color="Color.Error"
                                              OnClick="ClearSelection" />
                            </MudTooltip>
                        }
                    </div>
                </div>
                @if (isLoading)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (hierarchyAccounts.Any())
                {
                    @foreach (var account in hierarchyAccounts)
                    {
                        @RenderTreeNode(account, 0)
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No accounts found</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4">
                <MudDataGrid T="AccountModel" 
                            Items="@FilteredAccounts" 
                            Dense="true"
                            Hover="true"
                            ReadOnly="true"
                            Height="600px">
                    <Columns>
                        <PropertyColumn Property="x => x.AccountCode" Title="Code" />
                        <PropertyColumn Property="x => x.AccountName" Title="Name" />
                        <PropertyColumn Property="x => x.AccountType" Title="Type">
                            <CellTemplate>
                                <MudChip Size="MudBlazor.Size.Small" Color="GetTypeColor(context.Item.AccountType)">
                                    @context.Item.AccountType
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <TemplateColumn Title="Classification">
                            <CellTemplate>
                                @if (!string.IsNullOrEmpty(context.Item.ClassificationName))
                                {
                                    <MudChip Size="MudBlazor.Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                        @context.Item.ClassificationName
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default">â€”</MudText>
                                }
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.FullPath" Title="Path" />
                        <PropertyColumn Property="x => x.AllowPosting" Title="Posting">
                            <CellTemplate>
                                @if (context.Item.AllowPosting)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="MudBlazor.Size.Small" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.NotInterested" Color="Color.Default" Size="MudBlazor.Size.Small" />
                                }
                            </CellTemplate>
                        </PropertyColumn>
                        <TemplateColumn Title="Actions">
                            <CellTemplate>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                             Size="MudBlazor.Size.Small" 
                                             Color="Color.Primary"
                                             OnClick="@(() => EditAccount(context.Item.Id))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Size="MudBlazor.Size.Small" 
                                             Color="Color.Error"
                                             OnClick="@(() => DeleteAccount(context.Item.Id))" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<AccountModel> hierarchyAccounts = new();
    private List<AccountModel> flatAccounts = new();
    private string searchText = "";
    private string selectedType = "All";
    private bool showOnlyLeaf = false;
    private bool isLoading = false;
    private bool hasAccounts = true;
    private Guid? selectedNodeId = null;
    private HashSet<Guid> expandedNodes = new();

    private Guid GetTenantId() => TenantContext.TenantId ?? Guid.Empty;

    private class AccountModel
    {
        public Guid Id { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string DisplayName => string.IsNullOrEmpty(AccountCode) ? AccountName : $"{AccountCode} - {AccountName}";
        public string AccountType { get; set; } = "";
        public Guid? ParentAccountId { get; set; }
        public Guid? AccountClassificationId { get; set; }
        public string? ClassificationName { get; set; }
        public bool AllowPosting { get; set; }
        public bool IsActive { get; set; }
        public string FullPath { get; set; } = "";
        public List<AccountModel> SubAccounts { get; set; } = new();
    }

    private void ToggleExpand(Guid accountId)
    {
        if (expandedNodes.Contains(accountId))
            expandedNodes.Remove(accountId);
        else
            expandedNodes.Add(accountId);
        StateHasChanged();
    }

    private void ExpandAll()
    {
        expandedNodes.Clear();
        foreach (var account in flatAccounts.Where(a => HasChildren(a.Id)))
        {
            expandedNodes.Add(account.Id);
        }
        StateHasChanged();
    }

    private void CollapseAll()
    {
        expandedNodes.Clear();
        StateHasChanged();
    }

    private bool HasChildren(Guid accountId)
    {
        return flatAccounts.Any(a => a.ParentAccountId == accountId);
    }

    private void ClearSelection()
    {
        selectedNodeId = null;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckHasAccounts();
        await LoadAccounts();
    }
    
    private async Task CheckHasAccounts()
    {
        try
        {
            hasAccounts = await ChartOfAccountsService.HasAccountsAsync(GetTenantId());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error checking accounts: {ex.Message}", Severity.Error);
        }
    }

    private RenderFragment RenderTreeNode(AccountModel account, int level) => builder =>
    {
        var indent = level * 20;
        var hasChildren = account.SubAccounts.Any();
        var isExpanded = expandedNodes.Contains(account.Id);
        var isSelected = selectedNodeId == account.Id;
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", $"mud-list-item mud-list-item-dense{(isSelected ? " mud-primary-text" : "")}");
        builder.AddAttribute(2, "style", $"cursor: pointer; padding: 4px 8px; padding-left: {indent + 8}px; background-color: {(isSelected ? "var(--mud-palette-primary-lighten)" : "transparent")}; border-radius: 4px; margin: 2px 0;");
        
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "style", "display: flex; align-items: center; width: 100%;");
        
        // Expand/Collapse icon for parent nodes
        if (hasChildren)
        {
            builder.OpenElement(6, "span");
            builder.AddAttribute(7, "style", "cursor: pointer; margin-right: 4px;");
            builder.AddAttribute(8, "onclick", EventCallback.Factory.Create(this, (Action)(() => ToggleExpand(account.Id))));
            builder.OpenComponent<MudIcon>(9);
            builder.AddAttribute(10, "Icon", isExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight);
            builder.AddAttribute(11, "Size", MudBlazor.Size.Small);
            builder.CloseComponent();
            builder.CloseElement();
        }
        else
        {
            // Spacer for alignment when no children
            builder.OpenElement(6, "span");
            builder.AddAttribute(7, "style", "width: 24px; margin-right: 4px;");
            builder.CloseElement();
        }
        
        // Clickable area for selection
        builder.OpenElement(12, "div");
        builder.AddAttribute(13, "style", "display: flex; align-items: center; flex: 1;");
        builder.AddAttribute(14, "onclick", EventCallback.Factory.Create(this, (Action)(() => OnTreeNodeClick(account))));
        
        builder.OpenComponent<MudIcon>(15);
        builder.AddAttribute(16, "Icon", hasChildren ? (isExpanded ? Icons.Material.Filled.FolderOpen : Icons.Material.Filled.Folder) : Icons.Material.Filled.Description);
        builder.AddAttribute(17, "Size", MudBlazor.Size.Small);
        builder.AddAttribute(18, "Class", "mr-2");
        builder.AddAttribute(19, "Color", isSelected ? Color.Primary : Color.Default);
        builder.CloseComponent();
        
        builder.OpenComponent<MudText>(20);
        builder.AddAttribute(21, "Typo", Typo.body2);
        builder.AddAttribute(22, "Style", isSelected ? "font-weight: 600;" : "");
        builder.AddAttribute(23, "ChildContent", (RenderFragment)(textBuilder =>
        {
            textBuilder.AddContent(0, account.DisplayName);
        }));
        builder.CloseComponent();
        
        builder.CloseElement(); // Close clickable area
        
        builder.OpenElement(24, "div");
        builder.AddAttribute(25, "style", "margin-left: auto; display: flex; align-items: center; gap: 4px;");
        
        builder.OpenElement(26, "span");
        builder.AddAttribute(27, "class", $"mud-chip mud-chip-size-small mud-chip-color-{GetTypeColor(account.AccountType).ToString().ToLower()}");
        builder.AddAttribute(28, "style", "padding: 2px 8px; font-size: 0.75rem;");
        builder.AddContent(29, account.AccountType);
        builder.CloseElement();
        
        if (account.AllowPosting)
        {
            builder.OpenComponent<MudIcon>(30);
            builder.AddAttribute(31, "Icon", Icons.Material.Filled.Circle);
            builder.AddAttribute(32, "Color", Color.Success);
            builder.AddAttribute(33, "Size", MudBlazor.Size.Small);
            builder.CloseComponent();
        }
        
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement();
        
        // Only render children if expanded
        if (hasChildren && isExpanded)
        {
            foreach (var child in account.SubAccounts)
            {
                builder.AddContent(100, RenderTreeNode(child, level + 1));
            }
        }
    };

    private async Task LoadAccounts()
    {
        isLoading = true;
        try
        {
            var tenantId = GetTenantId();
            var hierarchyDtos = await ChartOfAccountsService.GetHierarchyAsync(tenantId);
            var flatDtos = await ChartOfAccountsService.GetAllAsync(tenantId);
            hierarchyAccounts = MapToHierarchyModels(hierarchyDtos);
            flatAccounts = flatDtos.Select(MapToModel).ToList();
            hasAccounts = flatAccounts.Any();
            CalculatePaths();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading accounts: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private AccountModel MapToModel(PlatformDTOs.ChartOfAccountDto dto) => new()
    {
        Id = dto.Id,
        AccountCode = dto.AccountCode ?? "",
        AccountName = dto.AccountName,
        AccountType = dto.AccountType.ToString(),
        ParentAccountId = dto.ParentAccountId,
        AccountClassificationId = dto.AccountClassificationId,
        ClassificationName = dto.AccountClassificationName,
        AllowPosting = dto.AllowPosting,
        IsActive = dto.IsActive
    };

    private List<AccountModel> MapToHierarchyModels(IEnumerable<PlatformDTOs.ChartOfAccountHierarchyDto> dtos)
    {
        return dtos.Select(dto => new AccountModel
        {
            Id = dto.Id,
            AccountCode = dto.AccountCode ?? "",
            AccountName = dto.AccountName,
            AccountType = dto.AccountType.ToString(),
            ParentAccountId = dto.ParentAccountId,
            AccountClassificationId = dto.AccountClassificationId,
            ClassificationName = dto.AccountClassificationName,
            AllowPosting = dto.AllowPosting,
            IsActive = dto.IsActive,
            SubAccounts = MapToHierarchyModels(dto.SubAccounts)
        }).ToList();
    }

    private void CalculatePaths()
    {
        foreach (var account in flatAccounts)
        {
            account.FullPath = GetAccountPath(account);
        }
    }

    private string GetAccountPath(AccountModel account)
    {
        if (account.ParentAccountId == null)
            return account.AccountName;

        var parent = flatAccounts.FirstOrDefault(a => a.Id == account.ParentAccountId);
        if (parent == null)
            return account.AccountName;

        return $"{GetAccountPath(parent)} > {account.AccountName}";
    }

    private IEnumerable<AccountModel> FilteredAccounts
    {
        get
        {
            var filtered = flatAccounts.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                filtered = filtered.Where(a => 
                    a.AccountCode.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    a.AccountName.Contains(searchText, StringComparison.OrdinalIgnoreCase));
            }

            if (selectedType != "All")
            {
                filtered = filtered.Where(a => a.AccountType == selectedType);
            }

            if (showOnlyLeaf)
            {
                var parentIds = flatAccounts.Where(a => a.ParentAccountId.HasValue)
                    .Select(a => a.ParentAccountId.Value)
                    .Distinct();
                filtered = filtered.Where(a => !parentIds.Contains(a.Id));
            }

            if (selectedNodeId.HasValue)
            {
                var descendants = GetDescendants(selectedNodeId.Value);
                filtered = filtered.Where(a => a.Id == selectedNodeId.Value || descendants.Contains(a.Id));
            }

            return filtered.OrderBy(a => a.AccountCode);
        }
    }

    private HashSet<Guid> GetDescendants(Guid parentId)
    {
        var descendants = new HashSet<Guid>();
        var children = flatAccounts.Where(a => a.ParentAccountId == parentId);
        
        foreach (var child in children)
        {
            descendants.Add(child.Id);
            foreach (var descendant in GetDescendants(child.Id))
            {
                descendants.Add(descendant);
            }
        }
        
        return descendants;
    }

    private void OnTreeNodeClick(AccountModel account)
    {
        selectedNodeId = account.Id;
    }

    private void OnSearchChanged()
    {
        StateHasChanged();
    }

    private Color GetTypeColor(string type)
    {
        return type switch
        {
            "Asset" => Color.Primary,
            "Liability" => Color.Error,
            "Equity" => Color.Info,
            "Revenue" => Color.Success,
            "Expense" => Color.Warning,
            _ => Color.Default
        };
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/gl/chart-of-accounts/new");
    }

    private void EditAccount(Guid id)
    {
        Navigation.NavigateTo($"/gl/chart-of-accounts/edit/{id}");
    }

    private async Task DeleteAccount(Guid id)
    {
        var account = flatAccounts.FirstOrDefault(a => a.Id == id);
        if (account == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete account '{account.AccountCode} - {account.AccountName}'?",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Account", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await ChartOfAccountsService.DeleteAsync(GetTenantId(), id);
                Snackbar.Add("Account deleted successfully", Severity.Success);
                await LoadAccounts();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting account: {ex.Message}", Severity.Error);
            }
        }
    }
    

    private async Task ExportPdf()
    {
        try
        {
            var response = await ChartOfAccountsService.ExportPdfAsync(GetTenantId());
            if (response != null)
            {
                Snackbar.Add("PDF report downloaded successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            var response = await ChartOfAccountsService.ExportExcelAsync(GetTenantId());
            if (response != null)
            {
                Snackbar.Add("Excel report downloaded successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting Excel: {ex.Message}", Severity.Error);
        }
    }

    private async Task SeedSampleAccounts()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Create Sample Chart of Accounts",
            "This will create a standard chart of accounts for a courier/logistics company. This action is recommended for first-time setup only. Continue?",
            yesText: "Create", cancelText: "Cancel");
        
        if (confirmed != true) return;
        
        try
        {
            await ChartOfAccountsService.SeedFromTemplateAsync(GetTenantId(), "courier");
            Snackbar.Add("Sample chart of accounts created successfully!", Severity.Success);
            hasAccounts = true;
            await LoadAccounts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating sample accounts: {ex.Message}", Severity.Error);
        }
    }
}

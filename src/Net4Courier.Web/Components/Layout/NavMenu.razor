@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Net4Courier.Infrastructure.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthService AuthService

<MudNavMenu>

    @if (CanAccessFavourites)
    {
        <!-- FAVOURITES -->
        <MudNavLink Href="/favourites" Icon="@Icons.Material.Filled.Star" Style="font-weight: 500;">Favourites</MudNavLink>
        
        <MudDivider Class="my-2" />
    }

    @if (HasValidRole)
    {
        <!-- 1. DASHBOARDS -->
        <MudNavGroup Title="Dashboards" Icon="@Icons.Material.Filled.Dashboard" 
                     Expanded="@(_expandedGroup == "Dashboards")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Dashboards", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Global Dashboard</MudNavLink>
            @if (!_isCourier)
            {
                <MudNavLink Href="/operational-desktop" Icon="@Icons.Material.Filled.Speed">Operations Dashboard</MudNavLink>
                <MudNavLink Href="/customer/dashboard" Icon="@Icons.Material.Filled.People">Customer Dashboard</MudNavLink>
            }
            <MudNavLink Href="/pickup-dashboard" Icon="@Icons.Material.Filled.LocalShipping">Pickup Dashboard</MudNavLink>
            @if (!_isCourier)
            {
                <MudNavLink Href="/tickets-dashboard" Icon="@Icons.Material.Filled.SupportAgent">Tickets Dashboard</MudNavLink>
            }
        </MudNavGroup>
    }

    @if (CanAccessOperations)
    {
        <!-- 2. OPERATIONS (Workflow-Based) -->
        <MudNavGroup Title="Operations" Icon="@Icons.Material.Filled.LocalShipping" 
                     Expanded="@(_expandedGroup == "Operations")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Operations", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/awb-list" Icon="@Icons.Material.Filled.ListAlt">Shipments (AWB)</MudNavLink>
            <MudNavGroup Title="Pickup" Icon="@Icons.Material.Filled.MoveToInbox">
                <MudNavLink Href="/pickup-management" Icon="@Icons.Material.Filled.ListAlt">Manage Pickup Request</MudNavLink>
                <MudNavLink Href="/pickup-schedules" Icon="@Icons.Material.Filled.Schedule">Pickup Schedules</MudNavLink>
                <MudNavLink Href="/pickup-commitments" Icon="@Icons.Material.Filled.AssignmentTurnedIn">Pickup Assignment</MudNavLink>
                <MudNavLink Href="/pickup-incentives" Icon="@Icons.Material.Filled.EmojiEvents">Pickup Incentives</MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Warehouse" Icon="@Icons.Material.Filled.Warehouse">
                <MudNavLink Href="/pickup-inscan" Icon="@Icons.Material.Filled.QrCodeScanner">INSCAN - Origin</MudNavLink>
                <MudNavLink Href="/import-dashboard" Icon="@Icons.Material.Filled.FlightLand">Manifest</MudNavLink>
                <MudNavLink Href="/outscan" Icon="@Icons.Material.Filled.ExitToApp">OUTSCAN / DRS</MudNavLink>
                <MudNavLink Href="/transfer-orders" Icon="@Icons.Material.Filled.TransferWithinAStation">Transfer Orders</MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Delivery" Icon="@Icons.Material.Filled.DeliveryDining">
                <MudNavLink Href="/pod-scanner" Icon="@Icons.Material.Filled.CameraAlt">POD Capture</MudNavLink>
                <MudNavLink Href="/rts-list" Icon="@Icons.Material.Filled.SwapHoriz">RTS / RTO</MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Import / Export" Icon="@Icons.Material.Filled.Flight">
                <MudNavLink Href="/import-customs" Icon="@Icons.Material.Filled.Gavel">Customs Processing</MudNavLink>
            </MudNavGroup>
        </MudNavGroup>
    }

    @if (_isCourier || _isAdministrator)
    {
        <!-- 3. DELIVERY (Courier + Admin) -->
        <MudNavGroup Title="My Deliveries" Icon="@Icons.Material.Filled.DeliveryDining" 
                     Expanded="@(_expandedGroup == "Delivery")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Delivery", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/courier-dashboard" Icon="@Icons.Material.Filled.Dashboard">Courier Dashboard</MudNavLink>
            <MudNavLink Href="/outscan" Icon="@Icons.Material.Filled.Assignment">Assigned Shipments (DRS)</MudNavLink>
            <MudNavLink Href="/pod-scanner" Icon="@Icons.Material.Filled.CameraAlt">Capture POD</MudNavLink>
            <MudNavLink Href="/drs-submission" Icon="@Icons.Material.Filled.Today">Courier Day-End</MudNavLink>
            <MudNavLink Href="/drs-cash-receipt" Icon="@Icons.Material.Filled.Receipt">Cash Receipt</MudNavLink>
        </MudNavGroup>
    }

    @if (CanAccessCustomers)
    {
        <!-- 4. CUSTOMERS -->
        <MudNavGroup Title="Customers" Icon="@Icons.Material.Filled.Contacts" 
                     Expanded="@(_expandedGroup == "Customers")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Customers", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/customers" Icon="@Icons.Material.Filled.Person">Customer Profiles</MudNavLink>
            <MudNavLink Href="/contracts-pricing" Icon="@Icons.Material.Filled.Handshake">Contracts</MudNavLink>
            <MudNavLink Href="/sla-management" Icon="@Icons.Material.Filled.Verified">SLA Management</MudNavLink>
            <MudNavLink Href="/credit-limits" Icon="@Icons.Material.Filled.CreditScore">Credit Settings</MudNavLink>
            <MudNavLink Href="/customer-awb-issue" Icon="@Icons.Material.Filled.Assignment">Prepaid AWB Issue</MudNavLink>
            <MudNavLink Href="/prepaid-awb-register" Icon="@Icons.Material.Filled.ListAlt">Prepaid AWB Register</MudNavLink>
            <MudNavLink Href="/complaints" Icon="@Icons.Material.Filled.SupportAgent">Complaints / Tickets</MudNavLink>
        </MudNavGroup>
    }

    @if (CanAccessPricing)
    {
        <!-- 5. PRICING -->
        <MudNavGroup Title="Pricing" Icon="@Icons.Material.Filled.PriceChange" 
                     Expanded="@(_expandedGroup == "Pricing")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Pricing", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/zone-categories" Icon="@Icons.Material.Filled.Category">Zone Categories</MudNavLink>
            <MudNavLink Href="/zone-matrix" Icon="@Icons.Material.Filled.GridOn">Zones</MudNavLink>
            <MudNavLink Href="/rate-cards" Icon="@Icons.Material.Filled.TableChart">Rate Cards</MudNavLink>
            <MudNavLink Href="/cost-rate-cards" Icon="@Icons.Material.Filled.PriceCheck">Cost Rate Cards</MudNavLink>
            <MudNavLink Href="/fuel-surcharge" Icon="@Icons.Material.Filled.LocalGasStation">Fuel Surcharge</MudNavLink>
            <MudNavLink Href="/special-charges" Icon="@Icons.Material.Filled.AttachMoney">Special Charges</MudNavLink>
            <MudNavLink Href="/other-charges" Icon="@Icons.Material.Filled.Receipt">Other Charges</MudNavLink>
            <MudNavLink Href="/discounts-contracts" Icon="@Icons.Material.Filled.Discount">Discounts</MudNavLink>
            <MudNavLink Href="/rate-enquiry" Icon="@Icons.Material.Filled.Calculate">Rate Calculator</MudNavLink>
            <MudNavLink Href="/rate-simulator" Icon="@Icons.Material.Filled.Science">Rate Simulator</MudNavLink>
        </MudNavGroup>
    }

    @if (CanAccessFinance)
    {
        <!-- 6. FINANCE -->
    <MudNavGroup Title="Finance" Icon="@Icons.Material.Filled.AccountBalance" 
                 Expanded="@(_expandedGroup == "Finance")" 
                 ExpandedChanged="@(e => OnGroupExpandedChanged("Finance", e))"
                 Class="nav-group-header">
        <MudNavGroup Title="Accounts Receivable" Icon="@Icons.Material.Filled.RequestQuote">
            <MudNavLink Href="/customer-invoices" Icon="@Icons.Material.Filled.Description">Invoices</MudNavLink>
            <MudNavLink Href="/customer-invoicing" Icon="@Icons.Material.Filled.Add">Generate Invoice</MudNavLink>
            <MudNavLink Href="/receipts" Icon="@Icons.Material.Filled.ReceiptLong">Receipts</MudNavLink>
            <MudNavLink Href="/credit-notes" Icon="@Icons.Material.Filled.NoteAlt">Credit Notes</MudNavLink>
            <MudNavLink Href="/customer-credit-approval" Icon="@Icons.Material.Filled.Approval">Credit Approval</MudNavLink>
            <MudNavGroup Title="AR Settings" Icon="@Icons.Material.Filled.Tune">
                <MudNavLink Href="/account-types" Icon="@Icons.Material.Filled.AccountBalance">Customer Account Types</MudNavLink>
                <MudNavLink Href="/ar-settings" Icon="@Icons.Material.Filled.Settings">AR Configuration</MudNavLink>
            </MudNavGroup>
        </MudNavGroup>
        <MudNavGroup Title="Accounts Payable" Icon="@Icons.Material.Filled.Payment">
            <MudNavLink Href="/vendor-bills" Icon="@Icons.Material.Filled.Receipt">Vendor Bills</MudNavLink>
            <MudNavLink Href="/vendor-payments" Icon="@Icons.Material.Filled.Payments">Vendor Payments</MudNavLink>
            <MudNavLink Href="/expense-management" Icon="@Icons.Material.Filled.MoneyOff">Expenses</MudNavLink>
            <MudNavLink Href="/debit-notes" Icon="@Icons.Material.Filled.NoteAlt">Debit Notes</MudNavLink>
            <MudNavGroup Title="AP Settings" Icon="@Icons.Material.Filled.Tune">
                <MudNavLink Href="/supplier-master" Icon="@Icons.Material.Filled.LocalShipping">Supplier Master</MudNavLink>
                <MudNavLink Href="/ap-settings" Icon="@Icons.Material.Filled.Settings">AP Configuration</MudNavLink>
            </MudNavGroup>
        </MudNavGroup>
        <MudNavGroup Title="General Ledger" Icon="@Icons.Material.Filled.MenuBook">
            <MudNavLink Href="/cash-bank-transactions" Icon="@Icons.Material.Filled.Payments">Cash & Bank</MudNavLink>
            <MudNavLink Href="/gl/journal-entry" Icon="@Icons.Material.Filled.Book">Journal Entry</MudNavLink>
            <MudNavLink Href="/gl/journal-vouchers" Icon="@Icons.Material.Filled.ViewList">Journal List</MudNavLink>
            <MudNavLink Href="/bank-accounts" Icon="@Icons.Material.Filled.AccountBalance">Bank Accounts</MudNavLink>
            <MudNavLink Href="/bank-reconciliation" Icon="@Icons.Material.Filled.Compare">Bank Reconciliation</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Courier Reconciliation" Icon="@Icons.Material.Filled.Sync">
            <MudNavLink Href="/drs-reconciliation" Icon="@Icons.Material.Filled.Dashboard">Reconciliation Dashboard</MudNavLink>
            <MudNavLink Href="/drs-reconcile" Icon="@Icons.Material.Filled.FactCheck">AWB Reconciliation</MudNavLink>
            <MudNavLink Href="/drs-submission" Icon="@Icons.Material.Filled.Today">Courier Day-End</MudNavLink>
            <MudNavLink Href="/cod-remittance" Icon="@Icons.Material.Filled.AttachMoney">COD Remittance</MudNavLink>
            <MudNavLink Href="/expense-approval" Icon="@Icons.Material.Filled.Approval">Expense Approval</MudNavLink>
            <MudNavLink Href="/courier-ledger" Icon="@Icons.Material.Filled.MenuBook">Courier Ledger</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Cost Management" Icon="@Icons.Material.Filled.PriceCheck">
            <MudNavLink Href="/mawb-cost-entry" Icon="@Icons.Material.Filled.FlightTakeoff">MAWB Cost Entry</MudNavLink>
            <MudNavLink Href="/cost-actualization" Icon="@Icons.Material.Filled.FactCheck">Cost Actualization</MudNavLink>
            <MudNavLink Href="/profitability-report" Icon="@Icons.Material.Filled.TrendingUp">Profitability Report</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Finance Setup" Icon="@Icons.Material.Filled.Settings">
            <MudNavLink Href="/financial-years" Icon="@Icons.Material.Filled.CalendarMonth">Financial Years</MudNavLink>
            <MudNavLink Href="/gl/chart-of-accounts" Icon="@Icons.Material.Filled.AccountTree">Chart of Accounts</MudNavLink>
            <MudNavLink Href="/gl/control-accounts" Icon="@Icons.Material.Filled.AccountBalanceWallet">Control Accounts</MudNavLink>
            <MudNavLink Href="/gl/transaction-page-types" Icon="@Icons.Material.Filled.Description">Transaction Page Types</MudNavLink>
            <MudNavLink Href="/gl/posting-setup" Icon="@Icons.Material.Filled.PostAdd">Posting Setup</MudNavLink>
            <MudNavLink Href="/gl/tax-codes" Icon="@Icons.Material.Filled.Calculate">Tax Codes</MudNavLink>
            <MudNavLink Href="/gl/currencies" Icon="@Icons.Material.Filled.CurrencyExchange">Currencies</MudNavLink>
            <MudNavLink Href="/gl/voucher-numbering" Icon="@Icons.Material.Filled.FormatListNumbered">Voucher Numbering</MudNavLink>
        </MudNavGroup>
    </MudNavGroup>
    }

    @if (CanAccessFinance)
    {
        <MudNavGroup Title="Approval Workflow" Icon="@Icons.Material.Filled.Approval" 
                     Expanded="@(_expandedGroup == "ApprovalWorkflow")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("ApprovalWorkflow", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/approval-workflow/my-approvals" Icon="@Icons.Material.Filled.HourglassTop">My Approvals</MudNavLink>
            <MudNavLink Href="/approval-workflow/config" Icon="@Icons.Material.Filled.Settings">Workflow Configuration</MudNavLink>
        </MudNavGroup>
    }

    @if (CanAccessReports)
    {
        <!-- 7. REPORTS -->
        <MudNavGroup Title="Reports" Icon="@Icons.Material.Filled.Assessment" 
                 Expanded="@(_expandedGroup == "Reports")" 
                 ExpandedChanged="@(e => OnGroupExpandedChanged("Reports", e))"
                 Class="nav-group-header">
        <MudNavGroup Title="Operations Reports" Icon="@Icons.Material.Filled.LocalShipping">
            <MudNavLink Href="/reports/ops/awb-register" Icon="@Icons.Material.Filled.ListAlt">AWB Register</MudNavLink>
            <MudNavLink Href="/reports/ops/sales-register" Icon="@Icons.Material.Filled.PointOfSale">Sales Register</MudNavLink>
            <MudNavLink Href="/reports/ops/customer-awb-list" Icon="@Icons.Material.Filled.Person">Customer AWB List</MudNavLink>
            <MudNavLink Href="/reports/ops/cod-pending" Icon="@Icons.Material.Filled.AttachMoney">COD Pending</MudNavLink>
            <MudNavLink Href="/reports/ops/uninvoiced" Icon="@Icons.Material.Filled.PendingActions">Uninvoiced AWBs</MudNavLink>
            <MudNavLink Href="/reports/ops/delivery-pending" Icon="@Icons.Material.Filled.LocalShipping">Delivery Pending</MudNavLink>
            <MudNavLink Href="/reports/ops/outscan-pending" Icon="@Icons.Material.Filled.ExitToApp">Outscan Pending</MudNavLink>
            <MudNavLink Href="/reports/ops/drs-cashflow" Icon="@Icons.Material.Filled.Payments">DRS Cash Flow</MudNavLink>
            <MudNavLink Href="/reports/ops/pdc-register" Icon="@Icons.Material.Filled.CreditCard">PDC Register</MudNavLink>
            <MudNavLink Href="/reports/ops/rts-register" Icon="@Icons.Material.Filled.Undo">AWB RTS Register</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="AR Reports" Icon="@Icons.Material.Filled.RequestQuote">
            <MudNavLink Href="/reports/ar/customer-list" Icon="@Icons.Material.Filled.People">Customer List</MudNavLink>
            <MudNavLink Href="/reports/ar/customer-opening-balance" Icon="@Icons.Material.Filled.AccountBalance">Opening Balance Register</MudNavLink>
            <MudNavLink Href="/reports/ar/customer-invoice-register" Icon="@Icons.Material.Filled.ListAlt">Invoice Register</MudNavLink>
            <MudNavLink Href="/reports/ar/customer-ledger" Icon="@Icons.Material.Filled.MenuBook">Customer Ledger</MudNavLink>
            <MudNavLink Href="/reports/ar/customer-statement" Icon="@Icons.Material.Filled.Receipt">Customer Statement</MudNavLink>
            <MudNavLink Href="/reports/ar/customer-outstanding" Icon="@Icons.Material.Filled.Warning">Outstanding Report</MudNavLink>
            <MudNavLink Href="/reports/ar/print-invoice" Icon="@Icons.Material.Filled.Print">Print Invoice</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="AP Reports" Icon="@Icons.Material.Filled.Payment">
            <MudNavLink Href="/reports/ap/supplier-list" Icon="@Icons.Material.Filled.People">Supplier List</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-opening-balance" Icon="@Icons.Material.Filled.AccountBalance">Opening Balance Register</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-invoice-register" Icon="@Icons.Material.Filled.ListAlt">Invoice Register</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-ledger" Icon="@Icons.Material.Filled.MenuBook">Supplier Ledger</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-statement" Icon="@Icons.Material.Filled.Receipt">Supplier Statement</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-aging" Icon="@Icons.Material.Filled.Schedule">Aging Report</MudNavLink>
            <MudNavLink Href="/reports/ap/supplier-outstanding" Icon="@Icons.Material.Filled.Warning">Outstanding Report</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Financial Reports" Icon="@Icons.Material.Filled.AccountBalance">
            <MudNavLink Href="/reports/day-book" Icon="@Icons.Material.Filled.CalendarToday">Day Book Register</MudNavLink>
            <MudNavLink Href="/reports/account-ledger" Icon="@Icons.Material.Filled.MenuBook">General Ledger</MudNavLink>
            <MudNavLink Href="/reports/trial-balance" Icon="@Icons.Material.Filled.Balance">Trial Balance</MudNavLink>
            <MudNavLink Href="/reports/profit-loss" Icon="@Icons.Material.Filled.TrendingUp">Profit & Loss</MudNavLink>
            <MudNavLink Href="/reports/balance-sheet" Icon="@Icons.Material.Filled.TableChart">Balance Sheet</MudNavLink>
        </MudNavGroup>
        </MudNavGroup>
    }

    @if (CanAccessMasters)
    {
        <!-- 8. MASTERS -->
        <MudNavGroup Title="Masters" Icon="@Icons.Material.Filled.Tune" 
                     Expanded="@(_expandedGroup == "Masters")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Masters", e))"
                     Class="nav-group-header">
            <MudNavGroup Title="Geography" Icon="@Icons.Material.Filled.Public">
                <MudNavLink Href="/countries" Icon="@Icons.Material.Filled.Flag">Countries</MudNavLink>
                <MudNavLink Href="/states" Icon="@Icons.Material.Filled.Map">States</MudNavLink>
                <MudNavLink Href="/cities" Icon="@Icons.Material.Filled.LocationCity">Cities</MudNavLink>
                <MudNavLink Href="/locations" Icon="@Icons.Material.Filled.PinDrop">Locations / Pincodes</MudNavLink>
                <MudNavLink Href="/ports" Icon="@Icons.Material.Filled.FlightTakeoff">Ports</MudNavLink>
                <MudNavLink Href="/customer-zones" Icon="@Icons.Material.Filled.MyLocation">Customer Zones</MudNavLink>
            </MudNavGroup>
            <MudNavGroup Title="Operations" Icon="@Icons.Material.Filled.Build">
                <MudNavLink Href="/service-types" Icon="@Icons.Material.Filled.Category">Service Types</MudNavLink>
                <MudNavLink Href="/shipment-modes" Icon="@Icons.Material.Filled.AltRoute">Shipment Modes</MudNavLink>
                <MudNavLink Href="/inco-terms" Icon="@Icons.Material.Filled.Gavel">Inco Terms</MudNavLink>
                <MudNavLink Href="/status-management" Icon="@Icons.Material.Filled.Timeline">Status Management</MudNavLink>
                <MudNavLink Href="/status-event-mappings" Icon="@Icons.Material.Filled.Link">Status Event Mappings</MudNavLink>
                <MudNavLink Href="/vehicles" Icon="@Icons.Material.Filled.DirectionsCar">Vehicles</MudNavLink>
                <MudNavLink Href="/awb-stock" Icon="@Icons.Material.Filled.Inventory">AWB Stock Management</MudNavLink>
            </MudNavGroup>
        </MudNavGroup>
    }

    @if (CanAccessSettings)
    {
        <!-- 9. SETTINGS -->
    <MudNavGroup Title="Settings" Icon="@Icons.Material.Filled.Settings" 
                 Expanded="@(_expandedGroup == "Settings")" 
                 ExpandedChanged="@(e => OnGroupExpandedChanged("Settings", e))"
                 Class="nav-group-header">
        <MudNavGroup Title="Organization" Icon="@Icons.Material.Filled.Business">
            <MudNavLink Href="/companies" Icon="@Icons.Material.Filled.Domain">Companies</MudNavLink>
            <MudNavLink Href="/branches" Icon="@Icons.Material.Filled.AccountTree">Branches</MudNavLink>
            <MudNavLink Href="/warehouses" Icon="@Icons.Material.Filled.Warehouse">Warehouses / Hubs</MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="User Management" Icon="@Icons.Material.Filled.Security">
            <MudNavLink Href="/departments" Icon="@Icons.Material.Filled.CorporateFare">Departments</MudNavLink>
            <MudNavLink Href="/designations" Icon="@Icons.Material.Filled.WorkOutline">Designations</MudNavLink>
            <MudNavLink Href="/employees" Icon="@Icons.Material.Outlined.Badge">Employees</MudNavLink>
            <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People">Users</MudNavLink>
            <MudNavLink Href="/usertypes" Icon="@Icons.Material.Filled.Badge">User Types</MudNavLink>
            <MudNavLink Href="/roles" Icon="@Icons.Material.Filled.AdminPanelSettings">Roles & Permissions</MudNavLink>
        </MudNavGroup>
        <MudNavLink Href="/workflow-rules" Icon="@Icons.Material.Filled.Rule">Workflow Rules</MudNavLink>
        <MudNavLink Href="/api-settings" Icon="@Icons.Material.Filled.Api">API Settings</MudNavLink>
    </MudNavGroup>
    }

    @if (CanAccessCompliance)
    {
        <!-- 10. COMPLIANCE & AUDIT -->
        <MudNavGroup Title="Compliance" Icon="@Icons.Material.Filled.VerifiedUser" 
                     Expanded="@(_expandedGroup == "Compliance")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Compliance", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/audit-logs" Icon="@Icons.Material.Filled.History">Audit Logs</MudNavLink>
            <MudNavGroup Title="Empost Regulatory" Icon="@Icons.Material.Filled.LocalPostOffice">
                <MudNavLink Href="/empost" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                <MudNavLink Href="/empost/license" Icon="@Icons.Material.Filled.Badge">License Management</MudNavLink>
                <MudNavLink Href="/empost/quarters" Icon="@Icons.Material.Filled.CalendarMonth">Quarterly Periods</MudNavLink>
                <MudNavLink Href="/empost/fee-calculation" Icon="@Icons.Material.Filled.Calculate">Fee Calculation</MudNavLink>
                <MudNavLink Href="/empost/settlements" Icon="@Icons.Material.Filled.Receipt">Settlements</MudNavLink>
                <MudNavLink Href="/empost/return-adjustments" Icon="@Icons.Material.Filled.SwapHoriz">Return Adjustments</MudNavLink>
                <MudNavLink Href="/empost/audit-reports" Icon="@Icons.Material.Filled.Assessment">Audit Reports</MudNavLink>
                <MudNavLink Href="/compliance/empost-fee-report" Icon="@Icons.Material.Filled.Summarize">Fee Report</MudNavLink>
            </MudNavGroup>
        </MudNavGroup>
    }

    @if (HasValidRole)
    {
        <!-- 11. KNOWLEDGE & TOOLS -->
        <MudNavGroup Title="Help" Icon="@Icons.Material.Filled.Help" 
                     Expanded="@(_expandedGroup == "Help")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("Help", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/onboarding" Icon="@Icons.Material.Filled.RocketLaunch">Onboarding</MudNavLink>
            <MudNavLink Href="/operations-workflow" Icon="@Icons.Material.Filled.Route">Operations Workflow</MudNavLink>
            <MudNavLink Href="/net4courier-profile" Icon="@Icons.Material.Filled.BusinessCenter">Net4Courier Profile</MudNavLink>
            <MudNavLink Href="/knowledge-base" Icon="@Icons.Material.Filled.MenuBook">Knowledge Base</MudNavLink>
            <MudNavLink Href="/pickup-workflow" Icon="@Icons.Material.Filled.Route">Pickup Workflow Guide</MudNavLink>
        </MudNavGroup>

        <!-- 12. MY ACCOUNT -->
        <MudNavGroup Title="My Account" Icon="@Icons.Material.Filled.Person" 
                     Expanded="@(_expandedGroup == "MyAccount")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("MyAccount", e))"
                     Class="nav-group-header">
            <MudNavLink Href="/user-profile" Icon="@Icons.Material.Filled.AccountCircle">User Profile</MudNavLink>
        </MudNavGroup>
    }

    @if (_isPlatformAdmin)
    {
        <!-- PLATFORM ADMINISTRATION (Platform Admin Only) -->
        <MudNavGroup Title="Platform Admin" Icon="@Icons.Material.Filled.SupervisorAccount" 
                     Expanded="@(_expandedGroup == "PlatformAdmin")" 
                     ExpandedChanged="@(e => OnGroupExpandedChanged("PlatformAdmin", e))"
                     Class="nav-group-header" Style="background-color: #fff3e0;">
            <MudNavLink Href="/tenant-settings" Icon="@Icons.Material.Filled.Business">Tenant Settings</MudNavLink>
            <MudNavLink Href="/subscription-management" Icon="@Icons.Material.Filled.CardMembership">Subscription Management</MudNavLink>
            <MudNavLink Href="/manage-demo-data" Icon="@Icons.Material.Filled.Science">Manage Demo Data</MudNavLink>
            <MudNavLink Href="/admin/schema-utility" Icon="@Icons.Material.Filled.Storage">Schema Utility</MudNavLink>
            <MudNavLink Href="/admin/branch-reassignment" Icon="@Icons.Material.Filled.SwapHoriz">Branch Reassignment</MudNavLink>
        </MudNavGroup>
    }

</MudNavMenu>

@code {
    private string? _expandedGroup = null;
    private bool _isPlatformAdmin = false;
    private bool _isAdministrator = false;
    private bool _isCourier = false;
    private string? _userRole = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var username = authState.User?.Identity?.Name;
            
            if (!string.IsNullOrEmpty(username))
            {
                _userRole = await AuthService.GetUserRoleByUsernameAsync(username);
                _isPlatformAdmin = _userRole == "PlatformAdmin";
                _isAdministrator = _userRole == "Administrator" || _userRole == "PlatformAdmin";
                _isCourier = _userRole == "Courier";
            }
        }
        catch
        {
            _isPlatformAdmin = false;
            _isAdministrator = false;
            _isCourier = false;
        }
    }

    private bool HasValidRole => !string.IsNullOrEmpty(_userRole);
    private bool CanAccessOperations => HasValidRole && !_isCourier;
    private bool CanAccessCustomers => HasValidRole && !_isCourier;
    private bool CanAccessPricing => _isAdministrator;
    private bool CanAccessFinance => HasValidRole && !_isCourier;
    private bool CanAccessReports => HasValidRole && !_isCourier;
    private bool CanAccessMasters => _isAdministrator;
    private bool CanAccessSettings => _isAdministrator;
    private bool CanAccessCompliance => _isAdministrator;
    private bool CanAccessFavourites => HasValidRole;

    private void OnGroupExpandedChanged(string groupName, bool expanded)
    {
        if (expanded)
        {
            _expandedGroup = groupName;
        }
        else if (_expandedGroup == groupName)
        {
            _expandedGroup = null;
        }
    }
}

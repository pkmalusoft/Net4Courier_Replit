@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Web.Services
@using Net4Courier.Infrastructure.Data
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<MainLayout> Logger
@inject GlobalSearchService SearchService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudText Typo="Typo.h5" Class="ml-3">Net4Courier</MudText>
        <AuthorizeView>
            <Authorized>
                <div class="header-search-container">
                    <MudAutocomplete T="SearchResult"
                                     @ref="_searchField"
                                     Value="_selectedSearchResult"
                                     ValueChanged="OnSearchResultSelected"
                                     SearchFunc="SearchAsync"
                                     Placeholder="Search by AWB, Ref No, Customer, or Invoice..."
                                     Variant="Variant.Text"
                                     Margin="Margin.Dense"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Search"
                                     Class="header-search-field"
                                     Immediate="true"
                                     DebounceInterval="300"
                                     MinCharacters="2"
                                     MaxItems="15"
                                     Dense="true"
                                     ResetValueOnEmptyText="true"
                                     CoerceText="false"
                                     CoerceValue="false"
                                     ToStringFunc="@(r => r?.Title ?? "")">
                        <ItemTemplate Context="searchItem">
                            <div class="d-flex align-center gap-3 py-1">
                                <MudIcon Icon="@GetSearchResultIcon(searchItem)" Size="Size.Small" Color="@GetSearchResultColor(searchItem)" />
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@searchItem.Title</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@searchItem.Subtitle</MudText>
                                </div>
                                @if (!string.IsNullOrEmpty(searchItem.Status))
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@GetSearchStatusChipColor(searchItem.Status)" Style="font-size: 0.65rem;">
                                        @searchItem.Status
                                    </MudChip>
                                }
                            </div>
                        </ItemTemplate>
                        <NoItemsTemplate>
                            <div class="pa-4 text-center">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No results found</MudText>
                            </div>
                        </NoItemsTemplate>
                        <MoreItemsTemplate>
                            <div class="pa-2 text-center">
                                <MudText Typo="Typo.caption" Color="Color.Primary">Type more to refine results...</MudText>
                            </div>
                        </MoreItemsTemplate>
                    </MudAutocomplete>
                </div>
            </Authorized>
        </AuthorizeView>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <div class="d-flex align-center gap-3 mr-4">
                    <div class="header-info">
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                            @_companyName
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Class="mr-1" />
                            @_branchName
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Class="mr-1" />
                            @_financialPeriod
                        </MudChip>
                    </div>
                </div>
                <MudBadge Content="@_notificationCount" Overlap="true" Color="Color.Error" Visible="@(_notificationCount > 0)" Class="mr-2">
                    <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
                </MudBadge>
                <div @onclick="ToggleUserMenu" class="user-menu-trigger">
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Text" Class="user-chip">
                        <MudAvatar Size="Size.Small" Color="Color.Secondary" Class="mr-2">@_userInitial</MudAvatar>
                        @_userName
                        <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
                    </MudChip>
                </div>
                <MudPopover Open="@_userMenuOpen" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="user-dropdown-popover">
                    <MudPaper Elevation="4" Class="pa-2" Style="min-width: 200px;">
                        <MudList T="string" Dense="true" Class="py-0">
                            <MudListItem T="string" Icon="@Icons.Material.Filled.AccountCircle" OnClick="@(() => NavigateFromMenu("/user-profile"))">
                                User Profile
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Business" OnClick="@(() => NavigateFromMenu("/companies"))">
                                Company
                            </MudListItem>
                            <MudListItem T="string" Icon="@Icons.Material.Filled.MenuBook" OnClick="@(() => NavigateFromMenu("/knowledge-base"))">
                                Knowledge Base
                            </MudListItem>
                            <MudDivider Class="my-1" />
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogoutFromMenu">
                                Logout
                            </MudListItem>
                        </MudList>
                    </MudPaper>
                </MudPopover>
            </Authorized>
        </AuthorizeView>
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" Color="Color.Inherit" OnClick="@ToggleDarkMode" />
    </MudAppBar>
    <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2" Class="pt-0">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        <div class="pa-4">
            <Microsoft.AspNetCore.Components.Web.ErrorBoundary @ref="_errorBoundary">
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent Context="exception">
                    <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: 50vh;">
                        <MudPaper Elevation="3" Class="pa-8 text-center" Style="max-width: 500px;">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Class="mb-4" />
                            <MudText Typo="Typo.h5" Color="Color.Error" Class="mb-2">Something went wrong</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @GetUserFriendlyMessage(exception)
                            </MudText>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                                <MudText Typo="Typo.caption">If this problem persists, please contact support.</MudText>
                            </MudAlert>
                            <div class="d-flex gap-2 justify-center">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RecoverFromError">
                                    Try Again
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Home" Href="/">
                                    Go to Dashboard
                                </MudButton>
                            </div>
                        </MudPaper>
                    </MudContainer>
                </ErrorContent>
            </Microsoft.AspNetCore.Components.Web.ErrorBoundary>
        </div>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">X</a>
</div>

<style>
    .header-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .header-chip {
        color: rgba(255,255,255,0.9) !important;
        font-size: 0.75rem;
        height: 28px;
        background: rgba(255,255,255,0.08) !important;
        border: 1px solid rgba(255,255,255,0.12) !important;
    }
    
    .header-chip .mud-icon-root {
        color: rgba(255,255,255,0.7) !important;
    }
    
    .user-chip {
        color: white !important;
        cursor: pointer;
        background: rgba(255,255,255,0.1) !important;
    }
    
    .user-chip:hover {
        background: rgba(255,255,255,0.2) !important;
    }
    
    @@media (max-width: 960px) {
        .header-info {
            display: none;
        }
    }
    
    .mud-drawer-content {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }
    
    .user-menu-dropdown {
        min-width: 180px;
        padding: 8px 0;
    }
    
    .user-menu-item {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        color: inherit;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .user-menu-item:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }
    
    .user-menu-trigger {
        cursor: pointer;
    }

    .header-search-container {
        flex: 1;
        max-width: 380px;
        margin-left: 20px;
    }

    .header-search-field .mud-input-root {
        background: rgba(255, 255, 255, 0.12) !important;
        border-radius: 8px !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        color: white !important;
        transition: all 0.2s ease;
    }

    .header-search-field .mud-input-root:hover {
        background: rgba(255, 255, 255, 0.18) !important;
        border-color: rgba(255, 255, 255, 0.25) !important;
    }

    .header-search-field .mud-input-root:focus-within {
        background: rgba(255, 255, 255, 0.22) !important;
        border-color: rgba(255, 255, 255, 0.4) !important;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1) !important;
    }

    .header-search-field .mud-input-root input {
        color: white !important;
    }

    .header-search-field .mud-input-root input::placeholder {
        color: rgba(255, 255, 255, 0.55) !important;
        opacity: 1 !important;
    }

    .header-search-field .mud-input-adornment-start .mud-icon-root {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    .header-search-field .mud-input-root:focus-within .mud-input-adornment-start .mud-icon-root {
        color: rgba(255, 255, 255, 0.9) !important;
    }

    @@media (max-width: 768px) {
        .header-search-container {
            max-width: 200px;
            margin-left: 12px;
        }
    }

    @@media (max-width: 600px) {
        .header-search-container {
            display: none;
        }
    }
</style>

@code {
    private bool _isDarkMode = false;
    private bool _userMenuOpen = false;
    private string _companyName = "Loading...";
    private string _branchName = "Loading...";
    private string _financialPeriod = "Loading...";
    private string _userName = "";
    private string _userInitial = "U";
    private int _notificationCount = 0;
    private Microsoft.AspNetCore.Components.Web.ErrorBoundary? _errorBoundary;
    private MudAutocomplete<SearchResult>? _searchField;
    private SearchResult? _selectedSearchResult;

    private void RecoverFromError()
    {
        _errorBoundary?.Recover();
    }

    private string GetUserFriendlyMessage(Exception ex)
    {
        var innerEx = ex;
        while (innerEx.InnerException != null) innerEx = innerEx.InnerException;
        var fullMessage = innerEx.Message;
        var allMessages = ex.Message;
        if (ex.InnerException != null) allMessages += " | " + ex.InnerException.Message;
        if (ex.InnerException?.InnerException != null) allMessages += " | " + ex.InnerException.InnerException.Message;
        Logger.LogError(ex, "ErrorBoundary caught exception: {AllMessages}\nInnermost: {Inner}\nStack: {Stack}", 
            allMessages, innerEx.Message, innerEx.StackTrace);
        var message = fullMessage.ToLowerInvariant();
        
        if (message.Contains("42703") || (message.Contains("column") && message.Contains("does not exist")))
        {
            var columnName = ExtractColumnName(fullMessage);
            var tableName = ExtractTableName(allMessages);
            if (!string.IsNullOrEmpty(columnName) && !string.IsNullOrEmpty(tableName))
                return $"Database schema out of sync — column \"{columnName}\" missing on \"{tableName}\". Fix: ALTER TABLE \"{tableName}\" ADD COLUMN IF NOT EXISTS \"{columnName}\" TEXT;";
            if (!string.IsNullOrEmpty(columnName))
                return $"Database schema out of sync — column \"{columnName}\" does not exist. Run Schema Sync from Platform Admin or add the column manually.";
            return $"Database schema out of sync: {fullMessage}. Run Schema Sync from Platform Admin to fix.";
        }
        
        if (message.Contains("42p01") || (message.Contains("relation") && message.Contains("does not exist")))
            return $"Database table missing: {fullMessage}";
        
        if (message.Contains("23502") || message.Contains("violates not-null constraint"))
            return $"Database constraint error: {fullMessage}";
        
        if (message.Contains("connection") || message.Contains("timeout"))
            return $"Connection error: {fullMessage}";
        
        if (message.Contains("unauthorized") || message.Contains("permission"))
            return $"Permission denied: {fullMessage}";
        
        if (ex is InvalidOperationException && message.Contains("sequence"))
            return $"Data loading error: {fullMessage}";

        if (ex is ArgumentNullException or ArgumentException)
            return $"Invalid input: {fullMessage}";

        return $"Error: {fullMessage}";
    }

    private static string ExtractColumnName(string errorMessage)
    {
        var match = System.Text.RegularExpressions.Regex.Match(errorMessage, @"column\s+""?[^""]*""?\s*\.\s*""?([^""\s]+)""?\s+does not exist", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        if (match.Success) return match.Groups[1].Value;
        match = System.Text.RegularExpressions.Regex.Match(errorMessage, @"column\s+""?([^""\s]+)""?\s+does not exist", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        if (match.Success) return match.Groups[1].Value;
        return "";
    }

    private static string ExtractTableName(string errorMessage)
    {
        var match = System.Text.RegularExpressions.Regex.Match(errorMessage, @"FROM\s+(?:""[^""]*""\s*\.\s*)?""([^""]+)""", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        if (match.Success) return match.Groups[1].Value;
        match = System.Text.RegularExpressions.Regex.Match(errorMessage, @"""([A-Z][a-zA-Z]+)""\s+AS\s+""?[a-z]""?", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        if (match.Success) return match.Groups[1].Value;
        return "";
    }

    private MudTheme _theme = new()
    {
        ZIndex = new ZIndex()
        {
            Dialog = 1400,
            Popover = 1500,
            Snackbar = 1600,
            Tooltip = 1700
        },
        PaletteLight = new PaletteLight()
        {
            Primary = "#556ee6",
            Secondary = "#34c38f",
            AppbarBackground = "#1e293b",
            Background = "#f1f5f9",
            Surface = "#ffffff",
            DrawerBackground = "#ffffff"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#556ee6",
            Secondary = "#34c38f",
            AppbarBackground = "#2a3042",
            Background = "#222736",
            Surface = "#2a3042",
            DrawerBackground = "#2a3042"
        },
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadHeaderData();
    }

    private async Task LoadHeaderData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var fullName = user.FindFirst("FullName")?.Value;
                _userName = !string.IsNullOrEmpty(fullName) ? fullName : (user.Identity.Name ?? "User");
                _userInitial = _userName.Length > 0 ? _userName[0].ToString().ToUpper() : "U";
                
                _companyName = user.FindFirst("CompanyName")?.Value ?? "No Company";
                _branchName = user.FindFirst("BranchName")?.Value ?? "No Branch";
                
                await using var dbContext = await DbFactory.CreateDbContextAsync();
                
                var currentPeriod = await dbContext.FinancialPeriods
                    .Where(fp => fp.Status == Net4Courier.Masters.Entities.PeriodStatus.Open && !fp.IsDeleted)
                    .OrderByDescending(fp => fp.StartDate)
                    .FirstOrDefaultAsync();
                
                if (currentPeriod != null)
                {
                    _financialPeriod = currentPeriod.PeriodName ?? $"{currentPeriod.StartDate:MMM yyyy}";
                }
                else
                {
                    _financialPeriod = "No Period";
                }
            }
        }
        catch
        {
            _companyName = "N/A";
            _branchName = "N/A";
            _financialPeriod = "N/A";
        }
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }

    private void NavigateTo(string path)
    {
        NavigationManager.NavigateTo(path);
    }

    private void NavigateToPage(string path)
    {
        NavigationManager.NavigateTo(path, forceLoad: true);
    }

    private void HandleLogout()
    {
        var authProvider = (AppAuthStateProvider)AuthStateProvider;
        authProvider.Logout();
        NavigationManager.NavigateTo("/login", true);
    }

    private void ToggleUserMenu()
    {
        _userMenuOpen = !_userMenuOpen;
    }

    private void NavigateFromMenu(string path)
    {
        _userMenuOpen = false;
        NavigationManager.NavigateTo(path);
    }

    private void HandleLogoutFromMenu()
    {
        _userMenuOpen = false;
        HandleLogout();
    }

    private async Task<IEnumerable<SearchResult>> SearchAsync(string query, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(query) || query.Length < 2)
            return Enumerable.Empty<SearchResult>();
        try
        {
            return await SearchService.SearchAsync(query);
        }
        catch
        {
            return Enumerable.Empty<SearchResult>();
        }
    }

    private void OnSearchResultSelected(SearchResult? result)
    {
        _selectedSearchResult = result;
        if (result != null)
        {
            var url = result.NavigateUrl;
            _selectedSearchResult = null;
            StateHasChanged();
            NavigationManager.NavigateTo(url);
        }
    }

    private string GetSearchResultIcon(SearchResult result) => result.Type switch
    {
        SearchResultType.AWB => Icons.Material.Filled.LocalShipping,
        SearchResultType.Customer => Icons.Material.Filled.Person,
        SearchResultType.Invoice => Icons.Material.Filled.Receipt,
        _ => Icons.Material.Filled.Search
    };

    private Color GetSearchResultColor(SearchResult result) => result.Type switch
    {
        SearchResultType.AWB => Color.Primary,
        SearchResultType.Customer => Color.Success,
        SearchResultType.Invoice => Color.Warning,
        _ => Color.Default
    };

    private Color GetSearchStatusChipColor(string status)
    {
        if (Enum.TryParse<Net4Courier.Kernel.Enums.CourierStatus>(status, out var courierStatus))
        {
            return courierStatus switch
            {
                Net4Courier.Kernel.Enums.CourierStatus.Delivered => Color.Success,
                Net4Courier.Kernel.Enums.CourierStatus.InTransit => Color.Primary,
                Net4Courier.Kernel.Enums.CourierStatus.OutForDelivery => Color.Info,
                Net4Courier.Kernel.Enums.CourierStatus.Pending => Color.Warning,
                Net4Courier.Kernel.Enums.CourierStatus.Returned => Color.Error,
                _ => Color.Default
            };
        }
        return Color.Default;
    }
}

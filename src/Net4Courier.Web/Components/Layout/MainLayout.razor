@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Web.Services
@using Net4Courier.Infrastructure.Data
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<MainLayout> Logger

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudPopoverProvider />
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudText Typo="Typo.h5" Class="ml-3">Net4Courier</MudText>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <div class="d-flex align-center gap-3 mr-4">
                    <div class="awb-search-box d-flex align-center">
                        <MudTextField @bind-Value="_searchAwb" 
                                      Placeholder="Track AWB..." 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      AdornmentColor="Color.Inherit"
                                      OnAdornmentClick="SearchAwb"
                                      OnKeyDown="HandleSearchKeyDown"
                                      Class="awb-search-field"
                                      Style="width: 180px;" />
                    </div>
                    <div class="header-info">
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                            @_companyName
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Small" Class="mr-1" />
                            @_branchName
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Text" Class="header-chip">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" Class="mr-1" />
                            @_financialPeriod
                        </MudChip>
                    </div>
                </div>
                <MudBadge Content="@_notificationCount" Overlap="true" Color="Color.Error" Visible="@(_notificationCount > 0)" Class="mr-2">
                    <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
                </MudBadge>
                <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Text" Class="user-chip">
                            <MudAvatar Size="Size.Small" Color="Color.Secondary" Class="mr-2">@_userInitial</MudAvatar>
                            @_userName
                            <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" />
                        </MudChip>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Icon="@Icons.Material.Filled.AccountCircle" Href="/user-profile">User Profile</MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Business" Href="/companies">Company</MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.MenuBook" Href="/knowledge-base">Knowledge Base</MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="HandleLogout">Logout</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
        </AuthorizeView>
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" Color="Color.Inherit" OnClick="@ToggleDarkMode" />
    </MudAppBar>
    <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2" Class="pt-0">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        <div class="pa-4">
            <Microsoft.AspNetCore.Components.Web.ErrorBoundary @ref="_errorBoundary">
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent Context="exception">
                    <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: 50vh;">
                        <MudPaper Elevation="3" Class="pa-8 text-center" Style="max-width: 500px;">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Class="mb-4" />
                            <MudText Typo="Typo.h5" Color="Color.Error" Class="mb-2">Something went wrong</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                @GetUserFriendlyMessage(exception)
                            </MudText>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                                <MudText Typo="Typo.caption">If this problem persists, please contact support.</MudText>
                            </MudAlert>
                            <div class="d-flex gap-2 justify-center">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" OnClick="RecoverFromError">
                                    Try Again
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Home" Href="/">
                                    Go to Dashboard
                                </MudButton>
                            </div>
                        </MudPaper>
                    </MudContainer>
                </ErrorContent>
            </Microsoft.AspNetCore.Components.Web.ErrorBoundary>
        </div>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">X</a>
</div>

<style>
    .header-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .header-chip {
        color: white !important;
        font-size: 0.75rem;
        height: 28px;
    }
    
    .header-chip .mud-icon-root {
        color: rgba(255,255,255,0.8) !important;
    }
    
    .user-chip {
        color: white !important;
        cursor: pointer;
        background: rgba(255,255,255,0.1) !important;
    }
    
    .user-chip:hover {
        background: rgba(255,255,255,0.2) !important;
    }
    
    .awb-search-box .mud-input-root {
        background: #F9A825 !important;
        border-radius: 20px !important;
    }
    
    .awb-search-box .mud-input {
        color: white !important;
    }
    
    .awb-search-box .mud-input::placeholder {
        color: rgba(255,255,255,0.9) !important;
    }
    
    .awb-search-box .mud-input-outlined-border {
        border-color: #F9A825 !important;
    }
    
    .awb-search-box:hover .mud-input-outlined-border {
        border-color: #FFB300 !important;
    }
    
    .awb-search-box .mud-icon-button {
        color: white !important;
    }
    
    @@media (max-width: 960px) {
        .header-info {
            display: none;
        }
    }
    
    @@media (max-width: 600px) {
        .awb-search-box {
            display: none;
        }
    }
    
    .mud-drawer-content {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }
</style>

@code {
    private bool _isDarkMode = false;
    private string _companyName = "Loading...";
    private string _branchName = "Loading...";
    private string _financialPeriod = "Loading...";
    private string _userName = "";
    private string _userInitial = "U";
    private int _notificationCount = 0;
    private Microsoft.AspNetCore.Components.Web.ErrorBoundary? _errorBoundary;
    private string _searchAwb = "";
    
    private void SearchAwb()
    {
        if (!string.IsNullOrWhiteSpace(_searchAwb))
        {
            NavigationManager.NavigateTo($"/tracking?awb={Uri.EscapeDataString(_searchAwb.Trim())}");
            _searchAwb = "";
        }
    }
    
    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            SearchAwb();
        }
    }

    private void RecoverFromError()
    {
        _errorBoundary?.Recover();
    }

    private string GetUserFriendlyMessage(Exception ex)
    {
        Logger.LogError(ex, "ErrorBoundary caught exception: {Message}", ex.Message);
        var message = ex.Message.ToLowerInvariant();
        
        if (message.Contains("42703") || (message.Contains("column") && message.Contains("does not exist")))
            return "There was an issue with the database configuration. Please contact support.";
        
        if (message.Contains("42p01") || (message.Contains("relation") && message.Contains("does not exist")))
            return "A required database table is missing. Please contact support.";
        
        if (message.Contains("connection") || message.Contains("timeout"))
            return "Unable to connect to the server. Please check your connection and try again.";
        
        if (message.Contains("unauthorized") || message.Contains("permission"))
            return "You don't have permission to access this resource.";
        
        if (ex is InvalidOperationException && message.Contains("sequence"))
            return "There was an issue loading the data. Please try again.";

        if (ex is ArgumentNullException or ArgumentException)
            return "Invalid data was provided. Please check your input and try again.";

        return "An unexpected error occurred. Please try again or contact support.";
    }

    private MudTheme _theme = new()
    {
        Palette = new PaletteLight()
        {
            Primary = "#556ee6",
            Secondary = "#34c38f",
            AppbarBackground = "#556ee6",
            Background = "#f8f8fb",
            Surface = "#ffffff",
            DrawerBackground = "#ffffff"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#556ee6",
            Secondary = "#34c38f",
            AppbarBackground = "#2a3042",
            Background = "#222736",
            Surface = "#2a3042",
            DrawerBackground = "#2a3042"
        },
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadHeaderData();
    }

    private async Task LoadHeaderData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var fullName = user.FindFirst("FullName")?.Value;
                _userName = !string.IsNullOrEmpty(fullName) ? fullName : (user.Identity.Name ?? "User");
                _userInitial = _userName.Length > 0 ? _userName[0].ToString().ToUpper() : "U";
                
                _companyName = user.FindFirst("CompanyName")?.Value ?? "No Company";
                _branchName = user.FindFirst("BranchName")?.Value ?? "No Branch";
                
                await using var dbContext = await DbFactory.CreateDbContextAsync();
                
                var currentPeriod = await dbContext.FinancialPeriods
                    .Where(fp => fp.Status == Net4Courier.Masters.Entities.PeriodStatus.Open && !fp.IsDeleted)
                    .OrderByDescending(fp => fp.StartDate)
                    .FirstOrDefaultAsync();
                
                if (currentPeriod != null)
                {
                    _financialPeriod = currentPeriod.PeriodName ?? $"{currentPeriod.StartDate:MMM yyyy}";
                }
                else
                {
                    _financialPeriod = "No Period";
                }
            }
        }
        catch
        {
            _companyName = "N/A";
            _branchName = "N/A";
            _financialPeriod = "N/A";
        }
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }

    private void HandleLogout()
    {
        var authProvider = (AppAuthStateProvider)AuthStateProvider;
        authProvider.Logout();
        NavigationManager.NavigateTo("/login", true);
    }
}

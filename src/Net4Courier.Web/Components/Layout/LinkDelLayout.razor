@inherits LayoutComponentBase
@implements IDisposable
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Operations.Entities
@using Net4Courier.Kernel.Enums
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IConfiguration Configuration

<HeadContent>
    <link rel="manifest" href="/linkdel/manifest.json" />
    <meta name="theme-color" content="#556ee6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <script src="/js/linkdel-offline.js"></script>
</HeadContent>

<MudThemeProvider Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="linkdel-shell">
    <MudAppBar Elevation="1" Dense="true" Style="background: #556ee6;">
        <MudIcon Icon="@Icons.Material.Filled.DeliveryDining" Size="Size.Medium" Style="color: #fff; margin-right: 8px;" />
        <MudText Typo="Typo.h6" Style="color: #fff; font-weight: 700;">LinkDel</MudText>
        @if (!_isOnline)
        {
            <MudChip T="string" Size="Size.Small" Style="background: rgba(239,68,68,0.9); color: #fff; font-size: 0.6rem; margin-left: 8px;" Icon="@Icons.Material.Filled.CloudOff">
                Offline
            </MudChip>
        }
        @if (_pendingSync > 0)
        {
            <MudChip T="string" Size="Size.Small" Style="background: rgba(245,158,11,0.9); color: #fff; font-size: 0.6rem; margin-left: 4px;">
                @_pendingSync pending
            </MudChip>
        }
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Notifications" Style="color: #fff;" OnClick="RequestNotificationPermission" />
        <MudAvatar Size="Size.Small" Style="background: #34c38f; color: #fff; font-size: 0.75rem; cursor: pointer;">
            @_userInitial
        </MudAvatar>
    </MudAppBar>

    @if (!_isOnline)
    {
        <div class="linkdel-offline-banner">
            <MudIcon Icon="@Icons.Material.Filled.WifiOff" Size="Size.Small" Style="color: #fff;" />
            <span>You're offline. Some features may be limited.</span>
        </div>
    }

    <div class="linkdel-body">
        @Body
    </div>

    <div class="linkdel-bottom-nav">
        <div class="linkdel-nav-item @(IsActive("/linkdel", true) ? "active" : "")" @onclick='() => Navigate("/linkdel")'>
            <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Medium" />
            <span>Home</span>
        </div>
        <div class="linkdel-nav-item @(IsActive("/linkdel/pickups") ? "active" : "")" @onclick='() => Navigate("/linkdel/pickups")'>
            <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Medium" />
            <span>Pickups</span>
        </div>
        <div class="linkdel-nav-item @(IsActive("/linkdel/deliveries") ? "active" : "")" @onclick='() => Navigate("/linkdel/deliveries")'>
            <MudIcon Icon="@Icons.Material.Filled.DeliveryDining" Size="Size.Medium" />
            <span>Deliveries</span>
        </div>
        <div class="linkdel-nav-item @(IsActive("/linkdel/expenses") ? "active" : "")" @onclick='() => Navigate("/linkdel/expenses")'>
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Medium" />
            <span>Expenses</span>
        </div>
        <div class="linkdel-nav-item @(IsActive("/linkdel/more") ? "active" : "")" @onclick='() => Navigate("/linkdel/more")'>
            <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Size="Size.Medium" />
            <span>More</span>
        </div>
    </div>
</div>

<style>
    .linkdel-shell {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        background: #f0f2f5;
        overflow: hidden;
    }

    .linkdel-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: 72px;
        -webkit-overflow-scrolling: touch;
    }

    .linkdel-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: #fff;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
        z-index: 1100;
    }

    .linkdel-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        min-height: 48px;
        padding: 4px 12px;
        cursor: pointer;
        color: #94a3b8;
        font-size: 0.65rem;
        font-weight: 500;
        transition: color 0.2s;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }

    .linkdel-nav-item.active {
        color: #556ee6;
    }

    .linkdel-nav-item span {
        margin-top: 2px;
    }

    .linkdel-offline-banner {
        background: #ef4444;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 6px 16px;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>

@code {
    private string _userInitial = "";
    private string _userName = "";
    private bool _isOnline = true;
    private int _pendingSync;
    private DotNetObjectReference<LinkDelLayout>? _selfRef;

    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#556ee6",
            Secondary = "#34c38f",
            Background = "#f0f2f5",
            Surface = "#ffffff",
            AppbarBackground = "#556ee6"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("linkdel.registerServiceWorker");
        }
        catch { }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/linkdel/login");
            return;
        }

        var role = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;
        if (role != "Courier")
        {
            Navigation.NavigateTo("/linkdel/login");
            return;
        }

        var fullName = user.FindFirst("FullName")?.Value ?? user.Identity?.Name ?? "";
        _userName = fullName;
        _userInitial = string.IsNullOrEmpty(fullName) ? "?" : fullName[..1].ToUpper();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _isOnline = await JS.InvokeAsync<bool>("linkdelOffline.isOnline");

                _selfRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("linkdelOffline.registerConnectivityListeners", _selfRef);

                _pendingSync = await JS.InvokeAsync<int>("linkdelOffline.getOutboxCount");
                StateHasChanged();
            }
            catch { }
        }
    }

    [JSInvokable]
    public async Task OnConnectivityChanged(bool isOnline)
    {
        _isOnline = isOnline;
        if (isOnline)
        {
            Snackbar.Add("Back online - syncing...", Severity.Success);
            await ProcessOutboxQueue();
        }
        else
        {
            Snackbar.Add("You're offline. Changes will sync when connected.", Severity.Warning);
        }
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnSyncRequested()
    {
        await ProcessOutboxQueue();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ProcessOutboxQueue()
    {
        try
        {
            var pendingJson = await JS.InvokeAsync<System.Text.Json.JsonElement[]>("linkdelOffline.getPendingActions");
            if (pendingJson == null || pendingJson.Length == 0)
            {
                _pendingSync = 0;
                return;
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst("UserId")?.Value;
            if (!long.TryParse(userIdClaim, out var userId)) return;
            var courierName = authState.User.FindFirst("FullName")?.Value;

            int synced = 0;
            int failed = 0;

            foreach (var action in pendingJson)
            {
                var id = action.GetProperty("id").GetInt32();
                var actionType = action.TryGetProperty("actionType", out var at) ? at.GetString() ?? "" : "";
                var payload = action.TryGetProperty("payload", out var pl) ? pl : default;

                try
                {
                    var success = await ProcessSingleAction(actionType, payload, userId, courierName);
                    if (success)
                    {
                        await JS.InvokeVoidAsync("linkdelOffline.markActionSynced", id);
                        synced++;
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("linkdelOffline.markActionFailed", id);
                        failed++;
                    }
                }
                catch
                {
                    await JS.InvokeVoidAsync("linkdelOffline.markActionFailed", id);
                    failed++;
                }
            }

            await JS.InvokeVoidAsync("linkdelOffline.clearSyncedActions");
            _pendingSync = await JS.InvokeAsync<int>("linkdelOffline.getOutboxCount");

            if (synced > 0)
                Snackbar.Add($"Synced {synced} offline action{(synced > 1 ? "s" : "")}", Severity.Success);
            if (failed > 0)
                Snackbar.Add($"{failed} action{(failed > 1 ? "s" : "")} failed to sync", Severity.Warning);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[LinkDel] Process outbox error: {ex.Message}");
            _pendingSync = await JS.InvokeAsync<int>("linkdelOffline.getOutboxCount");
        }
    }

    private async Task<bool> ProcessSingleAction(string actionType, System.Text.Json.JsonElement payload, long userId, string? courierName)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        switch (actionType)
        {
            case "accept_pickup":
            {
                var pickupId = payload.GetProperty("pickupId").GetInt64();
                var pickup = await db.PickupRequests.FindAsync(pickupId);
                if (pickup == null || pickup.CourierId != userId)
                    return false;
                if (pickup.Status != PickupStatus.PickupRequest)
                    return false;

                pickup.Status = PickupStatus.AssignedForCollection;
                pickup.AssignedAt = DateTime.UtcNow;
                pickup.ModifiedAt = DateTime.UtcNow;
                await db.SaveChangesAsync();
                return true;
            }
            case "reject_pickup":
            {
                var pickupId = payload.GetProperty("pickupId").GetInt64();
                var pickup = await db.PickupRequests.FindAsync(pickupId);
                if (pickup == null || pickup.CourierId != userId)
                    return false;
                if (pickup.Status != PickupStatus.PickupRequest)
                    return false;

                pickup.CourierId = null;
                pickup.CourierName = null;
                pickup.CourierPhone = null;
                pickup.Remarks = (pickup.Remarks ?? "") + " [Rejected by courier]";
                pickup.ModifiedAt = DateTime.UtcNow;
                await db.SaveChangesAsync();
                return true;
            }
            case "add_expense":
            {
                var drsId = payload.GetProperty("drsId").GetInt64();
                var drs = await db.DRSs.FirstOrDefaultAsync(d => d.Id == drsId && d.DeliveryEmployeeId == (int)userId && !d.IsDeleted);
                if (drs == null)
                    return false;

                var expense = new CourierExpense
                {
                    DRSId = drsId,
                    CourierId = (int)userId,
                    CourierName = courierName,
                    ExpenseDate = DateTime.UtcNow,
                    ExpenseType = (ExpenseType)payload.GetProperty("expenseType").GetInt32(),
                    Amount = payload.GetProperty("amount").GetDecimal(),
                    Description = payload.TryGetProperty("description", out var desc) && desc.ValueKind != System.Text.Json.JsonValueKind.Null ? desc.GetString() : null,
                    Status = ExpenseStatus.Pending,
                    CreatedAt = DateTime.UtcNow,
                    IsDeleted = false
                };
                db.CourierExpenses.Add(expense);
                await db.SaveChangesAsync();
                return true;
            }
            case "submit_cash":
            {
                var drsId = payload.GetProperty("drsId").GetInt64();
                var amount = payload.GetProperty("amount").GetDecimal();

                var dbDrs = await db.DRSs.FirstOrDefaultAsync(d => d.Id == drsId && d.DeliveryEmployeeId == (int)userId && !d.IsDeleted);
                if (dbDrs == null) return false;

                var alreadySubmitted = await db.CourierCashSubmissions
                    .Where(s => s.DRSId == drsId && !s.IsDeleted)
                    .SumAsync(s => s.CashSubmittedAmount);

                var remaining = (dbDrs.CollectedCOD ?? 0) - alreadySubmitted;
                if (amount > remaining) return false;

                var submission = new CourierCashSubmission
                {
                    DRSId = drsId,
                    CourierId = (int)userId,
                    CourierName = courierName,
                    CashSubmittedAmount = amount,
                    SubmissionDate = DateTime.UtcNow,
                    SubmissionTime = DateTime.UtcNow,
                    Remarks = payload.TryGetProperty("remarks", out var rm) && rm.ValueKind != System.Text.Json.JsonValueKind.Null ? rm.GetString() : null,
                    CreatedAt = DateTime.UtcNow,
                    IsDeleted = false
                };
                db.CourierCashSubmissions.Add(submission);
                await db.SaveChangesAsync();
                return true;
            }
            default:
                Console.WriteLine($"[LinkDel] Unknown sync action type: {actionType}");
                return false;
        }
    }

    private async Task RequestNotificationPermission()
    {
        try
        {
            var result = await JS.InvokeAsync<string>("linkdel.requestNotificationPermission");
            if (result == "granted")
            {
                var vapidKey = Configuration["Vapid:PublicKey"];
                if (!string.IsNullOrEmpty(vapidKey))
                {
                    var subscription = await JS.InvokeAsync<string?>("linkdel.subscribePush", vapidKey);
                    if (subscription != null)
                    {
                        Snackbar.Add("Notifications enabled", Severity.Success);
                    }
                    else
                    {
                        Snackbar.Add("Notification permission granted", Severity.Info);
                    }
                }
                else
                {
                    Snackbar.Add("Notification permission granted", Severity.Info);
                }
            }
            else if (result == "denied")
            {
                Snackbar.Add("Notification permission denied", Severity.Warning);
            }
            else
            {
                Snackbar.Add("Notification permission requested", Severity.Info);
            }
        }
        catch
        {
            Snackbar.Add("Notifications not supported on this device", Severity.Warning);
        }
    }

    private bool IsActive(string path, bool exact = false)
    {
        var uri = new Uri(Navigation.Uri);
        var current = uri.AbsolutePath.TrimEnd('/');
        var target = path.TrimEnd('/');
        return exact ? current == target : current.StartsWith(target);
    }

    private void Navigate(string path)
    {
        Navigation.NavigateTo(path);
    }

    public void Dispose()
    {
        try
        {
            _ = JS.InvokeVoidAsync("linkdelOffline.removeConnectivityListeners");
        }
        catch { }
        _selfRef?.Dispose();
    }
}

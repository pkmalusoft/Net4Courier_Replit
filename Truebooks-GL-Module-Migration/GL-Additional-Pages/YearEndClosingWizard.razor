@page "/gl/year-end-closing"



@inject PlatformServices.IYearEndService YearEndService
@inject PlatformServices.IFinancialPeriodService FinancialPeriodService
@inject LegacyServices.IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Year-End Closing</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.h4">Year-End Closing Wizard</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Complete the year-end closing process to finalize the fiscal year and prepare opening balances.
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex justify-end align-center">
                <MudButton Variant="Variant.Outlined" Href="/gl/financial-periods">
                    Back to Periods
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (closing == null)
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Select Year-End Period</MudText>
            @if (yearEndPeriods.Any())
            {
                <MudSelect T="PlatformFinanceDTOs.FinancialPeriodDto" @bind-Value="selectedPeriod" Label="Year-End Period" 
                           ToStringFunc="@(p => p == null ? "" : $"FY{p.FiscalYear} - {p.PeriodName}")"
                           Variant="Variant.Outlined" Class="mb-4">
                    @foreach (var period in yearEndPeriods)
                    {
                        <MudSelectItem Value="@period">FY@period.FiscalYear - @period.PeriodName</MudSelectItem>
                    }
                </MudSelect>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           Disabled="@(selectedPeriod == null)" OnClick="StartClosing">
                    Start Year-End Closing
                </MudButton>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    No year-end periods are available for closing. Please ensure you have created financial periods with the Year-End flag enabled.
                </MudAlert>
                <MudButton Variant="Variant.Outlined" Href="/gl/financial-periods">
                    Go to Financial Periods
                </MudButton>
            }
        </MudPaper>
    }
    else if (closing != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h6" Class="mb-2">Closing: @closing.ClosingNumber</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">FY@closing.FiscalYear - @closing.PeriodName</MudText>
            <MudDivider Class="my-3" />
            
            <MudGrid>
                @foreach (var step in GetSteps())
                {
                    <MudItem xs="12" sm="6" md="2">
                        <MudCard Outlined="true" Style="@GetStepStyle(step.StepNumber)">
                            <MudCardContent Class="pa-2 text-center">
                                <MudIcon Icon="@step.Icon" Size="Size.Medium" Color="@GetStepColor(step.StepNumber)" />
                                <MudText Typo="Typo.caption">@step.Title</MudText>
                                @if (step.StepNumber < currentStep)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>

        @switch (closing.Status)
        {
            case PlatformFinanceDTOs.YearEndClosingStatus.Draft:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Stage 1: Validation</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Verify all prerequisites before closing the fiscal year.
                    </MudText>
                    
                    @if (validationResult != null)
                    {
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@(validationResult.RetainedEarningsConfigured ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" 
                                         IconColor="@(validationResult.RetainedEarningsConfigured ? Color.Success : Color.Error)">
                                Retained Earnings account @(validationResult.RetainedEarningsConfigured ? "configured" : "not configured")
                            </MudListItem>
                            <MudListItem Icon="@(validationResult.ARControlConfigured ? Icons.Material.Filled.Check : Icons.Material.Filled.Warning)" 
                                         IconColor="@(validationResult.ARControlConfigured ? Color.Success : Color.Warning)">
                                AR Control account @(validationResult.ARControlConfigured ? "configured" : "not configured")
                            </MudListItem>
                            <MudListItem Icon="@(validationResult.UnpostedJournals == 0 ? Icons.Material.Filled.Check : Icons.Material.Filled.Warning)" 
                                         IconColor="@(validationResult.UnpostedJournals == 0 ? Color.Success : Color.Error)">
                                @validationResult.UnpostedJournals unposted journal entries
                            </MudListItem>
                        </MudList>

                        <MudDivider Class="my-4" />
                        <MudGrid>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #e8f5e9;">
                                    <MudText Typo="Typo.caption">Total Revenue</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">@validationResult.TotalRevenue.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #ffebee;">
                                    <MudText Typo="Typo.caption">Total Expense</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Error">@validationResult.TotalExpense.ToString("C2")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #e3f2fd;">
                                    <MudText Typo="Typo.caption">Net Income/Loss</MudText>
                                    <MudText Typo="Typo.h6" Color="@(validationResult.NetIncomeOrLoss >= 0 ? Color.Success : Color.Error)">
                                        @validationResult.NetIncomeOrLoss.ToString("C2")
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>

                        @if (validationResult.Errors.Any())
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-4">
                                @foreach (var error in validationResult.Errors)
                                {
                                    <MudText Typo="Typo.body2">- @error</MudText>
                                }
                            </MudAlert>
                        }
                    }

                    <MudDivider Class="my-4" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RunValidation" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Run Validation
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.Validated:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Stage 2: Close Income & Expense Accounts</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Create a journal entry to transfer all revenue and expense account balances to Retained Earnings.
                    </MudText>
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Net Income/Loss of <strong>@closing.NetIncomeOrLoss.ToString("C2")</strong> will be transferred to Retained Earnings.
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Stage2_CloseIncomeExpense" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Close Income/Expense
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.IncomeExpenseClosed:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Stage 3: Snapshot Customer & Supplier Balances</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Record opening balances for all customers and suppliers.
                    </MudText>
                    <MudGrid Class="mb-4">
                        <MudItem xs="6">
                            <MudPaper Class="pa-3" Elevation="0" Style="background-color: #e3f2fd;">
                                <MudText Typo="Typo.caption">AR Subledger</MudText>
                                <MudText Typo="Typo.h6">@closing.ARSubledgerBalance.ToString("C2")</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="6">
                            <MudPaper Class="pa-3" Elevation="0" Style="background-color: #fff3e0;">
                                <MudText Typo="Typo.caption">AP Subledger</MudText>
                                <MudText Typo="Typo.h6">@closing.APSubledgerBalance.ToString("C2")</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Stage3_SnapshotSubledgers" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Snapshot Subledgers
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.SubledgersSnapshotted:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Stage 4: Snapshot Inventory Balances</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Record opening inventory quantities and values.
                    </MudText>
                    <MudPaper Class="pa-3 mb-4" Elevation="0" Style="background-color: #e8f5e9;">
                        <MudText Typo="Typo.caption">Inventory Subledger</MudText>
                        <MudText Typo="Typo.h6">@closing.InventorySubledgerBalance.ToString("C2")</MudText>
                    </MudPaper>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Stage4_SnapshotInventory" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Snapshot Inventory
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.InventorySnapshotted:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Stage 5: Generate Opening Journal Entry</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Create the opening balance journal entry for the new fiscal year.
                    </MudText>
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        This will create a posted journal entry with opening balances for all Asset, Liability, and Equity accounts.
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Stage5_GenerateOpeningJE" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Generate Opening JE
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.OpeningJEGenerated:
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Complete Year-End Closing</MudText>
                    <MudText Typo="Typo.body1" Class="mb-4">
                        All stages are complete. Finalize the year-end closing process.
                    </MudText>
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        <strong>Warning:</strong> Once completed, the period will be hard closed and no further changes can be made.
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="CompleteClosing" Disabled="processing">
                        @if (processing) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                        Complete Closing
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.Completed:
                <MudPaper Class="pa-4">
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        <MudText Typo="Typo.h6">Year-End Closing Completed!</MudText>
                        <MudText Typo="Typo.body1">
                            The fiscal year has been successfully closed on @closing.ClosingDate?.ToString("MMM dd, yyyy HH:mm").
                        </MudText>
                    </MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/gl/financial-periods">
                        Return to Financial Periods
                    </MudButton>
                </MudPaper>
                break;

            case PlatformFinanceDTOs.YearEndClosingStatus.RolledBack:
                <MudAlert Severity="Severity.Error">
                    This closing has been rolled back.
                </MudAlert>
                break;
        }

        @if (closing.Status != PlatformFinanceDTOs.YearEndClosingStatus.Completed && closing.Status != PlatformFinanceDTOs.YearEndClosingStatus.RolledBack)
        {
            <MudPaper Class="pa-4 mt-4">
                <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="ShowRollbackDialog">
                    Rollback Closing
                </MudButton>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? PeriodId { get; set; }

    private bool loading = true;
    private bool processing = false;
    private List<PlatformFinanceDTOs.FinancialPeriodDto> yearEndPeriods = new();
    private PlatformFinanceDTOs.FinancialPeriodDto? selectedPeriod;
    private PlatformFinanceDTOs.YearEndClosingDto? closing;
    private ValidationResult? validationResult;
    private int currentStep => GetCurrentStep();

    private Guid GetTenantId() => Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var tenantId = GetTenantId();
            var allPeriods = await FinancialPeriodService.GetAllAsync(tenantId);
            yearEndPeriods = allPeriods.Where(p => p.IsYearEnd).ToList();

            if (!string.IsNullOrEmpty(PeriodId) && Guid.TryParse(PeriodId, out var periodId))
            {
                selectedPeriod = yearEndPeriods.FirstOrDefault(p => p.Id == periodId);
                if (selectedPeriod != null)
                {
                    await LoadExistingClosing(periodId);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadExistingClosing(Guid periodId)
    {
        var tenantId = GetTenantId();
        var closings = await YearEndService.GetAllClosingsAsync(tenantId);
        closing = closings.FirstOrDefault(c => c.FinancialPeriodId == periodId && c.Status != PlatformFinanceDTOs.YearEndClosingStatus.RolledBack);
    }

    private async Task StartClosing()
    {
        if (selectedPeriod == null) return;

        processing = true;
        try
        {
            var tenantId = GetTenantId();
            closing = await YearEndService.StartClosingAsync(tenantId, selectedPeriod.Id);
            if (closing != null)
            {
                Snackbar.Add("Year-end closing initiated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to start closing", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start closing: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }

    private async Task RunValidation()
    {
        if (closing == null) return;

        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var result = await YearEndService.ValidateAsync(tenantId, closing.Id);
            validationResult = new ValidationResult
            {
                IsValid = result.IsValid,
                RetainedEarningsConfigured = result.RetainedEarningsConfigured,
                ARControlConfigured = result.ARControlConfigured,
                UnpostedJournals = result.UnpostedJournals,
                TotalRevenue = result.TotalRevenue,
                TotalExpense = result.TotalExpense,
                NetIncomeOrLoss = result.NetIncomeOrLoss,
                Errors = result.Errors
            };
            await RefreshClosing();
            
            if (validationResult.IsValid)
            {
                Snackbar.Add("Validation passed!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Validation completed with issues", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Validation failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }

    private async Task Stage2_CloseIncomeExpense()
    {
        if (closing == null) return;
        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await YearEndService.CloseIncomeExpenseAsync(tenantId, closing.Id);
            if (success)
            {
                await RefreshClosing();
                Snackbar.Add("Income/Expense accounts closed", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to close Income/Expense accounts", Severity.Error);
            }
        }
        finally
        {
            processing = false;
        }
    }

    private async Task Stage3_SnapshotSubledgers()
    {
        if (closing == null) return;
        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await YearEndService.SnapshotSubledgersAsync(tenantId, closing.Id);
            if (success)
            {
                await RefreshClosing();
                Snackbar.Add("Subledgers snapshotted", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to snapshot subledgers", Severity.Error);
            }
        }
        finally
        {
            processing = false;
        }
    }

    private async Task Stage4_SnapshotInventory()
    {
        if (closing == null) return;
        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await YearEndService.SnapshotInventoryAsync(tenantId, closing.Id);
            if (success)
            {
                await RefreshClosing();
                Snackbar.Add("Inventory snapshotted", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to snapshot inventory", Severity.Error);
            }
        }
        finally
        {
            processing = false;
        }
    }

    private async Task Stage5_GenerateOpeningJE()
    {
        if (closing == null) return;
        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await YearEndService.GenerateOpeningJEAsync(tenantId, closing.Id);
            if (success)
            {
                await RefreshClosing();
                Snackbar.Add("Opening JE generated", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to generate Opening JE", Severity.Error);
            }
        }
        finally
        {
            processing = false;
        }
    }

    private async Task CompleteClosing()
    {
        if (closing == null) return;

        processing = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await YearEndService.CompleteClosingAsync(tenantId, closing.Id);
            if (success)
            {
                await RefreshClosing();
                Snackbar.Add("Year-end closing completed!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to complete closing", Severity.Error);
            }
        }
        finally
        {
            processing = false;
        }
    }

    private async Task ShowRollbackDialog()
    {
        var result = await DialogService.ShowMessageBox(
            "Rollback Year-End Closing",
            "Are you sure you want to rollback? All journal entries and snapshots will be voided.",
            yesText: "Yes, Rollback", cancelText: "Cancel");

        if (result == true && closing != null)
        {
            processing = true;
            try
            {
                var tenantId = GetTenantId();
                var success = await YearEndService.RollbackClosingAsync(tenantId, closing.Id, "User requested rollback");
                if (success)
                {
                    Snackbar.Add("Closing rolled back", Severity.Success);
                    Navigation.NavigateTo("/gl/financial-periods");
                }
                else
                {
                    Snackbar.Add("Rollback failed", Severity.Error);
                }
            }
            finally
            {
                processing = false;
            }
        }
    }

    private async Task RefreshClosing()
    {
        if (closing == null) return;
        
        var tenantId = GetTenantId();
        closing = await YearEndService.GetClosingByIdAsync(tenantId, closing.Id);
    }

    private int GetCurrentStep()
    {
        return closing?.Status switch
        {
            PlatformFinanceDTOs.YearEndClosingStatus.Draft => 1,
            PlatformFinanceDTOs.YearEndClosingStatus.Validated => 2,
            PlatformFinanceDTOs.YearEndClosingStatus.IncomeExpenseClosed => 3,
            PlatformFinanceDTOs.YearEndClosingStatus.SubledgersSnapshotted => 4,
            PlatformFinanceDTOs.YearEndClosingStatus.InventorySnapshotted => 5,
            PlatformFinanceDTOs.YearEndClosingStatus.OpeningJEGenerated => 6,
            PlatformFinanceDTOs.YearEndClosingStatus.Completed => 7,
            _ => 1
        };
    }

    private List<(int StepNumber, string Title, string Icon)> GetSteps()
    {
        return new List<(int, string, string)>
        {
            (1, "Validate", Icons.Material.Filled.CheckCircle),
            (2, "Close I/E", Icons.Material.Filled.AccountBalance),
            (3, "Subledgers", Icons.Material.Filled.People),
            (4, "Inventory", Icons.Material.Filled.Inventory),
            (5, "Opening JE", Icons.Material.Filled.NoteAdd),
            (6, "Complete", Icons.Material.Filled.Done)
        };
    }

    private Color GetStepColor(int stepNumber)
    {
        if (stepNumber < currentStep) return Color.Success;
        if (stepNumber == currentStep) return Color.Primary;
        return Color.Default;
    }

    private string GetStepStyle(int stepNumber)
    {
        if (stepNumber < currentStep) return "border-color: var(--mud-palette-success);";
        if (stepNumber == currentStep) return "border-color: var(--mud-palette-primary); border-width: 2px;";
        return "";
    }

    public class ValidationResult
    {
        public bool IsValid { get; set; }
        public List<string> Errors { get; set; } = new();
        public List<string> Warnings { get; set; } = new();
        public bool ARControlConfigured { get; set; }
        public bool APControlConfigured { get; set; }
        public bool InventoryControlConfigured { get; set; }
        public bool RetainedEarningsConfigured { get; set; }
        public decimal TotalRevenue { get; set; }
        public decimal TotalExpense { get; set; }
        public decimal NetIncomeOrLoss { get; set; }
        public int UnpostedJournals { get; set; }
        public int DraftDocuments { get; set; }
    }
}

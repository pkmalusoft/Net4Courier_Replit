@page "/finance/deferred-revenue"

@inject PlatformServices.IDeferredRevenueService DeferredRevenueService
@inject LegacyServices.IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Deferred Revenue Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Deferred Revenue Dashboard</MudText>

    @if (loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Deferred Revenue</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@summary.TotalDeferredRevenue.ToString("C")</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Recognized This Month</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Success">@summary.RecognizedThisMonth.ToString("C")</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Pending Recognition</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Warning">@summary.PendingRecognition.ToString("C")</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Active Schedules</MudText>
                    <MudText Typo="Typo.h5">@summary.ActiveSchedules</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6">Revenue Recognition Schedules</MudText>
                        <MudStack Row="true" Spacing="2">
                            <MudSelect T="string" @bind-Value="statusFilter" 
                                       Label="Status" 
                                       Variant="Variant.Outlined"
                                       Dense="true"
                                       Style="width: 150px;"
                                       AnchorOrigin="Origin.BottomCenter"
                                       TransformOrigin="Origin.TopCenter">
                                <MudSelectItem Value="@("")">All</MudSelectItem>
                                <MudSelectItem Value="@("Active")">Active</MudSelectItem>
                                <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                                <MudSelectItem Value="@("Cancelled")">Cancelled</MudSelectItem>
                            </MudSelect>
                            <MudButton Variant="Variant.Outlined" OnClick="LoadData">Refresh</MudButton>
                        </MudStack>
                    </MudStack>

                    <MudDataGrid T="PlatformFinanceDTOs.RevenueScheduleDto" Items="filteredSchedules" Striped="true" Hover="true" Dense="true">
                        <Columns>
                            <PropertyColumn Property="x => x.SourceDocumentNumber" Title="Document #" />
                            <PropertyColumn Property="x => x.CustomerName" Title="Customer" />
                            <TemplateColumn Title="Total Amount">
                                <CellTemplate>
                                    @context.Item.TotalAmount.ToString("C")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Recognized">
                                <CellTemplate>
                                    @context.Item.RecognizedAmount.ToString("C")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Remaining">
                                <CellTemplate>
                                    @context.Item.RemainingAmount.ToString("C")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Period">
                                <CellTemplate>
                                    @context.Item.ServiceStartDate.ToString("MMM yyyy") - @context.Item.ServiceEndDate.ToString("MMM yyyy")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Progress">
                                <CellTemplate>
                                    <MudProgressLinear Value="@GetProgressPercentage(context.Item)" 
                                                       Color="Color.Primary" 
                                                       Style="width: 100px;" />
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Status">
                                <CellTemplate>
                                    <MudChip T="string" Size="MudBlazor.Size.Small" 
                                             Color="@GetStatusColor(context.Item.Status)">
                                        @context.Item.Status
                                    </MudChip>
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Actions">
                                <CellTemplate>
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                  Size="MudBlazor.Size.Small"
                                                  aria-label="View schedule details"
                                                  OnClick="@(() => ViewScheduleDetails(context.Item.Id))" />
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudPaper>
            </MudItem>

            @if (upcomingRecognitions.Any())
            {
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Upcoming Recognitions (Next 30 Days)</MudText>
                        <MudSimpleTable Dense="true" Hover="true">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in upcomingRecognitions)
                                {
                                    <tr>
                                        <td>@item.SourceDocumentNumber</td>
                                        <td>@item.CustomerName</td>
                                        <td>@item.Amount.ToString("C")</td>
                                        <td>@item.RecognitionDate.ToString("MMM dd")</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    </MudPaper>
                </MudItem>
            }

            @if (pendingAlerts.Any())
            {
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-3">Pending Alerts</MudText>
                        <MudList T="PlatformFinanceDTOs.DeferredRevenueAlertDto" Dense="true">
                            @foreach (var alert in pendingAlerts)
                            {
                                <MudListItem T="PlatformFinanceDTOs.DeferredRevenueAlertDto" Icon="@GetAlertIcon(alert.AlertType)">
                                    <MudText>@alert.Message</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Due: @alert.DueDate.ToString("MMM dd, yyyy")</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<MudDialog @bind-Visible="isDetailsDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Schedule Details - @selectedSchedule?.SourceDocumentNumber</MudText>
    </TitleContent>
    <DialogContent>
        @if (selectedSchedule != null)
        {
            <MudGrid Class="mb-4">
                <MudItem xs="6">
                    <MudText Typo="Typo.caption">Customer</MudText>
                    <MudText>@selectedSchedule.CustomerName</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.caption">Status</MudText>
                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetStatusColor(selectedSchedule.Status)">@selectedSchedule.Status</MudChip>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption">Total Amount</MudText>
                    <MudText>@selectedSchedule.TotalAmount.ToString("C")</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption">Recognized</MudText>
                    <MudText Color="Color.Success">@selectedSchedule.RecognizedAmount.ToString("C")</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption">Remaining</MudText>
                    <MudText Color="Color.Warning">@selectedSchedule.RemainingAmount.ToString("C")</MudText>
                </MudItem>
            </MudGrid>
            
            <MudText Typo="Typo.subtitle2" Class="mb-2">Recognition Schedule</MudText>
            <MudTable Items="scheduleLines" Dense="true">
                <HeaderContent>
                    <MudTh>Period</MudTh>
                    <MudTh>Amount</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Posted Date</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.PeriodStartDate.ToString("MMM yyyy")</MudTd>
                    <MudTd>@context.Amount.ToString("C")</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetLineStatusColor(context.Status)">@context.Status</MudChip>
                    </MudTd>
                    <MudTd>@(context.PostedDate?.ToString("MMM dd, yyyy") ?? "-")</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => isDetailsDialogVisible = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool loading = true;
    private PlatformFinanceDTOs.DeferredRevenueDashboardDto summary = new(0, 0, 0, 0, 0);
    private List<PlatformFinanceDTOs.RevenueScheduleDto> schedules = new();
    private List<PlatformFinanceDTOs.DeferredRevenueAlertDto> pendingAlerts = new();
    private List<UpcomingRecognitionDto> upcomingRecognitions = new();
    private string statusFilter = "";
    private Guid tenantId = Guid.Empty;
    
    private bool isDetailsDialogVisible = false;
    private PlatformFinanceDTOs.RevenueScheduleDto? selectedSchedule;
    private List<PlatformFinanceDTOs.DeferredRevenueRecognitionLineDto> scheduleLines = new();

    private IEnumerable<PlatformFinanceDTOs.RevenueScheduleDto> filteredSchedules => 
        string.IsNullOrEmpty(statusFilter) 
            ? schedules 
            : schedules.Where(s => s.Status == statusFilter);

    protected override async Task OnInitializedAsync()
    {
        tenantId = Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            var summaryTask = DeferredRevenueService.GetDashboardAsync(tenantId);
            var schedulesTask = DeferredRevenueService.GetSchedulesAsync(tenantId);
            var alertsTask = DeferredRevenueService.GetPendingAlertsAsync(tenantId);

            await Task.WhenAll(summaryTask, schedulesTask, alertsTask);

            summary = await summaryTask;
            schedules = (await schedulesTask)?.ToList() ?? new();
            pendingAlerts = (await alertsTask)?.ToList() ?? new();

            upcomingRecognitions = schedules
                .Where(s => s.Status == "Active")
                .Select(s => new UpcomingRecognitionDto
                {
                    SourceDocumentNumber = s.SourceDocumentNumber,
                    CustomerName = s.CustomerName ?? "",
                    Amount = s.RemainingAmount / Math.Max(1, GetRemainingMonths(s)),
                    RecognitionDate = GetNextRecognitionDate(s)
                })
                .Where(u => u.RecognitionDate <= DateTime.Today.AddDays(30))
                .OrderBy(u => u.RecognitionDate)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task ViewScheduleDetails(Guid id)
    {
        try
        {
            selectedSchedule = schedules.FirstOrDefault(s => s.Id == id);
            if (selectedSchedule != null)
            {
                var lines = await DeferredRevenueService.GetScheduleLinesAsync(tenantId, id);
                scheduleLines = lines?.Select(l => new PlatformFinanceDTOs.DeferredRevenueRecognitionLineDto(
                    l.RecognitionDate,
                    l.Amount,
                    l.Status,
                    l.ProcessedDate
                )).ToList() ?? new();
                isDetailsDialogVisible = true;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading details: {ex.Message}", Severity.Error);
        }
    }

    private double GetProgressPercentage(PlatformFinanceDTOs.RevenueScheduleDto schedule)
    {
        if (schedule.TotalAmount == 0) return 0;
        return (double)(schedule.RecognizedAmount / schedule.TotalAmount) * 100;
    }

    private int GetRemainingMonths(PlatformFinanceDTOs.RevenueScheduleDto schedule)
    {
        var today = DateTime.Today;
        if (schedule.ServiceEndDate <= today) return 0;
        var start = schedule.ServiceStartDate > today ? schedule.ServiceStartDate : today;
        return ((schedule.ServiceEndDate.Year - start.Year) * 12) + schedule.ServiceEndDate.Month - start.Month + 1;
    }

    private DateTime GetNextRecognitionDate(PlatformFinanceDTOs.RevenueScheduleDto schedule)
    {
        var today = DateTime.Today;
        var firstOfNextMonth = new DateTime(today.Year, today.Month, 1).AddMonths(1);
        return firstOfNextMonth > schedule.ServiceEndDate ? schedule.ServiceEndDate : firstOfNextMonth;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Completed" => Color.Info,
        "Cancelled" => Color.Error,
        _ => Color.Default
    };

    private Color GetLineStatusColor(string status) => status switch
    {
        "Pending" => Color.Warning,
        "Posted" => Color.Success,
        "Skipped" => Color.Default,
        _ => Color.Default
    };

    private string GetAlertIcon(string alertType) => alertType switch
    {
        "PeriodEnding" => Icons.Material.Filled.Event,
        "RecognitionDue" => Icons.Material.Filled.Schedule,
        "VarianceDetected" => Icons.Material.Filled.Warning,
        _ => Icons.Material.Filled.Info
    };

    private class UpcomingRecognitionDto
    {
        public string SourceDocumentNumber { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public decimal Amount { get; set; }
        public DateTime RecognitionDate { get; set; }
    }
}

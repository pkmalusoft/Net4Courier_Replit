@page "/gl/opening-balances"

@inject PlatformServices.IOpeningBalanceService BalanceService
@inject LegacyServices.IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6">
        <MudText Typo="Typo.h4">Opening Balances</MudText>
    </MudItem>
    <MudItem xs="12" sm="6" Class="d-flex justify-end gap-2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateNewBatch">
            New Batch
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Lock" OnClick="CloseOpeningBalances" Disabled="@(!HasPostedBatches)">
            Close to Retained Earnings
        </MudButton>
    </MudItem>
</MudGrid>

@if (isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}

<MudPaper Class="pa-4" Elevation="2">
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="3">
            <MudSelect @bind-Value="filterModule" Label="Source Module" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem Value="@("")">All Modules</MudSelectItem>
                <MudSelectItem Value="@("GL")">General Ledger</MudSelectItem>
                <MudSelectItem Value="@("AR")">Accounts Receivable</MudSelectItem>
                <MudSelectItem Value="@("AP")">Accounts Payable</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudSelect @bind-Value="filterStatus" Label="Status" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem Value="@("")">All Statuses</MudSelectItem>
                <MudSelectItem Value="@("Draft")">Draft</MudSelectItem>
                <MudSelectItem Value="@("Submitted")">Submitted</MudSelectItem>
                <MudSelectItem Value="@("Posted")">Posted</MudSelectItem>
                <MudSelectItem Value="@("Closed")">Closed</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudNumericField @bind-Value="filterFiscalYear" Label="Fiscal Year" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadBatches">
                Search
            </MudButton>
        </MudItem>
    </MudGrid>

    <MudTable Items="@batches" Dense="true" Hover="true" Bordered="true" Loading="@isLoading">
        <HeaderContent>
            <MudTh>Batch #</MudTh>
            <MudTh>Module</MudTh>
            <MudTh>Effective Date</MudTh>
            <MudTh>Fiscal Year</MudTh>
            <MudTh>Lines</MudTh>
            <MudTh Style="text-align: right;">Total Debit</MudTh>
            <MudTh Style="text-align: right;">Total Credit</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Batch #">@context.BatchNumber</MudTd>
            <MudTd DataLabel="Module">
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetModuleColor(context.SourceModule)">@context.SourceModule</MudChip>
            </MudTd>
            <MudTd DataLabel="Effective Date">@context.EffectiveDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd DataLabel="Fiscal Year">@context.FiscalYear</MudTd>
            <MudTd DataLabel="Lines">@context.LineCount</MudTd>
            <MudTd DataLabel="Total Debit" Style="text-align: right;">@context.TotalDebit.ToString("N2")</MudTd>
            <MudTd DataLabel="Total Credit" Style="text-align: right;">@context.TotalCredit.ToString("N2")</MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudButtonGroup Size="MudBlazor.Size.Small">
                    @if (context.Status == "Draft")
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="MudBlazor.Size.Small" OnClick="@(() => EditBatch(context.Id))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="MudBlazor.Size.Small" Color="Color.Error" OnClick="@(() => DeleteBatch(context))" />
                    }
                    else
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="MudBlazor.Size.Small" OnClick="@(() => ViewBatch(context.Id))" />
                    }
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No opening balance batches found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

<MudDialog @bind-Visible="showNewBatchDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Create New Opening Balance Batch</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudSelect @bind-Value="newBatchModule" Label="Source Module" Variant="Variant.Outlined" Required="true">
                    <MudSelectItem Value="@("GL")">General Ledger (GL Accounts)</MudSelectItem>
                    <MudSelectItem Value="@("AR")">Accounts Receivable (Customer Balances)</MudSelectItem>
                    <MudSelectItem Value="@("AP")">Accounts Payable (Supplier Balances)</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudDatePicker @bind-Date="newBatchDate" Label="Effective Date" Required="true" />
            </MudItem>
            <MudItem xs="12">
                <MudNumericField @bind-Value="newBatchFiscalYear" Label="Fiscal Year" Required="true" />
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="newBatchNotes" Label="Notes" Lines="3" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showNewBatchDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveNewBatch">Create</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<PlatformFinanceDTOs.OpeningBalanceBatchDto> batches = new();
    private bool isLoading = true;
    private string filterModule = "";
    private string filterStatus = "";
    private int? filterFiscalYear;
    private Guid tenantId = Guid.Empty;
    
    private bool showNewBatchDialog = false;
    private string newBatchModule = "GL";
    private DateTime? newBatchDate;
    private int newBatchFiscalYear = DateTime.Now.Year;
    private string? newBatchNotes;
    
    private bool HasPostedBatches => batches.Any(b => b.Status == "Posted");

    protected override async Task OnInitializedAsync()
    {
        tenantId = Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;
        filterFiscalYear = DateTime.Now.Year;
        await LoadBatches();
    }

    private async Task LoadBatches()
    {
        isLoading = true;
        try
        {
            var result = await BalanceService.GetBatchesAsync(
                tenantId, 
                filterFiscalYear, 
                string.IsNullOrEmpty(filterModule) ? null : filterModule,
                string.IsNullOrEmpty(filterStatus) ? null : filterStatus
            );
            batches = result?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading batches: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CreateNewBatch()
    {
        newBatchModule = "GL";
        newBatchDate = DateTime.Today;
        newBatchFiscalYear = DateTime.Now.Year;
        newBatchNotes = null;
        showNewBatchDialog = true;
    }

    private async Task SaveNewBatch()
    {
        if (!newBatchDate.HasValue)
        {
            Snackbar.Add("Please select an effective date.", Severity.Warning);
            return;
        }

        try
        {
            var request = new PlatformFinanceDTOs.CreateOpeningBalanceBatchRequest(
                newBatchModule,
                newBatchDate.Value,
                newBatchFiscalYear,
                newBatchNotes
            );

            var batch = await BalanceService.CreateBatchAsync(tenantId, request);
            
            if (batch != null)
            {
                showNewBatchDialog = false;
                Snackbar.Add("Batch created successfully.", Severity.Success);
                Navigation.NavigateTo($"/gl/opening-balance/edit/{batch.Id}");
            }
            else
            {
                Snackbar.Add("Failed to create batch", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void EditBatch(Guid id)
    {
        Navigation.NavigateTo($"/gl/opening-balance/edit/{id}");
    }

    private void ViewBatch(Guid id)
    {
        Navigation.NavigateTo($"/gl/opening-balance/view/{id}");
    }

    private async Task DeleteBatch(PlatformFinanceDTOs.OpeningBalanceBatchDto batch)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Batch",
            $"Are you sure you want to delete batch {batch.BatchNumber}?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var success = await BalanceService.DeleteAsync(tenantId, batch.Id);
                if (success)
                {
                    Snackbar.Add("Batch deleted.", Severity.Success);
                    await LoadBatches();
                }
                else
                {
                    Snackbar.Add("Failed to delete batch", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CloseOpeningBalances()
    {
        var result = await DialogService.ShowMessageBox(
            "Close Opening Balances",
            "This will transfer all Opening Balance Equity amounts to Retained Earnings. This action cannot be undone. Continue?",
            yesText: "Close", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var success = await BalanceService.CloseBatchesToRetainedEarningsAsync(tenantId, filterFiscalYear ?? DateTime.Now.Year);

                if (success)
                {
                    Snackbar.Add("Opening balances closed to Retained Earnings.", Severity.Success);
                    await LoadBatches();
                }
                else
                {
                    Snackbar.Add("Failed to close opening balances", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetModuleColor(string module)
    {
        return module switch
        {
            "GL" => Color.Primary,
            "AR" => Color.Success,
            "AP" => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Draft" => Color.Default,
            "Submitted" => Color.Info,
            "Posted" => Color.Success,
            "Closed" => Color.Secondary,
            _ => Color.Default
        };
    }
}

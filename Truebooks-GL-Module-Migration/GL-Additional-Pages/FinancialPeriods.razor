@page "/gl/financial-periods"

@inject PlatformServices.IFinancialPeriodService PeriodService
@inject LegacyServices.IAuthService AuthService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Financial Periods</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.h4">Financial Periods</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Manage fiscal years and period status for financial reporting and transaction control.
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex justify-end align-center">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateFiscalYearDialog">
                    Create Fiscal Year
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        @foreach (var year in periods.GroupBy(p => p.FiscalYear).OrderByDescending(g => g.Key))
        {
            <MudPaper Class="pa-4 mb-4">
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudText Typo="Typo.h5" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="mr-2" />
                            Fiscal Year @year.Key
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="4" Class="d-flex justify-end">
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.DeleteForever"
                                   OnClick="@(() => OpenResetDialog(year.Key))">
                            Reset Fiscal Year
                        </MudButton>
                    </MudItem>
                </MudGrid>
                <MudDivider Class="mb-3" />
                <MudTable Items="@year.OrderBy(p => p.PeriodNumber)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Period</MudTh>
                        <MudTh>Period Name</MudTh>
                        <MudTh>Start Date</MudTh>
                        <MudTh>End Date</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Year End</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.PeriodNumber</MudTd>
                        <MudTd>@context.PeriodName</MudTd>
                        <MudTd>@context.StartDate.ToString("MMM dd, yyyy")</MudTd>
                        <MudTd>@context.EndDate.ToString("MMM dd, yyyy")</MudTd>
                        <MudTd>
                            <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">
                                @context.Status.ToString()
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            @if (context.IsYearEnd)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                            }
                        </MudTd>
                        <MudTd>
                            @if (context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.NotOpened)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                           OnClick="@(() => OpenPeriod(context.Id))">Open</MudButton>
                            }
                            else if (context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.Open)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small"
                                           OnClick="@(() => SoftClosePeriod(context.Id))">Soft Close</MudButton>
                            }
                            else if (context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.SoftClosed)
                            {
                                <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                                    <MudButton Color="Color.Info" OnClick="@(() => ReopenPeriod(context.Id))">Reopen</MudButton>
                                    <MudButton Color="Color.Error" OnClick="@(() => HardClosePeriod(context.Id))">Hard Close</MudButton>
                                </MudButtonGroup>
                            }
                            else if (context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.HardClosed)
                            {
                                <MudButton Variant="Variant.Text" Color="Color.Secondary" Size="Size.Small"
                                           OnClick="@(() => ArchivePeriod(context.Id))">Archive</MudButton>
                            }
                            
                            @if (context.IsYearEnd && (context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.SoftClosed || context.Status == PlatformFinanceDTOs.FinancialPeriodStatus.Open))
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" Class="ml-2"
                                           Href="@($"/gl/year-end-closing?periodId={context.Id}")">
                                    Year-End Closing
                                </MudButton>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }

        @if (!periods.Any())
        {
            <MudAlert Severity="Severity.Info">
                No financial periods found. Click "Create Fiscal Year" to set up your first fiscal year.
            </MudAlert>
        }
    }
</MudContainer>

<MudDialog @bind-Visible="showCreateDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Create Fiscal Year</MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4">
            Create a new fiscal year with 12 monthly periods. The system will automatically generate periods based on your date range.
        </MudAlert>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudDatePicker @bind-Date="fiscalYearStartDate" Label="Fiscal Year Start" Variant="Variant.Outlined" 
                               HelperText="First day of first period" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudDatePicker @bind-Date="fiscalYearEndDate" Label="Fiscal Year End" Variant="Variant.Outlined"
                               HelperText="Last day of last period" />
            </MudItem>
        </MudGrid>
        @if (fiscalYearStartDate.HasValue && fiscalYearEndDate.HasValue)
        {
            <MudText Typo="Typo.body2" Class="mt-2">
                Period: @GetNormalizedStartDate().ToString("MMM dd, yyyy") - @GetNormalizedEndDate().ToString("MMM dd, yyyy")
                (@GetMonthCount() months)
            </MudText>
            @if (GetMonthCount() != 12)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-2">
                    A fiscal year should contain exactly 12 periods. Current selection has @GetMonthCount() months.
                </MudAlert>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showCreateDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateFiscalYear" 
                   Disabled="@(!CanCreateFiscalYear)">Create</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="showResetDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Error">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
            Reset Fiscal Year @resetFiscalYear
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (loadingTransactionCounts)
        {
            <MudProgressCircular Indeterminate="true" />
            <MudText Class="ml-3">Loading transaction counts...</MudText>
        }
        else if (transactionCounts != null)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                <MudText Typo="Typo.body1"><strong>WARNING: This action is irreversible!</strong></MudText>
                <MudText Typo="Typo.body2">All transactions and financial periods for fiscal year @resetFiscalYear will be permanently deleted.</MudText>
            </MudAlert>
            
            <MudText Typo="Typo.subtitle1" Class="mb-2">Records to be deleted:</MudText>
            <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
                <tbody>
                    <tr><td>Journal Entries</td><td>@transactionCounts.JournalEntries</td></tr>
                    <tr><td>Sales Invoices</td><td>@transactionCounts.SalesInvoices</td></tr>
                    <tr><td>Purchase Bills</td><td>@transactionCounts.PurchaseBills</td></tr>
                    <tr><td>Cash/Bank Transactions</td><td>@transactionCounts.CashBankTransactions</td></tr>
                    <tr><td>Sales Orders</td><td>@transactionCounts.SalesOrders</td></tr>
                    <tr><td>Purchase Orders</td><td>@transactionCounts.PurchaseOrders</td></tr>
                    <tr><td>Delivery Notes</td><td>@transactionCounts.DeliveryNotes</td></tr>
                    <tr><td>Financial Periods</td><td>@transactionCounts.FinancialPeriods</td></tr>
                    <tr style="font-weight: bold; background-color: #ffebee;">
                        <td><strong>Total Transactions</strong></td>
                        <td><strong>@transactionCounts.TotalTransactions</strong></td>
                    </tr>
                </tbody>
            </MudSimpleTable>
            
            <MudCheckBox @bind-Value="resetDocumentNumbers" Color="Color.Error" Class="mb-3">
                Also reset document numbering sequences to 1
            </MudCheckBox>
            
            <MudText Typo="Typo.body2" Class="mb-2">
                To confirm, type <strong>"@resetFiscalYear"</strong> below:
            </MudText>
            <MudTextField @bind-Value="resetConfirmationText" Label="Confirmation" 
                          Placeholder="@resetFiscalYear.ToString()" Variant="Variant.Outlined" />
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showResetDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" 
                   OnClick="ExecuteReset" 
                   Disabled="@(resetConfirmationText != resetFiscalYear.ToString() || resetting)">
            @if (resetting)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                <span>Deleting...</span>
            }
            else
            {
                <span>Delete Everything</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool loading = true;
    private List<PlatformFinanceDTOs.FinancialPeriodDto> periods = new();
    private bool showCreateDialog = false;
    private DateTime? fiscalYearStartDate;
    private DateTime? fiscalYearEndDate;
    private Guid tenantId = Guid.Empty;
    
    private bool showResetDialog = false;
    private int resetFiscalYear;
    private string resetConfirmationText = "";
    private bool resetDocumentNumbers = true;
    private bool loadingTransactionCounts = false;
    private bool resetting = false;
    private PlatformFinanceDTOs.TransactionCountsDto? transactionCounts;
    
    private DialogOptions dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };
    
    private bool CanCreateFiscalYear => fiscalYearStartDate.HasValue && fiscalYearEndDate.HasValue && 
                                        fiscalYearEndDate.Value > fiscalYearStartDate.Value &&
                                        GetMonthCount() == 12;
    
    private int GetMonthCount()
    {
        if (!fiscalYearStartDate.HasValue || !fiscalYearEndDate.HasValue)
            return 0;
        return ((fiscalYearEndDate.Value.Year - fiscalYearStartDate.Value.Year) * 12) + 
               fiscalYearEndDate.Value.Month - fiscalYearStartDate.Value.Month + 1;
    }
    
    private DateTime GetNormalizedStartDate()
    {
        if (!fiscalYearStartDate.HasValue) return DateTime.Today;
        return new DateTime(fiscalYearStartDate.Value.Year, fiscalYearStartDate.Value.Month, 1);
    }
    
    private DateTime GetNormalizedEndDate()
    {
        if (!fiscalYearEndDate.HasValue) return DateTime.Today;
        var year = fiscalYearEndDate.Value.Year;
        var month = fiscalYearEndDate.Value.Month;
        return new DateTime(year, month, DateTime.DaysInMonth(year, month));
    }

    protected override async Task OnInitializedAsync()
    {
        tenantId = Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;
        await LoadPeriods();
    }

    private async Task LoadPeriods()
    {
        loading = true;
        try
        {
            var result = await PeriodService.GetAllAsync(tenantId);
            periods = result?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading periods: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void OpenCreateFiscalYearDialog()
    {
        var today = DateTime.Today;
        fiscalYearStartDate = new DateTime(today.Year, 4, 1);
        fiscalYearEndDate = new DateTime(today.Year + 1, 3, 31);
        showCreateDialog = true;
    }

    private async Task CreateFiscalYear()
    {
        if (!fiscalYearStartDate.HasValue || !fiscalYearEndDate.HasValue)
        {
            Snackbar.Add("Please select both start and end dates", Severity.Warning);
            return;
        }

        try
        {
            var normalizedStart = GetNormalizedStartDate();
            var normalizedEnd = GetNormalizedEndDate();
            var success = await PeriodService.CreateFiscalYearAsync(tenantId, normalizedStart, normalizedEnd);
            
            if (success)
            {
                Snackbar.Add($"Fiscal year created successfully with 12 periods", Severity.Success);
                showCreateDialog = false;
                await LoadPeriods();
            }
            else
            {
                Snackbar.Add("Failed to create fiscal year", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenPeriod(Guid periodId)
    {
        await ChangePeriodStatus(periodId, () => PeriodService.OpenPeriodAsync(tenantId, periodId), "Period opened successfully");
    }

    private async Task SoftClosePeriod(Guid periodId)
    {
        await ChangePeriodStatus(periodId, () => PeriodService.SoftClosePeriodAsync(tenantId, periodId), "Period soft closed successfully");
    }

    private async Task HardClosePeriod(Guid periodId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Hard Close Period",
            "Are you sure you want to hard close this period? This action restricts future edits.",
            yesText: "Yes, Hard Close", cancelText: "Cancel");
        
        if (confirmed == true)
        {
            await ChangePeriodStatus(periodId, () => PeriodService.HardClosePeriodAsync(tenantId, periodId), "Period hard closed successfully");
        }
    }

    private async Task ReopenPeriod(Guid periodId)
    {
        await ChangePeriodStatus(periodId, () => PeriodService.ReopenPeriodAsync(tenantId, periodId), "Period reopened successfully");
    }

    private async Task ArchivePeriod(Guid periodId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Archive Period",
            "Are you sure you want to archive this period? This action is permanent.",
            yesText: "Yes, Archive", cancelText: "Cancel");
        
        if (confirmed == true)
        {
            await ChangePeriodStatus(periodId, () => PeriodService.ArchivePeriodAsync(tenantId, periodId), "Period archived successfully");
        }
    }

    private async Task ChangePeriodStatus(Guid periodId, Func<Task<bool>> action, string successMessage)
    {
        try
        {
            var success = await action();
            
            if (success)
            {
                Snackbar.Add(successMessage, Severity.Success);
                await LoadPeriods();
            }
            else
            {
                Snackbar.Add("Operation failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(PlatformFinanceDTOs.FinancialPeriodStatus status)
    {
        return status switch
        {
            PlatformFinanceDTOs.FinancialPeriodStatus.NotOpened => Color.Default,
            PlatformFinanceDTOs.FinancialPeriodStatus.Open => Color.Success,
            PlatformFinanceDTOs.FinancialPeriodStatus.SoftClosed => Color.Warning,
            PlatformFinanceDTOs.FinancialPeriodStatus.HardClosed => Color.Error,
            PlatformFinanceDTOs.FinancialPeriodStatus.Archived => Color.Secondary,
            _ => Color.Default
        };
    }

    private async Task OpenResetDialog(int fiscalYear)
    {
        resetFiscalYear = fiscalYear;
        resetConfirmationText = "";
        resetDocumentNumbers = true;
        transactionCounts = null;
        showResetDialog = true;
        loadingTransactionCounts = true;
        
        try
        {
            transactionCounts = await PeriodService.GetTransactionCountsAsync(tenantId, fiscalYear);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading transaction counts: {ex.Message}", Severity.Error);
            showResetDialog = false;
        }
        finally
        {
            loadingTransactionCounts = false;
        }
    }

    private async Task ExecuteReset()
    {
        if (resetConfirmationText != resetFiscalYear.ToString())
        {
            Snackbar.Add("Confirmation text does not match", Severity.Warning);
            return;
        }
        
        resetting = true;
        
        try
        {
            var success = await PeriodService.ResetFiscalYearAsync(tenantId, resetFiscalYear, resetDocumentNumbers);
            
            if (success)
            {
                Snackbar.Add($"Fiscal year {resetFiscalYear} has been completely reset", Severity.Success);
                showResetDialog = false;
                await LoadPeriods();
            }
            else
            {
                Snackbar.Add("Reset failed", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            resetting = false;
        }
    }
}

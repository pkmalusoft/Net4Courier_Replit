@page "/gl/opening-balance/edit/{Id:guid}"
@page "/gl/opening-balance/view/{Id:guid}"



@using System.Text.Json
@using System.Text.Json.Serialization
@inject LegacyServices.IAuthService AuthService
@inject IMasterDataService MasterDataService
@inject PlatformServices.IOpeningBalanceService OpeningBalanceService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6">
        <MudText Typo="Typo.h4">@GetPageTitle()</MudText>
    </MudItem>
    <MudItem xs="12" sm="6" Class="d-flex justify-end">
        <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">
            Back to List
        </MudButton>
    </MudItem>
</MudGrid>

@if (isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}

<MudPaper Class="pa-6" Elevation="2">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudTextField Value="@batch.BatchNumber" Label="Batch Number" ReadOnly="true" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudChip T="string" Color="@GetModuleColor(batch.SourceModule)" Size="MudBlazor.Size.Large">@GetModuleLabel(batch.SourceModule)</MudChip>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudDatePicker Label="Effective Date" @bind-Date="effectiveDate" Disabled="@IsViewMode" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudChip T="string" Color="@GetStatusColor(batch.Status)" Size="MudBlazor.Size.Large">@batch.Status</MudChip>
        </MudItem>
        <MudItem xs="12">
            <MudTextField @bind-Value="notes" Label="Notes" Lines="2" Variant="Variant.Outlined" Disabled="@IsViewMode" />
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-6" />

    <MudText Typo="Typo.h6" Class="mb-4">@GetLinesTitle()</MudText>

    <MudTable Items="@lines" Dense="true" Hover="true" Bordered="true">
        <HeaderContent>
            <MudTh>@GetReferenceLabel()</MudTh>
            <MudTh>Currency</MudTh>
            <MudTh Style="text-align: right;">Debit</MudTh>
            <MudTh Style="text-align: right;">Credit</MudTh>
            @if (!IsViewMode)
            {
                <MudTh>Actions</MudTh>
            }
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@GetReferenceLabel()">
                @GetReferenceDisplay(context)
            </MudTd>
            <MudTd DataLabel="Currency">@GetCurrencyDisplay(context.CurrencyId)</MudTd>
            <MudTd DataLabel="Debit" Style="text-align: right;">@context.HomeCurrencyDebit.ToString("N2")</MudTd>
            <MudTd DataLabel="Credit" Style="text-align: right;">@context.HomeCurrencyCredit.ToString("N2")</MudTd>
            @if (!IsViewMode)
            {
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="MudBlazor.Size.Small" OnClick="@(() => EditLine(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="MudBlazor.Size.Small" Color="Color.Error" OnClick="@(() => DeleteLine(context))" />
                </MudTd>
            }
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No lines added yet. Click "Add Line" to begin.</MudText>
        </NoRecordsContent>
    </MudTable>

    @if (!IsViewMode)
    {
        <MudButton StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Class="mt-4" OnClick="AddLine">
            Add Line
        </MudButton>
    }

    <MudDivider Class="my-6" />

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudText Typo="Typo.h6">Total Debit: <MudChip T="string" Color="Color.Success">@TotalDebit.ToString("N2")</MudChip></MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudText Typo="Typo.h6">Total Credit: <MudChip T="string" Color="Color.Error">@TotalCredit.ToString("N2")</MudChip></MudText>
        </MudItem>
        <MudItem xs="12" md="4">
            @if (batch.SourceModule == "GL")
            {
                @if (Math.Abs(TotalDebit - TotalCredit) > 0.01m)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">Unbalanced: @((TotalDebit - TotalCredit).ToString("N2"))</MudAlert>
                }
                else if (lines.Count > 0)
                {
                    <MudAlert Severity="Severity.Success" Dense="true">Balanced</MudAlert>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Info" Dense="true">Auto-balanced to Opening Balance Equity</MudAlert>
            }
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-6" />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }

    <MudGrid>
        @if (!IsViewMode && batch.Status == "Draft")
        {
            <MudItem xs="12" sm="6" md="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="SaveBatch" Disabled="@isSaving">
                    Save Changes
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" OnClick="SubmitBatch" Disabled="@(isSaving || lines.Count == 0)">
                    Submit for Approval
                </MudButton>
            </MudItem>
        }
        @if (!IsViewMode && batch.Status == "Submitted")
        {
            <MudItem xs="12" sm="6" md="3">
                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" OnClick="PostBatch" Disabled="@isSaving">
                    Post to Ledger
                </MudButton>
            </MudItem>
        }
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Text" Color="Color.Default" FullWidth="true" OnClick="GoBack">
                @(IsViewMode ? "Back" : "Cancel")
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudDialog @bind-Visible="showLineDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingLine?.Id != Guid.Empty ? "Edit Line" : "Add Line")</MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            @if (batch.SourceModule == "GL")
            {
                <MudItem xs="12">
                    <MudAutocomplete T="ChartOfAccount" Label="Account" @bind-Value="selectedAccount"
                                     SearchFunc="@SearchAccounts" ToStringFunc="@(a => a == null ? "" : $"{a.AccountCode} - {a.AccountName}")"
                                     Variant="Variant.Outlined" Required="true" />
                </MudItem>
            }
            else if (batch.SourceModule == "AR")
            {
                <MudItem xs="12">
                    <MudAutocomplete T="Customer" Label="Customer" @bind-Value="selectedCustomer"
                                     SearchFunc="@SearchCustomers" ToStringFunc="@(c => c == null ? "" : $"{c.CustomerCode} - {c.Name}")"
                                     Variant="Variant.Outlined" Required="true" />
                </MudItem>
            }
            else if (batch.SourceModule == "AP")
            {
                <MudItem xs="12">
                    <MudAutocomplete T="Vendor" Label="Supplier" @bind-Value="selectedSupplier"
                                     SearchFunc="@SearchSuppliers" ToStringFunc="@(s => s == null ? "" : $"{s.VendorCode} - {s.Name}")"
                                     Variant="Variant.Outlined" Required="true" />
                </MudItem>
            }
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="lineCurrencyId" Label="Currency" Variant="Variant.Outlined">
                    @foreach (var currency in currencies)
                    {
                        <MudSelectItem Value="@currency.Id">@currency.Code - @currency.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="lineExchangeRate" Label="Exchange Rate" Format="N4" Min="0.0001m" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="lineDebit" Label="Debit" Format="N2" Min="0" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="lineCredit" Label="Credit" Format="N2" Min="0" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showLineDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveLine" Disabled="@(!IsLineValid)">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public Guid Id { get; set; }

    private PlatformFinanceDTOs.OpeningBalanceBatchDto batch = new();
    private List<PlatformFinanceDTOs.OpeningBalanceBatchLineDto> lines = new();
    private DateTime? effectiveDate;
    private string notes = "";
    private string errorMessage = "";
    private bool isLoading = false;
    private bool isSaving = false;

    private bool IsViewMode => Navigation.Uri.Contains("/view/");
    
    private List<ChartOfAccount> accounts = new();
    private List<Customer> customers = new();
    private List<Vendor> suppliers = new();
    private List<Currency> currencies = new();
    
    private bool showLineDialog = false;
    private PlatformFinanceDTOs.OpeningBalanceBatchLineDto? editingLine;
    private ChartOfAccount? selectedAccount;
    private Customer? selectedCustomer;
    private Vendor? selectedSupplier;
    private Guid? lineCurrencyId;
    private decimal lineExchangeRate = 1m;
    private decimal lineDebit = 0m;
    private decimal lineCredit = 0m;

    private decimal TotalDebit => lines.Sum(l => l.HomeCurrencyDebit);
    private decimal TotalCredit => lines.Sum(l => l.HomeCurrencyCredit);

    private bool IsLineValid
    {
        get
        {
            if (batch.SourceModule == "GL" && selectedAccount == null) return false;
            if (batch.SourceModule == "AR" && selectedCustomer == null) return false;
            if (batch.SourceModule == "AP" && selectedSupplier == null) return false;
            if (lineDebit == 0 && lineCredit == 0) return false;
            return true;
        }
    }

    private static readonly JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() }
    };

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(AuthService.GetAccessToken()))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isLoading = true;
        try
        {
            var currenciesTask = MasterDataService.GetCurrenciesAsync();
            var accountsTask = MasterDataService.GetChartOfAccountsAsync();
            var customersTask = MasterDataService.GetCustomersAsync();
            var suppliersTask = MasterDataService.GetVendorsAsync();

            await Task.WhenAll(currenciesTask, accountsTask, customersTask, suppliersTask);

            currencies = currenciesTask.Result;
            accounts = accountsTask.Result;
            customers = customersTask.Result;
            suppliers = suppliersTask.Result;

            await LoadBatch();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private Guid GetTenantId() => Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;

    private async Task LoadBatch()
    {
        var tenantId = GetTenantId();
        var loadedBatch = await OpeningBalanceService.GetBatchByIdAsync(tenantId, Id);
        
        if (loadedBatch != null)
        {
            batch = loadedBatch;
            lines = batch.Lines ?? new();
            effectiveDate = batch.EffectiveDate;
            notes = batch.Notes ?? "";

            if (currencies.Any() && !lineCurrencyId.HasValue)
            {
                var homeCurrency = currencies.FirstOrDefault(c => c.IsBaseCurrency);
                lineCurrencyId = homeCurrency?.Id ?? currencies.FirstOrDefault()?.Id;
            }
        }
        else
        {
            Snackbar.Add("Failed to load batch.", Severity.Error);
            Navigation.NavigateTo("/gl/opening-balances");
        }
    }

    private string GetPageTitle()
    {
        if (IsViewMode) return $"View Opening Balance Batch - {batch.BatchNumber}";
        return $"Edit Opening Balance Batch - {batch.BatchNumber}";
    }

    private string GetLinesTitle()
    {
        return batch.SourceModule switch
        {
            "GL" => "Account Balances",
            "AR" => "Customer Balances",
            "AP" => "Supplier Balances",
            _ => "Lines"
        };
    }

    private string GetReferenceLabel()
    {
        return batch.SourceModule switch
        {
            "GL" => "Account",
            "AR" => "Customer",
            "AP" => "Supplier",
            _ => "Reference"
        };
    }

    private string GetModuleLabel(string module)
    {
        return module switch
        {
            "GL" => "General Ledger",
            "AR" => "Accounts Receivable",
            "AP" => "Accounts Payable",
            _ => module
        };
    }

    private string GetReferenceDisplay(PlatformFinanceDTOs.OpeningBalanceBatchLineDto line)
    {
        return line.ReferenceName ?? line.ReferenceId.ToString();
    }

    private string GetCurrencyDisplay(Guid? currencyId)
    {
        if (!currencyId.HasValue) return "-";
        var currency = currencies.FirstOrDefault(c => c.Id == currencyId.Value);
        return currency?.Code ?? "-";
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/gl/opening-balances");
    }

    private Color GetModuleColor(string module)
    {
        return module switch
        {
            "GL" => Color.Primary,
            "AR" => Color.Success,
            "AP" => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Draft" => Color.Default,
            "Submitted" => Color.Info,
            "Posted" => Color.Success,
            "Closed" => Color.Secondary,
            _ => Color.Default
        };
    }

    private void AddLine()
    {
        editingLine = new PlatformFinanceDTOs.OpeningBalanceBatchLineDto(Guid.Empty, Guid.Empty, null, "", null, 1m, 0m, 0m);
        selectedAccount = null;
        selectedCustomer = null;
        selectedSupplier = null;
        lineCurrencyId = currencies.FirstOrDefault(c => c.IsBaseCurrency)?.Id ?? currencies.FirstOrDefault()?.Id;
        lineExchangeRate = 1m;
        lineDebit = 0m;
        lineCredit = 0m;
        showLineDialog = true;
    }

    private void EditLine(PlatformFinanceDTOs.OpeningBalanceBatchLineDto line)
    {
        editingLine = line;
        
        if (batch.SourceModule == "GL")
            selectedAccount = accounts.FirstOrDefault(a => a.Id == line.ReferenceId);
        else if (batch.SourceModule == "AR")
            selectedCustomer = customers.FirstOrDefault(c => c.Id == line.ReferenceId);
        else if (batch.SourceModule == "AP")
            selectedSupplier = suppliers.FirstOrDefault(s => s.Id == line.ReferenceId);

        lineCurrencyId = line.CurrencyId;
        lineExchangeRate = line.ExchangeRate;
        lineDebit = line.HomeCurrencyDebit;
        lineCredit = line.HomeCurrencyCredit;
        showLineDialog = true;
    }

    private async Task SaveLine()
    {
        if (editingLine == null) return;

        try
        {
            var tenantId = GetTenantId();

            Guid referenceId;
            string referenceType;
            string referenceName;

            if (batch.SourceModule == "GL" && selectedAccount != null)
            {
                referenceId = selectedAccount.Id;
                referenceType = "Account";
                referenceName = $"{selectedAccount.AccountCode} - {selectedAccount.AccountName}";
            }
            else if (batch.SourceModule == "AR" && selectedCustomer != null)
            {
                referenceId = selectedCustomer.Id;
                referenceType = "Customer";
                referenceName = $"{selectedCustomer.CustomerCode} - {selectedCustomer.Name}";
            }
            else if (batch.SourceModule == "AP" && selectedSupplier != null)
            {
                referenceId = selectedSupplier.Id;
                referenceType = "Supplier";
                referenceName = $"{selectedSupplier.VendorCode} - {selectedSupplier.Name}";
            }
            else
            {
                Snackbar.Add("Please select a reference.", Severity.Warning);
                return;
            }

            var lineRequest = new PlatformFinanceDTOs.CreateOpeningBalanceLineRequest(
                referenceType,
                referenceId,
                lineCurrencyId ?? Guid.Empty,
                lineExchangeRate,
                lineDebit,
                lineCredit
            );

            bool success;
            if (editingLine.Id == Guid.Empty)
            {
                var addedLine = await OpeningBalanceService.AddLineAsync(tenantId, Id, lineRequest);
                success = addedLine != null;
            }
            else
            {
                success = await OpeningBalanceService.UpdateLineAsync(tenantId, Id, editingLine.Id, lineRequest);
            }

            if (success)
            {
                showLineDialog = false;
                Snackbar.Add("Line saved.", Severity.Success);
                await LoadBatch();
            }
            else
            {
                Snackbar.Add("Failed to save line.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteLine(PlatformFinanceDTOs.OpeningBalanceBatchLineDto line)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Line",
            "Are you sure you want to delete this line?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var tenantId = GetTenantId();
                var success = await OpeningBalanceService.DeleteLineAsync(tenantId, Id, line.Id);
                if (success)
                {
                    Snackbar.Add("Line deleted.", Severity.Success);
                    await LoadBatch();
                }
                else
                {
                    Snackbar.Add("Failed to delete line.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task SaveBatch()
    {
        isSaving = true;
        try
        {
            var tenantId = GetTenantId();
            var updateRequest = new PlatformFinanceDTOs.UpdateOpeningBalanceBatchRequest(
                effectiveDate,
                notes
            );

            var success = await OpeningBalanceService.UpdateAsync(tenantId, Id, updateRequest);
            if (success)
            {
                Snackbar.Add("Batch saved.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to save batch.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task SubmitBatch()
    {
        isSaving = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await OpeningBalanceService.SubmitAsync(tenantId, Id);
            if (success)
            {
                Snackbar.Add("Batch submitted for approval.", Severity.Success);
                await LoadBatch();
            }
            else
            {
                Snackbar.Add("Failed to submit batch.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task PostBatch()
    {
        var result = await DialogService.ShowMessageBox(
            "Post Batch",
            "This will create journal entries and post balances to the ledger. Continue?",
            yesText: "Post", cancelText: "Cancel");

        if (result != true) return;

        isSaving = true;
        try
        {
            var tenantId = GetTenantId();
            var success = await OpeningBalanceService.PostAsync(tenantId, Id);
            if (success)
            {
                Snackbar.Add("Batch posted successfully.", Severity.Success);
                await LoadBatch();
            }
            else
            {
                Snackbar.Add("Failed to post batch.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task<IEnumerable<ChartOfAccount>> SearchAccounts(string value, CancellationToken token)
    {
        await Task.CompletedTask;
        if (string.IsNullOrEmpty(value))
            return accounts.Take(20);

        return accounts.Where(a => 
            (a.AccountCode?.Contains(value, StringComparison.OrdinalIgnoreCase) ?? false) ||
            a.AccountName.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(20);
    }

    private async Task<IEnumerable<Customer>> SearchCustomers(string value, CancellationToken token)
    {
        await Task.CompletedTask;
        if (string.IsNullOrEmpty(value))
            return customers.Take(20);

        return customers.Where(c => 
            c.CustomerCode.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(20);
    }

    private async Task<IEnumerable<Vendor>> SearchSuppliers(string value, CancellationToken token)
    {
        await Task.CompletedTask;
        if (string.IsNullOrEmpty(value))
            return suppliers.Take(20);

        return suppliers.Where(s => 
            s.VendorCode.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            s.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(20);
    }
}

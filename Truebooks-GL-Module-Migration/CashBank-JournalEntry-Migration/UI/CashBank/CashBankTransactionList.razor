@page "/cash-bank-transactions"

@using PlatformServices = Truebooks.Platform.Contracts.Services
@using PlatformDTOs = Truebooks.Platform.Contracts.DTOs

@inject PlatformServices.ICashBankTransactionService CashBankTransactionService
@inject PlatformServices.IBankAccountService BankAccountService
@inject LegacyServices.IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Cash & Bank Transactions</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedTransactionType" Label="Transaction Type" T="int?">
                    <MudSelectItem Value="@((int?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((int?)0)">Bank</MudSelectItem>
                    <MudSelectItem Value="@((int?)1)">Cash</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedRecPayType" Label="Receipt/Payment" T="int?">
                    <MudSelectItem Value="@((int?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((int?)0)">Receipt</MudSelectItem>
                    <MudSelectItem Value="@((int?)1)">Payment</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedStatusFilter" Label="Status" T="string">
                    <MudSelectItem Value="@("All")">All</MudSelectItem>
                    <MudSelectItem Value="@("Draft")">Draft</MudSelectItem>
                    <MudSelectItem Value="@("Posted")">Posted</MudSelectItem>
                    <MudSelectItem Value="@("Cancelled")">Cancelled</MudSelectItem>
                    <MudSelectItem Value="@("Void")">Void</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="CreateNew"
                          FullWidth="true">
                    Create New
                </MudButton>
            </MudItem>
        </MudGrid>
        
        <MudGrid Class="mt-2">
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          OnClick="ApplyFilters"
                          FullWidth="true">
                    Apply Filters
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Text" 
                          Color="Color.Default" 
                          OnClick="ClearFilters"
                          FullWidth="true">
                    Clear Filters
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4">
        @if (isLoading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudDataGrid T="PlatformDTOs.CashBankTransactionDto" 
                        Items="@transactions" 
                        Dense="true"
                        Hover="true"
                        ReadOnly="true"
                        Height="600px">
                <Columns>
                    <PropertyColumn Property="x => x.VoucherNo" Title="Voucher No" />
                    <PropertyColumn Property="x => x.VoucherDate" Title="Voucher Date" Format="dd MMM yyyy" />
                    <PropertyColumn Property="x => x.TransactionType" Title="Type">
                        <CellTemplate>
                            <MudChip Size="MudBlazor.Size.Small" Color="@(context.Item.TransactionType == 0 ? Color.Primary : Color.Info)">
                                @context.Item.TransactionTypeText
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.RecPayType" Title="Rec/Pay">
                        <CellTemplate>
                            <MudChip Size="MudBlazor.Size.Small" Color="@(context.Item.RecPayType == 0 ? Color.Success : Color.Warning)">
                                @context.Item.RecPayTypeText
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.SourceAccountName" Title="Source Account">
                        <CellTemplate>
                            @{
                                var bankAccountName = GetBankAccountName(context.Item.BankAccountId);
                                if (!string.IsNullOrEmpty(bankAccountName))
                                {
                                    <MudText>@bankAccountName</MudText>
                                    @if (!string.IsNullOrEmpty(context.Item.SourceAccountCode))
                                    {
                                        <MudText Typo="Typo.caption" Style="color: gray;">GL: @context.Item.SourceAccountCode</MudText>
                                    }
                                }
                                else if (!string.IsNullOrEmpty(context.Item.SourceAccountCode))
                                {
                                    <MudText>@context.Item.SourceAccountCode - @context.Item.SourceAccountName</MudText>
                                }
                                else
                                {
                                    <MudText>-</MudText>
                                }
                            }
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.TotalAmount" Title="Total Amount" Format="N2">
                        <CellTemplate>
                            <MudText Style="text-align: right;">@context.Item.TotalAmount.ToString("N2")</MudText>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.Status" Title="Status">
                        <CellTemplate>
                            <MudChip Size="MudBlazor.Size.Small" Color="@GetStatusColor(context.Item.Status)">
                                @context.Item.StatusText
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Attach" Sortable="false">
                        <CellTemplate>
                            @{
                                var attachmentCount = GetAttachmentCount(context.Item.Id);
                                if (attachmentCount > 0)
                                {
                                    <MudTooltip Text="@($"{attachmentCount} attachment(s) - Click to view")">
                                        <MudBadge Content="@attachmentCount" Color="Color.Primary" Overlap="true">
                                            <MudIconButton Icon="@Icons.Material.Filled.AttachFile" 
                                                         Size="MudBlazor.Size.Small" 
                                                         Color="Color.Info"
                                                         OnClick="@(() => ViewAttachments(context.Item.Id))" />
                                        </MudBadge>
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.AttachFile" 
                                           Size="MudBlazor.Size.Small" 
                                           Style="opacity: 0.3;" />
                                }
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                         Size="MudBlazor.Size.Small" 
                                         Color="Color.Primary"
                                         OnClick="@(() => EditTransaction(context.Item.Id))" />
                            @if (context.Item.Status == 1 && !context.Item.IsVoided && IsAdminOrOwner())
                            {
                                <MudTooltip Text="Void Transaction">
                                    <MudIconButton Icon="@Icons.Material.Filled.NotInterested" 
                                                 Size="MudBlazor.Size.Small" 
                                                 Color="Color.Error"
                                                 OnClick="@(() => OpenVoidDialog(context.Item))" />
                                </MudTooltip>
                            }
                            @if (context.Item.IsVoided)
                            {
                                <MudChip Size="MudBlazor.Size.Small" Color="Color.Error">VOIDED</MudChip>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
    </MudPaper>
</MudContainer>

@if (voidDialogVisible)
{
    <MudDialog Visible="true" Options="new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.Small }">
        <TitleContent>
            <MudText Typo="Typo.h6">Void Transaction</MudText>
        </TitleContent>
        <DialogContent>
            <MudText Typo="Typo.body1" Class="mb-4">
                Are you sure you want to void transaction <strong>@transactionToVoid?.VoucherNo</strong>?
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Warning" Class="mb-4">
                This action cannot be undone. The transaction will be marked as voided and excluded from reports.
            </MudText>
            <MudTextField @bind-Value="voidReason" 
                          Label="Void Reason" 
                          Required="true" 
                          Lines="3"
                          Variant="Variant.Outlined" 
                          HelperText="Please provide a reason for voiding this transaction" />
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseVoidDialog" Color="Color.Default">Cancel</MudButton>
            <MudButton OnClick="VoidTransaction" Color="Color.Error" Variant="Variant.Filled">Void Transaction</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    private List<PlatformDTOs.CashBankTransactionDto> transactions = new();
    private List<PlatformBankDTOs.BankAccountListDto> bankAccounts = new();
    private int? selectedTransactionType = null;
    private int? selectedRecPayType = null;
    private string selectedStatusFilter = "All";
    private bool isLoading = false;
    private bool voidDialogVisible = false;
    private PlatformDTOs.CashBankTransactionDto? transactionToVoid;
    private string voidReason = string.Empty;

    private Guid GetTenantId()
    {
        var tenantIdStr = AuthService.GetTenantId();
        return Guid.TryParse(tenantIdStr, out var tenantId) ? tenantId : Guid.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBankAccounts();
        await LoadTransactions();
    }
    
    private async Task LoadBankAccounts()
    {
        try
        {
            var tenantId = GetTenantId();
            bankAccounts = await BankAccountService.GetAllAsync(tenantId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading bank accounts: {ex.Message}", Severity.Warning);
        }
    }
    
    private string GetBankAccountName(Guid? bankAccountId)
    {
        if (!bankAccountId.HasValue) return string.Empty;
        
        var bankAccount = bankAccounts.FirstOrDefault(b => b.Id == bankAccountId.Value);
        if (bankAccount != null)
        {
            return $"{bankAccount.AccountName} - {bankAccount.BankName} (Acc# {bankAccount.AccountNumber})";
        }
        return string.Empty;
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        try
        {
            var tenantId = GetTenantId();
            bool includeVoided = selectedStatusFilter == "Void";
            int? status = selectedStatusFilter switch
            {
                "Draft" => 0,
                "Posted" => 1,
                "Cancelled" => 2,
                _ => null
            };

            var allTransactions = await CashBankTransactionService.GetAllAsync(
                tenantId,
                selectedTransactionType,
                selectedRecPayType,
                status,
                null,
                null,
                includeVoided
            );

            if (selectedStatusFilter == "Void")
            {
                transactions = allTransactions.Where(t => t.IsVoided).ToList();
            }
            else
            {
                transactions = allTransactions;
            }

            await LoadAttachmentCounts();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading transactions: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        await LoadTransactions();
    }

    private async Task ClearFilters()
    {
        selectedTransactionType = null;
        selectedRecPayType = null;
        selectedStatusFilter = "All";
        await LoadTransactions();
    }

    private Color GetStatusColor(int status)
    {
        return status switch
        {
            0 => Color.Default,
            1 => Color.Success,
            2 => Color.Error,
            _ => Color.Default
        };
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/cash-bank-transaction/new");
    }

    private void EditTransaction(Guid id)
    {
        Navigation.NavigateTo($"/cash-bank-transaction/edit/{id}");
    }

    private bool IsAdminOrOwner()
    {
        var userRoles = AuthService.GetUserRoles();
        return userRoles.Contains("admin") || userRoles.Contains("owner");
    }

    private void OpenVoidDialog(PlatformDTOs.CashBankTransactionDto transaction)
    {
        transactionToVoid = transaction;
        voidReason = string.Empty;
        voidDialogVisible = true;
    }

    private void CloseVoidDialog()
    {
        voidDialogVisible = false;
        transactionToVoid = null;
        voidReason = string.Empty;
    }

    private async Task VoidTransaction()
    {
        if (transactionToVoid == null || string.IsNullOrWhiteSpace(voidReason))
        {
            Snackbar.Add("Please provide a void reason", Severity.Warning);
            return;
        }

        try
        {
            var tenantId = GetTenantId();
            await CashBankTransactionService.VoidAsync(tenantId, transactionToVoid.Id, voidReason);
            Snackbar.Add($"Transaction {transactionToVoid.VoucherNo} has been voided successfully", Severity.Success);
            CloseVoidDialog();
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error voiding transaction: {ex.Message}", Severity.Error);
        }
    }

    private Dictionary<Guid, int> attachmentCounts = new();

    private async Task LoadAttachmentCounts()
    {
        try
        {
            var tenantId = GetTenantId();
            var transactionIds = transactions.Select(t => t.Id).ToList();
            attachmentCounts = await CashBankTransactionService.GetAttachmentCountsAsync(tenantId, transactionIds);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading attachment counts: {ex.Message}", Severity.Warning);
        }
    }

    private int GetAttachmentCount(Guid transactionId)
    {
        return attachmentCounts.TryGetValue(transactionId, out var count) ? count : 0;
    }

    private void ViewAttachments(Guid transactionId)
    {
        Navigation.NavigateTo($"/cash-bank-transaction/edit/{transactionId}#attachments");
    }
}

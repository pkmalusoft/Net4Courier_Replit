@page "/gl/journal-vouchers"

@inject PlatformServices.IJournalEntryService JournalService
@inject LegacyServices.IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Journal Vouchers</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedStatus" Label="Status" T="string">
                    <MudSelectItem Value="@("All")">All</MudSelectItem>
                    <MudSelectItem Value="@("Draft")">Draft</MudSelectItem>
                    <MudSelectItem Value="@("Posted")">Posted</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="fromDate" Label="From Date" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="toDate" Label="To Date" Clearable="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="CreateNew"
                          FullWidth="true">
                    Create New
                </MudButton>
            </MudItem>
        </MudGrid>
        
        <MudGrid Class="mt-2">
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          OnClick="ApplyFilters"
                          FullWidth="true">
                    Apply Filters
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Text" 
                          Color="Color.Default" 
                          OnClick="ClearFilters"
                          FullWidth="true">
                    Clear Filters
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudCheckBox @bind-Value="includeVoided" Label="Include Voided" Color="Color.Secondary" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4">
        @if (isLoading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudDataGrid T="PlatformFinanceDTOs.JournalEntryListDto" 
                        Items="@journalEntries" 
                        Dense="true"
                        Hover="true"
                        ReadOnly="true"
                        Height="600px">
                <Columns>
                    <PropertyColumn Property="x => x.EntryNumber" Title="Entry No" />
                    <PropertyColumn Property="x => x.EntryDate" Title="Entry Date" Format="dd MMM yyyy" />
                    <PropertyColumn Property="x => x.Description" Title="Description" />
                    <TemplateColumn Title="Source">
                        <CellTemplate>
                            <MudChip Size="MudBlazor.Size.Small" Color="@GetSourceColor(context.Item.Source)">
                                @context.Item.Source.ToString()
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.TotalDebit" Title="Debit" Format="N2">
                        <CellTemplate>
                            <MudText Style="text-align: right;">@context.Item.TotalDebit.ToString("N2")</MudText>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.TotalCredit" Title="Credit" Format="N2">
                        <CellTemplate>
                            <MudText Style="text-align: right;">@context.Item.TotalCredit.ToString("N2")</MudText>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Status">
                        <CellTemplate>
                            <MudChip Size="MudBlazor.Size.Small" Color="@GetStatusColor(context.Item.Status)">
                                @context.Item.Status.ToString()
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Actions">
                        <CellTemplate>
                            @if (!context.Item.IsVoided)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                             Size="MudBlazor.Size.Small" 
                                             Color="Color.Info"
                                             OnClick="@(() => ViewEntry(context.Item.Id))" />
                                @if (context.Item.Status == PlatformFinanceDTOs.JournalEntryStatus.Draft)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                 Size="MudBlazor.Size.Small" 
                                                 Color="Color.Primary"
                                                 OnClick="@(() => EditEntry(context.Item.Id))" />
                                }
                                @if (context.Item.Status == PlatformFinanceDTOs.JournalEntryStatus.Posted && IsAdminOrOwner())
                                {
                                    <MudTooltip Text="Void Entry">
                                        <MudIconButton Icon="@Icons.Material.Filled.NotInterested" 
                                                     Size="MudBlazor.Size.Small" 
                                                     Color="Color.Error"
                                                     OnClick="@(() => ShowVoidDialog(context.Item))" />
                                    </MudTooltip>
                                }
                            }
                            else
                            {
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="Color.Error">Voided</MudChip>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
    </MudPaper>
</MudContainer>

<MudDialog @bind-Visible="voidDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">Void Journal Entry</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-4">Are you sure you want to void entry <strong>@entryToVoid?.EntryNumber</strong>?</MudText>
        <MudTextField @bind-Value="voidReason" Label="Void Reason" Required="true" Lines="3" Variant="Variant.Outlined" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseVoidDialog">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="VoidEntry" Disabled="@string.IsNullOrWhiteSpace(voidReason)">Void Entry</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<PlatformFinanceDTOs.JournalEntryListDto> journalEntries = new();
    private bool isLoading = true;
    private string selectedStatus = "All";
    private DateTime? fromDate;
    private DateTime? toDate;
    private bool includeVoided = false;
    private Guid tenantId = Guid.Empty;
    
    private bool voidDialogVisible = false;
    private PlatformFinanceDTOs.JournalEntryListDto? entryToVoid;
    private string voidReason = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        tenantId = Guid.TryParse(AuthService.GetTenantId(), out var parsedId) ? parsedId : Guid.Empty;
        await LoadJournalEntries();
    }

    private async Task LoadJournalEntries()
    {
        isLoading = true;
        try
        {
            var statusFilter = selectedStatus == "All" ? null : selectedStatus;
            var result = await JournalService.GetAllAsync(tenantId, fromDate, toDate, statusFilter);
            var entries = result?.ToList() ?? new();
            
            if (!includeVoided)
            {
                entries = entries.Where(e => !e.IsVoided).ToList();
            }
            
            journalEntries = entries;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading journal entries: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        await LoadJournalEntries();
    }

    private void ClearFilters()
    {
        selectedStatus = "All";
        fromDate = null;
        toDate = null;
        includeVoided = false;
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/gl/journal-entry");
    }

    private void ViewEntry(Guid id)
    {
        Navigation.NavigateTo($"/gl/journal-entry/{id}?mode=view");
    }

    private void EditEntry(Guid id)
    {
        Navigation.NavigateTo($"/gl/journal-entry/{id}");
    }

    private bool IsAdminOrOwner()
    {
        var userRoles = AuthService.GetUserRoles();
        return userRoles.Contains("Admin") || userRoles.Contains("Owner");
    }

    private void ShowVoidDialog(PlatformFinanceDTOs.JournalEntryListDto entry)
    {
        entryToVoid = entry;
        voidReason = string.Empty;
        voidDialogVisible = true;
    }

    private void CloseVoidDialog()
    {
        voidDialogVisible = false;
        entryToVoid = null;
        voidReason = string.Empty;
    }

    private async Task VoidEntry()
    {
        if (entryToVoid == null || string.IsNullOrWhiteSpace(voidReason))
        {
            Snackbar.Add("Please provide a void reason.", Severity.Warning);
            return;
        }

        try
        {
            var success = await JournalService.VoidAsync(tenantId, entryToVoid.Id, voidReason);
            
            if (success)
            {
                Snackbar.Add("Journal entry voided successfully.", Severity.Success);
                CloseVoidDialog();
                await LoadJournalEntries();
            }
            else
            {
                Snackbar.Add("Error voiding entry", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error voiding entry: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(PlatformFinanceDTOs.JournalEntryStatus status)
    {
        return status switch
        {
            PlatformFinanceDTOs.JournalEntryStatus.Draft => Color.Warning,
            PlatformFinanceDTOs.JournalEntryStatus.Posted => Color.Success,
            PlatformFinanceDTOs.JournalEntryStatus.Cancelled => Color.Error,
            _ => Color.Default
        };
    }

    private Color GetSourceColor(PlatformFinanceDTOs.JournalEntrySource source)
    {
        return source switch
        {
            PlatformFinanceDTOs.JournalEntrySource.Manual => Color.Primary,
            PlatformFinanceDTOs.JournalEntrySource.SalesInvoice => Color.Info,
            PlatformFinanceDTOs.JournalEntrySource.PurchaseBill => Color.Secondary,
            PlatformFinanceDTOs.JournalEntrySource.CashBank => Color.Success,
            PlatformFinanceDTOs.JournalEntrySource.YearEndClosing => Color.Warning,
            PlatformFinanceDTOs.JournalEntrySource.OpeningBalance => Color.Tertiary,
            _ => Color.Default
        };
    }
}

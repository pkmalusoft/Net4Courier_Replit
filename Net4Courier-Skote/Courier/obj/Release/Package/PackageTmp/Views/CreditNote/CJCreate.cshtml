@model Net4Courier.Models.CreditNoteVM

@{

    
    ViewBag.pTitle = "CUSTOMER JOURNAL";
    ViewBag.pageTitle = "Account Receivable";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.isadd = Model.Details.Count > 0 ? 1 : 0;

    var _decimal = Convert.ToInt32(@Session["Decimal"].ToString());

    string path = Request.Url.AbsolutePath.ToLower();

    if (Convert.ToInt32(Session["UserRoleID"]) > 1)
    {
        Net4Courier.Models.SourceMastersModel obj = new Net4Courier.Models.SourceMastersModel();
        //isadd = obj.GetAddpermission(Convert.ToInt32(Session["UserRoleID"]), path);

    }
}


<script type="text/javascript">
    function setTwoNumberDecimal(obj) {
       $(obj).val(parseFloat($(obj).val()).toFixed(@_decimal));
    }
     
    $(document).ready(function () {

       

        $("#CustomerName").focus();
       

        $("#InvoiceAmount").attr("disabled", "disabled");
        $("#ReceivedAmount").attr("disabled", "disabled");


         
      

       
        //$("#btnadd").attr("disabled", "disabled");
        @*if (@ViewBag.isadd == 1) {
            $("#btnsave").removeAttr("disabled");
        } else {
            $("#btnsave").attr("disabled", "disabled");
        }*@
        //$("#AcDetailAmount").on('change', function () {
        //    var value = parseInt($(this).val());
        //    if (value > 0) {
        //        $("#btnadd").removeAttr("disabled");
        //    }
        //    else {
        //        $("#btnadd").attr("disabled", "disabled");
        //    }

        //});
       
        $('#TransType').change(function () {
            if ($('#CreditNoteID').val() == 0) {
                if ($('#TransType').val() == 'CN') {
                    $('#lblaccount').html('Chart of Account - Credit');
                    $('#lblaccount1').html('Chart of Account - Debit');
                    $('#lblamount').html('Credit Amount');
                    $('#lblamount1').html('Debit Amount');
                    $('#lblchkInvoice').html('For Invoice');
                    $('#lblInvoice').html('Invoice No.');
                    $('#lblInvoiceDate').html('Invoice Date');
                    $('#lblInvoiceAmt').html('Invoice Amount')
                    $('#lblReceivedAmt').html('OutStanding Amount');
                    $('#AmountType').val(0).trigger('change');
                    $('#AcDetailAmountType').val(1).trigger('change');
                    $('#txtCreditAmount').attr('readonly','readonly');
                    $('#txtDebitAmount').removeAttr('readonly');
                    $('#RecPayID').val('0');
                    $('#InvoiceNo').val('');
                    var refhtml ='<option value="0">Direct</option><option value="1">For Invoice </option>'
                    $('#ReferenceType').html(refhtml);
                }
                else if ($('#TransType').val() == 'CJ') {
                    $('#lblaccount').html('Chart of Account - Debit');
                    $('#lblaccount1').html('Chart of Account - Credit');
                    $('#lblamount').html('Debit Amount');
                    $('#lblamount1').html('Credit Amount');
                    $('#lblchkInvoice').html('For Recpt');
                    $('#lblInvoice').html('Receipt No.');
                    $('#lblInvoiceDate').html('Receipt Date');
                    $('#lblInvoiceAmt').html('Receipt Amount')
                    $('#lblReceivedAmt').html('Settled Amount');
                    $('#AmountType').val(1).trigger('change');
                    $('#txtDebitAmount').attr('readonly', 'readonly');
                    $('#txtCreditAmount').removeAttr('readonly');
                    $('#AcDetailAmountType').val(0).trigger('change');
                    $('#InvoiceNo').val('');
                    $('#InvoiceID').val('0');
                    var refhtml = '<option value="0">Direct</option><option value="1">For Invoice</option><option value="2">For Receipt </option>'
                    $('#ReferenceType').html(refhtml);
                }
            }
            var ID = $('#CustomerID').val();
            if (ID > 0 && $('#ReferenceType').val()>"1" && $("#CreditNoteID").val()==0) {
                $.ajax({
                    type: "POST",
                    url: '/CreditNote/GetTradeInvoiceOfCustomer/' + ID,
                    data: { 'ID': ID, 'amountreceived': 0, TransType: $('#TransType').val(), RefType: $('#ReferenceType').val() },
                    success: function (data) {
                        if (data.length == 0) {
                            alert("There is no pending invoice!");
                            $('#InvoiceNo').val('');
                            $('#InvoiceNo').attr('disabled', 'disabled');
                        }
                        else {
                            $('#InvoiceNo').removeAttr('disabled');
                        }

                    }
                });
            }
        })
        $('#ReferenceType').change(function () {
             
            if ($('#ReferenceType').val() == '1') {
                
                    $('#lblInvoice').html('Invoice No.');
                    $('#lblInvoiceDate').html('Invoice Date');
                    $('#lblInvoiceAmt').html('Invoice Amount')
                    $('#lblReceivedAmt').html('OutStanding Amount');
                     
                }
                else if ($('#ReferenceType').val() == '2'){
                   
                    $('#lblInvoice').html('Receipt No.');
                    $('#lblInvoiceDate').html('Receipt Date');
                    $('#lblInvoiceAmt').html('Receipt Amount')
                    $('#lblReceivedAmt').html('Settled Amount');
                    
            }
            var ID = $('#CustomerID').val();
            if (ID > 0 && $('#ReferenceType').val() >= "1" && $("#CreditNoteID").val() == 0) {
                $.ajax({
                    type: "POST",
                    url: '/CreditNote/GetTradeInvoiceOfCustomer/' + ID,
                    data: { 'ID': ID, 'amountreceived': 0, TransType: $('#TransType').val(), RefType: $('#ReferenceType').val() },
                    success: function (data) {
                        if (data.length == 0) {
                            alert("There is no pending invoice!");
                            $('#InvoiceNo').val('');
                            $('#InvoiceNo').attr('disabled', 'disabled');
                        }
                        else {
                            $('#InvoiceNo').removeAttr('disabled');
                        }

                    }
                });
            }
        })

        $("#InvoiceNo").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/CreditNote/GetInvoiceNo',
                    datatype: "json",
                    data: {
                         term: request.term
                    },
                    success: function (data) {
                        response($.map(data, function (val, item) {

                            return {
                                label: val.InvoiceNo,
                                value: val.SalesInvoiceID,
                                InvDate: val.DateTime,
                                InvoiceAmt: val.InvoiceAmount,
                                Type: val.InvoiceType,
                                Received: val.Balance
                            }
                        }))
                    }
                })
            }, minLength: 1,
            focus: function (e, i) {
                $("#InvoiceNo").val(i.item.label);
                $("#InvoiceID").val(i.item.value);
                $("#InvoiceDate").val(i.item.InvDate);
                $('#InvoiceType').val(i.item.Type);
                $('#InvoiceAmount').val(i.item.InvoiceAmt);
                $('#ReceivedAmount').val(i.item.Received);
                setTwoNumberDecimal($("#InvoiceAmount"));
                setTwoNumberDecimal($("#ReceivedAmount"));

            },
            select: function (e, i) {
                e.preventDefault();
                $("#InvoiceNo").val(i.item.label);
                $("#InvoiceID").val(i.item.value);
                $("#InvoiceDate").val(i.item.InvDate);
                $('#InvoiceType').val(i.item.Type);
                $('#InvoiceAmount').val(i.item.InvoiceAmt);
                $('#ReceivedAmount').val(i.item.Received);
                setTwoNumberDecimal($("#InvoiceAmount"));
                setTwoNumberDecimal($("#ReceivedAmount"));
            }
        });

        $("#ReferenceType").change(function () {
            if ($("#ReferenceType").val()=="1" ) {
                $('#InvoiceNo').removeAttr('disabled');
                $('#InvoiceNo').attr('required', 'required');                
                $('#InvoiceNo').addClass('form-select');
                $('#InvoiceNo').removeClass('form-control');
                var ID = $('#CustomerID').val();
                if (ID > 0 && $('#ReferenceType').val() >= "1" && $('#CreditNoteID').val()==0) {
                    $.ajax({
                        type: "POST",
                        url: '/CreditNote/GetTradeInvoiceOfCustomer/' + ID,
                        data: { 'ID': ID, 'amountreceived': 0, TransType: $('#TransType').val(),RefType: $('#ReferenceType').val() },
                        success: function (data) {
                            if (data.length == 0) {
                                alert("There is no pending invoice!");
                                $('#InvoiceNo').attr('disabled', 'disabled');                                
                                $('#InvoiceNo').val('');
                                $('#InvoiceDate').val('');
                                $('#InvoiceID').val(0);
                                $('#InvoiceNo').val('');                                
                            }
                            else {
                                $('#InvoiceNo').removeAttr('disabled');
                            }

                        }
                    });
                }

            }
            else if ( $('#ReferenceType').val() == "1" && $('#CreditNoteID').val() == 0) {
                $('#InvoiceNo').removeClass('form-select');
                $('#InvoiceNo').addClass('form-control');
                $('#InvoiceNo').attr('disabled', 'disabled');                
                $('#InvoiceNo').val('');
                $('#InvoiceDate').val('');
                $('#InvoiceID').val(0);
                $('#InvoiceID').removeAttr('required');
                
                 
            }
        });

       

      
        
        setTwoNumberDecimal($("#InvoiceAmount"));
        setTwoNumberDecimal($("#ReceivedAmount"));
        setTwoNumberDecimal($("#Amount"));
    });
    
</script>



@using (Html.BeginForm("CJCreate", "CreditNote", FormMethod.Post, new { @class = "needs-validation ", @novalidate = "novalidate" }))
{
  
    @Html.ValidationSummary(true)

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h4 class="card-title mb-2 mt-3 text-danger" id="msg1">
                </h4>
            </div>
            <div class="col-md-4 text-md-end">

                <input type="submit" value="Save" class="btn btn-success" id="btnsave" />
                <a href='@Url.Action("Index", "CreditNote", new { id = 0 })' class="btn btn-secondary">Cancel</a>
                <div id="divothermenu" class="btn-group">
                    @*<button type="submit" class="btn btn-primary">Menu</button>*@
                    <span class="btn btn-primary"><i class="bx bx-cog bx-spin me-2"></i>Sub Menu</span>
                    <button type="button" class="btn btn-primary dropdown-toggle-split border_right" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="mdi mdi-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="divsubmenu">

                        <a class="dropdown-item" href="/CreditNote/Create?id=0">New Credit Note</a>
                        <a class="dropdown-item" href="/CreditNote/Index">Credit Note List</a>
                        <a class="dropdown-item" target="_blank" href="/Accounts/Posting?id=@Model.AcJournalID">Journal Entry</a>
                    </div>
                </div>
                <div class="btn-group " id="divothermenu1">
                    <span class="btn btn-pink"><i class="mdi mdi-printer font-size-14 me-2"></i>Print</span>
                    <button type="button" class="btn btn-pink dropdown-toggle-split border_right" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="mdi mdi-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu" id="divprintmenu">
                        <a class="dropdown-item" href="Javascript:void(0)" onclick="funExportToPDF(@Model.CreditNoteID)">Report</a>
                    </div>
                </div><!-- /btn-group -->
            </div>

        </div>
   
        <div class="row">

            <div class="col-md-2">
                <div class="mb-2">
                    <label class="col-form-label">Customer JV No.</label>
                    @Html.HiddenFor(mode => mode.CreditNoteID)
                    @Html.HiddenFor(mode => mode.AcJournalID)

                    @Html.HiddenFor(mode => mode.AcHeadName)
                    @Html.TextBoxFor(mode => mode.CreditNoteNo, new { @class = "form-control", @readonly = "readonly" })
                </div>
            </div>
            <div class="col-md-2">
                <div class="mb-2">
                    <label class="col-form-label">Transaction Date</label>
                    <div class="docs-datepicker">
                        <div class="input-group">
                            @Html.TextBoxFor(model => model.Date, "{0:dd-MM-yyyy}", new { @class = "form-control", @required = "required" })
                            <button type="button"
                                    class="btn btn-secondary docs-datepicker-trigger"
                                    disabled>
                                <i class="mdi mdi-calendar" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="docs-datepicker-container"></div>
                    </div>
                    <div class="invalid-feedback">
                        Select Date
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-2">
                    <label class="col-form-label">Customer</label>
                    @Html.TextBoxFor(model => model.CustomerName, new { @class = "form-select", @required = "true" })
                    @*@Html.DropDownListFor(model => model.CustomerID, new SelectList(@ViewBag.customer, "CustomerID", "CustomerName"), "Select", new { @class = "form-control", @required = "true" })*@
                    @Html.HiddenFor(model => model.CustomerID)
                    @Html.HiddenFor(model => model.TransType)
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-2">
                    <label class="col-form-label">Description</label>
                    @Html.TextAreaFor(model => model.Description, new { @class = "form-control", @required = "true", @rows = "1" })

                </div>
            </div>

        </div>

        
 </div>   </div>
   
        <div class="card">
            <div class="card-body">
         <div class="row" id="listContainer">
        @{Html.RenderPartial("CreditNoteDetail", Model);}
        

    </div>
</div>
    </div>
  

}


@section scripts{

     
    <script src="~/Scripts/JS/CreditNoteCreate.js"></script>
}
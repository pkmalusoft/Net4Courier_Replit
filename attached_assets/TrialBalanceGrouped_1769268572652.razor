@page "/reports/trial-balance-grouped"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Trial Balance - Group-wise</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int?">
                    <MudSelectItem Value="@((int?)null)">All Months</MudSelectItem>
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@((int?)month)">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                <MudText Typo="Typo.subtitle1">
                    As at: @reportResult.AsAtDate.ToString("dd MMM yyyy")
                </MudText>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                    @reportResult.Groups.Sum(g => g.Items.Count) accounts in @reportResult.Groups.Count groups
                </MudText>
            </MudStack>

            @foreach (var group in reportResult.Groups)
            {
                <MudExpansionPanels Class="mb-3" MultiExpansion="true">
                    <MudExpansionPanel @bind-Expanded="expandedGroups[group.GroupName]">
                        <TitleContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Style="width: 100%">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@GetGroupIcon(group.AccountType)" Class="mr-2" />
                                    @group.GroupName
                                </MudText>
                                <MudStack Row="true" Spacing="4">
                                    <MudChip T="string" Color="Color.Success" Size="MudBlazor.Size.Small">
                                        Dr: @group.GroupTotalDebit.ToString("N2")
                                    </MudChip>
                                    <MudChip T="string" Color="Color.Error" Size="MudBlazor.Size.Small">
                                        Cr: @group.GroupTotalCredit.ToString("N2")
                                    </MudChip>
                                </MudStack>
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                            <MudTable Items="@group.Items" 
                                      Dense="true" 
                                      Hover="true" 
                                      Striped="true">
                                <HeaderContent>
                                    <MudTh Style="width: 120px">Account Code</MudTh>
                                    <MudTh>Account Name</MudTh>
                                    <MudTh Style="width: 150px; text-align: right">Debit</MudTh>
                                    <MudTh Style="width: 150px; text-align: right">Credit</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Account Code">@context.AccountCode</MudTd>
                                    <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                                    <MudTd DataLabel="Debit" Style="text-align: right">
                                        @(context.DebitBalance != 0 ? context.DebitBalance.ToString("N2") : "-")
                                    </MudTd>
                                    <MudTd DataLabel="Credit" Style="text-align: right">
                                        @(context.CreditBalance != 0 ? context.CreditBalance.ToString("N2") : "-")
                                    </MudTd>
                                </RowTemplate>
                                <FooterContent>
                                    <MudTFootRow>
                                        <MudTd colspan="2"><strong>@group.GroupName Total</strong></MudTd>
                                        <MudTd Style="text-align: right"><strong>@group.GroupTotalDebit.ToString("N2")</strong></MudTd>
                                        <MudTd Style="text-align: right"><strong>@group.GroupTotalCredit.ToString("N2")</strong></MudTd>
                                    </MudTFootRow>
                                </FooterContent>
                            </MudTable>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            <MudPaper Class="pa-4 mt-4" Elevation="2" Style="background-color: var(--mud-palette-background-grey)">
                <MudStack Row="true" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h6"><strong>Grand Total</strong></MudText>
                    <MudStack Row="true" Spacing="4">
                        <MudText Typo="Typo.h6" Color="Color.Success">
                            <strong>Debit: @reportResult.GrandTotalDebit.ToString("N2")</strong>
                        </MudText>
                        <MudText Typo="Typo.h6" Color="Color.Error">
                            <strong>Credit: @reportResult.GrandTotalCredit.ToString("N2")</strong>
                        </MudText>
                    </MudStack>
                </MudStack>
                @if (reportResult.GrandTotalDebit != reportResult.GrandTotalCredit)
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-2">
                        Trial Balance does not balance. Difference: @((reportResult.GrandTotalDebit - reportResult.GrandTotalCredit).ToString("N2"))
                    </MudAlert>
                }
            </MudPaper>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a period and click Generate to view the Trial Balance grouped by Account Type.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private int selectedYear = DateTime.Now.Year;
    private int? selectedMonth = DateTime.Now.Month;
    private bool isLoading = false;
    private TrialBalanceGroupedResult? reportResult;
    private Dictionary<string, bool> expandedGroups = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportResult = null;
        StateHasChanged();

        try
        {
            var request = CreateAuthenticatedRequest(HttpMethod.Post, "api/trialbalance/grouped");
            request.Content = JsonContent.Create(new
            {
                Year = selectedYear,
                Month = selectedMonth
            });

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<TrialBalanceGroupedResult>();
                if (reportResult != null)
                {
                    foreach (var group in reportResult.Groups)
                    {
                        expandedGroups[group.GroupName] = true;
                    }
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        reportResult = null;
        expandedGroups.Clear();
    }

    private string GetGroupIcon(string accountType)
    {
        return accountType switch
        {
            "Asset" => Icons.Material.Filled.AccountBalance,
            "Liability" => Icons.Material.Filled.CreditCard,
            "Equity" => Icons.Material.Filled.PieChart,
            "Revenue" => Icons.Material.Filled.TrendingUp,
            "Expense" => Icons.Material.Filled.ShoppingCart,
            _ => Icons.Material.Filled.Folder
        };
    }

    private HttpRequestMessage CreateAuthenticatedRequest(HttpMethod method, string uri)
    {
        var request = new HttpRequestMessage(method, uri);
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        
        if (!string.IsNullOrEmpty(token))
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        if (!string.IsNullOrEmpty(tenantId))
            request.Headers.Add("X-Tenant-Id", tenantId);
        
        return request;
    }

    private class TrialBalanceGroupedResult
    {
        public string ReportType { get; set; } = "";
        public DateTime AsAtDate { get; set; }
        public List<TrialBalanceGroup> Groups { get; set; } = new();
        public decimal GrandTotalDebit { get; set; }
        public decimal GrandTotalCredit { get; set; }
    }

    private class TrialBalanceGroup
    {
        public string GroupName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public List<TrialBalanceItem> Items { get; set; } = new();
        public decimal GroupTotalDebit { get; set; }
        public decimal GroupTotalCredit { get; set; }
    }

    private class TrialBalanceItem
    {
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public decimal DebitBalance { get; set; }
        public decimal CreditBalance { get; set; }
    }
}

@page "/courier/cod-remittances"
@layout MainLayout
@using Web.Models
@using Web.Services
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">COD Remittance Management</MudText>
    
    <MudPaper Class="pa-4 mb-4" Style="overflow: visible;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" Style="overflow: visible;">
            <MudStack Row="true" Spacing="2" Style="overflow: visible;">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="CreateNewRemittance">
                    New Remittance
                </MudButton>
                <MudDatePicker Date="@fromDate" Label="From Date" 
                              Variant="Variant.Outlined" Style="width: 150px;"
                              DateFormat="dd-MMM-yyyy"
                              DateChanged="@(async (DateTime? val) => { fromDate = val; await OnDateRangeChanged(); })" />
                <MudDatePicker Date="@toDate" Label="To Date" 
                              Variant="Variant.Outlined" Style="width: 150px;"
                              DateFormat="dd-MMM-yyyy"
                              DateChanged="@(async (DateTime? val) => { toDate = val; await OnDateRangeChanged(); })" />
                <MudSelect T="string?" Value="filterStatus" Label="Status" 
                          Variant="Variant.Outlined" Style="width: 150px;" Clearable="true"
                          ValueChanged="@(async (string? val) => { filterStatus = val; await LoadData(); })">
                    <MudSelectItem T="string?" Value="@("Pending")">Pending</MudSelectItem>
                    <MudSelectItem T="string?" Value="@("PartiallyPaid")">Partially Paid</MudSelectItem>
                    <MudSelectItem T="string?" Value="@("Paid")">Paid</MudSelectItem>
                </MudSelect>
            </MudStack>
            <MudTextField @bind-Value="searchText" Label="Search" 
                         Variant="Variant.Outlined" Style="width: 200px;"
                         Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                         OnKeyUp="@(async (e) => { if (e.Key == "Enter") await LoadData(); })" />
        </MudStack>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid Class="mb-4">
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.TotalPending.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Total Pending</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="MudBlazor.Size.Large" Color="Color.Warning" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.TotalCollected.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Total Collected</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Money" Size="MudBlazor.Size.Large" Color="Color.Success" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.TotalPaid.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Total Remitted</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="MudBlazor.Size.Large" Color="Color.Primary" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.Balance.ToString("N2")</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Balance Due</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Balance" Size="MudBlazor.Size.Large" Color="Color.Error" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudTabs Elevation="2" Rounded="true">
            <MudTabPanel Text="Pending COD" Icon="@Icons.Material.Filled.PendingActions">
                <MudPaper Class="pa-4">
                    <MudDataGrid T="PendingCODItem" Items="@pendingCODItems" Dense="true" Hover="true"
                                Selection="@selectedPendingItems" MultiSelection="true"
                                SelectedItemsChanged="@(items => selectedPendingItems = items.ToHashSet())">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">COD Collections Pending Remittance</MudText>
                            <MudSpacer />
                            @if (selectedPendingItems.Any())
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Payment"
                                          OnClick="CreateRemittanceFromSelected">
                                    Create Remittance (@selectedPendingItems.Count items)
                                </MudButton>
                            }
                        </ToolBarContent>
                        <Columns>
                            <SelectColumn T="PendingCODItem" />
                            <PropertyColumn Property="x => x.AWBNumber" Title="AWB Number" />
                            <PropertyColumn Property="x => x.CustomerName" Title="Customer" />
                            <TemplateColumn Title="Delivery Date">
                                <CellTemplate>
                                    @context.Item.DeliveryDate.ToString("dd-MMM-yyyy")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="COD Amount">
                                <CellTemplate>
                                    @context.Item.CODAmount.ToString("N2")
                                </CellTemplate>
                            </TemplateColumn>
                            <PropertyColumn Property="x => x.DeliveryAgentName" Title="Collected By" />
                            <PropertyColumn Property="x => x.DaysOutstanding" Title="Days Outstanding" />
                        </Columns>
                    </MudDataGrid>
                </MudPaper>
            </MudTabPanel>
            
            <MudTabPanel Text="Remittances" Icon="@Icons.Material.Filled.Receipt">
                <MudPaper Class="pa-4">
                    <MudDataGrid T="RemittanceItem" Items="@remittances" Dense="true" Hover="true"
                                RowClick="@(e => ViewRemittance(e.Item))">
                        <Columns>
                            <PropertyColumn Property="x => x.RemittanceNumber" Title="Remittance #" />
                            <TemplateColumn Title="Date">
                                <CellTemplate>
                                    @context.Item.RemittanceDate.ToString("dd-MMM-yyyy")
                                </CellTemplate>
                            </TemplateColumn>
                            <PropertyColumn Property="x => x.CustomerName" Title="Customer" />
                            <PropertyColumn Property="x => x.ShipmentCount" Title="Shipments" />
                            <TemplateColumn Title="Total Amount">
                                <CellTemplate>
                                    @context.Item.TotalAmount.ToString("N2")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Paid Amount">
                                <CellTemplate>
                                    @context.Item.PaidAmount.ToString("N2")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Balance">
                                <CellTemplate>
                                    @context.Item.BalanceAmount.ToString("N2")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Status">
                                <CellTemplate>
                                    <MudChip T="string" Size="MudBlazor.Size.Small" 
                                            Color="@GetStatusColor(context.Item.Status)">
                                        @context.Item.Status
                                    </MudChip>
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Actions" Sortable="false">
                                <CellTemplate>
                                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                  Color="Color.Primary" 
                                                  Size="MudBlazor.Size.Small"
                                                  OnClick="@(() => ViewRemittance(context.Item))" />
                                    @if (context.Item.Status == "Pending" || context.Item.Status == "PartiallyPaid")
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Payment" 
                                                      Color="Color.Success" 
                                                      Size="MudBlazor.Size.Small"
                                                      OnClick="@(() => ProcessPayment(context.Item))" />
                                    }
                                    <MudIconButton Icon="@Icons.Material.Filled.Print" 
                                                  Color="Color.Default" 
                                                  Size="MudBlazor.Size.Small"
                                                  OnClick="@(() => PrintRemittance(context.Item))" />
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudPaper>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

<MudDialog @bind-Visible="showPaymentDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Process Payment</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body1">Remittance: @selectedRemittance?.RemittanceNumber</MudText>
            <MudText Typo="Typo.body2">Balance Due: @selectedRemittance?.BalanceAmount.ToString("N2")</MudText>
            <MudNumericField @bind-Value="paymentAmount" Label="Payment Amount" 
                            Variant="Variant.Outlined" Format="N2" />
            <MudSelect T="string" @bind-Value="paymentMethod" Label="Payment Method" Variant="Variant.Outlined">
                <MudSelectItem Value="@("Cash")">Cash</MudSelectItem>
                <MudSelectItem Value="@("BankTransfer")">Bank Transfer</MudSelectItem>
                <MudSelectItem Value="@("Cheque")">Cheque</MudSelectItem>
                <MudSelectItem Value="@("UPI")">UPI</MudSelectItem>
            </MudSelect>
            <MudTextField @bind-Value="paymentReference" Label="Reference" Variant="Variant.Outlined" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showPaymentDialog = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitPayment">Process</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<PendingCODItem> pendingCODItems = new();
    private List<RemittanceItem> remittances = new();
    private HashSet<PendingCODItem> selectedPendingItems = new();
    private CODSummary summary = new();
    private bool isLoading = true;
    private DateTime? fromDate = DateTime.UtcNow.Date.AddDays(-30);
    private DateTime? toDate = DateTime.UtcNow.Date;
    private string? filterStatus;
    private string? searchText;
    
    private bool showPaymentDialog = false;
    private RemittanceItem? selectedRemittance;
    private decimal paymentAmount;
    private string paymentMethod = "Cash";
    private string? paymentReference;

    private void SetAuthHeaders()
    {
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
        if (!string.IsNullOrEmpty(tenantId))
        {
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private bool IsDateRangeValid()
    {
        if (fromDate.HasValue && toDate.HasValue && fromDate.Value > toDate.Value)
            return false;
        return true;
    }

    private async Task OnDateRangeChanged()
    {
        if (!IsDateRangeValid())
        {
            Snackbar.Add("Invalid date range: 'From Date' cannot be after 'To Date'", Severity.Warning);
            return;
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        if (!IsDateRangeValid())
        {
            Snackbar.Add("Invalid date range: 'From Date' cannot be after 'To Date'", Severity.Warning);
            return;
        }
        
        isLoading = true;
        try
        {
            SetAuthHeaders();
            
            var pendingTask = LoadPendingCOD();
            var remittanceTask = LoadRemittances();
            
            await Task.WhenAll(pendingTask, remittanceTask);
            
            summary = new CODSummary
            {
                TotalPending = pendingCODItems.Sum(x => x.CODAmount),
                TotalCollected = remittances.Sum(x => x.TotalAmount),
                TotalPaid = remittances.Sum(x => x.PaidAmount),
                Balance = remittances.Sum(x => x.BalanceAmount)
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadPendingCOD()
    {
        try
        {
            pendingCODItems = await Http.GetFromJsonAsync<List<PendingCODItem>>(
                "api/courier/cod-remittances/pending") ?? new();
        }
        catch { pendingCODItems = new(); }
    }

    private async Task LoadRemittances()
    {
        try
        {
            var url = "api/courier/cod-remittances";
            var queryParams = new List<string>();
            if (fromDate.HasValue)
                queryParams.Add($"fromDate={fromDate.Value:yyyy-MM-dd}");
            if (toDate.HasValue)
                queryParams.Add($"toDate={toDate.Value:yyyy-MM-dd}");
            if (!string.IsNullOrEmpty(filterStatus))
                queryParams.Add($"status={filterStatus}");
            if (!string.IsNullOrEmpty(searchText))
                queryParams.Add($"search={Uri.EscapeDataString(searchText.Trim())}");
            if (queryParams.Any())
                url += "?" + string.Join("&", queryParams);

            remittances = await Http.GetFromJsonAsync<List<RemittanceItem>>(url) ?? new();
        }
        catch { remittances = new(); }
    }

    private void CreateNewRemittance()
    {
        if (!pendingCODItems.Any())
        {
            Snackbar.Add("No pending COD items available for remittance", Severity.Info);
            return;
        }
        Snackbar.Add("Please select items from the 'Pending COD' tab below to create a remittance", Severity.Info);
    }

    private async Task CreateRemittanceFromSelected()
    {
        if (!selectedPendingItems.Any())
        {
            Snackbar.Add("Please select items to create remittance", Severity.Warning);
            return;
        }

        try
        {
            SetAuthHeaders();
            var response = await Http.PostAsJsonAsync("api/courier/cod-remittances", new
            {
                ShipmentIds = selectedPendingItems.Select(x => x.ShipmentId).ToList()
            });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Remittance created successfully", Severity.Success);
                selectedPendingItems.Clear();
                await LoadData();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to create remittance: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void ViewRemittance(RemittanceItem item)
    {
        Navigation.NavigateTo($"/courier/cod-remittances/{item.Id}");
    }

    private void ProcessPayment(RemittanceItem item)
    {
        selectedRemittance = item;
        paymentAmount = item.BalanceAmount;
        paymentMethod = "Cash";
        paymentReference = null;
        showPaymentDialog = true;
    }

    private async Task SubmitPayment()
    {
        if (selectedRemittance == null || paymentAmount <= 0)
        {
            Snackbar.Add("Invalid payment amount", Severity.Warning);
            return;
        }

        try
        {
            SetAuthHeaders();
            var response = await Http.PostAsJsonAsync($"api/courier/cod-remittances/{selectedRemittance.Id}/payment", new
            {
                Amount = paymentAmount,
                PaymentMethod = paymentMethod,
                Reference = paymentReference
            });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Payment processed successfully", Severity.Success);
                showPaymentDialog = false;
                await LoadData();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to process payment: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void PrintRemittance(RemittanceItem item)
    {
        Snackbar.Add("Print functionality will be implemented", Severity.Info);
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Warning,
        "PartiallyPaid" => Color.Info,
        "Paid" => Color.Success,
        _ => Color.Default
    };

    public class PendingCODItem
    {
        public Guid ShipmentId { get; set; }
        public string AWBNumber { get; set; } = "";
        public string CustomerName { get; set; } = "";
        public DateTime DeliveryDate { get; set; }
        public decimal CODAmount { get; set; }
        public string DeliveryAgentName { get; set; } = "";
        public int DaysOutstanding { get; set; }
    }

    public class RemittanceItem
    {
        public Guid Id { get; set; }
        public string RemittanceNumber { get; set; } = "";
        public DateTime RemittanceDate { get; set; }
        public string CustomerName { get; set; } = "";
        public int ShipmentCount { get; set; }
        public decimal TotalAmount { get; set; }
        public decimal PaidAmount { get; set; }
        public decimal BalanceAmount { get; set; }
        public string Status { get; set; } = "";
    }

    public class CODSummary
    {
        public decimal TotalPending { get; set; }
        public decimal TotalCollected { get; set; }
        public decimal TotalPaid { get; set; }
        public decimal Balance { get; set; }
    }
}

@page "/reports/chart-of-accounts"
@using Web.Services
@using System.Text.Json
@using System.Text.Json.Serialization
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudText Typo="Typo.h4" Class="mb-6">Chart of Accounts Report</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudGrid>
        <MudItem xs="12" md="2">
            <MudSwitch Value="@includeBalance" ValueChanged="@(async (bool v) => await OnIncludeBalanceChanged(v))" 
                      Color="Color.Primary" Label="Show Balances" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudTextField @bind-Value="searchTerm" Label="Search" Variant="Variant.Outlined" 
                         Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                         DebounceInterval="300" OnDebounceIntervalElapsed="@(async (s) => await FilterData())" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Value="@selectedClassification" ValueChanged="@OnClassificationChanged" 
                      Label="Classification" Variant="Variant.Outlined" Clearable="true">
                @if (classifications != null)
                {
                    @foreach (var cls in classifications)
                    {
                        <MudSelectItem T="string" Value="@cls">@cls</MudSelectItem>
                    }
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" Value="@selectedAccountType" ValueChanged="@OnAccountTypeChanged"
                      Label="Account Type" Variant="Variant.Outlined" Clearable="true">
                <MudSelectItem T="string" Value="@("Asset")">Asset</MudSelectItem>
                <MudSelectItem T="string" Value="@("Liability")">Liability</MudSelectItem>
                <MudSelectItem T="string" Value="@("Equity")">Equity</MudSelectItem>
                <MudSelectItem T="string" Value="@("Revenue")">Revenue</MudSelectItem>
                <MudSelectItem T="string" Value="@("Expense")">Expense</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Error" 
                      StartIcon="@Icons.Material.Filled.PictureAsPdf"
                      OnClick="ExportPdf" Disabled="isLoading">
                PDF
            </MudButton>
        </MudItem>
        <MudItem xs="12" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Success" 
                      StartIcon="@Icons.Material.Filled.TableChart"
                      OnClick="ExportExcel" Disabled="isLoading">
                EXCEL
            </MudButton>
        </MudItem>
        <MudItem xs="12" md="1">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                          Color="Color.Primary" 
                          OnClick="LoadData"
                          Size="Size.Large"
                          Disabled="isLoading" />
        </MudItem>
    </MudGrid>
</MudPaper>

@if (isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="my-4">@errorMessage</MudAlert>
}
else
{
    @if (includeBalance)
    {
        <MudTable Items="@filteredAccounts" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Elevation="2" GroupBy="@_groupDefinition">
            <HeaderContent>
                <MudTh>Code</MudTh>
                <MudTh>Account Name</MudTh>
                <MudTh>Type</MudTh>
                <MudTh Style="text-align: right;">Debit Balance</MudTh>
                <MudTh Style="text-align: right;">Credit Balance</MudTh>
                <MudTh Style="text-align: right;">Net Balance</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh Class="mud-table-cell-custom-group" colspan="6">
                    <MudText Typo="Typo.subtitle1" Style="font-weight: bold;">
                        @($"{context.Key}: {context.Items.Count()} accounts")
                    </MudText>
                </MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Code">@context.AccountCode</MudTd>
                <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                <MudTd DataLabel="Type">@context.AccountType</MudTd>
                <MudTd DataLabel="Debit Balance" Style="text-align: right;">@context.DebitBalance?.ToString("N2")</MudTd>
                <MudTd DataLabel="Credit Balance" Style="text-align: right;">@context.CreditBalance?.ToString("N2")</MudTd>
                <MudTd DataLabel="Net Balance" Style="text-align: right;">
                    <MudText Color="@GetBalanceColor(context.NetBalance ?? 0)">
                        @context.NetBalance?.ToString("N2")
                    </MudText>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                    No accounts found.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    }
    else
    {
        <MudTable Items="@filteredAccounts" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Elevation="2" GroupBy="@_groupDefinition">
            <HeaderContent>
                <MudTh>Code</MudTh>
                <MudTh>Account Name</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Classification</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh Class="mud-table-cell-custom-group" colspan="4">
                    <MudText Typo="Typo.subtitle1" Style="font-weight: bold;">
                        @($"{context.Key}: {context.Items.Count()} accounts")
                    </MudText>
                </MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Code">@context.AccountCode</MudTd>
                <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                <MudTd DataLabel="Type">@context.AccountType</MudTd>
                <MudTd DataLabel="Classification">@context.Classification</MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Align="Align.Center" Class="py-8">
                    No accounts found.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    }
}

@code {
    private List<ChartOfAccountReportDto> filteredAccounts = new();
    private List<string> classifications = new();
    private bool isLoading = true;
    private string errorMessage = "";
    private string searchTerm = "";
    private string? selectedClassification = null;
    private string? selectedAccountType = null;
    private bool includeBalance = false;

    private static readonly JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() },
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
    };

    private TableGroupDefinition<ChartOfAccountReportDto> _groupDefinition = new()
    {
        GroupName = "Classification",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.Classification
    };

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(AuthService.GetAccessToken()))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadClassifications();
        await LoadData();
    }

    private void SetAuthHeaders()
    {
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        
        Http.DefaultRequestHeaders.Authorization = 
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        
        Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
        if (!string.IsNullOrEmpty(tenantId))
        {
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);
        }
    }

    private async Task LoadClassifications()
    {
        try
        {
            SetAuthHeaders();

            var response = await Http.GetAsync("api/AccountClassification");
            if (response.IsSuccessStatusCode)
            {
                var allClassifications = await response.Content.ReadFromJsonAsync<List<ClassificationDto>>(jsonOptions) 
                    ?? new List<ClassificationDto>();
                classifications = allClassifications.Select(c => c.Name).Distinct().ToList();
            }
        }
        catch
        {
            // Silently fail - classifications are optional
        }
    }

    private async Task OnIncludeBalanceChanged(bool value)
    {
        includeBalance = value;
        await FilterData();
    }

    private async Task LoadData()
    {
        await FilterData();
    }

    private async Task FilterData()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            SetAuthHeaders();

            // Build URL with query parameters for server-side filtering
            var queryParams = new List<string>
            {
                $"includeBalance={includeBalance}"
            };

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                queryParams.Add($"search={Uri.EscapeDataString(searchTerm)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedClassification))
            {
                queryParams.Add($"classification={Uri.EscapeDataString(selectedClassification)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedAccountType))
            {
                queryParams.Add($"accountType={Uri.EscapeDataString(selectedAccountType)}");
            }

            var url = $"api/ChartOfAccountsReport?{string.Join("&", queryParams)}";
            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                filteredAccounts = await response.Content.ReadFromJsonAsync<List<ChartOfAccountReportDto>>(jsonOptions) 
                    ?? new List<ChartOfAccountReportDto>();
            }
            else
            {
                errorMessage = $"Error loading data: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnClassificationChanged(string? value)
    {
        selectedClassification = value;
        await FilterData();
    }

    private async Task OnAccountTypeChanged(string? value)
    {
        selectedAccountType = value;
        await FilterData();
    }

    private Color GetBalanceColor(decimal balance)
    {
        if (balance > 0) return Color.Success;
        if (balance < 0) return Color.Error;
        return Color.Default;
    }

    private async Task ExportPdf()
    {
        try
        {
            SetAuthHeaders();

            // Build URL with same filters as data view
            var queryParams = new List<string>
            {
                $"includeBalance={includeBalance}"
            };

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                queryParams.Add($"search={Uri.EscapeDataString(searchTerm)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedClassification))
            {
                queryParams.Add($"classification={Uri.EscapeDataString(selectedClassification)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedAccountType))
            {
                queryParams.Add($"accountType={Uri.EscapeDataString(selectedAccountType)}");
            }

            var url = $"api/ChartOfAccountsReport/export-pdf?{string.Join("&", queryParams)}";
            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = response.Content.Headers.ContentDisposition?.FileName?.Trim('"') 
                    ?? $"Chart_of_Accounts_{DateTime.UtcNow:yyyyMMdd}.pdf";
                
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, 
                    Convert.ToBase64String(fileBytes));
                
                Snackbar.Add("PDF exported successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error exporting PDF: {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            SetAuthHeaders();

            // Build URL with same filters as data view
            var queryParams = new List<string>
            {
                $"includeBalance={includeBalance}"
            };

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                queryParams.Add($"search={Uri.EscapeDataString(searchTerm)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedClassification))
            {
                queryParams.Add($"classification={Uri.EscapeDataString(selectedClassification)}");
            }

            if (!string.IsNullOrWhiteSpace(selectedAccountType))
            {
                queryParams.Add($"accountType={Uri.EscapeDataString(selectedAccountType)}");
            }

            var url = $"api/ChartOfAccountsReport/export-excel?{string.Join("&", queryParams)}";
            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = response.Content.Headers.ContentDisposition?.FileName?.Trim('"') 
                    ?? $"Chart_of_Accounts_{DateTime.UtcNow:yyyyMMdd}.xlsx";
                
                await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, 
                    Convert.ToBase64String(fileBytes));
                
                Snackbar.Add("Excel exported successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error exporting Excel: {response.ReasonPhrase}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting Excel: {ex.Message}", Severity.Error);
        }
    }

    private class ChartOfAccountReportDto
    {
        public Guid Id { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public string Classification { get; set; } = "";
        public bool IsActive { get; set; }
        public decimal? DebitBalance { get; set; }
        public decimal? CreditBalance { get; set; }
        public decimal? NetBalance { get; set; }
    }

    private class ClassificationDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
    }
}

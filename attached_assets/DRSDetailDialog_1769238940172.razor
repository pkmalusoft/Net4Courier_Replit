@using MudBlazor
@using Web.Services
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (isLoading)
        {
            <MudProgressCircular Indeterminate="true" Class="d-flex mx-auto my-4" />
        }
        else if (drsDetail == null)
        {
            <MudAlert Severity="Severity.Warning">DRS details not found</MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">DRS Information</MudText>
                        <MudStack Spacing="1">
                            <MudText><strong>DRS Number:</strong> @drsDetail.DRSNumber</MudText>
                            <MudText><strong>Date:</strong> @drsDetail.DRSDate.ToString("dd-MMM-yyyy")</MudText>
                            <MudText><strong>Status:</strong> <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetStatusColor(drsDetail.Status)">@drsDetail.Status</MudChip></MudText>
                            <MudText><strong>Hub:</strong> @(drsDetail.HubName ?? "N/A")</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Driver/Agent Details</MudText>
                        <MudStack Spacing="1">
                            <MudText><strong>Driver:</strong> @(drsDetail.DriverName ?? "N/A")</MudText>
                            <MudText><strong>Agent:</strong> @(drsDetail.AgentName ?? "N/A")</MudText>
                            <MudText><strong>Vehicle:</strong> @(drsDetail.VehicleNumber ?? "N/A")</MudText>
                            <MudText><strong>Dispatch Time:</strong> @(drsDetail.DispatchTime?.ToString("dd-MMM-yyyy HH:mm") ?? "Not dispatched")</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Summary</MudText>
                        <MudGrid>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Primary">@drsDetail.TotalShipments</MudText>
                                    <MudText Typo="Typo.caption">Total</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Success">@drsDetail.DeliveredCount</MudText>
                                    <MudText Typo="Typo.caption">Delivered</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Error">@drsDetail.FailedCount</MudText>
                                    <MudText Typo="Typo.caption">Failed</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Warning">@drsDetail.PendingCount</MudText>
                                    <MudText Typo="Typo.caption">Pending</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Info">@drsDetail.TotalCODExpected.ToString("N2")</MudText>
                                    <MudText Typo="Typo.caption">COD Expected</MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Color="Color.Success">@drsDetail.TotalCODCollected.ToString("N2")</MudText>
                                    <MudText Typo="Typo.caption">COD Collected</MudText>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Shipments</MudText>
                    <MudDataGrid T="DRSItemDto" Items="@drsDetail.Items" Dense="true" Hover="true">
                        <Columns>
                            <PropertyColumn Property="x => x.Sequence" Title="#" />
                            <PropertyColumn Property="x => x.AWBNumber" Title="AWB Number" />
                            <PropertyColumn Property="x => x.ReceiverName" Title="Receiver" />
                            <PropertyColumn Property="x => x.ReceiverCity" Title="City" />
                            <TemplateColumn Title="COD">
                                <CellTemplate>
                                    @context.Item.CODAmount.ToString("N2")
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Status">
                                <CellTemplate>
                                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetItemStatusColor(context.Item.Status)">
                                        @context.Item.Status
                                    </MudChip>
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                    </MudDataGrid>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] public Guid DRSId { get; set; }
    [Parameter] public string DRSNumber { get; set; } = "";
    
    private DRSDetailDto? drsDetail;
    private bool isLoading = true;

    private void SetAuthHeaders()
    {
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
        if (!string.IsNullOrEmpty(tenantId))
        {
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDetails();
    }

    private async Task LoadDetails()
    {
        isLoading = true;
        try
        {
            SetAuthHeaders();
            drsDetail = await Http.GetFromJsonAsync<DRSDetailDto>($"api/courier/drs/{DRSId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading DRS details: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetStatusColor(string status) => status switch
    {
        "Open" or "Draft" => Color.Info,
        "InProgress" or "Dispatched" => Color.Warning,
        "Completed" => Color.Success,
        "Reconciled" => Color.Default,
        _ => Color.Default
    };

    private Color GetItemStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "Delivered" => Color.Success,
        "Failed" or "Undelivered" => Color.Error,
        "Partial" => Color.Warning,
        _ => Color.Default
    };

    public class DRSDetailDto
    {
        public Guid Id { get; set; }
        public string DRSNumber { get; set; } = "";
        public DateTime DRSDate { get; set; }
        public string? HubName { get; set; }
        public string? DriverName { get; set; }
        public string? AgentName { get; set; }
        public string? VehicleNumber { get; set; }
        public string Status { get; set; } = "";
        public int TotalShipments { get; set; }
        public int DeliveredCount { get; set; }
        public int FailedCount { get; set; }
        public int PendingCount { get; set; }
        public decimal TotalCODExpected { get; set; }
        public decimal TotalCODCollected { get; set; }
        public DateTime? DispatchTime { get; set; }
        public DateTime? ReturnTime { get; set; }
        public bool IsReconciled { get; set; }
        public List<DRSItemDto> Items { get; set; } = new();
    }

    public class DRSItemDto
    {
        public Guid Id { get; set; }
        public Guid ShipmentId { get; set; }
        public int Sequence { get; set; }
        public string AWBNumber { get; set; } = "";
        public string? ReceiverName { get; set; }
        public string? ReceiverCity { get; set; }
        public decimal CODAmount { get; set; }
        public string Status { get; set; } = "";
    }
}

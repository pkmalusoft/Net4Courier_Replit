@page "/reports/account-ledger-summary"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Account Ledger - Summary</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-SelectedValues="selectedAccountIds" 
                           Label="Select Account(s)" 
                           T="Guid"
                           MultiSelection="true"
                           MultiSelectionTextFunc="@(new Func<List<string>, string>(GetSelectedAccountsText))"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var account in accounts)
                    {
                        <MudSelectItem Value="@account.Id">
                            @account.FullName
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          Disabled="@(!selectedAccountIds.Any())"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
        @if (selectedAccountIds.Any())
        {
            <MudGrid Class="mt-3">
                <MudItem xs="12">
                    <MudChipSet T="Guid">
                        @foreach (var accountId in selectedAccountIds)
                        {
                            var account = accounts.FirstOrDefault(a => a.Id == accountId);
                            if (account != null)
                            {
                                <MudChip T="Guid" 
                                         Color="Color.Primary" 
                                         Size="MudBlazor.Size.Small"
                                         OnClose="@(() => RemoveAccount(accountId))">
                                    @account.FullName
                                </MudChip>
                            }
                        }
                    </MudChipSet>
                </MudItem>
            </MudGrid>
        }
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">Account Summary</MudText>
                    <MudText Typo="Typo.caption">
                        Period: @reportResult.PeriodStart.ToString("dd MMM yyyy") - @reportResult.PeriodEnd.ToString("dd MMM yyyy")
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @reportResult.Items.Count account(s) displayed
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Total Opening</MudText>
                            <MudText Typo="Typo.h6" Style="@(reportResult.TotalOpeningBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @reportResult.TotalOpeningBalance.ToString("N2")
                            </MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Debit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@reportResult.TotalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Credit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@reportResult.TotalCredit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Total Closing</MudText>
                            <MudText Typo="Typo.h6" Style="@(reportResult.TotalClosingBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @reportResult.TotalClosingBalance.ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4">
            @if (reportResult.Items.Any())
            {
                <MudTable Items="@reportResult.Items" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh>Account Code</MudTh>
                        <MudTh>Account Name</MudTh>
                        <MudTh Style="text-align: right;">Opening Balance</MudTh>
                        <MudTh Style="text-align: right;">Debit</MudTh>
                        <MudTh Style="text-align: right;">Credit</MudTh>
                        <MudTh Style="text-align: right;">Closing Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Account Code">
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.AccountCode</MudText>
                        </MudTd>
                        <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                        <MudTd DataLabel="Opening Balance" Style="text-align: right;">
                            <span style="@(context.OpeningBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @context.OpeningBalance.ToString("N2")
                            </span>
                        </MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            @if (context.PeriodDebit > 0)
                            {
                                <span style="color: var(--mud-palette-error);">@context.PeriodDebit.ToString("N2")</span>
                            }
                            else
                            {
                                <span>0.00</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            @if (context.PeriodCredit > 0)
                            {
                                <span style="color: var(--mud-palette-success);">@context.PeriodCredit.ToString("N2")</span>
                            }
                            else
                            {
                                <span>0.00</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Closing Balance" Style="text-align: right; font-weight: bold;">
                            <span style="@(context.ClosingBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @context.ClosingBalance.ToString("N2")
                            </span>
                        </MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTd colspan="2" Style="font-weight: bold;">Grand Total</MudTd>
                        <MudTd Style="text-align: right; font-weight: bold;">
                            <span style="@(reportResult.TotalOpeningBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @reportResult.TotalOpeningBalance.ToString("N2")
                            </span>
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; color: var(--mud-palette-error);">
                            @reportResult.TotalDebit.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; color: var(--mud-palette-success);">
                            @reportResult.TotalCredit.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold;">
                            <span style="@(reportResult.TotalClosingBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @reportResult.TotalClosingBalance.ToString("N2")
                            </span>
                        </MudTd>
                    </FooterContent>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No data found for the selected accounts and period.</MudAlert>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<AccountDropdownDto> accounts = new();
    private IEnumerable<Guid> selectedAccountIds = new List<Guid>();
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private bool isLoading = false;
    private AccountLedgerSummaryResultDto? reportResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
    }

    private string GetSelectedAccountsText(List<string> selectedValues)
    {
        var count = selectedAccountIds.Count();
        return count switch
        {
            0 => "Select Account(s)",
            1 => accounts.FirstOrDefault(a => selectedAccountIds.Contains(a.Id))?.FullName ?? "1 account",
            _ => $"{count} accounts selected"
        };
    }

    private void RemoveAccount(Guid accountId)
    {
        selectedAccountIds = selectedAccountIds.Where(id => id != accountId).ToList();
    }

    private async Task LoadAccounts()
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "api/AccountLedger/accounts");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                accounts = await response.Content.ReadFromJsonAsync<List<AccountDropdownDto>>() ?? new();
            }
            else
            {
                Snackbar.Add("Failed to load accounts", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading accounts: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadReport()
    {
        if (!selectedAccountIds.Any())
        {
            Snackbar.Add("Please select at least one account", Severity.Warning);
            return;
        }

        isLoading = true;
        reportResult = null;

        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var requestBody = new AccountLedgerRequestDto
            {
                AccountIds = selectedAccountIds.ToList(),
                Year = selectedYear,
                Month = selectedMonth
            };

            var request = new HttpRequestMessage(HttpMethod.Post, "api/AccountLedger/summary");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);
            request.Content = JsonContent.Create(requestBody);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<AccountLedgerSummaryResultDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedAccountIds = new List<Guid>();
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        reportResult = null;
    }

    public class AccountDropdownDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }

    public class AccountLedgerRequestDto
    {
        public List<Guid> AccountIds { get; set; } = new();
        public int? Year { get; set; }
        public int? Month { get; set; }
    }

    public class AccountLedgerSummaryItemDto
    {
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = string.Empty;
        public string AccountName { get; set; } = string.Empty;
        public decimal OpeningBalance { get; set; }
        public decimal PeriodDebit { get; set; }
        public decimal PeriodCredit { get; set; }
        public decimal ClosingBalance { get; set; }
    }

    public class AccountLedgerSummaryResultDto
    {
        public DateTime PeriodStart { get; set; }
        public DateTime PeriodEnd { get; set; }
        public decimal TotalOpeningBalance { get; set; }
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public decimal TotalClosingBalance { get; set; }
        public List<AccountLedgerSummaryItemDto> Items { get; set; } = new();
    }
}

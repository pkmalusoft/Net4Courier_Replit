@page "/courier/drs"
@layout MainLayout
@using Web.Models
@using Web.Services
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Delivery Run Sheet (DRS) Management</MudText>
    
    <MudPaper Class="pa-4 mb-4" Style="overflow: visible;">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="8">
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Style="flex-wrap: wrap; gap: 8px;">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="GenerateNewDRS">
                        Generate DRS
                    </MudButton>
                    <MudDatePicker Date="@fromDate" Label="From Date" 
                                  Variant="Variant.Outlined" Style="width: 140px;"
                                  DateFormat="dd-MMM-yyyy"
                                  DateChanged="@(async (DateTime? val) => { fromDate = val; await OnDateRangeChanged(); })" />
                    <MudDatePicker Date="@toDate" Label="To Date" 
                                  Variant="Variant.Outlined" Style="width: 140px;"
                                  DateFormat="dd-MMM-yyyy"
                                  DateChanged="@(async (DateTime? val) => { toDate = val; await OnDateRangeChanged(); })" />
                    <MudSelect T="string?" Value="filterStatus" Label="Status" 
                              Variant="Variant.Outlined" Style="width: 130px;" Clearable="true"
                              ValueChanged="@(async (string? val) => { filterStatus = val; await LoadData(); })">
                        <MudSelectItem T="string?" Value="@("Open")">Open</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("InProgress")">In Progress</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Completed")">Completed</MudSelectItem>
                        <MudSelectItem T="string?" Value="@("Reconciled")">Reconciled</MudSelectItem>
                    </MudSelect>
                    <MudSelect T="Guid?" Value="selectedDeliveryAgent" Label="Agent" 
                              Variant="Variant.Outlined" Style="width: 160px;" Clearable="true"
                              ValueChanged="@(async (Guid? val) => { selectedDeliveryAgent = val; await LoadData(); })">
                        @foreach (var agent in deliveryAgents)
                        {
                            <MudSelectItem T="Guid?" Value="@agent.Id">@agent.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="searchText" Label="Search DRS # or Agent" 
                             Variant="Variant.Outlined" 
                             FullWidth="true"
                             Placeholder="Enter DRS number or agent name..."
                             Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                             AdornmentColor="Color.Primary"
                             OnAdornmentClick="@(async () => await LoadData())"
                             OnKeyUp="@(async (e) => { if (e.Key == "Enter") await LoadData(); })"
                             Immediate="true" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid Class="mb-4">
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.TotalDRS</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Total DRS</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.ListAlt" Size="MudBlazor.Size.Large" Color="Color.Primary" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.OpenDRS</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Open DRS</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="MudBlazor.Size.Large" Color="Color.Warning" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.DeliveredCount</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Delivered</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="MudBlazor.Size.Large" Color="Color.Success" />
                    </MudStack>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-3" Elevation="1">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@summary.PendingCOD.ToString("C")</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Pending COD</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="MudBlazor.Size.Large" Color="Color.Info" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudDataGrid T="DRSListItem" 
                     Items="@items" 
                     Filterable="true"
                     SortMode="SortMode.Multiple"
                     Dense="true"
                     Hover="true"
                     RowClick="@(e => ViewDRS(e.Item))">
            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Class="pa-4">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="MudBlazor.Size.Large" Color="Color.Default" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">No DRS records found</MudText>
                    @if (!string.IsNullOrWhiteSpace(searchText))
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            No results match "@searchText". Try a different search term.
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Try adjusting the filters or date range.
                        </MudText>
                    }
                </MudStack>
            </NoRecordsContent>
            <Columns>
                <PropertyColumn Property="x => x.DRSNumber" Title="DRS Number" />
                <TemplateColumn Title="Date">
                    <CellTemplate>
                        @context.Item.DRSDate.ToString("dd-MMM-yyyy")
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.DeliveryAgentName" Title="Delivery Agent" />
                <PropertyColumn Property="x => x.TotalShipments" Title="Shipments" />
                <PropertyColumn Property="x => x.DeliveredCount" Title="Delivered" />
                <PropertyColumn Property="x => x.UndeliveredCount" Title="Undelivered" />
                <TemplateColumn Title="COD Collected">
                    <CellTemplate>
                        @context.Item.CollectedCODAmount.ToString("N2")
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        <MudChip T="string" Size="MudBlazor.Size.Small" 
                                Color="@GetStatusColor(context.Item.Status)">
                            @context.Item.Status
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="0" @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                          Color="Color.Primary" 
                                          Size="MudBlazor.Size.Small"
                                          OnClick="@(() => ViewDRS(context.Item))" />
                            @if (context.Item.Status == "Open" || context.Item.Status == "InProgress")
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                              Color="Color.Info" 
                                              Size="MudBlazor.Size.Small"
                                              OnClick="@(() => UpdateDRS(context.Item))" />
                            }
                            @if (context.Item.Status == "Completed")
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.AccountBalance" 
                                              Color="Color.Success" 
                                              Size="MudBlazor.Size.Small"
                                              OnClick="@(() => ReconcileDRS(context.Item))" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Print" 
                                          Color="Color.Default" 
                                          Size="MudBlazor.Size.Small"
                                          OnClick="@(() => PrintDRS(context.Item))" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudContainer>

<MudDialog @bind-Visible="showGenerateDRSDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">Generate New DRS</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudDatePicker @bind-Date="newDrsDate" Label="DRS Date" Variant="Variant.Outlined" />
            <MudSelect T="Guid?" @bind-Value="newDrsAgentId" Label="Delivery Agent *" Variant="Variant.Outlined">
                @foreach (var agent in deliveryAgents)
                {
                    <MudSelectItem T="Guid?" Value="@agent.Id">@agent.Name</MudSelectItem>
                }
            </MudSelect>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                This will generate a DRS with all pending deliveries for the selected agent.
            </MudText>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => showGenerateDRSDialog = false)">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateDRS">Generate</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<DRSListItem> items = new();
    private List<AgentItem> deliveryAgents = new();
    private DRSSummary summary = new();
    private bool isLoading = true;
    private DateTime? fromDate = DateTime.UtcNow.Date.AddDays(-7);
    private DateTime? toDate = DateTime.UtcNow.Date;
    private string? filterStatus;
    private Guid? selectedDeliveryAgent;
    private string? searchText;
    
    private bool showGenerateDRSDialog = false;
    private DateTime? newDrsDate = DateTime.UtcNow.Date;
    private Guid? newDrsAgentId;

    private void SetAuthHeaders()
    {
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
        if (!string.IsNullOrEmpty(tenantId))
        {
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAgents();
        await LoadData();
    }

    private async Task LoadAgents()
    {
        try
        {
            SetAuthHeaders();
            deliveryAgents = await Http.GetFromJsonAsync<List<AgentItem>>("api/courier/agents?isDeliveryAgent=true") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading agents: {ex.Message}", Severity.Error);
        }
    }

    private bool IsDateRangeValid()
    {
        if (fromDate.HasValue && toDate.HasValue && fromDate.Value > toDate.Value)
            return false;
        return true;
    }

    private async Task OnDateRangeChanged()
    {
        if (!IsDateRangeValid())
        {
            Snackbar.Add("Invalid date range: 'From Date' cannot be after 'To Date'", Severity.Warning);
            return;
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        if (!IsDateRangeValid())
        {
            Snackbar.Add("Invalid date range: 'From Date' cannot be after 'To Date'", Severity.Warning);
            return;
        }
        
        isLoading = true;
        try
        {
            SetAuthHeaders();
            var url = "api/courier/drs";
            var queryParams = new List<string>();
            if (fromDate.HasValue)
                queryParams.Add($"fromDate={fromDate.Value:yyyy-MM-dd}");
            if (toDate.HasValue)
                queryParams.Add($"toDate={toDate.Value:yyyy-MM-dd}");
            if (!string.IsNullOrEmpty(filterStatus))
                queryParams.Add($"status={filterStatus}");
            if (selectedDeliveryAgent.HasValue)
                queryParams.Add($"deliveryAgentId={selectedDeliveryAgent}");
            if (!string.IsNullOrWhiteSpace(searchText))
                queryParams.Add($"search={Uri.EscapeDataString(searchText.Trim())}");
            if (queryParams.Any())
                url += "?" + string.Join("&", queryParams);

            items = await Http.GetFromJsonAsync<List<DRSListItem>>(url) ?? new();
            
            summary = new DRSSummary
            {
                TotalDRS = items.Count,
                OpenDRS = items.Count(x => x.Status == "Open" || x.Status == "InProgress"),
                DeliveredCount = items.Sum(x => x.DeliveredCount),
                PendingCOD = items.Where(x => x.Status != "Reconciled").Sum(x => x.CollectedCODAmount)
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading DRS: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GenerateNewDRS()
    {
        newDrsDate = DateTime.UtcNow.Date;
        newDrsAgentId = null;
        showGenerateDRSDialog = true;
    }

    private async Task CreateDRS()
    {
        if (!newDrsAgentId.HasValue)
        {
            Snackbar.Add("Please select a delivery agent", Severity.Warning);
            return;
        }

        try
        {
            SetAuthHeaders();
            var response = await Http.PostAsJsonAsync("api/courier/drs/generate", new
            {
                DrsDate = newDrsDate,
                DeliveryAgentId = newDrsAgentId
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<DRSCreateResult>();
                Snackbar.Add($"DRS {result?.DrsNumber} created with {result?.ShipmentCount} shipments", Severity.Success);
                showGenerateDRSDialog = false;
                await LoadData();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to create DRS: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating DRS: {ex.Message}", Severity.Error);
        }
    }

    private async Task ViewDRS(DRSListItem item)
    {
        await ShowDRSDetails(item);
    }

    private async Task UpdateDRS(DRSListItem item)
    {
        await ShowDRSDetails(item);
    }
    
    private async Task ShowDRSDetails(DRSListItem item)
    {
        var parameters = new DialogParameters<DRSDetailDialog>
        {
            { x => x.DRSId, item.Id },
            { x => x.DRSNumber, item.DRSNumber }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true, CloseButton = true };
        await DialogService.ShowAsync<DRSDetailDialog>($"DRS: {item.DRSNumber}", parameters, options);
    }

    private async Task ReconcileDRS(DRSListItem item)
    {
        try
        {
            SetAuthHeaders();
            var response = await Http.PostAsync($"api/courier/drs/{item.Id}/reconcile", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("DRS reconciled successfully", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Failed to reconcile DRS", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void PrintDRS(DRSListItem item)
    {
        Snackbar.Add("Print functionality will be implemented", Severity.Info);
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Open" => Color.Info,
        "InProgress" => Color.Warning,
        "Completed" => Color.Success,
        "Reconciled" => Color.Default,
        _ => Color.Default
    };

    public class DRSListItem
    {
        public Guid Id { get; set; }
        public string DRSNumber { get; set; } = "";
        public DateTime DRSDate { get; set; }
        public string? AgentName { get; set; }
        public string? DriverName { get; set; }
        public int TotalShipments { get; set; }
        public int DeliveredCount { get; set; }
        public int FailedCount { get; set; }
        public int PendingCount { get; set; }
        public decimal TotalCODExpected { get; set; }
        public decimal TotalCODCollected { get; set; }
        public string Status { get; set; } = "";
        
        public string DeliveryAgentName => AgentName ?? DriverName ?? "";
        public int UndeliveredCount => TotalShipments - DeliveredCount;
        public decimal CollectedCODAmount => TotalCODCollected;
    }

    public class AgentItem
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
    }

    public class DRSSummary
    {
        public int TotalDRS { get; set; }
        public int OpenDRS { get; set; }
        public int DeliveredCount { get; set; }
        public decimal PendingCOD { get; set; }
    }

    public class DRSCreateResult
    {
        public Guid Id { get; set; }
        public string DrsNumber { get; set; } = "";
        public int ShipmentCount { get; set; }
    }
}

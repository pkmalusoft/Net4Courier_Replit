@page "/reports/trial-balance-monthly"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Trial Balance - Month-wise</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                <MudText Typo="Typo.subtitle1">
                    Year: @reportResult.Year
                </MudText>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                    @reportResult.Items.Count accounts with activity
                </MudText>
            </MudStack>

            <div style="overflow-x: auto;">
                <MudTable Items="@reportResult.Items" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh Style="width: 80px; position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1">Code</MudTh>
                        <MudTh Style="width: 180px; position: sticky; left: 80px; background: var(--mud-palette-surface); z-index: 1">Account</MudTh>
                        <MudTh Style="width: 100px; text-align: right">Opening</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Jan</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Feb</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Mar</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Apr</MudTh>
                        <MudTh Style="width: 90px; text-align: right">May</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Jun</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Jul</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Aug</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Sep</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Oct</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Nov</MudTh>
                        <MudTh Style="width: 90px; text-align: right">Dec</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Code" Style="position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1">
                            @context.AccountCode
                        </MudTd>
                        <MudTd DataLabel="Account" Style="position: sticky; left: 80px; background: var(--mud-palette-surface); z-index: 1">
                            <MudTooltip Text="@context.AccountName">
                                <MudText Style="max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap">
                                    @context.AccountName
                                </MudText>
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Opening" Style="text-align: right">
                            @FormatBalance(context.OpeningBalance)
                        </MudTd>
                        <MudTd DataLabel="Jan" Style="text-align: right">@FormatBalance(context.Month1)</MudTd>
                        <MudTd DataLabel="Feb" Style="text-align: right">@FormatBalance(context.Month2)</MudTd>
                        <MudTd DataLabel="Mar" Style="text-align: right">@FormatBalance(context.Month3)</MudTd>
                        <MudTd DataLabel="Apr" Style="text-align: right">@FormatBalance(context.Month4)</MudTd>
                        <MudTd DataLabel="May" Style="text-align: right">@FormatBalance(context.Month5)</MudTd>
                        <MudTd DataLabel="Jun" Style="text-align: right">@FormatBalance(context.Month6)</MudTd>
                        <MudTd DataLabel="Jul" Style="text-align: right">@FormatBalance(context.Month7)</MudTd>
                        <MudTd DataLabel="Aug" Style="text-align: right">@FormatBalance(context.Month8)</MudTd>
                        <MudTd DataLabel="Sep" Style="text-align: right">@FormatBalance(context.Month9)</MudTd>
                        <MudTd DataLabel="Oct" Style="text-align: right">@FormatBalance(context.Month10)</MudTd>
                        <MudTd DataLabel="Nov" Style="text-align: right">@FormatBalance(context.Month11)</MudTd>
                        <MudTd DataLabel="Dec" Style="text-align: right">@FormatBalance(context.Month12)</MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTFootRow>
                            <MudTd Style="position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1">
                                <strong>Debit Total</strong>
                            </MudTd>
                            <MudTd Style="position: sticky; left: 80px; background: var(--mud-palette-surface); z-index: 1"></MudTd>
                            <MudTd Style="text-align: right; color: green">
                                <strong>@FormatBalance(reportResult.OpeningDebitTotal)</strong>
                            </MudTd>
                            @for (int i = 0; i < 12; i++)
                            {
                                var idx = i;
                                <MudTd Style="text-align: right; color: green">
                                    <strong>@FormatBalance(reportResult.MonthlyDebitTotals.ElementAtOrDefault(idx))</strong>
                                </MudTd>
                            }
                        </MudTFootRow>
                        <MudTFootRow>
                            <MudTd Style="position: sticky; left: 0; background: var(--mud-palette-surface); z-index: 1">
                                <strong>Credit Total</strong>
                            </MudTd>
                            <MudTd Style="position: sticky; left: 80px; background: var(--mud-palette-surface); z-index: 1"></MudTd>
                            <MudTd Style="text-align: right; color: red">
                                <strong>@FormatBalance(reportResult.OpeningCreditTotal)</strong>
                            </MudTd>
                            @for (int i = 0; i < 12; i++)
                            {
                                var idx = i;
                                <MudTd Style="text-align: right; color: red">
                                    <strong>@FormatBalance(reportResult.MonthlyCreditTotals.ElementAtOrDefault(idx))</strong>
                                </MudTd>
                            }
                        </MudTFootRow>
                    </FooterContent>
                </MudTable>
            </div>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a year and click Generate to view the Trial Balance with month-wise columns.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private int selectedYear = DateTime.Now.Year;
    private bool isLoading = false;
    private TrialBalanceMonthlyResult? reportResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportResult = null;
        StateHasChanged();

        try
        {
            var request = CreateAuthenticatedRequest(HttpMethod.Post, "api/trialbalance/monthly");
            request.Content = JsonContent.Create(new
            {
                Year = selectedYear
            });

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<TrialBalanceMonthlyResult>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedYear = DateTime.Now.Year;
        reportResult = null;
    }

    private string FormatBalance(decimal value)
    {
        if (value == 0) return "-";
        return value.ToString("N2");
    }

    private HttpRequestMessage CreateAuthenticatedRequest(HttpMethod method, string uri)
    {
        var request = new HttpRequestMessage(method, uri);
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        
        if (!string.IsNullOrEmpty(token))
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        if (!string.IsNullOrEmpty(tenantId))
            request.Headers.Add("X-Tenant-Id", tenantId);
        
        return request;
    }

    private class TrialBalanceMonthlyResult
    {
        public string ReportType { get; set; } = "";
        public int Year { get; set; }
        public List<TrialBalanceMonthlyItem> Items { get; set; } = new();
        public List<decimal> MonthlyTotals { get; set; } = new();
        public List<decimal> MonthlyDebitTotals { get; set; } = new();
        public List<decimal> MonthlyCreditTotals { get; set; } = new();
        public decimal OpeningDebitTotal { get; set; }
        public decimal OpeningCreditTotal { get; set; }
    }

    private class TrialBalanceMonthlyItem
    {
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public decimal OpeningBalance { get; set; }
        public decimal Month1 { get; set; }
        public decimal Month2 { get; set; }
        public decimal Month3 { get; set; }
        public decimal Month4 { get; set; }
        public decimal Month5 { get; set; }
        public decimal Month6 { get; set; }
        public decimal Month7 { get; set; }
        public decimal Month8 { get; set; }
        public decimal Month9 { get; set; }
        public decimal Month10 { get; set; }
        public decimal Month11 { get; set; }
        public decimal Month12 { get; set; }
        public bool HasActivity { get; set; }
    }
}

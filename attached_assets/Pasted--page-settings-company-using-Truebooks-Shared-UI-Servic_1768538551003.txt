@page "/settings/company"

@using Truebooks.Shared.UI.Services
@using Truebooks.Shared.UI.Components
@using Truebooks.Platform.Contracts.Enums.Common
@using System.Text.Json
@using Microsoft.Extensions.Logging
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject JsonSerializerOptions JsonOptions
@inject NavigationManager Navigation
@inject ILogger<CompanySettings> Logger

<PageTitle>Company Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Company Profile</MudText>
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }
    else if (loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="pa-4">
            <!-- Locked Fields Warning -->
            @if (settings.IsFieldsLocked)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4" Icon="@Icons.Material.Filled.Lock">
                    <strong>Note:</strong> Company Name @(settings.IsGSTINLocked ? "and Tax ID (GSTIN)" : "") 
                    cannot be changed because transactions exist in the system.
                </MudAlert>
            }
            
            <MudForm @ref="form" @bind-IsValid="@isValid">
                <MudGrid>
                    <!-- Company Name with Lock Icon -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="settings.Name" 
                                      Label="Company Name" 
                                      Required="true"
                                      Immediate="true"
                                      Disabled="@settings.IsFieldsLocked"
                                      Variant="Variant.Outlined"
                                      Adornment="@(settings.IsFieldsLocked ? Adornment.End : Adornment.None)"
                                      AdornmentIcon="@(settings.IsFieldsLocked ? Icons.Material.Filled.Lock : null)" />
                    </MudItem>

                    <!-- Multi-line Address -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="settings.Address" 
                                      Label="Address" 
                                      Lines="3"
                                      Immediate="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <!-- Location Selector Component (Cascading Dropdowns) -->
                    <MudItem xs="12">
                        <LocationSelector 
                            SelectedCountryId="@settings.CountryId"
                            SelectedCountryIdChanged="@(v => settings.CountryId = v)"
                            SelectedStateId="@settings.StateId"
                            SelectedStateIdChanged="@(v => settings.StateId = v)"
                            SelectedCityId="@settings.CityId"
                            SelectedCityIdChanged="@(v => settings.CityId = v)"
                            SelectedPostalCodeId="@settings.PostalCodeId"
                            SelectedPostalCodeIdChanged="@(v => settings.PostalCodeId = v)"
                            CountryNameChanged="@((name) => settings.Country = name)"
                            StateNameChanged="@((name) => settings.State = name)"
                            CityNameChanged="@((name) => settings.City = name)"
                            PostalCodeChanged="@((code) => settings.PostalCode = code)"
                            ShowInTwoColumns="true"
                            Disabled="false"
                            SetAuthHeaders="@SetAuthHeaders" />
                    </MudItem>

                    <!-- Currency Dropdown -->
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="settings.BaseCurrencyId" 
                                   Label="Base Currency" 
                                   Variant="Variant.Outlined"
                                   HelperText="Default currency for transactions"
                                   T="Guid?">
                            <MudSelectItem Value="@((Guid?)null)">-- Select Currency --</MudSelectItem>
                            @foreach (var currency in currencies)
                            {
                                <MudSelectItem Value="@((Guid?)currency.Id)">
                                    @currency.Code - @currency.Name (@currency.Symbol)
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- Section Divider -->
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Tax Configuration</MudText>
                    </MudItem>

                    <!-- Tax System Dropdown -->
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="settings.TaxSystem" 
                                   Label="Tax System" 
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   HelperText="Select the tax system for your region"
                                   T="TaxSystemType">
                            <MudSelectItem Value="TaxSystemType.GST">GST (India)</MudSelectItem>
                            <MudSelectItem Value="TaxSystemType.VAT">VAT (UAE)</MudSelectItem>
                            <MudSelectItem Value="TaxSystemType.USSalesTax">US Sales Tax (USA)</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Conditional Tax ID Fields -->
                    @if (settings.TaxSystem == TaxSystemType.GST)
                    {
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="settings.GSTIN" 
                                          Label="GSTIN (Tax ID)" 
                                          Variant="Variant.Outlined"
                                          MaxLength="15"
                                          Immediate="true"
                                          Disabled="@settings.IsGSTINLocked"
                                          Adornment="@(settings.IsGSTINLocked ? Adornment.End : Adornment.None)"
                                          AdornmentIcon="@(settings.IsGSTINLocked ? Icons.Material.Filled.Lock : null)"
                                          HelperText="@(settings.IsGSTINLocked ? "Locked - transactions exist" : "GST Identification Number (15 characters)")" />
                        </MudItem>
                    }
                    else if (settings.TaxSystem == TaxSystemType.VAT)
                    {
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="settings.TRN" 
                                          Label="TRN (Tax Registration Number)" 
                                          Variant="Variant.Outlined"
                                          MaxLength="20"
                                          Immediate="true"
                                          HelperText="UAE VAT Registration Number" />
                        </MudItem>
                    }
                    else if (settings.TaxSystem == TaxSystemType.USSalesTax)
                    {
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="settings.EIN" 
                                          Label="EIN (Employer Identification Number)" 
                                          Variant="Variant.Outlined"
                                          MaxLength="20"
                                          Immediate="true"
                                          HelperText="Federal Tax ID (XX-XXXXXXX format)" />
                        </MudItem>
                    }

                    <!-- Tax Rules Info Panel -->
                    <MudItem xs="12" Class="mt-2">
                        @if (settings.TaxSystem == TaxSystemType.GST)
                        {
                            <MudPaper Class="pa-3" Elevation="0" 
                                      Style="background-color: var(--mud-palette-background-grey);">
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">
                                    <strong>GST Tax Calculation Rules (India):</strong>
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    • When <strong>Customer State = Company State</strong> → CGST + SGST (Intra-state)
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    • When <strong>Customer State ≠ Company State</strong> → IGST (Inter-state)
                                </MudText>
                                <MudText Typo="Typo.caption" Class="mt-2" Style="opacity: 0.7;">
                                    Example: If your company is in Maharashtra and customer is in Maharashtra → 9% CGST + 9% SGST = 18%<br/>
                                    If customer is in Delhi → 18% IGST
                                </MudText>
                            </MudPaper>
                        }
                        else if (settings.TaxSystem == TaxSystemType.VAT)
                        {
                            <MudPaper Class="pa-3" Elevation="0" 
                                      Style="background-color: var(--mud-palette-background-grey);">
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">
                                    <strong>VAT Tax System (UAE):</strong>
                                </MudText>
                                <MudText Typo="Typo.body2">• Standard VAT Rate: <strong>5%</strong></MudText>
                                <MudText Typo="Typo.body2">• Zero-rated supplies: Exports, certain food items, healthcare, education</MudText>
                                <MudText Typo="Typo.body2">• Exempt supplies: Residential property, local transportation, life insurance</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2" Style="opacity: 0.7;">
                                    TRN is required on all tax invoices. VAT returns are filed quarterly.
                                </MudText>
                            </MudPaper>
                        }
                        else if (settings.TaxSystem == TaxSystemType.USSalesTax)
                        {
                            <MudPaper Class="pa-3" Elevation="0" 
                                      Style="background-color: var(--mud-palette-background-grey);">
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">
                                    <strong>US Sales Tax System:</strong>
                                </MudText>
                                <MudText Typo="Typo.body2">• Tax rates vary by state (0% to 10%+)</MudText>
                                <MudText Typo="Typo.body2">• Nexus: You collect tax in states where you have a physical or economic presence</MudText>
                                <MudText Typo="Typo.body2">• Exemptions: Some customers (resellers, non-profits) may be tax-exempt</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2" Style="opacity: 0.7;">
                                    Configure state rates and nexus in Settings → Tax → US State Rates
                                </MudText>
                            </MudPaper>
                        }
                    </MudItem>

                    <!-- Advanced Settings Section -->
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Advanced Financial Settings</MudText>
                    </MudItem>

                    <!-- Toggle Switch with Description -->
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="0" 
                                  Style="background-color: var(--mud-palette-background-grey);">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1">
                                        <strong>Enable Multiple Financial Calendars</strong>
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Enable this if your business operates across different jurisdictions 
                                        with different fiscal years (e.g., India April-March with UAE clients on January-December).
                                    </MudText>
                                </MudStack>
                                <MudSwitch @bind-Value="settings.EnableMultipleCalendars" 
                                          Color="Color.Primary"
                                          Label="@(settings.EnableMultipleCalendars ? "Enabled" : "Disabled")" />
                            </MudStack>
                            @if (settings.EnableMultipleCalendars)
                            {
                                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                                    <MudText Typo="Typo.body2">
                                        You can now manage multiple financial calendars from <strong>Finance → Financial Calendars</strong>.
                                        Configure client-facing calendars and set up deferred revenue recognition schedules.
                                    </MudText>
                                </MudAlert>
                            }
                        </MudPaper>
                    </MudItem>

                    <!-- Action Buttons -->
                    <MudItem xs="12" Class="mt-4">
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       OnClick="Save" 
                                       Disabled="@(!isValid || saving)">
                                @if (saving)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Saving...</MudText>
                                }
                                else
                                {
                                    <MudText>Save Settings</MudText>
                                }
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Default" 
                                       OnClick="Close"
                                       Disabled="@saving">
                                Close
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    }
</MudContainer>

@code {
    private MudForm form = null!;
    private bool isValid;
    private bool loading = true;
    private bool saving;
    private string? errorMessage;
    private bool hasInitialized;
    private CompanySettingsDto settings = new();
    private List<CurrencyDto> currencies = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasInitialized)
        {
            hasInitialized = true;
            
            if (!IsAuthenticated())
            {
                errorMessage = "Please log in to access company settings.";
                loading = false;
                StateHasChanged();
                return;
            }
            
            await LoadCurrencies();
            await LoadSettings();
            StateHasChanged();
        }
    }

    private async Task LoadCurrencies()
    {
        try
        {
            SetAuthHeaders();
            var response = await Http.GetFromJsonAsync<List<CurrencyDto>>("api/Currencies", JsonOptions);
            if (response != null)
            {
                currencies = response.Where(c => c.IsActive).OrderBy(c => c.Code).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading currencies: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSettings()
    {
        loading = true;
        try
        {
            var token = AuthService.GetAccessToken();
            if (string.IsNullOrEmpty(token))
            {
                errorMessage = "Session expired. Please log in again.";
                return;
            }
            
            SetAuthHeaders();
            var response = await Http.GetFromJsonAsync<CompanySettingsDto>("api/CompanySettings", JsonOptions);
            if (response != null)
            {
                settings = response;
            }
        }
        catch (HttpRequestException ex) when (ex.Message.Contains("401"))
        {
            errorMessage = "Session expired. Please log in again.";
            Snackbar.Add("Session expired. Please log in again.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void SetAuthHeaders()
    {
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();

        if (!string.IsNullOrEmpty(token))
        {
            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }
        else
        {
            Http.DefaultRequestHeaders.Authorization = null;
        }
        
        Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
        if (!string.IsNullOrEmpty(tenantId))
        {
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);
        }
    }

    private bool IsAuthenticated()
    {
        var token = AuthService.GetAccessToken();
        return !string.IsNullOrEmpty(token);
    }

    private async Task Save()
    {
        saving = true;
        try
        {
            var token = AuthService.GetAccessToken();
            if (string.IsNullOrEmpty(token))
            {
                Snackbar.Add("Session expired. Please log in again.", Severity.Warning);
                return;
            }
            
            SetAuthHeaders();
            var response = await Http.PutAsJsonAsync("api/CompanySettings", settings, JsonOptions);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Settings saved successfully", Severity.Success);
                var tokenAfterSave = AuthService.GetAccessToken();
                if (!string.IsNullOrEmpty(tokenAfterSave))
                {
                    await LoadSettings();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to save settings: {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
        }
    }

    private void Close()
    {
        Navigation.NavigateTo("/dashboard");
    }

    // DTOs
    public class CompanySettingsDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Address { get; set; }
        public Guid? CountryId { get; set; }
        public Guid? StateId { get; set; }
        public Guid? CityId { get; set; }
        public Guid? PostalCodeId { get; set; }
        public string? Country { get; set; }
        public string? State { get; set; }
        public string? City { get; set; }
        public string? PostalCode { get; set; }
        public TaxSystemType TaxSystem { get; set; } = TaxSystemType.GST;
        public string? GSTIN { get; set; }
        public string? TRN { get; set; }
        public string? EIN { get; set; }
        public Guid? BaseCurrencyId { get; set; }
        public bool IsFieldsLocked { get; set; }
        public bool IsGSTINLocked { get; set; }
        public bool EnableMultipleCalendars { get; set; }
    }

    public class CurrencyDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Symbol { get; set; } = string.Empty;
        public bool IsActive { get; set; }
    }
}
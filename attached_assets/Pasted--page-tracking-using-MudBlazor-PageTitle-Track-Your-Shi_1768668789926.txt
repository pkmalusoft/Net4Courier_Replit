@page "/tracking"
@using MudBlazor

<PageTitle>Track Your Shipment | Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8 mb-8">
    <MudPaper Elevation="3" Class="pa-8 mb-6 text-center">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">Track Your Shipment</MudText>
        <MudText Typo="Typo.body1" Class="mb-6">Enter your AWB or Reference Number to get the latest status.</MudText>
        
        <MudGrid Justify="Justify.Center">
            <MudItem xs="12" sm="8" md="6">
                <MudTextField @bind-Value="SearchTerm" 
                              Label="Enter Tracking Number" 
                              Variant="Variant.Outlined" 
                              Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              OnAdornmentClick="TrackShipment"
                              Immediate="true"
                              OnKeyDown="@(e => { if (e.Key == "Enter") TrackShipment(); })" />
            </MudItem>
            <MudItem xs="12" sm="4" md="2" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large" 
                           OnClick="TrackShipment" 
                           FullWidth="true"
                           Disabled="@IsLoading">
                    @if (IsLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                        <MudText Class="ms-2">Searching...</MudText>
                    }
                    else
                    {
                        <MudText>Track</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (Shipment != null)
    {
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Shipment Details</MudText>
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@Shipment.AWBNo</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                             <MudChip T="string" Color="@GetStatusColor(Shipment.CurrentStatus)" Size="Size.Small">@Shipment.CurrentStatus</MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.Person">
                                <MudText Typo="Typo.caption">Sender</MudText>
                                <MudText>@Shipment.SenderName</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.PersonOutline">
                                <MudText Typo="Typo.caption">Receiver</MudText>
                                <MudText>@Shipment.ReceiverName</MudText>
                            </MudListItem>
                             <MudDivider Class="my-2"/>
                            <MudListItem Icon="@Icons.Material.Filled.Place">
                                <MudText Typo="Typo.caption">Origin</MudText>
                                <MudText>@Shipment.Origin</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Flag">
                                <MudText Typo="Typo.caption">Destination</MudText>
                                <MudText>@Shipment.Destination</MudText>
                            </MudListItem>
                            <MudDivider Class="my-2"/>
                             <MudListItem Icon="@Icons.Material.Filled.Scale">
                                <MudText Typo="Typo.caption">Weight / Pieces</MudText>
                                <MudText>@Shipment.Weight kg / @Shipment.Pieces pcs</MudText>
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="8">
                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                             <MudText Typo="Typo.h6">Tracking History</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudTimeline TimelinePosition="TimelinePosition.Start">
                            @foreach (var eventItem in Shipment.History)
                            {
                                <MudTimelineItem Color="@GetEventColor(eventItem.Status)" Size="Size.Small">
                                    <ItemOpposite>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @eventItem.Date.ToShortDateString()
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="display:block">
                                            @eventItem.Date.ToShortTimeString()
                                        </MudText>
                                    </ItemOpposite>
                                    <ItemContent>
                                        <MudText Typo="Typo.subtitle2">@eventItem.Status</MudText>
                                        <MudText Typo="Typo.body2">@eventItem.Location</MudText>
                                        @if (!string.IsNullOrEmpty(eventItem.Remarks))
                                        {
                                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@eventItem.Remarks</MudText>
                                        }
                                    </ItemContent>
                                </MudTimelineItem>
                            }
                        </MudTimeline>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
    else if (HasSearched && !IsLoading)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-4">
            No shipment found with tracking number <strong>@SearchTerm</strong>. Please check and try again.
        </MudAlert>
    }
</MudContainer>

@code {
    private string SearchTerm { get; set; } = "";
    private bool IsLoading { get; set; } = false;
    private bool HasSearched { get; set; } = false;
    private ShipmentModel? Shipment { get; set; }

    // Mock Data Models (Replace these with your actual Entities later)
    public class ShipmentModel
    {
        public string AWBNo { get; set; } = "";
        public string SenderName { get; set; } = "";
        public string ReceiverName { get; set; } = "";
        public string Origin { get; set; } = "";
        public string Destination { get; set; } = "";
        public string CurrentStatus { get; set; } = "";
        public double Weight { get; set; }
        public int Pieces { get; set; }
        public List<TrackingEvent> History { get; set; } = new();
    }

    public class TrackingEvent
    {
        public DateTime Date { get; set; }
        public string Status { get; set; } = "";
        public string Location { get; set; } = "";
        public string Remarks { get; set; } = "";
    }

    private async Task TrackShipment()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm)) return;

        IsLoading = true;
        HasSearched = true;
        Shipment = null;

        // Simulate Network Delay
        await Task.Delay(1000);

        // --- MOCK DATA LOGIC ---
        // In a real app, you would inject your ShipmentService and call:
        // Shipment = await ShipmentService.GetByAWB(SearchTerm);

        if (SearchTerm.ToUpper() == "ERROR")
        {
            // Simulate Not Found
            Shipment = null; 
        }
        else
        {
            // Simulate Success
            Shipment = new ShipmentModel
            {
                AWBNo = SearchTerm.ToUpper(),
                SenderName = "Tech Solutions Ltd",
                ReceiverName = "John Doe",
                Origin = "New York, USA",
                Destination = "London, UK",
                CurrentStatus = "Out for Delivery",
                Weight = 2.5,
                Pieces = 1,
                History = new List<TrackingEvent>
                {
                    new TrackingEvent { Date = DateTime.Now, Status = "Out for Delivery", Location = "London Hub", Remarks = "With Courier: Mike" },
                    new TrackingEvent { Date = DateTime.Now.AddHours(-4), Status = "Arrived at Facility", Location = "London Hub", Remarks = "Processed at facility" },
                    new TrackingEvent { Date = DateTime.Now.AddDays(-1), Status = "Customs Cleared", Location = "Heathrow Airport", Remarks = "Released by customs" },
                    new TrackingEvent { Date = DateTime.Now.AddDays(-2), Status = "Departed Origin", Location = "JFK Airport", Remarks = "Flight AA123" },
                    new TrackingEvent { Date = DateTime.Now.AddDays(-2), Status = "Picked Up", Location = "New York", Remarks = "Received from sender" }
                }
            };
        }
        // -----------------------

        IsLoading = false;
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Delivered" => Color.Success,
            "Out for Delivery" => Color.Info,
            "Exception" => Color.Error,
            _ => Color.Warning
        };
    }

    private Color GetEventColor(string status)
    {
        if (status.Contains("Delivered")) return Color.Success;
        if (status.Contains("Exception") || status.Contains("Failed")) return Color.Error;
        if (status.Contains("Picked Up")) return Color.Info;
        return Color.Primary;
    }
}
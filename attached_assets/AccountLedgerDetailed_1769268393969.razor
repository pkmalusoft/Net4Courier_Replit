@page "/reports/account-ledger-detailed"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Account Ledger - Detailed</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-SelectedValues="selectedAccountIds" 
                           Label="Select Account(s)" 
                           T="Guid"
                           MultiSelection="true"
                           MultiSelectionTextFunc="@(new Func<List<string>, string>(GetSelectedAccountsText))"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var account in accounts)
                    {
                        <MudSelectItem Value="@account.Id">
                            @account.FullName
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="sortBy" 
                           Label="Sort By" 
                           T="string">
                    <MudSelectItem Value="@("date")">Date</MudSelectItem>
                    <MudSelectItem Value="@("voucherno")">Voucher No</MudSelectItem>
                    <MudSelectItem Value="@("amount")">Amount</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="sortDescending" 
                           Label="Order" 
                           T="bool">
                    <MudSelectItem Value="@false">Ascending</MudSelectItem>
                    <MudSelectItem Value="@true">Descending</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
        <MudGrid Class="mt-3">
            <MudItem xs="12" sm="10">
                @if (selectedAccountIds.Any())
                {
                    <MudChipSet T="Guid">
                        @foreach (var accountId in selectedAccountIds)
                        {
                            var account = accounts.FirstOrDefault(a => a.Id == accountId);
                            if (account != null)
                            {
                                <MudChip T="Guid" 
                                         Color="Color.Primary" 
                                         Size="MudBlazor.Size.Small"
                                         OnClose="@(() => RemoveAccount(accountId))">
                                    @account.FullName
                                </MudChip>
                            }
                        }
                    </MudChipSet>
                }
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Search"
                              OnClick="LoadReport"
                              Disabled="@(!selectedAccountIds.Any())">
                        Generate
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Default" 
                              StartIcon="@Icons.Material.Filled.Refresh"
                              OnClick="ClearFilters">
                        Clear
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">
                        @if (reportResult.SelectedAccounts.Count == 1)
                        {
                            var acc = reportResult.SelectedAccounts.First();
                            <span>@acc.Code - @acc.Name</span>
                        }
                        else
                        {
                            <span>@reportResult.SelectedAccounts.Count Accounts Selected</span>
                        }
                    </MudText>
                    <MudText Typo="Typo.caption">
                        Period: @reportResult.PeriodStart.ToString("dd MMM yyyy") - @reportResult.PeriodEnd.ToString("dd MMM yyyy")
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        @if (reportResult.SelectedAccounts.Count == 1)
                        {
                            var accountId = reportResult.SelectedAccounts.First().Id;
                            var opening = reportResult.OpeningBalances.GetValueOrDefault(accountId, 0m);
                            <MudStack Spacing="0" AlignItems="AlignItems.End">
                                <MudText Typo="Typo.caption">Opening Balance</MudText>
                                <MudText Typo="Typo.h6" Style="@(opening >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                    @opening.ToString("N2")
                                </MudText>
                            </MudStack>
                        }
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Debit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@reportResult.TotalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Credit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@reportResult.TotalCredit.ToString("N2")</MudText>
                        </MudStack>
                        @if (reportResult.SelectedAccounts.Count == 1 && reportResult.Transactions.Any())
                        {
                            var closing = reportResult.Transactions.Last().Balance;
                            <MudStack Spacing="0" AlignItems="AlignItems.End">
                                <MudText Typo="Typo.caption">Closing Balance</MudText>
                                <MudText Typo="Typo.h6" Style="@(closing >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                    @closing.ToString("N2")
                                </MudText>
                            </MudStack>
                        }
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4">
            @if (reportResult.Transactions.Any())
            {
                <MudTable Items="@reportResult.Transactions" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        @if (reportResult.SelectedAccounts.Count > 1)
                        {
                            <MudTh>Account</MudTh>
                        }
                        <MudTh>Voucher No</MudTh>
                        <MudTh>Narration</MudTh>
                        <MudTh>Reference</MudTh>
                        <MudTh Style="text-align: right;">Debit</MudTh>
                        <MudTh Style="text-align: right;">Credit</MudTh>
                        <MudTh Style="text-align: right;">Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.Date.ToString("dd MMM yyyy")</MudTd>
                        @if (reportResult.SelectedAccounts.Count > 1)
                        {
                            <MudTd DataLabel="Account">
                                <MudTooltip Text="@context.AccountName">
                                    <MudText Typo="Typo.body2">@context.AccountCode</MudText>
                                </MudTooltip>
                            </MudTd>
                        }
                        <MudTd DataLabel="Voucher No">@context.VoucherNo</MudTd>
                        <MudTd DataLabel="Narration">
                            <MudTooltip Text="@context.Narration">
                                <MudText Typo="Typo.body2" Style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @context.Narration
                                </MudText>
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Reference">
                            <MudText Typo="Typo.body2" Style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @context.Reference
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            @if (context.Debit > 0)
                            {
                                <span style="color: var(--mud-palette-error);">@context.Debit.ToString("N2")</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            @if (context.Credit > 0)
                            {
                                <span style="color: var(--mud-palette-success);">@context.Credit.ToString("N2")</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Balance" Style="text-align: right; font-weight: bold;">
                            <span style="@(context.Balance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @context.Balance.ToString("N2")
                            </span>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No transactions found for the selected period.</MudAlert>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<AccountDropdownDto> accounts = new();
    private IEnumerable<Guid> selectedAccountIds = new List<Guid>();
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private string sortBy = "date";
    private bool sortDescending = false;
    private bool isLoading = false;
    private AccountLedgerDetailedResultDto? reportResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
    }

    private string GetSelectedAccountsText(List<string> selectedValues)
    {
        var count = selectedAccountIds.Count();
        return count switch
        {
            0 => "Select Account(s)",
            1 => accounts.FirstOrDefault(a => selectedAccountIds.Contains(a.Id))?.FullName ?? "1 account",
            _ => $"{count} accounts selected"
        };
    }

    private void RemoveAccount(Guid accountId)
    {
        selectedAccountIds = selectedAccountIds.Where(id => id != accountId).ToList();
    }

    private async Task LoadAccounts()
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "api/AccountLedger/accounts");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                accounts = await response.Content.ReadFromJsonAsync<List<AccountDropdownDto>>() ?? new();
            }
            else
            {
                Snackbar.Add("Failed to load accounts", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading accounts: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadReport()
    {
        if (!selectedAccountIds.Any())
        {
            Snackbar.Add("Please select at least one account", Severity.Warning);
            return;
        }

        isLoading = true;
        reportResult = null;

        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var requestBody = new AccountLedgerRequestDto
            {
                AccountIds = selectedAccountIds.ToList(),
                Year = selectedYear,
                Month = selectedMonth,
                SortBy = sortBy,
                SortDescending = sortDescending
            };

            var request = new HttpRequestMessage(HttpMethod.Post, "api/AccountLedger/detailed");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);
            request.Content = JsonContent.Create(requestBody);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<AccountLedgerDetailedResultDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedAccountIds = new List<Guid>();
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        sortBy = "date";
        sortDescending = false;
        reportResult = null;
    }

    public class AccountDropdownDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
    }

    public class AccountLedgerRequestDto
    {
        public List<Guid> AccountIds { get; set; } = new();
        public int? Year { get; set; }
        public int? Month { get; set; }
        public string? SortBy { get; set; }
        public bool SortDescending { get; set; }
    }

    public class SelectedAccountDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }

    public class AccountLedgerDetailedItemDto
    {
        public Guid Id { get; set; }
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = string.Empty;
        public string AccountName { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public string VoucherNo { get; set; } = string.Empty;
        public string Narration { get; set; } = string.Empty;
        public string Reference { get; set; } = string.Empty;
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
    }

    public class AccountLedgerDetailedResultDto
    {
        public DateTime PeriodStart { get; set; }
        public DateTime PeriodEnd { get; set; }
        public List<SelectedAccountDto> SelectedAccounts { get; set; } = new();
        public Dictionary<Guid, decimal> OpeningBalances { get; set; } = new();
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public List<AccountLedgerDetailedItemDto> Transactions { get; set; } = new();
    }
}

@page "/reports/cash-bank-register"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Cash and Bank Register</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedAccountId" 
                           Label="Select Account" 
                           T="Guid?"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@((Guid?)null)">-- Select Account --</MudSelectItem>
                    @foreach (var account in accounts)
                    {
                        <MudSelectItem Value="@((Guid?)account.Id)">
                            @account.AccountName (@account.BankName)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="selectedRecPayType" 
                           Label="Transaction Type" 
                           T="string">
                    <MudSelectItem Value="@("All")">All Transactions</MudSelectItem>
                    <MudSelectItem Value="@("Receipt")">Receipts Only</MudSelectItem>
                    <MudSelectItem Value="@("Payment")">Payments Only</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudSelect Value="@dateSelectionMode" 
                           Label="Date Selection" 
                           T="string"
                           ValueChanged="@((string value) => OnDateSelectionModeChanged(value))">
                    <MudSelectItem Value="@("custom")">Custom Date Range</MudSelectItem>
                    <MudSelectItem Value="@("thisMonth")">This Month</MudSelectItem>
                    <MudSelectItem Value="@("lastMonth")">Last Month</MudSelectItem>
                    <MudSelectItem Value="@("thisQuarter")">This Quarter</MudSelectItem>
                    <MudSelectItem Value="@("lastQuarter")">Last Quarter</MudSelectItem>
                    <MudSelectItem Value="@("thisYear")">This Financial Year</MudSelectItem>
                    <MudSelectItem Value="@("lastYear")">Last Financial Year</MudSelectItem>
                    <MudSelectItem Value="@("all")">All Time</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
        
        @if (dateSelectionMode == "custom")
        {
            <MudGrid Class="mt-3">
                <MudItem xs="12" sm="4">
                    <MudDatePicker @bind-Date="fromDate" 
                                   Label="From Date" 
                                   DateFormat="dd/MM/yyyy"
                                   Placeholder="Select start date" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker @bind-Date="toDate" 
                                   Label="To Date" 
                                   DateFormat="dd/MM/yyyy"
                                   Placeholder="Select end date" />
                </MudItem>
            </MudGrid>
        }
        
        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          Disabled="@(!selectedAccountId.HasValue)"
                          FullWidth="true">
                    Generate Report
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">@reportResult.AccountName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @reportResult.BankName - @reportResult.AccountNumber
                    </MudText>
                    @if (reportResult.FromDate.HasValue || reportResult.ToDate.HasValue)
                    {
                        <MudText Typo="Typo.caption">
                            Period: @(reportResult.FromDate?.ToString("dd MMM yyyy") ?? "Beginning") 
                            to @(reportResult.ToDate?.ToString("dd MMM yyyy") ?? "Today")
                        </MudText>
                    }
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Opening Balance</MudText>
                            <MudText Typo="Typo.h6">@reportResult.OpeningBalance.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Receipts</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@reportResult.TotalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Payments</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@reportResult.TotalCredit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Closing Balance</MudText>
                            <MudText Typo="Typo.h6" Style="@(reportResult.ClosingBalance >= 0 ? "color: var(--mud-palette-success);" : "color: var(--mud-palette-error);")">
                                @reportResult.ClosingBalance.ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4">
            @if (reportResult.Transactions.Any())
            {
                <MudTable Items="@reportResult.Transactions" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Voucher No</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Particulars</MudTh>
                        <MudTh>Reference</MudTh>
                        <MudTh>Cheque No</MudTh>
                        <MudTh Style="text-align: right;">Debit (Receipt)</MudTh>
                        <MudTh Style="text-align: right;">Credit (Payment)</MudTh>
                        <MudTh Style="text-align: right;">Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.VoucherDate.ToString("dd MMM yyyy")</MudTd>
                        <MudTd DataLabel="Voucher No">
                            <MudLink Href="@($"/cash-bank-transaction/edit/{context.Id}")" Style="cursor: pointer; text-decoration: underline;">@context.VoucherNo</MudLink>
                        </MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="MudBlazor.Size.Small" 
                                     Color="@(context.RecPayType == "Receipt" ? Color.Success : Color.Warning)">
                                @context.RecPayType
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Particulars">
                            <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @context.Particulars
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Reference">@(context.ReferenceNo ?? "-")</MudTd>
                        <MudTd DataLabel="Cheque No">@(context.ChequeNo ?? "-")</MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            @if (context.Debit > 0)
                            {
                                <MudText Color="Color.Success">@context.Debit.ToString("N2")</MudText>
                            }
                            else
                            {
                                <MudText>-</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            @if (context.Credit > 0)
                            {
                                <MudText Color="Color.Error">@context.Credit.ToString("N2")</MudText>
                            }
                            else
                            {
                                <MudText>-</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Balance" Style="text-align: right;">
                            <MudText Style="@(context.Balance >= 0 ? "color: var(--mud-palette-success); font-weight: 500;" : "color: var(--mud-palette-error); font-weight: 500;")">
                                @context.Balance.ToString("N2")
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTh colspan="6" Style="text-align: right; font-weight: bold;">Totals:</MudTh>
                        <MudTh Style="text-align: right; font-weight: bold; color: var(--mud-palette-success);">
                            @reportResult.TotalDebit.ToString("N2")
                        </MudTh>
                        <MudTh Style="text-align: right; font-weight: bold; color: var(--mud-palette-error);">
                            @reportResult.TotalCredit.ToString("N2")
                        </MudTh>
                        <MudTh Style="text-align: right; font-weight: bold;">
                            @reportResult.ClosingBalance.ToString("N2")
                        </MudTh>
                    </FooterContent>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    No transactions found for the selected criteria.
                </MudAlert>
            }
        </MudPaper>
    }
    else if (hasSearched)
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Please select an account and click "Generate Report" to view the register.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private List<CashBankAccountDto> accounts = new();
    private Guid? selectedAccountId;
    private string selectedRecPayType = "All";
    private string dateSelectionMode = "thisMonth";
    private DateTime? fromDate;
    private DateTime? toDate;
    private bool isLoading;
    private bool hasSearched;
    private CashBankRegisterResultDto? reportResult;

    private static readonly JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() }
    };

    protected override async Task OnInitializedAsync()
    {
        SetDateRange("thisMonth");
        await LoadAccounts();
    }

    private HttpRequestMessage CreateAuthenticatedRequest(HttpMethod method, string url)
    {
        var request = new HttpRequestMessage(method, url);
        var token = AuthService.GetAccessToken();
        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }
        var tenantId = AuthService.GetTenantId();
        if (!string.IsNullOrEmpty(tenantId))
        {
            request.Headers.Add("X-Tenant-Id", tenantId);
        }
        return request;
    }

    private async Task LoadAccounts()
    {
        try
        {
            var request = CreateAuthenticatedRequest(HttpMethod.Get, "api/CashBankRegister/accounts");
            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();
            var content = await response.Content.ReadAsStringAsync();
            accounts = JsonSerializer.Deserialize<List<CashBankAccountDto>>(content, _jsonOptions) ?? new List<CashBankAccountDto>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading accounts: {ex.Message}", Severity.Error);
        }
    }

    private void OnDateSelectionModeChanged(string value)
    {
        dateSelectionMode = value;
        SetDateRange(value);
    }

    private void SetDateRange(string mode)
    {
        var today = DateTime.Today;
        var currentYear = today.Year;
        var currentMonth = today.Month;

        switch (mode)
        {
            case "thisMonth":
                fromDate = new DateTime(currentYear, currentMonth, 1);
                toDate = fromDate.Value.AddMonths(1).AddDays(-1);
                break;
            case "lastMonth":
                fromDate = new DateTime(currentYear, currentMonth, 1).AddMonths(-1);
                toDate = new DateTime(currentYear, currentMonth, 1).AddDays(-1);
                break;
            case "thisQuarter":
                var quarterStart = ((currentMonth - 1) / 3) * 3 + 1;
                fromDate = new DateTime(currentYear, quarterStart, 1);
                toDate = fromDate.Value.AddMonths(3).AddDays(-1);
                break;
            case "lastQuarter":
                var lastQuarterStart = ((currentMonth - 1) / 3) * 3 + 1;
                fromDate = new DateTime(currentYear, lastQuarterStart, 1).AddMonths(-3);
                toDate = new DateTime(currentYear, lastQuarterStart, 1).AddDays(-1);
                break;
            case "thisYear":
                fromDate = currentMonth >= 4 
                    ? new DateTime(currentYear, 4, 1) 
                    : new DateTime(currentYear - 1, 4, 1);
                toDate = fromDate.Value.AddYears(1).AddDays(-1);
                break;
            case "lastYear":
                fromDate = currentMonth >= 4 
                    ? new DateTime(currentYear - 1, 4, 1) 
                    : new DateTime(currentYear - 2, 4, 1);
                toDate = fromDate.Value.AddYears(1).AddDays(-1);
                break;
            case "all":
                fromDate = null;
                toDate = null;
                break;
            case "custom":
                break;
        }
    }

    private async Task LoadReport()
    {
        if (!selectedAccountId.HasValue)
        {
            Snackbar.Add("Please select an account", Severity.Warning);
            return;
        }

        isLoading = true;
        hasSearched = true;
        reportResult = null;
        StateHasChanged();

        try
        {
            var queryParams = new List<string>
            {
                $"accountId={selectedAccountId.Value}"
            };

            if (selectedRecPayType != "All")
            {
                queryParams.Add($"recPayType={selectedRecPayType}");
            }

            if (fromDate.HasValue)
            {
                queryParams.Add($"fromDate={fromDate.Value:yyyy-MM-dd}");
            }

            if (toDate.HasValue)
            {
                queryParams.Add($"toDate={toDate.Value:yyyy-MM-dd}");
            }

            var url = $"api/CashBankRegister/register?{string.Join("&", queryParams)}";
            var request = CreateAuthenticatedRequest(HttpMethod.Get, url);
            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();
            var content = await response.Content.ReadAsStringAsync();
            reportResult = JsonSerializer.Deserialize<CashBankRegisterResultDto>(content, _jsonOptions);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearFilters()
    {
        selectedAccountId = null;
        selectedRecPayType = "All";
        dateSelectionMode = "thisMonth";
        SetDateRange("thisMonth");
        reportResult = null;
        hasSearched = false;
    }

    public class CashBankAccountDto
    {
        public Guid Id { get; set; }
        public string AccountName { get; set; } = string.Empty;
        public string AccountNumber { get; set; } = string.Empty;
        public string BankName { get; set; } = string.Empty;
        public string AccountType { get; set; } = string.Empty;
        public Guid ChartOfAccountId { get; set; }
        public decimal OpeningBalance { get; set; }
        public DateTime OpeningBalanceDate { get; set; }
    }

    public class CashBankRegisterResultDto
    {
        public Guid AccountId { get; set; }
        public string AccountName { get; set; } = string.Empty;
        public string AccountNumber { get; set; } = string.Empty;
        public string BankName { get; set; } = string.Empty;
        public DateTime? FromDate { get; set; }
        public DateTime? ToDate { get; set; }
        public decimal OpeningBalance { get; set; }
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public decimal ClosingBalance { get; set; }
        public List<CashBankRegisterItemDto> Transactions { get; set; } = new();
    }

    public class CashBankRegisterItemDto
    {
        public Guid Id { get; set; }
        public string VoucherNo { get; set; } = string.Empty;
        public DateTime VoucherDate { get; set; }
        public string RecPayType { get; set; } = string.Empty;
        public string Particulars { get; set; } = string.Empty;
        public string? ReferenceNo { get; set; }
        public string? ChequeNo { get; set; }
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
    }
}

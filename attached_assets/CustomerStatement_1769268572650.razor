@page "/reports/customer-statement"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Customer Statement</MudText>
    
    <MudPaper Class="pa-4 mb-4 no-print">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedCustomerId" 
                           Label="Select Customer" 
                           T="Guid?"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@((Guid?)null)">-- Select Customer --</MudSelectItem>
                    @foreach (var customer in customers)
                    {
                        <MudSelectItem Value="@((Guid?)customer.Id)">
                            @customer.Name (@customer.Code)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadStatement"
                          Disabled="@(!selectedCustomerId.HasValue)"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Print"
                          OnClick="PrintStatement"
                          Disabled="@(statementResult == null)"
                          FullWidth="true"
                          Class="mt-1">
                    Print
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading statement...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (statementResult != null)
    {
        <div id="statement-content">
            <MudPaper Class="pa-6 mb-4" id="printable-statement">
                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.h5" Style="font-weight: bold;">@statementResult.CompanyName</MudText>
                        @if (!string.IsNullOrEmpty(statementResult.CompanyAddress))
                        {
                            <MudText Typo="Typo.body2">@statementResult.CompanyAddress</MudText>
                        }
                        @if (!string.IsNullOrEmpty(statementResult.CompanyPhone))
                        {
                            <MudText Typo="Typo.body2">Phone: @statementResult.CompanyPhone</MudText>
                        }
                        @if (!string.IsNullOrEmpty(statementResult.CompanyEmail))
                        {
                            <MudText Typo="Typo.body2">Email: @statementResult.CompanyEmail</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6" Style="text-align: right;">
                        <MudText Typo="Typo.h4" Color="Color.Primary">STATEMENT</MudText>
                        <MudText Typo="Typo.body2">Date: @statementResult.StatementDate.ToString("dd MMM yyyy")</MudText>
                        <MudText Typo="Typo.body2">Period: @statementResult.PeriodStart.ToString("dd MMM yyyy") - @statementResult.PeriodEnd.ToString("dd MMM yyyy")</MudText>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle1" Style="font-weight: bold;">Bill To:</MudText>
                        <MudText Typo="Typo.body1" Style="font-weight: bold;">@statementResult.CustomerName</MudText>
                        <MudText Typo="Typo.body2">Customer Code: @statementResult.CustomerCode</MudText>
                        @if (!string.IsNullOrEmpty(statementResult.CustomerAddress))
                        {
                            <MudText Typo="Typo.body2">@statementResult.CustomerAddress</MudText>
                        }
                        @if (!string.IsNullOrEmpty(statementResult.CustomerPhone))
                        {
                            <MudText Typo="Typo.body2">Phone: @statementResult.CustomerPhone</MudText>
                        }
                        @if (!string.IsNullOrEmpty(statementResult.CustomerEmail))
                        {
                            <MudText Typo="Typo.body2">Email: @statementResult.CustomerEmail</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6" Style="text-align: right;">
                        <MudPaper Class="pa-3" Style="background-color: #f5f5f5; display: inline-block;">
                            <MudText Typo="Typo.subtitle2">Amount Due</MudText>
                            <MudText Typo="Typo.h4" Color="@(statementResult.ClosingBalance > 0 ? Color.Error : Color.Success)">
                                @statementResult.ClosingBalance.ToString("N2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudSimpleTable Dense="true" Hover="true" Bordered="true" Style="margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #1976d2; color: white;">
                            <th style="width: 100px;">Date</th>
                            <th>Description</th>
                            <th>Reference</th>
                            <th style="text-align: right; width: 120px;">Debit</th>
                            <th style="text-align: right; width: 120px;">Credit</th>
                            <th style="text-align: right; width: 120px;">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background-color: #e3f2fd; font-weight: bold;">
                            <td>@statementResult.PeriodStart.ToString("dd MMM yyyy")</td>
                            <td colspan="4">Opening Balance</td>
                            <td style="text-align: right;">@statementResult.OpeningBalance.ToString("N2")</td>
                        </tr>
                        @foreach (var item in statementResult.Transactions)
                        {
                            <tr>
                                <td>@item.Date.ToString("dd MMM yyyy")</td>
                                <td>@item.Description</td>
                                <td>@item.Reference</td>
                                <td style="text-align: right;">@(item.Debit > 0 ? item.Debit.ToString("N2") : "")</td>
                                <td style="text-align: right;">@(item.Credit > 0 ? item.Credit.ToString("N2") : "")</td>
                                <td style="text-align: right;">@item.Balance.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr style="background-color: #e3f2fd; font-weight: bold;">
                            <td colspan="3" style="text-align: right;">Totals:</td>
                            <td style="text-align: right;">@statementResult.TotalDebit.ToString("N2")</td>
                            <td style="text-align: right;">@statementResult.TotalCredit.ToString("N2")</td>
                            <td style="text-align: right;">@statementResult.ClosingBalance.ToString("N2")</td>
                        </tr>
                    </tfoot>
                </MudSimpleTable>

                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.caption">
                            This is a computer generated statement. Please report any discrepancies within 7 days.
                        </MudText>
                    </MudItem>
                    <MudItem xs="6" Style="text-align: right;">
                        <MudText Typo="Typo.body2" Style="font-weight: bold;">
                            Closing Balance: @statementResult.ClosingBalance.ToString("N2")
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </div>
    }
</MudContainer>

<style>
    @@media print {
        .no-print {
            display: none !important;
        }
        #printable-statement {
            box-shadow: none !important;
            margin: 0 !important;
            padding: 20px !important;
        }
    }
</style>

@code {
    private List<CustomerStatementDropdownDto> customers = new();
    private Guid? selectedCustomerId;
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private bool isLoading = false;
    private CustomerStatementResultDto? statementResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "api/CustomerStatement/customers");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                customers = await response.Content.ReadFromJsonAsync<List<CustomerStatementDropdownDto>>() ?? new();
            }
            else
            {
                Snackbar.Add("Failed to load customers", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customers: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadStatement()
    {
        if (!selectedCustomerId.HasValue)
        {
            Snackbar.Add("Please select a customer", Severity.Warning);
            return;
        }

        isLoading = true;
        statementResult = null;

        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var url = $"api/CustomerStatement?customerId={selectedCustomerId.Value}&year={selectedYear}&month={selectedMonth}";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                statementResult = await response.Content.ReadFromJsonAsync<CustomerStatementResultDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load statement: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading statement: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PrintStatement()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    public class CustomerStatementDropdownDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string Address { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    public class CustomerStatementResultDto
    {
        public Guid CustomerId { get; set; }
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerCode { get; set; } = string.Empty;
        public string CustomerAddress { get; set; } = string.Empty;
        public string CustomerPhone { get; set; } = string.Empty;
        public string CustomerEmail { get; set; } = string.Empty;
        public string CompanyName { get; set; } = string.Empty;
        public string CompanyAddress { get; set; } = string.Empty;
        public string CompanyPhone { get; set; } = string.Empty;
        public string CompanyEmail { get; set; } = string.Empty;
        public DateTime PeriodStart { get; set; }
        public DateTime PeriodEnd { get; set; }
        public DateTime StatementDate { get; set; }
        public decimal OpeningBalance { get; set; }
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public decimal ClosingBalance { get; set; }
        public List<CustomerStatementItemDto> Transactions { get; set; } = new();
    }

    public class CustomerStatementItemDto
    {
        public Guid Id { get; set; }
        public DateTime Date { get; set; }
        public string Description { get; set; } = string.Empty;
        public string Reference { get; set; } = string.Empty;
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
    }
}

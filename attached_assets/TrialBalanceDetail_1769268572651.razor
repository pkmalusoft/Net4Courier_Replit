@page "/reports/trial-balance-detail"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using Web.Services
@using Web.Models
@inject HttpClient Http
@inject IAuthService AuthService
@inject IBranchService BranchService
@inject IDepartmentService DepartmentService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Trial Balance - Detail (With Opening Balances)</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int"
                           Variant="Variant.Outlined"
                           Dense="true">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int?"
                           Variant="Variant.Outlined"
                           Dense="true">
                    <MudSelectItem Value="@((int?)null)">Full Year</MudSelectItem>
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@((int?)month)">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect Value="selectedBranchId" Label="Branch" Variant="Variant.Outlined" Dense="true"
                           Clearable="true" T="Guid?" ValueChanged="OnBranchChanged"
                           ValueExpression="@(() => selectedBranchId)">
                    @foreach (var branch in branches)
                    {
                        <MudSelectItem Value="@((Guid?)branch.Id)">@branch.Code - @branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedDepartmentId" Label="Department" Variant="Variant.Outlined" Dense="true"
                           Clearable="true" T="Guid?" Disabled="@(!selectedBranchId.HasValue && branches.Any())">
                    @foreach (var dept in filteredDepartments)
                    {
                        <MudSelectItem Value="@((Guid?)dept.Id)">@dept.Code - @dept.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                <MudText Typo="Typo.subtitle1">
                    Period: @reportResult.PeriodStart.ToString("dd MMM yyyy") to @reportResult.PeriodEnd.ToString("dd MMM yyyy")
                </MudText>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                    @reportResult.Items.Count accounts
                </MudText>
            </MudStack>

            <MudTable Items="@reportResult.Items" 
                      Dense="true" 
                      Hover="true" 
                      Striped="true"
                      FixedHeader="true"
                      Height="500px">
                <HeaderContent>
                    <MudTh Style="width: 100px">Code</MudTh>
                    <MudTh>Account Name</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Opening Dr</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Opening Cr</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Period Dr</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Period Cr</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Closing Dr</MudTh>
                    <MudTh Style="width: 110px; text-align: right">Closing Cr</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Code">@context.AccountCode</MudTd>
                    <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                    <MudTd DataLabel="Opening Dr" Style="text-align: right">
                        @(context.OpeningDebit != 0 ? context.OpeningDebit.ToString("N2") : "-")
                    </MudTd>
                    <MudTd DataLabel="Opening Cr" Style="text-align: right">
                        @(context.OpeningCredit != 0 ? context.OpeningCredit.ToString("N2") : "-")
                    </MudTd>
                    <MudTd DataLabel="Period Dr" Style="text-align: right">
                        @(context.PeriodDebit != 0 ? context.PeriodDebit.ToString("N2") : "-")
                    </MudTd>
                    <MudTd DataLabel="Period Cr" Style="text-align: right">
                        @(context.PeriodCredit != 0 ? context.PeriodCredit.ToString("N2") : "-")
                    </MudTd>
                    <MudTd DataLabel="Closing Dr" Style="text-align: right">
                        @(context.ClosingDebit != 0 ? context.ClosingDebit.ToString("N2") : "-")
                    </MudTd>
                    <MudTd DataLabel="Closing Cr" Style="text-align: right">
                        @(context.ClosingCredit != 0 ? context.ClosingCredit.ToString("N2") : "-")
                    </MudTd>
                </RowTemplate>
                <FooterContent>
                    <MudTFootRow>
                        <MudTd colspan="2"><strong>Total</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalOpeningDebit.ToString("N2")</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalOpeningCredit.ToString("N2")</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalPeriodDebit.ToString("N2")</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalPeriodCredit.ToString("N2")</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalClosingDebit.ToString("N2")</strong></MudTd>
                        <MudTd Style="text-align: right"><strong>@reportResult.TotalClosingCredit.ToString("N2")</strong></MudTd>
                    </MudTFootRow>
                </FooterContent>
            </MudTable>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a period and click Generate to view the Trial Balance with Opening Balances.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private int selectedYear = DateTime.Now.Year;
    private int? selectedMonth = DateTime.Now.Month;
    private Guid? selectedBranchId;
    private Guid? selectedDepartmentId;
    private bool isLoading = false;
    private TrialBalanceDetailResult? reportResult;
    
    private List<BranchDto> branches = new();
    private List<DepartmentDto> departments = new();
    private IEnumerable<DepartmentDto> filteredDepartments => selectedBranchId.HasValue 
        ? departments.Where(d => d.BranchId == selectedBranchId || d.BranchId == null)
        : departments;

    protected override async Task OnInitializedAsync()
    {
        await LoadBranchesAndDepartments();
        await LoadReport();
    }

    private async Task LoadBranchesAndDepartments()
    {
        try
        {
            branches = await BranchService.GetAllAsync();
            departments = await DepartmentService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading branches/departments: {ex.Message}", Severity.Warning);
        }
    }

    private void OnBranchChanged(Guid? newBranchId)
    {
        selectedBranchId = newBranchId;
        selectedDepartmentId = null;
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportResult = null;
        StateHasChanged();

        try
        {
            var request = CreateAuthenticatedRequest(HttpMethod.Post, "api/trialbalance/detail");
            request.Content = JsonContent.Create(new
            {
                Year = selectedYear,
                Month = selectedMonth,
                BranchId = selectedBranchId,
                DepartmentId = selectedDepartmentId
            });

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<TrialBalanceDetailResult>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        selectedBranchId = null;
        selectedDepartmentId = null;
        reportResult = null;
    }

    private HttpRequestMessage CreateAuthenticatedRequest(HttpMethod method, string uri)
    {
        var request = new HttpRequestMessage(method, uri);
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();
        
        if (!string.IsNullOrEmpty(token))
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        if (!string.IsNullOrEmpty(tenantId))
            request.Headers.Add("X-Tenant-Id", tenantId);
        
        return request;
    }

    private class TrialBalanceDetailResult
    {
        public string ReportType { get; set; } = "";
        public DateTime PeriodStart { get; set; }
        public DateTime PeriodEnd { get; set; }
        public decimal TotalOpeningDebit { get; set; }
        public decimal TotalOpeningCredit { get; set; }
        public decimal TotalPeriodDebit { get; set; }
        public decimal TotalPeriodCredit { get; set; }
        public decimal TotalClosingDebit { get; set; }
        public decimal TotalClosingCredit { get; set; }
        public List<TrialBalanceDetailItem> Items { get; set; } = new();
    }

    private class TrialBalanceDetailItem
    {
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public decimal OpeningDebit { get; set; }
        public decimal OpeningCredit { get; set; }
        public decimal PeriodDebit { get; set; }
        public decimal PeriodCredit { get; set; }
        public decimal ClosingDebit { get; set; }
        public decimal ClosingCredit { get; set; }
    }
}

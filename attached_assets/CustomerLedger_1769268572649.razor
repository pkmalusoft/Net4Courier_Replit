@page "/reports/customer-ledger"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Customer Ledger</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedCustomerId" 
                           Label="Select Customer" 
                           T="Guid?"
                           Required="true"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@((Guid?)null)">-- Select Customer --</MudSelectItem>
                    @foreach (var customer in customers)
                    {
                        <MudSelectItem Value="@((Guid?)customer.Id)">
                            @customer.Name (@customer.Code)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          Disabled="@(!selectedCustomerId.HasValue)"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">@reportResult.CustomerName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Code: @reportResult.CustomerCode
                    </MudText>
                    <MudText Typo="Typo.caption">
                        As of: @reportResult.AsOfDate.ToString("dd MMM yyyy")
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Opening Balance</MudText>
                            <MudText Typo="Typo.h6">@reportResult.OpeningBalance.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Invoices</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@reportResult.TotalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Receipts</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@reportResult.TotalCredit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Closing Balance</MudText>
                            <MudText Typo="Typo.h6" Style="@(reportResult.ClosingBalance >= 0 ? "color: var(--mud-palette-error);" : "color: var(--mud-palette-success);")">
                                @reportResult.ClosingBalance.ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4">
            @if (reportResult.Transactions.Any())
            {
                <MudTable Items="@reportResult.Transactions" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Voucher Type</MudTh>
                        <MudTh>Voucher No</MudTh>
                        <MudTh>Reference</MudTh>
                        <MudTh Style="text-align: right;">Debit (Invoice)</MudTh>
                        <MudTh Style="text-align: right;">Credit (Receipt)</MudTh>
                        <MudTh Style="text-align: right;">Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.Date.ToString("dd MMM yyyy")</MudTd>
                        <MudTd DataLabel="Voucher Type">
                            <MudChip T="string" Size="MudBlazor.Size.Small" 
                                     Color="@GetVoucherTypeColor(context.VoucherType)">
                                @context.VoucherType
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Voucher No">@context.VoucherNo</MudTd>
                        <MudTd DataLabel="Reference">@context.Reference</MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            @if (context.Debit > 0)
                            {
                                <span style="color: var(--mud-palette-error);">@context.Debit.ToString("N2")</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            @if (context.Credit > 0)
                            {
                                <span style="color: var(--mud-palette-success);">@context.Credit.ToString("N2")</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Balance" Style="text-align: right; font-weight: bold;">
                            <span style="@(context.Balance >= 0 ? "color: var(--mud-palette-error);" : "color: var(--mud-palette-success);")">
                                @context.Balance.ToString("N2")
                            </span>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No transactions found for the selected period.</MudAlert>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<CustomerDropdownDto> customers = new();
    private Guid? selectedCustomerId;
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private bool isLoading = false;
    private CustomerLedgerResultDto? reportResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "api/CustomerLedger/customers");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                customers = await response.Content.ReadFromJsonAsync<List<CustomerDropdownDto>>() ?? new();
            }
            else
            {
                Snackbar.Add("Failed to load customers", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customers: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadReport()
    {
        if (!selectedCustomerId.HasValue)
        {
            Snackbar.Add("Please select a customer", Severity.Warning);
            return;
        }

        isLoading = true;
        reportResult = null;

        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var url = $"api/CustomerLedger?customerId={selectedCustomerId.Value}&year={selectedYear}&month={selectedMonth}";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<CustomerLedgerResultDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedCustomerId = null;
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        reportResult = null;
    }

    private Color GetVoucherTypeColor(string voucherType)
    {
        return voucherType switch
        {
            "Sales Invoice" => Color.Error,
            "Receipt" => Color.Success,
            "Sales Return" => Color.Warning,
            _ => Color.Default
        };
    }

    public class CustomerDropdownDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
    }

    public class CustomerLedgerResultDto
    {
        public Guid CustomerId { get; set; }
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerCode { get; set; } = string.Empty;
        public DateTime AsOfDate { get; set; }
        public decimal OpeningBalance { get; set; }
        public decimal TotalDebit { get; set; }
        public decimal TotalCredit { get; set; }
        public decimal ClosingBalance { get; set; }
        public List<CustomerLedgerItemDto> Transactions { get; set; } = new();
    }

    public class CustomerLedgerItemDto
    {
        public Guid Id { get; set; }
        public DateTime Date { get; set; }
        public string VoucherType { get; set; } = string.Empty;
        public string VoucherNo { get; set; } = string.Empty;
        public string Reference { get; set; } = string.Empty;
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Balance { get; set; }
        public string CurrencyCode { get; set; } = string.Empty;
    }
}

@page "/bank-reconciliation"
@using Web.Services
@inject HttpClient Http
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Bank Reconciliation</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Bank Reconciliation</MudText>
    
    @if (currentReconciliation == null)
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Start New Reconciliation</MudText>
            
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="selectedBankAccountId" Label="Bank Account" Required="true" Variant="Variant.Outlined">
                        @foreach (var account in bankAccounts)
                        {
                            <MudSelectItem Value="@account.Id">@account.AccountName (@account.AccountNumber)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="statementDate" Label="Statement Date" Required="true" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartReconciliation" Disabled="@(selectedBankAccountId == Guid.Empty)">
                        Start Reconciliation
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle2">Account:</MudText>
                    <MudText Typo="Typo.body1">@currentReconciliation.AccountName</MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle2">Statement Date:</MudText>
                    <MudText Typo="Typo.body1">@currentReconciliation.StatementDate.ToString("dd MMM yyyy")</MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle2">Status:</MudText>
                    <MudChip T="string" Color="@GetStatusColor(currentReconciliation.Status)">@currentReconciliation.Status</MudChip>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="CancelReconciliation">
                        Cancel & Return
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="Import Statement" Icon="@Icons.Material.Filled.Upload">
                <MudText Typo="Typo.h6" Class="mb-4">Upload Bank Statement</MudText>
                <InputFile OnChange="OnFileSelected" accept=".csv" id="fileInput" style="display:none;" />
                <MudButton HtmlTag="label" for="fileInput" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                    Select CSV File
                </MudButton>
                @if (selectedFile != null)
                {
                    <MudText Class="mt-2">Selected: @selectedFile.Name</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="UploadStatement" Class="mt-2">
                        Upload & Import
                    </MudButton>
                }
            </MudTabPanel>

            <MudTabPanel Text="Auto Match" Icon="@Icons.Material.Filled.AutoAwesome">
                <MudText Typo="Typo.h6" Class="mb-4">Automatic Matching</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RunAutoMatch">
                    Run Auto-Match Algorithm
                </MudButton>
            </MudTabPanel>

            <MudTabPanel Text="Manual Match" Icon="@Icons.Material.Filled.CompareArrows">
                <MudText Typo="Typo.h6" Class="mb-4">Manual Matching</MudText>
                <MudText Typo="Typo.body2" Color="Color.Info">Two-panel matching interface will be available here</MudText>
            </MudTabPanel>

            <MudTabPanel Text="Adjustments" Icon="@Icons.Material.Filled.Edit">
                <MudText Typo="Typo.h6" Class="mb-4">Bank Adjustments</MudText>
                <MudText Typo="Typo.body2" Color="Color.Info">Add bank fees, interest, and other adjustments</MudText>
            </MudTabPanel>

            <MudTabPanel Text="Finalize" Icon="@Icons.Material.Filled.CheckCircle">
                <MudText Typo="Typo.h6" Class="mb-4">Finalize Reconciliation</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="FinalizeReconciliation">
                    Complete & Lock Reconciliation
                </MudButton>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    private List<BankAccountDto> bankAccounts = new();
    private Guid selectedBankAccountId = Guid.Empty;
    private DateTime? statementDate = DateTime.UtcNow.Date;
    private ReconciliationDto? currentReconciliation;
    private IBrowserFile? selectedFile;

    protected override async Task OnInitializedAsync()
    {
        await LoadBankAccounts();
    }

    private async Task LoadBankAccounts()
    {
        try
        {
            var tenantId = AuthService.GetTenantId();
            Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);

            var response = await Http.GetFromJsonAsync<List<BankAccountDto>>("/api/bankaccount");
            bankAccounts = response ?? new List<BankAccountDto>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading bank accounts: {ex.Message}", Severity.Error);
        }
    }

    private async Task StartReconciliation()
    {
        try
        {
            var tenantId = AuthService.GetTenantId();
            Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);

            var request = new { BankAccountId = selectedBankAccountId, StatementDate = statementDate };
            var response = await Http.PostAsJsonAsync("/api/bank-reconciliation/start", request);
            
            if (response.IsSuccessStatusCode)
            {
                currentReconciliation = await response.Content.ReadFromJsonAsync<ReconciliationDto>();
                Snackbar.Add("Reconciliation started successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error starting reconciliation: {ex.Message}", Severity.Error);
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task UploadStatement()
    {
        if (selectedFile == null || currentReconciliation == null) return;

        try
        {
            var buffer = new byte[selectedFile.Size];
            await selectedFile.OpenReadStream().ReadAsync(buffer);
            var base64Content = Convert.ToBase64String(buffer);

            var tenantId = AuthService.GetTenantId();
            Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);

            var request = new { FileName = selectedFile.Name, FileContent = base64Content };
            var response = await Http.PostAsJsonAsync($"/api/bank-reconciliation/{currentReconciliation.Id}/import-statement", request);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Statement imported successfully", Severity.Success);
                selectedFile = null;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading statement: {ex.Message}", Severity.Error);
        }
    }

    private async Task RunAutoMatch()
    {
        if (currentReconciliation == null) return;

        try
        {
            var tenantId = AuthService.GetTenantId();
            Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);

            var response = await Http.PostAsync($"/api/bank-reconciliation/{currentReconciliation.Id}/auto-match", null);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AutoMatchResultDto>();
                Snackbar.Add($"Auto-matched {result?.MatchedCount ?? 0} transactions", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error running auto-match: {ex.Message}", Severity.Error);
        }
    }

    private async Task FinalizeReconciliation()
    {
        if (currentReconciliation == null) return;

        try
        {
            var tenantId = AuthService.GetTenantId();
            Http.DefaultRequestHeaders.Remove("X-Tenant-Id");
            Http.DefaultRequestHeaders.Add("X-Tenant-Id", tenantId);

            var response = await Http.PostAsync($"/api/bank-reconciliation/{currentReconciliation.Id}/finalize", null);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Reconciliation finalized successfully", Severity.Success);
                Navigation.NavigateTo("/bank-reconciliation");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error finalizing reconciliation: {ex.Message}", Severity.Error);
        }
    }

    private void CancelReconciliation()
    {
        currentReconciliation = null;
        selectedBankAccountId = Guid.Empty;
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Draft" => Color.Default,
            "InProgress" => Color.Info,
            "Completed" => Color.Success,
            "Locked" => Color.Secondary,
            _ => Color.Default
        };
    }

    public class BankAccountDto
    {
        public Guid Id { get; set; }
        public string AccountNumber { get; set; } = string.Empty;
        public string AccountName { get; set; } = string.Empty;
    }

    public class ReconciliationDto
    {
        public Guid Id { get; set; }
        public string AccountName { get; set; } = string.Empty;
        public DateTime StatementDate { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    public class AutoMatchResultDto
    {
        public int MatchedCount { get; set; }
        public int TotalStatementLines { get; set; }
    }
}

@page "/reports/profit-loss/itemwise"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using Web.Services
@using Web.Models
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@inject IBranchService BranchService
@inject IDepartmentService DepartmentService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h5" Class="mb-4">Profit & Loss Statement - Item-wise Detail</MudText>

        <MudGrid>
            <MudItem xs="12" sm="2">
                <MudSelect T="int" Label="Year" @bind-Value="selectedYear" Variant="Variant.Outlined" Dense="true">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 10; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect T="int?" Label="Month" @bind-Value="selectedMonth" Variant="Variant.Outlined" Dense="true" Clearable="true">
                    <MudSelectItem T="int?" Value="null">All Months</MudSelectItem>
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem T="int?" Value="@month">@(new DateTime(2000, month, 1).ToString("MMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect Value="selectedBranchId" Label="Branch" Variant="Variant.Outlined" Dense="true"
                           Clearable="true" T="Guid?" ValueChanged="OnBranchChanged"
                           ValueExpression="@(() => selectedBranchId)">
                    @foreach (var branch in branches)
                    {
                        <MudSelectItem Value="@((Guid?)branch.Id)">@branch.Code - @branch.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedDepartmentId" Label="Department" Variant="Variant.Outlined" Dense="true"
                           Clearable="true" T="Guid?" Disabled="@(!selectedBranchId.HasValue && branches.Any())">
                    @foreach (var dept in filteredDepartments)
                    {
                        <MudSelectItem Value="@((Guid?)dept.Id)">@dept.Code - @dept.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="4" Class="d-flex align-center gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" Disabled="isLoading">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Generate
                </MudButton>
                <MudButton Variant="Variant.Outlined" OnClick="ClearFilters">Clear</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.subtitle1" Class="mb-2">
                Period: @reportResult.PeriodStart.ToString("dd MMM yyyy") - @reportResult.PeriodEnd.ToString("dd MMM yyyy")
            </MudText>

            <MudExpansionPanels MultiExpansion="true">
                <MudExpansionPanel Text="REVENUE" Expanded="true" Style="background: var(--mud-palette-success-lighten);">
                    @foreach (var account in reportResult.RevenueAccounts)
                    {
                        <MudExpansionPanel Text="@($"{account.AccountCode} - {account.AccountName}")"
                                           Expanded="false"
                                           Style="margin-left: 16px;">
                            <TitleContent>
                                <div class="d-flex justify-space-between align-center" style="width: 100%">
                                    <MudText>@account.AccountCode - @account.AccountName</MudText>
                                    <MudText Color="Color.Success" Style="font-weight: bold">@FormatAmount(account.TotalAmount)</MudText>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudTable Items="@account.Transactions" Dense="true" Hover="true" Bordered="true">
                                    <HeaderContent>
                                        <MudTh>Date</MudTh>
                                        <MudTh>Voucher No</MudTh>
                                        <MudTh>Reference</MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh Style="text-align: right">Debit</MudTh>
                                        <MudTh Style="text-align: right">Credit</MudTh>
                                        <MudTh Style="text-align: right">Amount</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.EntryDate.ToString("dd-MMM-yyyy")</MudTd>
                                        <MudTd>@context.VoucherNumber</MudTd>
                                        <MudTd>@context.Reference</MudTd>
                                        <MudTd>@context.Description</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Debit)</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Credit)</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Amount)</MudTd>
                                    </RowTemplate>
                                    <FooterContent>
                                        <MudTFootRow>
                                            <MudTd colspan="4"><strong>Total</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.Transactions.Sum(t => t.Debit))</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.Transactions.Sum(t => t.Credit))</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.TotalAmount)</strong></MudTd>
                                        </MudTFootRow>
                                    </FooterContent>
                                </MudTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    }

                    <MudDivider Class="my-2" />
                    <div class="d-flex justify-space-between pa-3" style="background: var(--mud-palette-success-darken);">
                        <MudText Typo="Typo.subtitle1" Style="font-weight: bold; color: white;">Total Revenue</MudText>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: bold; color: white;">@FormatAmount(reportResult.TotalRevenue)</MudText>
                    </div>
                </MudExpansionPanel>

                <MudExpansionPanel Text="EXPENSES" Expanded="true" Style="background: var(--mud-palette-error-lighten);">
                    @foreach (var account in reportResult.ExpenseAccounts)
                    {
                        <MudExpansionPanel Text="@($"{account.AccountCode} - {account.AccountName}")"
                                           Expanded="false"
                                           Style="margin-left: 16px;">
                            <TitleContent>
                                <div class="d-flex justify-space-between align-center" style="width: 100%">
                                    <MudText>@account.AccountCode - @account.AccountName</MudText>
                                    <MudText Color="Color.Error" Style="font-weight: bold">@FormatAmount(account.TotalAmount)</MudText>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudTable Items="@account.Transactions" Dense="true" Hover="true" Bordered="true">
                                    <HeaderContent>
                                        <MudTh>Date</MudTh>
                                        <MudTh>Voucher No</MudTh>
                                        <MudTh>Reference</MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh Style="text-align: right">Debit</MudTh>
                                        <MudTh Style="text-align: right">Credit</MudTh>
                                        <MudTh Style="text-align: right">Amount</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.EntryDate.ToString("dd-MMM-yyyy")</MudTd>
                                        <MudTd>@context.VoucherNumber</MudTd>
                                        <MudTd>@context.Reference</MudTd>
                                        <MudTd>@context.Description</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Debit)</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Credit)</MudTd>
                                        <MudTd Style="text-align: right">@FormatAmount(context.Amount)</MudTd>
                                    </RowTemplate>
                                    <FooterContent>
                                        <MudTFootRow>
                                            <MudTd colspan="4"><strong>Total</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.Transactions.Sum(t => t.Debit))</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.Transactions.Sum(t => t.Credit))</strong></MudTd>
                                            <MudTd Style="text-align: right"><strong>@FormatAmount(account.TotalAmount)</strong></MudTd>
                                        </MudTFootRow>
                                    </FooterContent>
                                </MudTable>
                            </ChildContent>
                        </MudExpansionPanel>
                    }

                    <MudDivider Class="my-2" />
                    <div class="d-flex justify-space-between pa-3" style="background: var(--mud-palette-error-darken);">
                        <MudText Typo="Typo.subtitle1" Style="font-weight: bold; color: white;">Total Expenses</MudText>
                        <MudText Typo="Typo.subtitle1" Style="font-weight: bold; color: white;">@FormatAmount(reportResult.TotalExpenses)</MudText>
                    </div>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudPaper Class="pa-4 mt-4" Style="@GetNetProfitStyle()">
                <div class="d-flex justify-space-between align-center">
                    <MudText Typo="Typo.h6" Style="font-weight: bold; color: white;">
                        @(reportResult.NetProfitLoss >= 0 ? "NET PROFIT" : "NET LOSS")
                    </MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: bold; color: white;">
                        @FormatAmount(Math.Abs(reportResult.NetProfitLoss))
                    </MudText>
                </div>
            </MudPaper>
        </MudPaper>
    }
    else if (!isLoading)
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select a year/month and click Generate to view the Item-wise Profit & Loss Statement with transaction details.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private int selectedYear = DateTime.Now.Year;
    private int? selectedMonth = DateTime.Now.Month;
    private Guid? selectedBranchId;
    private Guid? selectedDepartmentId;
    private bool isLoading = false;
    private ProfitLossItemWiseResult? reportResult;
    
    private List<BranchDto> branches = new();
    private List<DepartmentDto> departments = new();
    private IEnumerable<DepartmentDto> filteredDepartments => selectedBranchId.HasValue 
        ? departments.Where(d => d.BranchId == selectedBranchId || d.BranchId == null)
        : departments;

    protected override async Task OnInitializedAsync()
    {
        await LoadBranchesAndDepartments();
        await LoadReport();
    }

    private async Task LoadBranchesAndDepartments()
    {
        try
        {
            branches = await BranchService.GetAllAsync();
            departments = await DepartmentService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading branches/departments: {ex.Message}", Severity.Warning);
        }
    }

    private void OnBranchChanged(Guid? newBranchId)
    {
        selectedBranchId = newBranchId;
        selectedDepartmentId = null;
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportResult = null;
        StateHasChanged();

        try
        {
            var request = CreateAuthenticatedRequest(HttpMethod.Post, "api/profitloss/itemwise");
            request.Content = JsonContent.Create(new
            {
                Year = selectedYear,
                Month = selectedMonth,
                BranchId = selectedBranchId,
                DepartmentId = selectedDepartmentId
            });

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<ProfitLossItemWiseResult>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        selectedBranchId = null;
        selectedDepartmentId = null;
        reportResult = null;
    }

    private string FormatAmount(decimal value)
    {
        if (value == 0) return "-";
        return value.ToString("N2");
    }

    private string GetNetProfitStyle()
    {
        if (reportResult == null) return "";
        return reportResult.NetProfitLoss >= 0
            ? "background: var(--mud-palette-success);"
            : "background: var(--mud-palette-error);";
    }

    private HttpRequestMessage CreateAuthenticatedRequest(HttpMethod method, string uri)
    {
        var request = new HttpRequestMessage(method, uri);
        var token = AuthService.GetAccessToken();
        var tenantId = AuthService.GetTenantId();

        if (!string.IsNullOrEmpty(token))
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        if (!string.IsNullOrEmpty(tenantId))
            request.Headers.Add("X-Tenant-Id", tenantId);

        return request;
    }

    private class ProfitLossItemWiseResult
    {
        public string ReportType { get; set; } = "";
        public DateTime PeriodStart { get; set; }
        public DateTime PeriodEnd { get; set; }
        public List<ProfitLossItemWiseAccount> RevenueAccounts { get; set; } = new();
        public List<ProfitLossItemWiseAccount> ExpenseAccounts { get; set; } = new();
        public decimal TotalRevenue { get; set; }
        public decimal TotalExpenses { get; set; }
        public decimal NetProfitLoss { get; set; }
    }

    private class ProfitLossItemWiseAccount
    {
        public Guid AccountId { get; set; }
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string AccountType { get; set; } = "";
        public List<ProfitLossTransaction> Transactions { get; set; } = new();
        public decimal TotalAmount { get; set; }
    }

    private class ProfitLossTransaction
    {
        public DateTime EntryDate { get; set; }
        public string VoucherNumber { get; set; } = "";
        public string Reference { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal Amount { get; set; }
    }
}

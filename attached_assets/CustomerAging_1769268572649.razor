@page "/reports/customer-aging"
@layout MainLayout
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Customer Aging Report</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedCustomerId" 
                           Label="Customer (Optional)" 
                           T="Guid?"
                           Clearable="true"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@((Guid?)null)">-- All Customers --</MudSelectItem>
                    @foreach (var customer in customers)
                    {
                        <MudSelectItem Value="@((Guid?)customer.Id)">
                            @customer.Name (@customer.Code)
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedYear" 
                           Label="Year" 
                           T="int">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <MudSelectItem Value="@y">@y</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect @bind-Value="selectedMonth" 
                           Label="Month" 
                           T="int">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var month = m;
                        <MudSelectItem Value="@month">@(new DateTime(2000, month, 1).ToString("MMMM"))</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Search"
                          OnClick="LoadReport"
                          FullWidth="true"
                          Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="ClearFilters"
                          FullWidth="true"
                          Class="mt-1">
                    Clear
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-4">
            <MudStack AlignItems="AlignItems.Center">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading report...</MudText>
            </MudStack>
        </MudPaper>
    }
    else if (reportResult != null)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudText Typo="Typo.h6">Aging Summary</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        As of: @reportResult.AsOfDate.ToString("dd MMM yyyy")
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="3">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Current</MudText>
                            <MudText Typo="Typo.subtitle1">@reportResult.TotalCurrent.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Warning">1-30 Days</MudText>
                            <MudText Typo="Typo.subtitle1">@reportResult.Total1To30.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Style="color: orange;">31-60 Days</MudText>
                            <MudText Typo="Typo.subtitle1">@reportResult.Total31To60.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">61-90 Days</MudText>
                            <MudText Typo="Typo.subtitle1">@reportResult.Total61To90.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Style="color: darkred;">Over 90 Days</MudText>
                            <MudText Typo="Typo.subtitle1">@reportResult.TotalOver90.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Style="font-weight: bold;">Grand Total</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@reportResult.GrandTotal.ToString("N2")</MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4">
            @if (reportResult.Items.Any())
            {
                <MudTable Items="@reportResult.Items" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true"
                          FixedHeader="true"
                          Height="500px">
                    <HeaderContent>
                        <MudTh>Customer</MudTh>
                        <MudTh>Code</MudTh>
                        <MudTh Style="text-align: right; background-color: #e8f5e9;">Current</MudTh>
                        <MudTh Style="text-align: right; background-color: #fff3e0;">1-30 Days</MudTh>
                        <MudTh Style="text-align: right; background-color: #ffe0b2;">31-60 Days</MudTh>
                        <MudTh Style="text-align: right; background-color: #ffcdd2;">61-90 Days</MudTh>
                        <MudTh Style="text-align: right; background-color: #ef9a9a;">Over 90</MudTh>
                        <MudTh Style="text-align: right; font-weight: bold;">Total</MudTh>
                        <MudTh Style="text-align: center;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Customer">
                            <MudLink Href="@($"/reports/customer-ledger?customerId={context.CustomerId}")" 
                                     Style="cursor: pointer; text-decoration: underline;">
                                @context.CustomerName
                            </MudLink>
                        </MudTd>
                        <MudTd DataLabel="Code">@context.CustomerCode</MudTd>
                        <MudTd DataLabel="Current" Style="text-align: right; background-color: #e8f5e9;">
                            @(context.Current > 0 ? context.Current.ToString("N2") : "-")
                        </MudTd>
                        <MudTd DataLabel="1-30 Days" Style="text-align: right; background-color: #fff3e0;">
                            @(context.Days1To30 > 0 ? context.Days1To30.ToString("N2") : "-")
                        </MudTd>
                        <MudTd DataLabel="31-60 Days" Style="text-align: right; background-color: #ffe0b2;">
                            @(context.Days31To60 > 0 ? context.Days31To60.ToString("N2") : "-")
                        </MudTd>
                        <MudTd DataLabel="61-90 Days" Style="text-align: right; background-color: #ffcdd2;">
                            @(context.Days61To90 > 0 ? context.Days61To90.ToString("N2") : "-")
                        </MudTd>
                        <MudTd DataLabel="Over 90" Style="text-align: right; background-color: #ef9a9a;">
                            @(context.Over90Days > 0 ? context.Over90Days.ToString("N2") : "-")
                        </MudTd>
                        <MudTd DataLabel="Total" Style="text-align: right; font-weight: bold;">
                            @context.Total.ToString("N2")
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: center;">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                           Size="MudBlazor.Size.Small" 
                                           Color="Color.Primary"
                                           Title="View Details"
                                           OnClick="@(() => ViewDetails(context.CustomerId))" />
                        </MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTd colspan="2" Style="font-weight: bold; text-align: right;">Totals:</MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; background-color: #c8e6c9;">
                            @reportResult.TotalCurrent.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; background-color: #ffe0b2;">
                            @reportResult.Total1To30.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; background-color: #ffcc80;">
                            @reportResult.Total31To60.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; background-color: #ef9a9a;">
                            @reportResult.Total61To90.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; background-color: #e57373;">
                            @reportResult.TotalOver90.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold;">
                            @reportResult.GrandTotal.ToString("N2")
                        </MudTd>
                        <MudTd></MudTd>
                    </FooterContent>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No outstanding balances found for the selected criteria.</MudAlert>
            }
        </MudPaper>
    }

    <MudDialog @bind-Visible="showDetailDialog" Options="dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                Invoice Details - @detailResult?.CustomerName
            </MudText>
        </TitleContent>
        <DialogContent>
            @if (detailResult != null)
            {
                <MudText Typo="Typo.body2" Class="mb-2">
                    Total Outstanding: <strong>@detailResult.TotalOutstanding.ToString("N2")</strong>
                </MudText>
                <MudTable Items="@detailResult.Items" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Invoice #</MudTh>
                        <MudTh>Invoice Date</MudTh>
                        <MudTh>Due Date</MudTh>
                        <MudTh Style="text-align: right;">Amount</MudTh>
                        <MudTh Style="text-align: right;">Paid</MudTh>
                        <MudTh Style="text-align: right;">Outstanding</MudTh>
                        <MudTh>Days Past Due</MudTh>
                        <MudTh>Bucket</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Invoice #">@context.InvoiceNumber</MudTd>
                        <MudTd DataLabel="Invoice Date">@context.InvoiceDate.ToString("dd MMM yyyy")</MudTd>
                        <MudTd DataLabel="Due Date">@context.DueDate.ToString("dd MMM yyyy")</MudTd>
                        <MudTd DataLabel="Amount" Style="text-align: right;">@context.InvoiceAmount.ToString("N2")</MudTd>
                        <MudTd DataLabel="Paid" Style="text-align: right;">@context.PaidAmount.ToString("N2")</MudTd>
                        <MudTd DataLabel="Outstanding" Style="text-align: right; font-weight: bold;">
                            @context.OutstandingAmount.ToString("N2")
                        </MudTd>
                        <MudTd DataLabel="Days Past Due">
                            @if (context.DaysPastDue > 0)
                            {
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetDaysColor(context.DaysPastDue)">
                                    @context.DaysPastDue days
                                </MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Size="MudBlazor.Size.Small" Color="Color.Success">Current</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Bucket">@context.AgingBucket</MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="CloseDetailDialog">Close</MudButton>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    private List<CustomerAgingDropdownDto> customers = new();
    private Guid? selectedCustomerId;
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private bool isLoading = false;
    private CustomerAgingResultDto? reportResult;
    private bool showDetailDialog = false;
    private CustomerAgingDetailResultDto? detailResult;

    private DialogOptions dialogOptions = new()
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true,
        CloseOnEscapeKey = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Get, "api/CustomerAging/customers");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                customers = await response.Content.ReadFromJsonAsync<List<CustomerAgingDropdownDto>>() ?? new();
            }
            else
            {
                Snackbar.Add("Failed to load customers", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customers: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        reportResult = null;

        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var url = $"api/CustomerAging?year={selectedYear}&month={selectedMonth}";
            if (selectedCustomerId.HasValue)
            {
                url += $"&customerId={selectedCustomerId.Value}";
            }

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                reportResult = await response.Content.ReadFromJsonAsync<CustomerAgingResultDto>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load report: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewDetails(Guid customerId)
    {
        try
        {
            var token = AuthService.GetAccessToken();
            var tenantId = AuthService.GetTenantId();

            if (string.IsNullOrEmpty(token) || string.IsNullOrEmpty(tenantId))
            {
                Snackbar.Add("Authentication required", Severity.Error);
                return;
            }

            var url = $"api/CustomerAging/detail?customerId={customerId}&year={selectedYear}&month={selectedMonth}";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            request.Headers.Add("X-Tenant-Id", tenantId);

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                detailResult = await response.Content.ReadFromJsonAsync<CustomerAgingDetailResultDto>();
                showDetailDialog = true;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to load details: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading details: {ex.Message}", Severity.Error);
        }
    }

    private void CloseDetailDialog()
    {
        showDetailDialog = false;
        detailResult = null;
    }

    private void ClearFilters()
    {
        selectedCustomerId = null;
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        reportResult = null;
    }

    private Color GetDaysColor(int days)
    {
        if (days <= 30) return Color.Warning;
        if (days <= 60) return Color.Warning;
        if (days <= 90) return Color.Error;
        return Color.Error;
    }

    public class CustomerAgingDropdownDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
    }

    public class CustomerAgingResultDto
    {
        public DateTime AsOfDate { get; set; }
        public decimal TotalCurrent { get; set; }
        public decimal Total1To30 { get; set; }
        public decimal Total31To60 { get; set; }
        public decimal Total61To90 { get; set; }
        public decimal TotalOver90 { get; set; }
        public decimal GrandTotal { get; set; }
        public List<CustomerAgingItemDto> Items { get; set; } = new();
    }

    public class CustomerAgingItemDto
    {
        public Guid CustomerId { get; set; }
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerCode { get; set; } = string.Empty;
        public decimal Current { get; set; }
        public decimal Days1To30 { get; set; }
        public decimal Days31To60 { get; set; }
        public decimal Days61To90 { get; set; }
        public decimal Over90Days { get; set; }
        public decimal Total { get; set; }
    }

    public class CustomerAgingDetailResultDto
    {
        public Guid CustomerId { get; set; }
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerCode { get; set; } = string.Empty;
        public DateTime AsOfDate { get; set; }
        public decimal TotalOutstanding { get; set; }
        public List<CustomerAgingDetailItemDto> Items { get; set; } = new();
    }

    public class CustomerAgingDetailItemDto
    {
        public Guid InvoiceId { get; set; }
        public string InvoiceNumber { get; set; } = string.Empty;
        public DateTime InvoiceDate { get; set; }
        public DateTime DueDate { get; set; }
        public decimal InvoiceAmount { get; set; }
        public decimal PaidAmount { get; set; }
        public decimal OutstandingAmount { get; set; }
        public int DaysPastDue { get; set; }
        public string AgingBucket { get; set; } = string.Empty;
    }
}

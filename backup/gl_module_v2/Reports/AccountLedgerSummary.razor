@page "/reports/account-ledger-summary"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Account Ledger (Summary) - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h5" Class="mb-4">Account Ledger - Summary</MudText>
    
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudSelect @bind-Value="_selectedClassification" 
                           Label="Classification" 
                           T="AccountClassification?"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true">
                    @foreach (AccountClassification cls in Enum.GetValues(typeof(AccountClassification)))
                    {
                        <MudSelectItem Value="@((AccountClassification?)cls)">@cls.ToString()</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_fromDate" Label="From Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudDatePicker @bind-Date="_toDate" Label="To Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" Dense="true" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudCheckBox @bind-Value="_showZeroBalances" Label="Include Zero Balances" Dense="true" Class="mt-2" />
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReport" 
                           FullWidth="true" Class="mt-1" Disabled="_isLoading">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_hasData)
    {
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">Account Summary</MudText>
                    <MudText Typo="Typo.caption">
                        Period: @_fromDate?.ToString("dd MMM yyyy") - @_toDate?.ToString("dd MMM yyyy")
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @_items.Count account(s) displayed
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Total Opening</MudText>
                            <MudText Typo="Typo.h6" Style="@(_totalOpening >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @_totalOpening.ToString("N2")
                            </MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Debit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@_totalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Credit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@_totalCredit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Total Closing</MudText>
                            <MudText Typo="Typo.h6" Style="@(_totalClosing >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @_totalClosing.ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Class="pa-4" Elevation="2">
            @if (_items.Any())
            {
                <MudTable Items="@_items" Dense="true" Hover="true" Striped="true" FixedHeader="true" Height="500px">
                    <HeaderContent>
                        <MudTh>Account Code</MudTh>
                        <MudTh>Account Name</MudTh>
                        <MudTh>Classification</MudTh>
                        <MudTh Style="text-align: right;">Opening Balance</MudTh>
                        <MudTh Style="text-align: right;">Debit</MudTh>
                        <MudTh Style="text-align: right;">Credit</MudTh>
                        <MudTh Style="text-align: right;">Closing Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Account Code">
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.AccountCode</MudText>
                        </MudTd>
                        <MudTd DataLabel="Account Name">@context.AccountName</MudTd>
                        <MudTd DataLabel="Classification">
                            <MudChip T="string" Size="Size.Small" Color="@GetClassificationColor(context.Classification)">
                                @context.Classification
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Opening Balance" Style="text-align: right;">
                            <span style="@(context.OpeningBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @context.OpeningBalance.ToString("N2")
                            </span>
                        </MudTd>
                        <MudTd DataLabel="Debit" Style="text-align: right;">
                            @if (context.PeriodDebit > 0)
                            {
                                <span style="color: var(--mud-palette-error);">@context.PeriodDebit.ToString("N2")</span>
                            }
                            else
                            {
                                <span>0.00</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credit" Style="text-align: right;">
                            @if (context.PeriodCredit > 0)
                            {
                                <span style="color: var(--mud-palette-success);">@context.PeriodCredit.ToString("N2")</span>
                            }
                            else
                            {
                                <span>0.00</span>
                            }
                        </MudTd>
                        <MudTd DataLabel="Closing Balance" Style="text-align: right; font-weight: bold;">
                            <span style="@(context.ClosingBalance >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @context.ClosingBalance.ToString("N2")
                            </span>
                        </MudTd>
                    </RowTemplate>
                    <FooterContent>
                        <MudTd colspan="3" Style="font-weight: bold;">Grand Total</MudTd>
                        <MudTd Style="text-align: right; font-weight: bold;">
                            <span style="@(_totalOpening >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @_totalOpening.ToString("N2")
                            </span>
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; color: var(--mud-palette-error);">
                            @_totalDebit.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold; color: var(--mud-palette-success);">
                            @_totalCredit.ToString("N2")
                        </MudTd>
                        <MudTd Style="text-align: right; font-weight: bold;">
                            <span style="@(_totalClosing >= 0 ? "color: var(--mud-palette-info);" : "color: var(--mud-palette-warning);")">
                                @_totalClosing.ToString("N2")
                            </span>
                        </MudTd>
                    </FooterContent>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No accounts found for the selected criteria.</MudAlert>
            }
        </MudPaper>
    }
    else if (!_isLoading)
    {
        <MudPaper Class="pa-4">
            <MudAlert Severity="Severity.Info">
                Select filters and click Generate to view the account summary.
            </MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {
    private AccountClassification? _selectedClassification;
    private DateTime? _fromDate = DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 1, 1), DateTimeKind.Utc);
    private DateTime? _toDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private bool _showZeroBalances;
    private bool _isLoading;
    private bool _hasData;

    private List<AccountSummaryItem> _items = new();
    private decimal _totalOpening;
    private decimal _totalDebit;
    private decimal _totalCredit;
    private decimal _totalClosing;

    private async Task LoadReport()
    {
        _isLoading = true;
        _items.Clear();

        try
        {
            var fromUtc = _fromDate.HasValue 
                ? DateTime.SpecifyKind(_fromDate.Value.Date, DateTimeKind.Utc) 
                : DateTime.SpecifyKind(new DateTime(DateTime.Today.Year, 1, 1), DateTimeKind.Utc);
            var toUtc = _toDate.HasValue 
                ? DateTime.SpecifyKind(_toDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) 
                : DateTime.UtcNow;

            var accountsQuery = DbContext.AccountHeads
                .Where(a => a.IsActive && !a.IsGroup);

            if (_selectedClassification.HasValue)
            {
                accountsQuery = accountsQuery.Where(a => a.Classification == _selectedClassification.Value);
            }

            var accounts = await accountsQuery.OrderBy(a => a.Code).ToListAsync();

            var allEntries = await DbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => !e.IsDeleted && e.Journal.IsPosted && e.Journal.VoucherDate <= toUtc)
                .ToListAsync();

            foreach (var account in accounts)
            {
                var accountEntries = allEntries.Where(e => e.AccountHeadId == account.Id).ToList();
                
                var priorEntries = accountEntries.Where(e => e.Journal.VoucherDate < fromUtc).ToList();
                var openingBalance = (account.OpeningBalance ?? 0) + priorEntries.Sum(e => (e.Debit ?? 0) - (e.Credit ?? 0));

                var periodEntries = accountEntries.Where(e => e.Journal.VoucherDate >= fromUtc && e.Journal.VoucherDate <= toUtc).ToList();
                var periodDebit = periodEntries.Sum(e => e.Debit ?? 0);
                var periodCredit = periodEntries.Sum(e => e.Credit ?? 0);
                var closingBalance = openingBalance + periodDebit - periodCredit;

                if (!_showZeroBalances && openingBalance == 0 && periodDebit == 0 && periodCredit == 0)
                    continue;

                _items.Add(new AccountSummaryItem
                {
                    AccountCode = account.Code,
                    AccountName = account.Name,
                    Classification = account.Classification.ToString(),
                    OpeningBalance = openingBalance,
                    PeriodDebit = periodDebit,
                    PeriodCredit = periodCredit,
                    ClosingBalance = closingBalance
                });
            }

            _totalOpening = _items.Sum(i => i.OpeningBalance);
            _totalDebit = _items.Sum(i => i.PeriodDebit);
            _totalCredit = _items.Sum(i => i.PeriodCredit);
            _totalClosing = _items.Sum(i => i.ClosingBalance);
            _hasData = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading report: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private Color GetClassificationColor(string classification)
    {
        return classification switch
        {
            "Assets" => Color.Success,
            "Liabilities" => Color.Warning,
            "Equity" => Color.Info,
            "Income" => Color.Primary,
            "Expenditure" => Color.Error,
            _ => Color.Default
        };
    }

    private class AccountSummaryItem
    {
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string Classification { get; set; } = "";
        public decimal OpeningBalance { get; set; }
        public decimal PeriodDebit { get; set; }
        public decimal PeriodCredit { get; set; }
        public decimal ClosingBalance { get; set; }
    }
}

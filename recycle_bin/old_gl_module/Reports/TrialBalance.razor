@page "/reports/trial-balance"
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities

<PageTitle>Trial Balance - Net4Courier</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Class="pa-4" Elevation="2">
        <MudText Typo="Typo.h5" Class="mb-4">Trial Balance</MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_asAtDate" Label="As At Date" DateFormat="dd-MMM-yyyy" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect T="string" @bind-Value="_viewType" Label="View Type" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("detailed")">Detailed (All Accounts)</MudSelectItem>
                    <MudSelectItem Value="@("grouped")">Grouped by Classification</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadTrialBalance" 
                           FullWidth="true" Class="mt-1">
                    Generate
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_isLoading)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        </MudPaper>
    }
    else if (_trialBalanceItems.Any())
    {
        <MudPaper Class="pa-4 mt-4" Elevation="2">
            <MudGrid Class="mb-3">
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.h6">Trial Balance</MudText>
                    <MudText Typo="Typo.caption">As at @_asAtDate?.ToString("dd-MMM-yyyy")</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Error">Total Debit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">@_totalDebit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption" Color="Color.Success">Total Credit</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">@_totalCredit.ToString("N2")</MudText>
                        </MudStack>
                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudText Typo="Typo.caption">Difference</MudText>
                            <MudText Typo="Typo.h6" Color="@(Math.Abs(_totalDebit - _totalCredit) < 0.01m ? Color.Success : Color.Error)">
                                @Math.Abs(_totalDebit - _totalCredit).ToString("N2")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>

            @if (Math.Abs(_totalDebit - _totalCredit) < 0.01m)
            {
                <MudAlert Severity="Severity.Success" Class="mb-3">Trial Balance is balanced.</MudAlert>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-3">Trial Balance is not balanced. Difference: @Math.Abs(_totalDebit - _totalCredit).ToString("N2")</MudAlert>
            }

            <MudTable Items="@_trialBalanceItems" Dense="true" Hover="true" Striped="true" FixedHeader="true" Height="500px"
                      GroupBy="@(_viewType == "grouped" ? _groupDefinition : null)">
                <HeaderContent>
                    <MudTh>Account Code</MudTh>
                    <MudTh>Account Name</MudTh>
                    <MudTh>Classification</MudTh>
                    <MudTh Style="text-align:right">Debit</MudTh>
                    <MudTh Style="text-align:right">Credit</MudTh>
                </HeaderContent>
                <GroupHeaderTemplate>
                    <MudTh colspan="3" Style="background-color: var(--mud-palette-grey-lighten-3);">
                        <MudText Typo="Typo.subtitle1"><b>@context.Key</b></MudText>
                    </MudTh>
                    <MudTh Style="text-align:right; background-color: var(--mud-palette-grey-lighten-3);">
                        <b>@context.Items.Sum(x => ((TrialBalanceItem)x).Debit).ToString("N2")</b>
                    </MudTh>
                    <MudTh Style="text-align:right; background-color: var(--mud-palette-grey-lighten-3);">
                        <b>@context.Items.Sum(x => ((TrialBalanceItem)x).Credit).ToString("N2")</b>
                    </MudTh>
                </GroupHeaderTemplate>
                <RowTemplate>
                    <MudTd>@context.AccountCode</MudTd>
                    <MudTd>@context.AccountName</MudTd>
                    <MudTd>@context.Classification</MudTd>
                    <MudTd Style="text-align:right">
                        @if (context.Debit > 0)
                        {
                            <span style="color: var(--mud-palette-error);">@context.Debit.ToString("N2")</span>
                        }
                    </MudTd>
                    <MudTd Style="text-align:right">
                        @if (context.Credit > 0)
                        {
                            <span style="color: var(--mud-palette-success);">@context.Credit.ToString("N2")</span>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private DateTime? _asAtDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private string _viewType = "detailed";
    private List<TrialBalanceItem> _trialBalanceItems = new();
    private bool _isLoading;
    private decimal _totalDebit;
    private decimal _totalCredit;

    private TableGroupDefinition<TrialBalanceItem> _groupDefinition = new()
    {
        GroupName = "Classification",
        Selector = (e) => e.Classification,
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true
    };

    private async Task LoadTrialBalance()
    {
        _isLoading = true;
        _trialBalanceItems.Clear();

        try
        {
            var asAtUtc = _asAtDate.HasValue 
                ? DateTime.SpecifyKind(_asAtDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc) 
                : DateTime.UtcNow;

            var accounts = await DbContext.AccountHeads
                .Where(a => a.IsActive && !a.IsGroup)
                .OrderBy(a => a.Classification)
                .ThenBy(a => a.Code)
                .ToListAsync();

            var journalEntries = await DbContext.JournalEntries
                .Include(e => e.Journal)
                .Where(e => !e.IsDeleted && e.Journal.IsPosted && e.Journal.VoucherDate <= asAtUtc)
                .ToListAsync();

            var entriesByAccount = journalEntries.GroupBy(e => e.AccountHeadId)
                .ToDictionary(g => g.Key, g => g.ToList());

            foreach (var account in accounts)
            {
                var opening = account.OpeningBalance ?? 0;
                var entries = entriesByAccount.GetValueOrDefault(account.Id, new List<JournalEntry>());
                var totalDebit = entries.Sum(e => e.Debit ?? 0);
                var totalCredit = entries.Sum(e => e.Credit ?? 0);
                
                var balance = opening + totalDebit - totalCredit;
                
                if (balance == 0 && opening == 0) continue;

                _trialBalanceItems.Add(new TrialBalanceItem
                {
                    AccountCode = account.Code,
                    AccountName = account.Name,
                    Classification = account.Classification.ToString(),
                    Debit = balance > 0 ? balance : 0,
                    Credit = balance < 0 ? Math.Abs(balance) : 0
                });
            }

            _totalDebit = _trialBalanceItems.Sum(t => t.Debit);
            _totalCredit = _trialBalanceItems.Sum(t => t.Credit);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading trial balance: {ex.Message}", Severity.Error);
        }

        _isLoading = false;
    }

    private class TrialBalanceItem
    {
        public string AccountCode { get; set; } = "";
        public string AccountName { get; set; } = "";
        public string Classification { get; set; } = "";
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
    }
}

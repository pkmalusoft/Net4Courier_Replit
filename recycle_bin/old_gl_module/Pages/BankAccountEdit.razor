@page "/bank-accounts/new"
@page "/bank-accounts/edit/{Id:long}"
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using Microsoft.EntityFrameworkCore
@using Net4Courier.Infrastructure.Data
@using Net4Courier.Finance.Entities
@using Net4Courier.Masters.Entities

<PageTitle>@(Id.HasValue ? "Edit" : "New") Bank Account</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack" />
        <MudText Typo="Typo.h5">@(Id.HasValue ? "Edit" : "New") Bank Account</MudText>
    </MudStack>

    <MudPaper Class="pa-6" Elevation="2">
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.AccountNumber" 
                                Label="Account Number" 
                                Required="true"
                                Immediate="true"
                                Variant="Variant.Outlined"
                                RequiredError="Account number is required"
                                MaxLength="50" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.AccountName" 
                                Label="Account Name" 
                                Required="true"
                                Immediate="true"
                                Variant="Variant.Outlined"
                                RequiredError="Account name is required"
                                MaxLength="200" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.BankName" 
                                Label="Bank Name" 
                                Required="true"
                                Immediate="true"
                                Variant="Variant.Outlined"
                                RequiredError="Bank name is required"
                                MaxLength="100" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.BranchName" 
                                Label="Branch Name" 
                                Variant="Variant.Outlined"
                                MaxLength="100" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.SwiftCode" 
                                Label="SWIFT Code" 
                                Variant="Variant.Outlined"
                                MaxLength="20" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_bankAccount.IbanNumber" 
                                Label="IBAN Number" 
                                Variant="Variant.Outlined"
                                MaxLength="50" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_bankAccount.AccountHeadId" 
                             Label="Chart of Account (Bank)" 
                             Required="true"
                             Variant="Variant.Outlined"
                             T="long"
                             RequiredError="Chart of Account is required">
                        @foreach (var account in _accountHeads)
                        {
                            <MudSelectItem Value="@account.Id">@account.Code - @account.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_bankAccount.CurrencyId" 
                             Label="Currency" 
                             Variant="Variant.Outlined"
                             T="long?"
                             Clearable="true">
                        @foreach (var currency in _currencies)
                        {
                            <MudSelectItem Value="@((long?)currency.Id)">@currency.Code - @currency.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_bankAccount.OpeningBalance" 
                                   Label="Opening Balance" 
                                   Variant="Variant.Outlined"
                                   Format="N2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="_openingBalanceDate" 
                                 Label="Opening Balance Date" 
                                 Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_bankAccount.Notes" 
                                Label="Notes" 
                                Variant="Variant.Outlined"
                                Lines="3"
                                MaxLength="500" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Value="_bankAccount.IsActive" Label="Active" Color="Color.Primary" />
                </MudItem>
            </MudGrid>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
            }

            <MudDivider Class="my-6" />

            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="Save" 
                          Disabled="@(!_formIsValid || _saving)">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Save
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Default" 
                          OnClick="GoBack" 
                          Disabled="_saving">
                    Cancel
                </MudButton>
            </MudStack>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public long? Id { get; set; }

    private MudForm? _form;
    private bool _formIsValid;
    private BankAccount _bankAccount = new();
    private List<AccountHead> _accountHeads = new();
    private List<Currency> _currencies = new();
    private string _errorMessage = "";
    private bool _saving = false;
    private long _companyId = 1;
    private long _branchId = 1;

    private DateTime? _openingBalanceDate
    {
        get => _bankAccount.OpeningBalanceDate;
        set => _bankAccount.OpeningBalanceDate = value ?? DateTime.UtcNow.Date;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();

        if (Id.HasValue)
        {
            var existing = await DbContext.BankAccounts
                .FirstOrDefaultAsync(b => b.Id == Id.Value);

            if (existing != null)
            {
                _bankAccount = existing;
            }
            else
            {
                Snackbar.Add("Bank account not found", Severity.Error);
                Navigation.NavigateTo("/bank-accounts");
            }
        }
        else
        {
            _bankAccount.OpeningBalanceDate = DateTime.UtcNow.Date;
            _bankAccount.IsActive = true;
            _bankAccount.CompanyId = _companyId;
            _bankAccount.BranchId = _branchId;
        }
    }

    private async Task LoadReferenceData()
    {
        _accountHeads = await DbContext.AccountHeads
            .Where(a => a.AccountNature == AccountNature.BankAccount && a.IsActive && !a.IsGroup)
            .OrderBy(a => a.Code)
            .ToListAsync();

        _currencies = await DbContext.Currencies
            .OrderBy(c => c.Code)
            .ToListAsync();
    }

    private async Task Save()
    {
        if (_form != null)
        {
            await _form.Validate();
        }

        if (!_formIsValid)
        {
            Snackbar.Add("Please fill all required fields correctly", Severity.Warning);
            return;
        }

        if (_bankAccount.AccountHeadId == 0)
        {
            Snackbar.Add("Please select a Chart of Account", Severity.Warning);
            return;
        }

        _errorMessage = "";
        _saving = true;

        try
        {
            if (Id.HasValue)
            {
                _bankAccount.ModifiedAt = DateTime.UtcNow;
                DbContext.BankAccounts.Update(_bankAccount);
                await DbContext.SaveChangesAsync();
                Snackbar.Add("Bank account updated successfully", Severity.Success);
            }
            else
            {
                _bankAccount.CreatedAt = DateTime.UtcNow;
                _bankAccount.CompanyId = _companyId;
                _bankAccount.BranchId = _branchId;
                DbContext.BankAccounts.Add(_bankAccount);
                await DbContext.SaveChangesAsync();
                Snackbar.Add("Bank account created successfully", Severity.Success);
            }

            Navigation.NavigateTo("/bank-accounts");
        }
        catch (DbUpdateException ex) when (ex.InnerException?.Message?.Contains("unique") == true)
        {
            _errorMessage = "A bank account with this account number already exists";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving bank account: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/bank-accounts");
}
